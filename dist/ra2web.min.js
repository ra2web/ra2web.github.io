var __classPrivateFieldSet=this&&this.__classPrivateFieldSet||function(S,O,B,N,j){if("m"===N)throw new TypeError("Private method is not writable");if("a"===N&&!j)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof O?S!==O||!j:!O.has(S))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===N?j.call(S,B):j?j.value=B:O.set(S,B),B},__classPrivateFieldGet=this&&this.__classPrivateFieldGet||function(S,O,B,N){if("a"===B&&!N)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof O?S!==O||!N:!O.has(S))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===B?N:"a"===B?N.call(S):N?N.value:O.get(S)},__decorate=this&&this.__decorate||function(S,O,B,N){var j,L=arguments.length,D=L<3?O:null===N?N=Object.getOwnPropertyDescriptor(O,B):N;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)D=Reflect.decorate(S,O,B,N);else for(var F=S.length-1;0<=F;F--)(j=S[F])&&(D=(L<3?j(D):3<L?j(O,B,D):j(O,B))||D);return 3<L&&D&&Object.defineProperty(O,B,D),D};System.register("Application",["fontfaceobserver","detect-gpu","@puzzl/core/lib/async/cancellation","engine/Engine","gui/component/SplashScreen","network/WolConnection","network/gameopt/Parser","Config","util/Routing","tools/LobbyFormTester","tools/VxlTester","tools/ShpTester","tools/BuildingTester","data/IniFile","util/time","engine/ResourceLoader","ConsoleVars","util/Logger","tools/DevToolsApi","tools/VehicleTester","tools/InfantryTester","tools/AircraftTester","tools/SoundTester","LocalPrefs","gui/FullScreen","version","data/Strings","network/ServerRegions","gui/screen/options/GeneralOptions","engine/gameRes/GameResConfig","gui/component/BasicErrorBoxApi","engine/gameRes/GameRes","engine/gameRes/importError/FileNotFoundError","engine/gameRes/importError/ArchiveDownloadError","engine/gameRes/importError/InvalidArchiveError","engine/gameRes/importError/ArchiveExtractionError","engine/gameRes/importError/ChecksumError","engine/gameRes/importError/NoStorageError","data/MapFile","gui/component/ImageContext","util/BoxedVar","gui/replay/ReplayStorageFileSystem","gui/replay/ReplayStorageMigration","data/vfs/StorageQuotaError","Gui","data/vfs/IOError","network/WolService","data/vfs/FileNotFoundError","RouteHelper","data/CsfFile","util/Sentry","engine/gameRes/importError/NoWebAssemblyError","network/WolConfig"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,xe,Oe,Ae,Me,Re,Pe,Ie,ke,Be,Ne;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S},function(S){ge=S},function(S){pe=S},function(S){me=S},function(S){fe=S},function(S){ye=S},function(S){Te=S},function(S){ve=S},function(S){be=S},function(S){Se=S},function(S){we=S},function(S){Ee=S},function(S){xe=S},function(S){Oe=S},function(S){Ae=S},function(S){Me=S},function(S){Re=S},function(S){Pe=S},function(S){Ie=S},function(S){ke=S},function(S){Be=S}],execute:function(){S("Application",Ne=class e{constructor(){this.viewport=new be.BoxedVar({x:0,y:0,width:0,height:0}),this.stageEl=void 0,this.outerRootEl=void 0,this.viewportClampMode="menu",this._onScreenChangeHandler=void 0,this._onViewportClampModeEvent=void 0,this._viewportResyncTimers=[]}getVersion(){return ne.version}getEngineVersion(){return L.Engine.getVersion()}getEngineModHash(){return L.Engine.getModHash()}async main(){try{await this.loadConfig()}catch(U){return void console.error("Missing config.ini. Please see README.md")}var S=this.config.defaultLocale;let O;try{O=await this.loadTranslations(S),this.locale=S}catch(U){return void console.error(`Missing translation ${S}.`,U)}let N=new ae.Strings(O);try{this.checkGlobalLibs()}catch(U){return console.error(U),void alert(N.get("TS:DownloadFailed"))}this.localPrefs=new re.LocalPrefs(localStorage);var j=document.getElementById("ra2web-root");if(!j)throw new Error("Missing root element");this.outerRootEl=j;let F=document.createElement("div");F.setAttribute("id","ra2web-stage"),F.style.position="fixed",F.style.left="50%",F.style.top="50%",F.style.transformOrigin="0 0",F.style.transform="scale(1) translate(-50%, -50%)",j.appendChild(F),this.stageEl=F,this.rootEl=F,this.runtimeVars=new Z.ConsoleVars,window.__ra2webRuntimeVars=this.runtimeVars,X.DevToolsApi.registerCommand("help",()=>{console.info("Available commands: "),[...X.DevToolsApi.listCommands()].forEach(S=>console.info("> "+S)),console.info("Available variables: "),[...X.DevToolsApi.listVars()].forEach(S=>console.info("> "+S))}),X.DevToolsApi.registerVar("freecamera",this.runtimeVars.freeCamera),X.DevToolsApi.registerCommand("version",()=>{console.info("Client version: "+this.getVersion()),console.info("Engine version: "+this.getEngineVersion()),console.info("Mod hash: "+L.Engine.getModHash())}),this.runtimeVars.forceResolution.onChange.subscribe(S=>{var O,B;S?.match(/^\d+x\d+$/)&&([O,B]=S.split("x").map(Number),this.setPreferredViewportSize({width:O,height:B}))}),X.DevToolsApi.registerVar("forcesize",this.runtimeVars.forceResolution),X.DevToolsApi.registerVar("debug_wireframes",this.runtimeVars.debugWireframes),X.DevToolsApi.registerVar("debug_paths",this.runtimeVars.debugPaths),X.DevToolsApi.registerVar("debug_text",this.runtimeVars.debugText),X.DevToolsApi.registerVar("debug_bot",this.runtimeVars.debugBotIndex),X.DevToolsApi.registerVar("fs_zoom_out",this.runtimeVars.fullScreenZoomOut),X.DevToolsApi.registerVar("mobile_joystick",this.runtimeVars.mobileJoystickEnabled),this.runtimeVars.fullScreenZoomOut.onChange.subscribe(()=>{this.updateViewportSize(this.fullScreen?.isFullScreen?.()??!1)}),await this.initLogging(),this.fullScreen=new se.FullScreen(document),this.fullScreen.init(),this.fullScreen.onChange.subscribe(S=>{this.onFullScreenChange(S),this.updateViewportSize(S),this.requestViewportResync()}),window.addEventListener("resize",()=>this.updateViewportSize(this.fullScreen.isFullScreen())),this.updateViewportSize(this.fullScreen.isFullScreen()),this._onViewportClampModeEvent=S=>{try{var O=S?.detail?.mode;"menu"!==O&&"dynamic"!==O||(this.viewportClampMode=O,this.updateViewportSize(this.fullScreen.isFullScreen()),this.requestViewportResync())}catch(S){console.warn("Failed to handle viewport clamp mode event",S)}},window.addEventListener("ra2web:viewportClampMode",this._onViewportClampModeEvent);let _=new D.SplashScreen(this.viewport.value.width,this.viewport.value.height);this.splashScreen=_,_.render(this.rootEl),_.setLoadingText(N.get("GUI:LoadingEx")),_.setCopyrightText(N.get("TXT_COPYRIGHT")+"\n"+N.get("GUI:WWBrand")),_.setDisclaimerText(N.get("TS:Disclaimer"));var U=q.sleep(this.config.devMode?0:5e3);let H;this.loadGpuBenchmarkData().then(S=>this.gpuTier=S).catch(S=>this.sentry?.captureException(S));try{H=this.fsAccessLib=await SystemJS.import("file-system-access")}catch(U){return console.error(U),_.setLoadingText(""),_.setBackgroundImage(""),void this.handleGameResLoadError(new Q.DownloadError("Failed to download fsa lib",{cause:U}),N,!0)}var V=new URLSearchParams(location.search).get(Re.RouteHelper.modQueryStringName)||void 0;let W=this.loadGameResConfig(this.localPrefs);try{let{configToPersist:S,cdnResLoader:O}=await new ue.GameRes(this.getVersion(),V,H,this.localPrefs,N,this.rootEl,_,this.viewport,this.config,e.resPath,this.sentry).init(W,(S,O)=>this.handleGameResLoadError(S,O),(S,O)=>this.handleGameResImportError(S,O));S&&(S.isCdn()?this.localPrefs.removeItem(re.StorageKey.GameRes):this.localPrefs.setItem(re.StorageKey.GameRes,S.serialize()),W=S),this.cdnResourceLoader=O}catch(U){return console.error(U),_.setLoadingText(""),_.setBackgroundImage(""),void this.handleGameResLoadError(U,N,!0)}this.gameResConfig=W,window.gtag?.("event","app_init",{res:this.gameResConfig.source,modName:L.Engine.getActiveMod()||"<none>"}),ve.ImageContext.cdnBaseUrl=this.gameResConfig.isCdn()?this.gameResConfig.getCdnBaseUrl():void 0,ve.ImageContext.vfs=L.Engine.vfs;try{let B=new Pe.CsfFile(L.Engine.vfs.openFile(L.Engine.getFileNameVariant("ra2.csf")));var z=B.getIsoLocale();if(void 0!==z&&z!==S)try{O=await this.loadTranslations(z),this.locale=z}catch(U){console.warn(`Failed to load translation ${z}. Falling back to ${S}.`,U)}N=this.strings=new ae.Strings(B),N.fromJson(O),L.Engine.loadRules(),this.sentry?.configureScope(S=>{S.setTag("mod",L.Engine.getActiveMod()||"<none>"),S.setExtra("mod",L.Engine.getActiveMod()||"<none>"),S.setExtra("modHash",L.Engine.getModHash())}),window.AudioContext||(window.AudioContext=(await SystemJS.import("web-audio-polyfill.js")).AudioContext)}catch(U){return console.error(U),_.setLoadingText(""),_.setBackgroundImage(""),void this.handleGameResLoadError(U,N,!0)}try{await new B.default("Fira Sans Condensed").load(),await new B.default("Fira Sans Condensed",{weight:"bold"}).load()}catch(U){console.error("Failed to load font",U)}try{await this.migrateReplayStorage(this.localPrefs,_,N)}catch(U){_.setLoadingText(""),U instanceof Ee.StorageQuotaError||U instanceof Oe.IOError||U instanceof Me.FileNotFoundError||this.sentry?.captureException(new Error("Failed to migrate replays to new storage",{cause:U})),console.error("Failed to migrate replays to new storage",U)}await U,_.destroy(),this.splashScreen=void 0,this.initRouting()}async loadTranslations(S){return await new Q.ResourceLoader(e.resPath).loadJson(`locale/${S}.json?v=`+this.getVersion())}checkGlobalLibs(){var S,O;for([S,O]of new Map([["CDWorkerHostLib",()=>window.CDWorkerHostLib],["THREE",()=>window.THREE],["Octree",()=>window.Octree],["SimplexNoise",()=>window.SimplexNoise],["LightningStrike",()=>window.THREE.LightningStrike],["TrailRenderer",()=>window.THREE.TrailRenderer],["SPE",()=>window.SPE],["GrowingPacker",()=>window.GrowingPacker],["lzo1x",()=>window.lzo1x]])){let B=!1;try{void 0!==O()&&(B=!0)}catch(S){}if(!B)throw new Error(`Library "${S}" was not found on window scope`)}}async loadConfig(){let S=await new Q.ResourceLoader("").loadText("config.ini");if(S.startsWith("<"))throw new Error("Config download failed. Response looks like an HTML document.");var O=(new $.IniFile).fromString(S);this.config=new U.Config,this.config.load(O)}async initLogging(){Y.AppLogger.useDefaults(),this.config.debugLogging&&(this.runtimeVars.debugLogging.value=this.config.debugLogging),X.DevToolsApi.registerVar("debug_logging",this.runtimeVars.debugLogging);var e=S=>{var O;if("string"!=typeof S)Y.AppLogger.setLevel(S?Y.AppLogger.DEBUG:Y.AppLogger.INFO);else for(O of S.split(","))Y.AppLogger.get(O).setLevel(Y.AppLogger.DEBUG)};if(e(!1),this.runtimeVars.debugLogging.value&&e(this.runtimeVars.debugLogging.value),this.runtimeVars.debugLogging.onChange.subscribe(e),this.config.debugGameState&&(this.runtimeVars.debugGameState.value=this.config.debugGameState),X.DevToolsApi.registerVar("debug_game_state",this.runtimeVars.debugGameState),e=this.config.sentry)try{this.sentry=new Ie.Sentry,await this.sentry.init(e,this.getVersion())}catch(e){console.error(e)}}loadGameResConfig(S){var O=S.getItem(re.StorageKey.GameRes);if(O){let S=new ce.GameResConfig(this.config.gameresBaseUrl??"");return S.unserialize(O),S.isCdn()&&!S.getCdnBaseUrl()?void 0:S}}async handleGameResLoadError(S,O,B=!1){let N=new he.BasicErrorBoxApi(this.viewport,O,this.rootEl),j=O.get("ts:import_load_files_failed");S instanceof fe.ChecksumError?j+="\n\n"+O.get("ts:import_checksum_mismatch",S.file):S instanceof de.FileNotFoundError?j+="\n\n"+O.get("ts:import_file_not_found",S.file):S instanceof Q.DownloadError||S.message?.match(/XHR error|Failed to fetch/i)?j+="\n\n"+O.get("ts:downloadfailed"):S instanceof ye.NoStorageError?j+="\n\n"+O.get("ts:import_no_storage"):S.message?.match(/out of memory|allocation/i)?j+="\n\n"+O.get("ts:gameinitoom"):"QuotaExceededError"===S.name||S instanceof Ee.StorageQuotaError?j+="\n\n"+O.get("ts:storage_quota_exceeded"):S instanceof Oe.IOError?(j+="\n\n"+O.get("ts:storage_io_error"),B=!0):S instanceof Me.FileNotFoundError||this.sentry?.captureException(new Error(`Game res load failed (${S.message??S.name})`,{cause:S})),await N.show(j,B)}async handleGameResImportError(S,O){let B=new he.BasicErrorBoxApi(this.viewport,O,this.rootEl),N=O.get("ts:import_failed");S instanceof de.FileNotFoundError?N+="\n\n"+O.get("ts:import_file_not_found",S.file):S instanceof pe.InvalidArchiveError?N+="\n\n"+O.get("ts:import_invalid_archive"):S instanceof me.ArchiveExtractionError?S.cause?.message?.match(/out of memory|allocation/i)?N+="\n\n"+O.get("ts:import_out_of_memory"):(N+="\n\n"+O.get("ts:import_archive_extract_failed"),this.sentry?.captureException(new Error(`Game res import failed (${S.message??S.name})`,{cause:S}))):S instanceof ke.NoWebAssemblyError?N+="\n\n"+O.get("ts:import_no_web_assembly"):S instanceof fe.ChecksumError?N+="\n\n"+O.get("ts:import_checksum_mismatch",S.file):S instanceof Q.DownloadError||S.message?.match(/XHR error|Failed to fetch|CompileError: WebAssembly|SystemJS|NetworkError|Load failed/i)?N+="\n\n"+O.get("ts:downloadfailed"):S instanceof ge.ArchiveDownloadError?N=O.get("ts:import_archive_download_failed",S.url):S instanceof ye.NoStorageError?N+="\n\n"+O.get("ts:import_no_storage"):S.message?.match(/out of memory|allocation/i)||S.name.match(/NS_ERROR_FAILURE|NS_ERROR_OUT_OF_MEMORY/)?N+="\n\n"+O.get("ts:import_out_of_memory"):"QuotaExceededError"===S.name||S instanceof Ee.StorageQuotaError?N+="\n\n"+O.get("ts:storage_quota_exceeded"):S instanceof Oe.IOError||S instanceof Me.FileNotFoundError||"AbortError"===S.name||this.sentry?.captureException(new Error("Game res import failed "+(S.message??S.name),{cause:S})),await B.show(N)}async loadGpuBenchmarkData(){let S=!1;var O=await N.getGPUTier({override:{loadBenchmarks:async O=>{let B=new j.CancellationTokenSource;var N=setTimeout(()=>B.cancel(),5e3);try{let S=await new Q.ResourceLoader("").loadJson("https://unpkg.com/detect-gpu@5.0.42/dist/benchmarks/"+O,B.token);return S.shift(),S}catch(N){throw S=!0,N}finally{clearTimeout(N)}}}});return S?void 0:O}async migrateReplayStorage(S,O,B){var N,j=await L.Engine.getReplayDir();j&&(N=new Se.ReplayStorageFileSystem(j,this.sentry),await new we.ReplayStorageMigration(O,B,j,S,N).migrate())}initRouting(){let S,O=new H.Routing;O.addRoute("*",async()=>{S&&await S.destroy(),this.viewportClampMode="menu"}),O.addRoute("/",async()=>{var O=new oe.ServerRegions;this.viewportClampMode="menu",this.gui=await this.initGui(O,this.strings),S=this}),O.addRoute("/game",async O=>{let B=new oe.ServerRegions;if(this.viewportClampMode="dynamic",this.gui=await this.initGui(B,this.strings),this.gui){let V=this.gui.getRootController();if(S=this,await q.sleep(1e3),1<O.length)throw new Error("Unsupported number of URL parameters");var N=F.WolConnection.factory(Y.AppLogger.get("net")),j=Be.WolConfig.factory(Be.ClientType.Cdral2);let W=new Ae.WolService(j,N,this.getVersion(),this.locale);B.load(await W.loadServerList(this.config.serversUrl));var L,D=(L=this.localPrefs.getItem(re.StorageKey.PreferredServerRegion))&&B.isAvailable(L)?B.get(L):B.getFirstAvailable();B.setSelectedRegion(D.id);var{gameId:U,gameTimestamp:H,gservUrl:j,playerName:N,gameOpts:L,tournament:D=!1}=Re.RouteHelper.extractGameParams(O[0]);L?(L=(new _.Parser).parseOptions(L),V.createGame(U,H,j,N,L,!1,D)):V.joinGame(U,H,j,N,D)}}),O.addRoute("/replay",async O=>{S=this;var[B]=O,N=new oe.ServerRegions;this.viewportClampMode="dynamic",this.gui=await this.initGui(N,this.strings,void 0!==B?B:void 0)}),O.addRoute("/lobbytest",async()=>{if(!L.Engine.vfs)throw new Error("Original game files must be provided.");V.LobbyFormTester.main(this.rootEl,this.strings),S=V.LobbyFormTester}),O.addRoute("/vxltest",async()=>{if(!L.Engine.vfs)throw new Error("Original game files must be provided.");W.VxlTester.main(L.Engine.vfs,this.runtimeVars),S=W.VxlTester}),O.addRoute("/shptest",async()=>{if(!L.Engine.vfs)throw new Error("Original game files must be provided.");var O=new Te.MapFile(L.Engine.vfs.openFile("mp03t4.map"));z.ShpTester.main(L.Engine.vfs,O,this.rootEl,this.strings),S=z.ShpTester}),O.addRoute("/buildtest",async()=>{if(!L.Engine.vfs)throw new Error("Original game files must be provided.");K.BuildingTester.main(this.runtimeVars),S=K.BuildingTester}),O.addRoute("/vehicletest",async()=>{if(!L.Engine.vfs)throw new Error("Original game files must be provided.");J.VehicleTester.main(this.runtimeVars),S=J.VehicleTester}),O.addRoute("/airtest",async()=>{if(!L.Engine.vfs)throw new Error("Original game files must be provided.");te.AircraftTester.main(this.runtimeVars),S=te.AircraftTester}),O.addRoute("/inftest",async()=>{if(!L.Engine.vfs)throw new Error("Original game files must be provided.");ee.InfantryTester.main(this.runtimeVars),S=ee.InfantryTester}),O.addRoute("/soundtest",async()=>{if(!L.Engine.vfs)throw new Error("Original game files must be provided.");ie.SoundTester.main(L.Engine.vfs,this.runtimeVars),S=ie.SoundTester}),O.init()}async initGui(S,O,B){var N=this.localPrefs.getItem(re.StorageKey.Options);let j;if(N)try{j=(new le.GeneralOptions).unserialize(N)}catch(S){console.warn("Couldn't read options from local storage",[S])}j||(j=new le.GeneralOptions,j.graphics.resolution.value={width:this.config.viewport.width,height:this.config.viewport.height}),this.setPreferredViewportSize(j.graphics.resolution.value),j.graphics.resolution.onChange.subscribe(S=>{this.setPreferredViewportSize(S)});let L=new xe.Gui(this.getVersion(),this.locale,this.getEngineVersion(),this.getEngineModHash(),this.gpuTier,this.config,this.gameResConfig,e.resPath,this.localPrefs,j,this.rootEl,this.viewport,this.fullScreen,O,this.cdnResourceLoader,this.fsAccessLib,S,this.runtimeVars,this.sentry);try{await L.init(B)}catch(S){let B;return console.error("Failed to initialize GUI",[S]),S instanceof Ee.StorageQuotaError||S instanceof Oe.IOError||S instanceof Me.FileNotFoundError?B=O.get("TS:GUIInitFSError"):(B=O.get("TS:GUIInitUnknownError"),this.sentry?.captureException(new Error(`Failed to initialize GUI (${S.name})`,{cause:S}))),void alert(B)}try{let S=L.getRootController();const t=S=>{this.viewportClampMode="menu",this.updateViewportSize(this.fullScreen.isFullScreen())};this._onScreenChangeHandler=t,S.onScreenChange.subscribe(t)}catch(S){console.warn("Failed to attach onScreenChange handler",S)}return L}setPreferredViewportSize(S){this.config.viewport.width=S?.width??Number.POSITIVE_INFINITY,this.config.viewport.height=S?.height??Number.POSITIVE_INFINITY,this.updateViewportSize(this.fullScreen.isFullScreen())}onFullScreenChange(S){navigator.keyboard&&(S?navigator.keyboard.lock(["Escape",...this.config.devMode?[]:["F5","F12"],"F11"])?.catch?.(S=>console.warn("Keyboard lock failed",S)):navigator.keyboard.unlock())}updateViewportSize(S){let O,B;if(B=S?(O=window.innerWidth,window.innerHeight):(O=Math.min(window.innerWidth,this.config.viewport.width),Math.min(window.innerHeight,this.config.viewport.height)),O-=O%2,B-=B%2,"menu"===this.viewportClampMode)O=Math.max(800,O),B=Math.max(600,B);else if(S){let S=Number(this.runtimeVars?.fullScreenZoomOut?.value??1);S=Number.isFinite(S)?S:1,S=Math.max(1,Math.min(2,S)),O=Math.floor(O*S),B=Math.floor(B*S),O-=O%2,B-=B%2}this.applyStageScale(O,B),this.setViewportSize(O,B),this.splashScreen?.setSize(O,B)}requestViewportResync(){try{this._viewportResyncTimers?.forEach(S=>clearTimeout(S)),this._viewportResyncTimers=[]}catch{}try{this._viewportResyncTimers.push(setTimeout(()=>this.updateViewportSize(this.fullScreen?.isFullScreen?.()??!1),60)),this._viewportResyncTimers.push(setTimeout(()=>this.updateViewportSize(this.fullScreen?.isFullScreen?.()??!1),220))}catch{}}applyStageScale(S,O){if(!this.stageEl)return;let B=window.innerWidth,N=window.innerHeight;if(!(B>0&&N>0&&S>0&&O>0))return;let j=Math.min(B/S,N/O,1);j=Math.max(.1,j),this.stageEl.style.width=S+"px",this.stageEl.style.height=O+"px",this.stageEl.style.transform=`scale(${j}) translate(-50%, -50%)`}setViewportSize(S,O){this.viewport.value={x:this.viewport.value.x,y:this.viewport.value.y,width:S,height:O}}async destroy(){try{if(this._onScreenChangeHandler&&this.gui){let S=this.gui.getRootController?.();S?.onScreenChange?.unsubscribe?.(this._onScreenChangeHandler)}}catch(S){console.warn("Failed to detach onScreenChange handler",S)}this._onScreenChangeHandler=void 0,this._onViewportClampModeEvent&&window.removeEventListener("ra2web:viewportClampMode",this._onViewportClampModeEvent),this._onViewportClampModeEvent=void 0;try{this._viewportResyncTimers?.forEach(S=>clearTimeout(S)),this._viewportResyncTimers=[]}catch{}await(this.gui?.destroy()),this.gui=void 0,this.splashScreen&&(this.splashScreen.destroy(),this.splashScreen=void 0)}}),Ne.resPath="res/"}}}),System.register("BattleControlApi",[],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[],execute:function(){S("BattleControlApi",class{constructor(){B.set(this,new Set),N.set(this,void 0)}_setWorldInteraction(S){__classPrivateFieldSet(this,N,S,"f")}_notifyToggle(S){for(var O of __classPrivateFieldGet(this,B,"f"))try{O(S)}catch(S){console.error(S)}}onToggle(S){return __classPrivateFieldGet(this,B,"f").add(S),()=>{__classPrivateFieldGet(this,B,"f").delete(S)}}requestPan(S,O){var B=new THREE.Vector2(S,O);__classPrivateFieldGet(this,N,"f")?.customScrollHandler.requestScroll(B)}cancelPan(){__classPrivateFieldGet(this,N,"f")?.customScrollHandler.cancel()}executeKeyCommand(S){__classPrivateFieldGet(this,N,"f")?.keyboardHandler.executeCommand(S)}applyKeyModifiers(S){__classPrivateFieldGet(this,N,"f")?.applyKeyModifiers(S)}cancelSelection(){__classPrivateFieldGet(this,N,"f")?.cancelSelection()}virtualTap(S,O,B){return __classPrivateFieldGet(this,N,"f")?.virtualTap(S,O,B)}}),B=new WeakMap,N=new WeakMap}}}),System.register("ClientApi",["BattleControlApi"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ClientApi",class{constructor(){this.battleControl=new B.BattleControlApi}})}}}),System.register("Config",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("Config",class{constructor(){this.corsProxies=[]}load(S){let O=S.getSection("General");if(!O)throw new Error("Missing [General] section in application config");this.generalData=O,this.viewport={width:O.getNumber("viewport.width"),height:O.getNumber("viewport.height")};let B=S.getSection("Sentry");B&&(this.sentry={dsn:B.getString("dsn"),env:B.getString("env"),defaultIntegrations:B.getBool("defaultIntegrations"),lazyLoad:B.getBool("lazyLoad",!0)});var N=S.getSection("CorsProxy");if(N)for(var[j,L]of N.entries)this.corsProxies.push([j,L])}get defaultLocale(){return this.generalData.getString("defaultLanguage","en-US")}get serversUrl(){return this.generalData.getString("serversUrl","servers.ini")}get gameresBaseUrl(){return this.generalData.getString("gameresBaseUrl")||void 0}get gameResArchiveUrl(){return this.generalData.getString("gameResArchiveUrl")}get defaultFullyPackUrl(){var S=this.generalData.getString("defaultFullyPackUrl");if(S&&S.length)return S}get mapsBaseUrl(){return this.generalData.getString("mapsBaseUrl")}get modsBaseUrl(){return this.generalData.getString("modsBaseUrl")}get devMode(){return this.generalData.getBool("dev")}get discordUrl(){var S=this.generalData.getString("discordUrl");if(S.length)return S}get patchNotesUrl(){var S=this.generalData.getString("patchNotesUrl");if(S.length)return S}get ladderRulesUrl(){var S=this.generalData.getString("ladderRulesUrl");if(S.length)return S}get modSdkUrl(){var S=this.generalData.getString("modSdkUrl");if(S.length)return S}get donateUrl(){var S=this.generalData.getString("donateUrl");if(S.length)return S}get breakingNewsUrl(){var S=this.generalData.getString("breakingNewsUrl");if(S.length)return S}get quickMatchEnabled(){return this.generalData.getBool("quickMatchEnabled")}get unrankedQueueEnabled(){return this.generalData.getBool("unrankedQueueEnabled",!0)}get botsEnabled(){return this.generalData.getBool("botsEnabled")}get oldClientsBaseUrl(){var S=this.generalData.getString("oldClientsBaseUrl");if(S.length)return S}get debugGameState(){return this.generalData.getBool("debugGameState")}get debugLogging(){var S=this.generalData.getString("debugLogging")||void 0;return S?this.generalData.getBool("debugLogging")||S:void 0}getCorsProxy(S){let O;for(var[B,N]of this.corsProxies){if(B.startsWith(".")?S.endsWith(B):S===B)return N;"*"===B&&(O=N)}return O}})}}}),System.register("ConsoleVars",["util/BoxedVar"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ConsoleVars",class{constructor(){this.debugWireframes=new B.BoxedVar(!1),this.debugPaths=new B.BoxedVar(!1),this.debugText=new B.BoxedVar(!1),this.debugBotIndex=new B.BoxedVar(0),this.debugLogging=new B.BoxedVar(!1),this.debugGameState=new B.BoxedVar(!1),this.forceResolution=new B.BoxedVar(void 0),this.freeCamera=new B.BoxedVar(!1),this.fps=new B.BoxedVar(!1),this.cheatsEnabled=new B.BoxedVar(!1),this.fullScreenZoomOut=new B.BoxedVar(1.3),this.mobileJoystickEnabled=new B.BoxedVar(!1)}})}}}),System.register("ErrorHandler",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("ErrorHandler",class{constructor(S,O){this.messageBoxApi=S,this.strings=O}handle(S,O,B){this.isErrorState||(B?this.messageBoxApi.show(O,this.strings.get("GUI:Ok"),()=>{this.isErrorState=!1,B()}):this.messageBoxApi.show(O)),console.error("Handled error:",S),this.isErrorState=!0}})}}}),System.register("Gui",["react","engine/Engine","gui/UiScene","engine/gfx/Renderer","game/rules/Rules","gui/screen/RootController","gui/screen/mainMenu/MainMenuRootScreen","gui/screen/game/GameScreen","gui/screen/game/gameMenu/ScreenType","gui/screen/mainMenu/ScreenType","gui/screen/ScreenType","gui/component/MessageBoxApi","network/WolConnection","network/GservConnection","network/gameopt/Parser","network/gameopt/Serializer","engine/ResourceLoader","ErrorHandler","engine/UiAnimationLoop","util/Logger","tools/DevToolsApi","gui/jsx/JsxRenderer","gui/Pointer","engine/sound/Sound","engine/sound/AudioSystem","engine/sound/Mixer","engine/sound/SoundSpecs","engine/sound/ChannelType","LocalPrefs","gui/screen/game/worldInteraction/keyboard/KeyBinds","gui/ReplayManager","gui/screen/replay/ReplayScreen","data/vfs/FileNotFoundError","engine/sound/Music","engine/sound/MusicSpecs","gui/screen/game/GameLoader","util/BoxedVar","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/gfx/RendererError","gui/replay/ReplayStorageFileSystem","gui/replay/ReplayStorageMemStorage","data/vfs/StorageQuotaError","gui/CanvasMetrics","data/vfs/IOError","util/disposable/CompositeDisposable","gui/component/ToastApi","network/WolService","gui/screen/mainMenu/main/HomeScreen","gui/screen/mainMenu/lobby/SkirmishScreen","gui/screen/mainMenu/login/LoginScreen","gui/screen/mainMenu/newAccount/NewAccountScreen","gui/screen/mainMenu/customGame/CustomGameScreen","gui/screen/mainMenu/lobby/LobbyScreen","gui/screen/mainMenu/mapSel/MapSelScreen","gui/screen/replay/ReplaySelScreen","gui/screen/mainMenu/score/ScoreScreen","gui/screen/mainMenu/infoAndCredits/InfoAndCreditsScreen","gui/screen/mainMenu/credits/CreditsScreen","gui/screen/options/OptionsScreen","gui/screen/options/SoundOptsScreen","gui/screen/options/KeyboardScreen","gui/screen/options/StorageScreen","gui/screen/options/CustomAiManagerScreen","gui/screen/mainMenu/patchNotes/PatchNotesScreen","gui/screen/game/gameMenu/GameMenuHomeScreen","gui/screen/game/gameMenu/DiploScreen","gui/screen/game/gameMenu/ConnectionInfoScreen","gui/screen/game/gameMenu/QuitConfirmScreen","gui/screen/game/loadingScreen/LoadingScreenApiFactory","gui/screen/game/MapFileLoader","gui/screen/mainMenu/modSel/ModSelScreen","gui/screen/mainMenu/modSel/ModManager","gui/screen/mainMenu/quickGame/QuickGameScreen","network/ladder/WLadderService","gui/screen/mainMenu/ladder/LadderScreen","network/WolConfig","gui/screen/mainMenu/ladderRules/LadderRulesScreen","ClientApi","network/WGameResService","network/MapTransferService"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,xe,Oe,Ae,Me,Re,Pe,Ie,ke,Be,Ne,je,Le,De,Fe,_e,Ue,He,Ge,Ve,We,ze,Ke,$e,qe,Qe,Ze,Ye,Xe,Je,et,it,rt,st,nt,at,ot,lt;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S},function(S){ge=S},function(S){pe=S},function(S){me=S},function(S){fe=S},function(S){ye=S},function(S){Te=S},function(S){ve=S},function(S){be=S},function(S){Se=S},function(S){we=S},function(S){Ee=S},function(S){xe=S},function(S){Oe=S},function(S){Ae=S},function(S){Me=S},function(S){Re=S},function(S){Pe=S},function(S){Ie=S},function(S){ke=S},function(S){Be=S},function(S){Ne=S},function(S){je=S},function(S){Le=S},function(S){De=S},function(S){Fe=S},function(S){_e=S},function(S){Ue=S},function(S){He=S},function(S){Ge=S},function(S){Ve=S},function(S){We=S},function(S){ze=S},function(S){Ke=S},function(S){$e=S},function(S){qe=S},function(S){Qe=S},function(S){Ze=S},function(S){Ye=S},function(S){Xe=S},function(S){Je=S},function(S){et=S},function(S){it=S},function(S){rt=S},function(S){st=S},function(S){nt=S},function(S){at=S},function(S){ot=S},function(S){lt=S}],execute:function(){S("Gui",class{constructor(S,O,B,N,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y){this.appVersion=S,this.appLocale=O,this.engineVersion=B,this.engineModHash=N,this.gpuTier=L,this.config=D,this.gameResConfig=F,this.appResPath=_,this.localPrefs=U,this.generalOptions=H,this.rootEl=V,this.viewport=W,this.fullScreen=z,this.strings=K,this.cdnResourceLoader=$,this.fsAccessLib=q,this.serverRegions=Q,this.runtimeVars=Z,this.sentry=Y,this.disposables=new Oe.CompositeDisposable,this.handleFullScreenChange=S=>{S&&this.pointer?.getUserLockMode()&&this.pointer.lock()},this.handleViewportChange=S=>{var O;this.renderer?.setViewportSize(S.width,S.height),this.uiScene&&(O=j.UiScene.createCamera(this.viewport.value),this.uiScene.setCamera(O),this.uiScene.setViewport(this.viewport.value),this.jsxRenderer?.setCamera(O),this.messageBoxApi?.updateViewport(this.viewport.value),this.rootController?.rerenderCurrentScreen(),this.canvasMetrics?.notifyViewportChange())}}getRootController(){if(!this.rootController)throw new Error("Root controller is not initialized");return this.rootController}async init(S){let O,B,L=this.strings;try{({renderer:O,uiAnimationLoop:B}=this.initRenderer(this.rootEl,this.viewport.value,this.config.devMode))}catch(S){if(S instanceof ve.RendererError)return console.error(S.cause),void alert(L.get("TS:RendererInitError"));throw S}this.renderer=O,this.viewport.onChange.subscribe(this.handleViewportChange),this.disposables.add(()=>this.viewport.onChange.unsubscribe(this.handleViewportChange)),this.fullScreen.onChange.subscribe(this.handleFullScreenChange),this.disposables.add(()=>this.fullScreen.onChange.unsubscribe(this.handleFullScreenChange));var X=this.gameResConfig;let ee=j.UiScene.factory(this.viewport.value),re=this.canvasMetrics=new Ee.CanvasMetrics(O.getCanvas(),window);re.init(),this.disposables.add(re);let se=this.pointer=ie.Pointer.factory(N.Engine.getImages().get("mouse.shp"),N.Engine.getPalettes().get("mousepal.pal"),O,document,re,this.generalOptions.mouseAcceleration);se.init(),this.disposables.add(se),ee.add(se.getSprite());var ne=this.jsxRenderer=new te.JsxRenderer(N.Engine.getImages(),N.Engine.getPalettes(),ee.camera,se.pointerEvents);this.toastApi=new Ae.ToastApi(this.viewport,ee,ne),this.disposables.add(this.toastApi),this.messageBoxApi=new z.MessageBoxApi(this.viewport.value,ee,ne);var ae=new Y.ErrorHandler(this.messageBoxApi,L),oe=new q.Parser,ge=new Q.Serializer;let pe=this.rootController=new F.RootController(this.serverRegions);var Oe=N.Engine.getMpModes(),ct=N.Engine.getFileNameVariant("keyboard.ini");let ht=new ce.KeyBinds(N.Engine.rfs?.getRootDirectory(),ct,N.Engine.getIni(ct));await ht.load();var ut=await N.Engine.getReplayDir().catch(S=>{console.error("Couldn't get replay directory",[S]),S instanceof we.StorageQuotaError||S instanceof xe.IOError||S instanceof de.FileNotFoundError||this.sentry?.captureException(new Error(`Couldn't get replay directory (${S.name})`,{cause:S}))}),dt=ut?new be.ReplayStorageFileSystem(ut,this.sentry):new Se.ReplayStorageMemStorage,gt=new he.ReplayManager(dt);let pt=this.generalOptions;var mt=new Z.ResourceLoader(this.config.mapsBaseUrl),ft=new Z.ResourceLoader(this.appResPath),yt=new Z.ResourceLoader(this.config.modsBaseUrl),Tt=new Ye.MapFileLoader(mt,N.Engine.vfs),vt=J.AppLogger.get("wol"),bt=st.WolConfig.factory(st.ClientType.Cdral2),St=K.WolConnection.factory(vt);let wt=new Me.WolService(bt,St,this.appVersion,this.appLocale);wt.init(),this.disposables.add(wt);var Ct=new it.WLadderService(bt),Et=new ot.WGameResService(wt,bt),xt=new lt.MapTransferService(wt),Ot=J.AppLogger.get("gserv"),At=$.GservConnection.factory(Ot),Mt=N.Engine.getMapList(),Rt=await N.Engine.getModDir().catch(S=>{console.error("Couldn't get mods directory",[S]),S instanceof we.StorageQuotaError||S instanceof xe.IOError||S instanceof de.FileNotFoundError||this.sentry?.captureException(new Error(`Couldn't get mods directory (${S.name})`,{cause:S}))});let Pt=Rt?new Je.ModManager(window.location,Rt,ft):void 0;var It=N.Engine.getActiveMod();let kt;ct=It?await(Pt?.loadModMeta(It)):void 0,ut=await N.Engine.getMapDir().catch(S=>{console.error("Couldn't get map dir",[S])}),dt=J.AppLogger.get("ini");try{kt=new D.Rules(N.Engine.getRules(),dt)}catch(S){if(It&&Pt)return console.error(S),O.addScene(ee),this.uiScene=ee,this.rootEl.appendChild(ee.getHtmlContainer().getElement()),await this.messageBoxApi.alert(L.get("TS:ModLoadError"),L.get("GUI:Ok")),void Pt.loadMod(void 0);throw S}var{mixer:mt,sound:bt,music:Ot}=await this.initSound(kt,X);let Bt=(new Map).set(V.ScreenType.Home,new Re.HomeScreen(L,this.fullScreen,this.appVersion,!(!N.Engine.rfs||!Rt),!N.Engine.getActiveMod()&&this.config.quickMatchEnabled)).set(V.ScreenType.Skirmish,new Pe.SkirmishScreen(pe,ae,this.messageBoxApi,L,kt,ne,Tt,Mt,Oe,this.localPrefs)).set(V.ScreenType.Login,new Ie.LoginScreen(wt,Ct,Et,xt,L,ne,this.messageBoxApi,this.serverRegions,this.config.serversUrl,this.config.breakingNewsUrl,vt,ae,this.localPrefs,pe)).set(V.ScreenType.NewAccount,new ke.NewAccountScreen(this.appLocale,L,ne,this.messageBoxApi,this.serverRegions,ae,this.localPrefs)).set(V.ScreenType.QuickGame,new et.QuickGameScreen(this.config.unrankedQueueEnabled,this.engineVersion,this.engineModHash,this.appLocale,kt,wt,St,Ct,this.serverRegions,pe,this.messageBoxApi,ne,L,this.localPrefs,bt,ae)).set(V.ScreenType.Ladder,new rt.LadderScreen(Ct,ne,ae,this.messageBoxApi,L,this.appLocale)).set(V.ScreenType.CustomGame,new Be.CustomGameScreen(this.engineModHash,L,St,wt,Ct,ne,bt,this.serverRegions,Mt,ae)).set(V.ScreenType.Lobby,new Ne.LobbyScreen(this.config.botsEnabled,this.engineModHash,ct,pe,ae,this.messageBoxApi,L,ee,St,wt,Ct,xt,At,kt,oe,ge,ne,Tt,Mt,Oe,bt,this.localPrefs)).set(V.ScreenType.MapSelection,new je.MapSelScreen(L,ne,Tt,ae,this.messageBoxApi,this.localPrefs,Mt,Oe,ut,this.fsAccessLib,this.sentry)).set(V.ScreenType.ReplaySelection,new Le.ReplaySelScreen(this.engineVersion,this.engineModHash,It,this.config.oldClientsBaseUrl,pe,L,ne,ae,this.messageBoxApi,gt,ee,kt,this.sentry)).set(V.ScreenType.Score,new De.ScoreScreen(L,ne,this.messageBoxApi,this.localPrefs,this.config,wt)).set(V.ScreenType.InfoAndCredits,new Fe.InfoAndCreditsScreen(L,this.config,this.messageBoxApi)).set(V.ScreenType.Credits,new _e.CreditsScreen(L,ne)).set(V.ScreenType.Options,new Ue.OptionsScreen(L,ne,pt,this.localPrefs,this.fullScreen,!1,!!N.Engine.rfs)).set(V.ScreenType.OptionsSound,new He.SoundOptsScreen(L,ne,mt,void 0,this.localPrefs)).set(V.ScreenType.OptionsKeyboard,new Ge.KeyboardScreen(L,ne,ht)).set(V.ScreenType.OptionsStorage,new Ve.StorageScreen(L,ne,this.messageBoxApi,N.Engine.rfs)).set(V.ScreenType.CustomAiManager,new We.CustomAiManagerScreen(L,ne,this.messageBoxApi,N.Engine.rfs));Pt&&Bt.set(V.ScreenType.ModSelection,new Xe.ModSelScreen(pe,L,ne,ae,this.messageBoxApi,Pt,N.Engine.getActiveMod(),this.config.modSdkUrl,yt,this.fsAccessLib,this.sentry)),this.config.patchNotesUrl&&Bt.set(V.ScreenType.PatchNotes,new ze.PatchNotesScreen(L,ne,this.config.patchNotesUrl)),this.config.ladderRulesUrl&&Bt.set(V.ScreenType.LadderRules,new nt.LadderRulesScreen(L,ne,this.config.ladderRulesUrl)),vt=await this.getMainMenuVideoUrl(X,Rt),ct=new _.MainMenuRootScreen(Bt,ee,X,L,N.Engine.getImages(),ne,vt,this.cdnResourceLoader,bt,Ot,this.sentry),St=new Te.VxlGeometryCache(await N.Engine.getCacheDir(),N.Engine.getActiveMod());let Nt=new ye.VxlGeometryPool(St,pt.graphics.models.value);pt.graphics.models.onChange.subscribe(S=>{Nt.setModelQuality(S),Nt.clear(),Nt.clearStorage().catch(S=>console.warn("Couldn't clear VXL geocache",[S]))}),Ct=window.CDWorkerHostLib,It=new fe.BoxedVar(!1),yt=new Map,Rt=J.AppLogger.get("action"),vt=J.AppLogger.get("lockstep"),St=new me.GameLoader(this.appVersion,Ct,this.cdnResourceLoader,ft,kt,Oe,bt,dt,Rt,It,X,Nt,yt,this.runtimeVars.debugBotIndex,this.config.devMode),ft=new Set;let jt=new fe.BoxedVar(Boolean(Number(this.localPrefs.getItem(le.StorageKey.TauntsEnabled)??"1")));const tt=S=>{this.localPrefs.setItem(le.StorageKey.TauntsEnabled,String(Number(S)))};jt.onChange.subscribe(tt),this.disposables.add(()=>jt.onChange.unsubscribe(tt)),dt=(new Map).set(H.ScreenType.Home,new Ke.GameMenuHomeScreen(L,this.fullScreen)).set(H.ScreenType.Diplo,new $e.DiploScreen(L,ne,O,Oe,jt,ft)).set(H.ScreenType.ConnectionInfo,new qe.ConnectionInfoScreen(L,ne)).set(H.ScreenType.QuitConfirm,new Qe.QuitConfirmScreen(L)).set(H.ScreenType.Options,new Ue.OptionsScreen(L,ne,pt,this.localPrefs,this.fullScreen,!0,!1)).set(H.ScreenType.OptionsSound,new He.SoundOptsScreen(L,ne,mt,Ot,this.localPrefs)).set(H.ScreenType.OptionsKeyboard,new Ge.KeyboardScreen(L,ne,ht)),Oe=new Ze.LoadingScreenApiFactory(kt,L,ee,ne,X,At),X=new at.ClientApi,window.dispatchEvent(new CustomEvent("CdApiReady",{detail:X})),window.CdApi=X,It=new U.GameScreen(Ct,At,Et,wt,xt,this.engineVersion,this.engineModHash,ae,dt,Oe,oe,ge,this.config,L,O,ee,this.runtimeVars,this.messageBoxApi,this.toastApi,B,this.viewport,ne,se,bt,Ot,mt,ht,pt,this.localPrefs,Rt,vt,gt,this.fullScreen,Tt,ut,Mt,St,Nt,yt,ft,jt,It,this.sentry,X.battleControl),X=new ue.ReplayScreen(this.engineVersion,this.engineModHash,ae,dt,Oe,this.config,L,O,ee,this.runtimeVars,this.messageBoxApi,B,this.viewport,ne,se,bt,Ot,ht,pt,Rt,this.fullScreen,Tt,St,Nt,yt,()=>{void 0!==S?(window.close(),(async()=>{await this.destroy(),document.body.appendChild(document.createTextNode(L.get("GUI:ReplayWindowClose")))})()):pe.goToScreen(W.ScreenType.MainMenuRoot)},X.battleControl),pe.addScreen(W.ScreenType.MainMenuRoot,ct),pe.addScreen(W.ScreenType.Game,It),pe.addScreen(W.ScreenType.Replay,X),O.addScene(ee),this.uiScene=ee,this.rootEl.appendChild(ee.getHtmlContainer().getElement()),await this.routeToInitialScreen(pe,pt,Ot,bt,S,gt),this.initTestApi(pe,ct)}async initTestApi(S,O){try{const{TestApi:B}=await SystemJS.import("tools/TestApi"),N=new B;N.init(this,S),N.mainMenuController=O?.mainMenuCtrl}catch(S){console.warn("[TestApi] Failed to initialize:",S)}}async getMainMenuVideoUrl(S,O){let B,j=N.Engine.rfsSettings.menuVideoFileName;if(S.isCdn())B=S.getCdnBaseUrl()+j.replace(".webm",".mp4");else try{let S;O&&await O.containsEntry(j)&&(S=await O.getRawFile(j)),!S&&await(N.Engine.rfs?.containsEntry(j))&&(S=await N.Engine.rfs.getRawFile(j)),!S&&N.Engine.vfs?.fileExists(j)&&(S=N.Engine.vfs.openFile(j).asFile()),B=S?new File([S],S.name,{type:"video/webm"}):(console.warn("Main menu video file not found in browser FS"),"")}catch(S){console.error("Failed to read video file from browser FS"),B=""}return B}async routeToInitialScreen(S,O,N,j,L,D){let F=!1;var _=this.localPrefs.getItem(le.StorageKey.LastConnection);let U,H;if(_)try{U=JSON.parse(_)}catch(S){console.error(`Unable to decode game params string "${_}"`)}if(U){var V=await this.messageBoxApi.confirm(this.strings.get("TS:ReconnectPrompt"),this.strings.get("TS:Reconnect"),this.strings.get("GUI:Quit"));if(F=!0,V)return U.create=!1,void S.goToScreen(W.ScreenType.Game,U);this.localPrefs.removeItem(le.StorageKey.LastConnection)}if(void 0!==(_=this.gpuTier)&&(V=this.localPrefs.getItem(le.StorageKey.LastGpuTier),2<=_.tier?void 0!==V&&Number(V)!==_.tier?(await this.confirmHighGfxSettings()&&(O.graphics.applyHighPreset(),this.localPrefs.setItem(le.StorageKey.Options,O.serialize())),F=!0):void 0===V&&_.isMobile&&(O.graphics.applyLowPreset(),this.localPrefs.setItem(le.StorageKey.Options,O.serialize())):(void 0===V||2<=Number(V))&&(await this.confirmLowGfxSettings()&&(O.graphics.applyLowPreset(),this.localPrefs.setItem(le.StorageKey.Options,O.serialize())),F=!0),this.localPrefs.setItem(le.StorageKey.LastGpuTier,""+_.tier)),(_=this.localPrefs.getItem(le.StorageKey.LastSeenPatch))&&_!==this.appVersion&&(await new Promise(S=>this.messageBoxApi.show(B.default.createElement("iframe",{src:this.config.patchNotesUrl,className:"patch-notes"}),[{label:this.strings.get("GUI:Continue"),onClick:S}],{className:"patch-notes-box"})),F=!0),_&&_===this.appVersion||this.localPrefs.setItem(le.StorageKey.LastSeenPatch,this.appVersion),N&&!F&&j.audioSystem.isSuspended()&&await new Promise(S=>this.messageBoxApi.show(this.strings.get("GUI:RequestAudioPermission"),this.strings.get("GUI:OK"),async()=>{await j.audioSystem.initMusicLoop().catch(S=>console.error(S)),S()})),void 0!==L)try{var z=(await D.loadList()).find(S=>S.id===L);if(!z)throw new Error(`Replay ID "${L}" not found`);H=await D.loadReplay(z)}catch(S){await this.messageBoxApi.alert(this.strings.get("GUI:ReplayError"),this.strings.get("GUI:Ok"))}H?S.goToScreen(W.ScreenType.Replay,{replay:H}):S.goToScreen(W.ScreenType.MainMenuRoot)}async confirmLowGfxSettings(){return await this.messageBoxApi.confirm(B.default.createElement("div",{dangerouslySetInnerHTML:{__html:this.strings.get("TS:RendererWarning").replace(/\n/g,"<br />").replace("{link}",'<a href="https://www.windowsdigitals.com/force-chrome-firefox-game-to-use-nvidia-gpu-integrated-graphics/" target="_blank" rel="noreferrer noopener">').replace("{/link}","</a>")}}),this.strings.get("TS:RendererUseLow"),this.strings.get("TS:RendererIgnore"))}async confirmHighGfxSettings(){return await this.messageBoxApi.confirm(this.strings.get("TS:RendererChangeDesc"),this.strings.get("GUI:Yes"),this.strings.get("GUI:No"))}initRenderer(S,O,B){var{width:N,height:j}=O;let D=new L.Renderer(N,j);D.init(S),this.disposables.add(D),ee.DevToolsApi.registerVar("fps",this.runtimeVars.fps),this.disposables.add(()=>ee.DevToolsApi.unregisterVar("fps")),this.runtimeVars.fps.onChange.subscribe(O=>{O?D.initStats(S):D.destroyStats()}),B&&(this.runtimeVars.fps.value=!0),this.runtimeVars.fps.value&&D.initStats(S);let F=new X.UiAnimationLoop(D);return F.start(),this.disposables.add(F),S.addEventListener("contextmenu",S=>{"A"===S.target.nodeName&&S.target.href.length||S.preventDefault()}),B||window.addEventListener("beforeunload",S=>{this.rootController?.getCurrentScreen()?.preventUnload&&(S.preventDefault(),S.returnValue="")}),D.getCanvas().addEventListener("mousedown",S=>{S.preventDefault()}),{renderer:D,uiAnimationLoop:F}}async initSound(S,O){let B;var j=this.localPrefs.getItem(le.StorageKey.Mixer);if(j)try{B=(new ne.Mixer).unserialize(j)}catch(S){console.warn("Failed to read mixer values from local storage",[S])}B||(B=new ne.Mixer,B.setVolume(oe.ChannelType.Master,.4),B.setVolume(oe.ChannelType.CreditTicks,.2),B.setVolume(oe.ChannelType.Music,.3),B.setVolume(oe.ChannelType.Ambient,.3));let L,D,F=new re.Sound(new se.AudioSystem(B),N.Engine.getSounds(),new ae.SoundSpecs(N.Engine.getIni("sound.ini")),S.audioVisual,document);F.initialize(),this.disposables.add(F);try{L=!!await(N.Engine.rfs?.containsEntry(N.Engine.rfsSettings.musicDir))}catch(S){console.error("Couldn't get music directory",[S]),S instanceof we.StorageQuotaError||S instanceof xe.IOError||S instanceof de.FileNotFoundError||this.sentry?.captureException(new Error(`Couldn't get music directory (${S.name})`,{cause:S})),L=!1}if(L&&(D=new ge.Music(F.audioSystem,N.Engine.getThemes(),new pe.MusicSpecs(N.Engine.getIni(N.Engine.getFileNameVariant("theme.ini")))),this.disposables.add(D),j=this.localPrefs.getItem(le.StorageKey.MusicOpts)))try{D.unserializeOptions(j)}catch(S){console.warn("Failed to read music options from local storage",[S])}return{mixer:B,sound:F,music:D}}async destroy(){var S;this.messageBoxApi&&(this.messageBoxApi.destroy(),this.messageBoxApi=void 0),this.rootController&&(await this.rootController.leaveCurrentScreen(),this.rootController.destroy()),this.uiScene&&((S=this.uiScene.getHtmlContainer()?.getElement())&&this.rootEl.removeChild(S),this.uiScene.destroy()),this.disposables.dispose()}})}}}),System.register("LocalPrefs",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("StorageKey",B={})).GameRes="_r_gameRes",O.Options="_r_opts_v3",O.Mixer="_r_mixer_v3",O.MusicOpts="_r_opts_music",O.LastGpuTier="_r_last_gpu",O.LastSeenPatch="_r_last_patch",O.LastMap="_r_lastMap",O.LastMode="_r_lastMode",O.LastSortMap="_r_lastSortMap",O.LastPlayerCountry="_r_lastCountry",O.LastPlayerColor="_r_lastColor",O.LastPlayerStartPos="_r_lastStartPos",O.LastPlayerTeam="_r_lastTeam",O.LastQueueRanked="_r_lastRanked",O.LastQueueType="_r_lastQueueType",O.LastBots="_r_lastBots",O.PreferredGameOpts="_r_hostOpts",O.LastConnection="_r_lastCon",O.PreferredServerRegion="_r_region",O.TauntsEnabled="_r_taunts",O.DonateBoxState="_r_donateBoxState",O.MobileJoystick="_r_mobileJoystick_v1",S("LocalPrefs",class{constructor(S){this.storage=S}getItem(S){try{return this.storage?.getItem(S)??void 0}catch(O){return void console.warn(`Unable to read key ${S} from localStorage.`,O)}}setItem(S,O){try{return this.storage?.setItem(S,O),!0}catch(O){return console.warn(`Unable to write key ${S} to localStorage.`,O),!1}}removeItem(S){try{this.storage?.removeItem(S)}catch(O){console.warn(`Unable to remove key ${S} from localStorage.`,O)}}listItems(){return this.storage?Object.keys(this.storage):[]}})}}}),System.register("RouteHelper",["util/Base64"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("RouteHelper",N=class{static getGameRoute(S){return"#/game/"+B.Base64.encode(JSON.stringify({gameId:S.gameId,gameTimestamp:S.gameTimestamp,gservUrl:S.gservUrl,playerName:S.playerName,gameOpts:S.gameOpts,tournament:S.tournament}))}static extractGameParams(S){return JSON.parse(B.Base64.decode(S))}}),N.modQueryStringName="mod"}}}),System.register("data/AudioBagFile",["data/DataStream","data/vfs/VirtualFile"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("AudioBagFile",class{constructor(){this.fileData=new Map}fromVirtualFile(S,O){var B,N;for([B,N]of O.entries){var j=this.buildWavData(S.stream,N);this.fileData.set(B,j)}return this}getFileList(){return[...this.fileData.keys()]}containsFile(S){return this.fileData.has(S)}openFile(S){if(!this.containsFile(S))throw new Error(`File "${S}" not found`);return new N.VirtualFile(this.fileData.get(S),S)}buildWavData(S,O){let N=new B.DataStream;var j,L,D,F,_=0<(1&O.flags)?2:1;let U=0;0<(2&O.flags)?(N.writeString("RIFF"),N.writeUint32(O.length+36),N.writeString("WAVE"),N.writeString("fmt "),N.writeInt32(16),N.writeInt16(1),N.writeInt16(_),N.writeUint32(O.sampleRate),N.writeUint32(2*_*O.sampleRate),N.writeInt16(2*_),N.writeInt16(16),N.writeString("data"),N.writeUint32(O.length)):0<(8&O.flags)&&(j=11100*_*(O.sampleRate/22050|0),L=O.chunkSize,D=1017*(F=Math.max(2,Math.ceil(O.length/L))),U=(F*=L)-O.length,N.writeString("RIFF"),N.writeUint32(52+F),N.writeString("WAVE"),N.writeString("fmt "),N.writeUint32(20),N.writeInt16(17),N.writeInt16(_),N.writeUint32(O.sampleRate),N.writeInt32(j),N.writeInt16(L),N.writeInt16(4),N.writeInt16(2),N.writeInt16(1017),N.writeString("fact"),N.writeUint32(4),N.writeInt32(D),N.writeString("data"),N.writeUint32(F)),S.seek(O.offset),N.writeUint8Array(S.readUint8Array(O.length));for(let S=0;S<U;S++)N.writeUint8(0);return N.seek(0),N._trimAlloc=()=>{},N}})}}}),System.register("data/Bitmap",[],function(S,O){"use strict";var B,N,j;function a(S){switch(S){case B.Indexed:return 1;case B.Rgb:return 3;case B.Rgba:return 4;default:throw new Error("Unsupported pixel format "+S)}}return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("PixelFormat",B={}))[O.Rgb=1]="Rgb",O[O.Rgba=2]="Rgba",O[O.Indexed=3]="Indexed",S("Bitmap",N=class{constructor(S,O,N,j=B.Rgba){var L=a(j);this.data=N||new Uint8Array(L*S*O),this.pixelFormat=j,this.width=S,this.height=O}drawIndexedImage(S,O,B){var N=a(this.pixelFormat);const j=this.data;var L=this.width,D=N*L,F=N*L*this.height;let _=0+D*B+N*O,U=0;for(let O=0;O<S.height;O++){for(let O=0;O<S.width;O++){var H=S.data[U];0!==H&&0<=_&&_<F&&(j[_]=H,3<=N&&(j[_+1]=0,j[_+2]=0),4===N&&(j[_+3]=255)),_+=N,U++}_+=D-S.width*N}}}),j=class extends N{constructor(S,O,N){super(S,O,N,B.Indexed)}},S("IndexedBitmap",j),j=class extends N{constructor(S,O,N){super(S,O,N,B.Rgb)}},S("RgbBitmap",j),j=class extends N{constructor(S,O,N){super(S,O,N,B.Rgba)}drawRgbaImage(S,O,B){const N=this.data;var j=this.width,L=4*j,D=4*j*this.height;let F=0+L*B+4*O,_=0;for(let O=0;O<S.height;O++){for(let O=0;O<S.width;O++)0<=F&&F<D&&(N[F]=S.data[_],N[F+1]=S.data[_+1],N[F+2]=S.data[_+2],N[F+3]=S.data[_+3]),F+=4,_+=4;F+=L-4*S.width}}},S("RgbaBitmap",j)}}}),System.register("data/Crc32",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){S("Crc32",B=class e{static calculateCrc(S,O=4294967295){let B=O;for(let O=0,N=S.length;O<N;O++)B=(B>>>8^this.lookUp[255&B^S[O]])>>>0;return B=(B^O)>>>0,B}constructor(S=4294967295){this.polynomal=S,this.crc=S}append(S){for(let O=0,B=S.length;O<B;O++)this.crc=(this.crc>>>8^e.lookUp[255&this.crc^S[O]])>>>0}get(){return(this.crc^this.polynomal)>>>0}}),B.lookUp=new Uint32Array([0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117])}}}),System.register("data/CsfFile",[],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[],execute:function(){var O;B=new Uint32Array(new Uint8Array(Array.prototype.map.call("STRW",S=>S.charCodeAt(0)).reverse()).buffer)[0],N=S=>S.map(S=>~S>>>0),j=S=>{let O="";for(let B=0;B<S.length;B+=2)O+=String.fromCharCode(S[B+1]<<8|S[B]);return O},(O=L||S("CsfLanguage",L={}))[O.EnglishUS=0]="EnglishUS",O[O.EnglishUK=1]="EnglishUK",O[O.German=2]="German",O[O.French=3]="French",O[O.Spanish=4]="Spanish",O[O.Italian=5]="Italian",O[O.Japanese=6]="Japanese",O[O.Jabberwockie=7]="Jabberwockie",O[O.Korean=8]="Korean",O[O.Unknown=9]="Unknown",O[O.ChineseCN=100]="ChineseCN",O[O.ChineseTW=101]="ChineseTW",S("csfLocaleMap",D=(new Map).set(L.EnglishUS,"en-US").set(L.EnglishUK,"en-GB").set(L.German,"de-DE").set(L.French,"fr-FR").set(L.Spanish,"es-ES").set(L.Italian,"it-IT").set(L.Japanese,"ja-JP").set(L.Korean,"ko-KR").set(L.ChineseCN,"zh-CN").set(L.ChineseTW,"zh-TW")),S("CsfFile",class{constructor(S){this.language=L.Unknown,this.data={},S&&this.fromVirtualFile(S)}fromVirtualFile(S){let O=S.stream;O.readInt32(),O.readInt32();var D=O.readInt32();O.readInt32(),O.readInt32(),this.language=O.readInt32();for(let S=0;S<D;S++){O.readInt32();var F,_=O.readInt32(),U=O.readString(O.readInt32());1&_?(F=O.readInt32()===B,_=N(O.readUint8Array(2*O.readInt32())),_=j(_),F&&O.readString(O.readInt32()),this.data[U]=_):this.data[U]=""}this.language===L.Unknown&&this.autoDetectLocale()}autoDetectLocale(){switch(this.data["THEME:Intro"]){case"":this.language=L.ChineseTW;break;case"":this.language=L.ChineseCN}}getIsoLocale(){return D.get(this.language)}})}}}),System.register("data/DataStream",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){S("DataStream",B=class e{constructor(S,O,B=e.LITTLE_ENDIAN){this.endianness=B,this.position=0,this._dynamicSize=!0,this._byteLength=0,this._byteOffset=O||0,S instanceof ArrayBuffer?this.buffer=S:"object"==typeof S?(this.dataView=S,O&&(this._byteOffset+=O)):this.buffer=new ArrayBuffer(S||0)}get dynamicSize(){return this._dynamicSize}set dynamicSize(S){S||this._trimAlloc(),this._dynamicSize=S}get byteLength(){return this._byteLength-this._byteOffset}get buffer(){return this._trimAlloc(),this._buffer}set buffer(S){this._buffer=S,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}get byteOffset(){return this._byteOffset}set byteOffset(S){this._byteOffset=S,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}get dataView(){return this._dataView}set dataView(S){this._byteOffset=S.byteOffset,this._buffer=S.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+S.byteLength}bigEndian(){return this.endianness=e.BIG_ENDIAN,this}_realloc(S){if(this._dynamicSize){var O=this._byteOffset+this.position+S;let j=this._buffer.byteLength;if(O<=j)O>this._byteLength&&(this._byteLength=O);else{for(j<1&&(j=1);O>j;)j*=2;var B=new ArrayBuffer(j),N=new Uint8Array(this._buffer);new Uint8Array(B,0,N.length).set(N),this.buffer=B,this._byteLength=O}}}_trimAlloc(){if(this._byteLength!==this._buffer.byteLength){var S=new ArrayBuffer(this._byteLength);const B=new Uint8Array(S);var O=new Uint8Array(this._buffer,0,B.length);B.set(O),this.buffer=S}}seek(S){var O=Math.max(0,Math.min(this.byteLength,S));this.position=isNaN(O)||!isFinite(O)?0:O}isEof(){return this.position>=this.byteLength}mapInt32Array(S,O){this._realloc(4*S);var B=new Int32Array(this._buffer,this.byteOffset+this.position,S);return e.arrayToNative(B,void 0===O?this.endianness:O),this.position+=4*S,B}mapInt16Array(S,O){this._realloc(2*S);var B=new Int16Array(this._buffer,this.byteOffset+this.position,S);return e.arrayToNative(B,void 0===O?this.endianness:O),this.position+=2*S,B}mapInt8Array(S){this._realloc(S);var O=new Int8Array(this._buffer,this.byteOffset+this.position,S);return this.position+=S,O}mapUint32Array(S,O){this._realloc(4*S);var B=new Uint32Array(this._buffer,this.byteOffset+this.position,S);return e.arrayToNative(B,void 0===O?this.endianness:O),this.position+=4*S,B}mapUint16Array(S,O){this._realloc(2*S);var B=new Uint16Array(this._buffer,this.byteOffset+this.position,S);return e.arrayToNative(B,void 0===O?this.endianness:O),this.position+=2*S,B}mapUint8Array(S){this._realloc(S);var O=new Uint8Array(this._buffer,this.byteOffset+this.position,S);return this.position+=S,O}mapFloat64Array(S,O){this._realloc(8*S);var B=new Float64Array(this._buffer,this.byteOffset+this.position,S);return e.arrayToNative(B,void 0===O?this.endianness:O),this.position+=8*S,B}mapFloat32Array(S,O){this._realloc(4*S);var B=new Float32Array(this._buffer,this.byteOffset+this.position,S);return e.arrayToNative(B,void 0===O?this.endianness:O),this.position+=4*S,B}readInt32Array(S,O){S=void 0===S?this.byteLength-this.position/4:S;var B=new Int32Array(S);return e.memcpy(B.buffer,0,this.buffer,this.byteOffset+this.position,S*B.BYTES_PER_ELEMENT),e.arrayToNative(B,void 0===O?this.endianness:O),this.position+=B.byteLength,B}readInt16Array(S,O){S=void 0===S?this.byteLength-this.position/2:S;var B=new Int16Array(S);return e.memcpy(B.buffer,0,this.buffer,this.byteOffset+this.position,S*B.BYTES_PER_ELEMENT),e.arrayToNative(B,void 0===O?this.endianness:O),this.position+=B.byteLength,B}readInt8Array(S){S=void 0===S?this.byteLength-this.position:S;var O=new Int8Array(S);return e.memcpy(O.buffer,0,this.buffer,this.byteOffset+this.position,S*O.BYTES_PER_ELEMENT),this.position+=O.byteLength,O}readUint32Array(S,O){S=void 0===S?this.byteLength-this.position/4:S;var B=new Uint32Array(S);return e.memcpy(B.buffer,0,this.buffer,this.byteOffset+this.position,S*B.BYTES_PER_ELEMENT),e.arrayToNative(B,void 0===O?this.endianness:O),this.position+=B.byteLength,B}readUint16Array(S,O){S=void 0===S?this.byteLength-this.position/2:S;var B=new Uint16Array(S);return e.memcpy(B.buffer,0,this.buffer,this.byteOffset+this.position,S*B.BYTES_PER_ELEMENT),e.arrayToNative(B,void 0===O?this.endianness:O),this.position+=B.byteLength,B}readUint8Array(S){S=void 0===S?this.byteLength-this.position:S;var O=new Uint8Array(S);return e.memcpy(O.buffer,0,this.buffer,this.byteOffset+this.position,S*O.BYTES_PER_ELEMENT),this.position+=O.byteLength,O}readFloat64Array(S,O){S=void 0===S?this.byteLength-this.position/8:S;var B=new Float64Array(S);return e.memcpy(B.buffer,0,this.buffer,this.byteOffset+this.position,S*B.BYTES_PER_ELEMENT),e.arrayToNative(B,void 0===O?this.endianness:O),this.position+=B.byteLength,B}readFloat32Array(S,O){S=void 0===S?this.byteLength-this.position/4:S;var B=new Float32Array(S);return e.memcpy(B.buffer,0,this.buffer,this.byteOffset+this.position,S*B.BYTES_PER_ELEMENT),e.arrayToNative(B,void 0===O?this.endianness:O),this.position+=B.byteLength,B}writeInt32Array(S,O){if(this._realloc(4*S.length),S instanceof Int32Array&&(this.byteOffset+this.position)%S.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,S.buffer,S.byteOffset,S.byteLength),this.mapInt32Array(S.length,O);else for(let B=0;B<S.length;B++)this.writeInt32(S[B],O);return this}writeInt16Array(S,O){if(this._realloc(2*S.length),S instanceof Int16Array&&(this.byteOffset+this.position)%S.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,S.buffer,S.byteOffset,S.byteLength),this.mapInt16Array(S.length,O);else for(let B=0;B<S.length;B++)this.writeInt16(S[B],O);return this}writeInt8Array(S){if(this._realloc(S.length),S instanceof Int8Array&&(this.byteOffset+this.position)%S.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,S.buffer,S.byteOffset,S.byteLength),this.mapInt8Array(S.length);else for(let O=0;O<S.length;O++)this.writeInt8(S[O]);return this}writeUint32Array(S,O){if(this._realloc(4*S.length),S instanceof Uint32Array&&(this.byteOffset+this.position)%S.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,S.buffer,S.byteOffset,S.byteLength),this.mapUint32Array(S.length,O);else for(let B=0;B<S.length;B++)this.writeUint32(S[B],O);return this}writeUint16Array(S,O){if(this._realloc(2*S.length),S instanceof Uint16Array&&(this.byteOffset+this.position)%S.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,S.buffer,S.byteOffset,S.byteLength),this.mapUint16Array(S.length,O);else for(let B=0;B<S.length;B++)this.writeUint16(S[B],O);return this}writeUint8Array(S){if(this._realloc(S.length),S instanceof Uint8Array&&(this.byteOffset+this.position)%S.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,S.buffer,S.byteOffset,S.byteLength),this.mapUint8Array(S.length);else for(let O=0;O<S.length;O++)this.writeUint8(S[O]);return this}writeFloat64Array(S,O){if(this._realloc(8*S.length),S instanceof Float64Array&&(this.byteOffset+this.position)%S.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,S.buffer,S.byteOffset,S.byteLength),this.mapFloat64Array(S.length,O);else for(let B=0;B<S.length;B++)this.writeFloat64(S[B],O);return this}writeFloat32Array(S,O){if(this._realloc(4*S.length),S instanceof Float32Array&&(this.byteOffset+this.position)%S.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,S.buffer,S.byteOffset,S.byteLength),this.mapFloat32Array(S.length,O);else for(let B=0;B<S.length;B++)this.writeFloat32(S[B],O);return this}readInt32(S){var O=this._dataView.getInt32(this.position,void 0===S?this.endianness:S);return this.position+=4,O}readInt16(S){var O=this._dataView.getInt16(this.position,void 0===S?this.endianness:S);return this.position+=2,O}readInt8(){var S=this._dataView.getInt8(this.position);return this.position+=1,S}readUint32(S){var O=this._dataView.getUint32(this.position,void 0===S?this.endianness:S);return this.position+=4,O}readUint16(S){var O=this._dataView.getUint16(this.position,void 0===S?this.endianness:S);return this.position+=2,O}readUint8(){var S=this._dataView.getUint8(this.position);return this.position+=1,S}readFloat32(S){var O=this._dataView.getFloat32(this.position,void 0===S?this.endianness:S);return this.position+=4,O}readFloat64(S){var O=this._dataView.getFloat64(this.position,void 0===S?this.endianness:S);return this.position+=8,O}writeInt32(S,O){return this._realloc(4),this._dataView.setInt32(this.position,S,void 0===O?this.endianness:O),this.position+=4,this}writeInt16(S,O){return this._realloc(2),this._dataView.setInt16(this.position,S,void 0===O?this.endianness:O),this.position+=2,this}writeInt8(S){return this._realloc(1),this._dataView.setInt8(this.position,S),this.position+=1,this}writeUint32(S,O){return this._realloc(4),this._dataView.setUint32(this.position,S,void 0===O?this.endianness:O),this.position+=4,this}writeUint16(S,O){return this._realloc(2),this._dataView.setUint16(this.position,S,void 0===O?this.endianness:O),this.position+=2,this}writeUint8(S){return this._realloc(1),this._dataView.setUint8(this.position,S),this.position+=1,this}writeFloat32(S,O){return this._realloc(4),this._dataView.setFloat32(this.position,S,void 0===O?this.endianness:O),this.position+=4,this}writeFloat64(S,O){return this._realloc(8),this._dataView.setFloat64(this.position,S,void 0===O?this.endianness:O),this.position+=8,this}static memcpy(S,O,B,N,j){const L=new Uint8Array(S,O,j);var D=new Uint8Array(B,N,j);L.set(D)}static arrayToNative(S,O){return O===this.endianness?S:this.flipArrayEndianness(S)}static nativeToEndian(S,O){return this.endianness===O?S:this.flipArrayEndianness(S)}static flipArrayEndianness(S){const O=new Uint8Array(S.buffer,S.byteOffset,S.byteLength);for(let N=0;N<S.byteLength;N+=S.BYTES_PER_ELEMENT)for(let j=N+S.BYTES_PER_ELEMENT-1,L=N;j>L;j--,L++){var B=O[L];O[L]=O[j],O[j]=B}return S}static createStringFromArray(S){const O=[];for(let B=0;B<S.length;B+=32768)O.push(String.fromCharCode.apply(void 0,S.subarray(B,B+32768)));return O.join("")}readUCS2String(S,O){return e.createStringFromArray(this.readUint16Array(S,O))}writeUCS2String(S,O,B){void 0===B&&(B=S.length);let N=0;for(;N<S.length&&N<B;N++)this.writeUint16(S.charCodeAt(N),O);for(;N<B;N++)this.writeUint16(0);return this}readString(S,O){return void 0===O||"ASCII"===O?e.createStringFromArray(this.mapUint8Array(void 0===S?this.byteLength-this.position:S)):new TextDecoder(O).decode(this.mapUint8Array(S))}writeString(S,O,B){if(void 0===O||"ASCII"===O)if(void 0!==B){let O;var N=Math.min(S.length,B);for(O=0;O<N;O++)this.writeUint8(S.charCodeAt(O));for(;O<B;O++)this.writeUint8(0)}else for(let O=0;O<S.length;O++)this.writeUint8(S.charCodeAt(O));else this.writeUint8Array((new TextEncoder).encode(S.substring(0,B)));return this}writeUtf8WithLen(S){var O=(new TextEncoder).encode(S);return this.writeUint16(O.length).writeUint8Array(O)}readUtf8WithLen(){var S=this.readUint16();return(new TextDecoder).decode(this.mapUint8Array(S))}readCString(S){var O=this.byteLength-this.position,B=new Uint8Array(this._buffer,this._byteOffset+this.position);let N=O;void 0!==S&&(N=Math.min(S,O));let j=0;for(;j<N&&0!==B[j];j++);var L=e.createStringFromArray(this.mapUint8Array(j));return void 0!==S?this.position+=N-j:j!==O&&(this.position+=1),L}writeCString(S,O){if(void 0!==O){let N;var B=Math.min(S.length,O);for(N=0;N<B;N++)this.writeUint8(S.charCodeAt(N));for(;N<O;N++)this.writeUint8(0)}else{for(let O=0;O<S.length;O++)this.writeUint8(S.charCodeAt(O));this.writeUint8(0)}return this}toUint8Array(){return new Uint8Array(this.buffer,this.byteOffset,this.byteLength)}}),B.BIG_ENDIAN=!1,B.LITTLE_ENDIAN=!0,B.endianness=0<new Int8Array(new Int16Array([1]).buffer)[0]}}}),System.register("data/HvaFile",["data/hva/Section","data/vfs/VirtualFile"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("HvaFile",class{constructor(S){S instanceof N.VirtualFile&&this.fromVirtualFile(S)}fromVirtualFile(S){this.filename=S.filename;let O=S.stream;this.sections=[],O.readCString(16);var N=O.readInt32(),j=O.readInt32();for(let S=0;S<j;++S){let S=new B.Section;S.name=O.readCString(16),S.matrices=new Array(N),this.sections.push(S)}for(let S=0;S<N;++S)for(let B=0;B<j;++B)this.sections[B].matrices[S]=this.readMatrix(O)}readMatrix(S){let O=[];for(let B=0;B<3;++B)O.push(S.readFloat32(),S.readFloat32(),S.readFloat32(),S.readFloat32());return O.push(0,0,0,1),(new THREE.Matrix4).fromArray(O).transpose()}})}}}),System.register("data/IdxEntry",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("IdxEntry",class{})}}}),System.register("data/IdxFile",["data/IdxEntry"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("IdxFile",class{constructor(S){this.entries=new Map,this.parse(S)}parse(S){var O=S.readCString(4);if("GABA"!==O)throw new Error(`Unable to load Idx file, did not find magic id, found ${O} instead`);if(2!==(O=S.readInt32()))throw new Error(`Unable to load Idx file, did not find magic number 2, found ${O} instead`);var N=S.readInt32();for(let O=0;O<N;O++){const O=new B.IdxEntry;let N=S.readString(16);var j=N.indexOf("\0");0!==j&&(N=N.substr(0,j)),O.filename=N+".wav",O.offset=S.readUint32(),O.length=S.readUint32(),O.sampleRate=S.readUint32(),O.flags=S.readUint32(),O.chunkSize=S.readUint32(),this.entries.set(O.filename,O)}}})}}}),System.register("data/IniFile",["data/IniSection","data/IniParser","data/vfs/VirtualFile"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("IniFile",class e{constructor(S){this.sections=new Map,S instanceof j.VirtualFile?this.fromVirtualFile(S):"object"==typeof S?this.fromJson(S):"string"==typeof S&&this.fromString(S)}fromVirtualFile(S){return this.fromString(S.readAsString())}fromString(S){return this.fromJson((new N.IniParser).parse(S))}fromJson(S){for(var O in S){var N;S.hasOwnProperty(O)&&(N=new B.IniSection(O).fromJson(S[O]),this.sections.set(O,N))}return this}toString(){let S=[];for(var O of this.sections.values())S.push(O.toString());return S.join("\r\n")}clone(){let S=new e;return this.sections.forEach((O,B)=>{S.sections.set(B,O.clone())}),S}getOrCreateSection(S){let O=this.sections.get(S);return O||(O=new B.IniSection(S),this.sections.set(S,O)),O}getSection(S){return this.sections.get(S)}getOrderedSections(){return[...this.sections.values()]}mergeWith(S){return S.sections.forEach((S,O)=>{this.getOrCreateSection(O).mergeWith(S)}),this}})}}}),System.register("data/IniParser",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("IniParser",class{parse(S){let O,B={},N=B,j=/^\[([^\]]*)\]\s*$|^([^=]+)(=(.*))?$/i;return S.split(/[\r\n]+/g).forEach(S=>{if(S&&!S.match(/^\s*[;#]/)){var L=(S=S.replace(/]\s*(\/\/|;|#).*$/,"]")).match(j);if(L){if(void 0!==L[1])return O=this.unsafe(L[1]),void(N=B[O]=B[O]||{});let S=this.unsafe(L[2]);L=L[3]?this.unsafe(L[4]||""):"",2<S.length&&"[]"===S.slice(-2)&&(S=S.substring(0,S.length-2),N[S]?Array.isArray(N[S])||(N[S]=[N[S]]):N[S]=[]),Array.isArray(N[S])?N[S].push(L):N[S]=L}}}),Object.keys(B).filter(S=>{if(!B[S]||"object"!=typeof B[S]||Array.isArray(B[S]))return!1;let O=this.dotSplit(S),N=B,j=O.pop();var L=j.replace(/\\\./g,".");return O.forEach(function(S){N[S]&&"object"==typeof N[S]||(N[S]={}),N=N[S]}),(N!==B||L!==j)&&(N[L]=B[S],!0)}).forEach(function(S){delete B[S]}),B}dotSplit(S){return S.replace(/\x01/g,"LITERAL\\1LITERAL").replace(/\\\./g,"").split(/\./).map(S=>S.replace(/\x01/g,"\\.").replace(/\x02LITERAL\\1LITERAL\x02/g,""))}isQuoted(S){return'"'===S.charAt(0)&&'"'===S.slice(-1)||"'"===S.charAt(0)&&"'"===S.slice(-1)}unsafe(S){if(S=(S||"").trim(),this.isQuoted(S))return S.substr(1,S.length-2);{let B=!1,N="";for(let j=0,L=S.length;j<L;j++){var O=S.charAt(j);if(B)-1!=="\\;#".indexOf(O)?N+=O:N+="\\"+O,B=!1;else{if(-1!==";#".indexOf(O))break;"\\"===O?B=!0:N+=O}}return B&&(N+="\\"),N=N.trim(),N}}})}}}),System.register("data/IniSection",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("IniSection",class e{constructor(S){this.entries=new Map,this.sections=new Map,this.name=S}fromJson(S){for(var O in S){var B;S.hasOwnProperty(O)&&(B=S[O],Array.isArray(B)||"object"!=typeof B?this.set(O,B):this.sections.set(O,new e(O).fromJson(B)))}return this}clone(){let S=new e(this.name);return this.entries.forEach((O,B)=>{S.set(B,O)}),this.sections.forEach((O,B)=>{S.sections.set(B,O.clone())}),S}set(S,O){this.entries.set(S,O)}get(S){return this.entries.get(S)}has(S){return this.entries.has(S)}getString(S,O=""){var B=this.get(S);return B&&"string"==typeof B?B:O}getNumber(S,O=0){var B=this.get(S);if(!B||"string"!=typeof B)return O;var N=this.parseNumber(B);return void 0===N?(console.warn(`Invalid value for key ${S}. "${B}" is not a valid number or percentage string.`),O):N}parseNumber(S){let O;if(O=S.match(/%$/)?Number(S.replace("%",""))/100:Number(S),!isNaN(O))return O}getFixed(S,O=0){return this.toFixedPointPrecision(this.getNumber(S,O))}toFixedPointPrecision(S){return(65536*S|0)/65536}getBool(S,O=!1){let B=this.getString(S).trim();return B=B&&B.toLowerCase(),!(!B||-1===["yes","1","true","on"].indexOf(B))||(!B||-1===["no","0","false","off"].indexOf(B))&&O}getKeyArray(S,O=[]){var B=this.get(S);return B&&Array.isArray(B)?B:O}getArray(S,O=/,\s*/,B=[]){let N=this.getString(S).trim();return N=N.replace(/,$/,"").replace(/,+/g,","),N?N.split(O):B}getNumberArray(S,O=/,\s*/,B=[]){let N=this.getString(S).trim();if(!N)return B;let j=[];for(var L of N.split(O)){if(!L)return B;var D=this.parseNumber(L);if(void 0===D)return console.warn(`Invalid value for key ${S}. "${L}" is not a valid number or percentage string.`),B;j.push(D)}return j}getFixedArray(S,O=/,\s*/,B=[]){return this.getNumberArray(S,O,B).map(S=>this.toFixedPointPrecision(S))}getEnum(S,O,B,N=!1){let j,L=this.getString(S).trim();if(!L)return B;if(N){var D=Object.getOwnPropertyNames(O).find(S=>S.toLowerCase()===L.toLowerCase());D&&(j=O[D])}else O.hasOwnProperty(L)&&(j=O[L]);return void 0===j?(console.warn(`Invalid value for key "${S}". "${L}" is not an accepted enum value.`),B):j}getEnumNumeric(S,O,B){var N=this.getString(S).trim();if(!N)return B;let j;return Number.isInteger(parseInt(N,10))&&O.hasOwnProperty(N)&&(j=parseInt(N,10)),void 0===j?(console.warn(`Invalid value for key "${S}". "${N}" is not an accepted enum value.`),B):j}getEnumArray(S,O,B=/,\s*/,N=[],j=!1){let L=this.getString(S).trim();if(!L)return N;let D=[];for(let _ of L.split(B)){if(!_)return N;let B=!1;if(j){var F=Object.getOwnPropertyNames(O).find(S=>S.toLowerCase()===_.toLowerCase());F&&(D.push(O[F]),B=!0)}else O.hasOwnProperty(_)&&(D.push(O[_]),B=!0);if(!B)return console.warn(`Invalid value "${_}" for key "${S}".`),N}return D}getHighestNumericIndex(){let S,O=0;return this.entries.forEach((B,N)=>{S=parseInt(N,10),S>O&&(O=S)}),O}isNumericIndexArray(){return 0<this.getHighestNumericIndex()||this.has("0")}getConcatenatedValues(){let S="";for(var O of this.entries.values())"string"==typeof O&&(S+=O);return S}toString(S){let O=[],B=(S?S+".":"")+this.name;for(var[N,j]of(O.push(`[${B}]`),this.entries))if(Array.isArray(j))for(var L of j)O.push(N+"[]="+L);else O.push(N+"="+j);return O.push(""),O.join("\r\n")+[...this.sections.values()].map(S=>S.toString(B)).join("\r\n")}mergeWith(S){if(this.isNumericIndexArray()){let O=this.getHighestNumericIndex()+1;S.entries.forEach((S,B)=>{Number.isNaN(Number(B))||Array.isArray(S)||this.set((O++).toString(),S)})}else S.entries.forEach((S,O)=>{this.set(O,Array.isArray(S)?[...S]:S)});S.sections.forEach((S,O)=>{this.getOrCreateSection(O).mergeWith(S)})}getOrCreateSection(S){let O=this.sections.get(S);return O||(O=new e(S),this.sections.set(S,O)),O}getSection(S){return this.sections.get(S)}getOrderedSections(){return[...this.sections.values()]}})}}}),System.register("data/MapFile",["data/mapObjects","data/IniFile","engine/TheaterType","util/string","data/encoding/Format5","data/Bitmap","data/map/tag/TagsReader","data/map/trigger/TriggerReader","data/DataStream","data/map/MapLighting","data/map/tag/CellTagsReader","data/map/Variable","data/map/SpecialFlags"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S}],execute:function(){$=class e extends N.IniFile{fromString(S){super.fromString(S);let O=this.getSection("Map");if(!O)throw new Error("[Map] section not found");var B=O.getNumberArray("Size");if(this.fullSize={x:B[0],y:B[1],width:B[2],height:B[3]},B=O.getNumberArray("LocalSize"),this.localSize={x:B[0],y:B[1],width:B[2],height:B[3]},this.theaterType=O.getEnum("Theater",j.TheaterType,j.TheaterType.None,!0),this.theaterType===j.TheaterType.None)throw new Error(`Unsupported theater type "${O.getString("Theater")}"`);let N=this.getSection("Basic");return B=this.iniFormat=N?.getNumber("NewINIFormat")??0,this.readTiles(),this.readWaypoints(this.getOrCreateSection("Waypoints")),this.readStructures(this.getOrCreateSection("Structures")),this.readVehicles(),this.readInfantries(),this.readAircrafts(),this.readTerrains(this.getOrCreateSection("Terrain")),this.readOverlays(),this.readSmudges(),this.readLighting(),this.readTagsAndTriggers(),this.readCellTags(B),this.readVariableNames(),this.startingLocations=this.readStartingLocations(this.waypoints),this.specialFlags=(new K.SpecialFlags).read(this.getOrCreateSection("SpecialFlags")),this}fromJson(S){if(S[e.artSectionPrefix]){let{[e.artSectionPrefix]:O,...B}=S;this.artOverrides=new N.IniFile(O),S=B}return super.fromJson(S)}readStartingLocations(S){let O=[];var B;for(B of S.filter(S=>S.number<8).sort((S,O)=>S.number<O.number?-1:1))O.push({x:B.rx,y:B.ry});return O}readLighting(){var S=this.getOrCreateSection("Lighting");this.lighting=(new V.MapLighting).read(S),this.ionLighting=(new V.MapLighting).read(S,"Ion"),this.ionLighting.forceTint=!0}readTagsAndTriggers(){this.tags=(new _.TagsReader).read(this.getOrCreateSection("Tags"));var S=this.getOrCreateSection("Triggers"),O=this.getOrCreateSection("Events"),B=this.getOrCreateSection("Actions"),{triggers:S,unknownEventTypes:O,unknownActionTypes:B}=(new U.TriggerReader).read(S,O,B,this.tags);this.triggers=S,this.unknownEventTypes=O,this.unknownActionTypes=B}readCellTags(S){this.cellTags=(new W.CellTagsReader).read(this.getOrCreateSection("CellTags"),S)}readVariableNames(){var S,O,B=this.getOrCreateSection("VariableNames");let N=new Map;for([S,O]of B.entries){var j,L,D=Number(S);Number.isNaN(D)?console.warn(`Map [VariableNames] contains non-numeric index "${S}". Skipping.`):([j,L]=O.split(","),L=new z.Variable(j,Boolean(Number(L))),N.set(D,L))}this.variables=N}readTiles(){let S=this.getSection("IsoMapPack5");if(!S)throw new Error("[IsoMapPack5] section not found");var O=L.base64StringToUint8Array(S.getConcatenatedValues()),B=(2*this.fullSize.width-1)*this.fullSize.height,N=new Uint8Array(11*B+4);D.Format5.decodeInto(O,N);let j=new H.DataStream(N.buffer),F=2*this.fullSize.width-1;N=this.fullSize.height;var _,U,V,W,g=(S,O)=>O*F+S;this.tiles=new Array(F*N);for(let S=this.maxTileNum=0;S<B;S++){var z=j.readUint16(),K=j.readUint16(),$=Math.max(0,j.readInt16());this.maxTileNum=Math.max(this.maxTileNum,$),j.readInt16();var q=j.readUint8(),Q=j.readUint8();j.readUint8();var Z=z-K+this.fullSize.width-1,Y=z+K-this.fullSize.width-1;0<=Z&&Z<2*this.fullSize.width&&0<=Y&&Y<2*this.fullSize.height&&(q={dx:Z,dy:Y,rx:z,ry:K,z:Q,tileNum:$,subTile:q},this.tiles[g(Z,Math.floor(Y/2))]=q)}for(let S=0;S<this.fullSize.height;S++)for(let O=0;O<=2*this.fullSize.width-2;O++)this.tiles[g(O,S)]||(W=(U=2*S+O%2)-(V=((_=O)+U)/2+1)+this.fullSize.width+1,this.tiles[g(O,S)]={dx:_,dy:U,rx:V,ry:W,z:0,tileNum:0,subTile:0})}readWaypoints(S){for(var[O,B]of(this.waypoints=[],S.entries)){var N;let S;isNaN(N=parseInt(O,10))||isNaN(S=parseInt(B,10))||(B=S-1e3*(O=Math.floor(S/1e3)),this.waypoints.push({number:N,rx:B,ry:O}))}}readStructures(S){for(var[,O]of(this.structures=[],S.entries))if(!((O=O.split(",")).length<=15)){let S=new B.Structure;S.owner=O[0],S.name=O[1],S.health=Number(O[2]),S.rx=Number(O[3]),S.ry=Number(O[4]),S.tag=this.readTagId(O[6]),S.poweredOn=Boolean(Number(O[9])),this.structures.push(S)}}readTagId(S){return"none"!==S.toLowerCase()?S:void 0}readVehicles(){this.vehicles=[];let S=this.getSection("Units");if(S)for(var O of S.entries.values()){var N=O.split(",");if(N.length<=11)console.warn(`Invalid Vehicle entry: "${O}"`);else{let S=new B.Vehicle;S.owner=N[0],S.name=N[1],S.health=Number(N[2]),S.rx=Number(N[3]),S.ry=Number(N[4]),S.direction=Number(N[5]),S.tag=this.readTagId(N[7]),S.veterancy=Number(N[8]),S.onBridge="1"===N[10],this.vehicles.push(S)}}}readInfantries(){this.infantries=[];let S=this.getSection("Infantry");if(S)for(var O of S.entries.values()){var N=O.split(",");let S=new B.Infantry;N.length<=8?console.warn(`Invalid Infantry entry: "${O}"`):(S.owner=N[0],S.name=N[1],S.health=Number(N[2]),S.rx=Number(N[3]),S.ry=Number(N[4]),S.subCell=Number(N[5]),S.direction=Number(N[7]),S.tag=this.readTagId(N[8]),S.veterancy=Number(N[9]),S.onBridge="1"===N[11],this.infantries.push(S))}}readAircrafts(){this.aircrafts=[];let S=this.getSection("Aircraft");if(S)for(var O of S.entries.values()){O=O.split(",");let S=new B.Aircraft;S.owner=O[0],S.name=O[1],S.health=Number(O[2]),S.rx=Number(O[3]),S.ry=Number(O[4]),S.direction=Number(O[5]),S.tag=this.readTagId(O[7]),S.veterancy=Number(O[8]),S.onBridge="1"===O[O.length-4],this.aircrafts.push(S)}}readTerrains(S){for(var[O,N]of(this.terrains=[],S.entries))if(O=Number(O),!isNaN(O)){let S=new B.Terrain;S.name=N,S.rx=O%1e3,S.ry=Math.floor(O/1e3),this.terrains.push(S)}}readOverlays(){this.overlays=[],this.maxOverlayId=0;let S=this.getSection("OverlayPack");if(S){var O=L.base64StringToUint8Array(S.getConcatenatedValues()),N=new Uint8Array(1<<18);D.Format5.decodeInto(O,N,80);let V=this.getSection("OverlayDataPack");if(V){O=L.base64StringToUint8Array(V.getConcatenatedValues());var j=new Uint8Array(1<<18);D.Format5.decodeInto(O,j,80);for(let S=0;S<this.fullSize.height;S++)for(let O=2*this.fullSize.width-2;0<=O;O--){var F,_,U=((F=O)+(_=2*S+O%2))/2+1,H=_-U+this.fullSize.width+1;if(255!==(_=N[F=U+512*H])){F=j[F];let S=new B.Overlay;S.id=_,S.value=F,S.rx=U,S.ry=H,this.overlays.push(S),this.maxOverlayId=Math.max(this.maxOverlayId,_)}}}else console.warn("[OverlayDataPack] section not found. Skipping.")}else console.warn("[Overlay] section not found. Skipping.")}readSmudges(){this.smudges=[];let S=this.getSection("Smudge");if(S)for(var O of S.entries.values()){var N=O.split(",");if(N.length<=2)console.warn(`Invalid Smudge entry: "${O}"`);else{let S=new B.Smudge;S.name=N[0],S.rx=Number(N[1]),S.ry=Number(N[2]),this.smudges.push(S)}}}decodePreviewImage(){let S=this.getSection("Preview"),O=this.getSection("PreviewPack");if(S&&O){var[,,B,N]=S.getArray("Size").map(S=>Number(S)),j=L.base64StringToUint8Array(O.getConcatenatedValues()),N=new F.RgbBitmap(B,N);return D.Format5.decodeInto(j,N.data),N}}},S("MapFile",$),$.artSectionPrefix="ART"}}}),System.register("data/MixEntry",["util/string","data/Crc32"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("MixEntry",j=class{static hashFilename(S){var O=(S=S.toUpperCase()).length,j=O>>2;if(3&O){S+=String.fromCharCode(O-(j<<2));let B=3-(3&O);for(;0!=B--;)S+=S[j<<2]}return N.Crc32.calculateCrc(B.binaryStringToUint8Array(S))}constructor(S,O,B){this.hash=S,this.offset=O,this.length=B}}),j.size=12}}}),System.register("data/MixFile",["data/DataStream","data/encoding/Blowfish","data/encoding/BlowfishKey","data/MixEntry","data/vfs/VirtualFile"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){var O;(O=F=F||{})[O.Checksum=65536]="Checksum",O[O.Encrypted=131072]="Encrypted",S("MixFile",class{constructor(S){this.stream=S,this.headerStart=84,this.index=new Map,this.parseHeader()}parseHeader(){var S=this.stream.readUint32();if(0==(S&~(F.Checksum|F.Encrypted))){if(0!=(S&F.Encrypted))return void(this.dataStart=this.parseRaHeader())}else this.stream.seek(0);this.dataStart=this.parseTdHeader(this.stream)}parseRaHeader(){const S=this.stream;var O=S.readUint8Array(80),D=(new j.BlowfishKey).decryptKey(O),F=S.readUint32Array(2);const _=new N.Blowfish(D);let U=new B.DataStream(_.decrypt(F));return O=U.readUint16(),U.readUint32(),S.position=this.headerStart,O=(3+(D=6+O*L.MixEntry.size))/4|0,F=S.readUint32Array(O+O%2),U=new B.DataStream(_.decrypt(F)),D=this.headerStart+D+(1+(~D>>>0)&7),this.parseTdHeader(U),D}parseTdHeader(S){var O=S.readUint16();S.readUint32();for(let N=0;N<O;N++){var B=new L.MixEntry(S.readUint32(),S.readUint32(),S.readUint32());this.index.set(B.hash,B)}return S.position}containsFile(S){return this.index.has(L.MixEntry.hashFilename(S))}openFile(S){var O=this.index.get(L.MixEntry.hashFilename(S));if(!O)throw new Error(`File "${S}" not found`);return D.VirtualFile.factory(this.stream,S,this.dataStart+O.offset,O.length)}})}}}),System.register("data/Mp3File",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("Mp3File",class{constructor(S){this.file=S}asFile(){return new File([this.file],this.file.name,{type:"audio/mp3"})}})}}}),System.register("data/Palette",["util/Color","util/math","data/vfs/VirtualFile"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("Palette",L=class e{constructor(S){S instanceof j.VirtualFile?this.fromVirtualFile(S):"object"==typeof S&&this.fromJson(S)}fromVirtualFile(S){var O=S.stream.readUint8Array(768);this.fromJson(O)}fromJson(S){this.colors=[];for(let O=0;O<S.length/3;++O)this.colors.push(B.Color.fromRgb(4*S[3*O],4*S[3*O+1],4*S[3*O+2]));this._hash=this.computeHash(this.colors)}getColor(S){return this.colors[S]}getColorAsHex(S){return this.getColor(S).asHex()}setColors(S){this.colors=S,this._hash=this.computeHash(this.colors)}get size(){return this.colors.length}get hash(){return this._hash}computeHash(S){let O=new Uint8Array(3*this.size),B=0;for(var j of S)O[B]=j.r,O[B+1]=j.g,O[B+2]=j.b,B+=3;return N.fnv32a(O)}clone(){let S=new e;return S.colors=this.colors.map(S=>S.clone()),S._hash=this._hash,S}remap(S){var O=[63,59,55,52,48,44,41,37,33,30,26,22,19,15,11,8];for(let B=e.REMAP_START_IDX;B<e.REMAP_START_IDX+O.length;B++)this.colors[B].r=Math.floor(S.r/255*O[B-e.REMAP_START_IDX]*4),this.colors[B].g=Math.floor(S.g/255*O[B-e.REMAP_START_IDX]*4),this.colors[B].b=Math.floor(S.b/255*O[B-e.REMAP_START_IDX]*4);return this._hash=this.computeHash(this.colors),this}}),L.REMAP_START_IDX=16}}}),System.register("data/PcxFile",["pcx-js","engine/gfx/CanvasUtils"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("PcxFile",class{constructor(S){this.file=S;var O=this.file.stream,N=new B.default(new Uint8Array(O.buffer,O.byteOffset,O.byteLength)).decode();O=N.pixelArray,this.fixAlpha(O),this.width=N.width,this.height=N.height,this.data=O}async toPngBlob(){var S=this.toCanvas();return await N.CanvasUtils.canvasToBlob(S)}toDataUrl(){return this.toCanvas().toDataURL()}toCanvas(){return N.CanvasUtils.canvasFromRgbaImageData(this.data,this.width,this.height)}fixAlpha(S){for(let O=0,B=S.length;O<B;O+=4)255===S[O]&&0===S[O+1]&&255===S[O+2]&&(S[O+3]=0)}})}}}),System.register("data/ShpFile",["data/encoding/Format3","data/ShpImage","data/vfs/VirtualFile"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("ShpFile",class e{constructor(S){this.height=0,this.width=0,this.numImages=0,this.images=[],S instanceof j.VirtualFile&&this.fromVirtualFile(S)}fromVirtualFile(S){this.filename=S.filename;let O=S.stream;if(0===O.readInt16()){this.width=O.readInt16(),this.height=O.readInt16(),this.numImages=O.readInt16();let S=[];for(let B=0;B<this.numImages;++B)S.push(this.readFrameHeader(O));this.images=[];for(let H=0;H<this.numImages;++H){var{compressionType:B,imageDataStartOffset:j,x:L,y:D,width:F,height:_}=S[H];let V=H<this.numImages-1?S[H+1].imageDataStartOffset:O.byteLength;V<j&&(V=O.byteLength);var U=V-j;O.seek(j),U=this.readImageData(O,F,_,B,U);let W=new N.ShpImage(U);W.x=L,W.y=D,W.width=F,W.height=_,this.images.push(W)}}}readFrameHeader(S){var O=S.readInt16(),B=S.readInt16(),N=S.readInt16(),j=S.readInt16(),L=S.readUint8();return S.readUint8(),S.readUint8(),S.readUint8(),S.readInt32(),S.readInt32(),{x:O,y:B,width:N,height:j,compressionType:L,imageDataStartOffset:S.readInt32()}}readImageData(S,O,N,j,L){var D=O*N;if(j<=1){var F=new Uint8Array(S.buffer,S.byteOffset+S.position,D);return S.position+=D,F}if(2===j){let O=0,B=new Uint8Array(D);for(let j=0;j<N;++j){var _=S.readUint16()-2;B.set(new Uint8Array(S.buffer,S.byteOffset+S.position,_),O),S.position+=_,O+=_}return B}return 3!==j?new Uint8Array:(D=new Uint8Array(S.buffer,S.byteOffset+S.position,L),S.position+=L,B.Format3.decode(D,O,N))}getImage(S){if(S<0||this.images.length<=S)throw new RangeError(`Image index out of bounds (file=${this.filename}, index=${S}, length=${this.images.length})`);return this.images[S]}addImage(S){this.images.push(S),this.numImages++}clip(S,O){let B=new e;return B.filename=this.filename,B.width=Math.min(this.width,S),B.height=Math.min(this.height,O),B.images=this.images.map(S=>S.clip(B.width,B.height)),B.numImages=this.numImages,B}})}}}),System.register("data/ShpImage",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("ShpImage",class e{constructor(S){this.height=1,this.width=1,this.x=0,this.y=0,this.imageData=S??new Uint8Array(0)}clip(S,O){let B=new e;B.width=Math.min(this.width,S),B.height=Math.min(this.height,O);let N=new Uint8Array(S*O),j=0;for(let B=0;B<this.height&&!(B>=O);B++)for(let O=0;O<this.width;O++)O>=S||(N[j++]=this.imageData[B*this.width+O]);return B.imageData=N,B.x=this.x,B.y=this.y,B}})}}}),System.register("data/Strings",["sprintf-js","data/CsfFile"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("Strings",class{constructor(S){this.data={},S instanceof N.CsfFile?this.fromCsf(S):"object"==typeof S&&this.fromJson(S)}fromCsf(S){this.fromJson(S.data)}fromJson(S){for(var O of Object.keys(S))this.setValue(O,this.sanitizeValue(S[O]))}sanitizeValue(S){return S.replace(/%hs/g,"%s")}setValue(S,O){this.data[S.toLowerCase()]=O}has(S){return!!this.data[S.toLowerCase()]}get(S,...O){let N=this.data[S.toLowerCase()];return N?"string"!=typeof N?(console.warn(`Invalid string value for name "${S}"`),S):(O.length&&(N=B.sprintf(N,...O)),N):S.match(/^NOSTR:/i)?S.replace(/^NOSTR:/i,""):(console.warn(`String with name "${S}" not found"`),S)}})}}}),System.register("data/TmpFile",["data/TmpImage","data/vfs/VirtualFile"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("TmpFile",class{constructor(S){this.images=[],S instanceof N.VirtualFile&&this.fromVirtualFile(S)}fromVirtualFile(S){let O=S.stream;this.width=O.readInt32(),this.height=O.readInt32(),this.blockWidth=O.readInt32(),this.blockHeight=O.readInt32();var N=this.width*this.height,j=new Uint8Array(O.buffer,O.byteOffset+O.position,4*N);this.images=[];for(let S=0;S<N;S++){var L=j[4*S+3]<<24|j[4*S+2]<<16|j[4*S+1]<<8|j[4*S];O.seek(L),L=new B.TmpImage(O,this.blockWidth,this.blockHeight),this.images.push(L)}}})}}}),System.register("data/TmpImage",[],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[],execute:function(){var O;(O=B=B||{})[O.ExtraData=1]="ExtraData",O[O.ZData=2]="ZData",O[O.DamagedData=4]="DamagedData",N=S=>S<0?S+256:S,S("TmpImage",class{constructor(S,O,B){this.fromStream(S,O,B)}fromStream(S,O,N){this.x=S.readInt32(),this.y=S.readInt32(),S.readInt32(),S.readInt32();var j=S.readInt32();this.extraX=S.readInt32(),this.extraY=S.readInt32(),this.extraWidth=S.readInt32(),this.extraHeight=S.readInt32();var L=S.readUint32();this.height=S.readUint8(),this.terrainType=S.readUint8(),this.rampType=S.readUint8(),this.radarLeft=this.readRadarRgb(S.readInt8(),S.readInt8(),S.readInt8()),this.radarRight=this.readRadarRgb(S.readInt8(),S.readInt8(),S.readInt8()),S.seek(S.position+3),this.tileData=new Uint8Array(S.buffer,S.byteOffset+S.position,O*N/2),S.position+=O*N/2,this.hasZData=(L&B.ZData)===B.ZData,this.hasZData&&(S.position+=O*N/2),this.hasExtraData=(L&B.ExtraData)===B.ExtraData,this.hasExtraData&&(L=Math.abs(this.extraWidth*this.extraHeight),this.extraData=new Uint8Array(S.buffer,S.byteOffset+S.position,L),S.position+=L),this.hasZData&&this.hasExtraData&&0<j&&j<S.byteLength&&(S.position+=Math.abs(this.extraWidth*this.extraHeight))}readRadarRgb(S,O,B){return new THREE.Color(N(S)/255,N(O)/255,N(B)/255)}})}}}),System.register("data/VxlFile",["data/vfs/VirtualFile","data/vxl/Section","data/vxl/VxlHeader"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("VxlFile",class{constructor(S){this.voxelCount=0,S instanceof B.VirtualFile&&this.fromVirtualFile(S)}fromVirtualFile(S){this.filename=S.filename;let O=S.stream;if(this.sections=[],!(O.byteLength<j.VxlHeader.size)){let S=new j.VxlHeader;if(S.read(O),S.headerCount&&S.tailerCount&&S.tailerCount===S.headerCount){for(let B=0;B<S.headerCount;++B){const S=new N.Section;this.readSectionHeader(S,O),this.sections.find(O=>O.name===S.name)&&console.warn(`Duplicate section name "${S.name}" found in VXL "${this.filename}".`),this.sections.push(S)}var B=O.position;O.seek(O.position+S.bodySize);let j=[];for(let B=0;B<S.tailerCount;++B)j[B]=this.readSectionTailer(this.sections[B],O);let L=0;for(let N=0;N<S.headerCount;++N)O.seek(B),L+=this.readSectionBodySpans(this.sections[N],j[N],O);this.voxelCount=L}}}readSectionHeader(S,O){S.name=O.readCString(16),O.readUint32(),O.readUint32(),O.readUint32()}readSectionTailer(S,O){var B=O.readUint32(),N=O.readUint32(),j=O.readUint32();return S.hvaMultiplier=O.readFloat32(),S.transfMatrix=this.readTransfMatrix(O),S.minBounds=new THREE.Vector3(O.readFloat32(),O.readFloat32(),O.readFloat32()),S.maxBounds=new THREE.Vector3(O.readFloat32(),O.readFloat32(),O.readFloat32()),S.sizeX=O.readUint8(),S.sizeY=O.readUint8(),S.sizeZ=O.readUint8(),S.normalsMode=O.readUint8(),{startingSpanOffset:B,endingSpanOffset:N,dataSpanOffset:j}}readTransfMatrix(S){let O=[];for(let B=0;B<3;++B)O.push(S.readFloat32(),S.readFloat32(),S.readFloat32(),S.readFloat32());return O.push(0,0,0,1),(new THREE.Matrix4).fromArray(O).transpose()}readSectionBodySpans(S,O,B){B.seek(B.position+O.startingSpanOffset);var{sizeX:N,sizeY:j,sizeZ:L}=S;let D=new Array(j);for(let S=0;S<j;++S){D[S]=new Array(N);for(let O=0;O<N;++O)D[S][O]=B.readInt32()}let F=new Array(j);for(let S=0;S<j;++S){F[S]=new Array(N);for(let O=0;O<N;++O)F[S][O]=B.readInt32()}let _=S.spans=[],U=0;for(let S=0;S<j;++S)for(let O=0;O<N;++O){var H={x:O,y:S,voxels:this.readSpanVoxels(D[S][O],F[S][O],O,S,L,B)};_.push(H),U+=H.voxels.length}return U}readSpanVoxels(S,O,B,N,j,L){if(-1===S||-1===O)return[];let D=[];for(let S=0;S<j;){S+=L.readUint8();var F=L.readUint8();for(let O=0;O<F;++O){var _={x:B,y:N,z:S++,colorIndex:L.readUint8(),normalIndex:L.readUint8()};D.push(_)}L.readUint8()}return D}fromPlain(S){return this.sections=S.sections.map(S=>(new N.Section).fromPlain(S)),this.voxelCount=S.voxelCount,this}toPlain(){return{sections:this.sections.map(S=>S.toPlain()),voxelCount:this.voxelCount}}getSection(S){return this.sections[S]}})}}}),System.register("data/WavFile",["wavefile","data/vfs/VirtualFile"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("WavFile",class{constructor(S){S instanceof Uint8Array?this.fromRawData(S):S instanceof N.VirtualFile&&this.fromVirtualFile(S)}fromRawData(S){return this.rawData=S,this}fromVirtualFile(S){var O=S.stream;return this.rawData=new Uint8Array(O.buffer,O.byteOffset,O.byteLength),this}getRawData(){return this.rawData}getData(){if(!this.decodedData){if(!this.rawData)throw new Error("No data loaded");this.decodedData=this.decodeData(this.rawData),this.rawData=void 0}return this.decodedData}setData(S){this.rawData=void 0,this.decodedData=S}decodeData(S){let O=new B.WaveFile(S);return"4"===O.bitDepth&&O.fromIMAADPCM(),O.toBuffer()}isRawImaAdpcm(){return this.rawData&&"4"===new B.WaveFile(this.rawData).bitDepth}})}}}),System.register("data/encoding/Blowfish",[],function(S,O){"use strict";function i(S){return((S=(S<<16>>>0|S>>>16)>>>0)<<8>>>0&4278255360|S>>>8&16711935)>>>0}return O&&O.id,{setters:[],execute:function(){S("Blowfish",class{constructor(S){this.m_p=new Uint32Array([608135816,2242054355,320440878,57701188,2752067618,698298832,137296536,3964562569,1160258022,953160567,3193202383,887688300,3232508343,3380367581,1065670069,3041331479,2450970073,2306472731]),this.m_s=[new Uint32Array([3509652390,2564797868,805139163,3491422135,3101798381,1780907670,3128725573,4046225305,614570311,3012652279,134345442,2240740374,1667834072,1901547113,2757295779,4103290238,227898511,1921955416,1904987480,2182433518,2069144605,3260701109,2620446009,720527379,3318853667,677414384,3393288472,3101374703,2390351024,1614419982,1822297739,2954791486,3608508353,3174124327,2024746970,1432378464,3864339955,2857741204,1464375394,1676153920,1439316330,715854006,3033291828,289532110,2706671279,2087905683,3018724369,1668267050,732546397,1947742710,3462151702,2609353502,2950085171,1814351708,2050118529,680887927,999245976,1800124847,3300911131,1713906067,1641548236,4213287313,1216130144,1575780402,4018429277,3917837745,3693486850,3949271944,596196993,3549867205,258830323,2213823033,772490370,2760122372,1774776394,2652871518,566650946,4142492826,1728879713,2882767088,1783734482,3629395816,2517608232,2874225571,1861159788,326777828,3124490320,2130389656,2716951837,967770486,1724537150,2185432712,2364442137,1164943284,2105845187,998989502,3765401048,2244026483,1075463327,1455516326,1322494562,910128902,469688178,1117454909,936433444,3490320968,3675253459,1240580251,122909385,2157517691,634681816,4142456567,3825094682,3061402683,2540495037,79693498,3249098678,1084186820,1583128258,426386531,1761308591,1047286709,322548459,995290223,1845252383,2603652396,3431023940,2942221577,3202600964,3727903485,1712269319,422464435,3234572375,1170764815,3523960633,3117677531,1434042557,442511882,3600875718,1076654713,1738483198,4213154764,2393238008,3677496056,1014306527,4251020053,793779912,2902807211,842905082,4246964064,1395751752,1040244610,2656851899,3396308128,445077038,3742853595,3577915638,679411651,2892444358,2354009459,1767581616,3150600392,3791627101,3102740896,284835224,4246832056,1258075500,768725851,2589189241,3069724005,3532540348,1274779536,3789419226,2764799539,1660621633,3471099624,4011903706,913787905,3497959166,737222580,2514213453,2928710040,3937242737,1804850592,3499020752,2949064160,2386320175,2390070455,2415321851,4061277028,2290661394,2416832540,1336762016,1754252060,3520065937,3014181293,791618072,3188594551,3933548030,2332172193,3852520463,3043980520,413987798,3465142937,3030929376,4245938359,2093235073,3534596313,375366246,2157278981,2479649556,555357303,3870105701,2008414854,3344188149,4221384143,3956125452,2067696032,3594591187,2921233993,2428461,544322398,577241275,1471733935,610547355,4027169054,1432588573,1507829418,2025931657,3646575487,545086370,48609733,2200306550,1653985193,298326376,1316178497,3007786442,2064951626,458293330,2589141269,3591329599,3164325604,727753846,2179363840,146436021,1461446943,4069977195,705550613,3059967265,3887724982,4281599278,3313849956,1404054877,2845806497,146425753,1854211946]),new Uint32Array([1266315497,3048417604,3681880366,3289982499,290971e4,1235738493,2632868024,2414719590,3970600049,1771706367,1449415276,3266420449,422970021,1963543593,2690192192,3826793022,1062508698,1531092325,1804592342,2583117782,2714934279,4024971509,1294809318,4028980673,1289560198,2221992742,1669523910,35572830,157838143,1052438473,1016535060,1802137761,1753167236,1386275462,3080475397,2857371447,1040679964,2145300060,2390574316,1461121720,2956646967,4031777805,4028374788,33600511,2920084762,1018524850,629373528,3691585981,3515945977,2091462646,2486323059,586499841,988145025,935516892,3367335476,2599673255,2839830854,265290510,3972581182,2759138881,3795373465,1005194799,847297441,406762289,1314163512,1332590856,1866599683,4127851711,750260880,613907577,1450815602,3165620655,3734664991,3650291728,3012275730,3704569646,1427272223,778793252,1343938022,2676280711,2052605720,1946737175,3164576444,3914038668,3967478842,3682934266,1661551462,3294938066,4011595847,840292616,3712170807,616741398,312560963,711312465,1351876610,322626781,1910503582,271666773,2175563734,1594956187,70604529,3617834859,1007753275,1495573769,4069517037,2549218298,2663038764,504708206,2263041392,3941167025,2249088522,1514023603,1998579484,1312622330,694541497,2582060303,2151582166,1382467621,776784248,2618340202,3323268794,2497899128,2784771155,503983604,4076293799,907881277,423175695,432175456,1378068232,4145222326,3954048622,3938656102,3820766613,2793130115,2977904593,26017576,3274890735,3194772133,1700274565,1756076034,4006520079,3677328699,720338349,1533947780,354530856,688349552,3973924725,1637815568,332179504,3949051286,53804574,2852348879,3044236432,1282449977,3583942155,3416972820,4006381244,1617046695,2628476075,3002303598,1686838959,431878346,2686675385,1700445008,1080580658,1009431731,832498133,3223435511,2605976345,2271191193,2516031870,1648197032,4164389018,2548247927,300782431,375919233,238389289,3353747414,2531188641,2019080857,1475708069,455242339,2609103871,448939670,3451063019,1395535956,2413381860,1841049896,1491858159,885456874,4264095073,4001119347,1565136089,3898914787,1108368660,540939232,1173283510,2745871338,3681308437,4207628240,3343053890,4016749493,1699691293,1103962373,3625875870,2256883143,3830138730,1031889488,3479347698,1535977030,4236805024,3251091107,2132092099,1774941330,1199868427,1452454533,157007616,2904115357,342012276,595725824,1480756522,206960106,497939518,591360097,863170706,2375253569,3596610801,1814182875,2094937945,3421402208,1082520231,3463918190,2785509508,435703966,3908032597,1641649973,2842273706,3305899714,1510255612,2148256476,2655287854,3276092548,4258621189,236887753,3681803219,274041037,1734335097,3815195456,3317970021,1899903192,1026095262,4050517792,356393447,2410691914,3873677099,3682840055]),new Uint32Array([3913112168,2491498743,4132185628,2489919796,1091903735,1979897079,3170134830,3567386728,3557303409,857797738,1136121015,1342202287,507115054,2535736646,337727348,3213592640,1301675037,2528481711,1895095763,1721773893,3216771564,62756741,2142006736,835421444,2531993523,1442658625,3659876326,2882144922,676362277,1392781812,170690266,3921047035,1759253602,3611846912,1745797284,664899054,1329594018,3901205900,3045908486,2062866102,2865634940,3543621612,3464012697,1080764994,553557557,3656615353,3996768171,991055499,499776247,1265440854,648242737,3940784050,980351604,3713745714,1749149687,3396870395,4211799374,3640570775,1161844396,3125318951,1431517754,545492359,4268468663,3499529547,1437099964,2702547544,3433638243,2581715763,2787789398,1060185593,1593081372,2418618748,4260947970,69676912,2159744348,86519011,2512459080,3838209314,1220612927,3339683548,133810670,1090789135,1078426020,1569222167,845107691,3583754449,4072456591,1091646820,628848692,1613405280,3757631651,526609435,236106946,48312990,2942717905,3402727701,1797494240,859738849,992217954,4005476642,2243076622,3870952857,3732016268,765654824,3490871365,2511836413,1685915746,3888969200,1414112111,2273134842,3281911079,4080962846,172450625,2569994100,980381355,4109958455,2819808352,2716589560,2568741196,3681446669,3329971472,1835478071,660984891,3704678404,4045999559,3422617507,3040415634,1762651403,1719377915,3470491036,2693910283,3642056355,3138596744,1364962596,2073328063,1983633131,926494387,3423689081,2150032023,4096667949,1749200295,3328846651,309677260,2016342300,1779581495,3079819751,111262694,1274766160,443224088,298511866,1025883608,3806446537,1145181785,168956806,3641502830,3584813610,1689216846,3666258015,3200248200,1692713982,2646376535,4042768518,1618508792,1610833997,3523052358,4130873264,2001055236,3610705100,2202168115,4028541809,2961195399,1006657119,2006996926,3186142756,1430667929,3210227297,1314452623,4074634658,4101304120,2273951170,1399257539,3367210612,3027628629,1190975929,2062231137,2333990788,2221543033,2438960610,1181637006,548689776,2362791313,3372408396,3104550113,3145860560,296247880,1970579870,3078560182,3769228297,1714227617,3291629107,3898220290,166772364,1251581989,493813264,448347421,195405023,2709975567,677966185,3703036547,1463355134,2715995803,1338867538,1343315457,2802222074,2684532164,233230375,2599980071,2000651841,3277868038,1638401717,4028070440,3237316320,6314154,819756386,300326615,590932579,1405279636,3267499572,3150704214,2428286686,3959192993,3461946742,1862657033,1266418056,963775037,2089974820,2263052895,1917689273,448879540,3550394620,3981727096,150775221,3627908307,1303187396,508620638,2975983352,2726630617,1817252668,1876281319,1457606340,908771278,3720792119,3617206836,2455994898,1729034894,1080033504]),new Uint32Array([976866871,3556439503,2881648439,1522871579,1555064734,1336096578,3548522304,2579274686,3574697629,3205460757,3593280638,3338716283,3079412587,564236357,2993598910,1781952180,1464380207,3163844217,3332601554,1699332808,1393555694,1183702653,3581086237,1288719814,691649499,2847557200,2895455976,3193889540,2717570544,1781354906,1676643554,2592534050,3230253752,1126444790,2770207658,2633158820,2210423226,2615765581,2414155088,3127139286,673620729,2805611233,1269405062,4015350505,3341807571,4149409754,1057255273,2012875353,2162469141,2276492801,2601117357,993977747,3918593370,2654263191,753973209,36408145,2530585658,25011837,3520020182,2088578344,530523599,2918365339,1524020338,1518925132,3760827505,3759777254,1202760957,3985898139,3906192525,674977740,4174734889,2031300136,2019492241,3983892565,4153806404,3822280332,352677332,2297720250,60907813,90501309,3286998549,1016092578,2535922412,2839152426,457141659,509813237,4120667899,652014361,1966332200,2975202805,55981186,2327461051,676427537,3255491064,2882294119,3433927263,1307055953,942726286,933058658,2468411793,3933900994,4215176142,1361170020,2001714738,2830558078,3274259782,1222529897,1679025792,2729314320,3714953764,1770335741,151462246,3013232138,1682292957,1483529935,471910574,1539241949,458788160,3436315007,1807016891,3718408830,978976581,1043663428,3165965781,1927990952,4200891579,2372276910,3208408903,3533431907,1412390302,2931980059,4132332400,1947078029,3881505623,4168226417,2941484381,1077988104,1320477388,886195818,18198404,3786409e3,2509781533,112762804,3463356488,1866414978,891333506,18488651,661792760,1628790961,3885187036,3141171499,876946877,2693282273,1372485963,791857591,2686433993,3759982718,3167212022,3472953795,2716379847,445679433,3561995674,3504004811,3574258232,54117162,3331405415,2381918588,3769707343,4154350007,1140177722,4074052095,668550556,3214352940,367459370,261225585,2610173221,4209349473,3468074219,3265815641,314222801,3066103646,3808782860,282218597,3406013506,3773591054,379116347,1285071038,846784868,2669647154,3771962079,3550491691,2305946142,453669953,1268987020,3317592352,3279303384,3744833421,2610507566,3859509063,266596637,3847019092,517658769,3462560207,3443424879,370717030,4247526661,2224018117,4143653529,4112773975,2788324899,2477274417,1456262402,2901442914,1517677493,1846949527,2295493580,3734397586,2176403920,1280348187,1908823572,3871786941,846861322,1172426758,3287448474,3383383037,1655181056,3139813346,901632758,1897031941,2986607138,3066810236,3447102507,1393639104,373351379,950779232,625454576,3124240540,4148612726,2007998917,544563296,2244738638,2330496472,2058025392,1291430526,424198748,50039436,29584100,3605783033,2429876329,2791104160,1057563949,3255363231,3075367218,3463963227,1469046755,985887462])];for(let L=0,D=0;L<18;++L){var O=S[D++%S.length],B=S[D++%S.length],N=S[D++%S.length],j=S[D++%S.length];this.m_p[L]^=O<<24|B<<16|N<<8|j}let L=0,D=0;for(let S=0;S<18;)[L,D]=this._encrypt(L,D),this.m_p[S++]=L,this.m_p[S++]=D;for(let S=0;S<4;++S)for(let O=0;O<256;)[L,D]=this._encrypt(L,D),this.m_s[S][O++]=L,this.m_s[S][O++]=D}encrypt(S){return this.runCipher(S,this._encrypt.bind(this))}decrypt(S){return this.runCipher(S,this._decrypt.bind(this))}runCipher(S,O){let B=new Uint32Array(S.length),N=S.length/2|0,j=0;for(;0<N--;){var L=i(S[j]),D=i(S[j+1]);[L,D]=O(L,D),B[j++]=i(L),B[j++]=i(D)}return B}_encrypt(S,O){let B=S,N=O;B^=this.m_p[0];let j=!1;for(let S=1;S<=16;S++,j=!j)j?B=this.round(B,N,S):N=this.round(N,B,S);return N^=this.m_p[17],[N,B]}_decrypt(S,O){let B=S,N=O;B^=this.m_p[17];let j=!1;for(let S=16;1<=S;S--,j=!j)j?B=this.round(B,N,S):N=this.round(N,B,S);return N^=this.m_p[0],[N,B]}s(S,O){return this.m_s[O][S>>(3-O<<3)&255]}bf_f(S){return(this.s(S,0)+this.s(S,1)>>>0^this.s(S,2))+this.s(S,3)>>>0}round(S,O,B){return S^this.bf_f(O)^this.m_p[B]}})}}}),System.register("data/encoding/BlowfishKey",[],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[],execute:function(){B="AihRvNoIbTn85FZRYNZRcT+i6KpU+maCsEqr3Q5q+LDB5tH7Tz2qQ38V",N=new Int8Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),j=class{constructor(){this.key1=new Uint32Array(64),this.key2=new Uint32Array(64)}},S("BlowfishKey",class{constructor(){this.pubkey=new j,this.glob1=new Uint32Array(64),this.glob2=new Uint32Array(130),this.glob1_hi=new Uint32Array(4),this.glob1_hi_inv=new Uint32Array(4)}init_bignum(S,O,B){for(let O=0;O<B;O++)S[O]=0;S[0]=O}move_key_to_big(S,O,B,N){let j;j=128&O[0]?255:0;const L=new Uint8Array(S.buffer,S.byteOffset);let D=4*N;for(;D>B;D--)L[D-1]=j;for(;0<D;D--)L[D-1]=O[B-D]}key_to_bignum(S,O,B){let N,j,L=0;if(2===O[L]){if(L++,128&O[L]){for(N=0,j=0;j<(127&O[L]);j++)N=(N<<8>>>0|O[L+j+1])>>>0;L+=1+(127&O[L])}else N=O[L],L++;N<=4*B&&this.move_key_to_big(S,O.subarray(L),N,B)}}len_bignum(S,O){let B=O-1;for(;0<=B&&0===S[B];)B--;return B+1}bitlen_bignum(S,O){var B;let N,j;if(0===(B=this.len_bignum(S,O)))return 0;for(N=32*B,j=2147483648;0==(j&S[B-1]);)j>>>=1,N--;return N}init_pubkey(){let S,O=0;var j;const L=new Uint8Array(256);for(this.init_bignum(this.pubkey.key2,65537,64),S=0;O<56;)j=(((N[B.charCodeAt(O++)]>>>0<<6>>>0|255&N[B.charCodeAt(O++)])>>>0<<6>>>0|255&N[B.charCodeAt(O++)])>>>0<<6>>>0|255&N[B.charCodeAt(O++)])>>>0,L[S++]=j>>16&255,L[S++]=j>>8&255,L[S++]=255&j;this.key_to_bignum(this.pubkey.key1,L,64),this.pubkey.len=this.bitlen_bignum(this.pubkey.key1,64)-1}len_predata(){var S=(this.pubkey.len-1)/8|0;return(1+(55/S|0))*(1+S)>>>0}cmp_bignum(S,O,B){for(;0<B;){if(S[--B]<O[B])return-1;if(S[B]>O[B])return 1}return 0}mov_bignum(S,O,B){for(let N=0;N<B;N++)S[N]=O[N]}shr_bignum(S,O,B){let N;var j=O/32|0;if(0<j){for(N=0;N<B-j;N++)S[N]=S[N+j];for(;N<B;N++)S[N]=0;O%=32}if(0!==O){for(N=0;N<B-1;N++)S[N]=(S[N]>>>O|S[N+1]<<32-O>>>0)>>>0;S[N]=S[N]>>>O}}shl_bignum(S,O,B){let N;var j=O/32|0;if(0<j){for(N=B-1;N>j;N--)S[N]=S[N-j];for(;0<N;N--)S[N]=0;O%=32}if(0!==O){for(N=B-1;0<N;N--)S[N]=(S[N]<<O>>>0|S[N-1]>>>32-O)>>>0;S[0]=S[0]<<O>>>0}}sub_bignum(S,O,B,N,j){var L,D;j+=j;var F=new Uint16Array(O.buffer,O.byteOffset),_=new Uint16Array(B.buffer,B.byteOffset);const U=new Uint16Array(S.buffer,S.byteOffset);let H=0;for(;-1!=--j;)L=F[H],D=_[H],U[H]=L-D-N&65535,N=L-D-N&65536?1:0,H++;return N}sub_bignum_word(S,O,B,N,j){var L,D;let F=0;for(;-1!=--j;)L=O[F],D=B[F],S[F]=L-D-N&65535,N=L-D-N&65536?1:0,F++;return N}inv_bignum(S,O,B){const N=new Uint32Array(64);var j;let L,D,F=0;for(this.init_bignum(N,0,B),this.init_bignum(S,0,B),D=this.bitlen_bignum(O,B),L=1<<D%32>>>0,F=((D+32)/32|0)-1,N[(j=4*((D-1)/32|0)>>>0)/4|0]=N[j/4|0]|1<<(D-1&31)>>>0;0<D;)D--,this.shl_bignum(N,1,B),-1!==this.cmp_bignum(N,O,B)&&(this.sub_bignum(N,N,O,0,B),S[F]=S[F]|L>>>0),L>>>=1,0===L&&(F--,L=2147483648);this.init_bignum(N,0,B)}inc_bignum(S,O){let B=0;for(;0==++S[B]&&0<--O;)B++}init_two_dw(S,O){this.mov_bignum(this.glob1,S,O),this.glob1_bitlen=this.bitlen_bignum(this.glob1,O),this.glob1_len_x2=(this.glob1_bitlen+15)/16|0,this.mov_bignum(this.glob1_hi,this.glob1.subarray(this.len_bignum(this.glob1,O)-2),2),this.glob1_hi_bitlen=this.bitlen_bignum(this.glob1_hi,2)-32>>>0,this.shr_bignum(this.glob1_hi,this.glob1_hi_bitlen,2),this.inv_bignum(this.glob1_hi_inv,this.glob1_hi,2),this.shr_bignum(this.glob1_hi_inv,1,2),this.glob1_hi_bitlen=(this.glob1_hi_bitlen+15)%16+1>>>0,this.inc_bignum(this.glob1_hi_inv,2),32<this.bitlen_bignum(this.glob1_hi_inv,2)&&(this.shr_bignum(this.glob1_hi_inv,1,2),this.glob1_hi_bitlen--),this.glob1_hi_inv_lo=65535&this.glob1_hi_inv[0],this.glob1_hi_inv_hi=this.glob1_hi_inv[0]>>>16&65535}mul_bignum_word(S,O,B,N){let j,L;var D=new Uint16Array(O.buffer,O.byteOffset);let F=L=0;for(j=0;j<N;j++)L=B*D[F]+S[F]+L,S[F]=65535&L,F++,L>>>=16;S[F]+=65535&L}mul_bignum(S,O,B,N){let j;var L=new Uint16Array(B.buffer,B.byteOffset);let D=new Uint16Array(S.buffer,S.byteOffset);this.init_bignum(S,0,2*N);let F=0;for(j=0;j<2*N;j++)this.mul_bignum_word(D.subarray(F),O,L[F],2*N),F++}not_bignum(S,O){let B;for(B=0;B<O;B++)S[B]=~S[B]>>>0}neg_bignum(S,O){this.not_bignum(S,O),this.inc_bignum(S,O)}get_mulword(S,O){let B=((((65535&(65535^S[O-1]))*this.glob1_hi_inv_lo+65536>>>1)+((65535^S[O-2])*this.glob1_hi_inv_hi+this.glob1_hi_inv_hi>>>1)+1>>>16)+((65535&(65535^S[O-1]))*this.glob1_hi_inv_hi>>>1)+((65535^S[O])*this.glob1_hi_inv_lo>>>1)+1>>>14)+this.glob1_hi_inv_hi*(65535^S[O])*2>>>this.glob1_hi_bitlen>>>0;return 65535<B&&(B=65535),65535&B}dec_bignum(S,O){let B=0;for(;--S[B]>>>0==4294967295&&0<--O;)B++}calc_a_bignum(S,O,B,N){var j;let L;var D=this.glob1,F=this.glob2;if(this.mul_bignum(this.glob2,O,B,N),this.glob2[2*N]=0,(j=2*this.len_bignum(this.glob2,2*N+1))>=this.glob1_len_x2){this.inc_bignum(this.glob2,2*N+1),this.neg_bignum(this.glob2,2*N+1),L=1+j-this.glob1_len_x2;let S=new Uint16Array(F.buffer),O=L,B=1+j;for(;0!==L;L--){B--;var _=this.get_mulword(S,B);O--;var U=S.subarray(O);0<_&&(this.mul_bignum_word(U,this.glob1,_,2*N),!(32768&S[B])&&0!==this.sub_bignum_word(U,U,new Uint16Array(D.buffer),0,2*N)&&S[B]--)}this.neg_bignum(this.glob2,N),this.dec_bignum(this.glob2,N)}this.mov_bignum(S,this.glob2,N)}clear_tmp_vars(S){this.init_bignum(this.glob1,0,S),this.init_bignum(this.glob2,0,S),this.init_bignum(this.glob1_hi_inv,0,4),this.init_bignum(this.glob1_hi,0,4),this.glob1_bitlen=0,this.glob1_hi_bitlen=0,this.glob1_len_x2=0,this.glob1_hi_inv_lo=0,this.glob1_hi_inv_hi=0}calc_a_key(S,O,B,N,j){var L,D=new Uint32Array(64);let F,_,U=0;for(this.init_bignum(S,1,j),L=this.len_bignum(N,j),this.init_two_dw(N,L),F=this.bitlen_bignum(B,L)<<24>>24,_=1<<(F-1)%32>>>1,U+=(((F+31)/32|0)>>>0)-1,F--,this.mov_bignum(S,O,L);-1!=--F;)0===_&&(_=2147483648,U--),this.calc_a_bignum(D,S,S,L),0!=(B[U]&_)?this.calc_a_bignum(S,D,O,L):this.mov_bignum(S,D,L),_>>>=1;this.init_bignum(D,0,L),this.clear_tmp_vars(j)}memcpy(S,O,B){let N=0;for(;0!=B--;)S[N]=O[N],N++}process_predata(S,O,B){var N=new Uint32Array(64),j=new Uint32Array(64);let L=0,D=0;for(var F=(this.pubkey.len-1)/8|0;1+F<=O;)this.init_bignum(N,0,64),this.memcpy(new Uint8Array(N.buffer),S.subarray(L),1+F),this.calc_a_key(j,N,this.pubkey.key2,this.pubkey.key1,64),this.memcpy(B.subarray(D),new Uint8Array(j.buffer),F),O-=1+F,L+=1+F,D+=F}decryptKey(S){this.init_pubkey();let O=new Uint8Array(256);return this.process_predata(S,this.len_predata(),O),O.subarray(0,56)}})}}}),System.register("data/encoding/Format3",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("Format3",class{static decode(S,O,B){let N=new Uint8Array(O*B),j=0,L=0;for(let D=0;D<B;D++){let B=(S[j+1]<<8|S[j])-2;j+=2;let D=0;for(;0<B--;){let F=S[j++];if(0!==F)D++,N[L++]=F;else for(B--,F=S[j++],D+F>O&&(F=O-D&255),D+=F;0!=F--;)N[L++]=0}}return N}})}}}),System.register("data/encoding/Format5",["data/encoding/Format80","data/encoding/MiniLzo"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("Format5",class{static decode(S,O,B=5){var N=new Uint8Array(O);return this.decodeInto(S,N,B),N}static decodeInto(S,O,j=5){var L=O.length;let D=0,F=0;for(;F<L;){var _=S[D+1]<<8|S[D];D+=2;var U=S[D+1]<<8|S[D];if(D+=2,!_||!U)break;let L;L=80===j?B.Format80.decode(S.subarray(D,D+_),U):N.MiniLzo.decompress(S.subarray(D,D+_),U);for(let S=0;S<U;++S)O[F+S]=L[S];D+=_,F+=U}}})}}}),System.register("data/encoding/Format80",["data/DataStream"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("Format80",class{static decode(S,O){var B=new Uint8Array(O);return this.decodeInto(S,B),B}static decodeInto(S,O){let N=new B.DataStream(new DataView(S.buffer,S.byteOffset,S.byteLength)),j=0;for(;;){var L=N.readUint8();if(128&L)if(64&L)if(62==(L&=63))for(var D=N.readInt16(),F=N.readUint8(),_=j+D;j<_;j++)O[j]=F;else if(63==L){D=N.readInt16();let S=N.readInt16();if(S>=j)throw new Error(`srcIndex >= destIndex  ${S}  `+j);for(var U=j+D;j<U;j++)O[j]=O[S++]}else{L=3+L;let S=N.readInt16();if(S>=j)throw new Error(`srcIndex >= destIndex  ${S}  `+j);for(var H=j+L;j<H;j++)O[j]=O[S++]}else{if(0==(W=63&L))return j;O.set(N.readUint8Array(W),j),j+=W}else{var V=N.readUint8(),W=3+((112&L)>>4);this.replicatePrevious(O,j,j-(((15&L)<<8)+V),W),j+=W}}}static replicatePrevious(S,O,B,N){if(O<B)throw new Error(`srcIndex > destIndex  ${B}  `+O);if(O-B==1)for(let B=0;B<N;B++)S[O+B]=S[O-1];else for(let j=0;j<N;j++)S[O+j]=S[B+j]}})}}}),System.register("data/encoding/MiniLzo",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("MiniLzo",class{static decompress(S,O){var B={inputBuffer:S,outputBuffer:null},N=lzo1x.decompress(B,{outputSize:O});if(0!==N)throw new Error("MiniLzo decode failed with code "+N);return B.outputBuffer}})}}}),System.register("data/hva/Section",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("Section",class{getMatrix(S){return this.matrices[S]}})}}}),System.register("data/map/MapLighting",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("MapLighting",class{constructor(){this.level=0,this.ambient=1,this.red=1,this.green=1,this.blue=1,this.ground=0,this.forceTint=!1}read(S,O=""){return this.level=S.getNumber(O+"Level",.032),this.ambient=S.getNumber(O+"Ambient",1),this.red=S.getNumber(O+"Red",1),this.green=S.getNumber(O+"Green",1),this.blue=S.getNumber(O+"Blue",1),this.ground=S.getNumber(O+"Ground",0),this}copy(S){return this.level=S.level,this.ambient=S.ambient,this.red=S.red,this.green=S.green,this.blue=S.blue,this.ground=S.ground,this.forceTint=S.forceTint,this}})}}}),System.register("data/map/SpecialFlags",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("SpecialFlags",class{read(S){return this.initialVeteran=S.getBool("InitialVeteran"),this}})}}}),System.register("data/map/Variable",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("Variable",class e{constructor(S,O){this.name=S,this.value=O}clone(){return new e(this.name,this.value)}})}}}),System.register("data/map/tag/CellTag",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("data/map/tag/CellTagsReader",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("CellTagsReader",class{read(S,O){let B=[];for(var[N,j]of S.entries)N={tagId:j,coords:this.readCoords(Number(N),O)},B.push(N);return B}readCoords(S,O){var B=O<4?128:1e3;return{x:S%B,y:Math.floor(S/B)}}})}}}),System.register("data/map/tag/Tag",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("Tag",class{})}}}),System.register("data/map/tag/TagRepeatType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("TagRepeatType",B={}))[O.OnceAny=0]="OnceAny",O[O.OnceAll=1]="OnceAll",O[O.Repeat=2]="Repeat"}}}),System.register("data/map/tag/TagsReader",["data/map/tag/TagRepeatType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("TagsReader",class{read(S){let O=[];for(var[N,j]of S.entries){var L=j.split(",");L.length<3?console.warn(`Invalid tag ${N}=${j}. Skipping.`):(j=Number(L[0]),void 0!==B.TagRepeatType[j]?(L={id:N,repeatType:j,name:L[1],triggerId:L[2]},O.push(L)):console.warn(`Invalid repeat value ${j} for tag id ${N}. Skipping.`))}return O}})}}}),System.register("data/map/trigger/Trigger",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("data/map/trigger/TriggerAction",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("data/map/trigger/TriggerActionType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("TriggerActionType",B={}))[O.NoAction=0]="NoAction",O[O.FireSale=9]="FireSale",O[O.TextTrigger=11]="TextTrigger",O[O.DestroyTrigger=12]="DestroyTrigger",O[O.ChangeHouse=14]="ChangeHouse",O[O.RevealMap=16]="RevealMap",O[O.RevealAroundWaypoint=17]="RevealAroundWaypoint",O[O.PlaySoundFx=19]="PlaySoundFx",O[O.PlaySpeech=21]="PlaySpeech",O[O.ForceTrigger=22]="ForceTrigger",O[O.TimerStart=23]="TimerStart",O[O.TimerStop=24]="TimerStop",O[O.TimerExtend=25]="TimerExtend",O[O.TimerShorten=26]="TimerShorten",O[O.TimerSet=27]="TimerSet",O[O.GlobalSet=28]="GlobalSet",O[O.GlobalClear=29]="GlobalClear",O[O.DestroyObject=32]="DestroyObject",O[O.AddOneTimeSuperWeapon=33]="AddOneTimeSuperWeapon",O[O.AddRepeatingSuperWeapon=34]="AddRepeatingSuperWeapon",O[O.AllChangeHouse=36]="AllChangeHouse",O[O.ResizePlayerView=40]="ResizePlayerView",O[O.PlayAnimAt=41]="PlayAnimAt",O[O.DetonateWarhead=42]="DetonateWarhead",O[O.ReshroudMap=51]="ReshroudMap",O[O.EnableTrigger=53]="EnableTrigger",O[O.DisableTrigger=54]="DisableTrigger",O[O.CreateRadarEvent=55]="CreateRadarEvent",O[O.LocalSet=56]="LocalSet",O[O.LocalClear=57]="LocalClear",O[O.SellBuilding=60]="SellBuilding",O[O.TurnOffBuilding=61]="TurnOffBuilding",O[O.TurnOnBuilding=62]="TurnOnBuilding",O[O.ApplyOneHundredDamage=63]="ApplyOneHundredDamage",O[O.ForceEnd=69]="ForceEnd",O[O.DestroyTag=70]="DestroyTag",O[O.SetAmbientStep=71]="SetAmbientStep",O[O.SetAmbientRate=72]="SetAmbientRate",O[O.SetAmbientLight=73]="SetAmbientLight",O[O.NukeStrike=95]="NukeStrike",O[O.PlaySoundFxAt=99]="PlaySoundFxAt",O[O.UnrevealAroundWaypoint=101]="UnrevealAroundWaypoint",O[O.LightningStrike=102]="LightningStrike",O[O.TimerText=103]="TimerText",O[O.CreateCrate=108]="CreateCrate",O[O.IronCurtainAt=109]="IronCurtainAt",O[O.EvictOccupiers=111]="EvictOccupiers",O[O.Cheer=113]="Cheer",O[O.StopSoundsAt=116]="StopSoundsAt"}}}),System.register("data/map/trigger/TriggerEvent",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("data/map/trigger/TriggerEventType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("TriggerEventType",B={}))[O.NoEvent=0]="NoEvent",O[O.EnteredBy=1]="EnteredBy",O[O.SpiedBy=2]="SpiedBy",O[O.AttackedByAny=6]="AttackedByAny",O[O.DestroyedByAny=7]="DestroyedByAny",O[O.AnyEvent=8]="AnyEvent",O[O.DestroyedAllUnits=9]="DestroyedAllUnits",O[O.DestroyedAllBuildings=10]="DestroyedAllBuildings",O[O.DestroyedAll=11]="DestroyedAll",O[O.CreditsExceed=12]="CreditsExceed",O[O.ElapsedTime=13]="ElapsedTime",O[O.MissionTimerExpired=14]="MissionTimerExpired",O[O.DestroyedBuildings=15]="DestroyedBuildings",O[O.DestroyedUnits=16]="DestroyedUnits",O[O.NoFactoriesLeft=17]="NoFactoriesLeft",O[O.BuildBuilding=19]="BuildBuilding",O[O.BuildUnit=20]="BuildUnit",O[O.BuildInfantry=21]="BuildInfantry",O[O.BuildAircraft=22]="BuildAircraft",O[O.CrossesHorizontalLine=25]="CrossesHorizontalLine",O[O.CrossesVerticalLine=26]="CrossesVerticalLine",O[O.GlobalIsSet=27]="GlobalIsSet",O[O.GlobalIsCleared=28]="GlobalIsCleared",O[O.DestroyedOrCaptured=29]="DestroyedOrCaptured",O[O.LowPower=30]="LowPower",O[O.DestroyedBridge=31]="DestroyedBridge",O[O.BuildingExists=32]="BuildingExists",O[O.ComesNearWaypoint=34]="ComesNearWaypoint",O[O.LocalIsSet=36]="LocalIsSet",O[O.LocalIsCleared=37]="LocalIsCleared",O[O.FirstDamagedCombat=38]="FirstDamagedCombat",O[O.HalfHealthCombat=39]="HalfHealthCombat",O[O.QuarterHealthCombat=40]="QuarterHealthCombat",O[O.FirstDamagedAny=41]="FirstDamagedAny",O[O.HalfHealthAny=42]="HalfHealthAny",O[O.QuarterHealthAny=43]="QuarterHealthAny",O[O.AttackedByHouse=44]="AttackedByHouse",O[O.AmbientLightBelow=45]="AmbientLightBelow",O[O.AmbientLightAbove=46]="AmbientLightAbove",O[O.ElapsedScenarioTime=47]="ElapsedScenarioTime",O[O.DestroyedOrCapturedOrInfiltrated=48]="DestroyedOrCapturedOrInfiltrated",O[O.PickupCrate=49]="PickupCrate",O[O.PickupCrateAny=50]="PickupCrateAny",O[O.RandomDelay=51]="RandomDelay",O[O.CreditsBelow=52]="CreditsBelow",O[O.SpyEnteringAsHouse=53]="SpyEnteringAsHouse",O[O.SpyEnteringAsInfantry=54]="SpyEnteringAsInfantry",O[O.DestroyedAllUnitsNaval=55]="DestroyedAllUnitsNaval",O[O.DestroyedAllUnitsLand=56]="DestroyedAllUnitsLand",O[O.BuildingNotExists=57]="BuildingNotExists"}}}),System.register("data/map/trigger/TriggerReader",["data/map/trigger/TriggerEventType","data/map/trigger/TriggerActionType"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("TriggerReader",class{read(S,O,B,N){let j=this.readTriggers(S),{events:L,unknownEventTypes:D}=this.readEvents(O),{actions:F,unknownActionTypes:_}=this.readActions(B),U=[...N.values()],H=new Set(j);for(let S of j.values()){var V=L.get(S.id);V&&S.events.push(...V),(V=F.get(S.id))&&S.actions.push(...V),!S.attachedTriggerId||(V=j.find(O=>O.id===S.attachedTriggerId))&&(S.attachedTrigger=V,H.delete(V))}for(let S of H){var W=U.find(O=>O.triggerId===S.id);if(W){let O=S;for(;O;)O.tag=W,O=O.attachedTrigger}else{let O=S;for(;O;){console.warn(`Trigger ${O.id} has no associated tag or valid root trigger. Skipping.`);var z=j.indexOf(O);-1!==z&&j.splice(z,1),O=O.attachedTrigger}}}return{triggers:j,unknownEventTypes:D,unknownActionTypes:_}}readTriggers(S){let O=[];for(var[B,N]of S.entries){var j=N.split(",");j.length<8?console.warn(`Invalid trigger ${B}=${N}. Skipping.`):(j={id:B,houseName:j[0],attachedTriggerId:"<none>"!==j[1]?j[1]:void 0,attachedTrigger:void 0,name:j[2],disabled:Boolean(Number(j[3])),difficulties:{easy:Boolean(Number(j[4])),medium:Boolean(Number(j[5])),hard:Boolean(Number(j[6]))},events:[],actions:[],tag:void 0},O.push(j))}return O}readEvents(S){let O=new Map,N=new Set;for(var[j,L]of S.entries){let S=L.split(",");if(S.length<4)console.warn(`Invalid event ${j}=${L}. Skipping.`);else{var D=Number(S.shift());let L=[];for(let O=0;O<D;O++){var F=Number(S.shift()),_=Number(S.shift());let D=S.splice(0,2===_?2:1);void 0!==B.TriggerEventType[F]?(_={triggerId:j,eventIndex:O,type:F,params:[_,...D.map(S=>S||"0")]},L.push(_)):(N.add(F),console.warn(`Unknown event type ${F} for trigger id ${j}. Skipping.`))}O.set(j,L)}}return{events:O,unknownEventTypes:N}}readActions(S){let O=new Map,B=new Set;for(var[j,L]of S.entries){let S=L.split(",");if(S.length<9)console.warn(`Invalid action ${j}=${L}. Skipping.`);else{var D=Number(S.shift());if(S.length<8*D)console.warn(`Invalid action ${j}=${L}. Skipping.`);else{let L=[];for(let O=0;O<D;O++){var F=Number(S.shift()),_=S.splice(0,7);void 0!==N.TriggerActionType[F]?(_={triggerId:j,index:O,type:F,params:[Number(_[0]||"0"),_[1]||"0",_[2]||"0",_[3]||"0",_[4]||"0",_[5]||"0",_[6]?this.readAZActionParam(_[6]):0]},L.push(_)):(B.add(F),console.warn(`Unknown action type ${F} for trigger id "${j}". Skipping.`))}O.set(j,L)}}}return{actions:O,unknownActionTypes:B}}readAZActionParam(S){var O="Z".charCodeAt(0),B="A".charCodeAt(0);return O=O-B+1,1<S.length?S.charCodeAt(1)-B+(S.charCodeAt(0)-B+1)*O:S.charCodeAt(0)-B}})}}}),System.register("data/mapObjects",["engine/type/ObjectType"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("MapObject",N=class{constructor(S){this.type=S}isStructure(){return this.type===B.ObjectType.Building}isVehicle(){return this.type===B.ObjectType.Vehicle}isInfantry(){return this.type===B.ObjectType.Infantry}isAircraft(){return this.type===B.ObjectType.Aircraft}isTerrain(){return this.type===B.ObjectType.Terrain}isSmudge(){return this.type===B.ObjectType.Smudge}isOverlay(){return this.type===B.ObjectType.Overlay}isNamed(){return"name"in this}isTechno(){return"health"in this}}),L=class extends N{},j=class extends L{},S("Structure",class extends j{constructor(){super(B.ObjectType.Building)}}),S("Vehicle",class extends j{constructor(){super(B.ObjectType.Vehicle)}}),S("Infantry",class extends j{constructor(){super(B.ObjectType.Infantry)}}),S("Aircraft",j=class extends j{constructor(){super(B.ObjectType.Aircraft)}}),S("Terrain",j=class extends L{constructor(){super(B.ObjectType.Terrain)}}),S("Smudge",L=class extends L{constructor(){super(B.ObjectType.Smudge)}}),S("Overlay",L=class extends N{constructor(){super(B.ObjectType.Overlay)}})}}}),System.register("data/vfs/Archive",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("data/vfs/FileNotFoundError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends Error{constructor(){super(...arguments),this.name="FileNotFoundError"}},S("FileNotFoundError",B)}}}),System.register("data/vfs/IOError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends Error{constructor(){super(...arguments),this.name="IOError"}},S("IOError",B)}}}),System.register("data/vfs/MemArchive",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("MemArchive",class{constructor(){this.entries=new Map}addFile(S){this.entries.set(S.filename,S)}containsFile(S){return this.entries.has(S)}openFile(S){if(!this.containsFile(S))throw new Error(`File "${S}" not found`);return this.entries.get(S)}})}}}),System.register("data/vfs/NameNotAllowedError",["data/vfs/IOError"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.IOError{constructor(){super(...arguments),this.name="NameNotAllowedError"}},S("NameNotAllowedError",N)}}}),System.register("data/vfs/RealFileSystem",["data/vfs/FileNotFoundError","data/vfs/RealFileSystemDir"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("RealFileSystem",class{constructor(){this.directories=[]}addRootDirectoryHandle(S){this.rootDirectory=this.addDirectoryHandle(S),this.rootDirectoryHandle=S}getRootDirectoryHandle(){return this.rootDirectoryHandle}addDirectoryHandle(S){var O=new N.RealFileSystemDir(S);return this.directories.push(O),O}addDirectory(S){this.directories.push(S)}async getDirectory(S){var O=await this.findDirectory(S);if(!O)throw new Error(`Directory "${S}" not found in real file system`);return O}async findDirectory(S){for(const O of this.directories)if(await O.containsEntry(S))return await O.getDirectory(S)}getRootDirectory(){return this.rootDirectory}async containsEntry(S){for(const O of this.directories)if(await O.containsEntry(S))return!0;return!1}async openFile(S,O=!1){for(const N of this.directories)try{return await N.openFile(S,O)}catch(S){if(!(S instanceof B.FileNotFoundError))throw S}throw new B.FileNotFoundError(`File "${S}" not found in real file system`)}async getRawFile(S){for(const O of this.directories)if(await O.containsEntry(S))return await O.getRawFile(S);throw new Error(`File "${S}" not found in real file system`)}async*getEntries(){for(var S of this.directories)for await(var O of S.getEntries())yield O}})}}}),System.register("data/vfs/RealFileSystemDir",["data/vfs/StorageQuotaError","util/string","data/vfs/FileNotFoundError","data/vfs/IOError","data/vfs/NameNotAllowedError","data/vfs/VirtualFile"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){S("RealFileSystemDir",class e{constructor(S,O=!1){this.handle=S,this.caseSensitive=O}get name(){return this.handle.name}async*getEntries(){try{for await(var S of this.handle.keys())yield S}catch(S){if("NotFoundError"===S.name)throw new j.FileNotFoundError(`Directory "${this.handle.name}" not found`,{cause:S});if(S instanceof DOMException)throw new L.IOError(`Directory "${this.handle.name}" could not be read (${S.name})`,{cause:S});throw S}}async listEntries(){let S=[];for await(var O of this.getEntries())S.push(O);return S}async*getFileHandles(){try{for await(const S of this.handle.values())"file"===S.kind&&(yield S)}catch(S){if("NotFoundError"===S.name)throw new j.FileNotFoundError(`Directory "${this.handle.name}" not found`,{cause:S});if(S instanceof DOMException)throw new L.IOError(`Directory "${this.handle.name}" could not be read (${S.name})`,{cause:S});throw S}}async*getRawFiles(){for await(const S of this.getFileHandles())yield await S.getFile()}async containsEntry(S){return void 0!==await this.resolveEntryName(S)}async resolveEntryName(S){if(this.caseSensitive)return(await this.handle.getFileHandle(S).catch(()=>this.handle.getDirectoryHandle(S)).catch(()=>{}))?.name;for await(const O of this.getEntries())if(N.equalsIgnoreCase(O,S))return O}async fixEntryCase(S){if(!this.caseSensitive)for await(var O of this.getEntries())if(N.equalsIgnoreCase(O,S)){S=O;break}return S}async getRawFile(S,O=!1,B){let N;try{var F=O?S:await this.fixEntryCase(S);N=await this.handle.getFileHandle(F)}catch(O){if("NotFoundError"===O.name)throw new j.FileNotFoundError(`File "${S}" not found in directory "${this.handle.name}"`,{cause:O});if(O instanceof TypeError&&O.message.includes("not allowed"))throw new D.NameNotAllowedError(`File name "${S}" is not allowed`,{cause:O});if(O instanceof DOMException)throw new L.IOError(`File "${S}" could not be read (${O.name})`,{cause:O});throw O}return F=await N.getFile(),B?new File([F],F.name,{type:B}):F}async openFile(S,O=!1){var B=await this.getRawFile(S,O);return F.VirtualFile.fromRealFile(B)}async writeFile(S,O){var N=O??(S instanceof File?S.name:S.filename);try{var F=await this.fixEntryCase(N);await this.deleteFile(F,!0);let B=await this.handle.getFileHandle(F,{create:!0}),j=await B.createWritable();try{await j.write(S instanceof File?S:new Uint8Array(S.stream.buffer,S.stream.byteOffset,S.stream.byteLength)),await j.close()}catch(O){throw await j.abort(),O}}catch(O){if("QuotaExceededError"===O.name)throw new B.StorageQuotaError({cause:O});if("NotFoundError"===O.name)throw new j.FileNotFoundError(`Directory "${this.handle.name}" not found`,{cause:O});if(O instanceof TypeError&&O.message.includes("not allowed"))throw new D.NameNotAllowedError(`File name "${N}" is not allowed`,{cause:O});if(O instanceof DOMException)throw new L.IOError(`File "${N}" could not be written (${O.name})`,{cause:O});throw O}}async deleteFile(S,O=!1){var N=O?S:await this.resolveEntryName(S);if(N)try{await this.handle.removeEntry(N)}catch(S){if(O&&"NotFoundError"===S.name)return;if("QuotaExceededError"===S.name)throw new B.StorageQuotaError({cause:S});if(S instanceof TypeError&&S.message.includes("not allowed"))throw new D.NameNotAllowedError(`File name "${N}" is not allowed`,{cause:S});if(S instanceof DOMException)throw new L.IOError(`File "${N}" could not be deleted (${S.name})`,{cause:S});throw S}}async getDirectory(S,O=this.caseSensitive){var B=O?S:await this.fixEntryCase(S);let N;try{N=await this.handle.getDirectoryHandle(B)}catch(O){if("NotFoundError"===O.name)throw new j.FileNotFoundError(`Directory "${S}" not found or parent directory "${this.handle.name}" is gone`,{cause:O});if(O instanceof TypeError&&O.message.includes("not allowed"))throw new D.NameNotAllowedError(`Directory name "${S}" is not allowed`,{cause:O});if(O instanceof DOMException)throw new L.IOError(`Directory "${S}" could not be read (${O.name})`,{cause:O});throw O}return new e(N,O)}async getOrCreateDirectory(S,O=this.caseSensitive){var N=O?S:await this.fixEntryCase(S);try{return new e(await this.handle.getDirectoryHandle(N,{create:!0}),O)}catch(O){if("QuotaExceededError"===O.name)throw new B.StorageQuotaError({cause:O});if("NotFoundError"===O.name)throw new j.FileNotFoundError(`Directory "${this.handle.name}" not found"`,{cause:O});if(O instanceof TypeError&&O.message.includes("not allowed"))throw new D.NameNotAllowedError(`Directory name "${S}" is not allowed`,{cause:O});if(O instanceof DOMException)throw new L.IOError(`Directory "${S}" could not be created (${O.name})`,{cause:O});throw O}}async deleteDirectory(S,O=!1){var N=await this.resolveEntryName(S);if(N)try{await this.handle.removeEntry(N,{recursive:O})}catch(S){if("QuotaExceededError"===S.name)throw new B.StorageQuotaError({cause:S});if("InvalidModificationError"===S.name)throw new L.IOError("Can't delete non-empty directory when recursive = false");if(S instanceof TypeError&&S.message.includes("not allowed"))throw new D.NameNotAllowedError(`Directory name "${N}" is not allowed`,{cause:S});if(S instanceof DOMException)throw new L.IOError(`Directory "${N}" could not be deleted (${S.name})`,{cause:S});throw S}}})}}}),System.register("data/vfs/StorageQuotaError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends Error{constructor(S){super("Storage quota exceeded",S),this.name="StorageQuotaError"}},S("StorageQuotaError",B)}}}),System.register("data/vfs/VirtualFile",["data/DataStream","data/vfs/IOError"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("VirtualFile",class{static async fromRealFile(S){try{const O=new B.DataStream(await S.arrayBuffer());return O._trimAlloc=()=>{},new this(O,S.name)}catch(O){if(O instanceof DOMException)throw new N.IOError(`File "${S.name}" could not be read (${O.name})`,{cause:O});throw O}}static fromBytes(S,O){let N=new B.DataStream(S);return N._trimAlloc=()=>{},new this(N,O)}static factory(S,O,N=0,j=S.byteLength){var L=new DataView(S.buffer,S.byteOffset+N,j);const D=new B.DataStream(L);return D._trimAlloc=()=>{},new this(D,O)}constructor(S,O){this.stream=S,this.filename=O}readAsString(S){return this.stream.seek(0),this.stream.readString(this.stream.byteLength,S)}getBytes(){return new Uint8Array(this.stream.buffer,this.stream.byteOffset,this.stream.byteLength)}getSize(){return this.stream.byteLength}asFile(S){return new File([this.getBytes()],this.filename,{type:S})}})}}}),System.register("data/vfs/VirtualFileSystem",["data/AudioBagFile","data/IdxFile","data/MixFile","engine/Engine","util/string","data/vfs/FileNotFoundError","data/vfs/MemArchive"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){S("VirtualFileSystem",class{constructor(S,O){this.rfs=S,this.logger=O,this.allArchives=new Map,this.archivesByPriority=[]}fileExists(S){for(const O of this.archivesByPriority)if(O.containsFile(S))return!0;return!1}openFile(S){for(const O of this.archivesByPriority)if(O.containsFile(S))return O.openFile(S);throw new F.FileNotFoundError(`File "${S}" not found in VFS`)}addArchive(S,O){this.allArchives.has(O)||(this.allArchives.set(O,S),this.archivesByPriority.push(S)),this.logger.info(`Added archive "${O}" to VFS`)}hasArchive(S){return this.allArchives.has(S)}removeArchive(S){var O=this.allArchives.get(S);O&&(this.allArchives.delete(S),this.archivesByPriority.splice(this.archivesByPriority.indexOf(O),1),this.logger.info(`Removed archive "${S}" from VFS`))}listArchives(){return[...this.allArchives.keys()]}async addMixFile(S){await this.addArchiveByFilename(S,S=>new j.MixFile(S.stream))}async addBagFile(S){const O=await this.openFileWithRfs(S.replace(".bag",".idx"));await this.addArchiveByFilename(S,S=>{var j=new N.IdxFile(O.stream);return(new B.AudioBagFile).fromVirtualFile(S,j)})}async addArchiveByFilename(S,O){var B;this.allArchives.has(S)||(B=await this.openFileWithRfs(S))&&this.addArchive(O(B),S)}async openFileWithRfs(S){let O;try{O=await this.rfs.openFile(S)}catch(S){if(!(S instanceof F.FileNotFoundError))throw S}if(!O){if(!this.fileExists(S))throw new F.FileNotFoundError(`File "${S}" not found`);O=this.openFile(S)}return O}async loadImplicitMixFiles(S){this.logger.info("Initializing implicit mix files..."),S===L.EngineType.YurisRevenge&&await this.addMixFile("langmd.mix"),await this.addMixFile("language.mix"),S===L.EngineType.YurisRevenge&&await this.addMixFile("ra2md.mix"),await this.addMixFile("ra2.mix"),S===L.EngineType.YurisRevenge&&await this.addMixFile("cachemd.mix"),await this.addMixFile("cache.mix"),S===L.EngineType.YurisRevenge&&await this.addMixFile("loadmd.mix"),await this.addMixFile("load.mix"),S===L.EngineType.YurisRevenge&&await this.addMixFile("localmd.mix"),await this.addMixFile("local.mix"),S===L.EngineType.YurisRevenge&&await this.addMixFile("ntrlmd.mix"),await this.addMixFile("neutral.mix"),S===L.EngineType.YurisRevenge&&await this.addMixFile("audiomd.mix"),await this.addMixFile("audio.mix"),await this.addBagFile("audio.bag"),await this.addMixFile("conquer.mix"),S===L.EngineType.YurisRevenge&&(await this.addMixFile("conqmd.mix"),await this.addMixFile("genermd.mix")),await this.addMixFile("generic.mix"),S===L.EngineType.YurisRevenge&&await this.addMixFile("isogenmd.mix"),await this.addMixFile("isogen.mix"),S===L.EngineType.YurisRevenge&&await this.addMixFile("cameomd.mix"),await this.addMixFile("cameo.mix"),await this.addMixFile("cameocd.mix"),S===L.EngineType.YurisRevenge&&await this.addMixFile("multimd.mix"),await this.addMixFile("multi.mix")}async loadExtraMixFiles(S){let O=new Set;for await(var B of this.rfs.getEntries())O.add(B.toLowerCase());for(var N of["ecache","expand","elocal"])for(let B=99;0<=B;B--){let j=[""+N+D.pad(B,"00")+".mix"];for(var F of(S===L.EngineType.YurisRevenge&&j.push(`${N}md${D.pad(B,"00")}.mix`),j))O.has(F)&&await this.addMixFile(F)}let _=[".mmx"];S===L.EngineType.YurisRevenge&&_.push(".yro");for(const S of _)for(const B of O)B.endsWith(S)&&this.addArchive(new j.MixFile((await this.rfs.openFile(B)).stream),B)}async loadStandaloneFiles(S){let O=["ini","csf"],B=new Set(S?.exclude),N=[];for await(var j of this.rfs.getEntries()){let S=j.toLowerCase();O.some(O=>S.endsWith("."+O))&&!B.has(S)&&N.push(await this.rfs.openFile(j,!0))}if(N.length){let S=new _.MemArchive;for(var L of N)S.addFile(L);this.addArchive(S,"mem.archive")}}})}}}),System.register("data/vxl/Section",["data/vxl/normals","data/vxl/VoxelField"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("Section",class{get spanX(){return this.maxBounds.x-this.minBounds.x}get spanY(){return this.maxBounds.y-this.minBounds.y}get spanZ(){return this.maxBounds.z-this.minBounds.z}get scaleX(){return this.spanX/this.sizeX}get scaleY(){return this.spanY/this.sizeY}get scaleZ(){return this.spanZ/this.sizeZ}get scale(){return new THREE.Vector3(this.scaleX,this.scaleY,this.scaleZ)}getAllVoxels(){let S=[],O=new N.VoxelField(this.sizeX+1,this.sizeY+1,this.sizeZ+1);for(let N=0,L=this.spans.length;N<L;N++){var B=this.spans[N].voxels;for(let N=0,L=B.length;N<L;N++){var j=B[N];S.push(j),O.add(j)}}return{voxels:S,voxelField:O}}getNormals(){switch(this.normalsMode){case 1:return B.normals1;case 2:return B.normals2;case 3:return B.normals3;case 4:return B.normals4;default:throw new Error("Invalid normalsmode "+this.normalsMode)}}scaleHvaMatrix(S){return(S=S.clone()).elements[12]*=this.hvaMultiplier,S.elements[13]*=this.hvaMultiplier,S.elements[14]*=this.hvaMultiplier,S}toPlain(){return{name:this.name,normalsMode:this.normalsMode,minBounds:this.minBounds.toArray(),maxBounds:this.maxBounds.toArray(),sizeX:this.sizeX,sizeY:this.sizeY,sizeZ:this.sizeZ,hvaMultiplier:this.hvaMultiplier,transfMatrix:this.transfMatrix.toArray(),spans:this.spans}}fromPlain(S){return this.name=S.name,this.normalsMode=S.normalsMode,this.minBounds=(new THREE.Vector3).fromArray(S.minBounds),this.maxBounds=(new THREE.Vector3).fromArray(S.maxBounds),this.sizeX=S.sizeX,this.sizeY=S.sizeY,this.sizeZ=S.sizeZ,this.hvaMultiplier=S.hvaMultiplier,this.transfMatrix=(new THREE.Matrix4).fromArray(S.transfMatrix),this.spans=S.spans,this}})}}}),System.register("data/vxl/Span",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("data/vxl/SpanOffsets",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("data/vxl/Voxel",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("data/vxl/VoxelField",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("VoxelField",class{constructor(S,O,B){this.sizeX=S,this.sizeY=O,this.sizeZ=B,this.arr=new Array(S*O*B)}add(S){this.arr[S.x+S.y*this.sizeX+S.z*this.sizeX*this.sizeY]=S}get(S,O,B){if(!(S>=this.sizeX||O>=this.sizeY||B>=this.sizeZ))return this.arr[S+O*this.sizeX+B*this.sizeX*this.sizeY]}})}}}),System.register("data/vxl/VxlHeader",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){S("VxlHeader",B=class{read(S){this.fileName=S.readCString(16),this.paletteCount=S.readUint32(),this.headerCount=S.readUint32(),this.tailerCount=S.readUint32(),this.bodySize=S.readUint32(),this.paletteRemapStart=S.readUint8(),this.paletteRemapEnd=S.readUint8(),S.seek(S.position+768)}}),B.size=32}}}),System.register("data/vxl/normals",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=THREE.Vector3,S("normals1",[new B(.54946297,-183e-6,-.835518),new B(.00014400001,.54940403,-.83555698),new B(-.54940403,-68000001e-12,-.83555698),new B(106e-6,-.54946297,-.835518),new B(.94900799,.00031599999,-.31525001),new B(-186e-6,.94899702,-.31528401),new B(-.94899702,.00031800001,-.31528401),new B(-447e-6,-.94900799,-.31525001),new B(.95084399,-279e-6,.30967101),new B(202e-6,.95084798,.30965701),new B(-.95084798,-70000002e-12,.30965701),new B(147e-6,-.95084399,.30967101),new B(.55237001,-11e-6,.83359897),new B(19999999e-12,.55238003,.833592),new B(-.55238003,57000001e-12,.83359301),new B(-66000001e-12,-.55237001,.83359897)]),S("normals2",[new B(.67121398,.19849201,-.714194),new B(.26964301,.58439398,-.76536),new B(-.040546,.096988,-.99445897),new B(-.57242799,-.091913998,-.81478697),new B(-.17140099,-.57270998,-.80163902),new B(.36255699,-.30299899,-.88133103),new B(.81034702,-.34897199,-.470698),new B(.103962,.93867201,-.328767),new B(-.324047,.58766901,-.74137598),new B(-.80086499,.34046099,-.49264699),new B(-.66549802,-.59014702,-.45698899),new B(.314767,-.803002,-.506073),new B(.97262901,.151076,-.17655),new B(.680291,.68423599,-.26272699),new B(-.52007902,.82777703,-.210483),new B(-.96164399,-.179001,-.207847),new B(-.262714,-.937451,-.22840101),new B(.219707,-.97130102,.091124997),new B(.92380798,-.229975,.30608699),new B(-.082488999,.97065997,.225866),new B(-.59179801,.69678998,.40528899),new B(-.92529601,.36660099,.097111002),new B(-.705051,-.68777502,.172828),new B(.7324,-.68036699,-.026304999),new B(.85516202,.37458199,.358311),new B(.47300601,.83648002,.276705),new B(-.097617,.65411198,.750072),new B(-.90412402,-.153725,.39865801),new B(-.211916,-.85808998,.46773201),new B(.50022697,-.67440802,.543091),new B(.584539,-.110249,.80384099),new B(.43737301,.45464399,.77588898),new B(-.042440999,.083318003,.995619),new B(-.59625101,.22013199,.77202803),new B(-.506455,-.39697701,.76544899),new B(.070569001,-.47847399,.87526202)]),S("normals3",[new B(.45651099,-.073968001,-.88663799),new B(.50769401,.38511699,-.77067),new B(.095431998,.22666401,-.96928602),new B(-.35876599,.54318798,-.75910097),new B(-.361276,.13299499,-.92292601),new B(-.48311701,-.32406601,-.813375),new B(-.018073,-.197559,-.980124),new B(.3211,-.501477,-.80337799),new B(.79949099,.069615997,-.59662998),new B(.390971,.77130598,-.50222403),new B(.080782004,.61448997,-.784778),new B(-.73275,.41143101,-.54203498),new B(-.73525399,.0091019999,-.67773098),new B(-.80249399,-.39490801,-.44727099),new B(-.13413,-.58915502,-.79680902),new B(.71955299,-.37622699,-.58369303),new B(.96687502,.173593,-.187132),new B(.760831,.51910597,-.38944301),new B(-.114642,.87551898,-.46938601),new B(-.53236699,.76885903,-.354177),new B(-.96226698,.024977,-.27095801),new B(-.46738699,-.721986,-.51018202),new B(.058449998,-.85235399,-.51968902),new B(.49823299,-.74374002,-.44566301),new B(.93915099,-.27024499,-.212044),new B(.58393198,.80944198,-.061857),new B(.183797,.97322798,-.138007),new B(-.88435501,.45221901,-.115822),new B(-.943178,-.33206701,.012138),new B(-.69844002,-.70656699,-.113772),new B(-.228411,-.95470601,-.190694),new B(.73156399,-.675861,-.089588001),new B(.96925098,.046804,.24158201),new B(.85564703,.50347698,.119916),new B(-.25115299,.96794701,-80999998e-12),new B(-.64779502,.75674897,.087711997),new B(-.96916401,.14519399,.1991),new B(-.41479301,-.88896698,.194126),new B(.25077501,-.961178,-.115109),new B(.47862899,-.84259301,.246883),new B(.89004397,-.39614201,.225595),new B(.52405101,.76235998,.37970701),new B(.11962,.94548202,.30291),new B(-.76085001,.49007499,.42536199),new B(-.86978501,-.20215,.450122),new B(-.70946699,-.60242403,.36570701),new B(.019308999,-.95887101,.28318599),new B(.626113,-.564677,.53770101),new B(.769943,-.126663,.62541503),new B(.76419097,.35070199,.54131401),new B(-.001878,.74136698,.67109799),new B(-.37088001,.81836802,.43900099),new B(-.71390897,.12865201,.68831801),new B(-.295165,-.73866397,.60601401),new B(.186195,-.73836899,.648184),new B(.387523,-.35878301,.84917599),new B(.481022,.124846,.86777401),new B(.391808,.54505599,.741216),new B(-.0035359999,.36559799,.93076599),new B(-.42049801,.484961,.76680797),new B(-.35490301,.019470001,.93470001),new B(-.54783702,-.35920799,.75554299),new B(-.106662,-.445115,.88909799),new B(.086796001,-.059307002,.99445897)]),S("normals4",[new B(.52657801,-.35962099,-.77031702),new B(.150482,.43598399,.88728398),new B(.414195,.73825502,-.53237402),new B(.075152002,.91624898,-.393498),new B(-.316149,.93073601,-.18379299),new B(-.77381903,.62333399,-.11251),new B(-.90084201,.42853701,-.069568001),new B(-.99894202,-.010971,.044665001),new B(-.979761,-.15767001,-.123324),new B(-.91127402,-.362371,-.19562),new B(-.62406898,-.72094101,-.301301),new B(-.310173,-.80934501,-.498752),new B(.146613,-.81581903,-.55941403),new B(-.71651602,-.69435602,-.066887997),new B(.50397199,-.114202,-.85613698),new B(.45549101,.87262702,-.176211),new B(-.00501,-.114373,-.99342501),new B(-.104675,-.327701,-.93896502),new B(.56041199,.75258899,-.34575599),new B(-.060575999,.82162797,-.566796),new B(-.30234101,.79700702,-.522847),new B(-.671543,.67074001,-.314863),new B(-.77840102,-.12835699,.61450499),new B(-.92404997,.278382,-.261985),new B(-.69977301,-.55049098,-.45527801),new B(-.56824797,-.51718903,-.64000797),new B(.054097999,-.93286401,-.356143),new B(.75838202,.57289302,-.31088799),new B(.0036200001,.30502599,-.95233703),new B(-.060849998,-.98688602,-.14951099),new B(.63523,.045478001,-.77098298),new B(.52170497,.241309,-.81828701),new B(.26940399,.63542497,-.72364098),new B(.045676,.67275399,-.738455),new B(-.180511,.67465699,-.71571898),new B(-.397131,.63664001,-.66104198),new B(-.55200398,.47251499,-.687038),new B(-.77217001,.08309,-.62996),new B(-.669819,-.119533,-.73284),new B(-.54045498,-.31844401,-.77878201),new B(-.38613501,-.522789,-.75999397),new B(-.261466,-.68856698,-.676395),new B(-.019412,-.69610298,-.71767998),new B(.30356899,-.48184401,-.82199299),new B(.68193901,-.19512901,-.70490003),new B(-.24488901,-.116562,-.96251899),new B(.80075902,-.022979001,-.59854603),new B(-.37027499,.095583998,-.92399102),new B(-.33067101,-.32657799,-.88543999),new B(-.16322,-.52757901,-.83367902),new B(.12639,-.313146,-.941257),new B(.34954801,-.27222601,-.89649802),new B(.23991799,-.085825004,-.96699202),new B(.390845,.081537001,-.91683799),new B(.25526699,.26869699,-.92878503),new B(.146245,.48043799,-.86474901),new B(-.32601601,.47845599,-.81534898),new B(-.46968201,-.112519,-.87563598),new B(.81844002,-.25852001,-.51315099),new B(-.474318,.292238,-.83043301),new B(.778943,.39584199,-.48637101),new B(.62409401,.39377299,-.67487001),new B(.74088597,.203834,-.63995302),new B(.48021701,.565768,-.67029703),new B(.38093001,.42453501,-.82137799),new B(-.093422003,.50112402,-.86031801),new B(-.236485,.29619801,-.92538702),new B(-.131531,.093959004,-.98684901),new B(-.82356203,.29577699,-.48400599),new B(.61106598,-.624304,-.486664),new B(.069495998,-.52033001,-.85113299),new B(.226522,-.66487902,-.711775),new B(.47130799,-.56890398,-.67395699),new B(.38842499,-.74262398,-.54556),new B(.78367501,-.48072901,-.39338499),new B(.962394,.135676,-.235349),new B(.876607,.172034,-.449406),new B(.63340503,.58979303,-.50094098),new B(.182276,.80065799,-.57072097),new B(.177003,.76413399,.62029701),new B(-.544016,.675515,-.49772099),new B(-.67929697,.28646699,-.67564201),new B(-.59039098,.091369003,-.801929),new B(-.82436001,-.13312399,-.55018902),new B(-.71579403,-.33454201,-.61296099),new B(.17428599,-.89248401,.416049),new B(-.082528003,-.83712298,-.54075301),new B(.28333101,-.88087398,-.37918901),new B(.675134,-.42662701,-.60181701),new B(.84372002,-.512335,-.160156),new B(.97730398,-.098555997,-.18752),new B(.846295,.522672,-.102947),new B(.67714101,.72132498,-.145501),new B(.32096499,.87089199,-.37219399),new B(-.178978,.911533,-.37023601),new B(-.44716901,.82670099,-.341474),new B(-.70320302,.496328,-.50908101),new B(-.97718102,.063562997,-.202674),new B(-.87817001,-.412938,.241455),new B(-.83583099,-.35855001,-.415728),new B(-.499174,-.69343299,-.51959199),new B(-.188789,-.92375302,-.33322501),new B(.19225401,-.96936101,-.152896),new B(.51594001,-.783907,-.34539199),new B(.90592498,-.30095199,-.29787099),new B(.99111199,-.127746,.037106998),new B(.99513501,.098424003,-.0043830001),new B(.76012301,.64627701,.067367002),new B(.205221,.95958,-.192591),new B(-.042750001,.97951299,-.19679099),new B(-.43801701,.89892697,.0084920004),new B(-.82199401,.48078501,-.30523899),new B(-.89991701,.081710003,-.42833701),new B(-.92661202,-.144618,-.347096),new B(-.79365999,-.55779201,-.24283899),new B(-.43134999,-.84777898,-.30855799),new B(-.0054919999,-.96499997,.26219299),new B(.58790499,-.80402601,-.088940002),new B(.69949299,-.66768599,-.254765),new B(.88930303,.359795,-.282291),new B(.780972,.197037,.59267199),new B(.52012098,.50669599,.68755698),new B(.40389499,.69396102,.59605998),new B(-.154983,.89923602,.40909001),new B(-.65733802,.53716803,.528543),new B(-.74619502,.33409101,.575827),new B(-.62495202,-.049144,.77911502),new B(.31814101,-.254715,.913185),new B(-.555897,.405294,.725752),new B(-.79443401,.099405997,.59916002),new B(-.64036101,-.68946302,.33849499),new B(-.12671299,-.73409498,.66711998),new B(.105457,-.78081697,.61579502),new B(.40799299,-.48091599,.77605498),new B(.69513601,-.54512,.468647),new B(.97319102,-.0064889998,.229908),new B(.94689399,.317509,-.050799001),new B(.56358302,.82561201,.027183),new B(.325773,.94542301,.0069490001),new B(-.171821,.98509699,-.0078149997),new B(-.67044097,.73993897,.054768998),new B(-.822981,.55496198,.121322),new B(-.96619302,.117857,.229307),new B(-.95376903,-.29470399,.058945),new B(-.86438698,-.50272799,-.010015),new B(-.53060901,-.84200603,-.097365998),new B(-.162618,-.98407501,.071772002),new B(.081446998,-.99601102,.036439002),new B(.74598402,-.66596299,.00076199998),new B(.94205701,-.32926899,-.064106002),new B(.93970197,-.28108999,.194803),new B(.77121401,.55067003,.319363),new B(.641348,.73069,.23402099),new B(.080682002,.99669099,.0098789996),new B(-.046725001,.97664303,.20972501),new B(-.53107601,.82100099,.209562),new B(-.69581503,.65599,.29243499),new B(-.97612202,.216709,-.014913),new B(-.96166098,-.14412899,.23331399),new B(-.772084,-.61364698,.165299),new B(-.44960001,-.83605999,.314426),new B(-.39269999,-.91461599,.096247002),new B(.390589,-.91947001,.044890001),new B(.58252901,-.79919797,.148127),new B(.866431,-.48981199,.096864),new B(.90458697,.111498,.41145),new B(.95353699,.23232999,.191806),new B(.497311,.77080297,.398177),new B(.194066,.95631999,.218611),new B(.422876,.882276,.206797),new B(-.373797,.84956598,.37217399),new B(-.53449702,.71402299,.4522),new B(-.881827,.23716,.40759799),new B(-.904948,-.014069,.42528901),new B(-.751827,-.51281703,.41445801),new B(-.50101501,-.69791698,.51175803),new B(-.23519,-.92592299,.295555),new B(.228983,-.95393997,.193819),new B(.734025,-.63489801,.241062),new B(.91375297,-.063253,-.40131599),new B(.90573502,-.161487,.391875),new B(.85892999,.342446,.38074899),new B(.62448603,.60758102,.49077699),new B(.28926399,.85747898,.42550799),new B(.069968,.90216899,.42567101),new B(-.28617999,.94069999,.182165),new B(-.57401299,.80511898,-.14930899),new B(.111258,.099717997,-.98877603),new B(-.30539301,-.94422799,-.12316),new B(-.60116601,-.78957599,.123163),new B(-.290645,-.81213999,.50591898),new B(-.064920001,-.87716299,.47578499),new B(.408301,-.862216,.29978901),new B(.56609702,-.72556603,.39126399),new B(.83936399,-.427387,.33586901),new B(.81889999,-.041305002,.57244802),new B(.71978402,.41499701,.55649698),new B(.88174403,.45027,.140659),new B(.40182301,-.89822,-.17815199),new B(-.054019999,.79134399,.60898),new B(-.29377401,.76399398,.57446498),new B(-.450798,.61034697,.65135098),new B(-.63822103,.186694,.74687302),new B(-.87287003,-.25712699,.41470799),new B(-.58725703,-.52170998,.618828),new B(-.35365799,-.64197397,.680291),new B(.041648999,-.61127299,.79032302),new B(.348342,-.77918297,.52108699),new B(.499167,-.62244099,.602826),new B(.79001898,-.30383101,.53250003),new B(.66011798,.060733002,.74870199),new B(.60492098,.29416099,.73996001),new B(.38569701,.37934601,.84103203),new B(.239693,.207876,.94833201),new B(.012623,.25853199,.96591997),new B(-.100557,.457147,.88368797),new B(.046967,.62858802,.77631903),new B(-.43039101,-.44540501,.785097),new B(-.43429101,-.196228,.87913901),new B(-.25663701,-.336867,.90590203),new B(-.131372,-.15891001,.97851402),new B(.102379,-.208767,.972592),new B(.195687,-.450129,.87125802),new B(.62731898,-.42314801,.65377098),new B(.68743902,-.171583,.70568198),new B(.27592,-.021255,.96094602),new B(.45936701,.15746599,.87417799),new B(.285395,.583184,.76055598),new B(-.81217402,.46030301,.35846099),new B(-.189068,.64122301,.743698),new B(-.338875,.47648001,.811252),new B(-.92099398,.347186,.176727),new B(.040638998,.024465,.99887401),new B(-.73913199,-.35374701,.57318997),new B(-.60351199,-.28661501,.74405998),new B(-.188676,-.547059,.81555402),new B(-.026045,-.39782,.91709399),new B(.26789701,-.649041,.71202302),new B(.518246,-.28489101,.80638599),new B(.493451,-.066532999,.86722499),new B(-.328188,.140251,.93414301),new B(.328188,.140251,.93414301),new B(-.328188,.140251,.93414301),new B(-.328188,.140251,.93414301),new B(-.328188,.140251,.93414301)])}}}),System.register("data/zip/Zip",["data/Crc32","data/zip/ZipUtils"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("Zip",class{constructor(S=!1){this.zip64=S,console.info("Started zip with zip64: "+this.zip64),this.fileRecord=[],this.finished=!1,this.byteCounterBig=BigInt(0),this.outputStream=new ReadableStream({start:S=>{console.info("OutputStream has started!"),this.outputController=S},cancel:()=>{console.info("OutputStream has been canceled!")}})}enqueue(S){this.outputController.enqueue(S)}close(){this.outputController.close()}getZip64ExtraField(S,O){return N.ZipUtils.createByteArray([{data:1,size:2},{data:28,size:2},{data:S,size:8},{data:S,size:8},{data:O,size:8},{data:0,size:4}])}isWritingFile(){return 0<this.fileRecord.length&&!1===this.fileRecord[this.fileRecord.length-1].done}startFile(S,O){if(this.isWritingFile()||this.finished)throw new Error("Tried adding file while adding other file or while zip has finished");console.info("Start file: "+S);var j=new Date(O);this.fileRecord=[...this.fileRecord,{name:S,sizeBig:BigInt(0),crc:new B.Crc32,done:!1,date:j,headerOffsetBig:this.byteCounterBig}];var L=(new TextEncoder).encode(S);L=N.ZipUtils.createByteArray([{data:67324752,size:4},{data:45,size:2},{data:2056,size:2},{data:0,size:2},{data:N.ZipUtils.getTimeStruct(j),size:2},{data:N.ZipUtils.getDateStruct(j),size:2},{data:0,size:4},{data:this.zip64?4294967295:0,size:4},{data:this.zip64?4294967295:0,size:4},{data:L.length,size:2},{data:this.zip64?32:0,size:2},{data:L},{data:this.zip64?this.getZip64ExtraField(BigInt(0),this.byteCounterBig):[]}]),this.enqueue(L),this.byteCounterBig+=BigInt(L.length)}appendData(S){if(!this.isWritingFile()||this.finished)throw new Error("Tried to append file data, but there is no open file!");this.enqueue(S),this.byteCounterBig+=BigInt(S.length),this.fileRecord[this.fileRecord.length-1].crc.append(S),this.fileRecord[this.fileRecord.length-1].sizeBig+=BigInt(S.length)}endFile(){if(!this.isWritingFile()||this.finished)throw new Error("Tried to end file, but there is no open file!");{const O=this.fileRecord[this.fileRecord.length-1];console.info("End file: "+O.name);var S=N.ZipUtils.createByteArray([{data:O.crc.get(),size:4},{data:O.sizeBig,size:this.zip64?8:4},{data:O.sizeBig,size:this.zip64?8:4}]);this.enqueue(S),this.byteCounterBig+=BigInt(S.length),this.fileRecord[this.fileRecord.length-1].done=!0}}finish(){if(this.isWritingFile()||this.finished)throw new Error("Empty zip, or there is still a file open");{console.info("Finishing zip");let j=BigInt(0);var S,O,B=this.byteCounterBig;this.fileRecord.forEach(S=>{const{date:O,crc:B,sizeBig:L,name:D,headerOffsetBig:F}=S;var _=(new TextEncoder).encode(D);_=N.ZipUtils.createByteArray([{data:33639248,size:4},{data:45,size:2},{data:45,size:2},{data:2056,size:2},{data:0,size:2},{data:N.ZipUtils.getTimeStruct(O),size:2},{data:N.ZipUtils.getDateStruct(O),size:2},{data:B.get(),size:4},{data:this.zip64?4294967295:L,size:4},{data:this.zip64?4294967295:L,size:4},{data:_.length,size:2},{data:this.zip64?32:0,size:2},{data:0,size:2},{data:0,size:2},{data:0,size:2},{data:0,size:4},{data:this.zip64?4294967295:F,size:4},{data:_},{data:this.zip64?this.getZip64ExtraField(L,F):[]}]),this.enqueue(_),this.byteCounterBig+=BigInt(_.length),j+=BigInt(_.length)}),this.zip64&&(O=this.byteCounterBig,S=N.ZipUtils.createByteArray([{data:101075792,size:4},{data:44,size:8},{data:45,size:2},{data:45,size:2},{data:0,size:4},{data:0,size:4},{data:this.fileRecord.length,size:8},{data:this.fileRecord.length,size:8},{data:j,size:8},{data:B,size:8}]),this.enqueue(S),this.byteCounterBig+=BigInt(S.length),O=N.ZipUtils.createByteArray([{data:117853008,size:4},{data:0,size:4},{data:O,size:8},{data:1,size:4}]),this.enqueue(O),this.byteCounterBig+=BigInt(O.length)),B=N.ZipUtils.createByteArray([{data:101010256,size:4},{data:0,size:2},{data:0,size:2},{data:this.zip64?65535:this.fileRecord.length,size:2},{data:this.zip64?65535:this.fileRecord.length,size:2},{data:this.zip64?4294967295:j,size:4},{data:this.zip64?4294967295:B,size:4},{data:0,size:2}]),this.enqueue(B),this.close(),this.byteCounterBig+=BigInt(B.length),this.finished=!0,console.info(`Done writing zip file. Wrote ${this.fileRecord.length} files and a total of ${this.byteCounterBig} bytes.`)}}})}}}),System.register("data/zip/ZipUtils",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("ZipUtils",class{static createByteArray(S){var O=S.reduce((S,O)=>S+(O.size||O.data.length),0);const B=new Uint8Array(O),N=new DataView(B.buffer);let j=0;return S.forEach(S=>{if(void 0!==S.data.length)B.set(S.data,j),j+=S.data.length;else{switch(S.size){case 1:N.setInt8(j,parseInt(S.data));break;case 2:N.setInt16(j,parseInt(S.data),!0);break;case 4:N.setInt32(j,parseInt(S.data),!0);break;case 8:N.setBigInt64(j,BigInt(S.data),!0);break;default:throw new Error("createByteArray: No handler defined for data size "+S.size+" of entry data "+JSON.stringify(S.data))}j+=S.size}}),B}static getTimeStruct(S){return(S.getHours()<<6|S.getMinutes())<<5|S.getSeconds()/2}static getDateStruct(S){return(S.getFullYear()-1980<<4|S.getMonth()+1)<<5|S.getDate()}})}}}),System.register("engine/AnimProps",["game/GameSpeed","util/math"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("AnimProps",j=class e{constructor(S,O){this.art=S,this.init(O)}init(S){this.shadow=this.art.getBool("Shadow"),this.reverse=this.art.getBool("Reverse"),this.frameCount="number"==typeof S?S:this.shadow?S.numImages/2:S.numImages,this.end=this.art.getNumber("End",this.frameCount-1);var O=this.art.getNumberArray("RandomRate").sort();2===O.length?this.rate=N.getRandomInt(O[0],O[1])/60:this.rate=this.art.getNumber("Rate",60*e.defaultRate)/60,this.start=this.art.getNumber("Start",0),this.loopStart=this.art.getNumber("LoopStart",0),this.loopEnd=Math.max(this.loopStart,this.art.getNumber("LoopEnd",this.end+1)-1),this.loopCount=this.art.getNumber("LoopCount",1),O=this.art.getNumberArray("RandomLoopDelay").sort(),this.randomLoopDelay=2===O.length?[O[0],O[1]]:void 0}getArt(){return this.art}setArt(S){this.art=S,this.init(this.frameCount)}}),j.defaultRate=B.GameSpeed.BASE_TICKS_PER_SECOND}}}),System.register("engine/Animation",["util/math"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){var O;(O=N||S("AnimationState",N={}))[O.NOT_STARTED=0]="NOT_STARTED",O[O.RUNNING=1]="RUNNING",O[O.STOPPED=2]="STOPPED",O[O.DELAYED=3]="DELAYED",O[O.PAUSED=4]="PAUSED",S("Animation",class{constructor(S,O){this.props=S,this.state=N.NOT_STARTED,this.endLoopFlag=!1,this.playToEndFlag=!1,this.speed=O}getState(){return this.state}start(S,O=0){this.time=S,this.frameNo=this.props.reverse?this.props.end:this.props.start,this.loopNo=0,this.delayFrames=O,this.state=O?N.DELAYED:N.RUNNING}pause(){this.state===N.RUNNING&&(this.state=N.PAUSED)}unpause(){this.state===N.PAUSED&&(this.state=N.RUNNING)}reset(){this.state=N.NOT_STARTED}stop(){this.state=N.STOPPED}update(S){var O=(S-this.time)/1e3,B=this.props.rate*this.speed.value;if(!((B=Math.floor(O*B))<1)&&(this.time=S,this.state!==N.PAUSED)){if(0<this.delayFrames){if(this.delayFrames=Math.max(0,this.delayFrames-B),0<this.delayFrames)return void(this.state=N.DELAYED);this.state=N.RUNNING}this.computeNextFrame(B)&&(this.state=N.STOPPED)}}endLoop(){this.endLoopFlag=!0}endLoopAndPlayToEnd(){this.endLoopFlag=!0,this.playToEndFlag=!0}rewind(){this.props.reverse?this.frameNo=this.loopNo?this.props.loopEnd:this.props.end:this.frameNo=this.loopNo?this.props.loopStart:this.props.start}getCurrentFrame(){return this.frameNo}computeNextFrame(S){let O=this.frameNo;for(;0<S;){var j=this.endLoopFlag&&this.playToEndFlag?this.props.reverse?this.props.start:this.props.end:this.props.reverse?this.props.loopStart:this.props.loopEnd;if(!this.props.reverse&&O+S<=j||this.props.reverse&&O-S>=j){O+=this.props.reverse?-S:S;break}if(-1!==this.props.loopCount&&this.loopNo>=this.props.loopCount-1)return this.frameNo=j,!0;if(this.endLoopFlag)return!(this.endLoopFlag=!1);S-=1+(this.props.reverse?O-j:j-O),O=this.props.reverse?this.props.loopEnd:this.props.loopStart,this.loopNo++,this.props.randomLoopDelay&&(this.state=N.DELAYED,this.delayFrames=B.getRandomInt(this.props.randomLoopDelay[0],this.props.randomLoopDelay[1]))}return this.frameNo=O,!1}})}}}),System.register("engine/AsyncResourceCollection",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("engine/Engine",["data/IniFile","data/ShpFile","data/VxlFile","data/TmpFile","data/Palette","engine/Theater","engine/TheaterType","version","data/vfs/VirtualFileSystem","data/vfs/RealFileSystem","engine/LazyResourceCollection","data/WavFile","engine/LazyAsyncResourceCollection","data/Mp3File","engine/mixDatabase","engine/gameRes/GameResSource","data/Crc32","game/ini/GameModes","util/string","engine/MapList","data/HvaFile","game/ini/MixinRulesType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se;return O&&O.id,{setters:[function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S}],execute:function(){var O;(O=re||S("EngineType",re={}))[O.AutoDetect=0]="AutoDetect",O[O.TiberianSun=1]="TiberianSun",O[O.Firestorm=2]="Firestorm",O[O.RedAlert2=3]="RedAlert2",O[O.YurisRevenge=4]="YurisRevenge",S("Engine",se=class{static getVersion(){return H.version.split(".").slice(0,2).join(".")}static getModHash(){if(!this.modHash)throw new Error("Rules must be loaded first");return this.modHash}static getActiveMod(){return this.activeMod}static setActiveMod(S){this.activeMod=S}static initGameResSource(S){this.gameResSource=S}static async initRfs(S){let O=this.rfs=new W.RealFileSystem;return O.addRootDirectoryHandle(S),O}static async initVfs(S,O){return this.vfs=new V.VirtualFileSystem(S,O),B.iniFiles.setVfs(this.vfs),B.palettes.setVfs(this.vfs),B.images.setVfs(this.vfs),B.voxels.setVfs(this.vfs),B.voxelAnims.setVfs(this.vfs),B.tileData.setVfs(this.vfs),B.sounds.setVfs(this.vfs),B.themes.setDir(await(this.rfs?.findDirectory(B.rfsSettings.musicDir))),B.taunts.setDir(await(this.rfs?.findDirectory(B.rfsSettings.tauntsDir))),this.vfs}static supportsTheater(S){var O=this.getActiveEngine();return this.theaterSettings.get(O)?.some(O=>O.type===S)||!1}static getTheaterSettings(S,O){if(!this.theaterSettings.has(S))throw new Error('Unknown engineType "'+S);var B=this.theaterSettings.get(S).find(S=>S.type===O);if(!B)throw new Error(`Unsupported theater "${U.TheaterType[O]}"`);return B}static async loadTheater(S){if(!B.rules||!B.art)throw new Error("Rules and art should be loaded first");if(void 0===B.gameResSource)throw new Error("No gameResSource is set");var O=B.getActiveEngine();let N;var j,L=B.getTheaterSettings(O,S);if(B.gameResSource!==Z.GameResSource.Cdn)for(var D of L.mixes)await B.vfs.addMixFile(D);return B.theaters.has(S)?N=B.theaters.get(S):(j=B.getTheaterIni(O,S),O=B.getTileData(),N=_.Theater.factory(S,j,L,O,B.palettes),B.theaters.set(S,N)),B.activeTheater=N,N}static unloadTheater(S){if(B.vfs){var O,N=B.getActiveEngine();for(O of B.getTheaterSettings(N,S).mixes)B.vfs.removeArchive(O)}}static unloadSideMixData(){for(var S of["sidec01.mix","sidec01cd.mix"]){var O,N=Q.mixDatabase.get(S);if(!N)return void console.warn(`Mix "${S}" not found in mix database`);for(O of N)("pal"===O.split(".").pop()?B.palettes:B.images).clear(O)}}static getTheaterIni(S,O){var N=B.getTheaterSettings(S,O).theaterIni;return B.getIni(N)}static loadRules(){var S=this.getFileNameVariant("rules.ini"),O=this.getFileNameVariant("art.ini"),N=this.getFileNameVariant("ai.ini");let j=this.iniFiles.get(S),L=this.iniFiles.get(O);var D=this.iniFiles.get(N);if(!j)throw new Error(`Rules "${S}" not found`);if(!L)throw new Error(`Art "${O}" not found`);if(!D)throw new Error(`AI "${N}" not found`);if(O=this.iniFiles.get(B.customRulesFileName),N=this.iniFiles.get(B.customArtFileName),!O)throw new Error(`Rules "${B.customRulesFileName}" not found`);if(!N)throw new Error(`Art "${B.customArtFileName}" not found`);B.art=L.clone().mergeWith(N),B.rules=j.clone().mergeWith(O),B.ai=D,B.modHash=B.computeModHash()}static computeModHash(){if(!this.vfs)throw new Error("VFS not initialized");let S=[this.customRulesFileName,this.customArtFileName,this.customMpModesFileName,this.shroudFileName,this.getFileNameVariant("rules.ini"),this.getFileNameVariant("art.ini"),this.getFileNameVariant("ai.ini"),...B.mixinRulesFileNames.values()];var O,N,j,L=this.theaterSettings.get(this.getActiveEngine());if(!L)throw new Error('Unsupported engineType "'+this.getActiveEngine());for(O of L)S.push(this.getFileNameVariant(O.theaterIni));let D=this.getMpModes();for(N of D.getAll())S.push(N.rulesOverride);let F=new Y.Crc32;for(j of S){if(!this.vfs.fileExists(j))throw new Error(`File ${j} not found`);var _=this.vfs.openFile(j).stream;F.append(new Uint8Array(_.buffer,_.byteOffset,_.byteLength))}return F.append(J.binaryStringToUint8Array(this.getVersion())),F.get()}static getRules(){if(!B.rules)throw new Error("Rules must be loaded first");return B.rules}static getArt(){if(!B.art)throw new Error("Art must be loaded first");return B.art}static getAi(){if(!B.ai)throw new Error("AI must be loaded first");return B.ai}static getFileNameVariant(S){var O=this.getActiveEngine();let B;if(O===re.YurisRevenge)B="md";else{if(O!==re.RedAlert2)throw new Error("Unsupported engine type "+re[O]);B=""}return B?S.replace(/\.([^.]+)$/,B+".$1"):S}static getMpModes(){return new X.GameModes(this.getIni(this.customMpModesFileName),S=>this.getIni(S))}static getUiIni(){var S=this.getFileNameVariant("ui.ini");return this.getIni(S)}static getIni(S){if(!this.iniFiles.has(S))throw new Error(`INI file ${S} not found.`);return this.iniFiles.get(S)}static async loadMapList(){if(!this.vfs)throw new Error("File system not initialized");var S,O,B,j=this.getMpModes();let L=new ee.MapList(j);for(S of(L.addFromIni(this.getIni(this.getFileNameVariant("missions.pkt"))),this.vfs.listArchives())){var D=S.toLowerCase().replace(/\.[^.]+$/,"")+".pkt";this.vfs.fileExists(D)&&L.addFromIni(new N.IniFile(this.vfs.openFile(D)))}let F=new ee.MapList(j);if(this.rfs)for await(var _ of this.rfs.getEntries()){let j=_.toLowerCase();try{j.endsWith(".pkt")?(O=new N.IniFile(await this.rfs.openFile(_,!0)),L.addFromIni(O)):this.supportedMapTypes.some(S=>j.endsWith("."+S))&&(B=await this.rfs.openFile(_,!0),F.addFromMapFile(B))}catch(S){console.warn(`Couldn't read file "${_}"`,S)}}return F.sortByName(),L.mergeWith(F),this.mapList=L,L}static getTileData(){return B.tileData}static getImages(){return B.images}static getVoxels(){return B.voxels}static getVoxelAnims(){return B.voxelAnims}static getPalettes(){return B.palettes}static getSounds(){return B.sounds}static getThemes(){return B.themes}static getTaunts(){return B.taunts}static getActiveEngine(){return re.RedAlert2}static getLastTheaterType(){return B.activeTheater?.type}static getCacheDir(){try{return this.getOrCreateDir(this.rfsSettings.cacheDir,!0)}catch(S){return void console.error("Couldn't get cache directory",[S])}}static async getReplayDir(){var S=this.getActiveMod();if(S){let O=await this.getModDir(),N=await(O?.getDirectory(S));return N?.getOrCreateDirectory(B.rfsSettings.replayDir)}return this.getOrCreateDir(this.rfsSettings.replayDir)}static getModDir(){return this.getOrCreateDir(B.rfsSettings.modDir)}static getMapDir(){return this.getOrCreateDir(B.rfsSettings.mapDir)}static getCustomAiDir(){return this.getOrCreateDir(B.rfsSettings.customAiDir)}static async getOrCreateDir(S,O=!1){let B=this.rfs?.getRootDirectory();if(B)return await B.getOrCreateDirectory(S,O)}static getMapList(){return this.mapList}static destroy(){this.activeTheater=void 0,this.activeMod=void 0,this.modHash=void 0,this.mapList=void 0,this.rfs=void 0,this.vfs=void 0,this.art=void 0,this.iniFiles.clear(),this.images.clear(),this.palettes.clear(),this.rules=void 0,this.ai=void 0,this.theaters.clear(),this.tileData.clear(),this.voxels.clear(),this.voxelAnims.clear()}}),(B=se).UI_ANIM_SPEED=2,se.rfsSettings={menuVideoFileName:"ra2ts_l.webm",splashImgFileName:"glsl.png",mapDir:"maps",modDir:"mods",musicDir:"music",tauntsDir:"Taunts",cacheDir:"cache",replayDir:"replays",customAiDir:"custom_ai"},se.supportedMapTypes=["mpr","map"],se.images=new z.LazyResourceCollection(S=>new j.ShpFile(S)),se.voxels=new z.LazyResourceCollection(S=>new L.VxlFile(S)),se.voxelAnims=new z.LazyResourceCollection(S=>new te.HvaFile(S)),se.sounds=new z.LazyResourceCollection(S=>new K.WavFile(S)),se.themes=new $.LazyAsyncResourceCollection(S=>new q.Mp3File(S),!1),se.taunts=new $.LazyAsyncResourceCollection(async S=>new K.WavFile(new Uint8Array(await S.arrayBuffer()))),se.iniFiles=new z.LazyResourceCollection(S=>new N.IniFile(S)),se.tileData=new z.LazyResourceCollection(S=>new D.TmpFile(S)),se.palettes=new z.LazyResourceCollection(S=>new F.Palette(S)),se.theaters=new Map,se.theaterSettings=(new Map).set(re.RedAlert2,[{type:U.TheaterType.Temperate,theaterIni:"temperat.ini",mixes:["isotemp.mix","temperat.mix","tem.mix"],extension:".tem",newTheaterChar:"T",isoPaletteName:"isotem.pal",unitPaletteName:"unittem.pal",overlayPaletteName:"temperat.pal",libPaletteName:"libtem.pal"},{type:U.TheaterType.Snow,theaterIni:"snow.ini",mixes:["isosnow.mix","snow.mix","sno.mix"],extension:".sno",newTheaterChar:"A",isoPaletteName:"isosno.pal",unitPaletteName:"unitsno.pal",overlayPaletteName:"snow.pal",libPaletteName:"libsno.pal"},{type:U.TheaterType.Urban,theaterIni:"urban.ini",mixes:["isourb.mix","urb.mix","urban.mix"],extension:".urb",newTheaterChar:"U",isoPaletteName:"isourb.pal",unitPaletteName:"uniturb.pal",overlayPaletteName:"urban.pal",libPaletteName:"liburb.pal"}]).set(re.YurisRevenge,[{type:U.TheaterType.Temperate,theaterIni:"temperatmd.ini",mixes:["isotemp.mix","isotemmd.mix","temperat.mix","tem.mix"],extension:".tem",newTheaterChar:"T",isoPaletteName:"isotem.pal",unitPaletteName:"unittem.pal",overlayPaletteName:"temperat.pal",libPaletteName:"libtem.pal"},{type:U.TheaterType.Snow,theaterIni:"snowmd.ini",mixes:["isosnomd.mix","snowmd.mix","isosnow.mix","snow.mix","sno.mix"],extension:".sno",newTheaterChar:"A",isoPaletteName:"isosno.pal",unitPaletteName:"unitsno.pal",overlayPaletteName:"snow.pal",libPaletteName:"libsno.pal"},{type:U.TheaterType.Urban,theaterIni:"urbanmd.ini",mixes:["isourbmd.mix","isourb.mix","urb.mix","urban.mix"],extension:".urb",newTheaterChar:"U",isoPaletteName:"isourb.pal",unitPaletteName:"uniturb.pal",overlayPaletteName:"urban.pal",libPaletteName:"liburb.pal"},{type:U.TheaterType.NewUrban,theaterIni:"urbannmd.ini",mixes:["isoubnmd.mix","isoubn.mix","ubn.mix","urbann.mix"],extension:".ubn",newTheaterChar:"N",isoPaletteName:"isoubn.pal",unitPaletteName:"unitubn.pal",overlayPaletteName:"urbann.pal",libPaletteName:"libubn.pal"},{type:U.TheaterType.Desert,theaterIni:"desertmd.ini",mixes:["isodesmd.mix","desert.mix","des.mix","isodes.mix"],extension:".des",newTheaterChar:"D",isoPaletteName:"isodes.pal",unitPaletteName:"unitdes.pal",overlayPaletteName:"desert.pal",libPaletteName:"libdes.pal"},{type:U.TheaterType.Lunar,theaterIni:"lunarmd.ini",mixes:["isolunmd.mix","isolun.mix","lun.mix","lunar.mix"],extension:".lun",newTheaterChar:"L",isoPaletteName:"isolun.pal",unitPaletteName:"unitlun.pal",overlayPaletteName:"lunar.pal",libPaletteName:"liblun.pal"}]),se.customRulesFileName="rulescd.ini",se.customArtFileName="artcd.ini",se.customMpModesFileName="mpmodescd.ini",se.shroudFileName="shroud.shp",se.mixinRulesFileNames=(new Map).set(ie.MixinRulesType.NoDogEngiKills,"nodogengikills.ini")}}}),System.register("engine/GameAnimationLoop",["network/IrcConnection"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("GameAnimationLoop",class{constructor(S,O,N,j,L={}){this.localPlayer=S,this.renderer=O,this.sound=N,this.gameTurnMgr=j,this.options=L,this.isStarted=!1,this.rendererErrorState=!1,this.doBackgroundFrame=S=>{if(this.isStarted&&this.paused){let O=this.updateDeltaGameFrames(S);for(this.turnMgrIsWaiting&&(O=1);0<O;)this.turnMgrIsWaiting=!1===this.tickGame(S),O--}},this.doFrame=S=>{if(this.isStarted&&!this.paused){let N=this.updateDeltaGameFrames(S);(this.turnMgrIsWaiting||!this.options.skipFrames&&1<N)&&(N=1);let j=this.renderer.getStats();if(j&&j.begin(),this.options.skipBudgetMillis){let B=this.options.skipBudgetMillis;for(;0<N;){var O=performance.now();if(this.turnMgrIsWaiting=!1===this.tickGame(S),N--,O=performance.now()-O,B=Math.max(0,B-O),B<=0)break}}else for(;0<N;)this.turnMgrIsWaiting=!1===this.tickGame(S),N--;var B=this.gameTurnMgr.getTurnMillis();B=Math.max(0,(S-(this.startTime+this.lastGameFrame*B))/B),this.updateRenderer(S,B),this.render()&&(j&&j.end(),this.rafId=requestAnimationFrame(this.doFrame))}},this.handleVisibilityChange=()=>{var S=document.hidden;if(this.paused!==S){if(this.localPlayer&&!this.localPlayer.isObserver&&this.paused&&this.doBackgroundFrame(performance.now()),(this.paused=S)||(this.startTime=void 0,this.lastGameFrame=0),this.localPlayer&&!this.localPlayer.isObserver)try{this.gameTurnMgr.setPassiveMode?.(this.paused)}catch(S){if(!(S instanceof B.IrcConnection.SocketError))throw S}this.paused?(this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId=setInterval(()=>{var S=performance.now();this.doBackgroundFrame(S)},1e3)):(this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),this.rafId=requestAnimationFrame(this.doFrame)),this.sound.audioSystem.setMuted(this.paused)}}}start(){this.isStarted||(this.isStarted=!0,this.paused=!1,this.startTime=void 0,this.lastGameFrame=0,document.hidden?this.handleVisibilityChange():this.rafId=requestAnimationFrame(this.doFrame),document.addEventListener("visibilitychange",this.handleVisibilityChange))}updateDeltaGameFrames(S){var O=this.gameTurnMgr.getTurnMillis(),B=O!==this.lastGameTurnMillis;this.lastGameTurnMillis=O,B&&(this.lastGameFrame=0,this.startTime=S);let N=0;return this.startTime?(B=S-this.startTime,N=(O=Math.round(B/O))-this.lastGameFrame,this.lastGameFrame=O):this.startTime=S,N}tickGame(S){if(!this.options.onError)return this.gameTurnMgr.doGameTurn(S);try{return this.gameTurnMgr.doGameTurn(S)}catch(S){return this.gameTurnMgr.setErrorState(),void this.options.onError(S)}}updateRenderer(S,O){if(this.options.onError){if(!this.rendererErrorState)try{this.renderer.update(S,O)}catch(S){return this.gameTurnMgr.setErrorState(),this.rendererErrorState=!0,void this.options.onError(S)}}else this.renderer.update(S,O)}render(){if(this.options.onError)try{this.renderer.render()}catch(S){return this.gameTurnMgr.setErrorState(),this.rendererErrorState=!0,this.options.onError(S,!0),!1}else this.renderer.render();return!0}stop(){this.isStarted&&(this.isStarted=!1,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),document.removeEventListener("visibilitychange",this.handleVisibilityChange))}destroy(){this.stop(),this.renderer.flush()}})}}}),System.register("engine/ImageFinder",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){S("ImageFinder",B=class e{constructor(S,O){this.images=S,this.theater=O}findByObjectArt(S){return this.find(S.imageName,S.useTheaterExtension)}find(S,O){var B=this.getFilename(S,O),N=this.images.get(B);if(!N)throw new e.MissingImageError(`No image file found for artName="${S}" (file=${B})`);return N}tryFind(S,O){let B;try{B=this.find(S,O)}catch(S){if(!(S instanceof e.MissingImageError))throw S}return B}getFilename(S,O){let B=S.toLowerCase();return B+=O?this.theater.settings.extension:".shp",B=this.applyNewTheaterIfNeeded(S,B),B}applyNewTheaterIfNeeded(S,O){return-1===["G","N","C","Y"].indexOf(S[0])||-1===["A","T","U","D","L","N"].indexOf(S[1])?O:this.applyNewTheater(O)}applyNewTheater(S){let O;var B=S[0],N=S.substr(2);return O=B+this.theater.settings.newTheaterChar.toLowerCase()+N,this.images.has(O)||(O=B+"g"+N,this.images.has(O)||(O=S)),O}}),function(S){class t extends Error{}S.MissingImageError=t}(B||S("ImageFinder",B={}))}}}),System.register("engine/IsoCoords",["game/Coords"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("IsoCoords",class e{static init(S){e.worldOrigin=S}static worldToScreen(S,O){if(!e.worldOrigin)throw new Error("Coords not initialized with world origin");return S-=e.worldOrigin.x,O-=e.worldOrigin.y,{x:(S/=B.Coords.ISO_WORLD_SCALE)-(O/=B.Coords.ISO_WORLD_SCALE),y:(S+O)/2}}static screenToWorld(S,O){if(!e.worldOrigin)throw new Error("Coords not initialized with world origin");return{x:(S+2*O)/2*B.Coords.ISO_WORLD_SCALE+e.worldOrigin.x,y:(2*O-S)/2*B.Coords.ISO_WORLD_SCALE+e.worldOrigin.y}}static vecWorldToScreen(S){let O=e.worldToScreen(S.x,S.z);return O.y-=e.tileHeightToScreen(B.Coords.worldToTileHeight(S.y)),O}static tileToScreen(S,O){var N=B.Coords.tileToWorld(S,O);return e.worldToScreen(N.x,N.y)}static tileHeightToScreen(S){return S*(B.Coords.ISO_TILE_SIZE/2)}static tile3dToScreen(S,O,B){let N=e.tileToScreen(S,O);return N.y-=e.tileHeightToScreen(B),N}static screenTileToScreen(S,O){return{x:S*B.Coords.ISO_TILE_SIZE,y:O*B.Coords.ISO_TILE_SIZE/2}}static screenToScreenTile(S,O){return{x:S/B.Coords.ISO_TILE_SIZE,y:O/(B.Coords.ISO_TILE_SIZE/2)}}static screenTileToWorld(S,O){var B=e.screenTileToScreen(S,O);return e.screenToWorld(B.x,B.y)}static getScreenTileSize(){return{width:e.tileToScreen(1,0).x-e.tileToScreen(0,1).x,height:e.tileToScreen(1,1).y-e.tileToScreen(0,0).y}}static screenDistanceToWorld(S,O){return B.Coords.screenDistanceToWorld(S,O)}})}}}),System.register("engine/LazyAsyncResourceCollection",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("LazyAsyncResourceCollection",class{constructor(S,O=!0){this.resourceFactory=S,this.cache=O,this.resources=new Map}setDir(S){this.rfsDir=S}set(S,O){this.resources.set(S,O)}async has(S){return!!this.resources.has(S)||(await(this.rfsDir?.containsEntry(S))??!1)}async get(S){let O;return O=this.resources.get(S),!O&&await(this.rfsDir?.containsEntry(S))&&(O=await this.resourceFactory(await this.rfsDir.getRawFile(S)),this.cache&&this.resources.set(S,O)),O}clear(){this.resources.clear()}})}}}),System.register("engine/LazyResourceCollection",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("LazyResourceCollection",class{constructor(S){this.resourceFactory=S,this.resources=new Map}setVfs(S){this.vfs=S}set(S,O){this.resources.set(S,O)}has(S){return!!this.resources.has(S)||(this.vfs?.fileExists(S)??!1)}get(S){let O;return O=this.resources.get(S),!O&&this.vfs?.fileExists(S)&&(O=this.resourceFactory(this.vfs.openFile(S)),this.resources.set(S,O)),O}clear(S){S?this.resources.delete(S):this.resources.clear()}})}}}),System.register("engine/Lighting",["engine/type/LightingType","data/map/MapLighting","util/event","util/disposable/CompositeDisposable"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=new THREE.Vector3,S("Lighting",class{get onChange(){return this._onChange.asEvent()}get mapLighting(){return this.ambientOverride??this.baseAmbient}constructor(S){if(this.baseAmbient=new N.MapLighting,this.tileLights=new Map,this.disposables=new L.CompositeDisposable,this._onChange=new j.EventDispatcher,S){this.baseAmbient.copy(S.getAmbient());let t=S=>{this.baseAmbient.copy(S),this._onChange.dispatch(this,void 0)};S.onChange.subscribe(t),this.disposables.add(()=>S.onChange.unsubscribe(t))}}forceUpdate(S){this._onChange.dispatch(this,S)}applyAmbientOverride(S){this.ambientOverride=S,this._onChange.dispatch(this,void 0)}getBaseAmbient(){return(new N.MapLighting).copy(this.baseAmbient)}addTileLight(S,O){this.tileLights.has(S)||this.tileLights.set(S,new Set),this.tileLights.get(S).add(O)}removeTileLight(S,O){let B=this.tileLights.get(S);B&&(B.delete(O),B.size||this.tileLights.delete(S))}compute(S,O,N=0){return S===B.LightingType.None?new THREE.Vector3(1,1,1):this.computeTint(S).add(this.computeTileTint(O,S,D)).multiplyScalar(this.mapLighting.ambient+this.mapLighting.ground+this.computeLevel(S,O.z+N)+this.computeTileLightIntensity(O))}computeNoAmbient(S,O,B=0){return this.computeLevel(S,O.z+B)+this.computeTileLightIntensity(O)}computeLevel(S,O){return S>=B.LightingType.Level?this.mapLighting.level*(O-1):0}computeTint(S){let O=1,N=1,j=1;return(S>=B.LightingType.Full||this.mapLighting.forceTint)&&(O=this.mapLighting.red,N=this.mapLighting.green,j=this.mapLighting.blue),new THREE.Vector3(O,N,j)}computeTileTint(S,O,N=new THREE.Vector3){let j=0,L=0,D=0;if(O>=B.LightingType.Full){var F=this.tileLights.get(S);if(F?.size)for(var _ of F)j+=_.red,L+=_.green,D+=_.blue}return N.set(j,L,D)}computeTileLightIntensity(S){let O=0;var B=this.tileLights.get(S);if(B?.size)for(var N of B)O+=N.intensity;return O}getAmbientIntensity(){return this.mapLighting.ambient+this.mapLighting.ground}dispose(){this.disposables.dispose()}})}}}),System.register("engine/MapDigest",["data/Crc32"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("MapDigest",class{static compute(S){return B.Crc32.calculateCrc(S.getBytes()).toString(16)}})}}}),System.register("engine/MapList",["engine/MapManifest"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("MapList",class e{constructor(S){this.gameModes=S,this.manifests=[]}addFromIni(S){let O=S.getSection("MultiMaps");if(!O)throw new Error("Invalid map list. Missing [MultiMaps] section.");return this.manifests=this.manifests.concat([...O.entries.values()].map(O=>{var N=S.getSection(O);if(!N)throw new Error(`Invalid map list. Missing [${O}] section.`);return(new B.MapManifest).fromIni(N,this.gameModes.getAll())})),this.dedupeEntries(),this}add(S){this.manifests.push(S)}addFromMapFile(S){this.add((new B.MapManifest).fromMapFile(S,this.gameModes.getAll()))}getAll(){return this.manifests}getByName(S){return this.manifests.find(O=>O.fileName.toLowerCase()===S.toLowerCase())}sortByName(){this.manifests.sort((S,O)=>S.fileName.localeCompare(O.fileName))}clone(){let S=new e(this.gameModes);return S.manifests=[...this.manifests],S}mergeWith(S){return this.manifests.push(...S.manifests),this.dedupeEntries(),this}dedupeEntries(){this.manifests=[...new Map(this.manifests.map(S=>[S.fileName.toLowerCase(),S])).values()]}})}}}),System.register("engine/MapManifest",["data/IniFile"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("MapManifest",class{fromIni(S,O){return this.fileName=S.getString("File")||S.name.toLowerCase()+".map",this.uiName=S.getString("Description"),this.maxSlots=S.getNumber("MaxPlayers"),this.official=!0,this.gameModes=O.filter(O=>S.getArray("GameMode").includes(O.mapFilter)),this}getFullMapTitle(S){return this.addTitleSlotsSuffix(S.get(this.uiName),this.maxSlots)}addTitleSlotsSuffix(S,O){return S.match(/(\(|)\s*\d(-\d)?\s*(\)|)\s*$/)||(S+=` (2${2<O?"-"+O:""})`),S}fromMapFile(S,O){var N=S.readAsString();let j=S.filename;const L=new B.IniFile(this.extractIniSection("Basic",N)).getSection("Basic");if(!L)throw new Error(`Map "${j}" is missing the [Basic] section`);this.fileName=j,this.uiName="NOSTR:"+(L.getString("Name")||j.replace(/\.[^.]+$/,""));let D=(N=this.extractIniSection("Waypoints",N))?new B.IniFile(N).getSection("Waypoints"):void 0;this.maxSlots=[...D?.entries.keys()??[]].filter(S=>Number(S)<8).length,this.official=L.getBool("Official");let F=L.getArray("GameMode",void 0,["standard"]);return this.gameModes=O.filter(S=>F.includes(S.mapFilter)),this}extractIniSection(S,O){var B=O.indexOf(`[${S}]`);if(-1!==B){let S=B+1;for(;S<O.length&&("["!==O[S]||"\n"!==O[S-1]);S++);return O.slice(B,S)}}})}}}),System.register("engine/MapSupport",["game/rules/Rules","engine/Engine","game/theater/TileSets","engine/TheaterType","engine/type/ObjectType"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){S("MapSupport",class{static check(S,O){if(S.iniFormat<4)return O.get("TS:MapUnsupportedGame");if(S.startingLocations.length<2)return O.get("TXT_SCENARIO_TOO_SMALL",S.startingLocations.length);if(!N.Engine.supportsTheater(S.theaterType))return O.get("TS:MapUnsupportedTheater",L.TheaterType[S.theaterType]);var F,_,U,H,V,W,z,K=N.Engine.getTheaterIni(N.Engine.getActiveEngine(),S.theaterType);let $=new j.TileSets(K);if(S.maxTileNum>$.readMaxTileNum())return O.get("TS:MapUnsupportedTileSet");let q=new B.Rules(N.Engine.getRules().clone().mergeWith(S));if(!q.hasOverlayId(S.maxOverlayId))return O.get("TS:MapUnsupportedOverlay",S.maxOverlayId);for(F of q.weaponTypes.values()){if(!q.getIni().getSection(F))return O.get("TS:MapUnsupportedWeapon",F);var Q=q.getWeapon(F),Z=Q.projectile;let S=Q.warhead;if(!Z||!S)return O.get("TS:MapUnsupportedWeapon",F);if(!q.getIni().getSection(Z))return O.get("TS:MapUnsupportedProjectile",Z);if(!q.warheadRules.has(S.toLowerCase())&&!q.getIni().getSection(S))return O.get("TS:MapUnsupportedWarhead",S)}for(_ of[...q.general.baseUnit,...q.general.harvesterUnit])if(_&&!q.hasObject(_,D.ObjectType.Vehicle))return O.get("TS:MapUnsupportedTechno",_);for(U of q.general.defaultMirageDisguises)if(U&&!q.terrainRules.has(U))return O.get("TS:MapUnsupportedTerrain",U);for(H of[q.general.engineer,q.general.crew.alliedCrew,q.general.crew.sovietCrew,q.general.alliedDisguise,q.general.sovietDisguise])if(H&&!q.infantryRules.has(H))return O.get("TS:MapUnsupportedTechno",H);for(V of[q.crateRules.crateImg,q.crateRules.waterCrateImg])if(V&&!q.overlayRules.has(V))return O.get("TS:MapUnsupportedOverlay",V);for(W of q.buildingRules.values())if(W.undeploysInto&&!q.hasObject(W.undeploysInto,D.ObjectType.Vehicle))return O.get("TS:MapUnsupportedTechno",W.undeploysInto);for(z of[...q.infantryRules.values(),...q.vehicleRules.values(),...q.aircraftRules.values()]){if(z.spawns&&!q.hasObject(z.spawns,D.ObjectType.Aircraft))return O.get("TS:MapUnsupportedTechno",z.spawns);if(z.deploysInto&&!q.hasObject(z.deploysInto,D.ObjectType.Building))return O.get("TS:MapUnsupportedTechno",z.deploysInto)}}})}}}),System.register("engine/RenderableManager",["engine/gfx/OctreeContainer"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("RenderableManager",class{constructor(S,O,B,N){this.world=S,this.worldScene=O,this.camera=B,this.renderableFactory=N,this.renderablesByGameObject=new Map,this.renderablesById=new Map,this.positionListeners=new Map,this.onCameraUpdate=()=>{this.container.cullChildren()},this.onWorldObjectSpawned=S=>{var O=S.isTechno()&&S.rules.isLightpost;let B=this.createRenderable(S,O?this.worldScene:this.container);B.onCreate&&B.onCreate(this),O=({tileChanged:O})=>this.onObjectPositionChanged(S,O),this.positionListeners.set(S,O),S.position.onPositionChange.subscribe(O)},this.onWorldObjectRemoved=S=>{S.position.onPositionChange.unsubscribe(this.positionListeners.get(S)),this.positionListeners.delete(S);let O=this.renderablesByGameObject.get(S);if(O.onRemove){let B=O.onRemove(this);B?B.then(()=>this.removeAndDisposeRenderable(O,S)).catch(S=>console.error(S)):this.removeAndDisposeRenderable(O,S)}else this.removeAndDisposeRenderable(O,S)}}init(){let S=this.container=B.OctreeContainer.factory(this.camera);S.autoCull=!1,this.worldScene.add(S),this.worldScene.onCameraUpdate.subscribe(this.onCameraUpdate),this.world.getAllObjects().forEach(S=>this.onWorldObjectSpawned(S)),this.world.onObjectSpawned.subscribe(this.onWorldObjectSpawned),this.world.onObjectRemoved.subscribe(this.onWorldObjectRemoved)}getRenderableById(S){return this.renderablesById.get(S)}getRenderableByGameObject(S){return this.renderablesByGameObject.get(S)}getRenderableContainer(){return this.container}onObjectPositionChanged(S,O){let B=this.renderablesByGameObject.get(S);B.setPosition(S.position.worldPosition),S.isTechno()&&S.rules.isLightpost||this.container.updateChild(B)}removeAndDisposeRenderable(S,O){(O.isTechno()&&O.rules.isLightpost?this.worldScene:this.container).remove(S),S.dispose?.(),this.renderablesByGameObject.delete(O),this.renderablesById.delete(O.id)}createTransientAnim(S,O){var B=this.renderableFactory.createTransientAnim(S,this.container);return O?.(B),this.container.add(B),B}createAnim(S,O,B=!1){var N=this.renderableFactory.createAnim(S);return O?.(N),B||this.container.add(N),N}addEffect(S){S.setContainer(this.worldScene),this.worldScene.add(S)}dispose(){this.worldScene.remove(this.container),this.container=void 0,this.worldScene.onCameraUpdate.unsubscribe(this.onCameraUpdate),this.world.onObjectSpawned.unsubscribe(this.onWorldObjectSpawned),this.world.onObjectRemoved.unsubscribe(this.onWorldObjectRemoved),this.onWorldObjectRemoved=void 0,this.onWorldObjectSpawned=void 0,this.positionListeners.forEach((S,O)=>O.position.onPositionChange.unsubscribe(S)),this.positionListeners.clear(),this.renderablesById.forEach(S=>S.dispose?.())}createRenderable(S,O){let B=this.renderableFactory.create(S);return B.setPosition(S.position.worldPosition),O.add(B),this.renderablesByGameObject.set(S,B),this.renderablesById.set(S.id,B),B}updateLighting(){for(var S of this.renderablesById.values())S.updateLighting()}})}}}),System.register("engine/ResourceCollection",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("engine/ResourceLoader",["@puzzl/core/lib/async/cancellation","network/HttpRequest","engine/resourceConfigs"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(O){S({DownloadError:(N=O).DownloadError})},function(S){j=S}],execute:function(){S("ResourceLoader",class{constructor(S){this.resourceBaseUrl=S,this.httpRequest=new N.HttpRequest}async prefetchResource(S,O){let N=this.getResourceUrl(S);const j=document.createElement("link");j.rel="prefetch",j.as="fetch",j.href=N,j.crossOrigin="anonymous",await new Promise((S,L)=>{O?.register(()=>{j.parentNode&&(document.head.removeChild(j),L(new B.OperationCanceledError(O)))}),"onload"in j&&(j.onload=()=>{document.head.removeChild(j),S()}),"onerror"in j&&(j.onerror=()=>{document.head.removeChild(j),L(new Error(`Couldn't prefetch URL "${N}"`))}),document.head.appendChild(j),"onload"in j||(document.head.removeChild(j),S())})}getResourceUrl(S){var O="object"==typeof S?S:j.resourceConfigs.get(S);if(!O)throw new Error("Missing resourceConfig for resType "+j.ResourceType[S]);return this.resourceBaseUrl+O.src}getResourceFileName(S){return this.getResourceUrl(S).split("?")[0].split("/").pop()}buildResourceManifest(S){return S.map(S=>{if("object"==typeof S)return S;if(!j.resourceConfigs.has(S))throw new Error("Missing resourceConfig for resType "+j.ResourceType[S]);return j.resourceConfigs.get(S)}).map(S=>({id:S.id,src:S.src.match(/^https?:\/\//)?S.src:this.resourceBaseUrl+S.src,type:S.type,sizeHint:S.sizeHint}))}async loadText(S,O,B){return await this.loadResource({src:S,type:"text"},O,B)}async loadBinary(S,O,B){return await this.loadResource({src:S,type:"binary"},O,B)}async loadJson(S,O,B){return await this.loadResource({src:S,type:"json"},O,B)}async loadResource(S,O,B){var N=await this.fetchResource(this.resourceBaseUrl+S.src,O,B);return this.httpRequest.parseResult(S.type,N)}async loadResources(S,O,B){let N=this.buildResourceManifest(S),j=new Map;var D,F=N.length;let _=0,U=N.reduce((S,{sizeHint:O})=>S+(O??0),0),H=0;for(D of N){var V=await this.fetchResource(D.src,O,{onProgress:S=>{H+=S,U&&B?.(Math.floor(100*Math.min(1,H/U)))}});j.set(D.id,V),_++,U||B?.(Math.floor(_/F*100))}return new L(j)}async fetchResource(S,O,B){return await this.httpRequest.fetchRaw(S,O,B)}}),S("LoaderResult",L=class{constructor(S){this.items=S}pop(S){let O;if("string"==typeof S)O=S;else{if(!j.resourceConfigs.has(S))throw new Error(`Missing resourceConfig for resource type "${j.ResourceType[S]}"`);if(O=j.resourceConfigs.get(S).id,!O)throw new Error("Undefined resourceId for resourceType "+S)}var B=this.items.get(O);if(!B)throw new Error(`Resource type "${S}" not found in result.`);return this.items.delete(O),B}})}}}),System.register("engine/Theater",["game/theater/TileSets","engine/type/PaletteType"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("Theater",class{static factory(S,O,N,j,L){var D=L.get(N.isoPaletteName);if(!D)throw new Error(`Missing palette "${N.isoPaletteName}"`);var F=L.get(N.overlayPaletteName);if(!F)throw new Error(`Missing palette "${N.overlayPaletteName}"`);var _=L.get(N.unitPaletteName);if(!_)throw new Error(`Missing palette "${N.unitPaletteName}"`);var U=L.get("anim.pal");if(!U)throw new Error("Missing anim palette");var H=L.get(N.libPaletteName);if(!H)throw new Error("Missing lib palette "+N.libPaletteName);let V=new B.TileSets(O);return V.loadTileData(j,N.extension),new this(S,N,L,D,F,_,U,H,V)}constructor(S,O,B,N,j,L,D,F,_){this.type=S,this.settings=O,this.palettes=B,this.isoPalette=N,this.ovlPalette=j,this.unitPalette=L,this.animPalette=D,this.libPalette=F,this.tileSets=_}getPalette(S,O){switch(S){case N.PaletteType.Anim:return this.animPalette;case N.PaletteType.Overlay:return this.ovlPalette;case N.PaletteType.Unit:return this.unitPalette;case N.PaletteType.Custom:if("lib"===O)return this.libPalette;var B=this.palettes.get(O+".pal");if(!B)throw new Error(`Custom palette "${O}" not found`);return B;default:return N.PaletteType.Iso,this.isoPalette}}})}}}),System.register("engine/TheaterType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("TheaterType",B={}))[O.None=0]="None",O[O.Temperate=1]="Temperate",O[O.Urban=2]="Urban",O[O.Snow=4]="Snow",O[O.Lunar=8]="Lunar",O[O.Desert=16]="Desert",O[O.NewUrban=32]="NewUrban",O[O.All=63]="All"}}}),System.register("engine/UiAnimationLoop",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("UiAnimationLoop",class{constructor(S){this.renderer=S,this.isStarted=!1,this.doBackgroundFrame=S=>{this.isStarted&&this.paused&&this.renderer.update(S)},this.doFrame=S=>{if(this.isStarted&&!this.paused){let O=this.renderer.getStats();O&&O.begin(),this.renderer.update(S),this.renderer.render(),O&&O.end(),this.rafId=requestAnimationFrame(this.doFrame)}},this.handleVisibilityChange=()=>{var S=document.hidden;this.paused!==S&&(this.paused=S,this.paused?(this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId=setInterval(()=>{var S=performance.now();this.doBackgroundFrame(S)},1e3)):(this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),this.rafId=requestAnimationFrame(this.doFrame)))}}start(){this.isStarted||(this.isStarted=!0,this.paused=!1,document.hidden?this.handleVisibilityChange():this.rafId=requestAnimationFrame(this.doFrame),document.addEventListener("visibilitychange",this.handleVisibilityChange))}stop(){this.isStarted&&(this.isStarted=!1,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),document.removeEventListener("visibilitychange",this.handleVisibilityChange))}destroy(){this.stop(),this.renderer.flush()}})}}}),System.register("engine/animation/Runner",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("engine/animation/SimpleRunner",["engine/Animation"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("SimpleRunner",class{tick(S){let O=this.animation;if(O)switch(O.getState()){case B.AnimationState.STOPPED:return;case B.AnimationState.NOT_STARTED:O.start(S);case B.AnimationState.RUNNING:default:O.update(S)}}getCurrentFrame(){return this.animation.getCurrentFrame()}shouldUpdate(){return this.animation.getState()!==B.AnimationState.STOPPED}})}}}),System.register("engine/gameRes/CdnManifest",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("engine/gameRes/CdnResourceLoader",["data/DataStream","data/Crc32","data/vfs/VirtualFile","engine/ResourceLoader"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class e extends L.ResourceLoader{static async clearCache(S){for await(var O of S.getEntries())O.startsWith(e.cachePrefix)&&await S.deleteFile(O)}constructor(S,O,B){super(S),this.cdnManifest=O,this.cacheDir=B}getFileNameFromUrl(S){return S.split("?")[0].split("/").pop()}async fetchResource(S,O,D){let F=this.getFileNameFromUrl(S);var _=e.cachePrefix+F,U=this.cdnManifest.checksums[F];try{if(F.endsWith(".mix")&&void 0!==U&&this.cacheDir&&await this.cacheDir.containsEntry(_)){let O=await this.cacheDir.getRawFile(_);var H=new Uint8Array(await O.arrayBuffer());if(N.Crc32.calculateCrc(H)===U)return D?.onProgress?.(H.length),H;try{await this.cacheDir.deleteFile(_)}catch(S){console.error("Couldn't delete file from local CDN cache",S)}}}catch(S){console.error(`Couldn't read file "${_}" from local CDN cache`,S)}if(void 0!==U&&(S+=(S.includes("?")?"&":"?")+"h="+U),H=await super.fetchResource(S,O,D),N.Crc32.calculateCrc(H)!==U)throw new L.DownloadError(`Checksum mismatch for URL "${S}"`);try{await(this.cacheDir?.writeFile(j.VirtualFile.factory(new B.DataStream(H),_)))}catch(S){console.error("Couldn't write file to local CDN cache",S)}return H}},S("CdnResourceLoader",D),D.cachePrefix="cdncache_"}}}),System.register("engine/gameRes/FileSystemAccessLib",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("engine/gameRes/FileSystemUtil",["data/vfs/FileNotFoundError","data/vfs/IOError"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("FileSystemUtil",class{static async getDirContents(S){let O=[];try{for await(var j of S.values())O.push(j)}catch(O){if("NotFoundError"===O.name)throw new B.FileNotFoundError(`Directory "${S.name}" not found`,{cause:O});if(O instanceof DOMException)throw new N.IOError(`Directory "${S.name}" could not be read (${O.name})`,{cause:O});throw O}return O}static async listDir(S){let O=[];try{for await(var j of S.keys())O.push(j)}catch(O){if("NotFoundError"===O.name)throw new B.FileNotFoundError(`Directory "${S.name}" not found`,{cause:O});if(O instanceof DOMException)throw new N.IOError(`Directory "${S.name}" could not be read (${O.name})`,{cause:O});throw O}return O}static async showArchivePicker(S){var O=await S.showOpenFilePicker({types:[{description:"Archive",accept:{"application/vnd.rar":[".rar"],"application/zip":[".zip"],"application/x-tar":[".tar"],"application/gzip":[".gz"],"application/x-bzip":[".bz"],"application/x-bzip2":[".bz2"],"application/x-xz":[".xz"],"application/x-7z-compressed":[".7z"],"application/octet-stream":[".exe"]}}]});return Array.isArray(O)?O[0]:O}static polyfillGetFile(){const S=FileSystemFileHandle.prototype.getFile;FileSystemFileHandle.prototype.getFile=function(){return S.call(this).then(S=>new File([S],this.name,{type:S.type,lastModified:S.lastModified}))}}})}}}),System.register("engine/gameRes/GameRes",["data/DataStream","data/MixFile","engine/Engine","engine/ResourceLoader","util/Logger","engine/gameRes/GameResConfig","engine/gameRes/importError/ChecksumError","engine/gameRes/importError/FileNotFoundError","engine/gameRes/importError/NoStorageError","data/Crc32","data/Palette","data/ShpFile","data/PcxFile","engine/gfx/ImageUtils","data/Bitmap","engine/gfx/CanvasUtils","gui/component/GameResBoxApi","engine/gameRes/GameResSource","data/vfs/RealFileSystem","engine/resourceConfigs","engine/gameRes/CdnResourceLoader","LocalPrefs","engine/gameRes/FileSystemUtil","data/vfs/StorageQuotaError","data/vfs/FileNotFoundError","data/vfs/IOError","engine/gameRes/GameResImporter"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S}],execute:function(){S("GameRes",class{constructor(S,O,B,N,j,L,D,F,_,U,H){this.appVersion=S,this.modName=O,this.fsAccessLib=B,this.localPrefs=N,this.strings=j,this.rootEl=L,this.splashScreen=D,this.viewport=F,this.appConfig=_,this.appResPath=U,this.sentry=H}async init(S,O,B){let N,L,D,_,U,V,W=!1,z=!1,p=(S,O)=>{if(S&&this.splashScreen.setLoadingText(S),O){let S;S="string"==typeof O?O:N=URL.createObjectURL(O),this.splashScreen.setBackgroundImage(S)}};try{L=await this.getBrowserFsHandle("native")}catch(L){if(!(L instanceof H.NoStorageError))throw L}try{D=!!L&&await this.migrateStorageToNative(L,p)}catch(L){console.warn("Storage migration to native failed",L),this.sentry?.captureException(new Error("Failed to migrate files to native file system",{cause:L})),D=!1}finally{p(this.strings.get("GUI:LoadingEx"))}try{var K=D?L:await this.getBrowserFsHandle("fallback");K&&(_=await j.Engine.initRfs(K))}catch(L){if(!(L instanceof H.NoStorageError))throw L;console.warn("No storage adapters available.")}if(!S&&_&&await this.lookForGameFiles(_.getRootDirectory())&&((S=new F.GameResConfig("")).source=Y.GameResSource.Local,z=!0),_&&($=await j.Engine.getModDir(),U=await this.loadMod(_,$)),_&&_.addDirectory(await j.Engine.getMapDir()),S){var $=await this.loadSplashScreenBackground(_?.getRootDirectory(),U,S);"string"==typeof $?this.splashScreen.setBackgroundImage($):$&&(N=URL.createObjectURL($),this.splashScreen.setBackgroundImage(N));try{V=await this.loadResources(_,S,p),W=!0}catch(L){console.error("Failed to load initial game resources"),console.error(L),this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),await O(L,this.strings)}}let q=new Z.GameResBoxApi(this.viewport,this.strings,this.rootEl,this.fsAccessLib,this.appConfig),Q=this.appConfig.gameResArchiveUrl;for(;!W;){this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),N&&(URL.revokeObjectURL(N),N=void 0);let j,D=await q.promptForGameRes(Q,!!this.appConfig.gameresBaseUrl&&!this.modName);if(S=new F.GameResConfig(this.appConfig.gameresBaseUrl??""),z=!0,D)if(D instanceof URL)j=Y.GameResSource.Archive,Q=D.toString();else if("file"===D.kind)j=Y.GameResSource.Archive;else{if("directory"!==D.kind)throw new Error("Unexpected FileSystemHandle type "+D.kind);j=Y.GameResSource.Local}else j=Y.GameResSource.Cdn;if(S.source=j,j!==Y.GameResSource.Cdn)try{if(!_)throw new H.NoStorageError("No storage adapters available");await new ae.GameResImporter(this.appConfig,this.strings,this.sentry).import(D,_.getRootDirectory(),(S,O)=>{p(S,O),S&&console.info(S)}),console.info("Game assets successfully imported.")}catch(L){console.error("Failed to import game assets"),console.error(L),this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),await B(L,this.strings);continue}finally{this.splashScreen.setLoadingText("")}try{this.splashScreen.setLoadingText(this.strings.get("GUI:LoadingEx")),V=await this.loadResources(_,S,p),W=!0}catch(L){console.error("Failed to load game assets"),console.error(L),this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),await O(L,this.strings)}}return N&&URL.revokeObjectURL(N),{configToPersist:z?S:void 0,cdnResLoader:V}}async loadMod(S,O){let B,N=this.modName;return N&&(await O.containsEntry(N)?(console.info(`Loading mod "${N}"...`),B=await O.getDirectory(N),S.addDirectory(B),j.Engine.setActiveMod(N)):(console.info(`Mod "${N}" not found. Ignoring.`),N=this.modName=void 0)),B}async lookForGameFiles(S){let O=await S.listEntries();return["language.mix","multi.mix","ra2.mix"].every(S=>O.includes(S))}async migrateStorageToNative(S,O){var B="_storage_migration_pending";if(this.localPrefs.getItem(B)){for await(var N of S.keys())await S.removeEntry(N,{recursive:!0});this.localPrefs.removeItem(B)}else if((await S.keys().next()).value)return!0;if(void 0===this.localPrefs.getItem(te.StorageKey.LastGpuTier))return!0;let L;console.info("Migrating to new storage...");try{L=await this.getBrowserFsHandle("fallback")}catch(O){if(O instanceof H.NoStorageError)return console.info("No existing storage found. Migration skipped."),!1;throw O}if(navigator.storage?.estimate){var D=await navigator.storage.estimate();if(void 0===D.usage||void 0===D.quota)return!1;if(D.usage>(D.quota-5242880)/2)return console.info("Migration to native storage skipped because of insufficient space."),!1}(await ie.FileSystemUtil.listDir(L)).includes(j.Engine.rfsSettings.cacheDir)&&await L.removeEntry(j.Engine.rfsSettings.cacheDir,{recursive:!0}),this.localPrefs.setItem(B,"1");try{await this.migrateDir(L,S,O)}catch(O){for await(var F of S.keys())await S.removeEntry(F,{recursive:!0});throw O}finally{this.localPrefs.removeItem(B)}try{indexedDB.deleteDatabase("fileSystem"),this.fsAccessLib.support.adapter.cache&&await(globalThis.caches?.delete("sandboxed-fs"))}catch(O){console.warn(O)}return console.info("Migration done."),!0}async migrateDir(S,O,B){var N;for(N of await ie.FileSystemUtil.getDirContents(S))try{if("directory"===N.kind){var j=await O.getDirectoryHandle(N.name,{create:!0});await this.migrateDir(N,j,B)}else{var L=N.name.replace(/\u200f/g,"");B(this.strings.get("TS:storage_migrating_file",O.name+"/"+N.name));let S=await O.getFileHandle(L,{create:!0});var D=await S.createWritable();let j=await N.getFile();await j.stream().pipeTo(D)}}catch(S){if("QuotaExceededError"===S.name)throw new re.StorageQuotaError({cause:S});throw new Error(`Failed migrating "${N.name}"`,{cause:S})}}async loadResources(S,O,B){let N;if(j.Engine.initGameResSource(O.source),O.isCdn()){var F=O.getCdnBaseUrl();let B=new L.ResourceLoader(F);var _=await B.loadJson("manifest.json");if(2!==_.version)throw new Error("Unknown manifest version "+_.version);if("mix"!==_.format)throw new Error("Unsupported CDN resource format "+_.format);S=S||new X.RealFileSystem,N=new ee.CdnResourceLoader(F,_,await j.Engine.getCacheDir())}else{if(!S)throw new H.NoStorageError("No available storage adapters");console.info("Checking integrity of mix files..."),await this.checkMixesIntegrity(S.getRootDirectory()),console.info("Mixes are valid.")}const U=D.AppLogger.get("vfs");U.info("Initializing virtual filesystem...");let V=await j.Engine.initVfs(S,U);return await V.loadStandaloneFiles({exclude:["keyboard.ini","theme.ini"].map(S=>j.Engine.getFileNameVariant(S))}),await V.loadExtraMixFiles(j.Engine.getActiveEngine()),await this.loadCustomMix(V),await this.loadMixes(O,N,V,B),await j.Engine.loadMapList(),await this.initUiCssVariables(this.rootEl),N}async checkMixesIntegrity(S){let O=new Map([["ra2.mix",["E7BA3BE","5DC70844"]],["multi.mix",["984EFDB6","3CDB648F"]]]);for(var[B,N]of O.entries()){let j,L;try{j=await S.getRawFile(B,!0),L=await j.arrayBuffer()}catch(O){if(O instanceof se.FileNotFoundError)throw new U.FileNotFoundError(B);if(O instanceof DOMException)throw new ne.IOError(`Failed to read file (${O.name})`,{cause:O});throw O}let D=V.Crc32.calculateCrc(new Uint8Array(L));if(!N.includes(D.toString(16).toUpperCase()))throw new _.ChecksumError(`Checksum mismatch for "${B}" (size: ${j.size}). Checksum "${D}" doesn't match known values`,B)}}async loadCustomMix(S){let O=new L.ResourceLoader(this.appResPath);var j=await O.loadBinary("ra2cd.mix?v="+this.appVersion);j=new N.MixFile(new B.DataStream(j)),S.addArchive(j,"ra2cd.mix")}async loadMixes(S,O,L,D){if(S.isCdn()){var F,_=S.getCdnBaseUrl();D(this.strings.get("TS:Downloading"),_+j.Engine.rfsSettings.splashImgFileName),_=[J.ResourceType.Ini,J.ResourceType.Ui,J.ResourceType.Strings];let V=await O.loadResources(_,void 0,S=>{D(this.strings.get("TS:DownloadingPg",S))});for(F of(D(this.strings.get("GUI:LoadingEx")),_)){var U=O.getResourceFileName(F),H=new N.MixFile(new B.DataStream(V.pop(F)));L.addArchive(H,U)}}else if(await L.loadImplicitMixFiles(j.Engine.getActiveEngine()),_=await j.Engine.getCacheDir())try{await ee.CdnResourceLoader.clearCache(_)}catch(S){if(!(S instanceof re.StorageQuotaError))throw S}}async initUiCssVariables(S){let O,B=await this.convertImagesToPng(j.Engine.vfs,[["pudlgbgn.shp","dialog.pal"],["mnbttn.shp","mainbttn.pal"],["cue_i.pcx"],["cce_i.pcx"],["cce_il.pcx"],["cce_ir.pcx"]]);B.set("menulogo.png",j.Engine.vfs.openFile("menulogo.png").asFile("image/png")),B.set("icons24.pcx",await this.generateIconSprite(j.Engine.vfs));var N,L={"--res-menu-logo":"menulogo.png","--res-icons-24":"icons24.pcx","--res-dlg-bgn":"pudlgbgn.shp","--res-mnbttn":"mnbttn.shp","--res-cue-i":"cue_i.pcx","--res-cce-i":"cce_i.pcx","--res-cce-il":"cce_il.pcx","--res-cce-ir":"cce_ir.pcx"};for(N of(O={},Object.keys(L))){var D=B.get(L[N]);D?(D=URL.createObjectURL(D),O[N]=`url("${D}")`):console.warn(`Image "${L[N]}" not found in browser FS`)}Object.keys(O).forEach(B=>{S.style.setProperty(B,O[B])})}async loadSplashScreenBackground(S,O,B){var N=j.Engine.rfsSettings.splashImgFileName;if(B.isCdn())return B.getCdnBaseUrl()+N;{let j;if(O)try{j=await O.getRawFile(N,!1,"image/png")}catch(B){B instanceof se.FileNotFoundError||console.warn("Failed to load splash image",B)}if(S&&!j)try{j=await S.getRawFile(N,!1,"image/png")}catch(B){console.warn("Failed to load splash image",B)}return j}}async getBrowserFsHandle(S){let O=[];var B;for("fallback"!==S&&this.fsAccessLib.support.adapter.native&&O.push({name:"native",module:void 0}),"native"!==S&&(O.push({name:"indexeddb",module:this.fsAccessLib.adapters.indexeddb}),this.fsAccessLib.support.adapter.cache&&O.push({name:"cache",module:this.fsAccessLib.adapters.cache}));B=O.shift();)try{console.info(`Loading storage adapter "${B.name}"...`);let O=await this.fsAccessLib.getOriginPrivateDirectory(B.module);try{let S=await O.getFileHandle("browsercheck",{create:!0});if("function"!=typeof S.createWritable)throw new Error("createWritable not supported");(await S.getFile()).name!==S.name&&ie.FileSystemUtil.polyfillGetFile()}catch(S){if("NotFoundError"===S.name&&"indexeddb"===B.name&&await new Promise(()=>{indexedDB.deleteDatabase("fileSystem"),this.localPrefs.removeItem(te.StorageKey.GameRes),location.reload()}),"QuotaExceededError"!==S.name)throw S}finally{try{await O.removeEntry("browsercheck")}catch(S){}}return console.info(`Storage adapter "${B.name}" loaded successfully.`),O}catch(S){console.warn("Couldn't load FS adapter "+B.name,[S])}throw new H.NoStorageError("No available FS adapters.")}async convertImagesToPng(S,O){let B=new Map;for(var[N,j]of O){let O;if(N.endsWith(".shp")){var L=new z.ShpFile(S.openFile(N));if(!j)throw new Error(`No palette specified for image "${N}"`);j=new W.Palette(S.openFile(j)),O=await $.ImageUtils.convertShpToPng(L,j)}else{if(!N.endsWith(".pcx")){console.warn(`Unknown image type "${N}"`);continue}{let B=new K.PcxFile(S.openFile(N));O=await B.toPngBlob()}}B.set(N,O)}return B}async generateIconSprite(S){let O=["wouref.pcx","wodref.pcx","wouact.pcx","wodact.pcx","dnarrowr.pcx","dnarrowp.pcx","uparrowr.pcx","uparrowp.pcx","sbgript.pcx","sbgripm.pcx","sbgripb.pcx","trakgrip.pcx"];var B=O.map(O=>new K.PcxFile(S.openFile(O)));let N=new q.RgbaBitmap(24*O.length,24);for(let S=0;S<B.length;S++){var j=new q.RgbaBitmap(B[S].width,B[S].height,B[S].data);N.drawRgbaImage(j,24*S,0)}var L=Q.CanvasUtils.canvasFromRgbaImageData(N.data,N.width,N.height);return await Q.CanvasUtils.canvasToBlob(L)}})}}}),System.register("engine/gameRes/GameResConfig",["engine/gameRes/GameResSource"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("GameResConfig",class{constructor(S){this.defaultCdnBaseUrl=S}unserialize(S){var[O,N]=S.split(","),O=Number(O);if(!B.GameResSource[O])throw new Error(`Unknown game res source "${O}"`);this.source=O,this.cdnUrl=N?decodeURI(N):void 0}serialize(){return this.source+(this.cdnUrl?","+encodeURI(this.cdnUrl):"")}isCdn(){return this.source===B.GameResSource.Cdn}getCdnBaseUrl(){return this.cdnUrl??this.defaultCdnBaseUrl}})}}}),System.register("engine/gameRes/GameResImporter",["data/MixFile","engine/Engine","util/time","engine/gameRes/importError/ChecksumError","engine/gameRes/importError/FileNotFoundError","engine/gameRes/importError/ArchiveExtractionError","data/vfs/VirtualFile","engine/mixDatabase","data/Palette","data/ShpFile","engine/gfx/ImageUtils","util/string","engine/gameRes/VideoConverter","engine/gameRes/importError/InvalidArchiveError","data/vfs/FileNotFoundError","data/vfs/IOError","data/vfs/RealFileSystemDir","engine/gameRes/importError/NoWebAssemblyError","network/HttpRequest","engine/gameRes/importError/ArchiveDownloadError"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee;function C(S){return S/1024/1024}function E(S){return function(O,B,N,j,L){let D=S(O,B,N,j,L);var F,_=ee.get(D.node.name);return _&&(D.node.contents=new Uint8Array(_),_=D.stream_ops.write,D.stream_ops={...D.stream_ops},D.stream_ops.write=(F=_,function(S,O,B,N,j,L){j||(S.node.usedBytes=S.node.contents.byteLength);var D=F(S,O,B,N,j,L);return j||(S.node.usedBytes=D),D})),D}}return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S}],execute:function(){ee=(new Map).set("ra2.mix",281895456).set("language.mix",53116040).set("multi.mix",25856283).set("theme.mix",76862662),S("GameResImporter",class{constructor(S,O,B){this.appConfig=S,this.strings=O,this.sentry=B}async import(S,O,B){var L,_=["ra2.mix","language.mix","multi.mix","theme.mix"];let U=new Set(["theme.mix"]),H=N.Engine.rfsSettings.tauntsDir,V=this.strings;if(B(V.get("ts:import_preparing_for_import")),S instanceof URL||"file"===S.kind){if(!window.WebAssembly)throw new Y.NoWebAssemblyError("WebAssembly is not available");let N,q,Z,se;try{let S=await SystemJS.import("7z-wasm");Z=await S({quit:(S,O)=>{N=S,q=O}})}catch(ee){if(ee.message.match(/Load failed|Failed to fetch/))throw new X.DownloadError("Failed to load 7z-wasm",{cause:ee});if(ee instanceof WebAssembly.RuntimeError)throw new Q.IOError("Couldn't load 7z-wasm",{cause:ee});throw ee}{let O;if(S instanceof URL){let N=0;var W=S.toString(),K=this.appConfig.getCorsProxy(S.hostname);let j=W;K&&(j=""+K+encodeURIComponent(W));try{O=await(new X.HttpRequest).fetchBinary(j,void 0,{onProgress(S,O){N+=S,B(O?V.get("ts:downloadingpgsize",C(N),C(O),N/O*100):V.get("ts:downloadingpgunkn",C(N)))}}),se="archive"}catch(ee){if(!N&&ee instanceof X.DownloadError)throw new J.ArchiveDownloadError(W,"Archive download failed",{cause:ee});throw ee}}else{let B=await S.getFile();O=new Uint8Array(await B.arrayBuffer()),se=B.name}B(V.get("ts:import_loading_archive")),Z.FS.chdir("/tmp");try{var ee=Z.FS.open(se,"w+");Z.FS.write(ee,O,0,O.byteLength,0,!0),Z.FS.close(ee)}catch(ee){if(ee instanceof DOMException)throw new Q.IOError(`File "${se}" could not be read (${ee.name})`,{cause:ee});throw ee}}for(L of(Z.FS.open=E(Z.FS.open),[..._,H])){if(B(V.get("ts:import_extracting",L)),await j.sleep(100),Z.callMain(["x","-ssc-",se,L]),N){if(1!==N)throw new $.InvalidArchiveError("7-Zip exited with code "+N,{cause:q});if(q?.message?.match(/out of memory|allocation/i))throw new RangeError("Out of memory",{cause:q});throw new F.ArchiveExtractionError("Archive extraction failed with code "+N,{cause:q})}var te=Z.FS.lookupPath(Z.FS.cwd()).node;let S=Object.keys(te.contents);if(L!==H){let N=L;var ie=S.find(S=>z.equalsIgnoreCase(S,N))??N;let j;B(V.get("ts:import_importing",N));try{j=this.readFileFromEmFs(Z.FS,ie),Z.FS.unlink(ie)}catch(ee){if(44!==ee.errno)throw ee;if(U.has(N)){console.warn(`Mix file "${N}" not found. Skipping.`);continue}throw new D.FileNotFoundError(N)}await this.importMixArchive(j,O,B,V)}else{let N=S.find(S=>z.equalsIgnoreCase(S,H));if(N){ie=Z.FS.lookupPath(N).node,ie=Object.keys(ie.contents).map(S=>N+"/"+S);try{let S=await O.getOrCreateDirectory(H);for(var re of ie){B(V.get("ts:import_importing",re));let O=this.readFileFromEmFs(Z.FS,re);Z.FS.unlink(re),await S.writeFile(O,O.filename.toLowerCase())}}catch(ee){if(!(ee instanceof DOMException||ee instanceof Q.IOError||44===ee.errno))throw ee;console.warn("Failed to copy taunts folder. Skipping.",[ee])}}else console.warn("Taunts folder not found in archive. Skipping.")}}Z.FS.unlink(se);try{await O.openFile("ra2.mix")}catch(ee){ee instanceof Q.IOError&&(B(this.strings.get("GUI:LoadingEx")),location.reload(),await new Promise(()=>{}))}}else{let N,j=new Z.RealFileSystemDir(S,!0),L=await j.listEntries();for(let S of _){B(V.get("ts:import_importing",S));var se=L.find(O=>z.equalsIgnoreCase(O,S))??S;let N;try{N=await j.openFile(se)}catch(ee){if(ee instanceof q.FileNotFoundError){if(U.has(S)){console.warn(`Mix file "${S}" not found. Skipping.`);continue}throw new D.FileNotFoundError(S)}throw ee}await this.importMixArchive(N,O,B,V)}_=L.find(S=>z.equalsIgnoreCase(S,H))??H;try{N=await j.getDirectory(_)}catch(ee){if(!(ee instanceof q.FileNotFoundError||ee instanceof Q.IOError))throw ee;console.warn(`Directory "${_}" not found (${ee.name}). Skipping.`,ee)}if(N)try{let S=await O.getOrCreateDirectory(H,!0);for await(var ne of N.getRawFiles())B(V.get("ts:import_importing",S.name+"/"+ne.name)),await S.writeFile(ne,ne.name.toLowerCase())}catch(ee){if(!(ee instanceof Q.IOError))throw ee;console.warn("Failed to copy taunts folder. Skipping.",[ee])}}}readFileFromEmFs(S,O){S.chmod(O,448);let B=S.lookupPath(O).node;var N=B.contents.subarray(0,B.usedBytes);return _.VirtualFile.fromBytes(N,O.slice(O.lastIndexOf("/")+1))}async importMixArchive(S,O,B,j){let D=S.filename.toLowerCase();var F,_=D.match(/^theme[^.]*\.mix$/);if(!S.getSize()){if(_)return void console.warn(`Mix file ${S.filename} is empty. Skipping.`);throw new L.ChecksumError(`Mix file "${D}" is empty`,D)}_||await O.writeFile(S,D),_?(F=N.Engine.rfsSettings.musicDir,F=await O.getOrCreateDirectory(F,!0),await this.importMusic(S,F,S=>B(j.get("ts:import_importing_pg",D,S)))):D.match(/language\.mix/)?(B(j.get("ts:import_importing_long",D)),await this.importVideo(S,O)):D.match(/ra2\.mix/)&&(F=await this.importSplashImage(S,O),B(void 0,F))}async importMusic(S,O,N){let j;try{j=new B.MixFile(S.stream)}catch(S){return console.warn("Failed to read music mix archive. Skipping."),void console.error(S)}var L=U.mixDatabase.get(S.filename.toLowerCase());if(L){var D,F=L.length;let B=F;for(D of L){if(N(Math.floor((F-B)/F*100)),B--,!D.match(/\.wav$/))throw new Error(`Music file "${D}" is not a WAV file`);var _=D.replace(".wav",".mp3");if(j.containsFile(D)){var H=j.openFile(D);if(H.stream.byteLength){let B;try{let S=await this.createFFMpeg();S.FS("writeFile",D,new Uint8Array(H.stream.buffer,H.stream.byteOffset,H.stream.byteLength)),await S.run("-i",D,"-vn","-ar","22050","-b:a","96k",_),B=S.FS("readFile",_),S.FS("unlink",D),S.FS("unlink",_)}catch(S){console.warn(`Failed to convert music file "${D}". Skipping.`),console.error(S);continue}H=new Blob([B],{type:"application/octet-stream"});try{await O.writeFile(new File([H],_))}catch(S){console.warn(`Failed to write music file "${_}". Skipping.`),console.error(S);continue}}else console.warn(`Music file "${D}" is empty in the mix archive. Skipping.`)}else console.warn(`Music file "${D} was not found in mix archive. Skipping.`)}}else console.warn(`File "${S.filename} not found in mix database. Skipping music import.`)}async importVideo(S,O){var j=await this.createFFMpeg().catch(S=>{if(S.message.match(/Load failed|Failed to fetch/))throw new X.DownloadError("Failed to load FFMpeg",{cause:S});throw S});let L=new B.MixFile(S.stream);var F="ra2ts_l.bik",_=N.Engine.rfsSettings.menuVideoFileName;if(!L.containsFile(F))throw new D.FileNotFoundError(F);F=L.openFile(F),F=await(new K.VideoConverter).convertBinkVideo(j,F),F=new Blob([F],{type:"video/webm"}),await O.writeFile(new File([F],_,{type:"video/webm"}))}async createFFMpeg(){let S=(0,(await SystemJS.import("@ffmpeg/ffmpeg")).createFFmpeg)({corePath:"lib/ffmpeg-core.js?v=1",log:!0});var O=window.define;return window.define=void 0,await S.load(),window.define=O,S}async importSplashImage(S,O){let j=new B.MixFile(S.stream);if(!j.containsFile("local.mix"))throw new D.FileNotFoundError("local.mix");let L=new B.MixFile(j.openFile("local.mix").stream);if(!L.containsFile("glsl.shp"))throw new D.FileNotFoundError("glsl.shp");var F=new V.ShpFile(L.openFile("glsl.shp"));if(!L.containsFile("gls.pal"))throw new D.FileNotFoundError("gls.pal");var _=new H.Palette(L.openFile("gls.pal"));let U;F=await W.ImageUtils.convertShpToPng(F,_),_=N.Engine.rfsSettings.splashImgFileName;try{U=new File([F],_,{type:F.type})}catch(S){console.error("Failed to convert splash image. Skipping.",S),this.sentry?.captureException(new Error(`Failed to convert splash image (type=${F.type})`,{cause:S}))}return U&&await O.writeFile(U),F}})}}}),System.register("engine/gameRes/GameResSource",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("GameResSource",B={}))[O.Archive=0]="Archive",O[O.Cdn=1]="Cdn",O[O.Local=2]="Local"}}}),System.register("engine/gameRes/VideoConverter",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("VideoConverter",class{async convertBinkVideo(S,O,B="webm"){var N=O.filename,j=O.filename.replace(/\.\w+$/,"")+"."+B;S.FS("writeFile",N,new Uint8Array(O.stream.buffer,O.stream.byteOffset,O.stream.byteLength)),"webm"===B?await S.run("-i",N,"-vcodec","libvpx","-crf","10","-b:v","2M","-deadline","realtime","-speed","2","-an",j):await S.run("-i",N,"-vcodec","libx264","-crf","25","-b:v","2M","-an",j);var L=S.FS("readFile",j);return S.FS("unlink",N),S.FS("unlink",j),L}})}}}),System.register("engine/gameRes/importError/ArchiveDownloadError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends Error{constructor(S,O,B){super(O,B),this.url=S}},S("ArchiveDownloadError",B)}}}),System.register("engine/gameRes/importError/ArchiveExtractionError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends Error{},S("ArchiveExtractionError",B)}}}),System.register("engine/gameRes/importError/ChecksumError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends Error{constructor(S,O){super(S),this.file=O}},S("ChecksumError",B)}}}),System.register("engine/gameRes/importError/FileNotFoundError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends Error{constructor(S){super(`File "${S}" not found.`),this.file=S}},S("FileNotFoundError",B)}}}),System.register("engine/gameRes/importError/InvalidArchiveError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends Error{},S("InvalidArchiveError",B)}}}),System.register("engine/gameRes/importError/NoStorageError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends Error{},S("NoStorageError",B)}}}),System.register("engine/gameRes/importError/NoWebAssemblyError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends Error{},S("NoWebAssemblyError",B)}}}),System.register("engine/gfx/BufferGeometryUtils",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("BufferGeometryUtils",class{static mergeVertices(S,O=1e-4){O=Math.max(O,Number.EPSILON);const B={},N=S.getIndex();var j=S.getAttribute("position"),L=(N||j).count;let D=0;var F=Object.keys(S.attributes);const _={},U={},H=[],V=[(S,O)=>S.getX(O),(S,O)=>S.getY(O),(S,O)=>S.getZ(O),(S,O)=>S.getW(O)];for(let O=0,B=F.length;O<B;O++){var W=F[O];_[W]=[];var z=S.morphAttributes[W];z&&(U[W]=new Array(z.length).fill(void 0).map(()=>[]))}j=Math.log10(1/O);var K=Math.pow(10,j);for(let O=0;O<L;O++){var $=N?N.getX(O):O;let j="";for(let O=0,B=F.length;O<B;O++){var q=F[O],Q=S.getAttribute(q),Z=Q.itemSize;for(let S=0;S<Z;S++)j+=~~(V[S](Q,$)*K)+","}if(j in B)H.push(B[j]);else{for(let O=0,B=F.length;O<B;O++){var Y=F[O],X=S.getAttribute(Y),J=S.morphAttributes[Y],ee=X.itemSize;const B=_[Y],N=U[Y];for(let S=0;S<ee;S++){const O=V[S];if(B.push(O(X,$)),J)for(let S=0,B=J.length;S<B;S++)N[S].push(O(J[S],$))}}B[j]=D,H.push(D),D++}}const te=S.clone();for(let O=0,B=F.length;O<B;O++){var ie=F[O];const B=S.getAttribute(ie);var re=new B.array.constructor(_[ie]);if(re=new THREE.BufferAttribute(re,B.itemSize,B.normalized),te.addAttribute(ie,re),ie in U)for(let O=0;O<U[ie].length;O++){const B=S.morphAttributes[ie][O];var se=new B.array.constructor(U[ie][O]);se=new THREE.BufferAttribute(se,B.itemSize,B.normalized),te.morphAttributes[ie][O]=se}}return te.setIndex(new THREE.BufferAttribute(new Uint32Array(H),1)),te}static mergeBufferGeometries(S,O=!1){var B=null!==S[0].index;const N=new Set(Object.keys(S[0].attributes)),j={},L=new THREE.BufferGeometry;let D=0;for(let _=0;_<S.length;++_){var F=S[_];let U=0;if(B!=(null!==F.index))throw new Error("mergeBufferGeometries() failed with geometry at index "+_+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them.");if(Object.keys(F.morphAttributes).length)throw new Error("mergeBufferGeometries() failed with geometry at index "+_+". Morph attributes are not supported");for(const S in F.attributes){if(!N.has(S))throw new Error("mergeBufferGeometries() failed with geometry at index "+_+'. All geometries must have compatible attributes; make sure "'+S+'" attribute exists among all geometries, or in none of them.');void 0===j[S]&&(j[S]=[]),j[S].push(F.attributes[S]),U++}if(U!==N.size)throw new Error("mergeBufferGeometries() failed with geometry at index "+_+". Make sure all geometries have the same number of attributes.");if(O){let S;if(B)S=F.index.count;else{if(void 0===F.attributes.position)throw new Error("mergeBufferGeometries() failed with geometry at index "+_+". The geometry must have either an index or a position attribute");S=F.attributes.position.count}L.addGroup(D,S,_),D+=S}}if(B){let O=0;const B=[];for(let N=0;N<S.length;++N){const j=S[N].index;for(let S=0;S<j.count;++S)B.push(j.getX(S)+O);O+=S[N].attributes.position.count}L.setIndex(new THREE.BufferAttribute(new(65535<B.length?Uint32Array:Uint16Array)(B),1))}for(const S in j){var _=this.mergeBufferAttributes(j[S]);if(!_)throw new Error("mergeBufferGeometries() failed while trying to merge the "+S+" attribute.");L.addAttribute(S,_)}return L}static mergeBufferAttributes(S){let O,B,N,j=0;for(let D=0;D<S.length;++D){var L=S[D];if(L.isInterleavedBufferAttribute)throw new Error("mergeBufferAttributes() failed. InterleavedBufferAttributes are not supported.");if(void 0===O&&(O=L.array.constructor),O!==L.array.constructor)throw new Error("mergeBufferAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes.");if(void 0===B&&(B=L.itemSize),B!==L.itemSize)throw new Error("mergeBufferAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes.");if(void 0===N&&(N=L.normalized),N!==L.normalized)throw new Error("mergeBufferAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes.");j+=L.array.length}const D=new O(j);let F=0;for(let O=0;O<S.length;++O)D.set(S[O].array,F),F+=S[O].array.length;return new THREE.BufferAttribute(D,B,N)}})}}}),System.register("engine/gfx/CanvasUtils",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("CanvasUtils",class{static canvasFromRgbImageData(S,O,B){let N=document.createElement("canvas"),j=N.getContext("2d");if(!j)throw new Error("Couldn't acquire canvas 2d context");let L=j.createImageData(O,B);N.width=O,N.height=B;let D=0;for(let O=0,B=S.length;O<B;O+=3)L.data[D]=S[O],L.data[D+1]=S[O+1],L.data[D+2]=S[O+2],L.data[D+3]=255,D+=4;return j.putImageData(L,0,0),N}static canvasFromRgbaImageData(S,O,B){let N=document.createElement("canvas"),j=N.getContext("2d");if(!j)throw new Error("Couldn't acquire canvas 2d context");let L=j.createImageData(O,B);N.width=O,N.height=B;let D=0;for(let O=0,B=S.length;O<B;O+=4)L.data[D]=S[O],L.data[D+1]=S[O+1],L.data[D+2]=S[O+2],L.data[D+3]=S[O+3],D+=4;return j.putImageData(L,0,0),N}static canvasFromIndexedImageData(S,O,B,N){let j=document.createElement("canvas"),L=j.getContext("2d");if(!L)throw new Error("Couldn't acquire canvas 2d context");let D=L.createImageData(O,B);j.width=O,j.height=B;let F=0;return S.forEach(S=>{var{r:O,g:B,b:j}=N.getColor(S);D.data[F++]=O,D.data[F++]=B,D.data[F++]=j,D.data[F++]=S?255:0}),L.putImageData(D,0,0),j}static async canvasToBlob(S){let O=await new Promise(O=>{try{S.toBlob(S=>{O(S)})}catch(S){console.error(S),O(null)}});if(!O){console.warn("Failed to convert canvas to blob. Falling back to dataURL generation.");try{O=this.dataUrlToBlob(S.toDataURL())}catch(S){throw new Error("Failed to generate image from canvas using fallback",{cause:S})}}return O}static dataUrlToBlob(S){if(!(N=S.match(/^data:((.*?)(;charset=.*?)?)(;base64)?,/)))throw new Error("invalid dataURI");var O=N[2]?N[1]:"text/plain"+(N[3]||";charset=utf-8"),B=!!N[4],N=S.slice(N[0].length);let j=(B?atob:decodeURIComponent)(N),L=[];for(let S=0;S<j.length;S++)L.push(j.charCodeAt(S));return new Blob([new Uint8Array(L)],{type:O})}static drawText(S,O,B=0,N=0,{color:j="white",backgroundColor:L,outlineColor:D,outlineWidth:F,fontSize:_,fontFamily:U="Arial, sans-serif",fontWeight:H="normal",borderColor:V,borderWidth:W=0,paddingTop:z=0,paddingBottom:K=0,paddingLeft:$=0,paddingRight:q=0,textAlign:Q="left",width:Z,height:Y,autoEnlargeCanvas:X=!1}){var J=H+` ${_}px `+U;S.font=J;var ee=S.measureText(O),te=S.measureText("A"),ie=te.actualBoundingBoxAscent+te.actualBoundingBoxDescent,re=Math.ceil(Math.max(ee.width,Math.abs(ee.actualBoundingBoxLeft)+Math.abs(ee.actualBoundingBoxRight))),se=re+2*W+$+q;se={x:"right"===Q&&void 0===Z?S.canvas.width-se:B,y:N,width:Z??se,height:Y??ie+2*W+z+K},X&&(se.x+se.width>S.canvas.width||se.y+se.height>S.canvas.height)&&(ie=0<S.canvas.width+S.canvas.height?S.getImageData(0,0,S.canvas.width,S.canvas.height):void 0,se.x+se.width>S.canvas.width&&(S.canvas.width=se.x+se.width),se.y+se.height>S.canvas.height&&(S.canvas.height=se.y+se.height),ie&&S.putImageData(ie,0,0)),L&&(S.fillStyle=L,S.fillRect(se.x,se.y,se.width,se.height)),V&&(S.strokeStyle=V,S.lineWidth=1,S.strokeRect(.5+se.x,.5+se.y,se.width-1,se.height-1)),S.fillStyle=j,S.font=J;let ne=W+$;return"right"===Q?ne=se.width-W-q-re:"center"===Q&&(ne+=Math.floor((se.width-2*W-$-q-re)/2)),ee=ee.actualBoundingBoxAscent+z+(te.actualBoundingBoxAscent-ee.actualBoundingBoxAscent),D&&(S.strokeStyle=D,S.lineWidth=2*(F??1),S.strokeText(O,se.x+ne+.5,se.y+ee,se.width)),S.fillText(O,se.x+ne+.5,se.y+ee,se.width),se}})}}}),System.register("engine/gfx/DebugUtils",["game/Coords","data/Bitmap","three"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("DebugUtils",class{static createWireframe(S,O){return new j.Mesh(this.createBoxGeometry(S,O),new THREE.MeshBasicMaterial({wireframe:!0}))}static createBoxGeometry(S,O,N=!1){var j=B.Coords.getWorldTileSize(),L=S.width*j,D=S.height*j;j=B.Coords.tileHeightToWorld(O);let F=new THREE.BoxBufferGeometry(L,j,D);return N?F.translate(0,j/2,0):F.translate(L/2,j/2,D/2),F}static createIndexedCheckerTex(S,O){let B=new N.IndexedBitmap(64,64,new Uint8Array(4096).fill(S));for(let S=0;S<32;S++)for(let N=0;N<32;N++)B.data[S+64*N]=O,B.data[S+32+64*(N+32)]=O;let j=new THREE.DataTexture(B.data,64,64,THREE.AlphaFormat);return j.needsUpdate=!0,j.minFilter=THREE.NearestFilter,j.magFilter=THREE.NearestFilter,j}})}}}),System.register("engine/gfx/FrustumCuller",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("FrustumCuller",class{cull(S,O){var B=[];return function e(S,O,B,N=0){let j,L=S.children;var D,F=S.visible;if(O.intersectsBox(S.box)){if(S.visible=!0,null!==L)for(j=0,D=L.length;j<D;++j)L[j].isOctree?e(L[j],O,B,N+1):!F&&S.config.skipInvisMatrixUpdate&&L[j].updateMatrixWorld(!1);B.push(S)}else S.visible=!1}(S,O,B),B}})}}}),System.register("engine/gfx/ImageUtils",["data/Bitmap","engine/gfx/CanvasUtils"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("ImageUtils",class e{static async convertShpToPng(S,O){var B=e.convertShpToCanvas(S,O);return await N.CanvasUtils.canvasToBlob(B)}static convertShpToBitmap(S,O,N=!1){let j=0,L=0,D=S.width,F=S.height;D!==F&&N&&(j=D>F?0:Math.floor((F-D)/2),L=D>F?Math.floor((D-F)/2):0,D=F=Math.max(D,F));let _=new B.IndexedBitmap(S.numImages*D,F);for(let O=0;O<S.numImages;O++){var U=S.getImage(O),H=new B.IndexedBitmap(U.width,U.height,U.imageData);_.drawIndexedImage(H,O*D+U.x+j,U.y+L)}return _}static convertShpToCanvas(S,O,B=!1){var j=this.convertShpToBitmap(S,O,B);return N.CanvasUtils.canvasFromIndexedImageData(j.data,j.width,j.height,O)}})}}}),System.register("engine/gfx/MathUtils",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("MathUtils",class{static rotateObjectAboutPoint(S,O,B,N,j=!1){(j=void 0!==j&&j)&&S.parent.localToWorld(S.position),S.position.sub(O),S.position.applyAxisAngle(B,N),S.position.add(O),j&&S.parent.worldToLocal(S.position),S.rotateOnAxis(B,N)}static translateTowardsCamera(S,O,B){var N=(new THREE.Quaternion).setFromEuler(O.rotation);S.setRotationFromQuaternion(N),S.translateZ(B*Math.cos(O.rotation.y)),S.setRotationFromEuler(new THREE.Euler(0,0,0))}})}}}),System.register("engine/gfx/OctreeContainer",["engine/gfx/RenderableContainer","engine/gfx/FrustumCuller","game/Coords"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){D=class e extends B.RenderableContainer{static factory(S){var{near:O,far:B}=S,j=new THREE.Box3(new THREE.Vector3(2*O,2*O,2*O),new THREE.Vector3(2*B,2*B,2*B));let L=new Octree(j,{maxDepth:Math.ceil(Math.log2(2*(B-O)/128)),splitThreshold:10,joinThreshold:5,skipInvisMatrixUpdate:!0});return L.name="octree",O=new N.FrustumCuller,new e(L,O,S)}constructor(S,O,B){super(S),this.autoCull=!0,this.lastCameraPosition=new THREE.Vector3,this.tree=S,this.frustumCuller=O,this.camera=B}update(S,O){super.update(S,O),this.autoCull&&this.cullChildren()}cullChildren(){if(!this.camera.position.equals(this.lastCameraPosition)){this.lastCameraPosition.copy(this.camera.position);var S=this.computeProjectionMatrix();this.camera.updateMatrixWorld(!1),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),S=(new THREE.Matrix4).multiplyMatrices(S,this.camera.matrixWorldInverse);let O=new THREE.Frustum;O.setFromMatrix(S),this.frustumCuller.cull(this.tree,O)}}computeProjectionMatrix(){return L?L.copy(this.camera):L=this.camera.clone(),L.top+=3*j.Coords.LEPTONS_PER_TILE*j.Coords.COS_ISO_CAMERA_BETA,L.bottom-=3*j.Coords.LEPTONS_PER_TILE*j.Coords.COS_ISO_CAMERA_BETA,L.left-=2*j.Coords.LEPTONS_PER_TILE*3*j.Coords.COS_ISO_CAMERA_BETA,L.right+=2*j.Coords.LEPTONS_PER_TILE*3*j.Coords.COS_ISO_CAMERA_BETA,L.updateProjectionMatrix(),L.projectionMatrix}updateChild(S){var O=S.get3DObject();O&&O.parent&&this.tree.updateObject(O)}},S("OctreeContainer",D)}}}),System.register("engine/gfx/OverlayUtils",["engine/gfx/CanvasUtils"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("OverlayUtils",class{static createGroundCircle(S,O){var B=new THREE.LineBasicMaterial({color:O,transparent:!0,depthTest:!1,depthWrite:!1});let N=new THREE.CircleGeometry(S,64);N.vertices.shift(),N.vertices.push(N.vertices[0]);let j=new THREE.Line(N,B);return j.rotation.x=Math.PI/2,j.renderOrder=1e6,j}static createTextBox(S,O){let N=document.createElement("canvas");N.width=N.height=0;var j=N.getContext("2d",{alpha:!O.backgroundColor||!!O.backgroundColor.match(/^rgba/)});return B.CanvasUtils.drawText(j,S,0,0,{...O,autoEnlargeCanvas:!0}),N}})}}}),System.register("engine/gfx/Renderable",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("engine/gfx/RenderableContainer",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("RenderableContainer",class{constructor(S){this.children=new Set,this.renderQueue=[],S&&this.set3DObject(S)}set3DObject(S){this.container=S}get3DObject(){return this.container}getChildren(){return[...this.children]}add(...S){for(var O of S)this.children.has(O)||(this.children.add(O),this.renderQueue.push(O))}remove(...S){for(var O of S){var B;this.children.has(O)&&(this.children.delete(O),-1===(B=this.renderQueue.indexOf(O))?(O=O.get3DObject())&&O.parent&&this.get3DObject().remove(O):this.renderQueue.splice(B,1))}}removeAll(){this.remove(...this.children)}processRenderQueue(){if(!this.get3DObject())throw new Error("A THREE.Object3D must be passed in the constructor or using the setter.");let S;for(;S=this.renderQueue.shift();){S.create3DObject();var O=S.get3DObject();O&&this.get3DObject().add(O)}}create3DObject(){this.processRenderQueue()}update(S,O){for(var B of(this.renderQueue.length&&this.processRenderQueue(),this.children))this.renderQueue.length&&this.processRenderQueue(),B.update(S,O)}})}}}),System.register("engine/gfx/Renderer",["stats.js","util/event","engine/gfx/RendererError"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("Renderer",class{get onFrame(){return this._onFrame.asEvent()}constructor(S,O){this.isContextLost=!1,this._onFrame=new N.EventDispatcher,this.handleContextLost=S=>{S.preventDefault(),this.isContextLost=!0},this.handleContextRestored=()=>{var S=this.renderer.domElement;this.renderer.dispose(),this.renderer=this.createGlRenderer(S),this.isContextLost=!1},this.width=S,this.height=O,this.scenes=new Set}getCanvas(){return this.renderer.domElement}getStats(){return this.stats}supportsInstancing(){if(!this.renderer)throw new Error("Renderer not yet initialized");return!!this.renderer.extensions.get("ANGLE_instanced_arrays")}initStats(S){this.stats||(this.stats=new B.default,this.stats.showPanel(0),this.stats.dom.style.top="auto",this.stats.dom.style.bottom="0px",this.stats.dom.classList.add("stats-layer"),S.appendChild(this.stats.dom))}destroyStats(){this.stats&&(this.stats.dom.parentNode.removeChild(this.stats.dom),this.stats=void 0)}init(S){let O=this.createGlRenderer();S.appendChild(O.domElement);try{const S=O.domElement;S.style.touchAction="none",S.style.overscrollBehavior="none",S.style.userSelect="none",S.style.webkitUserSelect="none",S.style.webkitTouchCallout="none",S.style.msTouchAction="none"}catch{}O.domElement.addEventListener("contextmenu",S=>{S.preventDefault()}),O.domElement.addEventListener("mousedown",S=>{S.preventDefault()}),O.domElement.addEventListener("wheel",S=>{S.stopPropagation()},{passive:!0}),O.domElement.addEventListener("webglcontextlost",this.handleContextLost),O.domElement.addEventListener("webglcontextrestored",this.handleContextRestored),this.renderer=O}createGlRenderer(S){let O;try{O=new THREE.WebGLRenderer({canvas:S,preserveDrawingBuffer:!0,powerPreference:"high-performance"})}catch(S){throw new j.RendererError("Failed to initialize WebGL renderer",{cause:S})}return O.setSize(this.width,this.height),O.autoClear=!1,O.autoClearDepth=!1,O.shadowMap.enabled=!0,O.localClippingEnabled=!0,O.toneMapping=THREE.NoToneMapping,O}setViewportSize(S,O){this.width=S,this.height=O,this.renderer&&this.renderer.setSize(S,O)}addScene(S){this.scenes.add(S),S.create3DObject()}removeScene(S){this.scenes.delete(S)}getScenes(){return[...this.scenes]}update(S,O){this.scenes.forEach(B=>{B.update(S,O)}),this._onFrame.dispatch(this,S)}render(){this.isContextLost||(this.renderer.clear(),this.scenes.forEach(S=>{this.renderer.clearDepth(),this.renderer.setViewport(S.viewport.x,S.viewport.y,S.viewport.width,S.viewport.height),this.renderer.render(S.scene,S.camera)}))}flush(){this.renderer.renderLists.dispose()}destroy(){this.renderer.domElement.remove(),this.renderer.domElement.removeEventListener("webglcontextlost",this.handleContextLost),this.renderer.domElement.removeEventListener("webglcontextrestored",this.handleContextRestored),this.renderer.dispose(),this.destroyStats()}})}}}),System.register("engine/gfx/RendererError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends Error{},S("RendererError",B)}}}),System.register("engine/gfx/Scene",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("engine/gfx/SpriteUtils",["util/math","engine/gfx/BufferGeometryUtils"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){(j=class e{constructor(){this.USE_INDEXED_GEOMETRY=!0,this.VERTICES_PER_SPRITE=this.USE_INDEXED_GEOMETRY?8:12,this.TRIANGLES_PER_SPRITE=4}createSpriteGeometry(S){if("object"!=typeof S)throw new Error("Invalid argument");var O=S.camera,j=S.texture;S.textureArea||(S.textureArea={x:0,y:0,width:j.image.width,height:j.image.height}),S.offset||(S.offset={x:0,y:0});var L=S.textureArea.width,D=S.textureArea.height,F={width:S.texture.image.width,height:S.texture.image.height},_=Math.cos(O.rotation.y)*(S.scale??1),U=_/Math.sin(-O.rotation.x),H=L*_,V=D*(S.flat?U:_);let W;L=(j=S.depth&&!S.flat)&&B.isBetween(-S.offset.x,0,H/_)?-S.offset.x:H/_/2,D=this.createRectGeometry(L*_,V);let z=this.createRectGeometry(H-L*_,V);return this.addRectUvs(D,{...S.textureArea,width:L},F),this.addRectUvs(z,{...S.textureArea,x:S.textureArea.x+L,width:S.textureArea.width-L},F),z.applyMatrix((new THREE.Matrix4).makeTranslation((H-L*_+L*_)/2,0,0)),W=N.BufferGeometryUtils.mergeBufferGeometries([D,z]),W.applyMatrix((new THREE.Matrix4).makeTranslation(-(H/2-L*_/2),0,0)),D=S.align,L=S.offset,W.applyMatrix((new THREE.Matrix4).makeTranslation(D.x*H/2+L.x*_,D.y*V/2-L.y*(S.flat?U:_),0)),j?this.applyDepth(W,O,S.depthOffset??0):S.depth&&S.flat&&S.depthOffset&&this.applyFlatDepth(W,S.depthOffset),j=new THREE.Euler(O.rotation.x,O.rotation.y,0,"YXZ"),W.applyMatrix((new THREE.Matrix4).makeRotationFromEuler(j).multiply(S.flat?(new THREE.Matrix4).makeRotationFromEuler(new THREE.Euler(-O.rotation.x-Math.PI/2,0,0)):(new THREE.Matrix4).identity())),W}createRectGeometry(S,O){return this.USE_INDEXED_GEOMETRY?this.createIndexedRectGeometry(S,O):this.createNonIndexedRectGeometry(S,O)}createNonIndexedRectGeometry(S,O){let B=new THREE.BufferGeometry;var N=new Float32Array([-.5*S,.5*O,0,-.5*S,-.5*O,0,.5*S,.5*O,0,-.5*S,-.5*O,0,.5*S,-.5*O,0,.5*S,.5*O,0]);return B.addAttribute("position",new THREE.BufferAttribute(N,3)),B}createIndexedRectGeometry(S,O){let B=new THREE.BufferGeometry;var N=new Float32Array([-.5*S,.5*O,0,.5*S,.5*O,0,-.5*S,-.5*O,0,.5*S,-.5*O,0]);return B.addAttribute("position",new THREE.BufferAttribute(N,3)),N=new Uint16Array([0,2,1,2,3,1]),B.setIndex(new THREE.BufferAttribute(N,1)),B}addRectUvs(S,O,B){var N=new Float32Array(2*S.getAttribute("position").count);this.USE_INDEXED_GEOMETRY?this.writeIndexedRectUvsIntoBuffer(N,0,O,B):this.writeNonIndexedRectUvsIntoBuffer(N,0,O,B),S.addAttribute("uv",new THREE.BufferAttribute(N,2))}writeNonIndexedRectUvsIntoBuffer(S,O,B,N){var j=B.x/N.width,L=1-(B.y+B.height)/N.height,D=B.width/N.width,F=B.height/N.height;S.set([j,L+F,j,L,j+D,L+F,j,L,j+D,L,j+D,L+F],12*O)}writeIndexedRectUvsIntoBuffer(S,O,B,N){var j=B.x/N.width,L=1-(B.y+B.height)/N.height,D=B.width/N.width,F=B.height/N.height;S.set([j,L+F,j+D,L+F,j,L,j+D,L],8*O)}applyDepth(S,O,B){let N=S.getAttribute("position");for(let S=0,L=N.count;S<L;S++){var j=N.getX(S)*e.MAGIC_DEPTH_SCALE;let L;L=j<0?B-Math.abs(j)/Math.cos(O.rotation.x)*Math.tan(O.rotation.y):B-j/Math.cos(O.rotation.x)/Math.tan(O.rotation.y),N.setZ(S,L)}}applyFlatDepth(S,O){let B=S.getAttribute("position");for(let S=0,N=B.count;S<N;S++)B.setZ(S,O)}}).MAGIC_DEPTH_SCALE=.8,S("SpriteUtils",new j)}}}),System.register("engine/gfx/TextureAtlas",["data/Bitmap"],function(S,O){"use strict";var B;function r(S){let O=S.target;O.isDisposed=!0,O.removeEventListener("dispose",r)}function s(S,O,N,j){let L=new B.IndexedBitmap(O,N);return S.forEach(S=>{if(!S.fit)throw new Error("Couldn't fit all images in a single texture");var O=S.image,B=S.fit.x,N=S.fit.y;j?.set(O,{x:B,y:N,width:S.w,height:S.h}),L.drawIndexedImage(O,B,N)}),L}return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("TextureAtlas",class{getTexture(){if(!this.texture)throw new Error("Texture atlas not initialized");return this.texture}getImageRect(S){if(!this.imageRects)throw new Error("Texture atlas not initialized");var O=this.imageRects.get(S);if(!O)throw new Error("Image not found in atlas");return O}pack(S){let O=[];S.forEach(S=>{O.push({w:S.width+S.width%2,h:S.height+S.height%2,image:S})}),O.sort((S,O)=>1e4*(O.w-S.w)+O.h-S.h);let B=new GrowingPacker;B.fit(O);var N,j,L,D=B.root.w,F=B.root.h,_=new Map,U=s(O,D,F,_);let H=new THREE.DataTexture(U.data,D,F,THREE.AlphaFormat);H.needsUpdate=!0,H.flipY=!0,H.minFilter=THREE.NearestFilter,H.magFilter=THREE.NearestFilter,H.onUpdate=(N=O,j=D,L=F,S=>{S.image={width:S.image.width,height:S.image.height,get data(){return S.isDisposed?new Uint8Array(this.width*this.height):(console.log("TextureAtlas: Rebuilding texture for upload to GPU..."),s(N,j,L).data)}},S.addEventListener("dispose",r)}),this.width=D,this.height=F,this.imageRects=_,this.texture=H}dispose(){this.texture?.dispose()}})}}}),System.register("engine/gfx/TextureUtils",["data/Bitmap","util/math","engine/gfx/CanvasUtils","engine/gfx/drawable/PalDrawable"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("TextureUtils",D=class e{static textureFromPalette(S){var O=S.hash,B=e.cache.get(O);return B||(B=new L.PalDrawable(S).draw(),B=this.textureFromPalBitmap(B),e.cache.set(O,B),B)}static textureFromPalettes(S){if(!S.length)throw new Error("At least one palette is required");var O=N.fnv32a(S.map(S=>S.hash));if(F=e.cache.get(O))return F;let j;var D,F=S.map(S=>new L.PalDrawable(S).draw());j=new B.RgbaBitmap(F[0].width,F.length);let _=0;for(D of F)j.drawRgbaImage(D,0,_++);return F=this.textureFromPalBitmap(j),e.cache.set(O,F),F}static textureFromPalBitmap(S){var O=j.CanvasUtils.canvasFromRgbaImageData(S.data,S.width,S.height);let B=new THREE.Texture(O);return B.minFilter=THREE.NearestFilter,B.magFilter=THREE.NearestFilter,B.needsUpdate=!0,B.flipY=!1,B}}),D.cache=new Map}}}),System.register("engine/gfx/batch/BatchedMesh",[],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("BatchMode",B={}))[O.Instancing=0]="Instancing",O[O.Merging=1]="Merging",N=class extends THREE.Mesh{constructor(S,O,N=B.Instancing){super(S,O),this.geometry=S,this.material=O,this.batchMode=N,this.isBatchedMesh=!0,this.castShadow=!1,this.opacity=1,this.extraLight=new THREE.Vector3(0,0,0),this.paletteIndex=0,this.clippingPlanes=[],this.clippingPlanesHash="",this.layers.disable(0)}getOpacity(){return this.opacity}setOpacity(S){this.opacity=S}getExtraLight(){return this.extraLight}setExtraLight(S){this.extraLight=S}getPaletteIndex(){return this.paletteIndex}setPaletteIndex(S){this.paletteIndex=S}getClippingPlanes(){return this.clippingPlanes}setClippingPlanes(S){this.clippingPlanes=S,this.updateClippingPlanesHash(S)}updateClippingPlanesHash(S){this.clippingPlanesHash=S.map(S=>[...S.normal.toArray(),S.constant]).flat().join(",")}getClippingPlanesHash(){return this.clippingPlanesHash}},S("BatchedMesh",N)}}}),System.register("engine/gfx/batch/InstancedMesh",[],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[],execute:function(){(B=new THREE.MeshDepthMaterial).depthPacking=THREE.RGBADepthPacking,B.clipping=!0,B.defines={INSTANCE_TRANSFORM:""},D=THREE.ShaderLib.distanceRGBA,N=THREE.UniformsUtils.clone(D.uniforms),j={USE_SHADOWMAP:"",INSTANCE_TRANSFORM:""},L=new THREE.ShaderMaterial({defines:j,uniforms:N,vertexShader:D.vertexShader,fragmentShader:D.fragmentShader,clipping:!0}),D=class extends THREE.Mesh{constructor(S,O,N,j,D=!1){super((new THREE.InstancedBufferGeometry).copy(S)),this.maxInstances=N,this.uniformScale=j,this.useInstanceColor=D,this.initAttributes(this.geometry),this.material=this.decorateMaterial(O.clone()),this.frustumCulled=!1,this.customDepthMaterial=B,this.customDistanceMaterial=L}initAttributes(S){let O=[];for(let S=0;S<4;S++)O.push({name:"instanceMatrix"+S,data:new Float32Array(4*this.maxInstances),itemSize:4,normalized:!0});for(var{name:B,data:N,itemSize:j,normalized:L}of(this.useInstanceColor&&O.push({name:"instanceColor",data:new Uint8Array(3*this.maxInstances),itemSize:3,normalized:!0}),O.push({name:"instanceOpacity",data:new Float32Array(this.maxInstances).fill(1),itemSize:1,normalized:!0}),O)){let O=new THREE.InstancedBufferAttribute(N,j,L,1);O.dynamic=!0,S.addAttribute(B,O)}this.instanceMatrixAttributes=new Array(4).fill(0).map((O,B)=>S.getAttribute("instanceMatrix"+B))}decorateMaterial(S){let O=S;return O.defines??(O.defines={}),O.defines.INSTANCE_TRANSFORM="",this.uniformScale?O.defines.INSTANCE_UNIFORM="":delete O.defines.INSTANCE_UNIFORM,this.useInstanceColor?O.defines.INSTANCE_COLOR="":delete O.defines.INSTANCE_COLOR,O.defines.INSTANCE_OPACITY="",S}setRenderCount(S){if(S>this.maxInstances)throw new RangeError("Exceeded maximum number of instances");this.geometry.maxInstancedCount=S}setMatrixAt(S,O){for(let N=0;N<4;N++){var B=4*N;this.instanceMatrixAttributes[N].setXYZW(S,O.elements[B++],O.elements[B++],O.elements[B++],O.elements[+B])}}updateFromMeshes(S){var O,B=!!S[0].material.palette,N=this.geometry.attributes;let j=N.instanceOpacity,L=N.instancePaletteOffset,D=N.instanceExtraLight;for(let O=0,N=S.length;O<N;O++){let N=S[O];this.setMatrixAt(O,N.matrixWorld);var F,_,U=N.getOpacity();j.getX(O)!==U&&(j.setX(O,U),j.needsUpdate=!0),B&&(F=N.getPaletteIndex(),L.getX(O)!==F&&(L.setX(O,F),L.needsUpdate=!0),_=N.getExtraLight(),U=Math.fround(_.x),F=Math.fround(_.y),_=Math.fround(_.z),U===D.getX(O)&&F===D.getY(O)&&_===D.getZ(O)||(D.setXYZ(O,U,F,_),D.needsUpdate=!0))}for(O of(this.setRenderCount(S.length),this.instanceMatrixAttributes))O.needsUpdate=!0}dispose(){this.geometry.dispose(),this.material.dispose()}},S("InstancedMesh",D)}}}),System.register("engine/gfx/batch/MergedSpriteMesh",["util/array","engine/gfx/material/PaletteBasicMaterial"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=new THREE.Vector3,L=new THREE.Vector4,D=class e extends THREE.Mesh{static createMergedGeometry(S,O,B){let j=new THREE.BufferGeometry;for(var L of Object.keys(S.attributes)){let B=S.getAttribute(L);var D=new B.array.constructor(O*B.array.length);j.addAttribute(L,new THREE.BufferAttribute(D,B.itemSize,B.normalized))}var F,_=S.getAttribute("position").count;for(F of(B instanceof N.PaletteBasicMaterial&&j.addAttribute("vertexColorMult",new THREE.BufferAttribute(new Float32Array(_*O*4),4)),B.palette&&j.addAttribute("vertexPaletteOffset",new THREE.BufferAttribute(new Float32Array(_*O),1)),Object.values(j.attributes)))F.setDynamic(!0);if(S.index){j.setIndex(new THREE.BufferAttribute(new Uint32Array(O*S.index.array.length),1));for(let B=0;B<O;B++){let O=B*_;j.index.array.set(Uint32Array.from(S.index.array,S=>S+O),B*S.index.array.length)}}return j}constructor(S,O,B){super(e.createMergedGeometry(S,B,O)),this.maxInstances=B,this.material=this.decorateMaterial(O.clone()),this.verticesPerItem=S.getAttribute("position").count,this.indicesPerItem=S.index?.count,this.frustumCulled=!1}decorateMaterial(S){let O=S;return O.defines??(O.defines={}),S.palette&&(O.defines.VERTEX_PALETTE_OFFSET=""),S instanceof N.PaletteBasicMaterial&&(O.useVertexColorMult=!0),S}updateFromMeshes(S){var O,B=this.geometry.attributes,N=B.position,D=B.uv,F=B.vertexColorMult,_=B.vertexPaletteOffset,U=S.length;if(U>this.maxInstances)throw new RangeError("Exceeded maximum number of instances");for(let O=0;O<U;O++){var H=O*this.verticesPerItem;let B=S[O];this.setGeometryAt(H,B.geometry,j.setFromMatrixPosition(B.matrixWorld),N,D);var V=B.getExtraLight();F&&this.setColorMultAt(H,L.set(1+V.x,1+V.y,1+V.z,B.getOpacity()),F),_&&this.setPaletteIndexAt(H,B.getPaletteIndex(),_)}for(O of(this.geometry.setDrawRange(0,U*(this.geometry.index?this.indicesPerItem:this.verticesPerItem)),Object.values(B)))O.dynamic&&(O.updateRange.count=U<this.maxInstances?U*this.verticesPerItem*O.itemSize:-1)}setGeometryAt(S,O,N,j,L){var D=O.attributes,F=D.position.array;let _=j.array;for(let O=0;O<this.verticesPerItem;O++){var U=3*(S+O),H=Math.fround(F[3*O]+Math.fround(N.x)),V=Math.fround(F[3*O+1]+Math.fround(N.y)),W=Math.fround(F[3*O+2]+Math.fround(N.z));H===_[U]&&V===_[1+U]&&W===_[2+U]||(_[U]=H,_[1+U]=V,_[2+U]=W,j.needsUpdate=!0)}let z=L.array;D=D.uv.array,B.equals(D,z.subarray(2*S,2*S+D.length))||(z.set(D,2*S),L.needsUpdate=!0)}setColorMultAt(S,O,B){if(B.getX(S)!==O.x||B.getY(S)!==O.y||B.getZ(S)!==O.z||B.getW(S)!==O.w){B.needsUpdate=!0;for(let N=0;N<this.verticesPerItem;N++)B.setXYZW(S+N,O.x,O.y,O.z,O.w)}}setPaletteIndexAt(S,O,B){if(B.getX(S)!==O){B.needsUpdate=!0;for(let N=0;N<this.verticesPerItem;N++)B.setX(S+N,O)}}dispose(){this.geometry.dispose(),this.material.dispose()}},S("MergedSpriteMesh",D)}}}),System.register("engine/gfx/batch/MeshBatchManager",["engine/gfx/batch/BatchedMesh","engine/gfx/batch/MeshInstancingBatch","engine/gfx/RenderableContainer","engine/gfx/batch/MeshMergingBatch"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends j.RenderableContainer{constructor(S){super(),this.renderableContainer=S,this.batches=new Map}create3DObject(){let S=this.get3DObject();S||(S=new THREE.Object3D,S.name="mesh_batch_manager",S.matrixAutoUpdate=!1,this.set3DObject(S)),super.create3DObject()}updateMeshes(){var S=this.renderableContainer.get3DObject();S&&(S=this.collectMeshes(S),S=this.fillBatches(this.groupMeshesByBatchKey(S)),this.cleanUnusedBatches(S))}collectMeshes(S){let O=[];return S.traverseVisible(S=>{S.isBatchedMesh&&O.push(S)}),O}fillBatches(S){let O=new Map([...this.batches.keys()].map(S=>[S,0]));for(var[j,D]of S){let S=this.batches.get(j),U=0;for(;D.length;){var F=D[0].batchMode===B.BatchMode.Instancing,_=F?1024:128;let O=D.splice(0,_),H=S?.[U];H||(S||(S=[],this.batches.set(j,S)),H=new(F?N.MeshInstancingBatch:L.MeshMergingBatch)(_),H.castShadow=O[0].castShadow,H.receiveShadow=O[0].receiveShadow,H.renderOrder=O[0].renderOrder,H.clippingPlanes=O[0].getClippingPlanes(),S.push(H),this.add(H),this.processRenderQueue()),H.setMeshes(O),U++}O.set(j,U)}return O}cleanUnusedBatches(S){for(var[O,B]of S){let S=this.batches.get(O);if(S){var N;for(N of S.splice(B))this.remove(N),N.dispose();S.length||this.batches.delete(O)}}}groupMeshesByBatchKey(S){let O=new Map;for(let j=0,L=S.length;j<L;j++){var B=S[j],N=this.getBatchKey(B);let L=O.get(N);L||(L=[],O.set(N,L)),L.push(B)}return O}getBatchKey(S){return S.batchMode+"_"+(S.batchMode===B.BatchMode.Instancing?S.geometry.uuid:S.geometry.attributes.position.count)+"_"+S.material.uuid+"_"+Number(S.castShadow)+"_"+S.renderOrder+"_"+Number(S.receiveShadow)+"_"+S.getClippingPlanesHash()}dispose(){this.batches.forEach(S=>S.forEach(S=>S.dispose()))}},S("MeshBatchManager",D)}}}),System.register("engine/gfx/batch/MeshInstancingBatch",["engine/gfx/batch/InstancedMesh"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("MeshInstancingBatch",class{get castShadow(){return this._castShadow}set castShadow(S){this._castShadow=S,this.instancedMesh&&(this.instancedMesh.castShadow=S)}get receiveShadow(){return this._receiveShadow}set receiveShadow(S){this._receiveShadow=S,this.instancedMesh&&(this.instancedMesh.receiveShadow=S)}get clippingPlanes(){return this._clippingPlanes}set clippingPlanes(S){this._clippingPlanes=S,this.instancedMesh&&(this.instancedMesh.material.clippingPlanes=S)}get renderOrder(){return this._renderOrder}set renderOrder(S){this._renderOrder=S,this.instancedMesh&&(this.instancedMesh.renderOrder=S)}constructor(S){this.maxInstances=S,this._castShadow=!1,this._receiveShadow=!1,this._clippingPlanes=[],this._renderOrder=0}get3DObject(){return this.target}create3DObject(){if(!this.target){let S=new THREE.Object3D;S.matrixAutoUpdate=!1,this.target=S,this.instancedMesh&&S.add(this.instancedMesh)}}setMeshes(S){if(S.length>this.maxInstances)throw new RangeError("Meshes array exceeds max number of instances");var O;S.length?(O=!!S[0].material.palette,this.instancedMesh||(this.instancedMesh=new B.InstancedMesh(S[0].geometry,S[0].material,this.maxInstances,!0),this.instancedMesh.castShadow=this._castShadow,this.instancedMesh.renderOrder=this._renderOrder,this.instancedMesh.material.clippingPlanes=this._clippingPlanes,O&&(this.instancedMesh.geometry.addAttribute("instancePaletteOffset",new THREE.InstancedBufferAttribute(new Float32Array(this.maxInstances),1)),this.instancedMesh.geometry.addAttribute("instanceExtraLight",new THREE.InstancedBufferAttribute(new Float32Array(3*this.maxInstances),3))),this.target?.add(this.instancedMesh)),this.instancedMesh.updateFromMeshes(S)):this.instancedMesh&&(this.target?.remove(this.instancedMesh),this.instancedMesh.dispose(),this.instancedMesh=void 0)}update(){}dispose(){this.instancedMesh?.dispose()}})}}}),System.register("engine/gfx/batch/MeshMergingBatch",["engine/gfx/batch/MergedSpriteMesh"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("MeshMergingBatch",class{get castShadow(){return this._castShadow}set castShadow(S){this._castShadow=S,this.mergedGeoMesh&&(this.mergedGeoMesh.castShadow=S)}get receiveShadow(){return this._receiveShadow}set receiveShadow(S){this._receiveShadow=S,this.mergedGeoMesh&&(this.mergedGeoMesh.receiveShadow=S)}get clippingPlanes(){return this._clippingPlanes}set clippingPlanes(S){this._clippingPlanes=S,this.mergedGeoMesh&&(this.mergedGeoMesh.material.clippingPlanes=S)}get renderOrder(){return this._renderOrder}set renderOrder(S){this._renderOrder=S,this.mergedGeoMesh&&(this.mergedGeoMesh.renderOrder=S)}constructor(S){this.maxInstances=S,this._castShadow=!1,this._receiveShadow=!1,this._clippingPlanes=[],this._renderOrder=0}get3DObject(){return this.target}create3DObject(){if(!this.target){let S=new THREE.Object3D;S.matrixAutoUpdate=!1,this.target=S,this.mergedGeoMesh&&S.add(this.mergedGeoMesh)}}setMeshes(S){if(S.length>this.maxInstances)throw new RangeError("Meshes array exceeds max number of instances");S.length?(this.mergedGeoMesh||(this.mergedGeoMesh=new B.MergedSpriteMesh(S[0].geometry,S[0].material,this.maxInstances),this.mergedGeoMesh.castShadow=this._castShadow,this.mergedGeoMesh.receiveShadow=this._receiveShadow,this.mergedGeoMesh.renderOrder=this._renderOrder,this.mergedGeoMesh.material.clippingPlanes=this._clippingPlanes,this.target?.add(this.mergedGeoMesh)),this.mergedGeoMesh.updateFromMeshes(S)):this.mergedGeoMesh&&(this.target?.remove(this.mergedGeoMesh),this.mergedGeoMesh.dispose(),this.mergedGeoMesh=void 0)}update(){}dispose(){this.mergedGeoMesh?.dispose()}})}}}),System.register("engine/gfx/drawable/PalDrawable",["data/Bitmap"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("PalDrawable",class{constructor(S){this.pal=S}draw(){var S=this.pal.size;let O=new B.RgbaBitmap(S,1),N=0;for(let B=0,L=S;B<L;++B){var j=this.pal.getColor(B);O.data[N]=j.r,O.data[N+1]=j.g,O.data[N+2]=j.b,O.data[N+3]=B?255:0,N+=4}return O}})}}}),System.register("engine/gfx/drawable/TmpDrawable",["data/Bitmap"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("TmpDrawable",class{drawTileBlock(S,O,B,N,j,L){let D=O.data;var F=N/2;let _=B/2-2+O.width*L+j;var U=O.width*O.height;let H=0,V=0,W=0;for(;V<F;V++){W+=4;for(let O=0;O<W;O++){var z=S.tileData[H];0!==z&&0<=_&&_<U&&(D[_]=z),_++,H++}_+=O.width-(W+2)}for(_+=4;V<N;V++){W-=4;for(let O=0;O<W;O++){var K=S.tileData[H];0<=_&&_<U&&(D[_]=K),_+=1,H++}_+=O.width-(W-2)}}draw(S,O,N){let j=O,L=N,D=0,F=0;S.hasExtraData&&(D+=Math.max(0,S.x-S.extraX),F+=Math.max(0,S.y-S.extraY),j+=Math.max(0,S.x-S.extraX),L+=Math.max(0,S.y-S.extraY));var _=new B.IndexedBitmap(j,L);return this.drawTileBlock(S,_,O,N,D,F),S.hasExtraData&&this.drawExtraData(S,_),_}drawExtraData(S,O){if(S.hasExtraData){let _=O.data;var B=O.width,N=O.height,j=Math.max(0,S.extraX-S.x),L=B,D=B*N;let U=0+L*Math.max(0,S.extraY-S.y)+j,H=0;for(let O=0;O<S.extraHeight;O++){for(let O=0;O<S.extraWidth;O++){var F=S.extraData[H];0!==F&&0<=U&&U<D&&(_[U]=F),U+=1,H++}U+=L-S.extraWidth}}}})}}}),System.register("engine/gfx/geometry/BufferGeometrySerializer",["data/DataStream"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("BufferGeometrySerializer",class{serialize(S){if(Object.keys(S.morphAttributes).length)throw new Error("Morph attributes are not supported");if(1<S.groups.length)throw new Error("Groups are not supported");var O,N=Object.keys(S.attributes),j=S.index,L=1+22*N.length+Object.values(S.attributes).map(S=>this.getTypedArrayByteSize(S.array)).reduce((S,O)=>S+O,0)+1+(j?this.getTypedArrayByteSize(j.array):0);let D=new B.DataStream(new ArrayBuffer(L));for(O of(D.writeUint8(N.length),N)){var F=S.getAttribute(O);D.writeCString(O,20),D.writeUint8(F.itemSize),D.writeUint8(Number(F.normalized)),this.writeTypedArray(D,F.array)}return D.writeUint8(Number(Boolean(j))),j&&this.writeTypedArray(D,j.array),D.seek(0),D.dynamicSize=!1,D.buffer}unserialize(S){let O=new THREE.BufferGeometry;var B,N=S.readUint8();for(let B=0;B<N;B++){var j=S.readCString(20),L=S.readUint8(),D=Boolean(S.readUint8()),F=this.readTypedArray(S);D=new THREE.BufferAttribute(F,L,D),O.addAttribute(j,D)}return Boolean(S.readUint8())&&(B=this.readTypedArray(S),O.setIndex(new THREE.BufferAttribute(B,1))),O}writeTypedArray(S,O){if(S.writeUint32(O.length),O instanceof Float32Array)S.writeUint8(0),S.writeFloat32Array(O);else if(O instanceof Uint32Array)S.writeUint8(1),S.writeUint32Array(O);else{if(!(O instanceof Uint16Array))throw new Error(`Unsupported array type "${O.constructor.name}"`);S.writeUint8(2),S.writeUint16Array(O)}}readTypedArray(S){var O=S.readUint32(),B=S.readUint8();switch(B){case 0:return S.readFloat32Array(O);case 1:return S.readUint32Array(O);case 2:return S.readUint16Array(O);default:throw new Error(`Unsupported array type "${B}"`)}}getTypedArrayByteSize(S){return 5+S.BYTES_PER_ELEMENT*S.length}})}}}),System.register("engine/gfx/geometry/VxlGeometryCache",["data/DataStream","data/vfs/VirtualFile","engine/gfx/geometry/BufferGeometrySerializer","data/vfs/FileNotFoundError"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("VxlGeometryCache",D=class e{constructor(S,O){this.cacheDir=S,this.activeMod=O,this.geometries=new Map}async loadFromStorage(S,O){let B=this.geometries.get(S);if(!B){let F=this.cacheDir;if(F){var N=this.getCacheFileName(O,S.name);try{var D=await F.openFile(N);B=(new j.BufferGeometrySerializer).unserialize(D.stream),this.set(S,B)}catch(S){S instanceof L.FileNotFoundError||console.error(`Failed to load buffer geometry from cache file "${N}"`,S)}}}return B}async persistToStorage(S,O,L){this.geometries.has(S)||this.set(S,(new j.BufferGeometrySerializer).unserialize(new B.DataStream(L))),await(this.cacheDir?.writeFile(new N.VirtualFile(new B.DataStream(L),this.getCacheFileName(O,S.name))))}async clearStorage(){await this.clearStorageFiles()}async clearOtherModStorage(){let S=e.cacheFilePrefix+this.getModPrefix();await this.clearStorageFiles(O=>!O.startsWith(S))}async clearStorageFiles(S=()=>!0){let O=this.cacheDir;if(O)for await(var B of O.getEntries())B.startsWith(e.cacheFilePrefix)&&S(B)&&await O.deleteFile(B)}getCacheFileName(S,O){var B=this.getModPrefix();return""+e.cacheFilePrefix+B+S.replace(".vxl","")+"_"+O}getModPrefix(){return this.activeMod?this.activeMod+"#":"#"}clear(){this.geometries.forEach(S=>{for(var O of(S.dispose(),Object.keys(S.attributes)))S.removeAttribute(O)}),this.geometries.clear()}get(S){return this.geometries.get(S)}set(S,O){this.geometries.set(S,O)}}),D.cacheFilePrefix="geocache_"}}}),System.register("engine/gfx/lighting/LightingDirector",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("LightingDirector",class{constructor(S,O,B){this.lighting=S,this.renderer=O,this.gameSpeed=B,this.effects=[],this.onFrame=S=>{if(this.effects.length){let O=!1;this.effects.slice().forEach((B,N)=>{B.isRunning||(B.isRunning=!0,B.startTime=S,B.mapLighting.copy(this.lighting.getBaseAmbient()));var j=B.update(S,this.gameSpeed.value);j.done&&(this.effects.splice(this.effects.indexOf(B),1),N||(O=!0)),N||j.updated&&this.lighting.applyAmbientOverride(B.mapLighting)}),this.effects.length?O&&this.lighting.applyAmbientOverride(this.effects[0].mapLighting):this.lighting.applyAmbientOverride(void 0)}}}init(){this.renderer.onFrame.subscribe(this.onFrame)}addEffect(S){this.effects.push(S),this.effects.sort((S,O)=>O.priority-S.priority)}dispose(){this.renderer.onFrame.unsubscribe(this.onFrame)}})}}}),System.register("engine/gfx/lighting/LightingFx",["data/map/MapLighting"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){var O;(O=N||S("LightingFxPriority",N={}))[O.Normal=0]="Normal",O[O.High=1]="High",S("LightingFx",class{constructor(){this.priority=N.Normal,this.mapLighting=new B.MapLighting,this.isRunning=!1}update(S,O){return{done:!0}}})}}}),System.register("engine/gfx/lighting/LightningStormFx",["engine/gfx/lighting/LightingFx"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.LightingFx{constructor(S,O){super(),this.durationGameSeconds=S,this.ionLighting=O,this.cloudAnims=[]}waitForCloudAnim(S){this.cloudAnims.push(S)}update(S,O){let B=!1,N=!1;return S===this.startTime&&(this.mapLighting.copy(this.ionLighting),B=!0),(S-this.startTime)/1e3*O>this.durationGameSeconds&&!this.cloudAnims.some(S=>!S.isAnimFinished())&&(N=!0),{done:N,updated:B}}},S("LightningStormFx",N)}}}),System.register("engine/gfx/lighting/NukeLightingFx",["engine/gfx/lighting/LightingFx"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.LightingFx{constructor(){super(),this.priority=B.LightingFxPriority.High}update(S,O){let B=!1,N=!1;this.initialAmbient??(this.initialAmbient=this.mapLighting.ambient);let j,L=(S-this.startTime)/1e3*O;var D;return 3.3<=L?(L-=3.3,D=Math.min(1,L/.5),j=this.initialAmbient+1.5*(1-D),1===D&&(N=!0)):L<.3&&(D=L/.3,j=this.initialAmbient+1.5*D),void 0!==j&&this.mapLighting.ambient!==j&&(B=!0,this.mapLighting.ambient=j),{done:N,updated:B}}},S("NukeLightingFx",N)}}}),System.register("engine/gfx/material/PaletteBasicMaterial",["engine/gfx/material/paletteShaderLib"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N={uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,B.paletteShaderLib.uniforms]),vertexShader:THREE.ShaderChunk.meshbasic_vert.replace("#include <common>","#include <common>\n"+[B.paletteShaderLib.instanceParsVertex,B.paletteShaderLib.paletteColorParsVertex,B.paletteShaderLib.vertexColorMultParsVertex].join("\n")).replace("void main() {","void main() {\n"+[B.paletteShaderLib.instanceVertex,B.paletteShaderLib.paletteColorVertex,B.paletteShaderLib.vertexColorMultVertex].join("\n")),fragmentShader:THREE.ShaderChunk.meshbasic_frag.replace("#include <common>","#include <common>\n"+[B.paletteShaderLib.paletteColorParsFrag,B.paletteShaderLib.vertexColorMultParsFrag].join("\n")).replace("#include <color_fragment>","#include <color_fragment>\n"+[B.paletteShaderLib.paletteColorFrag,B.paletteShaderLib.paletteBasicLightFragment,B.paletteShaderLib.vertexColorMultFrag].join("\n"))},j=class extends THREE.MeshBasicMaterial{get palette(){return this.uniforms.palette.value}set palette(S){this.uniforms.palette.value=S}get paletteOffset(){return this.uniforms.paletteOffsetCount.value[0]}set paletteOffset(S){this.uniforms.paletteOffsetCount.value[0]=S}get paletteCount(){return this.uniforms.paletteOffsetCount.value[1]}set paletteCount(S){this.uniforms.paletteOffsetCount.value[1]=S}get extraLight(){return this.uniforms.extraLight.value}set extraLight(S){this.uniforms.extraLight.value=S}set useVertexColorMult(S){S?(this.defines??(this.defines={}),this.defines.USE_VERTEX_COLOR_MULT=""):this.defines&&delete this.defines.USE_VERTEX_COLOR_MULT}constructor({palette:S,paletteCount:O,paletteOffset:B,extraLight:j,useVertexColorMult:L,...D}={}){super(D),this.uniforms=THREE.UniformsUtils.clone(N.uniforms),S&&(this.palette=S),O&&(this.paletteCount=O),B&&(this.paletteOffset=B),j&&this.extraLight.copy(j),L&&(this.useVertexColorMult=L),this.vertexShader=N.vertexShader,this.fragmentShader=N.fragmentShader,this.type="PaletteBasicMaterial"}copy(S){return super.copy(S),this.fragmentShader=S.fragmentShader,this.vertexShader=S.vertexShader,this.uniforms=THREE.UniformsUtils.clone(S.uniforms),this.palette=S.palette,this}},S("PaletteBasicMaterial",j)}}}),System.register("engine/gfx/material/PaletteLambertMaterial",["engine/gfx/material/paletteShaderLib"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N={uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.lambert.uniforms,B.paletteShaderLib.uniforms]),vertexShader:THREE.ShaderChunk.meshlambert_vert.replace("#include <common>","#include <common>\n"+B.paletteShaderLib.instanceParsVertex).replace("void main() {","void main() {\n"+B.paletteShaderLib.instanceVertex),fragmentShader:THREE.ShaderChunk.meshlambert_frag.replace("#include <common>","#include <common>\n"+B.paletteShaderLib.paletteColorParsFrag).replace("#include <color_fragment>","#include <color_fragment>\n"+B.paletteShaderLib.paletteColorFrag).replace("#include <lights_fragment_end>","#include <lights_fragment_end>\n"+B.paletteShaderLib.paletteFullLightFragment)},j=class extends THREE.MeshLambertMaterial{get palette(){return this.uniforms.palette.value}set palette(S){this.uniforms.palette.value=S}get paletteOffset(){return this.uniforms.paletteOffsetCount.value[0]}set paletteOffset(S){this.uniforms.paletteOffsetCount.value[0]=S}get paletteCount(){return this.uniforms.paletteOffsetCount.value[1]}set paletteCount(S){this.uniforms.paletteOffsetCount.value[1]=S}get extraLight(){return this.uniforms?.extraLight.value}set extraLight(S){this.uniforms.extraLight.value=S}constructor({palette:S,paletteCount:O,paletteOffset:B,extraLight:j,...L}={}){super(L),this.uniforms=THREE.UniformsUtils.clone(N.uniforms),S&&(this.palette=S),O&&(this.paletteCount=O),B&&(this.paletteOffset=B),j&&this.extraLight.copy(j),this.vertexShader=N.vertexShader,this.fragmentShader=N.fragmentShader,this.type="PaletteLambertMaterial"}copy(S){return super.copy(S),this.fragmentShader=S.fragmentShader,this.vertexShader=S.vertexShader,this.uniforms=THREE.UniformsUtils.clone(S.uniforms),this.palette=S.palette,this}},S("PaletteLambertMaterial",j)}}}),System.register("engine/gfx/material/PalettePhongMaterial",["engine/gfx/material/paletteShaderLib"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N={uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.phong.uniforms,B.paletteShaderLib.uniforms]),vertexShader:THREE.ShaderChunk.meshphong_vert.replace("#include <common>","#include <common>\n"+B.paletteShaderLib.instanceParsVertex).replace("void main() {","void main() {\n"+B.paletteShaderLib.instanceVertex),fragmentShader:THREE.ShaderChunk.meshphong_frag.replace("#include <common>","#include <common>\n"+B.paletteShaderLib.paletteColorParsFrag).replace("#include <color_fragment>","#include <color_fragment>\n"+B.paletteShaderLib.paletteColorFrag).replace("#include <lights_fragment_end>","#include <lights_fragment_end>\n"+B.paletteShaderLib.paletteFullLightFragment)},j=class extends THREE.MeshPhongMaterial{get palette(){return this.uniforms.palette.value}set palette(S){this.uniforms.palette.value=S}get paletteOffset(){return this.uniforms.paletteOffsetCount.value[0]}set paletteOffset(S){this.uniforms.paletteOffsetCount.value[0]=S}get paletteCount(){return this.uniforms.paletteOffsetCount.value[1]}set paletteCount(S){this.uniforms.paletteOffsetCount.value[1]=S}get extraLight(){return this.uniforms?.extraLight.value}set extraLight(S){this.uniforms.extraLight.value=S}constructor({palette:S,paletteCount:O,paletteOffset:B,extraLight:j,...L}={}){super(L),this.uniforms=THREE.UniformsUtils.clone(N.uniforms),S&&(this.palette=S),O&&(this.paletteCount=O),B&&(this.paletteOffset=B),j&&this.extraLight.copy(j),this.vertexShader=N.vertexShader,this.fragmentShader=N.fragmentShader,this.type="PalettePhongMaterial"}copy(S){return super.copy(S),this.fragmentShader=S.fragmentShader,this.vertexShader=S.vertexShader,this.uniforms=THREE.UniformsUtils.clone(S.uniforms),this.palette=S.palette,this}},S("PalettePhongMaterial",j)}}}),System.register("engine/gfx/material/paletteShaderLib",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("paletteShaderLib",{uniforms:{palette:{type:"t",value:null},paletteOffsetCount:{value:[0,1]},extraLight:{value:new THREE.Vector3(0,0,0)}},instanceParsVertex:"\n#ifdef INSTANCE_TRANSFORM\n    attribute float instancePaletteOffset;\n    varying float vInstancePaletteOffset;\n    attribute vec3 instanceExtraLight;\n    varying vec3 vInstanceExtraLight;\n#endif\n",instanceVertex:"\n  #ifdef INSTANCE_TRANSFORM\n    vInstancePaletteOffset = instancePaletteOffset;\n    vInstanceExtraLight = instanceExtraLight;\n  #endif\n",paletteColorParsVertex:"\n#ifdef VERTEX_PALETTE_OFFSET\n    attribute float vertexPaletteOffset;\n    varying float vVertexPaletteOffset;\n#endif\n",paletteColorVertex:"\n  #ifdef VERTEX_PALETTE_OFFSET\n    vVertexPaletteOffset = vertexPaletteOffset;\n  #endif\n",paletteColorParsFrag:"\nuniform sampler2D palette;\n#ifdef VERTEX_PALETTE_OFFSET\n    varying float vVertexPaletteOffset;\n#endif\nuniform vec2 paletteOffsetCount;\nuniform vec3 extraLight;\n\n#ifdef INSTANCE_TRANSFORM\nvarying float vInstancePaletteOffset;\nvarying vec3 vInstanceExtraLight;\n#endif\n",paletteColorFrag:"\n  float paletteColorIndex;\n\n  #ifdef USE_MAP\n  paletteColorIndex = texelColor.a;\n  #endif\n\n  #ifdef USE_COLOR\n  paletteColorIndex = vColor.r;\n  #endif\n\n  #ifdef INSTANCE_TRANSFORM\n  diffuseColor = texture2D(palette, vec2(paletteColorIndex, (vInstancePaletteOffset + 0.5) / paletteOffsetCount.y));\n  #elif defined(VERTEX_PALETTE_OFFSET)\n  diffuseColor = texture2D(palette, vec2(paletteColorIndex, (vVertexPaletteOffset + 0.5) / paletteOffsetCount.y));\n  #else\n  diffuseColor = texture2D(palette, vec2(paletteColorIndex, (paletteOffsetCount.x + 0.5) / paletteOffsetCount.y));\n  #endif\n\n  #ifdef INSTANCE_OPACITY\n  diffuseColor.a *= vInstanceOpacity * opacity;\n  #else\n  diffuseColor.a *= opacity;\n  #endif\n  diffuseColor = clamp(diffuseColor, 0.0, 1.0);\n",paletteBasicLightFragment:"\n  #ifdef INSTANCE_TRANSFORM\n  diffuseColor.rgb += vInstanceExtraLight.rgb * diffuseColor.rgb;\n  #else\n  diffuseColor.rgb += extraLight.rgb * diffuseColor.rgb;\n  #endif\n\n  diffuseColor = clamp(diffuseColor, 0.0, 1.0);\n",paletteFullLightFragment:"\n  #ifdef INSTANCE_TRANSFORM\n  vec3 extraIrradiance = vInstanceExtraLight.rgb;\n  #else\n  vec3 extraIrradiance = extraLight.rgb;\n  #endif\n\n  #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n    #pragma unroll_loop\n    for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n      directionalLight = directionalLights[ i ];\n      getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\n      directLight.color = extraIrradiance;\n      RE_Direct( directLight, geometry, material, reflectedLight );\n    }\n  #endif\n\n  #if defined( RE_IndirectDiffuse )\n  RE_IndirectDiffuse( extraIrradiance, geometry, material, reflectedLight );\n  #endif\n",vertexColorMultParsVertex:"\n#ifdef USE_VERTEX_COLOR_MULT\nattribute vec4 vertexColorMult;\nvarying vec4 vVertexColorMult;\n#endif\n",vertexColorMultVertex:"\n  #ifdef USE_VERTEX_COLOR_MULT\n  vVertexColorMult = vertexColorMult;\n  #endif\n",vertexColorMultParsFrag:"\n#ifdef USE_VERTEX_COLOR_MULT\nvarying vec4 vVertexColorMult;\n#endif\n",vertexColorMultFrag:"\n  #ifdef USE_VERTEX_COLOR_MULT\n  diffuseColor.rgba *= vVertexColorMult.rgba;\n  #endif\n"})}}}),System.register("engine/mixDatabase",[],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[],execute:function(){S("mixDatabase",B=(new Map).set("cameo.mix",["adogicon.shp","adoguico.shp","aengicon.shp","aenguico.shp","agapgen.shp","agisicon.shp","ahrvicon.shp","ahrvuico.shp","aparicon.shp","apchicon.shp","apcicon.shp","artyicon.shp","asaticon.shp","ayaricon.shp","batricon.shp","beagicon.shp","bggyicon.shp","bolticon.shp","brrkicon.shp","carricon.shp","ccomicon.shp","ccomuico.shp","chemicon.shp","chroicon.shp","clckicon.shp","clegicon.shp","cleguico.shp","clonicon.shp","cnsticon.shp","crryicon.shp","csphicon.shp","darken.shp","desoicon.shp","desouico.shp","desticon.shp","detnicon.shp","dlphicon.shp","dlphuico.shp","dogicon.shp","doguico.shp","dredicon.shp","dronicon.shp","e1icon.shp","e1uico.shp","e2icon.shp","e2uico.shp","e4icon.shp","empicon.shp","engnicon.shp","facticon.shp","falcicon.shp","fixicon.shp","flakicon.shp","flkticon.shp","flktuico.shp","forticon.shp","fsdicon.shp","fspicon.shp","fstdicon.shp","fvicon.shp","fvuico.shp","gapicon.shp","gat2icon.shp","gateicon.shp","gbayicon.shp","gcanicon.shp","giicon.shp","giuico.shp","gorep.shp","gtnkicon.shp","gtnkuico.shp","gwepicon.shp","handicon.shp","harvicon.shp","harvuico.shp","heliicon.shp","hindicon.shp","hmecicon.shp","hovricon.shp","htkicon.shp","htkuico.shp","htnkicon.shp","htnkuico.shp","ioncicon.shp","ircricon.shp","ironicon.shp","ivanicon.shp","ivanuico.shp","ivncicon.shp","ivncuico.shp","jjeticon.shp","jjetuico.shp","landicon.shp","lasricon.shp","liteicon.shp","lpsticon.shp","mcvicon.shp","mcvuico.shp","metricon.shp","mltiicon.shp","mmchicon.shp","msslicon.shp","mtnkicon.shp","mtnkuico.shp","mutcicon.shp","nga2icon.shp","ngaticon.shp","nhpdicon.shp","npsiicon.shp","npwricon.shp","nradicon.shp","nrcticon.shp","nreficon.shp","ntchicon.shp","nukeicon.shp","nwalicon.shp","nwepicon.shp","obliicon.shp","obmbicon.shp","orcaicon.shp","otrnicon.shp","paraicon.shp","pillicon.shp","plticon.shp","plugicon.shp","podsicon.shp","powricon.shp","prisicon.shp","proicon.shp","psicicon.shp","psicuico.shp","psisicon.shp","psiticon.shp","psituico.shp","rad1icon.shp","rad2icon.shp","rad3icon.shp","radricon.shp","rboticon.shp","reficon.shp","rfixicon.shp","rtnkicon.shp","rtnkuico.shp","samicon.shp","sapcicon.shp","sapicon.shp","sbagicon.shp","sealicon.shp","sealuico.shp","seekicon.shp","shadicon.shp","shaduico.shp","shkicon.shp","shkuico.shp","smchicon.shp","smcvicon.shp","smcvuico.shp","snipicon.shp","snipuico.shp","soniicon.shp","spoticon.shp","spyicon.shp","spyuico.shp","sqdicon.shp","sreficon.shp","srefuico.shp","stnkicon.shp","subicon.shp","subticon.shp","tanyicon.shp","tanyuico.shp","techicon.shp","tempicon.shp","teslaicon.shp","tickicon.shp","tnkdicon.shp","tnkduico.shp","towricon.shp","trkaicon.shp","trsticon.shp","trstuico.shp","tslaicon.shp","ttnkicon.shp","ttnkuico.shp","turbicon.shp","twr1icon.shp","twr2icon.shp","twr3icon.shp","v3icon.shp","v3uico.shp","wallicon.shp","weapicon.shp","weaticon.shp","weedicon.shp","wethicon.shp","xxicon.shp","yardicon.shp","yuriicon.shp","yuriuico.shp","yurpicon.shp","yurpuico.shp","zepicon.shp","zepuico.shp"]).set("theme.mix",["200meter.wav","blowitup.wav","burn.wav","destroy.wav","eaglehun.wav","fortific.wav","grinder.wav","hm2.wav","indeep.wav","industro.wav","jank.wav","motorize.wav","power.wav","ra2-opt.wav","ra2-sco.wav","tension.wav"])),N=["addon.shp","bkgdlg.shp","bkgdmd.shp","bkgdsm.shp","bttnbkgd.shp","button00.shp","button01.shp","button02.shp","button03.shp","button04.shp","button05.shp","button06.shp","button07.shp","button08.shp","button09.shp","button10.shp","button11.shp","credits.shp","diplobtn.shp","gclock2.shp","key.ini","lendcap.shp","lspacer.shp","optbtn.shp","pbeacon.shp","power.shp","powerp.shp","pwrlvl.shp","radar.shp","radar01.shp","radar02.shp","r-dn.shp","rdrbeacn.shp","rendcap.shp","repair.shp","r-up.shp","sell.shp","side1.shp","side2.shp","side2b.shp","side3.shp","sidebar.pal","sidebttn.shp","tab00.shp","tab01.shp","tab02.shp","tab03.shp","tabs.shp","top.shp","uibkgd.pal","wayp.shp"],B.set("sidec01.mix",N).set("sidec02.mix",N),N=["reportbug.shp"],B.set("sidec01cd.mix",N).set("sidec02cd.mix",N)}}}),System.register("engine/renderable/AlphaRenderable",["data/Palette","engine/renderable/builder/ShpBuilder","util/Color","game/Coords"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("AlphaRenderable",class e{static getOrCreateAlphaPalette(){let S=e.alphaPalette;if(!S){S=new B.Palette(new Array(768).fill(0));let N=[];for(let S=0;S<256;S++){var O=127<S?2*(S-127):0;N.push(new j.Color(O,O,O))}S.setColors(N),e.alphaPalette=S}return S}constructor(S,O,B){this.shpFile=S,this.camera=O,this.visible=!0,this.drawOffset={...B}}setVisible(S){this.visible=S,this.object3d&&(this.object3d.visible=S)}setSize(S){this.shpSize=S,this.builder?.setSize(S)}create3DObject(){if(!this.object3d){var S=e.getOrCreateAlphaPalette();let O=new N.ShpBuilder(this.shpFile,S,this.camera,L.Coords.ISO_WORLD_SCALE);this.shpSize&&O.setSize(this.shpSize),O.setFrame(0),O.setOffset(this.drawOffset);let B=O.build();B.visible=this.visible,B.renderOrder=999995;let j=B.material;j.depthTest=!1,j.depthWrite=!0,j.transparent=!0,j.blending=THREE.CustomBlending,j.blendEquation=THREE.AddEquation,j.blendSrc=THREE.DstColorFactor,j.blendDst=THREE.OneFactor,this.builder=O,this.object3d=B}}get3DObject(){return this.object3d}update(S){}dispose(){this.builder?.dispose()}})}}}),System.register("engine/renderable/CameraPan",["util/math"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("CameraPan",class{constructor(S){this.freeCamera=S,this.pan={x:0,y:0}}setPanLimits(S){this.panLimits=S,this.setPan({x:this.pan.x,y:this.pan.y})}getPanLimits(){return{...this.panLimits}}getPan(){return{...this.pan}}setPan(S){this.panLimits&&!this.freeCamera.value&&(S.x=B.clamp(S.x,this.panLimits.x,this.panLimits.x+this.panLimits.width),S.y=B.clamp(S.y,this.panLimits.y,this.panLimits.y+this.panLimits.height)),this.pan={x:S.x,y:S.y}}})}}}),System.register("engine/renderable/CameraZoom",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("CameraZoom",class{constructor(S){this.freeCamera=S,this.zoom=1}getZoom(){return this.zoom}applyStep(S){this.freeCamera.value&&(this.zoom=Math.max(.1,this.zoom+S))}})}}}),System.register("engine/renderable/DebugRenderable",["data/Palette","engine/gfx/DebugUtils","engine/gfx/TextureUtils","engine/gfx/material/PaletteBasicMaterial","three","engine/gfx/batch/BatchedMesh"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){S("DebugRenderable",_=class e{static getOrCreateTexture(){let S=e.checkerboardTex;return S||(S=N.DebugUtils.createIndexedCheckerTex(B.Palette.REMAP_START_IDX-1,B.Palette.REMAP_START_IDX),e.checkerboardTex=S),S}static clearCaches(){e.checkerboardTex?.dispose(),e.geometryCache.forEach(S=>S.dispose()),e.geometryCache.clear()}constructor(S,O,B,N){this.foundation=S,this.height=O,this.palette=B,this.options=N,this.batchPalettes=[],this.useMeshBatching=!1,this.opacity=1}useMaterial(S){this.materialCacheKey=S.uuid;let O,B=e.materialCache.get(this.materialCacheKey);return B?(O=B.material,B.usages++):(O=new L.PaletteBasicMaterial({map:e.getOrCreateTexture(),palette:S,alphaTest:.05,paletteCount:this.batchPalettes.length,flatShading:!0,transparent:!0}),B={material:O,usages:1},e.materialCache.set(this.materialCacheKey,B)),O}freeMaterial(){if(!this.materialCacheKey)throw new Error("Material cache key not set");let S=e.materialCache.get(this.materialCacheKey);S&&(1===S.usages?(e.materialCache.delete(this.materialCacheKey),S.material.dispose()):S.usages--)}getGeometryCacheKey(){return this.foundation.width+"_"+this.foundation.height+"_"+this.height}setBatched(S){if(this.mesh)throw new Error("Batching can only be set before calling build()");this.useMeshBatching=S}getBatchPaletteIndex(S){var O=this.batchPalettes.findIndex(O=>O.hash===S.hash);if(-1===O)throw new Error("Provided palette not found in the list of batch palettes. Call setBatchPalettes first.");return O}setPalette(S){if(this.palette=S,this.mesh)if(this.useMeshBatching){var O=this.getBatchPaletteIndex(S);this.mesh.setPaletteIndex(O)}else O=j.TextureUtils.textureFromPalette(S),this.mesh.material.palette=O}setBatchPalettes(S){if(!this.useMeshBatching)throw new Error("Can't use multiple palettes when not batching");if(this.mesh)throw new Error("Palettes must be set before creating 3DObject");this.batchPalettes=S}setOpacity(S){this.opacity!==S&&(this.opacity=S,this.updateOpacity())}updateOpacity(){this.mesh&&(this.useMeshBatching?this.mesh.setOpacity(this.opacity):this.mesh.material.opacity=this.opacity)}create3DObject(){if(!this.mesh){var S,O,B=this.getGeometryCacheKey();let _,U=e.geometryCache,H=U.get(B);H||(H=N.DebugUtils.createBoxGeometry(this.foundation,this.height,this.options?.centerFoundation),U.set(B,H)),this.useMeshBatching?(S=j.TextureUtils.textureFromPalettes(this.batchPalettes),O=this.useMaterial(S),_=new F.BatchedMesh(H,O,F.BatchMode.Merging),_.castShadow=!1):(S=j.TextureUtils.textureFromPalette(this.palette),O=e.getOrCreateTexture(),O=new L.PaletteBasicMaterial({palette:S,map:O,alphaTest:.05,transparent:!0}),_=new D.Mesh(H,O)),_.matrixAutoUpdate=!1,this.mesh=_,this.setPalette(this.palette),this.updateOpacity()}}get3DObject(){return this.mesh}update(S){}dispose(){this.mesh&&(this.useMeshBatching?this.freeMaterial():this.mesh.material.dispose(),this.mesh=void 0)}}),_.geometryCache=new Map,_.materialCache=new Map}}}),System.register("engine/renderable/Entity",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("engine/renderable/MapSpriteTranslation",["game/Coords","engine/IsoCoords"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("MapSpriteTranslation",class{constructor(S,O){this.rx=S,this.ry=O}compute(){let S=B.Coords.tileToWorld(this.rx,this.ry);var O=N.IsoCoords.worldToScreen(S.x,S.y),j=N.IsoCoords.worldToScreen(0,0);let L=new THREE.Vector2(j.x-O.x,j.y-O.y);return 0!=(O=L.y-Math.floor(L.y))&&(L.y-=O,j=new THREE.Vector2(j.x-L.x,j.y-L.y),S=N.IsoCoords.screenToWorld(j.x,j.y)),{spriteOffset:L,anchorPointWorld:S}}})}}}),System.register("engine/renderable/RenderablePlugin",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("engine/renderable/ShadowRenderable",["data/Palette","engine/renderable/builder/ShpBuilder","game/Coords","engine/IsoCoords","engine/renderable/entity/map/MapSurface"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){S("ShadowRenderable",class e{static getOrCreateShadowPalette(){let S=e.shadowPalette;return S||(S=new B.Palette(new Array(768).fill(0)),e.shadowPalette=S),S}constructor(S,O,B,N=0){this.shpFile=S,this.camera=O,this.shadowHeightTileAdjust=N,this.baseFrameNo=0,this.frameOffset=0,this.visible=!0,this.useBatching=!1,this.drawOffset={...B}}setVisible(S){var O;this.visible=S,this.object3d&&(O=this.computeShadowFrameNo(this.baseFrameNo),this.object3d.visible=S&&this.frameHasShadowData(O))}setSize(S){this.shpSize=S,this.builder?.setSize(S)}setBatched(S){this.useBatching=S,this.builder?.setBatched(S)}setBaseFrame(S){var O;this.baseFrameNo=S,this.builder&&(O=this.computeShadowFrameNo(S),this.builder.setFrame(O),this.object3d.visible=this.visible&&this.frameHasShadowData(O))}setFrameOffset(S){this.frameOffset=S,this.builder&&this.builder.setFrameOffset(S)}computeShadowFrameNo(S){return S<this.shpFile.numImages?this.shpFile.numImages/2+S:1}create3DObject(){if(!this.object3d){var S=e.getOrCreateShadowPalette();let B=new N.ShpBuilder(this.shpFile,S,this.camera,j.Coords.ISO_WORLD_SCALE);this.shpSize&&B.setSize(this.shpSize),B.setFrameOffset(this.frameOffset),B.setBatched(this.useBatching),this.useBatching&&B.setBatchPalettes([S]),B.flat=!0;var O=this.computeShadowFrameNo(this.baseFrameNo);B.setFrame(O),this.shadowHeightTileAdjust&&(S=L.IsoCoords.tileHeightToScreen(this.shadowHeightTileAdjust),this.drawOffset.y+=-S),B.setOffset(this.drawOffset),B.setOpacity(.5);let F=B.build();this.shadowHeightTileAdjust&&(F.position.y+=j.Coords.tileHeightToWorld(-this.shadowHeightTileAdjust),F.updateMatrix()),F.visible=this.visible&&this.frameHasShadowData(O),F.position.y+=D.MAGIC_OFFSET/5,F.updateMatrix(),this.builder=B,this.object3d=F}}frameHasShadowData(S){return!!this.shpFile.getImage(this.frameOffset+S).imageData.length}get3DObject(){return this.object3d}update(S){}dispose(){this.builder?.dispose()}})}}}),System.register("engine/renderable/ShpRenderable",["engine/renderable/builder/ShpBuilder","engine/renderable/ShadowRenderable","game/Coords"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("ShpRenderable",class{static factory(S,O,L,D,F=!1,_=0,U=!1,H=0,V=!1){var W=F?new N.ShadowRenderable(S,L,D,_):void 0,z=j.Coords.ISO_WORLD_SCALE;let K,$=new B.ShpBuilder(S,O,L,z,U,H);return $.setOffset(D),V&&(K=new B.ShpBuilder(S,O,L,z,U,H),K.setOffset(D),K.flat=!0),new this($,W,K)}constructor(S,O,B){this.builder=S,this.shadowRenderable=O,this.zShapeFixBuilder=B}get3DObject(){return this.target}setBatched(S){this.builder.setBatched(S),this.zShapeFixBuilder?.setBatched(S),this.shadowRenderable?.setBatched(S)}setBatchPalettes(S){this.builder.setBatchPalettes(S),this.zShapeFixBuilder?.setBatchPalettes(S)}setSize(S){this.builder.setSize(S),this.zShapeFixBuilder?.setSize(S),this.shadowRenderable?.setSize(S)}getFlat(){return this.builder.flat}setFlat(S){this.builder.flat=S}setFrame(S){this.builder.getFrame()!==S&&(this.builder.setFrame(S),this.zShapeFixBuilder?.setFrame(S),this.shadowRenderable?.setBaseFrame(S))}setFrameOffset(S){this.builder.setFrameOffset(S),this.zShapeFixBuilder?.setFrameOffset(S),this.shadowRenderable?.setFrameOffset(S)}setPalette(S){this.builder.setPalette(S),this.zShapeFixBuilder?.setPalette(S)}setExtraLight(S){this.builder.setExtraLight(S),this.zShapeFixBuilder?.setExtraLight(S)}setOpacity(S){this.builder.setOpacity(S),this.zShapeFixBuilder?.setOpacity(S)}setForceTransparent(S){this.builder.setForceTransparent(S),this.zShapeFixBuilder?.setForceTransparent(S)}get frameCount(){return this.shadowRenderable?this.builder.frameCount/2:this.builder.frameCount}getShapeMesh(){return this.shapeMesh}getShadowMesh(){return this.shadowMesh}setShadowVisible(S){this.shadowRenderable?.setVisible(S)}create3DObject(){if(!this.target){var S,O=this.shapeMesh=this.builder.build();if(this.shadowRenderable||this.zShapeFixBuilder){let B=new THREE.Object3D;B.matrixAutoUpdate=!1,B.add(O),this.shadowRenderable&&(this.shadowRenderable.create3DObject(),S=this.shadowMesh=this.shadowRenderable.get3DObject(),B.add(S)),this.zShapeFixBuilder&&(S=this.zShapeFixBuilder.build(),B.add(S)),this.target=B}else this.target=O}}update(S){}dispose(){this.builder.dispose(),this.zShapeFixBuilder?.dispose(),this.shadowRenderable?.dispose()}})}}}),System.register("engine/renderable/WithPosition",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("WithPosition",class{constructor(){this.matrixUpdate=!1,this.position=new THREE.Vector3}setPosition(S,O,B){this.position.x=S,this.position.y=O,this.position.z=B,this.updatePosition()}getPosition(){return this.position}updatePosition(){if(this.target){let S=this.target.get3DObject();S&&(S.position.set(this.position.x,this.position.y,this.position.z),this.matrixUpdate&&(S.matrix.setPosition(S.position),S.matrixWorldNeedsUpdate=!0))}}applyTo(S){this.target=S,this.updatePosition()}})}}}),System.register("engine/renderable/WithVisibility",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("WithVisibility",class{constructor(){this.visible=!0}setVisible(S){this.visible=S,this.updateVisibility()}isVisible(){return this.visible}updateVisibility(){if(this.target){let S=this.target.get3DObject();S&&(S.visible=this.visible)}}applyTo(S){this.target=S,this.updateVisibility()}})}}}),System.register("engine/renderable/WorldScene",["util/geometry","engine/gfx/RenderableContainer","engine/renderable/CameraPan","engine/renderable/CameraZoom","engine/type/LightingType","game/Coords","util/event","engine/renderable/entity/unit/ShadowQuality","engine/gfx/batch/MeshBatchManager"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S}],execute:function(){V=new Map([[U.ShadowQuality.High,8],[U.ShadowQuality.Medium,4],[U.ShadowQuality.Low,2]]),W=class e extends N.RenderableContainer{get onBeforeCameraUpdate(){return this._onBeforeCameraUpdate.asEvent()}get onCameraUpdate(){return this._onCameraUpdate.asEvent()}static factory(S,O,B){let N=new THREE.Scene;N.matrixAutoUpdate=!1;var D=e.createCamera(S),F=new j.CameraPan(O),_=new L.CameraZoom(O);return new e(N,D,S,F,_,B)}static getCameraParams(S){var O=F.Coords.ISO_CAMERA_ALPHA,B=F.Coords.ISO_CAMERA_BETA,N=F.Coords.ISO_WORLD_SCALE;return{alpha:O,beta:B,d:S.height/2*F.Coords.COS_ISO_CAMERA_BETA*N,aspect:S.width/S.height,far:16e3*N}}static createCamera(S){var{alpha:O,beta:B,d:N,aspect:j,far:L}=this.getCameraParams(S);let D=new THREE.OrthographicCamera(-N*j,N*j,N,-N,0,L);return D.rotation.order="YXZ",D.rotation.y=+B,D.rotation.x=-O,D}constructor(S,O,B,N,j,L){super(S),this.scene=S,this.camera=O,this.viewport=B,this.cameraPan=N,this.cameraZoom=j,this.shadowQuality=L,this.initialized=!1,this.ambientLight=new THREE.AmbientLight(16777215,.8),this.directionalLight=new THREE.DirectionalLight(16777215,1),this._onBeforeCameraUpdate=new _.EventDispatcher,this._onCameraUpdate=new _.EventDispatcher}updateViewport(S){this.viewport=S;var{d:O,aspect:B}=e.getCameraParams(S);let N=this.camera;N.left=-O*B,N.right=O*B,N.top=O,N.bottom=-O,N.updateProjectionMatrix()}updateCamera(S,O){let B=this.camera;B.updateMatrix();var N=B.matrix.elements;let j=new THREE.Vector3;B.position.set(0,0,0),B.translateZ(16e3*F.Coords.ISO_WORLD_SCALE),j.set(N[0],N[1],N[2]),j.multiplyScalar(S.x*(B.right-B.left)/this.viewport.width/B.zoom),B.position.add(j),j.set(N[4],N[5],N[6]),j.multiplyScalar(-S.y*(B.top-B.bottom)/this.viewport.height/B.zoom),B.position.add(j),B.zoom=O,B.updateProjectionMatrix(),B.updateMatrixWorld(!1)}create3DObject(){if(super.create3DObject(),!this.initialized){this.initialized=!0,this.scene.position.x-=.1*F.Coords.ISO_WORLD_SCALE,this.scene.position.z-=.1*F.Coords.ISO_WORLD_SCALE,this.scene.updateMatrix();var S=new THREE.AxesHelper(F.Coords.LEPTONS_PER_TILE);this.scene.add(S),this.scene.add(this.ambientLight);let O=this.directionalLight;O.position.set(-87.012,204.338,195.409),this.lightFocusPoint&&(O.position.x+=this.lightFocusPoint.x,O.position.z+=this.lightFocusPoint.y,O.target.position.set(this.lightFocusPoint.x,0,this.lightFocusPoint.y),O.target.updateMatrixWorld(void 0)),this.updateShadowQuality(O,this.shadowQuality.value),this.shadowQualityListener=()=>this.updateShadowQuality(O,this.shadowQuality.value),this.shadowQuality.onChange.subscribe(this.shadowQualityListener),this.scene.add(O),this.scene.add(this.camera),S=this.meshBatchManager=new H.MeshBatchManager(this),this.add(S),this.scene.autoUpdate=!1}}updateShadowQuality(S,O){var B=O!==U.ShadowQuality.Off;if(S.castShadow=B){var N=F.Coords.ISO_WORLD_SCALE;B=3500*N;let j=S.shadow.camera;if(j.right=B,j.left=-B,j.top=B,j.bottom=-B,j.near=-4e3*N,j.far=3e3*N,!(N=V.get(O)))throw new Error(`Unsupported shadow quality "${O}"`);S.shadow.mapSize.width=1024*N,S.shadow.mapSize.height=1024*N}}setLightFocusPoint(S,O){this.lightFocusPoint={x:S,y:O}}applyLighting(S){var O=S.computeTint(D.LightingType.Ambient);this.ambientLight.color.setRGB(O.x,O.y,O.z),this.directionalLight.color.setRGB(O.x,O.y,O.z),O=S.getAmbientIntensity(),this.ambientLight.intensity=.8*O,this.directionalLight.intensity=O}update(S,O){super.update(S,O),this._onBeforeCameraUpdate.dispatch(this,S);var N=this.cameraZoom.getZoom(),j=this.cameraPan.getPan();B.pointEquals(j,this.lastCameraPan)&&this.lastCameraZoom===N||(this.updateCamera(j,N),this.lastCameraZoom=N,this.lastCameraPan=j),this._onCameraUpdate.dispatch(this,S),this.scene.updateMatrixWorld(!1),this.meshBatchManager.updateMeshes()}dispose(){this.shadowQualityListener&&(this.shadowQuality.onChange.unsubscribe(this.shadowQualityListener),this.shadowQualityListener=void 0),this.directionalLight.shadow.map?.dispose(),this.meshBatchManager&&(this.meshBatchManager.dispose(),this.remove(this.meshBatchManager),this.meshBatchManager=void 0),this.scene.remove(this.ambientLight),this.scene.remove(this.directionalLight)}},S("WorldScene",W)}}}),System.register("engine/renderable/builder/BatchShpBuilder",["engine/renderable/builder/ShpTextureAtlas","engine/gfx/SpriteUtils","engine/gfx/TextureUtils","engine/gfx/material/PaletteBasicMaterial"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("BatchShpBuilder",class{get verticesPerSprite(){return N.SpriteUtils.VERTICES_PER_SPRITE}get trianglesPerSprite(){return N.SpriteUtils.TRIANGLES_PER_SPRITE}constructor(S,O,B,N,j=1,L=!1,D=1e4,F=1){this.shpFile=S,this.palette=O,this.camera=B,this.textureCache=N,this.opacity=j,this.transparent=L,this.batchSize=D,this.scale=F,this.specIndexes=new Map}initTexture(){var S;this.textureCache.has(this.shpFile)?this.atlas=this.textureCache.get(this.shpFile):(S=(new B.ShpTextureAtlas).fromShpFile(this.shpFile),this.textureCache.set(this.shpFile,S),this.atlas=S)}getSpriteGeometryOptions(S){var O={x:(O=this.shpFile.getImage(S.frameNo)).x-S.shpFile.width/2+S.offset.x,y:O.y-S.shpFile.height/2+S.offset.y};return{texture:this.atlas.getTexture(),textureArea:this.atlas.getTextureArea(S.frameNo),flat:S.flat,depth:S.depth,align:{x:1,y:-1},offset:O,camera:this.camera,scale:this.scale}}setPalette(S){if(this.palette=S,this.mesh){var O=j.TextureUtils.textureFromPalette(S);this.mesh.material.palette=O}}build(){if(this.mesh)return this.mesh;this.initTexture();var S=j.TextureUtils.textureFromPalette(this.palette);let O=new THREE.BufferGeometry;var B,D,F=this.batchSize*this.verticesPerSprite,_=new THREE.BufferAttribute(new Float32Array(3*F),3);O.addAttribute("position",_),this.positionAttribute=_,O.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(2*F),2)),N.SpriteUtils.USE_INDEXED_GEOMETRY&&(B=this.batchSize*this.trianglesPerSprite*3,O.setIndex(new THREE.BufferAttribute(new Uint32Array(3*B),1))),F=new THREE.BufferAttribute(new Float32Array(4*F),4),O.addAttribute("vertexColorMult",F),this.colorMultAttribute=F;let U=0;for(D of this.specIndexes.keys())this.specIndexes.set(D,U),this.setSpecGeometry(D,O,U),U++;if(this.firstFreeSpriteIdx=U<this.batchSize?U:-1,U<this.batchSize){let S=_.array;for(let O=U;O<this.batchSize-1;O++)S[O*this.verticesPerSprite*3]=O+1;S[(this.batchSize-1)*this.verticesPerSprite*3]=-1}S=new L.PaletteBasicMaterial({map:this.atlas.getTexture(),palette:S,alphaTest:this.transparent?.05:.5,flatShading:!0,transparent:this.transparent,opacity:this.opacity,useVertexColorMult:!0});let H=new THREE.Mesh(O,S);return H.matrixAutoUpdate=!1,H.frustumCulled=!1,this.mesh=H,H}add(S){if(!this.specIndexes.has(S)){if(this.isFull())throw new Error("Batch is full");var O=this.mesh?.geometry;if(O){var B=this.firstFreeSpriteIdx;if(-1===B)throw new Error("No free sprite index found");this.specIndexes.set(S,B);var N=(this.positionAttribute?.array)[B*this.verticesPerSprite*3];this.setSpecGeometry(S,O,B),this.firstFreeSpriteIdx=N}else this.specIndexes.set(S,void 0)}}setSpecGeometry(S,O,B){var j=this.getSpriteGeometryOptions(S);let L=N.SpriteUtils.createSpriteGeometry(j);j=S.position,L.applyMatrix((new THREE.Matrix4).makeTranslation(j.x,j.y,j.z));let D=L;if(D.getAttribute("position").count!==this.verticesPerSprite)throw new Error("Vertex count mismatch");var F;for(F of(O.merge(D,B*this.verticesPerSprite),D.index&&(O.index.array.set(Uint32Array.from(D.index.array,S=>S+B*this.verticesPerSprite),B*D.index.array.length),O.index.needsUpdate=!0),j=S.lightMult??new THREE.Vector3(1,1,1),this.setLightingAt(B,j,this.colorMultAttribute.array),this.setVisibilityAt(B,!0,this.colorMultAttribute.array),Object.values(O.attributes)))F.needsUpdate=!0}has(S){return this.specIndexes.has(S)}remove(S){if(this.specIndexes.has(S)){if(this.mesh){var O=this.specIndexes.get(S);this.setVisibilityAt(O,!1,this.colorMultAttribute.array),this.colorMultAttribute.needsUpdate=!0,this.positionAttribute.array[O*this.verticesPerSprite*3]=this.firstFreeSpriteIdx,this.firstFreeSpriteIdx=O}this.specIndexes.delete(S)}}update(S){var O;!this.specIndexes.has(S)||(O=this.mesh?.geometry)&&this.setSpecGeometry(S,O,this.specIndexes.get(S))}isFull(){return this.specIndexes.size===this.batchSize}isEmpty(){return 0===this.specIndexes.size}setLightingAt(S,O,B){for(let N=0;N<this.verticesPerSprite;N++)B[S*this.verticesPerSprite*4+4*N]=O.x,B[S*this.verticesPerSprite*4+4*N+1]=O.y,B[S*this.verticesPerSprite*4+4*N+2]=O.z}setVisibilityAt(S,O,B){for(let N=0;N<this.verticesPerSprite;N++)B[S*this.verticesPerSprite*4+4*N+3]=O?1:0}updateLighting(){if(this.mesh){let S=this.colorMultAttribute.array;this.specIndexes.forEach((O,B)=>{var N=B.lightMult??new THREE.Vector3(1,1,1);this.setLightingAt(O,N,S)}),this.colorMultAttribute.needsUpdate=!0}}dispose(){this.mesh&&(this.mesh.geometry.dispose(),this.mesh.material.dispose())}})}}}),System.register("engine/renderable/builder/CanvasSpriteBuilder",["engine/gfx/SpriteUtils","engine/renderable/builder/CanvasTextureAtlas"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("CanvasSpriteBuilder",j=class e{static clearCaches(){e.textureCache.clear()}constructor(S,O){this.images=S,this.camera=O,this.offset={x:0,y:0},this.align={x:0,y:0},this.opacity=1,this.forceTransparent=!1,this.frustumCulled=!1,this.frameGeometries=new Map,this.setFrame(0)}setOffset(S){this.offset=S}setAlign(S,O){var N;this.align={x:S,y:O},this.mesh&&(this.frameGeometries.get(this.frameNo)?.dispose(),N=B.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions()),this.frameGeometries.set(this.frameNo,N),this.mesh.geometry=N)}initTexture(){if(e.textureCache.has(this.images))this.atlas=e.textureCache.get(this.images);else{let S=new N.CanvasTextureAtlas;S.pack(this.images),e.textureCache.set(this.images,S),this.atlas=S}}getSpriteGeometryOptions(){var S=this.images[this.frameNo],O={x:-S.width/2-this.align.x*(S.width/2)+this.offset.x,y:-S.height/2-this.align.y*(S.height/2)+this.offset.y};return{texture:this.atlas.getTexture(),textureArea:this.atlas.getImageRect(S),align:{x:1,y:-1},offset:O,camera:this.camera}}setFrame(S){if(this.frameNo!==S&&(this.frameNo=S,this.mesh)){let O=this.frameGeometries.get(S);O||(O=B.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions()),this.frameGeometries.set(S,O)),this.mesh.geometry=O}}getFrame(){return this.frameNo}getSize(){return{width:this.images[this.frameNo].width,height:this.images[this.frameNo].height}}get frameCount(){return this.images.length}setOpacity(S){var O=this.opacity;O!==S&&(this.opacity=S,this.mesh&&(this.mesh.material.opacity=S),Math.floor(O)===Math.floor(S)||this.forceTransparent||this.updateTransparency())}setForceTransparent(S){this.forceTransparent!==S&&(this.forceTransparent=S,this.updateTransparency())}updateTransparency(){this.mesh&&(this.mesh.material.transparent=this.forceTransparent||this.opacity<1)}setExtraLight(S){throw new Error("Not implemented")}setFrustumCulled(S){this.frustumCulled=S,this.mesh&&(this.mesh.frustumCulled=S)}build(){if(this.mesh)return this.mesh;this.initTexture();var S=B.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions());this.frameGeometries.set(this.frameNo,S);var O=new THREE.MeshBasicMaterial({map:this.atlas.getTexture(),flatShading:!0,opacity:this.opacity,transparent:this.opacity<1||this.forceTransparent});let N=new THREE.Mesh(S,O);return N.matrixAutoUpdate=!1,N.frustumCulled=this.frustumCulled,this.mesh=N,N}dispose(){this.frameGeometries.forEach(S=>S.dispose()),this.mesh?.material?.dispose()}}),j.textureCache=new Map}}}),System.register("engine/renderable/builder/CanvasTextureAtlas",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("CanvasTextureAtlas",class{getTexture(){if(!this.texture)throw new Error("Texture atlas not initialized");return this.texture}getImageRect(S){if(!this.imageRects)throw new Error("Texture atlas not initialized");var O=this.imageRects.get(S);if(!O)throw new Error("Image not found in atlas");return O}pack(S){let O=[];S.forEach(S=>{O.push({w:S.width,h:S.height,image:S})}),O.sort((S,O)=>1e3*(O.w-S.w)+O.h-S.h);let B=new GrowingPacker;B.fit(O);var N=B.root.w,j=B.root.h;let L=document.createElement("canvas"),D=L.getContext("2d",{alpha:!0});L.width=N,L.height=j;let F=new Map;O.forEach(S=>{if(!S.fit)throw new Error("Couldn't fit all images in a single texture");var O=S.image,B=S.fit.x,N=S.fit.y;F.set(O,{x:B,y:N,width:S.w,height:S.h}),D.drawImage(O,B,N)});let _=new THREE.Texture(L);_.minFilter=THREE.NearestFilter,_.magFilter=THREE.NearestFilter,_.needsUpdate=!0,this.texture=_,this.imageRects=F}})}}}),System.register("engine/renderable/builder/ObjectBuilder",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("engine/renderable/builder/ShpAggregator",["data/ShpFile","data/ShpImage"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("ShpAggregator",class{static getShpFrameInfo(S,O){return{file:S,hasShadow:O,frameCount:Math.floor(S.numImages*(O?.5:1))}}aggregate(S,O){let j=new B.ShpFile;j.filename=O;let L=[],D=new Map,F=0;for(var{file:_,hasShadow:U,frameCount:H}of S)if(!D.has(_)){D.set(_,F);for(let S=0;S<H;S++)j.addImage(_.getImage(S)),L.push(U?_.getImage(H+S):new N.ShpImage),F++}return L.forEach(S=>j.addImage(S)),{file:j,imageIndexes:D}}})}}}),System.register("engine/renderable/builder/ShpBuilder",["engine/gfx/TextureUtils","engine/gfx/SpriteUtils","engine/renderable/builder/ShpTextureAtlas","engine/gfx/material/PaletteBasicMaterial","engine/gfx/batch/BatchedMesh"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){S("ShpBuilder",F=class e{static prepareTexture(S){var O;e.textureCache.has(S)||(O=(new j.ShpTextureAtlas).fromShpFile(S),e.textureCache.set(S,O))}static clearCaches(){e.textureCache.forEach(S=>S.dispose()),e.textureCache.clear(),e.geometryCache.forEach(S=>S.forEach(S=>S.dispose())),e.geometryCache.clear()}constructor(S,O,B,N=1,j=!1,L=0){this.scale=N,this.depth=j,this.depthOffset=L,this.batchPalettes=[],this.useMeshBatching=!1,this.opacity=1,this.forceTransparent=!1,this.offset={x:0,y:0},this.frameOffset=0,this.flat=!1,this.shpFile=S,this.palette=O,this.camera=B,this.shpSize={width:S.width,height:S.height},this.setFrame(0)}useMaterial(S,O,B){if(S.format!==THREE.AlphaFormat)throw new Error("Texture must have format THREE.AlphaFormat");this.materialCacheKey=S.uuid+"_"+O.uuid+"_"+Number(B);let N,j=e.materialCache.get(this.materialCacheKey);return j?(N=j.material,j.usages++):(N=new L.PaletteBasicMaterial({map:S,palette:O,alphaTest:.05,paletteCount:this.batchPalettes.length,flatShading:!0,transparent:B}),j={material:N,usages:1},e.materialCache.set(this.materialCacheKey,j)),N}freeMaterial(){if(!this.materialCacheKey)throw new Error("Material cache key not set");let S=e.materialCache.get(this.materialCacheKey);S&&(1===S.usages?(e.materialCache.delete(this.materialCacheKey),S.material.dispose()):S.usages--)}setBatched(S){if(this.mesh)throw new Error("Batching can only be set before calling build()");this.useMeshBatching=S}setOffset(S){if(this.mesh)throw new Error("Offset can only be set before calling build()");this.offset=S}setFrameOffset(S){if(this.mesh)throw new Error("frameOffset can only be set before calling build()");this.frameOffset=S}initTexture(){e.prepareTexture(this.shpFile),this.atlas=e.textureCache.get(this.shpFile)}getSpriteGeometryOptions(S){S+=this.frameOffset;var O={x:(O=this.shpFile.getImage(S)).x-Math.floor(this.shpSize.width/2)+Math.floor(this.offset.x),y:O.y-Math.floor(this.shpSize.height/2)+Math.floor(this.offset.y)};return{texture:this.atlas.getTexture(),textureArea:this.atlas.getTextureArea(S),flat:this.flat,align:{x:1,y:-1},offset:O,camera:this.camera,depth:this.depth,depthOffset:this.depthOffset,scale:this.scale}}getGeometryCacheKey(S){return S+this.frameOffset+"_"+this.shpSize.width+"_"+this.shpSize.height+"_"+this.offset.x+"_"+this.offset.y+"_"+this.flat+"_"+this.depth+"_"+this.depthOffset}setFrame(S){if(this.frameNo!==S&&(this.frameNo=S,this.mesh)){let B=this.getGeometryCache();var O=this.getGeometryCacheKey(S);let j=B.get(O);j||(j=N.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions(S)),B.set(O,j)),this.mesh.geometry=j}}getGeometryCache(){let S=e.geometryCache.get(this.shpFile);return S||(S=new Map,e.geometryCache.set(this.shpFile,S)),S}getFrame(){return this.frameNo}setSize(S){this.shpSize={width:S.width,height:S.height}}getSize(){return this.shpSize}get frameCount(){return this.shpFile.numImages}getBatchPaletteIndex(S){var O=this.batchPalettes.findIndex(O=>O.hash===S.hash);if(-1===O)throw new Error("Provided palette not found in the list of batch palettes. Call setBatchPalettes first.");return O}setPalette(S){if(this.palette=S,this.mesh)if(this.useMeshBatching){var O=this.getBatchPaletteIndex(S);this.mesh.setPaletteIndex(O)}else O=B.TextureUtils.textureFromPalette(S),this.mesh.material.palette=O}setBatchPalettes(S){if(!this.useMeshBatching)throw new Error("Can't use multiple palettes when not batching");if(this.mesh)throw new Error("Palettes must be set before creating 3DObject");this.batchPalettes=S}setExtraLight(S){this.extraLight=S,this.mesh&&(this.useMeshBatching?this.mesh.setExtraLight(S):this.mesh.material.extraLight=S)}setOpacity(S){var O=this.opacity;O!==S&&(this.opacity=S,this.updateOpacity()),Math.floor(O)===Math.floor(S)||this.forceTransparent||this.updateTransparency()}setForceTransparent(S){S!==this.forceTransparent&&(this.forceTransparent=S,this.updateTransparency())}updateOpacity(){this.mesh&&(this.useMeshBatching?this.mesh.setOpacity(this.opacity):this.mesh.material.opacity=this.opacity)}updateTransparency(){var S,O,B;this.mesh&&(S=this.forceTransparent||this.opacity<1,this.useMeshBatching?(O=this.mesh.material.map,B=this.mesh.material.palette,this.freeMaterial(),this.mesh.material=this.useMaterial(O,B,S)):this.mesh.material.transparent=S)}build(){if(this.mesh)return this.mesh;this.initTexture();var S,O=this.atlas.getTexture(),j=this.getGeometryCacheKey(this.frameNo);let F,_=this.getGeometryCache(),U=_.get(j);var H;return U||(S=this.getSpriteGeometryOptions(this.frameNo),U=N.SpriteUtils.createSpriteGeometry(S),_.set(j,U)),j=this.opacity<1||this.forceTransparent,this.useMeshBatching?(H=B.TextureUtils.textureFromPalettes(this.batchPalettes),H=this.useMaterial(O,H,j),F=new D.BatchedMesh(U,H,D.BatchMode.Merging),F.castShadow=!1):(H=B.TextureUtils.textureFromPalette(this.palette),j=new L.PaletteBasicMaterial({map:O,palette:H,alphaTest:.5,flatShading:!0,transparent:j}),F=new THREE.Mesh(U,j)),F.matrixAutoUpdate=!1,this.mesh=F,this.setPalette(this.palette),this.updateOpacity(),this.extraLight&&this.setExtraLight(this.extraLight),F}dispose(){this.mesh&&(this.useMeshBatching?this.freeMaterial():this.mesh.material.dispose(),this.mesh=void 0)}}),F.textureCache=new Map,F.geometryCache=new Map,F.materialCache=new Map}}}),System.register("engine/renderable/builder/ShpTextureAtlas",["data/Bitmap","engine/gfx/TextureAtlas"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("ShpTextureAtlas",class{fromShpFile(S){let O=[];for(let N=0;N<S.numImages;N++){var j=S.getImage(N);O.push(new B.IndexedBitmap(j.width,j.height,j.imageData))}let L=new N.TextureAtlas;return L.pack(O),this.images=O,this.atlas=L,this}getTextureArea(S){return this.atlas.getImageRect(this.images[S])}getTexture(){return this.atlas.getTexture()}dispose(){this.atlas.dispose()}})}}}),System.register("engine/renderable/builder/SpriteBuilder",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("engine/renderable/builder/VxlBatchedBuilder",["engine/gfx/TextureUtils","engine/gfx/batch/BatchedMesh","engine/renderable/builder/VxlBuilder","engine/gfx/material/PalettePhongMaterial"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class e extends j.VxlBuilder{constructor(S,O,B,N,j,L){super(L),this.vxlFile=S,this.hvaFile=O,this.palettes=B,this.palette=N,this.vxlGeometryPool=j,this.clippingPlanes=[],this.opacity=1,this.castShadow=!0}createVxlMeshes(){var S=B.TextureUtils.textureFromPalettes(this.palettes);let O=this.useMaterial(S);this.materialCacheKey=S;let j=this.getPaletteIndex(this.palette),L=this.vxlFile.sections,D=new Map;return L.forEach((S,B)=>{var L=this.vxlGeometryPool.get(S);let F=new N.BatchedMesh(L,O),_=S.transfMatrix,U=this.hvaFile?.sections[B];U&&(_=S.scaleHvaMatrix(U.getMatrix(0))),F.applyMatrix(_),D.set(S.name,F),F.castShadow=this.castShadow,F.setPaletteIndex(j),this.extraLight&&F.setExtraLight(this.extraLight),F.setOpacity(this.opacity),F.setClippingPlanes(this.clippingPlanes)}),D}useMaterial(S){let O,B=e.materialCache.get(S);return B?(O=B.material,B.usages++):(O=new L.PalettePhongMaterial({palette:S,paletteCount:this.palettes.length,vertexColors:THREE.VertexColors,transparent:!0}),B={material:O,usages:1},e.materialCache.set(S,B)),O}freeMaterial(){let S=e.materialCache.get(this.materialCacheKey);S&&(1===S.usages?(e.materialCache.delete(this.materialCacheKey),S.material.dispose()):S.usages--)}getPaletteIndex(S){var O=this.palettes.findIndex(O=>O.hash===S.hash);if(-1===O)throw new Error("Provided palette not found in the list of available palettes");return O}setPalette(S){if(this.palette=S,this.object){let O=this.getPaletteIndex(S);this.sections.forEach(S=>S.setPaletteIndex(O))}}setExtraLight(S){this.extraLight=S,this.object&&this.sections.forEach(O=>O.setExtraLight(S))}setShadow(S){this.castShadow=S,this.sections?.forEach(O=>{O.castShadow=S})}setClippingPlanes(S){this.clippingPlanes=S,this.object&&this.sections.forEach(O=>O.setClippingPlanes(S))}setOpacity(S){this.opacity=S,this.object&&this.sections.forEach(O=>O.setOpacity(S))}dispose(){this.object&&(this.freeMaterial(),this.object=void 0)}},S("VxlBatchedBuilder",D),D.materialCache=new Map}}}),System.register("engine/renderable/builder/VxlBuilder",["game/Coords"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("VxlBuilder",class{constructor(S){this.camera=S}build(){if(this.object)return this.object;let S=this.object=new THREE.Object3D,O=Math.cos(this.camera.rotation.y)*B.Coords.ISO_WORLD_SCALE;S.scale.set(O,O,O);let N=new THREE.Object3D;return N.rotation.x=-Math.PI/2,N.rotation.z=+Math.PI/2,N.matrixAutoUpdate=!1,N.updateMatrix(),S.add(N),(this.sections=this.createVxlMeshes()).forEach(S=>{var B;S.matrixAutoUpdate=!1,N.add(S),this.localBoundingBox||(S.geometry.boundingBox||S.geometry.computeBoundingBox(),this.localBoundingBox=new THREE.Box3(S.geometry.boundingBox.min.clone().multiplyScalar(O),S.geometry.boundingBox.max.clone().multiplyScalar(O)),B=this.localBoundingBox.min.x,this.localBoundingBox.min.x=this.localBoundingBox.min.y,this.localBoundingBox.min.y=B,B=this.localBoundingBox.max.x,this.localBoundingBox.max.x=this.localBoundingBox.max.y,this.localBoundingBox.max.y=B)}),S.matrixAutoUpdate=!1,S.updateMatrix(),S}getSection(S){if(!this.sections)throw new Error("Vxl object must be built first");return this.sections.get(S)}getLocalBoundingBox(){return this.localBoundingBox}})}}}),System.register("engine/renderable/builder/VxlBuilderFactory",["engine/renderable/builder/VxlBatchedBuilder","engine/renderable/builder/VxlNonBatchedBuilder"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("VxlBuilderFactory",class{constructor(S,O,B){this.vxlGeometryPool=S,this.useBatching=O,this.camera=B}create(S,O,j,L){return this.useBatching?new B.VxlBatchedBuilder(S,O,j,L,this.vxlGeometryPool,this.camera):new N.VxlNonBatchedBuilder(S,O,L,this.vxlGeometryPool,this.camera)}})}}}),System.register("engine/renderable/builder/VxlNonBatchedBuilder",["engine/gfx/TextureUtils","engine/renderable/builder/VxlBuilder","engine/gfx/material/PalettePhongMaterial"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends N.VxlBuilder{constructor(S,O,B,N,j){super(j),this.vxlFile=S,this.hvaFile=O,this.palette=B,this.vxlGeometryPool=N,this.clippingPlanes=[],this.castShadow=!0}createVxlMeshes(){var S=this.palette;S=B.TextureUtils.textureFromPalette(S);let O=this.material=new j.PalettePhongMaterial({palette:S,vertexColors:THREE.VertexColors});this.extraLight&&(O.extraLight=this.extraLight),O.clippingPlanes=this.clippingPlanes;let N=this.vxlFile.sections,L=new Map;return N.forEach((S,B)=>{var N=this.vxlGeometryPool.get(S);let j=new THREE.Mesh(N,O),D=S.transfMatrix,F=this.hvaFile?.sections[B];F&&(D=S.scaleHvaMatrix(F.getMatrix(0))),j.applyMatrix(D),L.set(S.name,j),j.castShadow=this.castShadow}),L}setPalette(S){var O;this.palette=S,this.object&&(O=B.TextureUtils.textureFromPalette(S),this.material.palette=O)}setExtraLight(S){this.extraLight=S,this.object&&(this.material.extraLight=S)}setShadow(S){this.castShadow=S,this.sections?.forEach(O=>O.castShadow=S)}setClippingPlanes(S){this.clippingPlanes=S,this.object&&(this.material.clippingPlanes=S)}setOpacity(S){this.material.transparent=S<1,this.material.opacity=S}dispose(){this.object&&this.material.dispose()}},S("VxlNonBatchedBuilder",L)}}}),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryCulledBuilder",["engine/gfx/BufferGeometryUtils"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("VxlGeometryCulledBuilder",class{build(S){let{voxels:O,voxelField:N}=S.getAllVoxels(),j=new THREE.BoxBufferGeometry(1,1,1);var L=j.getAttribute("position").array,D=L.length/3,F=j.getAttribute("normal").array,_=j.getIndex().array;let U=[],H=[],V=[],W=[];var z=S.minBounds,K=S.scale,$=S.getNormals();let q=0;for(let S=0,B=O.length;S<B;S++){var Q=O[S],Z=$[Math.min(O[S].normalIndex,$.length-1)];let B=new Array(D);for(let S=0,O=3*D;S<O;S+=3)N.get(Q.x+F[S],Q.y+F[S+1],Q.z+F[S+2])||(B[S/3]=q,U.push(z.x+Q.x*K.x+L[S],z.y+Q.y*K.y+L[S+1],z.z+Q.z*K.z+L[S+2]),H.push(Z.x,Z.y,Z.z),V.push(Q.colorIndex/255,0,0),q++);for(let S=0,O=_.length;S<O;S+=3){var Y=B[_[S]],X=B[_[S+1]],J=B[_[S+2]];void 0!==Y&&void 0!==X&&void 0!==J&&W.push(Y,X,J)}}let ee=new THREE.BufferGeometry;return ee.setIndex(new THREE.BufferAttribute(new Uint32Array(W),1)),ee.addAttribute("position",new THREE.BufferAttribute(new Float32Array(U),3)),ee.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(H),3)),ee.addAttribute("color",new THREE.BufferAttribute(new Float32Array(V),3)),ee=B.BufferGeometryUtils.mergeVertices(ee),ee.computeBoundingBox(),ee}})}}}),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryMonotoneBuilder",["engine/gfx/BufferGeometryUtils"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("VxlGeometryMonotoneBuilder",class{build(S,O=!1){let j=S.getAllVoxels().voxelField;var{vertices:L,faces:D}=function(S,O){for(var B=[],j=[],L=0;L<3;++L){var D=(L+1)%3,F=(L+2)%3,_=new Int32Array(3),U=new Int32Array(3),H=new Int32Array(2*(O[D]+1)),V=new Int32Array(O[D]),W=new Int32Array(O[D]),z=new Int32Array(2*O[F]),K=new Int32Array(2*O[F]),$=new Int32Array(24*O[F]),q=[[0,0],[0,0]];for(U[L]=1,_[L]=-1;_[L]<O[L];){var Q=[],Z=0;for(_[F]=0;_[F]<O[F];++_[F]){var Y=0,X=0,J=0;for(_[D]=0;_[D]<O[D];++_[D],X=J){var ee=0<=_[L]?S(_[0],_[1],_[2]):0,te=_[L]<O[L]-1?S(_[0]+U[0],_[1]+U[1],_[2]+U[2]):0;!(J=ee)==!te?J=0:ee||(J=-te),X!==J&&(H[Y++]=_[D],H[Y++]=J)}H[Y++]=O[D];for(var ie=H[Y++]=0,re=0,se=0;re<Z&&se<Y-2;){let S=Q[V[re]];var ne=S.left[S.left.length-1][0],ae=S.right[S.right.length-1][0],oe=S.color,le=H[se],ce=H[se+2],he=H[se+1];ne<ce&&le<ae&&he===oe?(S.merge_run(_[F],le,ce),W[ie++]=V[re],++re,se+=2):(ce<=ae&&(he&&(ue=new N(he,_[F],le,ce),W[ie++]=Q.length,Q.push(ue)),se+=2),ae<=ce&&(S.close_off(_[F]),++re))}for(;re<Z;++re)Q[V[re]].close_off(_[F]);for(;se<Y-2;se+=2){var ue;le=H[se],ce=H[se+2],(he=H[se+1])&&(ue=new N(he,_[F],le,ce),W[ie++]=Q.length,Q.push(ue))}var de=W;W=V,V=de,Z=ie}for(re=0;re<Z;++re)Q[V[re]].close_off(O[F]);for(_[L]++,re=0;re<Q.length;++re){var ge=Q[re],pe=!1;for((J=ge.color)<0&&(pe=!0,J=-J),se=0;se<ge.left.length;++se){z[se]=B.length;var me=[0,0,0],fe=ge.left[se];me[L]=_[L],me[D]=fe[0],me[F]=fe[1],B.push({position:me,value:J})}for(se=0;se<ge.right.length;++se)K[se]=B.length,me=[0,0,0],fe=ge.right[se],me[L]=_[L],me[D]=fe[0],me[F]=fe[1],B.push({position:me,value:J});var ye=0,Te=0,ve=1,be=1,Se=!0;for($[Te++]=z[0],$[Te++]=ge.left[0][0],$[Te++]=ge.left[0][1],$[Te++]=K[0],$[Te++]=ge.right[0][0],$[Te++]=ge.right[0][1];ve<ge.left.length||be<ge.right.length;){var we,Ee,xe=!1;ve===ge.left.length?xe=!0:be!==ge.right.length&&(we=ge.left[ve],Ee=ge.right[be],xe=we[1]>Ee[1]);var Oe=xe?K[be]:z[ve],Ae=xe?ge.right[be]:ge.left[ve];if(xe!==Se)for(;ye+3<Te;)pe===xe?j.push([$[ye],$[ye+3],Oe]):j.push([$[ye+3],$[ye],Oe]),ye+=3;else for(;ye+3<Te;){for(se=0;se<2;++se)for(var Me=0;Me<2;++Me)q[se][Me]=$[Te-3*(se+1)+Me+1]-Ae[Me];var Re=q[0][0]*q[1][1]-q[1][0]*q[0][1];if(xe===0<Re)break;0!=Re&&(pe===xe?j.push([$[Te-3],$[Te-6],Oe]):j.push([$[Te-6],$[Te-3],Oe])),Te-=3}$[Te++]=Oe,$[Te++]=Ae[0],$[Te++]=Ae[1],xe?++be:++ve,Se=xe}}}}return{vertices:B,faces:j}}(O?(S,O,B)=>{var N=j.get(S,O,B);return N?N.colorIndex:0}:(S,O,B)=>{var N=j.get(S,O,B);return N?N.normalIndex+256*N.colorIndex:0},[S.sizeX,S.sizeY,S.sizeZ]),F=S.minBounds,_=S.scale,U=S.getNormals();let H=new Float32Array(3*L.length),V=new Float32Array(3*L.length),W=new Float32Array(3*L.length),z=0,K=0,$=0;for(let S=0,B=L.length;S<B;S++){var q=L[S],Q=O?q.value:q.value/256|0;H[z++]=F.x+q.position[0]*_.x,H[z++]=F.y+q.position[1]*_.y,H[z++]=F.z+q.position[2]*_.z,W[$++]=Q/255,W[$++]=0,W[$++]=0,O||(q=q.value%256,q=U[Math.min(q,U.length-1)],V[K++]=q.x,V[K++]=q.y,V[K++]=q.z)}let Z=new Uint32Array(3*D.length),Y=0;for(let S=0,O=D.length;S<O;S++){var X=D[S];Z[Y++]=X[0],Z[Y++]=X[1],Z[Y++]=X[2]}let J=new THREE.BufferGeometry;return J.addAttribute("position",new THREE.BufferAttribute(H,3)),O||J.addAttribute("normal",new THREE.BufferAttribute(V,3)),J.addAttribute("color",new THREE.BufferAttribute(W,3)),J.setIndex(new THREE.BufferAttribute(Z,1)),J=B.BufferGeometryUtils.mergeVertices(J),J.computeBoundingBox(),O&&J.computeVertexNormals(),J}}),N=class{constructor(S,O,B,N){this.color=S,this.left=[[B,O]],this.right=[[N,O]]}close_off(S){this.left.push([this.left[this.left.length-1][0],S]),this.right.push([this.right[this.right.length-1][0],S])}merge_run(S,O,B){var N=this.left[this.left.length-1][0],j=this.right[this.right.length-1][0];N!==O&&(this.left.push([N,S]),this.left.push([O,S])),j!==B&&(this.right.push([j,S]),this.right.push([B,S]))}}}}}),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryNaiveBuilder",["engine/gfx/BufferGeometryUtils"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("VxlGeometryNaiveBuilder",class{build(S){var{voxels:O,voxelField:N}=S.getAllVoxels();let j=new THREE.BoxBufferGeometry(1,1,1);var L=j.getAttribute("position").array.length/3,D=j.getAttribute("normal").array;let F=new THREE.BufferGeometry;return F.setIndex(this.createIndexAttr(O,j,L)),F.addAttribute("position",this.createPositionAttr(S,O,j)),F.addAttribute("normal",this.createNormalAttr(S,O,L)),F.addAttribute("color",this.createColorAttr(O,L,D,N)),F=B.BufferGeometryUtils.mergeVertices(F),F.computeBoundingBox(),F}createPositionAttr(S,O,B){var N=B.getAttribute("position").array,j=N.length;let L=new Float32Array(N.length*O.length);var D=S.minBounds,F=S.scale;for(let S=0,B=O.length;S<B;S++){var _=S*j,U=O[S];for(let S=0,O=N.length;S<O;S+=3)L[_+S]=D.x+U.x*F.x+N[S],L[_+S+1]=D.y+U.y*F.y+N[S+1],L[_+S+2]=D.z+U.z*F.z+N[S+2]}return new THREE.BufferAttribute(L,3)}createNormalAttr(S,O,B){let N=new Float32Array(B*O.length*3);var j=S.getNormals();for(let S=0,F=O.length;S<F;S++){var L=S*B*3,D=j[Math.min(O[S].normalIndex,j.length-1)];for(let S=0,O=3*B;S<O;S+=3)N[L+S]=D.x,N[L+S+1]=D.y,N[L+S+2]=D.z}return new THREE.BufferAttribute(N,3)}createColorAttr(S,O,B,N){let j=new Float32Array(O*S.length*3);for(let _=0,U=S.length;_<U;_++){var L=_*O*3,D=S[_];for(let S=0,_=3*O;S<_;S+=3){var F=N.get(D.x+B[S],D.y+B[S+1],D.z+B[S+2]);j[L+S]=F?0:D.colorIndex/255,j[L+S+1]=0,j[L+S+2]=0}}return new THREE.BufferAttribute(j,3)}createIndexAttr(S,O,B){var N=O.getIndex().array;let j=new Uint32Array(S.length*N.length);for(let O=0,L=S.length;O<L;O++)for(let S=0,L=N.length;S<L;S++)j[O*L+S]=O*B+N[S];return new THREE.BufferAttribute(j,1)}})}}}),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryPool",["engine/renderable/entity/unit/ModelQuality","util/typeGuard","engine/renderable/builder/vxlGeometry/VxlGeometryMonotoneBuilder"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("VxlGeometryPool",class{constructor(S,O=B.ModelQuality.High){this.cache=S,this.modelQuality=O}setModelQuality(S){this.modelQuality=S}getModelQuality(){return this.modelQuality}async loadFromStorage(S,O){return(await Promise.all(S.sections.map(S=>this.cache.loadFromStorage(S,O)))).every(N.isNotNullOrUndefined)}async persistToStorage(S,O,B){for(let j=0;j<S.sections.length;j++){var N=S.sections[j];await this.cache.persistToStorage(N,O,B[j])}}clear(){this.cache.clear()}async clearStorage(){await this.cache.clearStorage()}async clearOtherModStorage(){await this.cache.clearOtherModStorage()}get(S){let O=this.cache.get(S);return O||(O=(new j.VxlGeometryMonotoneBuilder).build(S),this.cache.set(S,O)),O}})}}}),System.register("engine/renderable/entity/Aircraft",["game/Coords","engine/renderable/WithPosition","engine/gfx/DebugUtils","util/math","game/gameobject/unit/VeteranLevel","engine/renderable/entity/HighlightAnimRunner","engine/Animation","game/gameobject/common/DeathType","game/gameobject/unit/ZoneType","engine/renderable/entity/InvulnerableAnimRunner","engine/renderable/entity/BoxIntersectObject3D","engine/renderable/entity/unit/RotorHelper","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/DebugRenderable"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S}],execute:function(){S("Aircraft",class{constructor(S,O,B,N,j,L,D,_,U,H,W,z,K){this.gameObject=S,this.rules=O,this.voxels=B,this.voxelAnims=N,this.palette=j,this.lighting=D,this.debugFrame=_,this.gameSpeed=U,this.selectionModel=H,this.vxlBuilderFactory=W,this.useSpriteBatching=z,this.pipOverlay=K,this.rotorSpeeds=[],this.vxlBuilders=[],this.highlightAnimRunner=new F.HighlightAnimRunner(this.gameSpeed),this.invulnAnimRunner=new V.InvulnerableAnimRunner(this.gameSpeed),this.plugins=[],this.objectRules=S.rules,this.objectArt=S.art,this.label="aircraft_"+this.objectRules.name,this.init()}init(){this.paletteRemaps=[...this.rules.colors.values()].map(S=>this.palette.clone().remap(S)),this.palette.remap(this.gameObject.owner.color),this.lastOwnerColor=this.gameObject.owner.color,this.withPosition=new N.WithPosition,this.updateBaseLight(),this.extraLight=(new THREE.Vector3).copy(this.baseExtraLight)}updateBaseLight(){this.baseExtraLight=(new THREE.Vector3).setScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile)+this.rules.audioVisual.extraAircraftLight)}updateLighting(){this.plugins.forEach(S=>S.updateLighting?.()),this.updateBaseLight(),this.extraLight.copy(this.baseExtraLight)}get3DObject(){return this.target}getIntersectTarget(){return this.target}getUiName(){var S=this.plugins.reduce((S,O)=>O.getUiNameOverride?.()??S,void 0);return void 0!==S?S:this.gameObject.getUiName()}create3DObject(){let S=this.get3DObject();S||(S=new W.BoxIntersectObject3D(new THREE.Vector3(1,1/3,1).multiplyScalar(B.Coords.LEPTONS_PER_TILE*(this.gameObject.rules.spawned?.5:1))),S.name=this.label,S.userData.id=this.gameObject.id,this.target=S,S.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(S),this.vxlBuilders.forEach(S=>S.setExtraLight(this.extraLight)),this.pipOverlay&&(this.pipOverlay.create3DObject(),this.posObj?.add(this.pipOverlay.get3DObject())))}setPosition(S){this.withPosition.setPosition(S.x,S.y,S.z)}getPosition(){return this.withPosition.getPosition()}registerPlugin(S){this.plugins.push(S)}highlight(){this.plugins.some(S=>S.shouldDisableHighlight?.())||this.highlightAnimRunner.animation.getState()!==_.AnimationState.RUNNING&&this.highlightAnimRunner.animate(2)}update(S){this.plugins.forEach(O=>O.update(S)),this.pipOverlay?.update(S),this.gameObject.veteranLevel!==this.lastVeteranLevel&&(this.gameObject.veteranLevel===D.VeteranLevel.Elite&&void 0!==this.lastVeteranLevel&&this.highlightAnimRunner.animate(30),this.lastVeteranLevel=this.gameObject.veteranLevel);var O=this.highlightAnimRunner.shouldUpdate(),B=this.gameObject.invulnerableTrait.isActive(),N=B!==this.lastInvulnerable;(this.lastInvulnerable=B)&&N&&this.invulnAnimRunner.animate(),this.invulnAnimRunner.shouldUpdate()&&this.invulnAnimRunner.tick(S),(O||N)&&(O&&this.highlightAnimRunner.tick(S),j=B?this.invulnAnimRunner.getValue():0,F=(O?this.highlightAnimRunner.getValue():0)||j,L=this.lighting.getAmbientIntensity(),K.ExtraLightHelper.multiplyVxl(this.extraLight,this.baseExtraLight,L,F));var j=(O=this.gameObject.warpedOutTrait.isActive())!==this.lastWarpedOut;this.lastWarpedOut=O;var L=this.gameObject.cloakableTrait?.isCloaked(),F=L!==this.lastCloaked;if(this.lastCloaked=L,j||F){let S=O||L?.5:1;this.vxlBuilders.forEach(O=>O.setOpacity(S)),this.placeholder?.setOpacity(S)}L=this.gameObject.owner.color,this.lastOwnerColor!==L&&(this.palette.remap(L),this.lastOwnerColor=L,this.vxlBuilders.forEach(S=>S.setPalette(this.palette)),this.placeholder?.setPalette(this.palette)),(L=this.gameObject.zone)!==this.lastZone&&(this.gameObject.rules.missileSpawn&&L===H.ZoneType.Air&&this.lastZone!==H.ZoneType.Air&&this.renderableManager.createTransientAnim("V3TAKOFF",S=>S.setPosition(this.withPosition.getPosition())),this.lastZone=L),this.updateVxlRotation()}updateVxlRotation(){var{pitch:S,yaw:O,roll:B}=this.gameObject;this.tiltObj.rotation.z=THREE.Math.degToRad(B),this.tiltObj.rotation.x=THREE.Math.degToRad(S),this.tiltObj.rotation.y=THREE.Math.degToRad(O),this.rotors&&this.rotors.forEach((S,O)=>{this.rotorSpeeds[O]=z.RotorHelper.computeRotationStep(this.gameObject,this.rotorSpeeds[O]??0,this.objectArt.rotors[O]),this.rotorSpeeds[O]&&(S.rotateOnAxis(this.objectArt.rotors[O].axis,this.rotorSpeeds[O]),S.updateMatrix())})}createObjects(S){if(this.debugFrame.value){let O=j.DebugUtils.createWireframe({width:1,height:1},1);O.translateX(-B.Coords.getWorldTileSize()/2),O.translateZ(-B.Coords.getWorldTileSize()/2),S.add(O)}let O=this.tiltObj=new THREE.Object3D;O.rotation.order="YXZ";var N=this.createMainObject();O.add(N);let L=this.posObj=new THREE.Object3D;L.matrixAutoUpdate=!1,L.add(O),S.add(L)}createMainObject(){var S=this.objectArt.imageName.toLowerCase(),O=S+".vxl",B=this.voxels.get(O);if(!B)return console.warn(`VXL missing for aircraft ${this.objectRules.name}. Vxl file ${O} not found. `),this.placeholder=new $.DebugRenderable({width:.5,height:.5},this.objectArt.height,this.palette,{centerFoundation:!0}),this.placeholder.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholder.setBatchPalettes(this.paletteRemaps),this.placeholder.create3DObject(),this.placeholder.get3DObject();O=this.objectArt.noHva?void 0:this.voxelAnims.get(S+".hva"),S=[...this.rules.colors.values()].map(S=>this.palette.clone().remap(S));let N=this.vxlBuilderFactory.create(B,O,S,this.palette);return this.vxlBuilders.push(N),S=N.build(),this.objectArt.rotors&&(this.rotors=this.objectArt.rotors.map(S=>{var O=N.getSection(S.name);if(!O)throw new Error(`Aircraft "${this.objectRules.name}" VXL section "${S.name}" not found`);return O})),S}onCreate(S){this.renderableManager=S,this.plugins.forEach(O=>O.onCreate(S))}onRemove(S){var O;this.renderableManager=void 0,this.plugins.forEach(O=>O.onRemove(S)),this.gameObject.isDestroyed&&this.objectRules.explosion.length&&this.gameObject.deathType!==U.DeathType.Temporal&&this.gameObject.deathType!==U.DeathType.None&&(O=(O=this.objectRules.explosion)[L.getRandomInt(0,O.length-1)],S.createTransientAnim(O,S=>{let O=this.withPosition.getPosition();this.gameObject.rules.missileSpawn&&(O=O.clone().add(this.gameObject.moveTrait.velocity.clone().setLength(this.rules.general.getMissileRules(this.gameObject.name).bodyLength))),S.setPosition(O)}))}dispose(){this.plugins.forEach(S=>S.dispose()),this.pipOverlay?.dispose(),this.vxlBuilders.forEach(S=>S.dispose()),this.placeholder?.dispose()}})}}}),System.register("engine/renderable/entity/Anim",["engine/renderable/WithPosition","engine/AnimProps","engine/Animation","engine/renderable/ShpRenderable","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/animation/SimpleRunner","engine/gfx/MathUtils","game/Coords"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){S("Anim",class{constructor(S,O,N,j,L,D,F,_,U,H=new THREE.Vector3(0,0,0),V,W){this.objectArt=O,this.extraOffset=N,this.imageFinder=j,this.theater=L,this.camera=D,this.debugFrame=F,this.gameSpeed=_,this.useSpriteBatching=U,this.extraLight=H,this.worldSound=V,this.renderOrder=0,this.name=S,this.palette=W??this.theater.getPalette(this.objectArt.paletteType,this.objectArt.customPaletteName),this.withPosition=new B.WithPosition}get3DObject(){return this.target}create3DObject(){let S=this.get3DObject();S||(S=new THREE.Object3D,S.name="anim_"+this.name,this.target=S,S.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(S))}setPosition(S){this.withPosition.setPosition(S.x,S.y,S.z)}getPosition(){return this.withPosition.getPosition()}update(S){if(this.animationRunner){(B=this.objectArt.startSound??this.objectArt.report)&&!this.soundHandle&&this.animation?.getState()===j.AnimationState.NOT_STARTED&&(this.soundHandle=this.worldSound?.playEffect(B,this.withPosition.getPosition(),void 0,1,.25)),this.animationRunner.tick(S),this.mainObj.get3DObject().visible=this.animation.getState()!==j.AnimationState.DELAYED,this.mainObj.setFrame(this.animationRunner.getCurrentFrame());var O=this.objectArt.translucent,B=this.objectArt.translucency;if(O||0<B){let S;S=O?(O=this.animation.props,1-this.animationRunner.getCurrentFrame()/(O.end-O.start)):1-B,this.mainObj.setOpacity(S)}}}createObjects(S){var O={width:1,height:1};this.debugFrame.value&&(L=F.DebugUtils.createWireframe(O,0),S.add(L));let B=new _.MapSpriteTranslation(O.width,O.height);var{spriteOffset:N,anchorPointWorld:j}=B.compute(),L=this.computeSpriteAnchorOffset(N);let D=new THREE.Object3D;if(D.matrixAutoUpdate=!1,this.mainObj=this.createMainObject(L),this.mainObj){if(this.mainObj.setExtraLight(this.extraLight),O=this.useSpriteBatching&&!this.renderOrder,this.mainObj.setBatched(O),O&&this.mainObj.setBatchPalettes([this.palette]),N=this.objectArt.translucent,L=this.objectArt.translucency,(N||0<L)&&this.mainObj.setForceTransparent(!0),this.mainObj.create3DObject(),this.renderOrder){if(O)throw new Error("Render order not supported with batching");this.mainObj.getShapeMesh().renderOrder=this.renderOrder,this.mainObj.getShapeMesh().material.depthTest=!this.renderOrder,this.mainObj.getShapeMesh().material.transparent=!!this.renderOrder}D.add(this.mainObj.get3DObject()),D.position.x=j.x,D.position.z=j.y,this.objectArt.zAdjust&&H.MathUtils.translateTowardsCamera(D,this.camera,-this.objectArt.zAdjust*V.Coords.ISO_WORLD_SCALE),D.updateMatrix(),S.add(D)}}setExtraLight(S){this.extraLight=S,this.mainObj?.setExtraLight(this.extraLight)}setRenderOrder(S){if(this.mainObj)throw new Error("Render order must be set before 3DObject is created");this.renderOrder=S}computeSpriteAnchorOffset(S){var O=this.objectArt.getDrawOffset();return{x:S.x+O.x+this.extraOffset.x,y:S.y+O.y+this.extraOffset.y}}createMainObject(S){let O;try{O=this.shpFile=this.imageFinder.findByObjectArt(this.objectArt)}catch(S){if(S instanceof D.ImageFinder.MissingImageError)return void console.warn(S.message);throw S}let B=L.ShpRenderable.factory(O,this.palette,this.camera,S);B.setFlat(this.objectArt.flat);var F=new N.AnimProps(this.objectArt.art,O);return this.animation=new j.Animation(F,this.gameSpeed),this.animationRunner=new U.SimpleRunner,this.animationRunner.animation=this.animation,B}getAnimProps(){return this.animation?.props}getShpFile(){return this.shpFile}remapColor(S){if(this.mainObj)throw new Error("Palette can only be remapped before creating 3DObject");let O=this.palette.clone();O.remap(S),this.palette=O}isAnimFinished(){return this.animation?.getState()===j.AnimationState.STOPPED}isAnimNotStarted(){return this.animation?.getState()===j.AnimationState.NOT_STARTED}endAnimationLoop(){this.animation?.endLoopAndPlayToEnd()}reset(){this.animation?.reset()}dispose(){this.mainObj?.dispose(),this.soundHandle?.isLoop&&this.soundHandle.stop()}})}}}),System.register("engine/renderable/entity/BoxIntersectObject3D",[],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[],execute:function(){B=new THREE.Ray,N=new THREE.Matrix4,j=new THREE.Box3,L=new THREE.Vector3,D=class extends THREE.Object3D{constructor(S){super(),this.boxSize=S}raycast(S,O){if(this.parent){N.getInverse(this.parent.matrixWorld),B.copy(S.ray).applyMatrix4(N),L.copy(this.position);let D=j.setFromCenterAndSize(L,this.boxSize);if(B.intersectsBox(D)){const B=new THREE.Vector3;D.getCenter(B),B.applyMatrix4(this.parent.matrixWorld),O.push({distance:S.ray.origin.distanceTo(B),point:B,object:this})}}}},S("BoxIntersectObject3D",D)}}}),System.register("engine/renderable/entity/Building",["engine/renderable/builder/ShpBuilder","engine/renderable/entity/building/DamageType","engine/renderable/entity/building/AnimationType","engine/gfx/OverlayUtils","game/gameobject/Building","engine/Animation","game/map/wallTypes","game/Coords","util/math","engine/AnimProps","engine/renderable/WithPosition","engine/renderable/ShpRenderable","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/renderable/entity/building/BuildingAnimArtProps","util/typeGuard","engine/renderable/entity/HighlightAnimRunner","game/rules/TechnoRules","game/gameobject/trait/AttackTrait","game/SideType","game/gameobject/trait/FactoryTrait","game/gameobject/trait/UnitRepairTrait","game/gameobject/common/DeathType","engine/renderable/entity/InvulnerableAnimRunner","engine/renderable/entity/building/BuildingShpHelper","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/AlphaRenderable","engine/renderable/DebugRenderable","engine/gfx/MathUtils"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S}],execute:function(){he=(new Map).set(j.AnimationType.PRODUCTION,j.AnimationType.IDLE).set(j.AnimationType.BUILDUP,j.AnimationType.IDLE).set(j.AnimationType.SPECIAL_DOCKING,j.AnimationType.IDLE).set(j.AnimationType.SPECIAL_REPAIR_START,j.AnimationType.SPECIAL_REPAIR_LOOP).set(j.AnimationType.SPECIAL_REPAIR_LOOP,j.AnimationType.SPECIAL_REPAIR_END).set(j.AnimationType.SPECIAL_REPAIR_END,j.AnimationType.IDLE).set(j.AnimationType.SUPER_CHARGE_START,j.AnimationType.SUPER_CHARGE_LOOP).set(j.AnimationType.SUPER_CHARGE_LOOP,j.AnimationType.SUPER_CHARGE_END).set(j.AnimationType.SUPER_CHARGE_END,j.AnimationType.IDLE).set(j.AnimationType.FACTORY_DEPLOYING,j.AnimationType.IDLE).set(j.AnimationType.FACTORY_ROOF_DEPLOYING,j.AnimationType.IDLE),ue=(new Map).set(j.AnimationType.SUPER_CHARGE_START,[j.AnimationType.SUPER,1]).set(j.AnimationType.SUPER_CHARGE_LOOP,[j.AnimationType.SUPER,2]).set(j.AnimationType.SUPER_CHARGE_END,[j.AnimationType.SUPER,3]).set(j.AnimationType.SPECIAL_REPAIR_START,[j.AnimationType.SPECIAL,0]).set(j.AnimationType.SPECIAL_REPAIR_LOOP,[j.AnimationType.SPECIAL,1]).set(j.AnimationType.SPECIAL_REPAIR_END,[j.AnimationType.SPECIAL,2]).set(j.AnimationType.SPECIAL_DOCKING,[j.AnimationType.SPECIAL,0]).set(j.AnimationType.SPECIAL_SHOOT,[j.AnimationType.SPECIAL,0]).set(j.AnimationType.FACTORY_DEPLOYING,[j.AnimationType.FACTORY_DEPLOYING,0]).set(j.AnimationType.FACTORY_UNDER_DOOR,[j.AnimationType.FACTORY_DEPLOYING,1]).set(j.AnimationType.FACTORY_ROOF_DEPLOYING,[j.AnimationType.FACTORY_ROOF_DEPLOYING,0]).set(j.AnimationType.FACTORY_UNDER_ROOF_DOOR,[j.AnimationType.FACTORY_ROOF_DEPLOYING,1]),S("Building",de=class e{constructor(S,O,B,N,L,D,F,_,U,H,V,z,$,q,Z,X,J,ee,te,ie,re,ae=j.AnimationType.IDLE){this.gameObject=S,this.selectionModel=O,this.rules=B,this.art=N,this.imageFinder=L,this.voxels=F,this.voxelAnims=_,this.palette=U,this.animPalette=H,this.isoPalette=V,this.camera=z,this.lighting=$,this.debugFrame=q,this.gameSpeed=Z,this.vxlBuilderFactory=X,this.useSpriteBatching=J,this.buildingImageDataCache=te,this.pipOverlay=ie,this.worldSound=re,this.initialAnimType=ae,this.animObjects=new Map,this.animations=new Map,this.animSounds=new Map,this.powered=!0,this.repairStopRequested=!1,this.repairStartRequested=!1,this.highlightAnimRunner=new Y.HighlightAnimRunner(this.gameSpeed),this.invulnAnimRunner=new se.InvulnerableAnimRunner(this.gameSpeed),this.plugins=[],this.objectArt=S.art,this.objectRules=S.rules,this.type=this.objectRules.name,this.paletteRemaps=[...this.rules.colors.values()].map(S=>this.palette.clone().remap(S)),this.palette.remap(this.gameObject.owner.color),this.lastOwnerColor=this.gameObject.owner.color,this.updateBaseLight(),this.vxlExtraLight=(new THREE.Vector3).copy(this.baseVxlExtraLight),this.shpExtraLight=(new THREE.Vector3).copy(this.baseShpExtraLight);var oe=this.animArtProps=new Q.BuildingAnimArtProps;let le,ce;this.animArtProps.read(this.objectArt.art,this.art);try{le=this.imageFinder.findByObjectArt(this.objectArt)}catch(S){if(!(S instanceof K.ImageFinder.MissingImageError))throw S;console.warn(S.message)}this.mainShpFile=le;try{ce=this.objectArt.bibShape?this.imageFinder.find(this.objectArt.bibShape,this.objectArt.useTheaterExtension):void 0}catch(S){if(!(S instanceof K.ImageFinder.MissingImageError))throw S;console.warn(S.message)}this.bibShpFile=ce;let he=new ne.BuildingShpHelper(this.imageFinder);oe=this.animShpFiles=he.collectAnimShpFiles(oe,this.objectArt);let ue=this.shpFrameInfos=he.getShpFrameInfos(this.objectArt,le,ce,oe),de=this.buildingImageDataCache.get(this.gameObject.name);de||(de=ee.aggregate(ue.values(),`agg_${this.objectRules.name}.shp`),this.buildingImageDataCache.set(this.gameObject.name,de)),this.aggregatedImageData=de,this.withPosition=new W.WithPosition}updateBaseLight(){this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile).addScalar(-1),this.baseVxlExtraLight=(new THREE.Vector3).setScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile))}updateLighting(){this.updateBaseLight(),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight),this.plugins.forEach(S=>S.updateLighting?.())}get3DObject(){return this.target}getIntersectTarget(){return this.intersectTarget}updateIntersectTarget(){this.intersectTarget=[this.placeholderObj?.get3DObject(),this.mainObj?.getShapeMesh(),this.bib?.getShapeMesh(),...[...this.animObjects.values()].flat().map(S=>S.getShapeMesh())].filter(Z.isNotNullOrUndefined)}getUiName(){var S=this.plugins.reduce((S,O)=>O.getUiNameOverride?.()??S,void 0);return void 0!==S?S:this.gameObject.getUiName()}create3DObject(){let S=this.get3DObject();if(!S){S=new THREE.Object3D,S.name="building_"+this.type,S.userData.id=this.gameObject.id,this.target=S,S.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this);var O=this.gameObject.rules.alphaImage;if(O){var N=this.imageFinder.tryFind(O,!1);if(N){let O=new oe.AlphaRenderable(N,this.camera,new THREE.Vector2(0,(U.Coords.ISO_TILE_SIZE+1)/2));O.create3DObject(),S.add(O.get3DObject())}else console.warn(`<${this.objectRules.name}>: Alpha image "${O}" not found`)}this.objectRules.lightIntensity&&(this.createLamp(S),this.objectRules.isLightpost)||(this.createObjects(S),this.updateIntersectTarget(),this.pipOverlay&&(this.pipOverlay.create3DObject(),S.add(this.pipOverlay.get3DObject())),this.updateImage(this.computeDamageType(this.gameObject.healthTrait.health)),this.mainObj?.setExtraLight(this.shpExtraLight),[...this.animObjects.values()].forEach(S=>{S.forEach(S=>{this.animations.get(S).props.getArt().has("UseNormalLight")||S.setExtraLight(this.shpExtraLight)})}),this.bib?.setExtraLight(this.shpExtraLight),this.turretBuilders?.forEach(S=>{S instanceof B.ShpBuilder?S.setExtraLight(this.shpExtraLight):S.setExtraLight(this.vxlExtraLight)}))}}createLamp(S){var O=this.objectRules;let B=(1+O.lightRedTint)*(1+Math.abs(O.lightIntensity))-1,N=(1+O.lightGreenTint)*(1+Math.abs(O.lightIntensity))-1,j=(1+O.lightBlueTint)*(1+Math.abs(O.lightIntensity))-1;var L=Math.max(B,N,j);1<L&&(B/=L,N/=L,j/=L),L=new THREE.Color(B,N,j).multiplyScalar(.9).getHexString();let D=e.lampTextures.get(L);D||(D=this.createLampTexture(L),e.lampTextures.set(L,D)),L=new THREE.MeshBasicMaterial({map:D,depthTest:!1,depthWrite:!1,transparent:!0,blending:THREE.CustomBlending,blendEquation:0<O.lightIntensity?THREE.AddEquation:THREE.ReverseSubtractEquation,blendSrc:THREE.DstColorFactor,blendDst:THREE.OneFactor}),O=O.lightVisibility,O=new THREE.PlaneBufferGeometry(2*O,2*O);let F=new THREE.Mesh(O,L);F.rotation.x=-Math.PI/2,F.renderOrder=999995,F.matrixAutoUpdate=!1,F.updateMatrix(),S.add(F)}createLampTexture(S){let O=document.createElement("canvas");O.width=O.height=32;let B=O.getContext("2d");B.fillStyle="black",B.fillRect(0,0,32,32);let N=B.createRadialGradient(16,16,0,16,16,16);N.addColorStop(0,"#"+S),N.addColorStop(1,"black"),B.arc(16,16,16,0,2*Math.PI),B.fillStyle=N,B.fill();let j=new THREE.Texture(O);return j.needsUpdate=!0,j}setPosition(S){var O=this.gameObject.getFoundationCenterOffset();this.withPosition.setPosition(S.x-O.x,S.y,S.z-O.y)}getPosition(){return this.withPosition.getPosition()}registerPlugin(S){this.plugins.push(S)}highlight(){this.plugins.some(S=>S.shouldDisableHighlight?.())||this.highlightAnimRunner.animate(2)}update(S){if(!this.objectRules.isLightpost){this.gameObject.isDestroyed||void 0!==this.currentAnimType||this.setAnimation(this.initialAnimType,S),this.plugins.forEach(O=>O.update(S)),this.pipOverlay?.update(S);var O=this.gameObject.c4ChargeTrait?.hasCharge();!this.gameObject.isDestroyed&&this.lastHasC4Charge!==O&&O&&(this.lastHasC4Charge=O,this.highlight());var B=this.highlightAnimRunner.shouldUpdate(),L=this.gameObject.invulnerableTrait.isActive();O=L!==this.lastInvulnerable,(this.lastInvulnerable=L)&&O&&this.invulnAnimRunner.animate(),this.invulnAnimRunner.shouldUpdate()&&this.invulnAnimRunner.tick(S),(B||O||L)&&(B&&this.highlightAnimRunner.tick(S),L=L?this.invulnAnimRunner.getValue():0,U=(B?this.highlightAnimRunner.getValue():0)||L,L=this.lighting.getAmbientIntensity(),ae.ExtraLightHelper.multiplyVxl(this.vxlExtraLight,this.baseVxlExtraLight,L,U),ae.ExtraLightHelper.multiplyShp(this.shpExtraLight,this.baseShpExtraLight,U));var _,U=this.gameObject.warpedOutTrait.isActive();if(U!==this.lastWarpedOut){let S=(this.lastWarpedOut=U)?.5:1;for(_ of[this.mainObj,this.bib,...[...this.animObjects.values()].flat()])_?.setOpacity(S);this.turretBuilders?.forEach(O=>O.setOpacity(S)),this.placeholderObj?.setOpacity(S)}this.gameObject.isDestroyed||(H=this.gameObject.owner.color,this.lastOwnerColor!==H&&(this.palette.remap(H),this.mainObj?.setPalette(this.palette),[...this.animObjects.values()].forEach(S=>{S.forEach(S=>S.setPalette(this.palette))}),this.bib?.setPalette(this.palette),this.turretBuilders?.forEach(S=>S.setPalette(this.palette)),this.placeholderObj?.setPalette(this.palette),this.lastOwnerColor=H)),!this.gameObject.isDestroyed&&he.has(this.currentAnimType)&&(V=he.get(this.currentAnimType),this.hasObjectWithStoppedAnimation(this.currentAnimType)&&this.setAnimation(V,S)),this.gameObject.isDestroyed||this.gameObject.buildStatus!==D.BuildStatus.BuildDown||this.currentAnimType===j.AnimationType.UNBUILD||this.setAnimation(j.AnimationType.UNBUILD,S);var H=this.gameObject.attackTrait?.attackState;if((void 0===this.lastAttackState||this.lastAttackState!==H&&!this.gameObject.isDestroyed)&&(this.lastAttackState=H,!this.gameObject.isDestroyed&&this.hasAnimation(j.AnimationType.SPECIAL_SHOOT)&&(H===J.AttackState.FireUp?this.setAnimation(j.AnimationType.SPECIAL_SHOOT,S):this.currentAnimType===j.AnimationType.SPECIAL_SHOOT&&this.setAnimation(j.AnimationType.IDLE,S)),H===J.AttackState.JustFired&&this.objectArt.muzzleFlash)){let S=this.createMuzzleFlashAnim(this.spriteOffset,this.renderableManager);S&&(S.create3DObject(),this.spriteWrap.add(S.get3DObject()),this.muzzleAnims=this.muzzleAnims||[],this.muzzleAnims.push(S))}var V=this.gameObject.factoryTrait;if(V){var W=V.status;if(this.lastFactoryStatus!==W&&!this.gameObject.isDestroyed&&(H=this.lastFactoryStatus,this.lastFactoryStatus=W,void 0!==H)){let O,B=!1;[X.FactoryType.BuildingType,X.FactoryType.NavalUnitType].includes(V.type)?O=j.AnimationType.PRODUCTION:V.type===X.FactoryType.UnitType?(O=V.deliveringUnit?.rules.consideredAircraft?j.AnimationType.FACTORY_ROOF_DEPLOYING:j.AnimationType.FACTORY_DEPLOYING,B=!0):O=void 0,O&&this.hasAnimation(O)&&(W===te.FactoryStatus.Delivering?this.setAnimation(O,S):B&&this.setAnimation(j.AnimationType.IDLE,S))}}W=this.gameObject.unitRepairTrait?.status,this.lastRepairStatus===W||this.gameObject.isDestroyed||($=this.lastRepairStatus,this.lastRepairStatus=W,this.hasAnimation(j.AnimationType.SPECIAL_REPAIR_START)&&(W===ie.RepairStatus.Repairing?(this.currentAnimType!==j.AnimationType.SPECIAL_REPAIR_LOOP&&this.currentAnimType!==j.AnimationType.SPECIAL_REPAIR_END||$!==ie.RepairStatus.Idle?this.setAnimation(j.AnimationType.SPECIAL_REPAIR_START,S):this.repairStartRequested=!0,this.repairStopRequested=!1):(this.currentAnimType===j.AnimationType.SPECIAL_REPAIR_START?this.repairStopRequested=!0:this.endCurrentAnimation(),this.repairStartRequested=!1)));let Q=this.gameObject.superWeaponTrait?.getSuperWeapon(this.gameObject);!Q||!this.hasAnimation(j.AnimationType.SUPER_CHARGE_START)||this.gameObject.isDestroyed||(q=Q.getTimerSeconds()<=60*this.objectRules.chargedAnimTime)!==this.lastSuperWeaponAlmostCharged&&((this.lastSuperWeaponAlmostCharged=q)?this.setAnimation(j.AnimationType.SUPER_CHARGE_START,S):this.endCurrentAnimation()),this.repairStopRequested&&this.currentAnimType===j.AnimationType.SPECIAL_REPAIR_LOOP&&(this.endCurrentAnimation(),this.repairStopRequested=!1),this.repairStartRequested&&this.currentAnimType===j.AnimationType.IDLE&&(this.setAnimation(j.AnimationType.SPECIAL_REPAIR_START,S),this.repairStartRequested=!1),this.muzzleAnims&&this.updateMuzzleAnims(S),U||(this.animations.forEach((O,B)=>{switch(O.getState()){case F.AnimationState.STOPPED:return;case F.AnimationState.DELAYED:O.update(S),B.get3DObject().visible=O.getState()!==F.AnimationState.DELAYED;break;case F.AnimationState.NOT_STARTED:O.start(S);case F.AnimationState.RUNNING:default:O.update(S)}B.setFrame(O.getCurrentFrame())}),this.animObjects.forEach((S,O)=>{let B=this.animArtProps.getByType(O);S.forEach((S,O)=>{var N=B[O];let j=this.animations.get(S);var L=N.translucent;if(N=N.translucency,L||0<N){let O;O=L?(L=j.props,1-j.getCurrentFrame()/(L.end-L.start)):1-N,S.setOpacity(O)}})})),this.toggleRangeCircleVisibility((this.gameObject.showWeaponRange||this.selectionModel.isSelected()&&-1!==this.gameObject.rules.techLevel)&&!U),W=this.gameObject.wallTrait?.wallType!==this.lastWallType;var z,K,$=void 0===this.lastOccupiedState||this.lastOccupiedState!==!!this.gameObject.garrisonTrait?.isOccupied(),q=void 0===this.lastHealth||this.lastHealth!==this.gameObject.healthTrait.health;(W||$||q)&&(z=this.computeDamageType(this.gameObject.healthTrait.health),q=q&&z!==this.computeDamageType(this.lastHealth),this.lastOccupiedState=!!this.gameObject.garrisonTrait?.isOccupied(),this.lastHealth=this.gameObject.healthTrait.health,this.lastWallType=this.gameObject.wallTrait?.wallType,(W||$||q)&&this.updateImage(z),q&&z===N.DamageType.DESTROYED&&this.objectRules.explosion.length&&this.createExplosionAnims(this.renderableManager)),this.gameObject.turretTrait&&((z=this.gameObject.turretTrait.facing)!==this.lastTurretFacing&&(this.lastTurretFacing=z,this.turretRot.rotation.y=THREE.Math.degToRad(z),this.turretRot.updateMatrix()),z=this.gameObject.turretTrait.isRotating()&&!U,this.lastTurretRotating!==z&&(this.lastTurretRotating=z,(K=this.objectRules.turretRotateSound)&&(z&&!this.gameObject.isDestroyed?this.turretRotateSound=this.worldSound?.playEffect(K,this.gameObject,this.gameObject.owner):this.turretRotateSound?.stop()))),this.gameObject.poweredTrait&&(this.gameObject.isDestroyed?this.poweredSound&&(this.poweredSound.stop(),this.poweredSound=void 0):(K=this.gameObject.poweredTrait.isPoweredOn()&&!U)!==this.lastPowered&&(this.setPowered(K),this.lastPowered=K,this.poweredSound?.stop(),(K=K?this.gameObject.rules.workingSound:this.gameObject.rules.notWorkingSound)&&!U&&(this.poweredSound=this.worldSound?.playEffect(K,this.gameObject,this.gameObject.owner,.25))))}}createExplosionAnims(S){var O=this.objectArt.foundation,B=this.objectRules.explosion;for(let j=0;j<O.width;j++)for(let L=0;L<O.height;L++){var N=B[H.getRandomInt(0,B.length-1)];S.createTransientAnim(N,S=>{S.setPosition(U.Coords.tile3dToWorld(j,L,0).add(this.withPosition.getPosition()))})}}updateMuzzleAnims(S){let O=this.muzzleAnims,B=[];O.forEach(O=>{O.update(S),O.isAnimFinished()&&(this.spriteWrap.remove(O.get3DObject()),O.dispose(),B.push(O))}),B.forEach(S=>O.splice(O.indexOf(S),1))}getNormalizedAnimType(S){let O=0,B=S;return ue.has(S)&&([B,O]=ue.get(S)),[B,O]}hasObjectWithStoppedAnimation(S){var O,[O,B]=this.getNormalizedAnimType(S);if(O=this.animObjects.get(O)){let N=this.animations.get(O[B]);if(!N)throw new Error(`Missing animation for type '${j.AnimationType[S]}'`);if(N.getState()===F.AnimationState.STOPPED)return!0}return!1}computeDamageType(S){if(!S)return N.DamageType.DESTROYED;let O;return O=S>100*this.rules.audioVisual.conditionYellow?N.DamageType.NORMAL:S>100*this.rules.audioVisual.conditionRed?N.DamageType.CONDITION_YELLOW:N.DamageType.CONDITION_RED,(O&&this.objectRules.canBeOccupied||O===N.DamageType.CONDITION_RED)&&(O-=1),O}updateImage(S){let O=S===N.DamageType.DESTROYED;O?(this.objectRules.leaveRubble&&this.rubbleObj&&(this.rubbleObj.get3DObject().visible=!0),this.mainObj&&(this.mainObj.get3DObject().visible=!1)):this.gameObject.wallTrait?this.updateWallImage(this.gameObject.wallTrait.wallType,S):this.updateMainObjFrame(!!this.gameObject.garrisonTrait?.isOccupied(),S),this.bib&&(O&&(this.bib.get3DObject().visible=!1),this.bib.setFrame(S!==N.DamageType.NORMAL?1:0)),this.turret&&O&&(this.turret.visible=!1),this.animObjects.forEach((B,L)=>{B.forEach((D,F)=>{if(L!==j.AnimationType.BUILDUP&&L!==j.AnimationType.UNBUILD){O&&B.forEach(S=>S.get3DObject().visible=!1);let H=this.animations.get(D);var _=S!==N.DamageType.NORMAL,U=this.animArtProps.getByType(L)[F];!_||U.damagedArt?(H.props.setArt(_?U.damagedArt:U.art),H.rewind()):console.warn(`<${this.gameObject.name}>: Missing damaged anim ${j.AnimationType[L]},`+F)}})});let B=S!==N.DamageType.NORMAL&&!O;this.fireObjects.forEach(S=>{S.get3DObject().visible=B;let O=this.animations.get(S);O.rewind();var N=O.props.getArt().getString("StartSound");N&&this.handleSoundChange(N,S,B,.15)})}updateMainObjFrame(S,O){let B=S?2:O;this.mainShpFile&&this.mainObj&&(B>=this.shpFrameInfos.get(this.mainShpFile).frameCount&&(console.warn(`Building ${this.objectRules.name} has damage frame `+B+` (occupied=${S}, damageType=${N.DamageType[O]}) out of bounds`),B=N.DamageType.NORMAL),this.mainObj.setFrame(B))}updateWallImage(S,O){var B;this.mainObj&&this.mainShpFile&&(B=this.shpFrameInfos.get(this.mainShpFile).frameCount<_.wallTypes.length?1:_.wallTypes.length,this.mainObj.setFrame(S+O*B))}createObjects(S){var O=this.objectArt.foundation;this.debugFrame.value&&(L=$.DebugUtils.createWireframe(O,this.objectArt.height),S.add(L));let B=new q.MapSpriteTranslation(O.width,O.height);var{spriteOffset:N,anchorPointWorld:j}=B.compute(),L=this.spriteOffset=this.computeSpriteAnchorOffset(N);let D=this.spriteWrap=new THREE.Object3D;D.matrixAutoUpdate=!1;let F=D,_={...L},H=!1;if(N=this.objectArt.zShapePointMove,(this.gameObject.rules.refinery||this.gameObject.rules.nukeSilo)&&N.length){F=new THREE.Object3D,F.matrixAutoUpdate=!1,D.add(F),H=!0,N={x:-N[0]/U.Coords.ISO_TILE_SIZE,y:-N[1]/U.Coords.ISO_TILE_SIZE};let S=new q.MapSpriteTranslation(N.x,N.y);var{spriteOffset:V,anchorPointWorld:N}=S.compute();F.position.x=N.x,F.position.z=N.y,F.updateMatrix(),_.x+=V.x,_.y+=V.y}if(this.mainShpFile?(this.mainObj=this.createMainObject(this.mainShpFile,_,H),this.mainObj.create3DObject(),F.add(this.mainObj.get3DObject()),this.mainObj.getFlat()&&(ce.MathUtils.translateTowardsCamera(this.mainObj.get3DObject(),this.camera,+U.Coords.ISO_WORLD_SCALE),this.mainObj.get3DObject().updateMatrix())):(this.placeholderObj=new le.DebugRenderable(O,this.objectArt.height,this.palette),this.placeholderObj.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholderObj.setBatchPalettes(this.paletteRemaps),this.placeholderObj.create3DObject(),S.add(this.placeholderObj.get3DObject())),this.objectRules.leaveRubble&&(this.rubbleObj=this.createRubbleObject(L),this.rubbleObj&&(this.rubbleObj.setExtraLight(this.shpExtraLight),this.rubbleObj.create3DObject(),this.rubbleObj.get3DObject().visible=!1,D.add(this.rubbleObj.get3DObject()))),this.createAnimObjects(_,H).forEach(S=>{F.add(S)}),this.fireObjects=this.createFireObjects(L),this.fireObjects.forEach(S=>{D.add(S.get3DObject())}),this.objectRules.turret&&(({turret:V,turretRot:O}=this.createTurretObject(L,j)),this.turret=V,this.turretRot=O,D.add(this.turret)),this.bibShpFile){this.bib=this.createBibObject(this.bibShpFile,L),this.bib.create3DObject();let S=this.bib.get3DObject();ce.MathUtils.translateTowardsCamera(S,this.camera,-1),S.updateMatrix(),D.add(this.bib.get3DObject())}if((this.gameObject.primaryWeapon||this.gameObject.rules.hasRadialIndicator)&&(L=this.gameObject.psychicDetectorTrait?.radiusTiles??this.gameObject.gapGeneratorTrait?.radiusTiles??this.gameObject.primaryWeapon?.range)){L=this.rangeCircle=this.createRangeCircle(L);let O=this.rangeCircleWrapper=new THREE.Object3D;O.matrixAutoUpdate=!1,O.position.x=j.x/2,O.position.z=j.y/2,O.updateMatrix(),O.visible=!1,O.add(L),S.add(O)}D.position.x=j.x,D.position.z=j.y,D.updateMatrix(),S.add(D)}computeSpriteAnchorOffset(S){var O=this.objectArt.getDrawOffset();return{x:S.x+O.x,y:S.y+O.y}}createMainObject(S,O,B=!1){let N=!1;this.objectRules.turret&&"CAOUTP"!==this.objectRules.name&&(N=!0);let j=z.ShpRenderable.factory(this.aggregatedImageData.file,this.palette,this.camera,O,this.objectArt.hasShadow,0,!N,0,B);return j.setSize(S),j.setFrameOffset(this.aggregatedImageData.imageIndexes.get(S)),j.setBatched(this.useSpriteBatching),this.useSpriteBatching&&j.setBatchPalettes(this.paletteRemaps),j.setFlat(N),j}createRubbleObject(S){var O=this.mainShpFile;if(O){let B=z.ShpRenderable.factory(this.aggregatedImageData.file,this.isoPalette,this.camera,S,this.objectArt.hasShadow);if(B.setSize(O),!(this.shpFrameInfos.get(O).frameCount<4))return B.setFrameOffset(this.aggregatedImageData.imageIndexes.get(O)),B.setBatched(this.useSpriteBatching),this.useSpriteBatching&&B.setBatchPalettes([this.isoPalette]),B.setFlat(!0),B.setFrame(3),B;console.warn(`Building image ${this.objectArt.imageName} has no rubble frame (missing 4th frame)`)}}createAnimObjects(S,O){let B=[];return this.animArtProps.getAll().forEach((N,j)=>{let L=[],D=1;for(var F of N){var _=this.animShpFiles.get(F);if(_){let N=this.createAnimObject(F,_,S,D++,O);N&&(B.push(N.get3DObject()),L.push(N))}}this.animObjects.set(j,L)}),B}createFireObjects(S){let O=[],N=0;for(;;){let D=this.objectArt.art.getString("DamageFireOffset"+N++);if(!D)break;var j=this.rules.audioVisual.fireNames,L=j[H.getRandomInt(0,j.length-1)];let _;try{_=this.imageFinder.find(L,this.objectArt.useTheaterExtension)}catch(S){if(S instanceof K.ImageFinder.MissingImageError){console.warn(S.message);continue}throw S}j=D.split(/\.|,/).filter(S=>""!==S);let W=parseInt(j[0],10),$=parseInt(j[1],10);j=this.animPalette;let q=new B.ShpBuilder(_,j,this.camera,U.Coords.ISO_WORLD_SCALE,!0,3);q.setOffset({x:S.x+W,y:S.y+$});let Q=new z.ShpRenderable(q);Q.setBatched(this.useSpriteBatching),this.useSpriteBatching&&Q.setBatchPalettes([j]),Q.create3DObject(),Q.get3DObject().visible=!1,L=this.art.getAnimation(L),L=new V.AnimProps(L.art,_),this.animations.set(Q,new F.Animation(L,this.gameSpeed)),O.push(Q)}return O}createMuzzleFlashAnim(S,O){if(this.objectArt.muzzleFlash?.length){var B=H.getRandomInt(0,this.objectArt.muzzleFlash.length-1),N=this.objectArt.muzzleFlash[B];if((B=this.gameObject.owner.country?.side===ee.SideType.GDI?this.gameObject.primaryWeapon:this.gameObject.secondaryWeapon)&&(B=B.rules.anim).length){B=B[H.getRandomInt(0,B.length-1)];let j={x:S.x+N.x,y:S.y+N.y};return O.createAnim(B,S=>{S.extraOffset=j},!0)}}}createAnimObject(S,O,B,N,L){var D=S.art;let _=new V.AnimProps(D,O);S.type!==j.AnimationType.BUILDUP&&S.type!==j.AnimationType.UNBUILD||(U=_.shadow?O.numImages/2:O.numImages,_.rate=U/(60*this.rules.general.buildupTime));var U={x:B.x+S.offset.x,y:B.y+S.offset.y};let H=z.ShpRenderable.factory(this.aggregatedImageData.file,this.palette,this.camera,U,_.shadow,0,!S.flat,N,L&&!S.flat);return H.setSize(O),H.setFrameOffset(this.aggregatedImageData.imageIndexes.get(O)),H.setBatched(this.useSpriteBatching),this.useSpriteBatching&&H.setBatchPalettes(this.paletteRemaps),H.setFlat(S.flat),(S.translucent||0<S.translucency)&&H.setForceTransparent(!0),H.create3DObject(),this.animations.set(H,new F.Animation(_,this.gameSpeed)),H}createBibObject(S,O){let B=z.ShpRenderable.factory(this.aggregatedImageData.file,this.palette,this.camera,O,this.objectArt.hasShadow);return B.setSize(S),B.setFrameOffset(this.aggregatedImageData.imageIndexes.get(S)),B.setBatched(this.useSpriteBatching),this.useSpriteBatching&&B.setBatchPalettes(this.paletteRemaps),B.setFlat(!0),B}createTurretObject(S,O){this.turretBuilders=[];let N=new THREE.Object3D;N.matrixAutoUpdate=!1;let j=new THREE.Object3D;j.matrixAutoUpdate=!1;let L=this.objectRules.turretAnim;var D={x:this.objectRules.turretAnimX,y:this.objectRules.turretAnimY};let F;if(this.objectRules.turretAnimIsVoxel){var _=!this.objectArt.noHva;let S=L.toLowerCase()+".vxl";var H=this.voxels.get(S);if(H){var V=_?this.voxelAnims.get(S.replace(".vxl",".hva")):void 0;let O=this.vxlBuilderFactory.create(H,V,this.paletteRemaps,this.palette);this.turretBuilders.push(O),F=O.build(),F.children.forEach(S=>S.castShadow=!1)}else console.warn(`Turret missing for building ${this.type}. Vxl file ${S} not found. `);if(L.toLowerCase().includes("tur")){let O=S.replace("tur","barl");if(V=this.voxels.get(O)){var W=_?this.voxelAnims.get(O.replace(".vxl",".hva")):void 0;let S=this.vxlBuilderFactory.create(V,W,this.paletteRemaps,this.palette);this.turretBuilders.push(S);let B=S.build();B.children.forEach(S=>S.castShadow=!1),j.add(B)}}W=U.Coords.screenDistanceToWorld(D.x,D.y),N.position.x=-O.x+W.x,N.position.z=-O.y+W.y}else{let N;try{N=this.imageFinder.find(L,this.objectArt.useTheaterExtension)}catch(O){if(!(O instanceof K.ImageFinder.MissingImageError))throw O;console.warn(O.message)}if(N){let O=new B.ShpBuilder(N,this.palette,this.camera,U.Coords.ISO_WORLD_SCALE,!0,2);O.setBatched(this.useSpriteBatching),this.useSpriteBatching&&O.setBatchPalettes(this.paletteRemaps),this.turretBuilders.push(O),O.setOffset({x:S.x+D.x,y:S.y+D.y}),F=O.build()}}return F&&j.add(F),N.add(j),ce.MathUtils.translateTowardsCamera(N,this.camera,-(this.objectRules.turretAnimZAdjust+this.objectRules.turretAnimY/Math.cos(this.camera.rotation.y))*U.Coords.ISO_WORLD_SCALE),N.updateMatrix(),{turret:N,turretRot:j}}createRangeCircle(S){var O=S*U.Coords.getWorldTileSize();let B=this.gameObject.owner.color,N=L.OverlayUtils.createGroundCircle(O,B.asHex());return N.matrixAutoUpdate=!1,N.updateMatrix(),N}toggleRangeCircleVisibility(S){var O;this.rangeCircleWrapper&&(this.rangeCircleWrapper.visible=S,(O=this.gameObject.overpoweredTrait?.isOverpowered())!==this.lastOverpowered&&(this.lastOverpowered=O,this.rangeCircle&&(this.rangeCircleWrapper.remove(this.rangeCircle),this.rangeCircle.material.dispose(),this.rangeCircle.geometry.dispose()),(O=this.gameObject.overpoweredTrait?.getWeapon()?.range)&&(this.rangeCircle=this.createRangeCircle(O),this.rangeCircleWrapper.add(this.rangeCircle))))}setAnimationVisibility(S,O,B=-1){let N=this.animObjects.get(S);if(void 0===N)throw new Error(`Missing animObjects for animType "${j.AnimationType[S]}"`);if(-1!==B){if(B>=N.length)throw new RangeError(`Index ${B} exceeds length of animation objects (${N.length}) of type `+j.AnimationType[S]);N=[N[B]]}for(var L of N){L.get3DObject().visible=O;let S=this.animations.get(L).props.getArt(),B=S.getString("Report");B=B||S.getString("StartSound"),B&&this.handleSoundChange(B,L,O)}}setActiveAnimationVisible(){let S=this.animArtProps.getByType(j.AnimationType.ACTIVE);this.objectRules.refinery&&(S=[S[0]]),S.forEach(({showWhenUnpowered:S},O)=>{try{this.setAnimationVisibility(j.AnimationType.ACTIVE,this.powered||S,O)}catch(S){RangeError}})}setPowered(S){if(this.powered=S,this.currentAnimType===j.AnimationType.IDLE&&this.setActiveAnimationVisible(),this.objectRules.superWeapon&&this.hasAnimation(j.AnimationType.SUPER)){var[O,B]=this.getNormalizedAnimType(j.AnimationType.SUPER_CHARGE_LOOP),N=this.animObjects.get(O);if(void 0===N)throw new Error(`Missing anim object for normalized anim type "${j.AnimationType[O]}"`);B=N[B];let L=this.animations.get(B);S?L.unpause():L.pause()}else this.animObjects.get(j.AnimationType.ACTIVE).forEach((O,B)=>{let N=this.animations.get(O);N&&(!S&&this.animArtProps.getByType(j.AnimationType.ACTIVE)[B].pauseWhenUnpowered?N.pause():N.unpause())})}hasAnimation(S){return S===j.AnimationType.IDLE||([S]=this.getNormalizedAnimType(S),this.animObjects.has(S)&&!!this.animObjects.get(S).length)}setAnimation(S,O){if(!this.gameObject.healthTrait.health)throw new Error("We can't switch building animation for a destroyed building");switch(this.hasAnimation(S)||(S=j.AnimationType.IDLE),this.currentAnimType=S,this.setAnimationVisibility(j.AnimationType.IDLE,!1),this.setAnimationVisibility(j.AnimationType.SPECIAL,!1),this.setAnimationVisibility(j.AnimationType.PRODUCTION,!1),this.setAnimationVisibility(j.AnimationType.SUPER,!1),this.setAnimationVisibility(j.AnimationType.BUILDUP,!1),this.setAnimationVisibility(j.AnimationType.UNBUILD,!1),this.setAnimationVisibility(j.AnimationType.FACTORY_DEPLOYING,!1),this.setAnimationVisibility(j.AnimationType.FACTORY_ROOF_DEPLOYING,!1),this.setActiveAnimationVisible(),S!==j.AnimationType.BUILDUP&&S!==j.AnimationType.UNBUILD?(this.mainObj&&(this.mainObj.get3DObject().visible=!0),this.bib&&(this.bib.get3DObject().visible=!0),this.turret&&(this.turret.visible=!0)):(this.mainObj&&(this.mainObj.get3DObject().visible=!1),this.bib&&(this.bib.get3DObject().visible=!1),this.turret&&(this.turret.visible=!1)),S!==j.AnimationType.FACTORY_DEPLOYING&&S!==j.AnimationType.FACTORY_ROOF_DEPLOYING||this.mainObj&&(this.mainObj.get3DObject().visible=!1),S){case j.AnimationType.PRODUCTION:this.setAnimationVisibility(j.AnimationType.PRODUCTION,!0),this.animObjects.get(j.AnimationType.PRODUCTION).forEach(S=>{this.animations.get(S).start(O)});break;case j.AnimationType.BUILDUP:this.setAnimationVisibility(j.AnimationType.ACTIVE,!1),this.setAnimationVisibility(j.AnimationType.BUILDUP,!0),this.animObjects.get(j.AnimationType.BUILDUP).forEach(S=>{this.animations.get(S).start(O)});break;case j.AnimationType.UNBUILD:this.setAnimationVisibility(j.AnimationType.ACTIVE,!1),this.setAnimationVisibility(j.AnimationType.UNBUILD,!0),this.animObjects.get(j.AnimationType.UNBUILD).forEach(S=>{this.animations.get(S).start(O)});break;case j.AnimationType.FACTORY_DEPLOYING:if(this.hasAnimation(j.AnimationType.FACTORY_DEPLOYING)&&this.objectRules.factory){this.setAnimationVisibility(j.AnimationType.FACTORY_DEPLOYING,!0),this.animObjects.get(j.AnimationType.FACTORY_DEPLOYING).forEach(S=>{this.animations.get(S).start(O)});break}case j.AnimationType.FACTORY_ROOF_DEPLOYING:if(this.hasAnimation(j.AnimationType.FACTORY_ROOF_DEPLOYING)&&this.objectRules.factory){this.setAnimationVisibility(j.AnimationType.FACTORY_ROOF_DEPLOYING,!0),this.animObjects.get(j.AnimationType.FACTORY_ROOF_DEPLOYING).forEach(S=>{this.animations.get(S).start(O)});break}case j.AnimationType.SPECIAL_REPAIR_START:case j.AnimationType.SPECIAL_REPAIR_LOOP:case j.AnimationType.SPECIAL_REPAIR_END:case j.AnimationType.SPECIAL_DOCKING:if(this.hasAnimation(j.AnimationType.SPECIAL)&&(S===j.AnimationType.SPECIAL_DOCKING&&this.objectRules.refinery||S!==j.AnimationType.SPECIAL_DOCKING&&this.objectRules.unitRepair)){var[B,N]=this.getNormalizedAnimType(S);this.setAnimationVisibility(B,!0,N),N=this.animObjects.get(B)[N],this.animations.get(N).start(O);break}case j.AnimationType.SPECIAL_SHOOT:if(this.objectRules.isBaseDefense){this.setAnimationVisibility(j.AnimationType.ACTIVE,!1);var[N,L]=this.getNormalizedAnimType(S);this.setAnimationVisibility(N,!0,L),L=this.animObjects.get(N)[L],this.animations.get(L).start(O);break}case j.AnimationType.SUPER_CHARGE_START:case j.AnimationType.SUPER_CHARGE_LOOP:case j.AnimationType.SUPER_CHARGE_END:if(this.objectRules.superWeapon&&this.hasAnimation(j.AnimationType.SUPER)){var[L,D]=this.getNormalizedAnimType(S);this.setAnimationVisibility(L,!0,D),D=this.animObjects.get(L)[D],this.animations.get(D).start(O);break}case j.AnimationType.IDLE:default:this.currentAnimType=j.AnimationType.IDLE,this.objectRules.superWeapon&&this.hasAnimation(j.AnimationType.SUPER)?(this.setAnimationVisibility(j.AnimationType.SUPER,!0,0),D=this.animObjects.get(j.AnimationType.SUPER)[0],this.animations.get(D).start(O)):(this.setAnimationVisibility(j.AnimationType.IDLE,!0),this.animObjects.get(j.AnimationType.IDLE).forEach(S=>{this.animations.get(S).start(O)}))}}doWithAnimation(S,O){var[B,N]=this.getNormalizedAnimType(S);let L=this.animObjects.get(B);if(void 0===L)throw new Error(`Missing animObjects for anim type "${j.AnimationType[B]}"`);B!==S&&(L=[L[N]]),L.forEach((S,B)=>{O(this.animations.get(S),S)})}doWithCurrentAnimation(S){this.doWithAnimation(this.currentAnimType,S)}endCurrentAnimation(){this.doWithCurrentAnimation(S=>S.endLoop())}handleSoundChange(S,O,B,N=1){if(B){var j;this.animSounds.has(O)&&this.animSounds.get(O).isPlaying()||(j=this.worldSound?.playEffect(S,this.gameObject,this.gameObject.owner,N))&&this.animSounds.set(O,j)}else{let S=this.animSounds.get(O);S&&S.isLoop&&(S.stop(),this.animSounds.delete(O))}}onCreate(S){this.renderableManager=S,this.plugins.forEach(O=>O.onCreate(S)),this.objectRules.ambientSound&&(this.ambientSound=this.worldSound?.playEffect(this.objectRules.ambientSound,this.gameObject,void 0,.25)),this.pipOverlay?.onCreate(S)}onRemove(S){if(this.renderableManager=void 0,this.plugins.forEach(O=>O.onRemove(S)),this.animSounds.forEach(S=>S.stop()),this.ambientSound?.stop(),this.turretRotateSound?.stop(),this.poweredSound?.stop(),this.gameObject.isDestroyed)return this.gameObject.deathType===re.DeathType.Temporal||this.gameObject.deathType===re.DeathType.None?void 0:void(this.objectRules.explosion.length&&this.createExplosionAnims(S))}dispose(){this.plugins.forEach(S=>S.dispose()),this.pipOverlay?.dispose(),this.placeholderObj?.dispose(),this.mainObj?.dispose(),this.rubbleObj?.dispose(),this.bib?.dispose(),this.fireObjects?.forEach(S=>S.dispose()),this.turretBuilders?.forEach(S=>S.dispose()),[...this.animObjects?.values()??[]].forEach(S=>S.forEach(S=>S.dispose()))}}),de.lampTextures=new Map}}}),System.register("engine/renderable/entity/Debris",["engine/renderable/WithPosition","engine/renderable/ShpRenderable","engine/renderable/MapSpriteTranslation","engine/Animation","engine/AnimProps","engine/animation/SimpleRunner","game/Coords","engine/renderable/ShadowRenderable"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){S("Debris",class{constructor(S,O,B,N,j,L,D,F,_,U,H){this.gameObject=S,this.rules=O,this.imageFinder=B,this.voxels=N,this.palette=L,this.camera=D,this.lighting=F,this.gameSpeed=_,this.vxlBuilderFactory=U,this.useSpriteBatching=H,this.plugins=[],this.objectRules=S.rules,this.objectArt=S.art,this.label="debris_"+this.objectRules.name,this.init()}init(){this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1),this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)),this.vxlExtraLight=(new THREE.Vector3).copy(this.baseVxlExtraLight),this.shpExtraLight=(new THREE.Vector3).copy(this.baseShpExtraLight),this.withPosition=new B.WithPosition}registerPlugin(S){this.plugins.push(S)}updateLighting(){this.plugins.forEach(S=>S.updateLighting?.()),this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1),this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight)}get3DObject(){return this.target}create3DObject(){let S=this.get3DObject();S||(S=new THREE.Object3D,S.name=this.label,this.target=S,S.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(S),this.vxlBuilder?.setExtraLight(this.vxlExtraLight),this.shpRenderable?.setExtraLight(this.shpExtraLight))}setPosition(S){this.withPosition.setPosition(S.x,S.y,S.z)}getPosition(){return this.withPosition.getPosition()}update(S,O=0){this.plugins.forEach(O=>O.update(S));var B=this.gameObject.tile.z+this.gameObject.tileElevation;if((void 0===this.lastElevation||this.lastElevation!==B)&&(this.lastElevation=B,this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)),this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight),this.shadowWrap&&(this.shadowWrap.position.y=-_.Coords.tileHeightToWorld(this.gameObject.tileElevation),this.shadowWrap.updateMatrix())),0<O){var N=this.gameObject.velocity.clone().multiplyScalar(O).add(this.gameObject.position.worldPosition);this.setPosition(N)}this.vxlBuilder?(({rotationAxis:B,angularVelocity:N}=this.gameObject),this.vxlRotObj.rotateOnAxis(B,THREE.Math.degToRad(N)),this.vxlRotObj.updateMatrix()):(this.shpAnimRunner.tick(S),this.shpRenderable.setFrame(this.shpAnimRunner.animation.getCurrentFrame()),this.shpShadowRenderable.setFrame(this.shpAnimRunner.animation.getCurrentFrame()))}createObjects(S){let O=this.vxlRotObj=new THREE.Object3D;O.matrixAutoUpdate=!1,O.rotation.order="YXZ";var B=this.createMainObject();O.add(B),S.add(O)}computeSpriteAnchorOffset(S){var O=this.objectArt.getDrawOffset();return{x:S.x+O.x,y:S.y+O.y}}createMainObject(){let S=new THREE.Object3D;if(S.matrixAutoUpdate=!1,this.rules.voxelAnimRules.has(this.gameObject.name)){var O=this.getVxlFileName(this.objectRules,this.objectArt);if(!(H=this.voxels.get(O)))throw new Error(`VXL missing for anim ${this.objectRules.name}. Vxl file ${O} not found. `);let N=this.vxlBuilderFactory.create(H,void 0,[this.palette],this.palette);this.vxlBuilder=N;var B=N.build();S.add(B)}else{let V=new j.MapSpriteTranslation(1,1);var{spriteOffset:_,anchorPointWorld:O}=V.compute(),H=this.computeSpriteAnchorOffset(_);B=this.imageFinder.findByObjectArt(this.objectArt);let W=this.shpRenderable=N.ShpRenderable.factory(B,this.palette,this.camera,H,!1);W.setBatched(this.useSpriteBatching),this.useSpriteBatching&&W.setBatchPalettes([this.palette]),W.create3DObject(),S.add(W.get3DObject()),_=U.ShadowRenderable.getOrCreateShadowPalette();let z=this.shpShadowRenderable=N.ShpRenderable.factory(B,_,this.camera,H,!1);z.setBatched(this.useSpriteBatching),this.useSpriteBatching&&z.setBatchPalettes([_]),z.setOpacity(.5),z.create3DObject();let K=this.shadowWrap=new THREE.Object3D;K.matrixAutoUpdate=!1,K.add(z.get3DObject()),S.add(K),S.position.x=O.x,S.position.z=O.y,S.updateMatrix(),W.setFlat(this.objectArt.flat),B=new D.AnimProps(this.objectArt.art,B),B=new L.Animation(B,this.gameSpeed),this.shpAnimRunner=new F.SimpleRunner,this.shpAnimRunner.animation=B}return S}getVxlFileName(S,O){let B=O.imageName;return S.shareSource&&(B=S.shareSource,S.shareTurretData?B+="tur":S.shareBarrelData&&(B+="barl")),B.toLowerCase()+".vxl"}onCreate(S){this.plugins.forEach(O=>O.onCreate(S))}onRemove(S){var O;this.plugins.forEach(O=>O.onRemove(S)),this.gameObject.isDestroyed&&this.get3DObject()&&(O=this.gameObject.explodeAnim)&&S.createTransientAnim(O,S=>S.setPosition(this.withPosition.getPosition()))}dispose(){this.plugins.forEach(S=>S.dispose()),this.shpRenderable?.dispose(),this.shpShadowRenderable?.dispose(),this.vxlBuilder?.dispose()}})}}}),System.register("engine/renderable/entity/HighlightAnimRunner",["engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","data/ShpFile"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends B.SimpleRunner{constructor(S,O=.5,B=2,F=5){super(),this.maxAmount=O;let _=new j.AnimProps(new L.IniSection("dummy"),new D.ShpFile);_.rate=F,_.loopEnd=B-1,_.loopCount=2,this.animation=new N.Animation(_,S),this.animation.stop()}animate(S){this.animation.props.loopCount=S,this.animation.reset()}getValue(){return(1-this.getCurrentFrame())*this.maxAmount}},S("HighlightAnimRunner",F)}}}),System.register("engine/renderable/entity/Infantry",["engine/renderable/WithPosition","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/ShpRenderable","game/Coords","engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","game/gameobject/infantry/sequenceMap","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType","game/art/SequenceType","util/math","game/gameobject/infantry/InfDeathType","game/gameobject/unit/VeteranLevel","engine/renderable/entity/HighlightAnimRunner","game/gameobject/common/DeathType","game/type/MovementZone","engine/renderable/entity/unit/BlobShadow","engine/renderable/entity/BoxIntersectObject3D","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/DebugRenderable","engine/gfx/MathUtils"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S}],execute:function(){S("Infantry",class{constructor(S,O,N,j,L,D,F,_,U,H,V,W,z,K,$){this.gameObject=S,this.rules=O,this.art=N,this.imageFinder=j,this.palette=D,this.camera=F,this.lighting=_,this.debugFrame=U,this.gameSpeed=H,this.selectionModel=V,this.useSpriteBatching=W,this.useMeshInstancing=z,this.pipOverlay=K,this.worldSound=$,this.crashingSequencePlaying=!1,this.deathAnimSequencePlaying=!1,this.idleActionDue=!1,this.disguiseChanged=!1,this.highlightAnimRunner=new Z.HighlightAnimRunner(this.gameSpeed),this.plugins=[],this.objectArt=S.art,this.label="infantry_"+S.rules.name,this.paletteRemaps=[...this.rules.colors.values()].map(S=>this.palette.clone().remap(S)),this.palette=this.palette.remap(this.gameObject.owner.color),this.withPosition=new B.WithPosition,this.updateBaseLight(),this.extraLight=(new THREE.Vector3).copy(this.baseExtraLight)}updateBaseLight(){this.baseExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1+this.rules.audioVisual.extraInfantryLight)}registerPlugin(S){this.plugins.push(S)}updateLighting(){this.plugins.forEach(S=>S.updateLighting?.()),this.updateBaseLight(),this.extraLight.copy(this.baseExtraLight)}get3DObject(){return this.target}getIntersectTarget(){return this.target}getUiName(){var S=this.plugins.reduce((S,O)=>O.getUiNameOverride?.()??S,void 0);return void 0!==S?S:this.gameObject.getUiName()}create3DObject(){let S=this.get3DObject();S||(S=new ee.BoxIntersectObject3D(new THREE.Vector3(.5,2/3,.5).multiplyScalar(D.Coords.LEPTONS_PER_TILE)),S.name=this.label,S.userData.id=this.gameObject.id,this.target=S,S.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(S),this.shpRenderable?.setExtraLight(this.extraLight),this.pipOverlay&&(this.pipOverlay.create3DObject(),this.posWrap.add(this.pipOverlay.get3DObject())))}setPosition(S){this.withPosition.setPosition(S.x,S.y,S.z)}getPosition(){return this.withPosition.getPosition()}highlight(){this.plugins.some(S=>S.shouldDisableHighlight?.())||this.highlightAnimRunner.animation.getState()!==_.AnimationState.RUNNING&&this.highlightAnimRunner.animate(2)}update(S){this.plugins.forEach(O=>O.update(S));var{zone:O,stance:B,isCrashing:N,isMoving:j,isFiring:L,isPanicked:F,owner:U,veteranLevel:H}=this.gameObject;this.pipOverlay?.update(S),this.blobShadow?.update(S),H!==this.lastVeteranLevel&&(H===Q.VeteranLevel.Elite&&void 0!==this.lastVeteranLevel&&this.highlightAnimRunner.animate(30),this.lastVeteranLevel=H);var $=this.gameObject.tile.z+this.gameObject.tileElevation;void 0!==this.lastElevation&&this.lastElevation===$||(this.lastElevation=$,this.updateBaseLight(),this.extraLight.copy(this.baseExtraLight)),this.highlightAnimRunner.shouldUpdate()&&(this.highlightAnimRunner.tick(S),te.ExtraLightHelper.multiplyShp(this.extraLight,this.baseExtraLight,this.highlightAnimRunner.getValue()));var Z=this.disguise?.owner??U;this.lastOwnerColor!==Z.color&&(this.palette.remap(Z.color),(this.shpRenderable??this.placeholder)?.setPalette(this.palette),this.lastOwnerColor=Z.color);var Y=this.gameObject.warpedOutTrait.isActive(),H=Y!==this.lastWarpedOut;if(this.lastWarpedOut=Y,$=this.gameObject.cloakableTrait?.isCloaked(),Z=$!==this.lastCloaked,this.lastCloaked=$,(H||Z)&&(this.shpRenderable??this.placeholder)?.setOpacity(Y||$?.5:1),N||void 0!==this.lastZone&&this.lastZone===O||(O===W.ZoneType.Water?this.gameObject.rules.enterWaterSound&&this.worldSound?.playEffect(this.gameObject.rules.enterWaterSound,this.gameObject,U):this.lastZone===W.ZoneType.Water&&this.gameObject.rules.leaveWaterSound&&this.worldSound?.playEffect(this.gameObject.rules.leaveWaterSound,this.gameObject,U),this.blobShadow&&this.shpRenderable?.setShadowVisible(!this.blobShadow.get3DObject().visible)),this.gameObject.isDestroyed&&this.deathPromiseResolve)if(this.deadBodyAnimRenderable){if((this.shpRenderable??this.placeholder).get3DObject().visible=!1,this.deadBodyAnimRenderable.update(S),this.deadBodyAnimRenderable.isAnimFinished())return void this.deathPromiseResolve()}else{if(!this.deathAnimRenderable){if(this.deathAnimSequencePlaying)return this.animRunner&&this.animRunner.animation.getState()!==_.AnimationState.STOPPED?(this.animRunner.tick(S),void this.updateShapeFrame(this.computeFacingNumber(this.gameObject.direction))):void([q.InfDeathType.Gunfire,q.InfDeathType.Explode].includes(this.gameObject.infDeathType)&&this.gameObject.rules.isHuman&&this.gameObject.zone===W.ZoneType.Ground?this.prepareDeadBodyAnim():this.deathPromiseResolve());if($=this.sequenceQueue.shift())return this.deathAnimSequencePlaying=!0,void this.setAnimParams($,S,!1);throw new Error("We should have a death sequence scheduled right now")}if((this.shpRenderable??this.placeholder).get3DObject().visible=!1,this.deathAnimRenderable.update(S),this.deathAnimRenderable.isAnimFinished())return void([q.InfDeathType.Gunfire,q.InfDeathType.Explode].includes(this.gameObject.infDeathType)&&this.gameObject.rules.isHuman?this.prepareDeadBodyAnim():this.deathPromiseResolve())}else{if(this.gameObject.warpedOutTrait.isActive())return;N&&(this.crashingSequencePlaying||(this.crashingSequencePlaying=!0,(X=V.getCrashingSequences(this.gameObject))&&(this.sequenceQueue=X)))}void 0!==this.lastDirection&&this.lastDirection===this.gameObject.direction||(this.lastDirection=this.gameObject.direction,this.computedDirection=this.gameObject.direction);var X=this.idleActionDue;this.idleActionDue=this.gameObject.idleActionTrait.actionDueThisTick();let J=this.idleActionDue&&!X;if(void 0===this.lastMoving||this.lastMoving!==j||void 0===this.lastFiring||this.lastFiring!==L||void 0===this.lastZone||this.lastZone!==O||void 0===this.lastPanicked||this.lastPanicked!==F||this.disguiseChanged){var ee=this.disguiseChanged,ie=this.lastFiring!==L;if(this.lastMoving=j,this.lastFiring=L,this.lastZone=O,this.lastPanicked=F,this.computedDirection=this.gameObject.direction,this.disguiseChanged=!1,!N&&(this.sequenceQueue=[],!ie||L||ee)){let N=this.findSequenceBy(O,B,j,L,F);void 0!==N&&(this.disguise&&[K.SequenceType.FireUp,K.SequenceType.FireProne].includes(N)&&(N=K.SequenceType.Ready),this.setAnimParams(N,S,!L))}}if(void 0!==this.lastStance&&this.lastStance===B||(this.sequenceQueue=[],J=!1,ie=V.getStanceTransitionSequenceBy(this.lastStance,B),this.lastStance=B,ie&&this.objectArt.sequences.has(ie)&&this.sequenceQueue.push(ie),void 0!==(ee=this.findSequenceBy(O,B,j,L,F))&&this.sequenceQueue.push(ee),void 0!==this.currentSequenceParams?.onlyFacing&&(this.computedDirection=this.directionFromFacingNo(this.currentSequenceParams.onlyFacing)),ee=this.sequenceQueue.shift(),this.setAnimParams(ee,S,!ie),ee===K.SequenceType.Paradrop?(ee=this.rules.audioVisual.parachute,this.paradropAnim=this.renderableManager.createAnim(ee,void 0,!0),this.paradropAnim.remapColor(U.color),this.paradropAnim.create3DObject(),this.paradropAnim.get3DObject().position.y=D.Coords.tileHeightToWorld(1),this.paradropAnim.get3DObject().updateMatrix(),this.posWrap.add(this.paradropAnim.get3DObject())):this.paradropAnim&&(this.paradropAnim.endAnimationLoop(),this.blobShadow&&(this.posWrap.remove(this.blobShadow.get3DObject()),this.blobShadow.dispose(),this.blobShadow=void 0,this.shpRenderable?.setShadowVisible(!0)))),this.paradropAnim&&(this.paradropAnim.update(S),this.paradropAnim.isAnimFinished()&&(this.posWrap.remove(this.paradropAnim.get3DObject()),this.paradropAnim=void 0)),this.sequenceQueue.length||j||L||B!==z.StanceType.None&&B!==z.StanceType.Guard||O===W.ZoneType.Air||!J||(.5<=Math.random()?(U=this.findIdleSequence(O,B,this.objectArt))&&this.setAnimParams(U,S,!1):this.computedDirection=Math.floor(360*Math.random())),this.animRunner){if(this.animRunner.animation.getState()===_.AnimationState.STOPPED&&this.currentSequenceParams){let N;[K.SequenceType.Idle1,K.SequenceType.Idle2].includes(this.currentSequenceParams.type)&&void 0!==this.currentSequenceParams.onlyFacing&&(this.computedDirection=this.directionFromFacingNo(this.currentSequenceParams.onlyFacing)),N=this.sequenceQueue.length?this.sequenceQueue.shift():this.findSequenceBy(O,B,j,L,F),void 0!==N&&this.setAnimParams(N,S,!L)}this.animRunner.tick(S),L=this.computeFacingNumber(this.computedDirection),this.updateShapeFrame(L)}}findIdleSequence(S,O,B){let N=V.getIdleSequenceBy(S,O);if(N?.length&&(N=N.filter(S=>B.sequences.has(S)),N.length||S===W.ZoneType.Ground||(N=V.getIdleSequenceBy(W.ZoneType.Ground,O)?.filter(S=>B.sequences.has(S)))),N)return N[$.getRandomInt(0,N.length-1)]}prepareDeadBodyAnim(){var S=(S=this.rules.audioVisual.deadBodies)[$.getRandomInt(0,S.length-1)];this.deadBodyAnimRenderable=this.renderableManager.createAnim(S,void 0,!0),this.deadBodyAnimRenderable.create3DObject(),this.posWrap.add(this.deadBodyAnimRenderable.get3DObject())}findSequenceBy(S,O,B,N,j){var L=V.findSequence(S,O,B,N,j,[...this.objectArt.sequences.keys()]);if(void 0!==L)return L;console.warn(`Couldn't find a sequence for infantry "${this.gameObject.name}" (moving=${B}, firing=${N})`)}setAnimParams(S,O,B=!0){if(this.animRunner){var N=this.objectArt.sequences.get(S);if(N){this.currentSequenceParams=N;let j=this.animRunner.animation.props;j.loopCount=B?-1:1,j.loopEnd=N.frameCount-1,[K.SequenceType.Deploy,K.SequenceType.Undeploy,K.SequenceType.Paradrop].includes(S)?S===K.SequenceType.Paradrop?j.rate=2*U.AnimProps.defaultRate:j.rate=U.AnimProps.defaultRate:j.rate=U.AnimProps.defaultRate/2,[K.SequenceType.Walk].includes(S)&&(j.rate/=1.33),this.animRunner.animation.start(O)}else console.warn(`Infantry "${this.gameObject.name}" is missing sequence "${K.SequenceType[S]}"`)}}updateShapeFrame(S){var O,B;this.currentSequenceParams&&this.shpRenderable&&this.animRunner&&(({startFrame:O,facingMult:B}=this.currentSequenceParams),(B=O+B*S+this.animRunner.animation.getCurrentFrame())<this.shpRenderable.frameCount&&this.shpRenderable.setFrame(B))}computeFacingNumber(S){return Math.round((S-45+360)%360/360*8)%8}directionFromFacingNo(S){return 45+360*S/8}createObjects(S){if(this.debugFrame.value){let O=j.DebugUtils.createWireframe({width:.5,height:.5},1);O.translateX(-D.Coords.getWorldTileSize()/4),O.translateZ(-D.Coords.getWorldTileSize()/4),S.add(O)}let O=this.posWrap=new THREE.Object3D;O.matrixAutoUpdate=!1,S.add(O);var B=this.createMainObject(this.objectArt);O.add(B),(this.gameObject.rules.movementZone!==X.MovementZone.Fly||this.objectArt.isVoxel)&&this.gameObject.stance!==z.StanceType.Paradrop||(this.blobShadow=new J.BlobShadow(this.gameObject,3,this.useMeshInstancing),this.blobShadow.create3DObject(),this.posWrap.add(this.blobShadow.get3DObject()))}createMainObject(S){let O;try{O=this.imageFinder.findByObjectArt(S)}catch(S){if(!(S instanceof N.ImageFinder.MissingImageError))throw S;console.warn(`<${this.gameObject.name}>: `+S.message)}if(!O)return this.placeholder=new ie.DebugRenderable({width:.25,height:.25},this.objectArt.height,this.palette,{centerFoundation:!0}),this.placeholder.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholder.setBatchPalettes(this.paletteRemaps),this.placeholder.create3DObject(),this.placeholder.get3DObject();var B=S.getDrawOffset();let j=this.shpRenderable=L.ShpRenderable.factory(O,this.palette,this.camera,B,S.hasShadow);j.setBatched(this.useSpriteBatching),this.useSpriteBatching&&j.setBatchPalettes(this.paletteRemaps),j.create3DObject();let V=j.get3DObject();return re.MathUtils.translateTowardsCamera(V,this.camera,15*D.Coords.ISO_WORLD_SCALE),V.updateMatrix(),B=new U.AnimProps(new H.IniSection("dummy"),O),B=new _.Animation(B,this.gameSpeed),this.animRunner=new F.SimpleRunner,this.animRunner.animation=B,V}setDisguise(S){this.gameObject.isDestroyed||this.gameObject.isCrashing||(this.objectArt=S?.objectArt??this.gameObject.art,this.updateShpRenderableFromArt(this.objectArt),this.disguiseChanged=!0,this.disguise=S)}updateShpRenderableFromArt(S){var O=(this.shpRenderable??this.placeholder)?.get3DObject();O&&(this.posWrap.remove(O),(this.shpRenderable??this.placeholder)?.dispose()),this.posWrap.add(this.createMainObject(S))}onCreate(S){this.renderableManager=S,this.plugins.forEach(O=>O.onCreate(S)),this.gameObject.rules.ambientSound&&(this.ambientSound=this.worldSound?.playEffect(this.gameObject.rules.ambientSound,this.gameObject))}onRemove(S){if(this.renderableManager=void 0,this.plugins.forEach(O=>O.onRemove(S)),this.ambientSound?.stop(),this.gameObject.isDestroyed&&this.gameObject.deathType!==Y.DeathType.Temporal&&this.gameObject.deathType!==Y.DeathType.Crush&&this.gameObject.stance!==z.StanceType.Paradrop){var O,B=V.getDeathSequence(this.gameObject,this.gameObject.infDeathType);if(B)1<B.length?(O=B[$.getRandomInt(0,B.length-1)],this.sequenceQueue=[O]):this.sequenceQueue=[B[0]],this.disguise&&(this.objectArt=this.gameObject.art,this.updateShpRenderableFromArt(this.gameObject.art));else{if(!this.gameObject.rules.isHuman)return;if(!(B=V.getDeathAnim(this.rules,this.gameObject.infDeathType)))return;let O=this.art.getAnimation(B);if(this.deathAnimRenderable=S.createAnim(B,void 0,!0),this.deathAnimRenderable.create3DObject(),this.create3DObject(),this.posWrap.add(this.deathAnimRenderable.get3DObject()),O.isFlamingGuy){let S=O.art.clone();S.set("Shadow","yes"),S.set("LoopCount","0"),S.set("Start",String(8*O.runningFrames)),this.deathAnimRenderable.getAnimProps().setArt(S)}}return this.renderableManager=S,new Promise(S=>{this.deathPromiseResolve=()=>{this.renderableManager=void 0,S()}})}}dispose(){this.plugins.forEach(S=>S.dispose()),this.pipOverlay?.dispose(),this.shpRenderable?.dispose(),this.placeholder?.dispose(),this.deathAnimRenderable?.dispose(),this.deadBodyAnimRenderable?.dispose(),this.paradropAnim?.dispose(),this.blobShadow?.dispose()}})}}}),System.register("engine/renderable/entity/InvulnerableAnimRunner",["engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","data/ShpFile"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends B.SimpleRunner{constructor(S,O=-.75,B=-.5,F=10,_=10){super(),this.minAmount=O,this.maxAmount=B,this.steps=F;let U=new j.AnimProps(new L.IniSection("dummy"),new D.ShpFile);U.rate=_,U.loopEnd=F,U.loopCount=-1,this.animation=new N.Animation(U,S),this.animation.stop()}animate(){this.animation.reset()}getValue(){return this.minAmount+(1+Math.sin(2*Math.PI*this.getCurrentFrame()/this.steps))/2*(this.maxAmount-this.minAmount)}},S("InvulnerableAnimRunner",F)}}}),System.register("engine/renderable/entity/Overlay",["data/ShpFile","game/Coords","engine/renderable/WithPosition","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/renderable/ShpRenderable","util/math","game/map/BridgeOverlayTypes","engine/type/ObjectType","game/gameobject/common/DeathType","engine/renderable/entity/BoxIntersectObject3D","engine/gfx/MathUtils","engine/renderable/entity/map/MapSurface","game/map/wallTypes"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S}],execute:function(){S("Overlay",class{constructor(S,O,B,N,j,L,D,F,_,U,H){this.gameObject=S,this.rules=O,this.art=B,this.imageFinder=N,this.palette=j,this.camera=L,this.lighting=D,this.debugFrame=F,this.bridgeImageCache=_,this.mapOverlayLayer=U,this.useSpriteBatching=H,this.isInvisible=!1,this.objectRules=S.rules,this.objectArt=S.art,this.label="overlay_"+this.objectRules.name,this.init()}init(){this.withPosition=new j.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting()}updateLighting(){var S=this.objectArt.lightingType;this.extraLight.copy(this.lighting.compute(S,this.gameObject.tile,this.gameObject.isHighBridge()?4:0)).addScalar(-1)}get3DObject(){return this.target}create3DObject(){let S=this.get3DObject();S||(S=new THREE.Object3D,S.name=this.label,S.userData.id=this.gameObject.id,this.target=S,S.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(S))}update(S){var O,B;this.isInvisible||(B=!!this.gameObject.healthTrait&&this.gameObject.healthTrait.health<=100*this.rules.audioVisual.conditionYellow,(O=1e5*this.gameObject.overlayId+10*this.gameObject.value+Number(B))!==this.lastOverlayHash&&(this.lastOverlayHash=O,B=this.computeFrame(B),this.mainRenderable?B<this.mainRenderable.frameCount&&this.mainRenderable.setFrame(B):this.mapOverlayLayer.setObjectFrame(this.gameObject,B)))}computeFrame(S){let O=this.gameObject,B=O.value;return O.isBridge()?0===B&&(B=_.getRandomInt(0,3)):O.wallTrait&&S&&(B+=(this.mainRenderable?this.mainRenderable.frameCount:this.mapOverlayLayer.getObjectFrameCount(this.gameObject))<$.wallTypes.length?1:$.wallTypes.length),B}setPosition(S){this.withPosition.setPosition(S.x,S.y,S.z)}getPosition(){return this.withPosition.getPosition()}getIntersectTarget(){return this.intersectTarget}getUiName(){return this.gameObject.getUiName()}createObjects(S){var O=this.gameObject.getFoundation();if(this.debugFrame.value&&(j=this.createWireframe(O,1),S.add(j)),this.objectRules.isRubble||this.gameObject.isBridgePlaceholder())this.isInvisible=!0;else{var B=this.gameObject.isBridge()||this.gameObject.isTiberium()||this.gameObject.rules.wall;if(this.mapOverlayLayer?.shouldBeBatched(this.gameObject)){if(this.mapOverlayLayer.addObject(this.gameObject),B){let B=new W.BoxIntersectObject3D(new THREE.Vector3(1,0,1).multiplyScalar(N.Coords.LEPTONS_PER_TILE));B.position.add(new THREE.Vector3(O.width/2,0,O.height/2).multiplyScalar(N.Coords.LEPTONS_PER_TILE)),B.matrixAutoUpdate=!1,B.updateMatrix(),S.add(B),this.intersectTarget=B}}else{let L=new THREE.Object3D;L.matrixAutoUpdate=!1;let F=new D.MapSpriteTranslation(O.width,O.height),{spriteOffset:_,anchorPointWorld:H}=F.compute();var j=_.clone().add(this.objectArt.getDrawOffset());let V;if(this.gameObject.isLowBridge()){O=U.BridgeOverlayTypes.getOverlayBridgeType(this.gameObject.overlayId);let S=this.bridgeImageCache.get(O);S||(S=this.buildVirtualBridgeFile(O),this.bridgeImageCache.set(O,S)),V=S}else V=this.imageFinder.findByObjectArt(this.objectArt);let W=this.mainRenderable=this.createMainObject(V,j);if(W.create3DObject(),L.add(W.get3DObject()),B&&W&&(this.intersectTarget=W.getShapeMesh()),j=N.Coords.getWorldTileSize(),L.position.x=H.x,L.position.z=H.y,B=this.gameObject.isXBridge(),this.gameObject.isBridge()&&(L.position.x+=j/2,L.position.z+=j/2,L.position.x+=B?0:j,L.position.z+=B?j:0),this.gameObject.isHighBridge()){L.position.x-=+N.Coords.ISO_WORLD_SCALE,L.position.z-=+N.Coords.ISO_WORLD_SCALE,L.position.x+=j+(B?.5*j:0),L.position.z+=j+(B?.5*j:0);let O=W.getShadowMesh();O&&(z.MathUtils.translateTowardsCamera(O,this.camera,(K.MAGIC_OFFSET+.05)*N.Coords.ISO_WORLD_SCALE),O.updateMatrix()),j=this.createBridgeShadowSurface(),S.add(j)}L.updateMatrix(),S.add(L)}}}buildVirtualBridgeFile(S){var O=S===U.OverlayBridgeType.Concrete?U.BridgeOverlayTypes.minLowBridgeConcreteId:U.BridgeOverlayTypes.minLowBridgeWoodId,N=S===U.OverlayBridgeType.Concrete?U.BridgeOverlayTypes.maxLowBridgeConcreteId:U.BridgeOverlayTypes.maxLowBridgeWoodId;let j=new B.ShpFile;j.filename="agg_"+this.gameObject.name+".shp";for(let S=O;S<=N;S++){var L=this.rules.getOverlay(this.rules.getOverlayName(S));L=this.art.getObject(L.name,H.ObjectType.Overlay);let O=this.imageFinder.findByObjectArt(L);j.width||(j.width=O.width,j.height=O.height),j.addImage(O.getImage(1))}return j}createBridgeShadowSurface(){var S=(O=this.gameObject.getFoundation()).width*N.Coords.getWorldTileSize(),O=O.height*N.Coords.getWorldTileSize();let B=new THREE.PlaneGeometry(S,O);B.applyMatrix((new THREE.Matrix4).makeTranslation(S/2,K.MAGIC_OFFSET,O/2).multiply((new THREE.Matrix4).makeRotationX(-Math.PI/2)));let j=new THREE.ShadowMaterial;j.transparent=!0,j.opacity=.5;let L=new THREE.Mesh(B,j);return L.receiveShadow=!0,L.renderOrder=5,L}createWireframe(S,O){let B=L.DebugUtils.createWireframe(S,O);var j=this.gameObject.isBridge();return B.position.y+=j?N.Coords.tileHeightToWorld(-1):0,B}createMainObject(S,O){var B=this.objectRules.wall,N=this.gameObject.isHighBridge()?4:0;let j=F.ShpRenderable.factory(S,this.palette,this.camera,O,this.objectArt.hasShadow&&!this.gameObject.isLowBridge(),N,B);return j.setBatched(this.useSpriteBatching),this.useSpriteBatching&&j.setBatchPalettes([this.palette]),j.setFlat(this.objectArt.flat),j.setExtraLight(this.extraLight),j}onRemove(S){if(this.mapOverlayLayer?.hasObject(this.gameObject)&&this.mapOverlayLayer.removeObject(this.gameObject),this.gameObject.isDestroyed&&(this.gameObject.deathType===V.DeathType.Demolish||this.gameObject.isHighBridge())){var O=this.gameObject.getFoundation(),B=this.rules.audioVisual.bridgeExplosions;for(let L=0;L<O.width;L++)for(let D=0;D<O.height;D++){var j=B[_.getRandomInt(0,B.length-1)];S.createTransientAnim(j,S=>{S.setPosition(N.Coords.tile3dToWorld(L,D,0).add(this.withPosition.getPosition()))})}}}dispose(){this.mainRenderable?.dispose()}})}}}),System.register("engine/renderable/entity/PipOverlay",["engine/gfx/TextureAtlas","data/Bitmap","engine/gfx/SpriteUtils","game/Coords","engine/gfx/TextureUtils","game/gameobject/selection/SelectionLevel","game/type/PipColor","util/disposable/CompositeDisposable","engine/gfx/OverlayUtils","engine/renderable/fx/RallyPointFx","engine/renderable/entity/unit/FlyerHelperMode","game/gameobject/unit/ZoneType","engine/gfx/BufferGeometryUtils","engine/gfx/material/PaletteBasicMaterial","engine/gfx/batch/BatchedMesh","game/gameobject/unit/HealthLevel","engine/renderable/entity/unit/DebugLabel"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S}],execute:function(){Y={width:8,height:11},X={0:F.SelectionLevel.Hover,2:F.SelectionLevel.Selected,1:F.SelectionLevel.Hover,3:F.SelectionLevel.Hover,4:F.SelectionLevel.Selected,5:F.SelectionLevel.Selected},J=(new Map).set(Q.HealthLevel.Green,15).set(Q.HealthLevel.Yellow,16).set(Q.HealthLevel.Red,17),S("PipOverlay",ee=class e{static clearCaches(){e.atlasCache?.dispose(),e.atlasCache=void 0,e.atlasImageHandles.clear(),[...e.unitHealthTextures.values()].forEach(S=>S.dispose()),e.unitHealthTextures.clear(),e.unitHealthMaterials.forEach(S=>S.dispose()),e.unitHealthMaterials.clear(),[...e.controlGroupTextures.values()].forEach(S=>S.dispose()),e.controlGroupTextures.clear(),e.controlGroupMaterials.forEach(S=>S.dispose()),e.controlGroupMaterials.clear(),[...e.primaryFactoryTextures.values()].forEach(S=>S.dispose()),e.primaryFactoryTextures.clear(),e.primaryFactoryMaterials.forEach(S=>S.dispose()),e.primaryFactoryMaterials.clear()}constructor(S,O,B,N,j,L,D,F,_,H,V,W,z,K,$,q){this.paradropRules=S,this.audioVisualRules=O,this.gameObject=B,this.viewer=N,this.alliances=j,this.selectionModel=L,this.imageFinder=D,this.palette=F,this.camera=_,this.strings=H,this.flyerHelperOpt=V,this.hiddenObjectsOpt=W,this.debugTextEnabled=z,this.animFactory=K,this.useSpriteBatching=$,this.useMeshInstancing=q,this.lastPrimaryFactory=!1,this.invalidatedElements=[],this.disposables=new U.CompositeDisposable,this.lastFollowLabelText=void 0,this.lastFollowLabelColor=void 0,this.lastFollowLabelHtml=void 0,this.lastFollowLabelFontSize=void 0,this.followLabelDomElement=void 0,this.followLabelDomHtml=void 0}create3DObject(){let S=this.rootObj;if(!S){var O;if(S=new THREE.Object3D,S.name="pip_overlay",S.matrixAutoUpdate=!1,e.atlasCache||(O=this.initTexture(),e.atlasCache=O,[...e.atlasImageHandles.keys()].forEach(S=>{var O=j.SpriteUtils.createSpriteGeometry(this.buildSpriteGeometry(S));e.geometries.set(S,O)}),e.material=new $.PaletteBasicMaterial({map:e.atlasCache.getTexture(),palette:D.TextureUtils.textureFromPalette(this.palette),alphaTest:.5,flatShading:!0,transparent:!0,depthTest:!1})),this.gameObject.isBuilding()){var B;this.healthBar=this.createBuildingHealthBar(this.gameObject),S.add(this.healthBar),1<=this.gameObject.art.height&&(N=this.selectionBox=this.createBuildingSelectionBox(this.gameObject),S.add(N)),(B=this.createBuildingOccupationInfo(this.gameObject))&&(S.add(B),this.pipsSprite=B),this.lastPipsDataKey=this.gameObject.garrisonTrait?.units.length}else{var{healthBarWrapper:N,selectionBox:B}=this.createUnitHealthBar(this.gameObject);if(this.healthBar=N,this.selectionBox=B,S.add(this.healthBar),this.gameObject.art.isVoxel&&(this.gameObject.rules.consideredAircraft||this.gameObject.isAircraft())&&!this.gameObject.rules.missileSpawn){let O=this.animFactory(this.audioVisualRules.flyerHelper);this.flyHelper=O,O.create3DObject(),S.add(O.get3DObject())}if(this.gameObject.isUnit()){let S=this.animFactory(this.audioVisualRules.behind);S.setRenderOrder(999995),this.behindAnim=S}}if(this.gameObject.debugLabel&&this.debugTextEnabled.value){let O=new Z.DebugLabel(this.gameObject.debugLabel,this.gameObject.owner.color.asHex(),this.camera);this.debugLabel=O,O.create3DObject(),O.get3DObject().renderOrder=999999,S.add(O.get3DObject())}var L=this.gameObject.consoleFollowLabel,F=L&&void 0!==L.text&&null!==L.text&&""!==L.text?L.text:void 0,_=F&&L&&void 0!==L.color?L.color:void 0,U=L&&"string"==typeof L.html&&L.html.trim()?L.html.trim():void 0,H=L&&void 0!==L.fontSize?Number(L.fontSize):void 0;if(H=Number.isFinite(H)&&0<H?H:void 0,F||U){var V=this.instantiateFollowLabel(S,F,_,"create3DObject",{html:U,fontSize:H});V&&(this.lastFollowLabelText=F,this.lastFollowLabelColor=V.color??_,this.lastFollowLabelHtml=U,this.lastFollowLabelFontSize=V.fontSize??H)}else this.lastFollowLabelText=void 0,this.lastFollowLabelColor=void 0,this.lastFollowLabelHtml=void 0,this.lastFollowLabelFontSize=void 0;this.lastHealth=this.gameObject.healthTrait.health,this.lastOwner=this.gameObject.owner,this.rootObj=S}}onCreate(S){this.gameObject.isBuilding()&&this.gameObject.rallyTrait&&(this.rallyLine=new V.RallyPointFx(this.camera,new THREE.Vector3,new THREE.Vector3,new THREE.Color,999999),this.rallyLine.visible=!1,S.addEffect(this.rallyLine),this.disposables.add(()=>this.rallyLine.remove(),this.rallyLine))}initTexture(){e.pipBrdFile=this.imageFinder.find("pipbrd",!1),e.pipsFile=this.imageFinder.find("pips",!1),e.pips2File=this.imageFinder.find("pips2",!1);let S=[e.pipBrdFile,e.pipsFile,e.pips2File],O=[];S.forEach(S=>{for(let L=0;L<S.numImages;L++){var B=S.getImage(L),j=new N.IndexedBitmap(B.width,B.height,B.imageData);O.push(j),e.atlasImageHandles.set(B,{bitmap:j,shpFile:S})}});let j=new B.TextureAtlas;return j.pack(O),j}buildSpriteGeometry(S){if(!e.atlasCache)throw new Error("Must build texture atlas before geometry");let O=e.atlasCache;var{bitmap:B,shpFile:N}=e.atlasImageHandles.get(S);return{texture:O.getTexture(),textureArea:O.getImageRect(B),align:{x:1,y:-1},offset:{x:S.x-Math.floor(N.width/2),y:S.y-Math.floor(N.height/2)},camera:this.camera,scale:L.Coords.ISO_WORLD_SCALE}}createBuildingHealthBar(S){var O=S.art.foundation.height,B=S.healthTrait.health,N=4*L.Coords.ISO_WORLD_SCALE,j=Math.floor(O*L.Coords.getWorldTileSize()/N),D=Math.max(1,Math.floor(B/100*j));let F;F=B>100*this.audioVisualRules.conditionYellow?1:B>100*this.audioVisualRules.conditionRed?2:4,O=F+"_"+O+"_"+D;let _=e.buildingHealthGeoCache.get(O);if(!_){let S=[];var U=e.pipsFile.getImage(0),H=e.pipsFile.getImage(F);for(let O=0;O<j;O++){var V=O<D?H:U;let B=e.geometries.get(V).clone();V=N*O+N/2,B.applyMatrix((new THREE.Matrix4).makeTranslation(N,0,V)),S.push(B)}_=K.BufferGeometryUtils.mergeBufferGeometries(S),e.buildingHealthGeoCache.set(O,_)}let W=this.useMeshInstancing?new q.BatchedMesh(_,e.material,q.BatchMode.Instancing):new THREE.Mesh(_,e.material);return W.matrixAutoUpdate=!1,W.renderOrder=999999,O=S.art.height||.5,W.position.y=L.Coords.tileHeightToWorld(O),W.updateMatrix(),W}createUnitHealthBar(S){var O=!S.isInfantry(),B=S.healthTrait.health,N=S.healthTrait.level;let F=e.unitHealthTextures.get(O);F||(F=this.createUnitHealthTexture(O),e.unitHealthTextures.set(O,F));var _=e.pipBrdFile.getImage(O?0:1),U=J.get(N);if(void 0===U)throw new Error(`Unhandled health level "${N}"`);U=e.pipsFile.getImage(U),U=Math.floor((_.width-2)/U.width),U=(O?1:0)+"_"+(B=Math.max(1,Math.floor(B/100*U)));let H=e.unitHealthGeoCache.get(U);H||(H=j.SpriteUtils.createSpriteGeometry({texture:F,textureArea:{x:0,y:(B-1)*_.height,width:_.width,height:_.height},camera:this.camera,align:{x:0,y:0},scale:L.Coords.ISO_WORLD_SCALE}),e.unitHealthGeoCache.set(U,H));let V=e.unitHealthMaterials.get(O);V||(V=new $.PaletteBasicMaterial({map:F,palette:D.TextureUtils.textureFromPalette(this.palette),alphaTest:.5,flatShading:!0,transparent:!0,depthTest:!1}),e.unitHealthMaterials.set(O,V));let W=this.useSpriteBatching?new q.BatchedMesh(H,V,q.BatchMode.Merging):new THREE.Mesh(H,V);W.matrixAutoUpdate=!1,W.renderOrder=999998,O=L.Coords.screenDistanceToWorld(Math.floor(_.width/2)+-1,0),W.applyMatrix((new THREE.Matrix4).makeTranslation(O.x,0,O.y)),W.updateMatrix(),O=e.geometries.get(_);let z=this.useSpriteBatching?new q.BatchedMesh(O,e.material,q.BatchMode.Merging):new THREE.Mesh(O,e.material);z.matrixAutoUpdate=!1,O=L.Coords.screenDistanceToWorld(Math.floor(e.pipBrdFile.getImage(0).width/2)+-1,0),z.applyMatrix((new THREE.Matrix4).makeTranslation(O.x,0,O.y)),z.updateMatrix(),z.renderOrder=999997;let K=new THREE.Object3D;return K.matrixAutoUpdate=!1,K.add(z),K.add(W),_=L.Coords.screenDistanceToWorld(-Math.floor(_.width/2),0),K.applyMatrix((new THREE.Matrix4).makeTranslation(_.x,L.Coords.tileHeightToWorld(2),_.y)),K.updateMatrix(),{healthBarWrapper:K,selectionBox:z}}createUnitHealthTexture(S){var O=e.pipBrdFile.getImage(S?0:1),B=e.pipsFile.getImage(J.values().next().value).width,j=Math.floor((O.width-2)/B);let L=new N.IndexedBitmap(O.width,O.height*j);for(let S=1;S<=j;++S){var D=S/j*100;let B;if(B=D>100*this.audioVisualRules.conditionYellow?Q.HealthLevel.Green:D>100*this.audioVisualRules.conditionRed?Q.HealthLevel.Yellow:Q.HealthLevel.Red,void 0===(D=J.get(B)))throw new Error(`Unhandled health level "${B}"`);var F=e.pipsFile.getImage(D),_=new N.IndexedBitmap(F.width,F.height,F.imageData),U=(S-1)*O.height;for(let O=0;O<S;O++){var H=F.width*O;L.drawIndexedImage(_,H+1,U+1)}}let V=new THREE.DataTexture(L.data,L.width,L.height,THREE.AlphaFormat);return V.minFilter=THREE.NearestFilter,V.magFilter=THREE.NearestFilter,V.flipY=!0,V.needsUpdate=!0,V}createBuildingSelectionBox(S){let O=new THREE.Object3D;O.matrixAutoUpdate=!1;let B=S.art.foundation,N=L.Coords.getWorldTileSize();return[[0,0],[0,1],[1,1],[1,0]].forEach(([j,D],F)=>{let _=this.createBuildingSelectionCornerMesh();_.matrixAutoUpdate=!1,_.position.set(j*N*B.width,L.Coords.tileHeightToWorld(S.art.height),D*N*B.height),_.rotation.y=F*Math.PI/2,_.scale.set((F%2==0?B.width:B.height)/4*L.Coords.getWorldTileSize(),L.Coords.tileHeightToWorld(S.art.height/4),(F%2==0?B.height:B.width)/4*L.Coords.getWorldTileSize()),_.updateMatrix(),O.add(_)}),O}createBuildingSelectionCornerMesh(){var S=[0,0,0,1,0,0,0,0,0,0,-1,0,0,0,0,0,0,1],O=new Array(S.length).fill(1);let B=new THREE.BufferGeometry;return B.addAttribute("position",new THREE.BufferAttribute(new Float32Array(S),3)),B.addAttribute("color",new THREE.BufferAttribute(new Float32Array(O),3)),O=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}),this.disposables.add(B,O),new THREE.LineSegments(B,O)}createBuildingOccupationInfo(S){if(S.garrisonTrait?.units.length&&!this.objectIsOpaqueToViewer()){var O=S.garrisonTrait.units.length,B=S.rules.maxNumberOccupants;let U=[];var N=4*L.Coords.ISO_WORLD_SCALE,j=e.pipsFile.getImage(6),D=e.pipsFile.getImage(7);for(let _=1;_<=B;_++){var F=_<=O?D:j;let B=e.geometries.get(F).clone();F=N*_+N/2,B.applyMatrix((new THREE.Matrix4).makeTranslation(F,0,S.art.foundation.height*L.Coords.getWorldTileSize())),U.push(B)}var _=K.BufferGeometryUtils.mergeBufferGeometries(U);let H=this.useSpriteBatching?new q.BatchedMesh(_,e.material,q.BatchMode.Merging):new THREE.Mesh(_,e.material);return H.matrixAutoUpdate=!1,H.renderOrder=999999,H}}createPipsSprite(S,O,B=!1){if(!this.objectIsOpaqueToViewer()){let U=[];var N=e.pips2File.getImage(B?12:0).width,j=e.pips2File.getImage(B?13:0);for(let F=0;F<O;F++){let O;if(F<S.length){var D=S[F];let N=B?12:3;D===_.PipColor.Blue?N=5:D===_.PipColor.Red?N=4:D===_.PipColor.Yellow&&(N=2),O=e.pips2File.getImage(N)}else O=j;let H=e.geometries.get(O).clone();D=N*F+N/2,D=L.Coords.screenDistanceToWorld(-Math.floor(e.pipBrdFile.getImage(this.gameObject.isInfantry()?1:0).width/2)+D,Math.floor(j.height/2)+3),H.applyMatrix((new THREE.Matrix4).makeTranslation(D.x,0,D.y)),U.push(H)}var F=K.BufferGeometryUtils.mergeBufferGeometries(U);let H=this.useSpriteBatching?new q.BatchedMesh(F,e.material,q.BatchMode.Merging):new THREE.Mesh(F,e.material);return H.renderOrder=999996,H}}createControlGroupTexture(S){let O=document.createElement("canvas"),B=O.getContext("2d",{alpha:!1});var N=Y;O.width=10*(N.width+2),O.height=N.height+2,B.fillStyle="#000",B.fillRect(0,0,O.width,O.height),B.strokeStyle=S.asHexString(),B.fillStyle=S.asHexString(),B.font="bold 12px Arial, sans-serif";for(let S=0;S<10;S++){var j=(N.width+2)*S;B.strokeRect(.5+j,.5,N.width+2-1,O.height-1),B.fillText(String(S),j+1+.5,N.height)}let L=new THREE.Texture(O);return L.minFilter=THREE.NearestFilter,L.magFilter=THREE.NearestFilter,L.needsUpdate=!0,L}createControlGroupSprite(S){let O=this.gameObject.owner.color;e.controlGroupTextures.has(O.asHex())||(N=this.createControlGroupTexture(O),e.controlGroupTextures.set(O.asHex(),N));var B=e.controlGroupTextures.get(O.asHex()),N=j.SpriteUtils.createSpriteGeometry({texture:B,textureArea:{x:S*(Y.width+2),y:0,width:Y.width+2,height:Y.height+2},camera:this.camera,align:{x:1,y:-1},scale:L.Coords.ISO_WORLD_SCALE});let D=e.controlGroupMaterials.get(B);D||(D=new THREE.MeshBasicMaterial({map:B,alphaTest:.5,transparent:!0,depthTest:!1,flatShading:!0}),e.controlGroupMaterials.set(B,D));let F=this.useSpriteBatching?new q.BatchedMesh(N,D,q.BatchMode.Merging):new THREE.Mesh(N,D);return F.matrixAutoUpdate=!1,F.renderOrder=999996,F}createPrimaryFactoryTexture(S){var O=H.OverlayUtils.createTextBox(this.strings.get("TXT_PRIMARY"),{color:S.asHexString(),borderColor:S.asHexString(),backgroundColor:"#000",fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:5,paddingBottom:5,paddingLeft:2,paddingRight:4});let B=new THREE.Texture(O);return B.minFilter=THREE.NearestFilter,B.magFilter=THREE.NearestFilter,B.needsUpdate=!0,B}createPrimaryFactorySprite(){if(!this.objectIsOpaqueToViewer()){let B=this.gameObject.owner.color;e.primaryFactoryTextures.has(B.asHex())||(O=this.createPrimaryFactoryTexture(B),e.primaryFactoryTextures.set(B.asHex(),O));var S=e.primaryFactoryTextures.get(B.asHex()),O=j.SpriteUtils.createSpriteGeometry({texture:S,camera:this.camera,align:{x:1,y:-1},offset:{x:-Math.floor(S.image.width/2),y:-Math.floor(S.image.height/2)},scale:L.Coords.ISO_WORLD_SCALE});let N=e.primaryFactoryMaterials.get(S);N||(N=new THREE.MeshBasicMaterial({map:S,alphaTest:.5,transparent:!0,depthTest:!1,flatShading:!0}),e.primaryFactoryMaterials.set(S,N));let D=this.useSpriteBatching?new q.BatchedMesh(O,N,q.BatchMode.Merging):new THREE.Mesh(O,N);return D.renderOrder=999999,D}}createVeteranIndicator(S){if(S.veteranLevel){var O=e.pipsFile.getImage(13+S.veteranLevel-1);O=e.geometries.get(O);let B=this.useSpriteBatching?new q.BatchedMesh(O,e.material,q.BatchMode.Merging):new THREE.Mesh(O,e.material);return B.matrixAutoUpdate=!1,B.renderOrder=999996,B.receiveShadow=!1,B}}get3DObject(){return this.rootObj}update(S){let O=this.gameObject;if(O.isDestroyed||O.isCrashing)this.rootObj.visible=!1;else{O.healthTrait.health!==this.lastHealth&&(this.lastHealth=O.healthTrait.health,this.invalidatedElements[0]=!0);let N=this.selectionModel.getSelectionLevel();this.invalidatedElements[0]&&(N>=X[0]||N>=X[3])&&(this.invalidatedElements[0]=void 0,this.updateHealthBarSprite(N));var B=this.computePipsDataKey(O);this.lastPipsDataKey===B&&this.lastOwner===O.owner||(this.lastPipsDataKey=B,this.invalidatedElements[1]=!0),this.invalidatedElements[1]&&N>=X[1]&&(this.invalidatedElements[1]=void 0,this.updatePipsSprite()),B=this.selectionModel.getControlGroupNumber(),this.lastControlGroup!==B&&(this.lastControlGroup=B,this.invalidatedElements[3]=!0),this.invalidatedElements[3]&&N>=X[3]&&(this.invalidatedElements[3]=void 0,this.updateControlGroupSprite(B)),B=O.isBuilding()&&!!O.rules.factory&&O.owner.production?.getPrimaryFactory(O.rules.factory)===O,this.lastPrimaryFactory===B&&this.lastOwner===O.owner||(this.lastPrimaryFactory=B,this.invalidatedElements[4]=!0),this.invalidatedElements[4]&&N>=X[4]&&(this.invalidatedElements[4]=void 0,this.updatePrimaryFactorySprite(B)),B=O.isBuilding()&&O.rallyTrait?.getRallyPoint()||void 0,this.lastRallyPoint===B&&this.lastOwner===O.owner||(this.lastRallyPoint=B,this.invalidatedElements[5]=!0),this.invalidatedElements[5]&&N>=X[5]&&this.rallyLine&&(this.invalidatedElements[5]=void 0,this.updateRallyPointLine(B,this.rallyLine)),O.isBuilding()?(B=!O.autoRepairTrait.isDisabled(),this.lastRepairState!==B&&(this.lastRepairState=B,this.updateRepairWrenchSprite(B))):this.lastVeteranLevel!==O.veteranLevel&&(this.lastVeteranLevel=O.veteranLevel,this.updateVeteranIndicatorSprite(O)),this.updateFlyerHelper(N,S),this.updateBehindAnim(S),this.updateDebugLabel(),this.updateFollowLabel(),(void 0===this.lastSelectionLevel||this.lastSelectionLevel!==N)&&(this.lastSelectionLevel=N,new Map([[0,this.healthBar],[2,this.selectionBox],[1,this.pipsSprite],[3,this.controlGroupSprite],[4,this.primaryFactorySprite],[5,this.rallyLine]]).forEach((S,O)=>{S&&(S.visible=N>=X[O])})),this.lastOwner=O.owner,this.lastDebugTextEnabled=this.debugTextEnabled.value,this.repairWrench?.update(S)}}updateFlyerHelper(S,O){if(this.flyHelper&&this.gameObject.isUnit()){let N;switch(this.flyerHelperOpt.value){case W.FlyerHelperMode.Never:N=!1;break;case W.FlyerHelperMode.Always:N=!0;break;case W.FlyerHelperMode.Selected:N=S>=F.SelectionLevel.Selected;break;default:N=!1}N=N&&this.gameObject.zone===z.ZoneType.Air;let j=this.flyHelper.get3DObject();var B;j.visible=N,N&&(this.flyHelper.update(O),(B=-L.Coords.tileHeightToWorld(this.gameObject.tileElevation))!==j.position.y&&(j.position.y=B,j.updateMatrix()))}}updateBehindAnim(S){this.behindAnim&&(this.hiddenObjectsOpt.value&&this.gameObject.isSpawned&&this.gameObject.tile.occluded&&this.gameObject.art.canBeHidden&&this.gameObject.zone!==z.ZoneType.Air?(this.behindAnim?.update(S),this.behindAnim.get3DObject()?.parent||(this.behindAnim.create3DObject(),this.rootObj.add(this.behindAnim.get3DObject()),this.behindAnim.get3DObject().updateMatrix())):this.behindAnim.get3DObject()?.parent&&this.rootObj.remove(this.behindAnim.get3DObject()))}resolveFollowLabelColor(S){if(void 0!==S)return S;try{var O=this.gameObject.owner?.color;if(O&&"function"==typeof O.asHex)return O.asHex()}catch(S){}return 16777215}instantiateFollowLabel(S,O,B,N,j={}){if(!S)return null;var L="string"==typeof j.html&&j.html.trim()?j.html.trim():void 0,D=j.fontSize;if(D=void 0!==D&&Number.isFinite(D)&&0<D?Number(D):void 0,L){let S=e.ensureDomFollowLabelHost();if(!S)return null;let O=document.createElement("div");O.className="pip-follow-label",O.style.position="absolute",O.style.pointerEvents="none",O.style.left="0px",O.style.top="0px",O.style.transform="translate(-50%, -100%)",O.style.willChange="transform",O.dataset.unitId=String(this.gameObject.id);try{O.innerHTML=L}catch(S){return null}return S.appendChild(O),this.followLabelDomElement=O,this.followLabelDomHtml=L,this.updateDomFollowLabelPosition(),{color:B??null,mode:"dom",fontSize:D}}let F=this.resolveFollowLabelColor(B);try{let B={};void 0!==D&&(B.fontSize=D);let N=new Z.DebugLabel(O,F,this.camera,B);N.create3DObject();let j=N.get3DObject();return j.renderOrder=999999,j.updateMatrix(),S.add(j),this.followLabel=N,{color:F,mode:"three",fontSize:N.fontSize}}catch(S){return null}}updateDebugLabel(){if((this.gameObject.debugLabel!==this.lastDebugLabel||this.gameObject.owner!==this.lastOwner||this.debugTextEnabled.value!==this.lastDebugTextEnabled)&&(this.lastDebugLabel=this.gameObject.debugLabel,this.debugLabel&&(this.rootObj.remove(this.debugLabel.get3DObject()),this.debugLabel.dispose(),this.debugLabel=void 0),this.gameObject.debugLabel&&this.debugTextEnabled.value)){let S=new Z.DebugLabel(this.gameObject.debugLabel,this.gameObject.owner.color.asHex(),this.camera);this.debugLabel=S,S.create3DObject(),S.get3DObject().renderOrder=999999,this.rootObj.add(S.get3DObject())}}updateFollowLabel(){var S=this.gameObject.consoleFollowLabel,O=S&&void 0!==S.text&&null!==S.text&&""!==S.text?S.text:void 0,B=S&&void 0!==S.color&&null!==S.color?S.color:void 0,N=S&&"string"==typeof S.html&&S.html.trim()?S.html.trim():void 0,j=S&&void 0!==S.fontSize?Number(S.fontSize):void 0;if(j=Number.isFinite(j)&&0<j?j:void 0,!O&&!N)return this.clearFollowLabelResources("cleared"),this.lastFollowLabelText=void 0,this.lastFollowLabelColor=void 0,this.lastFollowLabelHtml=void 0,void(this.lastFollowLabelFontSize=void 0);if(!this.rootObj)return;if(N){if(this.followLabel&&(this.rootObj.remove(this.followLabel.get3DObject()),this.followLabel.dispose(),this.followLabel=void 0),this.followLabelDomElement){if(this.followLabelDomHtml!==N){try{this.followLabelDomElement.innerHTML=N}catch(L){}this.followLabelDomHtml=N}}else{let S=this.instantiateFollowLabel(this.rootObj,O??"",B,this.lastFollowLabelHtml?"update-refresh":"update-create",{html:N,fontSize:j});if(!S)return this.lastFollowLabelText=void 0,this.lastFollowLabelColor=void 0,this.lastFollowLabelHtml=void 0,void(this.lastFollowLabelFontSize=void 0);this.lastFollowLabelColor=S.color??B,this.lastFollowLabelFontSize=S.fontSize??j}return this.lastFollowLabelText=O,this.lastFollowLabelHtml=N,this.lastFollowLabelFontSize=j,void(this.followLabelDomElement&&this.updateDomFollowLabelPosition())}this.followLabelDomElement&&(this.clearFollowLabelResources("refresh"),this.followLabelDomHtml=void 0);let L=O!==this.lastFollowLabelText,D=B!==this.lastFollowLabelColor,F=j!==this.lastFollowLabelFontSize;if((this.followLabel||L||D||F)&&(L||D||F||!this.followLabel)){this.followLabel&&(this.rootObj.remove(this.followLabel.get3DObject()),this.followLabel.dispose(),this.followLabel=void 0);let S=this.instantiateFollowLabel(this.rootObj,O??"",B,this.lastFollowLabelText?"update-refresh":"update-create",{fontSize:j});S?(this.lastFollowLabelText=O,this.lastFollowLabelColor=S.color??B,this.lastFollowLabelFontSize=S.fontSize??j,this.lastFollowLabelHtml=void 0):(this.lastFollowLabelText=void 0,this.lastFollowLabelColor=void 0,this.lastFollowLabelFontSize=void 0)}}clearFollowLabelResources(S){this.followLabel&&(this.rootObj?.remove(this.followLabel.get3DObject()),this.followLabel.dispose(),this.followLabel=void 0),this.followLabelDomElement&&(this.followLabelDomElement.remove(),this.followLabelDomElement=void 0,this.followLabelDomHtml=void 0)}getFollowLabelAnchorWorldPosition(){var S=this.gameObject?.position?.worldPosition;if(!S)return null;let O;O="function"==typeof S.clone?S.clone():new THREE.Vector3(S.x,S.y,S.z);let B=0;try{var N=this.gameObject?.art?.height??0;B=L.Coords.tileHeightToWorld((N||0)+.5)}catch(S){B=0}return O.y+=B,O}updateDomFollowLabelPosition(){var S=this.followLabelDomElement;if(!S)return;var O=e.getWorldCanvasElement();if(!O)return void(S.style.display="none");var B=this.getFollowLabelAnchorWorldPosition();if(!B)return void(S.style.display="none");var N=O.getBoundingClientRect();if(!N.width||!N.height)return void(S.style.display="none");let j="function"==typeof B.clone?B.clone():new THREE.Vector3(B.x,B.y,B.z);j.project(this.camera);let L=N.left+(j.x+1)/2*N.width,D=N.top+(1-(j.y+1)/2)*N.height;Number.isFinite(L)&&Number.isFinite(D)?(S.style.display="block",S.style.transform=`translate(${L}px, ${D}px) translate(-50%, -100%)`):S.style.display="none"}updateRepairWrenchSprite(S){this.repairWrench&&this.rootObj.remove(this.repairWrench.get3DObject()),S&&(this.repairWrench=this.createRepairWrench(),this.repairWrench&&(this.repairWrench.create3DObject(),this.rootObj.add(this.repairWrench.get3DObject())))}updateVeteranIndicatorSprite(S){var O;this.veteranIndicator&&this.rootObj.remove(this.veteranIndicator),this.veteranIndicator=this.createVeteranIndicator(S),this.veteranIndicator&&(this.rootObj.add(this.veteranIndicator),O=L.Coords.screenDistanceToWorld(Math.floor(e.pipBrdFile.getImage(S.isInfantry()?1:0).width/2)-Math.floor(e.pipsFile.getImage(13).width/2),0),this.veteranIndicator.position.x=O.x,this.veteranIndicator.position.y=0,this.veteranIndicator.position.z=O.y,this.veteranIndicator.updateMatrix())}updateRallyPointLine(S,O){O.visible=!1,S&&(this.objectIsOpaqueToViewer()||(O.sourcePos=this.gameObject.position.worldPosition,O.targetPos=L.Coords.tile3dToWorld(S.rx+.5,S.ry+.5,S.z),O.color=new THREE.Color(this.gameObject.owner.color.asHex()),O.needsUpdate=!0,O.visible=!0))}updatePrimaryFactorySprite(S){var O;this.primaryFactorySprite&&this.rootObj.remove(this.primaryFactorySprite),!S||(O=this.primaryFactorySprite=this.createPrimaryFactorySprite())&&this.rootObj.add(O)}updateControlGroupSprite(S){if(this.controlGroupSprite&&this.rootObj.remove(this.controlGroupSprite),void 0!==S){let B=this.controlGroupSprite=this.createControlGroupSprite(S),N=this.gameObject;var O;N.isBuilding()?(B.position.x=1,B.position.y=L.Coords.tileHeightToWorld(N.art.height-.5),B.position.z=L.Coords.getWorldTileSize()*N.art.foundation.height):N.isInfantry()?(O=L.Coords.screenDistanceToWorld(-(Y.width+2+e.pipBrdFile.getImage(1).width/2+1),-e.pipBrdFile.height/2),B.position.x=O.x,B.position.y=this.healthBar.position.y,B.position.z=O.y):(O=L.Coords.screenDistanceToWorld(-e.pipBrdFile.getImage(0).width/2,e.pipBrdFile.height/2),B.position.x=O.x,B.position.y=this.healthBar.position.y,B.position.z=O.y),B.updateMatrix(),this.rootObj.add(B)}}updatePipsSprite(){this.pipsSprite&&(this.rootObj.remove(this.pipsSprite),this.pipsSprite=void 0);let S,O=this.gameObject;if(O.isBuilding())S=this.createBuildingOccupationInfo(O);else if(O.isVehicle()){let j,L=[];var B,N;O.harvesterTrait&&0<O.rules.storage?(j=5,N=O.rules.storage,B=Math.floor(O.harvesterTrait.gems/N*j),N=Math.floor(O.harvesterTrait.ore/N*j),L.push(...new Array(B).fill(_.PipColor.Blue),...new Array(N).fill(_.PipColor.Yellow))):O.transportTrait&&0<O.rules.passengers?(j=O.rules.passengers,O.transportTrait.units.forEach(S=>{let O=0;S.isVehicle()&&(L.push(_.PipColor.Blue),O++),L.push(...new Array(S.rules.size-O).fill(S.isVehicle()?_.PipColor.Red:S.rules.pip))})):O.airSpawnTrait&&(L=new Array(O.airSpawnTrait.availableSpawns).fill(_.PipColor.Yellow),j=O.rules.spawnsNumber),j&&(S=this.createPipsSprite(L,j))}else O.isAircraft()&&O.ammo&&O.name!==this.paradropRules.paradropPlane&&!O.rules.missileSpawn&&(S=this.createPipsSprite(new Array(O.ammo).fill(_.PipColor.Green),O.ammo,!0));S&&(S.updateMatrix(),this.rootObj.add(S),this.pipsSprite=S)}computePipsDataKey(S){let O;return S.isBuilding()?O=S.garrisonTrait?.units.length:S.isVehicle()?S.harvesterTrait?O=S.harvesterTrait.ore+"_"+S.harvesterTrait.gems:S.transportTrait?O=S.transportTrait.units.length:S.airSpawnTrait&&(O=S.airSpawnTrait.availableSpawns):S.isAircraft()&&(O=S.ammo),O}updateHealthBarSprite(S){if(this.healthBar){if(this.rootObj.remove(this.healthBar),this.gameObject.isBuilding())this.healthBar=this.createBuildingHealthBar(this.gameObject);else{let{healthBarWrapper:O,selectionBox:B}=this.createUnitHealthBar(this.gameObject);this.healthBar=O,this.selectionBox=B,B.visible=S>=X[2]}this.rootObj.add(this.healthBar)}}createRepairWrench(){let S=this.animFactory("WRENCH");return S.setRenderOrder(999998),S}objectIsOpaqueToViewer(){var S=this.viewer.value;return!(!S||S.isObserver||this.gameObject.owner===S||this.alliances.areAllied(this.gameObject.owner,S))}dispose(){this.disposables.dispose(),this.repairWrench?.dispose(),this.flyHelper?.dispose(),this.behindAnim?.dispose(),this.debugLabel?.dispose(),this.clearFollowLabelResources(),this.animFactory=void 0}}),ee.ensureDomFollowLabelHost=function(){if("undefined"==typeof document)return;let S=ee.domFollowLabelHost;return S&&document.contains(S)?S:document.body?(S=document.getElementById("pip-follow-label-layer")||document.createElement("div"),S.setAttribute("id","pip-follow-label-layer"),S.style.position="fixed",S.style.left="0px",S.style.top="0px",S.style.width="100vw",S.style.height="100vh",S.style.pointerEvents="none",S.style.zIndex="1200",document.body.appendChild(S),ee.domFollowLabelHost=S):void 0},ee.getWorldCanvasElement=function(){if("undefined"==typeof document)return;let S=ee.cachedWorldCanvas;if(S&&document.contains(S))return S;let O,B=0;return document.querySelectorAll("canvas").forEach(S=>{const N=S.getBoundingClientRect(),j=N.width*N.height;j>B&&(B=j,O=S)}),ee.cachedWorldCanvas=O},ee.domFollowLabelHost=void 0,ee.cachedWorldCanvas=void 0,ee.atlasImageHandles=new Map,ee.geometries=new Map,ee.buildingHealthGeoCache=new Map,ee.unitHealthGeoCache=new Map,ee.unitHealthTextures=new Map,ee.unitHealthMaterials=new Map,ee.controlGroupTextures=new Map,ee.controlGroupMaterials=new Map,ee.primaryFactoryTextures=new Map,ee.primaryFactoryMaterials=new Map}}}),System.register("engine/renderable/entity/Projectile",["engine/renderable/WithPosition","engine/renderable/ShpRenderable","game/gameobject/Projectile","game/Coords","engine/renderable/fx/LaserFx","game/WeaponType","engine/renderable/fx/TeslaFx","game/GameSpeed","engine/renderable/fx/LineTrailFx","engine/renderable/fx/SparkFx","engine/renderable/fx/RadBeamFx","engine/renderable/entity/unit/BlobShadow","engine/gfx/lighting/NukeLightingFx","engine/gfx/batch/BatchedMesh","game/rules/ObjectRules","game/math/geometry","engine/type/PaletteType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S}],execute:function(){S("Projectile",class e{constructor(S,O,N,j,L,D,F,_,U,H,V,W,z,K,$){var q,Q;this.gameObject=S,this.rules=O,this.imageFinder=N,this.voxels=j,this.voxelAnims=L,this.theater=D,this.palette=F,this.specialPalette=_,this.camera=U,this.gameSpeed=H,this.lighting=V,this.lightingDirector=W,this.vxlBuilderFactory=z,this.useSpriteBatching=K,this.useMeshInstancing=$,this.plugins=[],this.objectArt=S.art,this.label="projectile_"+S.rules.name,this.withPosition=new B.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting(),this.gameObject.rules.firersPalette&&(q=(Q=this.gameObject.fromObject)?.art.paletteType??Z.PaletteType.Unit,Q=Q?.art.customPaletteName,this.palette=this.theater.getPalette(q,Q),this.gameObject.art.remapable&&(this.palette=this.palette.clone(),this.palette.remap(this.gameObject.fromPlayer.color))),this.gameObject.rules.firersPalette&&this.objectArt.remapable?this.paletteRemaps=[...this.rules.colors.values()].map(S=>this.palette.clone().remap(S)):this.paletteRemaps=[this.palette]}registerPlugin(S){this.plugins.push(S)}updateLighting(){this.plugins.forEach(S=>S.updateLighting?.()),this.objectArt.isVoxel?this.extraLight.setScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)):this.extraLight.copy(this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)).addScalar(-1)}getIntersectTarget(){}get3DObject(){return this.target}create3DObject(){let S=this.get3DObject();S||(S=new THREE.Object3D,S.name=this.label,this.target=S,S.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(S))}setPosition(S){this.withPosition.setPosition(S.x,S.y,S.z)}getPosition(){return this.withPosition.getPosition()}update(S,O){if(this.plugins.forEach(O=>O.update(S)),0<O&&!this.gameObject.isDestroyed){var B=this.gameObject.velocity.clone().multiplyScalar(O).add(this.gameObject.position.worldPosition);this.setPosition(B)}this.blobShadow?.update(S,O);var N=this.gameObject.direction;!this.vxlRotWrapper&&void 0!==this.lastDirection&&this.lastDirection===N||(this.shpRenderable&&2<this.shpRenderable.frameCount?(this.lastDirection=N,this.updateShapeFrame(N)):this.vxlRotWrapper?(B=Q.quaternionFromVec3(this.gameObject.velocity.clone().negate()),this.vxlRotWrapper.rotation.setFromQuaternion(B,"YXZ"),this.gameObject.rules.vertical&&(this.vxlRotWrapper.rotation.y=THREE.Math.degToRad(180+N)),this.vxlRotWrapper.updateMatrix()):this.sonicWaveMesh&&(this.sonicWaveMesh.rotation.y=THREE.Math.degToRad(N),this.sonicWaveMesh.updateMatrix())),this.gameObject.state!==this.lastState&&(this.lastState=this.gameObject.state,this.gameObject.state===j.ProjectileState.Impact&&(this.target.visible=!1,this.renderableManager.createTransientAnim(this.gameObject.impactAnim,S=>{S.setPosition(this.withPosition.getPosition())}),this.gameObject.isNuke&&this.lightingDirector.addEffect(new K.NukeLightingFx)))}updateShapeFrame(S){let O=0;this.objectArt.rotates&&(O=Math.round((S-45+360)%360/360*32)%32),this.shpRenderable.setFrame(O)}createObjects(S){if(this.gameObject.fromWeapon.rules.isSonic){e.sonicWaveGeometry??(e.sonicWaveGeometry=this.createSonicWaveGeometry()),e.sonicWaveMaterial??(e.sonicWaveMaterial=new THREE.MeshBasicMaterial({color:48340,blending:THREE.CustomBlending,blendEquation:THREE.AddEquation,blendSrc:THREE.DstColorFactor,blendDst:THREE.OneFactor,transparent:!0,opacity:.25,alphaTest:.01,depthTest:!1,depthWrite:!1}));let O=new(this.useMeshInstancing?$.BatchedMesh:THREE.Mesh)(e.sonicWaveGeometry,e.sonicWaveMaterial);return O.rotation.order="YXZ",O.rotation.x=-Math.PI/2,O.rotation.y=THREE.Math.degToRad(this.gameObject.direction),O.updateMatrix(),O.matrixAutoUpdate=!1,S.add(O),void(this.sonicWaveMesh=O)}if(!this.gameObject.rules.inviso&&this.gameObject.rules.imageName!==q.ObjectRules.IMAGE_NONE){if(this.gameObject.art.isVoxel){var O=this.objectArt.imageName.toLowerCase(),B=O+".vxl",j=this.voxels.get(B);if(!j)throw new Error(`VXL missing for projectile ${this.gameObject.rules.name}. Vxl file ${B} not found. `);var L=this.objectArt.noHva?void 0:this.voxelAnims.get(O+".hva");let N=this.vxlBuilder=this.vxlBuilderFactory.create(j,L,this.paletteRemaps,this.palette);N.setExtraLight(this.extraLight),B=N.build();let D=this.vxlRotWrapper=new THREE.Object3D;D.rotation.order="YXZ",D.matrixAutoUpdate=!1,D.add(B),S.add(D)}else{O=this.imageFinder.findByObjectArt(this.objectArt),j=this.objectArt.getDrawOffset(),L=this.gameObject.rules.arcing,B=this.gameObject.rules.shadow&&!L&&1<O.numImages;let D=N.ShpRenderable.factory(O,this.palette,this.camera,j,B);D.setBatched(this.useSpriteBatching),this.useSpriteBatching&&D.setBatchPalettes(this.paletteRemaps),D.setExtraLight(this.extraLight),D.create3DObject(),this.shpRenderable=D,S.add(D.get3DObject()),L&&(this.blobShadow=new z.BlobShadow(this.gameObject,1.5,this.useMeshInstancing),this.blobShadow.create3DObject(),S.add(this.blobShadow.get3DObject()))}this.gameObject.fromWeapon.type===F.WeaponType.DeathWeapon&&(S.visible=!1)}}createSonicWaveGeometry(){let S=new THREE.PlaneBufferGeometry(L.Coords.LEPTONS_PER_TILE,L.Coords.LEPTONS_PER_TILE/3,10,10),O=S.getAttribute("position");for(let S=0;S<O.count;S++)O.setY(S,O.getY(S)+Math.cos(O.getX(S)*Math.PI/L.Coords.LEPTONS_PER_TILE)*L.Coords.ISO_WORLD_SCALE);return S}onCreate(S){this.renderableManager=S,this.plugins.forEach(O=>O.onCreate(S));var O=this.gameObject.fromObject?.name===this.rules.general.prism.type&&this.gameObject.fromWeapon.type===F.WeaponType.Secondary;let B;var N,j;if(B=this.gameObject.fromObject?this.gameObject.fromWeapon.type===F.WeaponType.Primary||this.gameObject.fromWeapon.type===F.WeaponType.DeathWeapon||O?this.gameObject.fromObject.art.primaryFirePixelOffset:this.gameObject.fromObject.art.secondaryFirePixelOffset:[],O=this.gameObject.fromWeapon.rules,this.gameObject.fromWeapon.type!==F.WeaponType.DeathWeapon&&!O.limboLaunch){let O;(z=this.gameObject.fromWeapon.rules.anim).length?O=1===z.length?z[0]:(K=this.gameObject.direction,z[Math.round((45-K+360)%360/360*8)%8]):this.gameObject.fromWeapon.warhead.rules.nukeMaker&&(O=this.rules.audioVisual.nukeTakeOff),O&&S.createTransientAnim(O,S=>{S.setPosition(this.gameObject.position.worldPosition),B.length&&(S.extraOffset={x:B[0],y:-B[1]/2})})}if(O.isLaser){let N=this.gameObject.position.worldPosition.clone(),j=new THREE.Vector3;B.length&&($=L.Coords.screenDistanceToWorld(B[0],0),j.x=4*$.x,j.z=4*$.y,j.y=4*L.Coords.tileHeightToWorld(-B[1]/(L.Coords.ISO_TILE_SIZE/2)));let _=this.gameObject.target.getWorldCoords().clone();this.gameObject.fromObject?.name===this.rules.general.prism.type&&this.gameObject.fromWeapon.type===F.WeaponType.Secondary&&(j.y+=this.gameObject.fromObject.art.primaryFireFlh.vertical,_.add(j)),N.add(j);var z=new THREE.Color(O.isHouseColor?this.gameObject.fromPlayer.color.asHex():16711680),K=O.laserDuration/U.GameSpeed.BASE_TICKS_PER_SECOND/this.gameSpeed.value,$=2*(1<this.gameObject.baseDamageMultiplier?2:1);$=new D.LaserFx(this.camera,N,_,z,K,$),S.addEffect($)}if(O.isElectricBolt){let B=this.gameObject.position.worldPosition.clone();this.gameObject.fromObject?.isBuilding()&&(B.y+=L.Coords.tileHeightToWorld(1)),$=this.gameObject.target.getWorldCoords();let N=this.specialPalette;var q=new THREE.Color(N.getColorAsHex(O.isAlternateColor?5:10)),Q=new THREE.Color(N.getColorAsHex(15)),Z=1/this.gameSpeed.value;q=new _.TeslaFx(B,$,q,Q,Z),S.addEffect(q)}O.isRadBeam&&(Q=this.gameObject.position.worldPosition.clone(),Z=this.gameObject.target.getWorldCoords().clone(),q=this.gameObject.fromWeapon.warhead.rules.temporal?new THREE.Color(...this.rules.audioVisual.chronoBeamColor.map(S=>S/255)):new THREE.Color(...this.rules.radiation.radColor.map(S=>S/255)),N=1/this.gameSpeed.value,N=new W.RadBeamFx(this.camera,Q,Z,q,N,1),S.addEffect(N)),this.objectArt.useLineTrail&&(N=(new THREE.Color).fromArray(this.objectArt.lineTrailColor.map(S=>S/255)),j=this.objectArt.lineTrailColorDecrement,j=new H.LineTrailFx(()=>this.target,N,j,this.gameSpeed,this.camera),S.addEffect(j),this.lineTrailFx=j),O.useSparkParticles&&(j=this.gameObject.position.worldPosition.clone(),O=20/U.GameSpeed.BASE_TICKS_PER_SECOND,O=new V.SparkFx(j,new THREE.Color(1,1,1),O,this.gameSpeed),S.addEffect(O))}onRemove(S){this.renderableManager=void 0,this.plugins.forEach(O=>O.onRemove(S)),this.gameObject.overshootTiles&&this.lineTrailFx?.stopTracking(),this.lineTrailFx?.requestFinishAndDispose()}dispose(){this.plugins.forEach(S=>S.dispose()),this.shpRenderable?.dispose(),this.vxlBuilder?.dispose(),this.blobShadow?.dispose()}})}}}),System.register("engine/renderable/entity/RenderableFactory",["engine/renderable/entity/Building","engine/renderable/entity/Vehicle","engine/renderable/entity/Terrain","engine/renderable/entity/Overlay","engine/renderable/entity/Smudge","engine/renderable/entity/building/AnimationType","engine/renderable/entity/Infantry","engine/renderable/entity/PipOverlay","engine/renderable/entity/Aircraft","engine/renderable/entity/TransientAnim","engine/renderable/entity/Projectile","engine/type/ObjectType","engine/renderable/entity/plugin/HarvesterPlugin","engine/renderable/entity/Anim","engine/renderable/entity/plugin/MoveSoundFxPlugin","engine/renderable/entity/plugin/VehicleDisguisePlugin","engine/renderable/entity/plugin/ChronoSparkleFxPlugin","engine/renderable/entity/plugin/TntFxPlugin","engine/renderable/entity/plugin/MindControlLinkPlugin","engine/renderable/entity/plugin/InfantryDisguisePlugin","engine/renderable/entity/building/PsychicDetectPlugin","engine/renderable/entity/plugin/TrailerSmokePlugin","engine/renderable/entity/plugin/DamageSmokePlugin","game/type/LocomotorType","engine/renderable/entity/plugin/ShipWakeTrailPlugin","engine/renderable/entity/plugin/ObjectCloakPlugin","engine/renderable/entity/Debris","engine/renderable/builder/ShpAggregator"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S}],execute:function(){S("RenderableFactory",class{constructor(S,O,B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te=!1,ie=!1){this.localPlayer=S,this.unitSelection=O,this.alliances=B,this.rules=N,this.art=j,this.mapRenderable=L,this.imageFinder=D,this.palettes=F,this.voxels=_,this.voxelAnims=U,this.theater=H,this.camera=V,this.lighting=W,this.lightingDirector=z,this.debugWireframes=K,this.debugText=$,this.gameSpeed=q,this.worldSound=Q,this.strings=Z,this.flyerHelperOpt=Y,this.hiddenObjectsOpt=X,this.vxlBuilderFactory=J,this.buildingImageDataCache=ee,this.useSpriteBatching=te,this.useMeshInstancing=ie,this.bridgeImageCache=new Map}createTransientAnim(S,O){var B=this.art.getObject(S,z.ObjectType.Animation);return new V.TransientAnim(S,B,{x:0,y:0},this.imageFinder,this.theater,this.camera,this.debugWireframes,this.gameSpeed,this.useSpriteBatching,O,this.worldSound)}createAnim(S){var O=this.art.getObject(S,z.ObjectType.Animation);return new $.Anim(S,O,{x:0,y:0},this.imageFinder,this.theater,this.camera,this.debugWireframes,this.gameSpeed,this.useSpriteBatching,void 0,this.worldSound)}create(S){let O=this.theater.getPalette(S.art.paletteType,S.art.customPaletteName),V=[];if((S.isAircraft()||S.isProjectile()||S.isDebris())&&V.push(new te.TrailerSmokePlugin(S,this.art,this.theater,this.imageFinder,this.gameSpeed)),S.isTechno()){O=O.clone();var z=this.unitSelection.getOrCreateSelectionModel(S),$=new U.PipOverlay(this.rules.general.paradrop,this.rules.audioVisual,S,this.localPlayer,this.alliances,z,this.imageFinder,this.palettes.get("palette.pal"),this.camera,this.strings,this.flyerHelperOpt,this.hiddenObjectsOpt,this.debugText,S=>this.createAnim(S),this.useSpriteBatching,this.useMeshInstancing);let j;if(!S.isUnit()||(ce=S.rules.moveSound)&&this.worldSound&&V.push(new q.MoveSoundFxPlugin(S,ce,this.worldSound)),V.push(new Z.ChronoSparkleFxPlugin(S,this.rules.audioVisual.chronoSparkle1)),S.mindControllerTrait&&V.push(new X.MindControlLinkPlugin(S,z,this.alliances,this.localPlayer)),S.isBuilding()){var le=this.theater.animPalette,ce=this.theater.isoPalette;j=new B.Building(S,z,this.rules,this.art,this.imageFinder,this.theater,this.voxels,this.voxelAnims,O,le,ce,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,this.vxlBuilderFactory,this.useSpriteBatching,new oe.ShpAggregator,this.buildingImageDataCache,$,this.worldSound,F.AnimationType.BUILDUP),S.psychicDetectorTrait&&V.push(new ee.PsychicDetectPlugin(S,S.psychicDetectorTrait,this.localPlayer,this.camera))}else if(S.isVehicle())j=new N.Vehicle(S,this.rules,this.art,this.imageFinder,this.theater,this.voxels,this.voxelAnims,O,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,z,this.vxlBuilderFactory,this.useSpriteBatching,$,this.worldSound),S.rules.damageParticleSystems.length&&V.push(new ie.DamageSmokePlugin(S,this.art,this.theater,this.imageFinder,this.gameSpeed)),S.rules.locomotor!==re.LocomotorType.Ship&&S.rules.locomotor!==re.LocomotorType.Hover||V.push(new se.ShipWakeTrailPlugin(S,this.rules,this.art,this.theater,this.imageFinder,this.gameSpeed)),S.harvesterTrait&&this.mapRenderable&&V.push(new K.HarvesterPlugin(S,S.harvesterTrait)),S.disguiseTrait&&V.push(new Q.VehicleDisguisePlugin(S,S.disguiseTrait,this.localPlayer,this.alliances,j,this.art,this.imageFinder,this.theater,this.camera,this.lighting,this.gameSpeed,this.useSpriteBatching));else if(S.isInfantry())j=new _.Infantry(S,this.rules,this.art,this.imageFinder,this.theater,O,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,z,this.useSpriteBatching,this.useMeshInstancing,$,this.worldSound),S.disguiseTrait&&V.push(new J.InfantryDisguisePlugin(S,S.disguiseTrait,this.localPlayer,this.alliances,j,this.art,this.gameSpeed));else{if(!S.isAircraft())throw new Error("Unhandled game object type "+S.type);j=new H.Aircraft(S,this.rules,this.voxels,this.voxelAnims,O,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,z,this.vxlBuilderFactory,this.useSpriteBatching,$)}return S.tntChargeTrait&&V.push(new Y.TntFxPlugin(S,S.tntChargeTrait,this.rules.combatDamage.ivanIconFlickerRate,j,this.imageFinder,this.art,this.alliances,this.localPlayer,this.worldSound,S=>this.createAnim(S))),V.push(new ne.ObjectCloakPlugin(S,this.localPlayer,this.alliances,j)),V.forEach(S=>j.registerPlugin(S)),j}if(S.isTerrain())return new j.Terrain(S,this.mapRenderable?.terrainLayer,this.imageFinder,O,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,this.useSpriteBatching);if(S.isOverlay())return new L.Overlay(S,this.rules,this.art,this.imageFinder,O,this.camera,this.lighting,this.debugWireframes,this.bridgeImageCache,this.mapRenderable?.overlayLayer,this.useSpriteBatching);if(S.isProjectile()){let B=new W.Projectile(S,this.rules,this.imageFinder,this.voxels,this.voxelAnims,this.theater,O,this.palettes.get("palette.pal"),this.camera,this.gameSpeed,this.lighting,this.lightingDirector,this.vxlBuilderFactory,this.useSpriteBatching,this.useMeshInstancing);return V.forEach(S=>B.registerPlugin(S)),B}if(S.isSmudge())return new D.Smudge(S,this.imageFinder,O,this.camera,this.lighting,this.debugWireframes,this.mapRenderable?.smudgeLayer);if(S.isDebris()){let B=new ae.Debris(S,this.rules,this.imageFinder,this.voxels,this.voxelAnims,O,this.camera,this.lighting,this.gameSpeed,this.vxlBuilderFactory,this.useSpriteBatching);return V.forEach(S=>B.registerPlugin(S)),B}throw new Error("Not implemented")}})}}}),System.register("engine/renderable/entity/Smudge",["engine/renderable/builder/ShpBuilder","engine/renderable/WithPosition","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","game/Coords"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){S("Smudge",class{constructor(S,O,B,N,j,L,D){this.gameObject=S,this.imageFinder=O,this.palette=B,this.camera=N,this.lighting=j,this.debugFrame=L,this.mapSmudgeLayer=D,this.objectArt=S.art,this.label="smudge_"+S.name,this.init()}init(){this.withPosition=new N.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting()}updateLighting(){this.extraLight.copy(this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile)).addScalar(-1)}get3DObject(){return this.target}create3DObject(){let S=this.get3DObject();S||(S=new THREE.Object3D,S.name=this.label,this.target=S,S.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(S))}update(S){}setPosition(S){this.withPosition.setPosition(S.x,S.y,S.z)}getPosition(){return this.withPosition.getPosition()}createObjects(S){var O,N={width:1,height:1};let _=new THREE.Object3D;if(_.matrixAutoUpdate=!1,this.debugFrame.value&&(O=L.DebugUtils.createWireframe(N,0),S.add(O)),this.mapSmudgeLayer?.shouldBeBatched(this.gameObject))this.mapSmudgeLayer.addObject(this.gameObject);else{let L;try{L=this.imageFinder.findByObjectArt(this.objectArt)}catch(O){if(O instanceof j.ImageFinder.MissingImageError)return void console.warn(O.message);throw O}let U=new D.MapSpriteTranslation(N.width,N.height),{spriteOffset:H,anchorPointWorld:V}=U.compute();N=H.clone().add(this.objectArt.getDrawOffset());let W=this.builder=new B.ShpBuilder(L,this.palette,this.camera,F.Coords.ISO_WORLD_SCALE);W.setOffset(N),W.flat=this.objectArt.flat,W.setExtraLight(this.extraLight),N=W.build(),_.add(N),_.position.x=V.x,_.position.z=V.y,_.updateMatrix(),S.add(_)}}onRemove(){this.mapSmudgeLayer?.hasObject(this.gameObject)&&this.mapSmudgeLayer.removeObject(this.gameObject)}dispose(){this.builder?.dispose()}})}}}),System.register("engine/renderable/entity/TargetLines",["game/Coords","game/gameobject/task/system/TargetLinesConfig","game/gameobject/unit/ZoneType"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("TargetLines",class{constructor(S,O,N,j,L){this.currentPlayer=S,this.unitSelection=O,this.camera=N,this.debugPaths=j,this.enabled=L,this.unitPaths=new Map,this.unitLines=new Map,this.lineHeadGeometry=new THREE.PlaneGeometry(3*B.Coords.ISO_WORLD_SCALE,3*B.Coords.ISO_WORLD_SCALE)}create3DObject(){this.obj||(this.obj=new THREE.Object3D,this.obj.name="target_lines",this.obj.matrixAutoUpdate=!1,this.attackLineMaterial=new THREE.LineBasicMaterial({color:11337728,transparent:!0,depthTest:!1,depthWrite:!1}),this.moveLineMaterial=new THREE.LineBasicMaterial({color:43520,transparent:!0,depthTest:!1,depthWrite:!1}),this.attackLineHeadMaterial=new THREE.MeshBasicMaterial({color:11337728,transparent:!0,depthTest:!1,depthWrite:!1}),this.moveLineHeadMaterial=new THREE.MeshBasicMaterial({color:43520,transparent:!0,depthTest:!1,depthWrite:!1}))}get3DObject(){return this.obj}forceShow(){this.selectionHash=void 0}update(S){if(this.obj.visible=this.enabled.value,this.enabled.value){var O=this.unitSelection.getHash();if(void 0===this.selectionHash||this.selectionHash!==O)return this.selectionHash=O,this.hideAllLines(),this.unitPaths.clear(),this.disposeUnitLines(),void this.unitSelection.getSelectedUnits().forEach(O=>{!O.isUnit()||this.currentPlayer&&O.owner!==this.currentPlayer||(this.unitPaths.set(O,N.cloneConfig(O.unitOrderTrait.targetLinesConfig)),this.updateLines(O),O.zone!==j.ZoneType.Air&&!N.configHasTarget(O.unitOrderTrait.targetLinesConfig)||this.showLines(O,S))});{let O=!1;if(this.unitSelection.getSelectedUnits().forEach(B=>{if(B.isUnit()&&(!this.currentPlayer||B.owner===this.currentPlayer)){this.unitPaths.has(B)&&N.configsAreEqual(this.unitPaths.get(B),B.unitOrderTrait.targetLinesConfig)||B.unitOrderTrait.targetLinesConfig?.isRecalc||(this.unitPaths.set(B,N.cloneConfig(B.unitOrderTrait.targetLinesConfig)),O=!0,this.updateLines(B),N.configHasTarget(B.unitOrderTrait.targetLinesConfig)&&this.showLines(B,S));let D=this.unitLines.get(B),F=B.position.worldPosition;if(D){var j=!F.equals(D.srcLineHead.position),L=B.unitOrderTrait.targetLinesConfig?.target;let S=L?L.position.worldPosition:void 0;if(L=S&&!S.equals(D.destLineHead.position),j||L){let O=D.line.geometry;O.verticesNeedUpdate=!0,j&&(O.vertices[O.vertices.length-1].copy(F),D.srcLineHead.position.copy(F),D.srcLineHead.updateMatrix()),S&&L&&(O.vertices[0].copy(S),D.destLineHead.position.copy(S),D.destLineHead.updateMatrix())}}}}),O)return}void 0!==this.showStart&&1e3<=S-this.showStart&&this.hideAllLines()}}showLines(S,O){this.showStart=O,this.unitLines.get(S).root.visible=!0}hideAllLines(){this.showStart=void 0,this.unitLines.forEach(S=>S.root.visible=!1)}updateLines(S){let O=S.unitOrderTrait.targetLinesConfig;if(!O||!N.configHasTarget(O)){if(S.zone!==j.ZoneType.Air)return void(this.unitLines.has(S)&&(F=this.unitLines.get(S),this.obj?.remove(F.root),this.disposeLineObjects(F),this.unitLines.delete(S)));O={pathNodes:[{tile:S.tile,onBridge:void 0},{tile:S.tile,onBridge:void 0}]}}let L=new THREE.Geometry,D=O.pathNodes;D.length?(this.debugPaths.value||(D=[D[0],D[D.length-1]]),D.forEach(S=>{var O=B.Coords.tile3dToWorld(S.tile.rx+.5,S.tile.ry+.5,S.tile.z+(S.onBridge?.tileElevation??0));L.vertices.push(O)}),L.vertices[L.vertices.length-1].copy(S.position.worldPosition)):(_=O.target,L.vertices.push(_.position.worldPosition,S.position.worldPosition));var F=!!O.isAttack,_=F?this.attackLineMaterial:this.moveLineMaterial;let U=new THREE.Line(L,_);U.matrixAutoUpdate=!1;let H=this.createLineHead(F);H.position.copy(L.vertices[L.vertices.length-1]),H.matrixAutoUpdate=!1,H.updateMatrix();let V=this.createLineHead(F);V.position.copy(L.vertices[0]),V.matrixAutoUpdate=!1,V.updateMatrix(),U.renderOrder=H.renderOrder=V.renderOrder=1e6;let W=new THREE.Object3D;W.matrixAutoUpdate=!1,W.visible=!1,W.add(U),W.add(H),W.add(V),this.unitLines.has(S)&&(F=this.unitLines.get(S),this.obj?.remove(F.root),this.disposeLineObjects(F)),this.unitLines.set(S,{root:W,line:U,srcLineHead:H,destLineHead:V}),this.obj?.add(W)}createLineHead(S){let O=new THREE.Mesh(this.lineHeadGeometry,S?this.attackLineHeadMaterial:this.moveLineHeadMaterial);var B=(new THREE.Quaternion).setFromEuler(this.camera.rotation);return O.setRotationFromQuaternion(B),O}disposeUnitLines(){[...this.unitLines.values()].forEach(S=>this.disposeLineObjects(S)),this.unitLines.clear()}disposeLineObjects(S){S.line.geometry.dispose()}dispose(){this.disposeUnitLines(),this.attackLineMaterial?.dispose(),this.attackLineHeadMaterial?.dispose(),this.moveLineMaterial?.dispose(),this.moveLineHeadMaterial?.dispose(),this.lineHeadGeometry.dispose()}})}}}),System.register("engine/renderable/entity/Terrain",["engine/renderable/WithPosition","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/renderable/ShpRenderable","game/gameobject/trait/TiberiumTreeTrait","engine/animation/SimpleRunner","engine/AnimProps","engine/Animation","data/IniSection","engine/renderable/AlphaRenderable"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S}],execute:function(){S("Terrain",class{constructor(S,O,B,N,j,L,D,F,_){this.gameObject=S,this.terrainLayer=O,this.imageFinder=B,this.palette=N,this.camera=j,this.lighting=L,this.debugFrame=D,this.gameSpeed=F,this.useSpriteBatching=_,this.objectArt=S.art,this.label="terrain_"+S.rules.name,this.init()}init(){this.tiberiumTreeTrait=this.gameObject.traits.find(F.TiberiumTreeTrait),this.withPosition=new B.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting()}updateLighting(){this.extraLight.copy(this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile)).addScalar(-1)}get3DObject(){return this.target}create3DObject(){let S=this.get3DObject();S||(S=new THREE.Object3D,S.name=this.label,this.target=S,S.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(S))}setPosition(S){this.withPosition.setPosition(S.x,S.y,S.z)}getPosition(){return this.withPosition.getPosition()}update(S){var O;this.tiberiumTreeTrait&&((O=this.tiberiumTreeTrait.status)!==this.lastTiberiumSpawnStatus&&(this.lastTiberiumSpawnStatus=O)===F.SpawnStatus.Spawning&&this.animationRunner?.animation.reset(),this.animationRunner&&(this.animationRunner.tick(S),this.animationRunner.animation.getState()!==H.AnimationState.STOPPED?this.mainObj.setFrame(this.animationRunner.getCurrentFrame()):this.mainObj.setFrame(0)))}createObjects(S){var O={width:1,height:1};let B;this.debugFrame.value&&(z=j.DebugUtils.createWireframe(O,2),S.add(z));try{B=this.imageFinder.findByObjectArt(this.objectArt)}catch(F){if(F instanceof N.ImageFinder.MissingImageError)return void console.warn(F.message);throw F}var F=this.gameObject.rules.alphaImage;if(F){var z=this.imageFinder.tryFind(F,!1);if(z){let O=new W.AlphaRenderable(z,this.camera,this.objectArt.getDrawOffset());O.create3DObject(),S.add(O.get3DObject())}else console.warn(`<${this.gameObject.name}>: Alpha image "${F}" not found`)}if(this.terrainLayer?.shouldBeBatched(this.gameObject))this.terrainLayer.addObject(this.gameObject);else{let N=new THREE.Object3D;N.matrixAutoUpdate=!1;let j=new L.MapSpriteTranslation(O.width,O.height),{spriteOffset:F,anchorPointWorld:W}=j.compute();N.position.x=W.x,N.position.z=W.y,N.updateMatrix(),O=F.clone().add(this.objectArt.getDrawOffset());let z=D.ShpRenderable.factory(B,this.palette,this.camera,O,this.objectArt.hasShadow);if(z.setBatched(this.useSpriteBatching),this.useSpriteBatching&&z.setBatchPalettes([this.palette]),z.setFrame(0),z.setExtraLight(this.extraLight),z.create3DObject(),N.add(z.get3DObject()),this.mainObj=z,this.tiberiumTreeTrait){let S=new V.IniSection("dummy");this.gameObject.rules.animationRate&&(S.set("Rate",""+60*this.gameObject.rules.animationRate),S.set("Shadow","yes")),O=new U.AnimProps(S,B);let N=new H.Animation(O,this.gameSpeed);this.animationRunner=new _.SimpleRunner,this.animationRunner.animation=N,N.stop()}S.add(N)}}onRemove(){this.terrainLayer?.hasObject(this.gameObject)&&this.terrainLayer.removeObject(this.gameObject)}dispose(){this.mainObj?.dispose()}})}}}),System.register("engine/renderable/entity/TransientAnim",["engine/renderable/entity/Anim"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.Anim{constructor(S,O,B,N,j,L,D,F,_,U,H){super(S,O,B,N,j,L,D,F,_,void 0,H),this.container=U}update(S){var O;!this.isAnimNotStarted()||(O=this.objectArt.report)&&this.worldSound?.playEffect(O,this.getPosition()),super.update(S),this.isAnimFinished()&&(this.remove(),this.dispose())}remove(){this.container.remove(this)}},S("TransientAnim",N)}}}),System.register("engine/renderable/entity/Vehicle",["liang-barsky","game/gameobject/Vehicle","game/Coords","engine/renderable/WithPosition","engine/gfx/DebugUtils","engine/renderable/ShpRenderable","engine/ImageFinder","engine/renderable/MapSpriteTranslation","engine/Animation","engine/AnimProps","data/IniSection","engine/animation/SimpleRunner","util/math","engine/type/ObjectType","game/type/SpeedType","engine/renderable/entity/HighlightAnimRunner","game/gameobject/unit/VeteranLevel","game/gameobject/trait/HarvesterTrait","game/gameobject/common/DeathType","game/gameobject/unit/FacingUtil","game/gameobject/unit/ZoneType","engine/renderable/entity/InvulnerableAnimRunner","game/GameSpeed","engine/renderable/entity/BoxIntersectObject3D","engine/renderable/entity/unit/RotorHelper","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/DebugRenderable","engine/gfx/MathUtils"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S}],execute:function(){var O;le=Math.PI/4,(O=ce=ce||{})[O.Grab=0]="Grab",O[O.Shake1=1]="Shake1",O[O.Shake2=2]="Shake2",S("Vehicle",class{constructor(S,O,B,N,j,D,F,_,U,H,V,W,z,K,$,q,Z){this.gameObject=S,this.rules=O,this.imageFinder=N,this.voxels=D,this.voxelAnims=F,this.palette=_,this.camera=U,this.lighting=H,this.debugFrame=V,this.gameSpeed=W,this.selectionModel=z,this.vxlBuilderFactory=K,this.useSpriteBatching=$,this.pipOverlay=q,this.worldSound=Z,this.rotorSpeeds=[],this.vxlBuilders=[],this.highlightAnimRunner=new Q.HighlightAnimRunner(this.gameSpeed),this.invulnAnimRunner=new te.InvulnerableAnimRunner(this.gameSpeed),this.plugins=[],this.objectRules=S.rules,this.objectArt=S.art,this.label="vehicle_"+this.objectRules.name,this.paletteRemaps=[...this.rules.colors.values()].map(S=>this.palette.clone().remap(S)),this.palette.remap(this.gameObject.owner.color),this.lastOwnerColor=this.gameObject.owner.color,this.updateBaseLight(),this.vxlExtraLight=(new THREE.Vector3).copy(this.baseVxlExtraLight),this.shpExtraLight=(new THREE.Vector3).copy(this.baseShpExtraLight),this.withPosition=new L.WithPosition}updateBaseLight(){this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1).addScalar(this.rules.audioVisual.extraUnitLight),this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)+this.rules.audioVisual.extraUnitLight)}registerPlugin(S){this.plugins.push(S)}updateLighting(){this.plugins.forEach(S=>S.updateLighting?.()),this.updateBaseLight(),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight)}get3DObject(){return this.target}create3DObject(){let S=this.get3DObject();S||(S=new re.BoxIntersectObject3D(new THREE.Vector3(1,1/3,1).multiplyScalar(j.Coords.LEPTONS_PER_TILE)),S.name=this.label,S.userData.id=this.gameObject.id,this.target=S,S.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(S),this.vxlBuilders.forEach(S=>S.setExtraLight(this.vxlExtraLight)),this.shpRenderable?.setExtraLight(this.shpExtraLight),this.pipOverlay&&(this.pipOverlay.create3DObject(),this.posObj?.add(this.pipOverlay.get3DObject())))}updateClippingPlanes(S,O=!1){if(O||this.objectRules.naval&&!this.objectRules.underwater){var B=j.Coords.tileHeightToWorld(S);let O=[new THREE.Plane(new THREE.Vector3(0,1,0),-B)];this.vxlBuilders.forEach(S=>S.setClippingPlanes(O))}}getIntersectTarget(){return this.target}getUiName(){var S=this.plugins.reduce((S,O)=>O.getUiNameOverride?.()??S,void 0);return void 0!==S?S:this.gameObject.getUiName()}setPosition(S){this.withPosition.setPosition(S.x,S.y,S.z)}getPosition(){return this.withPosition.getPosition()}highlight(){this.plugins.some(S=>S.shouldDisableHighlight?.())||this.highlightAnimRunner.animation.getState()!==H.AnimationState.RUNNING&&this.highlightAnimRunner.animate(2)}update(S,O=0){this.plugins.forEach(O=>O.update(S)),this.pipOverlay?.update(S),this.gameObject.veteranLevel!==this.lastVeteranLevel&&(this.gameObject.veteranLevel===Z.VeteranLevel.Elite&&void 0!==this.lastVeteranLevel&&this.highlightAnimRunner.animate(30),this.lastVeteranLevel=this.gameObject.veteranLevel);var B=this.gameObject.tile.z+this.gameObject.tileElevation,N=void 0===this.lastElevation||this.lastElevation!==B;N&&(this.lastElevation=B,this.updateBaseLight(),this.updateClippingPlanes(this.gameObject.tile.z));var L=this.gameObject.invulnerableTrait.isActive(),D=L!==this.lastInvulnerable;this.lastInvulnerable=L;var F=this.highlightAnimRunner.shouldUpdate();F&&this.highlightAnimRunner.tick(S),L&&D&&this.invulnAnimRunner.animate(),this.invulnAnimRunner.shouldUpdate()&&this.invulnAnimRunner.tick(S);var _=this.gameObject.warpedOutTrait.isActive(),U=_!==this.lastWarpedOut;this.lastWarpedOut=_;var K=this.gameObject.cloakableTrait?.isCloaked(),$=K!==this.lastCloaked;this.lastCloaked=K;let q=this.gameObject.submergibleTrait?.isSubmerged();if(B=q!==this.lastSubmerged,this.lastSubmerged=q,U||$||B){let S=_||K||q?.5:1;this.shpRenderable?.setOpacity(S),this.shpRenderable?.setFlat(!!q),this.vxlBuilders.forEach(O=>{O.setOpacity(S),O.setShadow(!q)}),this.placeholder?.setOpacity(S)}if((N||D||L||F)&&(Q=L?this.invulnAnimRunner.getValue():0,J=(F?this.highlightAnimRunner.getValue():0)||Q,Y=this.lighting.getAmbientIntensity(),ne.ExtraLightHelper.multiplyVxl(this.vxlExtraLight,this.baseVxlExtraLight,Y,J),ne.ExtraLightHelper.multiplyShp(this.shpExtraLight,this.baseShpExtraLight,J)),this.gameObject.isDestroyed&&this.resolveObjectRemove){if(this.squidGrabAnim&&(this.posObj?.remove(this.squidGrabAnim.get3DObject()),this.squidGrabAnim.dispose(),this.squidGrabAnim=void 0),this.destroyStartTime||(this.destroyStartTime=S),this.isSinker()){(ie=1<=(te=(S-this.destroyStartTime)/3e3))?this.mainObj.visible=!1:(this.objectRules.naval&&(this.mainObj.rotation.x=Math.PI/4*te),this.mainObj.position.y=-16*j.Coords.ISO_WORLD_SCALE*te,this.mainObj.position.z=8*j.Coords.ISO_WORLD_SCALE*te,this.mainObj.updateMatrix());let O=!1;this.sinkWakeAnims.forEach(O=>O.update(S)),this.sinkWakeAnims.filter(S=>!S.isAnimFinished()).length||(this.sinkWakeAnims.forEach(S=>this.get3DObject().remove(S.get3DObject())),this.sinkWakeAnims.length=0,O=!0),ie&&O&&this.resolveObjectRemove()}}else if(!this.gameObject.warpedOutTrait.isActive()){let B=(Math.floor(this.gameObject.direction+this.gameObject.spinVelocity*O)+360)%360;var Q=B!==this.lastDirection;Q&&void 0!==this.lastDirection&&this.objectArt.isVoxel&&this.gameObject.zone===ee.ZoneType.Air&&(re=B-this.lastDirection,void 0!==this.lastDirectionDelta&&Math.abs(re)<2&&Math.abs(this.lastDirectionDelta)<2&&Math.sign(re)!==Math.sign(this.lastDirectionDelta)?B=this.lastDirection:this.lastDirectionDelta=re),this.lastDirection=B;var Y=this.gameObject.owner.color;this.lastOwnerColor!==Y&&(this.palette.remap(Y),this.lastOwnerColor=Y,this.vxlBuilders.forEach(S=>S.setPalette(this.palette)),this.shpRenderable?.setPalette(this.palette),this.placeholder?.setPalette(this.palette));var X,J=this.gameObject.isMoving||!this.objectArt.isVoxel&&!!this.gameObject.spinVelocity,te=this.gameObject.isFiring,ie=void 0===this.lastMoving||this.lastMoving!==J,re=void 0===this.lastFiring||this.lastFiring!==te;let N;if(0<O&&(J||ie)&&(Y=this.gameObject.moveTrait.velocity.clone().multiplyScalar(O).add(this.gameObject.position.worldPosition),this.setPosition(Y)),(ie||re)&&(this.lastMoving=J,this.lastFiring=te,this.objectArt.isVoxel||this.updateShapeAnimation(J,te)),this.gameObject.rules.isChargeTurret){if(re&&te){this.chargeTurretRunner=new z.SimpleRunner;let S=new V.AnimProps(new W.IniSection("dummy"),this.gameObject.rules.turretCount);S.reverse=!0,S.rate=5;var se=new H.Animation(S,this.gameSpeed);this.chargeTurretRunner.animation=se}this.chargeTurretRunner?.tick(S);var ae=this.chargeTurretRunner?.getCurrentFrame()??0;N=ae!==this.currentTurretIdx,this.currentTurretIdx=ae,this.chargeTurretRunner?.animation.getState()===H.AnimationState.STOPPED&&(this.chargeTurretRunner=void 0)}else N=this.gameObject.turretNo!==this.currentTurretIdx,this.currentTurretIdx=this.gameObject.turretNo;this.objectArt.isVoxel?(this.updateVxlRotation(B,Q),this.updateBodyVxl(),se=(re=this.gameObject.rocking?.facing)!==this.lastRockingFacing,this.lastRockingFacing=re,!se||void 0===re||0<(X=this.gameObject.rocking.factor)&&this.startRocking(re,X,S),X=(ae=!(!this.gameObject.parasiteableTrait?.isInfested()||!this.gameObject.parasiteableTrait.getParasite()?.rules.organic))!==this.lastSquidGrabbed,this.lastSquidGrabbed=ae,this.updateRocking(S,ae),this.gameObject.turretTrait&&1<this.objectRules.turretCount&&N&&this.updateActiveTurret(this.currentTurretIdx),this.updateSquidGrab(S,ae,X,Q,B,re,se)):this.shpAnimRunner&&(this.shpAnimRunner.tick(S),this.updateShapeFrame(B,J,te))}}updateVxlRotation(S,O){var B,N=this.gameObject.tilterTrait?.tilt??{yaw:0,pitch:0};this.lastTilt&&N.pitch===this.lastTilt.pitch&&N.yaw===this.lastTilt.yaw&&!O||(this.lastTilt=N,this.tiltObj.rotation.y=THREE.Math.degToRad(N.yaw),this.tiltObj.rotation.x=THREE.Math.degToRad(N.pitch),this.tiltObj.updateMatrix(),this.dirWrapObj.rotation.y=THREE.Math.degToRad(S-N.yaw),this.dirWrapObj.updateMatrix()),this.turret&&(N=(B=Math.floor(this.gameObject.turretTrait.facing))!==this.lastTurretFacing,this.lastTurretFacing=B,(N||O)&&(B=THREE.Math.degToRad(B-S),this.turret.rotation.y=B,this.turret.updateMatrix(),this.barrel&&(this.barrel.rotation.y=B,this.barrel.updateMatrix()))),this.rotors&&this.rotors.forEach((S,O)=>{this.rotorSpeeds[O]=se.RotorHelper.computeRotationStep(this.gameObject,this.rotorSpeeds[O]??0,this.objectArt.rotors[O]),this.rotorSpeeds[O]&&(S.rotateOnAxis(this.objectArt.rotors[O].axis,this.rotorSpeeds[O]),S.updateMatrix())})}startRocking(S,O,N){if(this.bodyVxlBuilder){this.rockingStartTime=N,this.rockingFactor=O;var j=this.bodyVxlBuilder.getLocalBoundingBox();let D=new THREE.Box2(new THREE.Vector2(j.min.x,j.min.y),new THREE.Vector2(j.max.x,j.max.y));var L=THREE.Math.degToRad(J.FacingUtil.toWorldDeg(S));j=new THREE.Vector2;let F=new THREE.Vector2(10,0).rotateAround(new THREE.Vector2,L).setLength(D.getSize(j).length()+1);j=F.toArray(),B.default([0,0],j,[D.min.x,D.min.y,D.max.x,D.max.y]),this.rockingPoint=new THREE.Vector3(j[0],0,j[1]),j=F.clone().rotateAround(new THREE.Vector2,-Math.PI/2).normalize(),this.rockingAxis=new THREE.Vector3(j.x,0,j.y)}}updateRocking(S,O){if(this.rockingStartTime){var B=S-this.rockingStartTime;let L=this.rockingFactor;O||(L*=1-Math.min(1,this.gameObject.rules.weight/5));var j=B||L?Math.min(1,B/(N.ROCKING_TICKS/ie.GameSpeed.BASE_TICKS_PER_SECOND*1e3)*this.gameSpeed.value/L):0;B=le*L*(1-Math.pow(2*(j-.5),2)),this.rockingTiltObj.position.set(0,0,0),this.rockingTiltObj.rotation.set(0,0,0),this.rockingTiltObj.scale.set(1,1,1),oe.MathUtils.rotateObjectAboutPoint(this.rockingTiltObj,this.rockingPoint,this.rockingAxis,B),this.rockingTiltObj.updateMatrix(),1!==j&&0!==L||(this.rockingStartTime=void 0)}}updateSquidGrab(S,O,B,N,L,D,F){var _;if(B&&(this.squidGrabAnim&&(this.posObj?.remove(this.squidGrabAnim.get3DObject()),this.squidGrabAnim.dispose(),this.squidGrabAnim=void 0),O&&(this.squidGrabAnim=this.renderableManager.createAnim("SQDG",S=>{S.extraOffset={x:0,y:-j.Coords.ISO_TILE_SIZE/4},S.setExtraLight(this.shpExtraLight)},!0),this.squidGrabAnim.remapColor(this.gameObject.parasiteableTrait.getParasite().owner.color),this.squidGrabAnim.create3DObject(),this.posObj?.add(this.squidGrabAnim.get3DObject()))),O&&(N||B)&&this.updateSquidGrabAnim(this.squidGrabAnim.getAnimProps(),L,ce.Grab),O&&F&&D&&(_=0<D?ce.Shake1:ce.Shake2,this.updateSquidGrabAnim(this.squidGrabAnim.getAnimProps(),L,_),this.squidGrabAnim.reset()),O&&F&&!D){var U=this.rules.combatDamage.splashList;for(let S=0;S<3;S++){var H=U[K.getRandomInt(0,U.length-1)];this.renderableManager.createTransientAnim(H,S=>{let O=this.withPosition.getPosition().clone();var B={x:K.getRandomInt(-j.Coords.ISO_TILE_SIZE/2,j.Coords.ISO_TILE_SIZE/2)*j.Coords.ISO_WORLD_SCALE,y:K.getRandomInt(-j.Coords.ISO_TILE_SIZE/2,j.Coords.ISO_TILE_SIZE/2)*j.Coords.ISO_WORLD_SCALE};S.setPosition(O.add(new THREE.Vector3(B.x,0,B.y)))})}}this.squidGrabAnim?.update(S)}updateShapeAnimation(S,O){if(this.shpAnimRunner){let N=this.shpAnimRunner.animation.props;var B;O?(N.loopEnd=this.objectArt.firingFrames-1,N.rate=V.AnimProps.defaultRate/2):S||this.objectRules.naval?(N.loopEnd=this.objectArt.walkFrames-1,B=this.objectRules.naval&&!S?this.objectRules.idleRate:this.objectRules.walkRate,N.rate=V.AnimProps.defaultRate/B):N.loopEnd=this.objectArt.standingFrames-1,this.shpAnimRunner.animation.rewind()}}updateShapeFrame(S,O,B){if(this.shpRenderable&&this.shpAnimRunner){let L;var N=this.objectArt.facings,j=Math.round((45-S+360)%360/360*N)%N;N=this.shpAnimRunner.animation.getCurrentFrame(),L=B?this.objectArt.startFiringFrame+this.objectArt.firingFrames*j+N:O||this.objectRules.naval?this.objectArt.startWalkFrame+this.objectArt.walkFrames*j+N:this.objectArt.startStandFrame+this.objectArt.standingFrames*j+N,this.shpRenderable.setFrame(L)}}updateSquidGrabAnim(S,O,B){var j=Math.round((360-O)%360/360*8)%8;S.start=10*j+80*B,S.end=10*j+9+80*B,S.loopStart=S.start,S.loopEnd=S.end,S.loopCount=0,S.rate=10/(N.ROCKING_TICKS/ie.GameSpeed.BASE_TICKS_PER_SECOND/(this.rockingFactor??1))}createObjects(S){if(this.debugFrame.value){let O=D.DebugUtils.createWireframe({width:1,height:1},1);O.translateX(-j.Coords.getWorldTileSize()/2),O.translateZ(-j.Coords.getWorldTileSize()/2),S.add(O)}let O=this.tiltObj=new THREE.Object3D;O.matrixAutoUpdate=!1,O.rotation.order="YXZ";let B=this.dirWrapObj=new THREE.Object3D;B.matrixAutoUpdate=!1;var N=this.mainObj=this.createMainObject();let L=this.rockingTiltObj=new THREE.Object3D;L.matrixAutoUpdate=!1,L.rotation.order="YXZ",L.add(N),B.add(L),O.add(B);let F=this.posObj=new THREE.Object3D;F.matrixAutoUpdate=!1,F.add(O),S.add(F)}computeSpriteAnchorOffset(S){var O=this.objectArt.getDrawOffset();return{x:S.x+O.x,y:S.y+O.y}}createMainObject(){let S=new THREE.Object3D;if(S.matrixAutoUpdate=!1,this.objectArt.isVoxel){var O=!this.objectArt.noHva,B=this.objectArt.imageName.toLowerCase(),N=B+".vxl",j=this.voxels.get(N);if(j){var L=O?this.voxelAnims.get(B+".hva"):void 0;let N=this.bodyVxlBuilder=this.vxlBuilderFactory.create(j,L,this.paletteRemaps,this.palette);this.vxlBuilders.push(N),L=this.mainVxl=N.build(),S.add(L),this.objectArt.rotors&&(this.rotors=this.objectArt.rotors.map(S=>{var O=N.getSection(S.name);if(!O)throw new Error(`Vehicle "${this.objectRules.name}" VXL section "${S.name}" not found`);return O}))}else console.warn(`VXL missing for vehicle ${this.objectRules.name}. Vxl file ${N} not found. `),S.add(this.createPlaceholder());if(this.objectRules.spawns&&this.objectRules.noSpawnAlt){let N=B+"wo.vxl";if(K=this.voxels.get(N)){var D=O?this.voxelAnims.get(N.replace(".vxl",".hva")):void 0;let B=this.vxlBuilderFactory.create(K,D,this.paletteRemaps,this.palette);this.vxlBuilders.push(B);let j=this.noSpawnAltVxl=B.build();j.visible=!1,S.add(j)}else console.warn(`<${this.gameObject.name}>: Couldn't find noSpawnAlt image "${N}"`)}if(this.gameObject.harvesterTrait&&this.objectRules.unloadingClass){var K,q=this.rules.hasObject(this.objectRules.unloadingClass,$.ObjectType.Vehicle)?this.rules.getObject(this.objectRules.unloadingClass,$.ObjectType.Vehicle).imageName.toLowerCase():void 0;if(K=q?this.voxels.get(q+".vxl"):void 0){D=O?this.voxelAnims.get(q+".hva"):void 0;let B=this.vxlBuilderFactory.create(K,D,this.paletteRemaps,this.palette);this.vxlBuilders.push(B);let N=this.harvesterAltVxl=B.build();N.visible=!1,S.add(N)}else console.warn(`<${this.gameObject.name}>: Couldn't find UnloadingClass image "${q}.vxl"`)}if(this.gameObject.turretTrait){let N=S;if(q=this.objectArt.turretOffset){let O=new THREE.Object3D;O.matrixAutoUpdate=!1,O.position.z=-q,O.updateMatrix(),S.add(O),N=O}let j,L=[];for(let S=0;S<this.objectRules.turretCount;++S){let N=B+`tur${S||""}.vxl`;var Q=this.voxels.get(N);if(Q){var Z=O?this.voxelAnims.get(N.replace(".vxl",".hva")):void 0;let B=this.vxlBuilderFactory.create(Q,Z,this.paletteRemaps,this.palette);this.vxlBuilders.push(B);let j=B.build();j.visible=S===this.gameObject.turretNo,L.push(j)}else console.warn(`<${this.gameObject.name}>: Missing turret file "${N}"`),L.push(void 0)}this.currentTurretIdx=this.gameObject.turretNo,this.allTurrets=L,1<L.length?(j=this.turret=new THREE.Object3D,j.matrixAutoUpdate=!1,L.forEach(S=>S&&j.add(S))):j=this.turret=L[0],j&&N.add(j);let D=B+"barl.vxl";if(q=this.voxels.get(D)){var Y=O?this.voxelAnims.get(D.replace(".vxl",".hva")):void 0;let S=this.vxlBuilderFactory.create(q,Y,this.paletteRemaps,this.palette);this.vxlBuilders.push(S);var X=this.barrel=S.build();N.add(X)}}}else{let O=new U.MapSpriteTranslation(1,1);var{spriteOffset:Y,anchorPointWorld:X}=O.compute();let N;Y=this.computeSpriteAnchorOffset(Y);try{N=this.imageFinder.findByObjectArt(this.objectArt)}catch(B){if(!(B instanceof _.ImageFinder.MissingImageError))throw B;console.warn(`<${this.gameObject.name}>: `+B.message)}if(N){let O=this.shpRenderable=F.ShpRenderable.factory(N,this.palette,this.camera,Y,this.objectArt.hasShadow);O.setBatched(this.useSpriteBatching),this.useSpriteBatching&&O.setBatchPalettes(this.paletteRemaps),O.create3DObject(),S.add(O.get3DObject()),S.position.x=X.x,S.position.z=X.y,S.updateMatrix();let B=new V.AnimProps(new W.IniSection("dummy"),N);B.loopCount=-1,X=new H.Animation(B,this.gameSpeed),this.shpAnimRunner=new z.SimpleRunner,this.shpAnimRunner.animation=X}else S.add(this.createPlaceholder())}return S}createPlaceholder(){return this.placeholder=new ae.DebugRenderable({width:.5,height:.5},this.objectArt.height,this.palette,{centerFoundation:!0}),this.placeholder.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholder.setBatchPalettes(this.paletteRemaps),this.placeholder.create3DObject(),this.placeholder.get3DObject()}updateActiveTurret(S){this.allTurrets.forEach((O,B)=>{O&&(O.visible=B===S)})}updateBodyVxl(){var S=!!this.noSpawnAltVxl&&!this.gameObject.airSpawnTrait.availableSpawns,O=!!this.harvesterAltVxl&&!!this.gameObject.harvesterTrait&&[Y.HarvesterStatus.PreparingToUnload,Y.HarvesterStatus.Unloading].includes(this.gameObject.harvesterTrait.status);this.noSpawnAltVxl&&(this.noSpawnAltVxl.visible=S),this.harvesterAltVxl&&(this.harvesterAltVxl.visible=O),this.mainVxl&&(this.mainVxl.visible=!S&&!O)}isSinker(){return this.gameObject.zone===ee.ZoneType.Water&&this.gameObject.isSinker}onCreate(S){this.renderableManager=S,this.plugins.forEach(O=>O.onCreate(S)),this.objectRules.ambientSound&&(this.ambientSound=this.worldSound?.playEffect(this.objectRules.ambientSound,this.gameObject))}onRemove(S){if(this.renderableManager=void 0,this.plugins.forEach(O=>O.onRemove(S)),this.ambientSound?.stop(),this.gameObject.isDestroyed&&this.gameObject.isVehicle()&&this.get3DObject()){if(this.gameObject.deathType===X.DeathType.Temporal)return;if(this.gameObject.deathType===X.DeathType.None)return;if(this.gameObject.deathType===X.DeathType.Crush)return;if(!this.isSinker()||this.objectRules.underwater||this.gameObject.deathType!==X.DeathType.Sink&&this.objectRules.speedType===q.SpeedType.Hover){if(this.objectRules.underwater&&this.objectRules.organic)return;if(!this.objectRules.explosion.length)return;if(this.gameObject.explodes&&this.objectRules.deathWeapon)return;var O=(O=this.objectRules.explosion)[K.getRandomInt(0,O.length-1)];return void S.createTransientAnim(O,S=>S.setPosition(this.withPosition.getPosition()))}if(this.isSinker()){var B=this.rules.audioVisual.wake;this.sinkWakeAnims=[];for(let O=0;O<5;O++){let O=S.createAnim(B,void 0,!0);var N={x:K.getRandomInt(-15,15)*j.Coords.ISO_WORLD_SCALE,y:K.getRandomInt(-15,15)*j.Coords.ISO_WORLD_SCALE};O.setPosition(new THREE.Vector3(N.x,0,N.y)),this.sinkWakeAnims.push(O),O.create3DObject(),this.get3DObject().add(O.get3DObject())}this.gameObject.rules.naval||this.updateClippingPlanes(this.gameObject.tile.z,!0)}return new Promise(S=>this.resolveObjectRemove=S)}}dispose(){this.plugins.forEach(S=>S.dispose()),this.pipOverlay?.dispose(),this.shpRenderable?.dispose(),this.vxlBuilders.forEach(S=>S.dispose()),this.sinkWakeAnims?.forEach(S=>S.dispose()),this.squidGrabAnim?.dispose(),this.placeholder?.dispose()}})}}}),System.register("engine/renderable/entity/WaypointLine",["three.meshline","game/Coords"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("WaypointLine",class{constructor(S,O){this.linePath=S,this.camera=O,this.lastColor=this.linePath.color,this.lastBgColor=this.linePath.bgColor,this.lineHeadMaterial=new THREE.PointsMaterial({size:6,sizeAttenuation:!1,color:S.color,depthTest:!1,depthWrite:!1,transparent:!0}),this.lineHeadBgMaterial=new THREE.PointsMaterial({size:8,sizeAttenuation:!1,color:S.bgColor,depthTest:!1,depthWrite:!1,transparent:!0})}get3DObject(){return this.wrapper}create3DObject(){if(!this.wrapper){this.wrapper=new THREE.Object3D,this.wrapper.name="waypoint_line";let S=this.meshLine=new B.MeshLine,O=this.linePath.vertices.filter(S=>S.enabled).map(S=>S.position);this.lastLineVertexCount=O.length,S.setGeometry(O.map(S=>[S.x,S.y,S.z]).flat()),this.fgLineMesh=new THREE.Mesh(S.geometry,this.createFgLineMaterial(new THREE.Color(this.linePath.color),this.computeLineLength(O))),this.fgLineMesh.renderOrder=1000002,this.wrapper.add(this.fgLineMesh),this.bgLineMesh=new THREE.Mesh(S.geometry,this.createBgLineMaterial(new THREE.Color(this.linePath.bgColor))),this.bgLineMesh.renderOrder=1000001,this.wrapper.add(this.bgLineMesh),this.lineHeadMeshes=this.createLineHeads(this.linePath.vertices.filter(S=>S.enabled&&S.lineHead).map(S=>S.position)),this.lineHeadMeshes.forEach(S=>this.wrapper.add(S))}}update(S){this.lastUpdateMillis||(this.lastUpdateMillis=S);let O=(S-this.lastUpdateMillis)/(1e3/120);this.lastUpdateMillis=S;var B=this.camera.top+"_"+this.camera.right;if(B!==this.cameraHash&&(this.cameraHash=B,[this.fgLineMesh,this.bgLineMesh].forEach(S=>{S.material.uniforms.resolution.value.copy(this.computeResolution(this.camera))})),this.linePath.verticesNeedUpdate){this.linePath.verticesNeedUpdate=!1;let S=this.linePath.vertices.filter(S=>S.enabled).map(S=>S.position);this.lastLineVertexCount!==S.length&&(this.lastLineVertexCount=S.length,this.meshLine.attributes=void 0),this.meshLine.setGeometry(S.map(S=>[S.x,S.y,S.z]).flat());let O=this.computeLineLength(S);[this.fgLineMesh].forEach(S=>{S.material.uniforms.dashArray.value=this.computeDashArray(O)}),this.updateLineHeads(this.linePath.vertices.filter(S=>S.enabled&&S.lineHead).map(S=>S.position))}this.linePath.color!==this.lastColor&&(this.lastColor=this.linePath.color,this.fgLineMesh.material.uniforms.color.value=new THREE.Color(this.linePath.color),this.lineHeadMaterial.color.set(this.linePath.color)),this.linePath.bgColor!==this.lastBgColor&&(this.lastBgColor=this.linePath.bgColor,this.bgLineMesh.material.uniforms.color.value=new THREE.Color(this.linePath.bgColor),this.lineHeadBgMaterial.color.set(this.linePath.bgColor)),[this.fgLineMesh].forEach(S=>{let B=S.material;B.uniforms.dashOffset.value-=B.uniforms.dashArray.value/50*O})}computeLineLength(S){let O=0;for(let B=1,N=S.length;B<N;B++)O+=S[B].distanceTo(S[B-1]);return O}createFgLineMaterial(S,O){return new B.MeshLineMaterial({color:S,lineWidth:2,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,dashArray:this.computeDashArray(O),depthTest:!1})}createBgLineMaterial(S){return new B.MeshLineMaterial({color:S,lineWidth:4,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,depthTest:!1})}computeDashArray(S){return Math.min(1,5/S)*N.Coords.ISO_WORLD_SCALE}computeResolution(S){var O=S.top,B=S.right/S.top,j=2*O/Math.cos(S.rotation.y);return new THREE.Vector2(j*B,j).multiplyScalar(O*Math.cos(this.camera.rotation.x)/N.Coords.ISO_WORLD_SCALE)}createLineHeads(S){let O=new THREE.BufferGeometry;O.addAttribute("position",new THREE.BufferAttribute(new Float32Array(S.map(S=>[S.x,S.y,S.z]).flat()),3));let B=new THREE.Points(O,this.lineHeadMaterial);B.renderOrder=1000004;let N=new THREE.Points(O,this.lineHeadBgMaterial);return N.renderOrder=1000003,[B,N]}updateLineHeads(S){var O=S.map(S=>[S.x,S.y,S.z]).flat();let B=this.lineHeadMeshes[0].geometry,N=B.getAttribute("position");if(N.array.length!==O.length)B.addAttribute("position",new THREE.BufferAttribute(new Float32Array(O),3));else{let S=N.array;for(let B=0,N=S.length;B<N;B++)S[B]=O[B];N.needsUpdate=!0}}dispose(){[this.fgLineMesh,this.bgLineMesh].forEach(S=>{S&&(S.geometry.dispose(),S.material.dispose())}),this.lineHeadMeshes?.forEach(S=>S.geometry.dispose()),this.lineHeadMaterial.dispose(),this.lineHeadBgMaterial.dispose()}})}}}),System.register("engine/renderable/entity/WaypointLines",["game/Coords","game/gameobject/task/system/TargetLinesConfig","util/array","engine/renderable/entity/WaypointLine"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){var O;(O=D=D||{})[O.Source=0]="Source",O[O.InitialTarget=1]="InitialTarget",O[O.Waypoint=2]="Waypoint",S("WaypointLines",class{constructor(S,O,B,N,j){this.unitSelection=S,this.currentPlayer=O,this.selectedPaths=B,this.paths=N,this.camera=j,this.lastPathWaypoints=new Map,this.sourceLinePaths=new Map,this.waypointLinePaths=new Map}create3DObject(){this.obj||(this.obj=new THREE.Object3D,this.obj.name="waypoint_lines",this.obj.matrixAutoUpdate=!1)}get3DObject(){return this.obj}update(S){var O=this.unitSelection.getHash(),B=void 0===this.selectionHash||this.selectionHash!==O;B&&(this.selectionHash=O);let N=!this.lastPaths||!j.equals(this.lastPaths,this.paths);if(N)this.lastPaths=[...this.paths];else for(var D of this.paths){var F=this.lastPathWaypoints.get(D);if(!F||!j.equals(D.waypoints,F)){N=!0,this.lastPathWaypoints.set(D,[...D.waypoints]);break}}if(B||N){let O=[],B=this.unitSelection.getSelectedUnits();1===B.length&&B[0].owner!==this.currentPlayer&&(B=[]),O=this.paths.length?[...new Set([...this.paths.map(S=>[...S.units]).flat(),...B])]:B,O=O.filter(S=>S.isSpawned),[...this.sourceLinePaths.values(),...this.waypointLinePaths.values()].forEach(S=>{let O=S.lineObj;O&&(this.obj.remove(O.get3DObject()),O.dispose())}),this.sourceLinePaths.clear(),this.waypointLinePaths.clear();for(let B of O)if(B.isUnit()){let O=this.createSourceLinePath(B,this.paths.find(S=>S.units.has(B)));this.sourceLinePaths.set(B,O),O.lineObj=new L.WaypointLine(O,this.camera),O.lineObj.create3DObject(),this.obj.add(O.lineObj.get3DObject()),O.lineObj.update(S)}for(var _ of this.paths){let O=this.createWaypointLinePath(_,this.selectedPaths.includes(_));this.waypointLinePaths.set(_,O),O.lineObj=new L.WaypointLine(O,this.camera),O.lineObj.create3DObject(),this.obj.add(O.lineObj.get3DObject()),O.lineObj.update(S)}}else this.sourceLinePaths.forEach((O,B)=>{this.updateSourceLinePath(O,B,this.paths.find(S=>S.units.has(B))),O.lineObj.update(S)}),this.waypointLinePaths.forEach(O=>{this.updateWaypointLinePath(O),O.lineObj.update(S)})}createSourceLinePath(S,O){var B=!!S.unitOrderTrait.targetLinesConfig&&N.configHasTarget(S.unitOrderTrait.targetLinesConfig);let j=S.unitOrderTrait.waypointPath?O?.waypoints.find(O=>O.original===(S.unitOrderTrait.currentWaypoint??S.unitOrderTrait.waypointPath.waypoints[0])):O?.waypoints.find(S=>S.draft),L={vertices:[],verticesNeedUpdate:!1,color:10867711,bgColor:this.unitSelection.isSelected(S)?16777215:0};var F={type:D.Source,enabled:B||!!j,lineHead:!0,obj:S,position:S.position.worldPosition.clone()};return B={type:D.InitialTarget,enabled:B&&(!S.unitOrderTrait.waypointPath||!S.unitOrderTrait.currentWaypoint),lineHead:!0,obj:S,position:B?this.computeInitialTargetPosition(S.unitOrderTrait.targetLinesConfig).clone():new THREE.Vector3},L.vertices.push(F,B),j&&(B={type:D.Waypoint,enabled:!0,lineHead:!1,waypoint:j,position:j.target.getWorldCoords().clone()},L.vertices.push(B)),L}updateSourceLinePath(S,O,B){var j,L=O.unitOrderTrait.waypointPath?B?.waypoints.find(S=>S.original===(O.unitOrderTrait.currentWaypoint??O.unitOrderTrait.waypointPath.waypoints[0])):B?.waypoints.find(S=>S.draft),F=!!L,_=!!O.unitOrderTrait.targetLinesConfig&&N.configHasTarget(O.unitOrderTrait.targetLinesConfig);for(j of S.vertices){let B,N;j.type===D.Source?(B=F||_,N=O.position.worldPosition):j.type===D.InitialTarget?(B=_&&(!O.unitOrderTrait.waypointPath||!O.unitOrderTrait.currentWaypoint),_&&(N=this.computeInitialTargetPosition(j.obj.unitOrderTrait.targetLinesConfig))):(B=F,L&&(j.waypoint=L),N=j.waypoint.target.getWorldCoords()),N&&!N.equals(j.position)&&(S.verticesNeedUpdate=!0,j.position.copy(N)),void 0!==B&&B!==j.enabled&&(S.verticesNeedUpdate=!0,j.enabled=B)}}createWaypointLinePath(S,O){return{vertices:S.waypoints.map(S=>({type:D.Waypoint,enabled:!0,lineHead:!0,waypoint:S,position:S.target.getWorldCoords().clone()})),verticesNeedUpdate:!1,color:10867711,bgColor:O?16777215:0}}updateWaypointLinePath(S){for(var O of S.vertices){let B=O.waypoint.target.getWorldCoords();B.equals(O.position)||(O.position.copy(B),S.verticesNeedUpdate=!0)}}computeInitialTargetPosition(S){if(S.pathNodes.length){var O=S.pathNodes[0];return B.Coords.tile3dToWorld(O.tile.rx+.5,O.tile.ry+.5,O.tile.z+(O.onBridge?.tileElevation??0))}if(S.target)return S.target.position.worldPosition;throw new Error("No target and no pathNodes found")}dispose(){this.sourceLinePaths.forEach(S=>S.lineObj?.dispose()),this.waypointLinePaths.forEach(S=>S.lineObj?.dispose())}})}}}),System.register("engine/renderable/entity/building/AnimationType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("AnimationType",B={}))[O.IDLE=0]="IDLE",O[O.PRODUCTION=1]="PRODUCTION",O[O.ACTIVE=2]="ACTIVE",O[O.SPECIAL=3]="SPECIAL",O[O.SUPER=4]="SUPER",O[O.BUILDUP=5]="BUILDUP",O[O.UNBUILD=6]="UNBUILD",O[O.FACTORY_DEPLOYING=7]="FACTORY_DEPLOYING",O[O.FACTORY_ROOF_DEPLOYING=8]="FACTORY_ROOF_DEPLOYING",O[O.SUPER_IDLE=9]="SUPER_IDLE",O[O.SUPER_CHARGE_START=10]="SUPER_CHARGE_START",O[O.SUPER_CHARGE_LOOP=11]="SUPER_CHARGE_LOOP",O[O.SUPER_CHARGE_END=12]="SUPER_CHARGE_END",O[O.SPECIAL_DOCKING=13]="SPECIAL_DOCKING",O[O.SPECIAL_REPAIR_START=14]="SPECIAL_REPAIR_START",O[O.SPECIAL_REPAIR_LOOP=15]="SPECIAL_REPAIR_LOOP",O[O.SPECIAL_REPAIR_END=16]="SPECIAL_REPAIR_END",O[O.SPECIAL_SHOOT=17]="SPECIAL_SHOOT",O[O.FACTORY_UNDER_DOOR=18]="FACTORY_UNDER_DOOR",O[O.FACTORY_UNDER_ROOF_DOOR=19]="FACTORY_UNDER_ROOF_DOOR"}}}),System.register("engine/renderable/entity/building/BuildingAnimArtProps",["engine/renderable/entity/building/AnimationType","data/IniSection","engine/renderable/entity/building/BuildingAnimData","engine/type/ObjectType"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=(new Map).set(B.AnimationType.IDLE,["IdleAnim"]).set(B.AnimationType.PRODUCTION,["ProductionAnim"]).set(B.AnimationType.SUPER,["SuperAnim","SuperAnimTwo","SuperAnimThree","SuperAnimFour"]).set(B.AnimationType.ACTIVE,["ActiveAnim","ActiveAnimTwo","ActiveAnimThree","ActiveAnimFour"]).set(B.AnimationType.SPECIAL,["SpecialAnim","SpecialAnimTwo","SpecialAnimThree","SpecialAnimFour"]).set(B.AnimationType.FACTORY_DEPLOYING,["DeployingAnim","UnderDoorAnim"]).set(B.AnimationType.FACTORY_ROOF_DEPLOYING,["RoofDeployingAnim","UnderRoofDoorAnim"]).set(B.AnimationType.BUILDUP,["Buildup"]).set(B.AnimationType.UNBUILD,["Buildup"]),S("BuildingAnimArtProps",class{constructor(){this.animsByType=new Map}read(S,O){D.forEach((D,F)=>{let _=[];D.forEach((D,U)=>{var H=S.getString(D);if(H){let U,W,z=new j.BuildingAnimData;if(z.name=H,z.type=F,O.hasObject(H,L.ObjectType.Animation)&&(W=O.getObject(H,L.ObjectType.Animation),U=W.art),F===B.AnimationType.BUILDUP||F===B.AnimationType.UNBUILD)U=U?U.clone():new N.IniSection(H),U.has("Shadow")||U.set("Shadow","yes"),F===B.AnimationType.UNBUILD&&U.set("Reverse","yes");else if(!U)throw new Error(`Missing building anim section "${H}"`);z.art=U,z.pauseWhenUnpowered=S.getBool(D+"Powered",!0),z.showWhenUnpowered=!S.getBool(D+"PoweredLight",!1);var V=S.getString(D+"Damaged");V&&O.hasObject(V,L.ObjectType.Animation)&&(z.damagedArt=O.getObject(V,L.ObjectType.Animation).art),z.offset={x:S.getNumber(D+"X"),y:S.getNumber(D+"Y")};let K=U.getString("Image");K=K||H,z.image=K,z.flat="UnderDoorAnim"===D||"UnderRoofDoorAnim"===D||U.getBool("Flat"),W&&(z.translucent=W.translucent,z.translucency=W.translucency),_.push(z)}}),this.animsByType.set(F,_)})}getByType(S){if(!this.animsByType.has(S))throw new Error(`Animation type "${B.AnimationType[S]}" has no data`);return this.animsByType.get(S)}getAll(){return this.animsByType}})}}}),System.register("engine/renderable/entity/building/BuildingAnimData",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("BuildingAnimData",class{})}}}),System.register("engine/renderable/entity/building/BuildingShpHelper",["engine/AnimProps","engine/ImageFinder","engine/renderable/builder/ShpAggregator"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("BuildingShpHelper",class{constructor(S){this.imageFinder=S}getShpFrameInfos(S,O,N,L){let D=new Map;for(var[F,_]of(O&&D.set(O,j.ShpAggregator.getShpFrameInfo(O,S.hasShadow)),N&&D.set(N,j.ShpAggregator.getShpFrameInfo(N,S.hasShadow)),L))F=new B.AnimProps(F.art,_),F=j.ShpAggregator.getShpFrameInfo(_,F.shadow),D.set(_,F);return D}collectAnimShpFiles(S,O){let B=new Map;return S.getAll().forEach((S,j)=>{for(var L of S){let j;try{j=this.imageFinder.find(L.image,O.useTheaterExtension)}catch(S){if(S instanceof N.ImageFinder.MissingImageError){console.warn(S.message);continue}throw S}B.set(L,j)}}),B}})}}}),System.register("engine/renderable/entity/building/DamageType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("DamageType",B={}))[O.NORMAL=0]="NORMAL",O[O.CONDITION_YELLOW=1]="CONDITION_YELLOW",O[O.CONDITION_RED=2]="CONDITION_RED",O[O.DESTROYED=3]="DESTROYED"}}}),System.register("engine/renderable/entity/building/PsychicDetectPlugin",["engine/renderable/fx/DetectionLineFx"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("PsychicDetectPlugin",class{constructor(S,O,B,N){this.gameObject=S,this.psychicDetectorTrait=O,this.localPlayer=B,this.camera=N,this.lineEffects=new Map}onCreate(S){this.renderableManager=S}update(S){if(this.localPlayer.value===this.gameObject.owner){let S=this.psychicDetectorTrait.detectionLines;var O,N,j,L,D=S!==this.lastDetectionLines;this.lastDetectionLines=S;let W=S.map(S=>({hash:S.source.id+"_"+(S.target.obj?.id??S.target.tile.id),line:S}));if(D){for(let S of this.lineEffects.keys())W.find(({hash:O})=>O===S)||(this.disposeLine(this.lineEffects.get(S)),this.lineEffects.delete(S));for(var{line:F,hash:_}of W)this.lineEffects.has(_)||(O=F.source.position.worldPosition.clone(),N=F.target.getWorldCoords().clone(),F=new THREE.Color(F.source.owner.color.asHex()),F=new B.DetectionLineFx(this.camera,O,N,F,1e6),this.lineEffects.set(_,F),this.renderableManager.addEffect(F))}for({line:j,hash:L}of W){let S=this.lineEffects.get(L);if(!S)throw new Error("Line hash should have been found");var U=j.source.position.worldPosition.clone(),H=j.target.getWorldCoords().clone(),V=new THREE.Color(j.source.owner.color.asHex());S.color.equals(V)||(S.color.copy(V),S.needsUpdate=!0),S.sourcePos.equals(U)||(S.sourcePos.copy(U),S.needsUpdate=!0),S.targetPos.equals(H)||(S.targetPos.copy(H),S.needsUpdate=!0)}}else this.lineEffects.forEach(S=>this.disposeLine(S))}onRemove(){this.renderableManager=void 0,this.dispose()}dispose(){this.lineEffects.forEach(S=>this.disposeLine(S))}disposeLine(S){S.remove(),S.dispose()}})}}}),System.register("engine/renderable/entity/map/MapBounds",["engine/IsoCoords","engine/renderable/WithVisibility","util/disposable/CompositeDisposable"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("MapBounds",class{constructor(S){this.map=S,this.withVisibility=new N.WithVisibility,this.disposables=new j.CompositeDisposable;let t=()=>{this.target&&this.wrapperObj&&(this.target.remove(this.wrapperObj),this.wrapperObj=this.build(),this.target.add(this.wrapperObj))};S.mapBounds.onLocalResize.subscribe(t),this.disposables.add(()=>S.mapBounds.onLocalResize.unsubscribe(t))}build(){var S=this.map.mapBounds.getClampedFullSize(),O=this.map.mapBounds.getLocalSize();let B=this.createBoundRect({x:S.x,y:S.y},{x:S.x+S.width,y:S.y+S.height},16711680);B.matrixAutoUpdate=!1;let N=this.createBoundRect({x:O.x,y:O.y},{x:O.x+O.width,y:O.y+O.height-1},255);N.matrixAutoUpdate=!1;let j=new THREE.Object3D;return j.matrixAutoUpdate=!1,j.add(B),j.add(N),j}createBoundRect(S,O,N){var j=B.IsoCoords.screenTileToWorld(S.x,S.y),L=B.IsoCoords.screenTileToWorld(O.x,O.y),D=B.IsoCoords.screenTileToWorld(O.x,S.y),F=B.IsoCoords.screenTileToWorld(S.x,O.y),_=new THREE.LineBasicMaterial({color:N,transparent:!0,depthTest:!1,depthWrite:!1});let U=new THREE.Geometry;U.vertices.push(new THREE.Vector3(j.x,0,j.y),new THREE.Vector3(F.x,0,F.y),new THREE.Vector3(L.x,0,L.y),new THREE.Vector3(D.x,0,D.y),new THREE.Vector3(j.x,0,j.y)),this.disposables.add(U,_);let H=new THREE.Line(U,_);return H.renderOrder=1e6,H}get3DObject(){return this.target}create3DObject(){if(!this.target){let S=new THREE.Object3D;S.matrixAutoUpdate=!1,S.name="map_bounds",S.visible=this.withVisibility.isVisible(),this.target=S,!this.wrapperObj&&S.visible&&(this.wrapperObj=this.build(),this.target.add(this.wrapperObj))}}update(){}setVisible(S){S!==this.withVisibility.isVisible()&&(this.withVisibility.setVisible(S),this.target&&((this.target.visible=S)?(this.wrapperObj||(this.wrapperObj=this.build()),this.target.add(this.wrapperObj)):this.wrapperObj&&this.target.remove(this.wrapperObj)))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/entity/map/MapGrid",["game/Coords","engine/IsoCoords"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("MapGrid",class{constructor(S){this.size=S,this.build()}build(){var S=this.size,O=B.Coords.getWorldTileSize(),j=N.IsoCoords.screenTileToWorld(0,0),L=N.IsoCoords.screenTileToWorld(S.width,S.height),D=N.IsoCoords.screenTileToWorld(0,S.height);S=N.IsoCoords.screenTileToWorld(S.width,0),j=L.x-j.x,D=D.y-S.y,S=new THREE.PlaneGeometry(j,D,j/O,D/O),O=new THREE.MeshBasicMaterial({color:9474192,wireframe:!0,side:THREE.DoubleSide});let F=new THREE.Mesh(S,O);F.matrixAutoUpdate=!1,F.rotation.x=Math.PI/2,F.updateMatrix();let _=new THREE.Object3D;_.matrixAutoUpdate=!1,_.add(F),_.position.x=j/2,_.position.z=D/2,_.position.y=-1*B.Coords.ISO_WORLD_SCALE,_.updateMatrix(),this.target=_}get3DObject(){return this.target}create3DObject(){}update(){}})}}}),System.register("engine/renderable/entity/map/MapRenderable",["engine/renderable/entity/map/MapTileLayer","engine/renderable/entity/map/MapTileLayerDebug","engine/renderable/entity/map/MapSurface","engine/renderable/entity/map/MapBounds","engine/renderable/entity/map/MapShroudLayer","engine/renderable/builder/ShpAggregator","engine/renderable/entity/map/MapSpriteBatchLayer","game/map/BridgeOverlayTypes"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){S("MapRenderable",class{constructor(S,O,B,N,j,L,D,F,_,U,H,V,W){this.gameObj=S,this.mapShroud=O,this.mapRadiation=B,this.lighting=N,this.theater=j,this.rules=L,this.art=D,this.imageFinder=F,this.camera=_,this.debugWireframe=U,this.gameSpeed=H,this.worldSound=V,this.useSpriteBatching=W,this.lastDebugValue=!1,this.invalidatedRadTiles=new Set,this.radTileLights=new Map,this.handleRadChange=S=>{for(var O of S)this.invalidatedRadTiles.add(O)},this._objects=[],this.init()}get3DObject(){return this.target}getGameObject(){return this.gameObj}init(){var S=this.getGameObject();this.tileLayer=new B.MapTileLayer(S,this.theater,this.art,this.imageFinder,this.camera,this.debugWireframe,this.gameSpeed,this.worldSound,this.lighting,this.useSpriteBatching),this.addObject(this.tileLayer),this.debugLayer=new N.MapTileLayerDebug(S,this.theater,this.camera),this.debugLayer.setVisible(!1),this.addObject(this.debugLayer),this.mapSurface=new j.MapSurface(S,this.theater),this.addObject(this.mapSurface),this.mapBounds=new L.MapBounds(S),this.mapBounds.setVisible(!1),this.mapShroud&&(this.shroudLayer=new D.MapShroudLayer(this.mapShroud,this.imageFinder,this.camera),this.addObject(this.shroudLayer)),this.addObject(this.mapBounds),S=new F.ShpAggregator,this.terrainLayer=new _.MapSpriteBatchLayer("map_terrain_layer",[...this.rules.terrainRules.values()].filter(S=>!S.isAnimated&&this.art.hasObject(S.name,S.type)),()=>!1,this.theater,this.art,this.imageFinder,this.camera,this.lighting,S),this.addObject(this.terrainLayer),this.overlayLayer=new _.MapSpriteBatchLayer("map_overlay_layer",[...this.rules.overlayRules.values()].filter(S=>this.art.hasObject(S.name,S.type)&&!U.BridgeOverlayTypes.isBridge(this.rules.getOverlayId(S.name))),S=>S.rules.wall,this.theater,this.art,this.imageFinder,this.camera,this.lighting,S),this.addObject(this.overlayLayer),this.smudgeLayer=new _.MapSpriteBatchLayer("map_smudge_layer",[...this.rules.smudgeRules.values()].filter(S=>this.art.hasObject(S.name,S.type)),()=>!1,this.theater,this.art,this.imageFinder,this.camera,this.lighting,S),this.addObject(this.smudgeLayer),this.mapRadiation.onChange.subscribe(this.handleRadChange)}setShroud(S){S!==this.mapShroud&&(!S&&this.shroudLayer&&(this.removeObject(this.shroudLayer),this.shroudLayer.dispose(),this.shroudLayer=void 0),this.mapShroud=S,this.mapShroud&&(this.shroudLayer?this.shroudLayer.setShroud(this.mapShroud):(this.shroudLayer=new D.MapShroudLayer(this.mapShroud,this.imageFinder,this.camera),this.addObject(this.shroudLayer))))}addObject(S){this._objects.push(S),this.target&&(S.create3DObject(),this.target.add(S.get3DObject()))}removeObject(S){var O=this._objects.indexOf(S);-1!==O&&(this._objects.splice(O,1),this.target&&S.get3DObject()&&this.target.remove(S.get3DObject()))}create3DObject(){let S=this.get3DObject();if(!S){S=new THREE.Object3D,S.name="map",S.matrixAutoUpdate=!1,this.target=S;for(let O=0,B=this._objects.length;O<B;++O)this._objects[O].create3DObject(),S.add(this._objects[O].get3DObject())}}update(S,O){if(this.create3DObject(),this.debugWireframe.value!==this.lastDebugValue&&(this.lastDebugValue=this.debugWireframe.value,this.debugLayer.setVisible(this.debugWireframe.value),this.mapBounds.setVisible(this.debugWireframe.value)),this._objects.forEach(B=>B.update(S,O)),this.invalidatedRadTiles.size){for(var B of this.invalidatedRadTiles){var N,j=this.mapRadiation.getRadLevel(B);j?(N=Math.min(1,j/this.rules.radiation.radLevelMax),this.radTileLights.has(B)&&this.lighting.removeTileLight(B,this.radTileLights.get(B)),j=this.rules.radiation.radColor,N={intensity:this.rules.radiation.radLightFactor*N,red:j[0]/255*N,green:j[1]/255*N,blue:j[2]/255*N},this.lighting.addTileLight(B,N),this.radTileLights.set(B,N)):(this.lighting.removeTileLight(B,this.radTileLights.get(B)),this.radTileLights.delete(B))}this.lighting.forceUpdate([...this.invalidatedRadTiles]),this.invalidatedRadTiles.clear()}}updateLighting(S){this.tileLayer.updateLighting(S),this.terrainLayer.updateLighting(),this.overlayLayer.updateLighting(),this.smudgeLayer.updateLighting()}dispose(){this.mapRadiation.onChange.unsubscribe(this.handleRadChange),this.tileLayer.dispose(),this.debugLayer.dispose(),this.terrainLayer.dispose(),this.overlayLayer.dispose(),this.smudgeLayer.dispose(),this.shroudLayer?.dispose(),this.mapBounds.dispose(),this.mapSurface.dispose()}})}}}),System.register("engine/renderable/entity/map/MapShroudLayer",["game/Coords","engine/gfx/TextureUtils","engine/gfx/SpriteUtils","util/disposable/CompositeDisposable","engine/renderable/builder/ShpTextureAtlas","data/Palette","util/Color","game/map/MapShroud","engine/gfx/BufferGeometryUtils","engine/gfx/material/PaletteBasicMaterial","engine/Engine"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S}],execute:function(){z=[[1,32],[4,33],[8,34],[2,35],[5,36],[12,37],[10,38],[3,39],[13,40],[14,41],[11,42],[7,43],[9,44],[6,45],[15,46]].reduce((S,O)=>(S[O[0]]=O[1],S),new Array(16).fill(void 0)),K=[[24,16],[34,17],[50,18],[65,19],[97,20],[132,21],[152,22],[196,23],[18,24],[33,25],[68,26],[136,27],[26,28],[35,29],[69,30],[140,31]].reduce((S,O)=>(S[O[0]]=O[1],S),new Array(256).fill(void 0)),$=[0,5,12,13,10,15,14,15,3,7,15,15,11,15,15,15],S("MapShroudLayer",class{constructor(S,O,B){this.shroud=S,this.imageFinder=O,this.camera=B,this.disposables=new L.CompositeDisposable,this.needsIncrementalUpdate=[],this.needsFullUpdate=!1,this.onShroudChange=S=>{"incremental"===S.type?this.needsIncrementalUpdate.push(...S.coords):this.needsFullUpdate=S.type},this.camera=B}get3DObject(){return this.target}create3DObject(){let S=this.get3DObject();S||(S=new THREE.Object3D,S.name="map_shroud_layer",S.matrixAutoUpdate=!1,this.target=S,this.createTileObjects(S),this.shroud.onChange.subscribe(this.onShroudChange),this.disposables.add(()=>this.shroud.onChange.unsubscribe(this.onShroudChange)))}setShroud(S){this.shroud.onChange.unsubscribe(this.onShroudChange),this.shroud=S,this.shroud.onChange.subscribe(this.onShroudChange),this.needsFullUpdate="full"}createTileObjects(S){var O=this.imageFinder.find(W.Engine.shroudFileName.split(".")[0],!1);let B=(new D.ShpTextureAtlas).fromShpFile(O);this.disposables.add(B);let L=new F.Palette,U=[new _.Color(0,0,0),new _.Color(0,0,0)];for(let S=0;S<254;S++){var z=Math.min(255,Math.floor(S/125*255));U.push(new _.Color(z,z,z))}L.setColors(U),O=N.TextureUtils.textureFromPalette(L);let K=[],$=0;var q=this.shroud.getSize();for(let S=0;S<q.height;S++)for(let O=0;O<q.width;O++){var Q={sx:O,sy:S},Z=this.getFrameNo(Q);Z=this.createTileGeometry(Q,B,Z),K.push(Z),$++}O=new V.PaletteBasicMaterial({map:B.getTexture(),palette:O,alphaTest:.01,flatShading:!0,transparent:!0,depthTest:!1,blending:THREE.MultiplyBlending});let Y=H.BufferGeometryUtils.mergeBufferGeometries(K);if(Y.getAttribute("position").count!==j.SpriteUtils.VERTICES_PER_SPRITE*$)throw new Error("Vertex count mismatch");this.uvAttribute=Y.getAttribute("uv"),this.uvElemsPerPiece=this.uvAttribute.count*this.uvAttribute.itemSize/$,this.uvLookup=new Float32Array(47*this.uvElemsPerPiece);for(let S=0;S<47;S++){let O=j.SpriteUtils.createSpriteGeometry(this.getTileGeometryOptions(B,S));this.uvLookup.set(O.getAttribute("uv").array,S*this.uvElemsPerPiece)}K.forEach(S=>S.dispose());let X=new THREE.Mesh(Y,O);X.renderOrder=999999,X.matrixAutoUpdate=!1,X.frustumCulled=!1,S.add(X),this.disposables.add(Y,O)}createTileGeometry(S,O,N){var{rx:L,ry:D}=this.shroud.shroudCoordsToWorld(S),D=B.Coords.tile3dToWorld(L,D,0);let F=j.SpriteUtils.createSpriteGeometry(this.getTileGeometryOptions(O,N));return F.applyMatrix((new THREE.Matrix4).makeTranslation(D.x,D.y,D.z)),F}getTileGeometryOptions(S,O){return{texture:S.getTexture(),textureArea:S.getTextureArea(O),flat:!0,align:{x:0,y:-1},camera:this.camera,scale:B.Coords.ISO_WORLD_SCALE}}update(S){var O;this.needsFullUpdate&&("cover"===this.needsFullUpdate||"clear"===this.needsFullUpdate?this.toggleAllTiles("cover"===this.needsFullUpdate?U.ShroudType.Unexplored:U.ShroudType.Explored):(this.updateAllTiles(),this.needsIncrementalUpdate=[]),this.uvAttribute.needsUpdate=!0,this.needsFullUpdate=!1),this.needsIncrementalUpdate.length&&(O=this.extendToAdjacentTiles(this.needsIncrementalUpdate),this.updateTiles(O),this.uvAttribute.needsUpdate=!0,this.needsIncrementalUpdate.length=0)}extendToAdjacentTiles(S){let O=new Map;var B,N=this.shroud.getSize();for(B of S)for(let S=-1;S<=1;S++)for(let D=-1;D<=1;D++){var j=B.sx+S,L=B.sy+D;0<=j&&0<=L&&j<N.width&&L<N.height&&O.set(j+"_"+L,{sx:j,sy:L})}return[...O.values()]}updateTiles(S){var O,B=this.shroud.getSize();for(O of S){var N=O.sx+O.sy*B.width;this.updateTilePiece(N,this.getFrameNo(O))}}updateAllTiles(){var S=this.shroud.getSize();for(let N=0;N<S.height;N++)for(let j=0;j<S.width;j++){var O={sx:j,sy:N},B=O.sx+O.sy*S.width;this.updateTilePiece(B,this.getFrameNo(O))}}toggleAllTiles(S){var O=S===U.ShroudType.Unexplored?15:0,B=this.uvLookup.subarray(O*this.uvElemsPerPiece,(1+O)*this.uvElemsPerPiece);let N=this.uvAttribute.array;for(let S=0,j=(O=this.shroud.getSize()).width*O.height;S<j;S++)N.set(B,S*this.uvElemsPerPiece)}updateTilePiece(S,O){this.uvAttribute.array.set(this.uvLookup.subarray(O*this.uvElemsPerPiece,(O+1)*this.uvElemsPerPiece),S*this.uvElemsPerPiece)}getFrameNo(S){if(this.shroud.getShroudTypeByShroudCoords(S)===U.ShroudType.Unexplored)return 15;let O=0;this.hasShroudedNeighbour(S,0,-1)&&(O+=1),this.hasShroudedNeighbour(S,1,0)&&(O+=2),this.hasShroudedNeighbour(S,0,1)&&(O+=4),this.hasShroudedNeighbour(S,-1,0)&&(O+=8);let B=0;for(let O=-1;O<=1;O+=2)for(let N=-1;N<=1;N+=2)this.hasShroudedNeighbour(S,O,N)&&(B+=1<<O+1+(N+1>>1));if(0<B)if(0===O)O=z[B];else{var N=B&~$[O];if(0<N){if(void 0===(N=K[N+(O<<4)]))throw new Error(`Missing mapped corner frame number for cornerValue "${B}",edgeFrameNo=`+O);O=N}}return O}hasShroudedNeighbour({sx:S,sy:O},B,N){return this.shroud.getShroudTypeByShroudCoords({sx:S+B,sy:O+N})===U.ShroudType.Unexplored}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/entity/map/MapSpriteBatchLayer",["game/Coords","engine/ImageFinder","engine/renderable/builder/BatchShpBuilder","engine/renderable/builder/ShpAggregator","engine/renderable/MapSpriteTranslation","engine/renderable/ShadowRenderable","util/typeGuard"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){S("MapSpriteBatchLayer",class{constructor(S,O,B,N,j,L,D,F,_){this.label=S,this.spriteUseDepth=B,this.theater=N,this.art=j,this.imageFinder=L,this.camera=D,this.lighting=F,this.shpAggregator=_,this.textureCache=new Map,this.batchShpSpecsByObject=new Map,this.batchShpBuilders=new Map,this.shadowBatchShpBuilders=[],this.batchedObjectRules=new Set(O),this.aggregatedImageData=this.createAggregatedShpFile(`agg_${S}.shp`)}get3DObject(){return this.target}create3DObject(){let S=this.get3DObject();S||(S=new THREE.Object3D,S.name=this.label,S.matrixAutoUpdate=!1,this.target=S)}createAggregatedShpFile(S){var O=[...this.batchedObjectRules.values()].map(S=>{var O=this.art.getObject(S.name,S.type);let B;try{B=this.imageFinder.findByObjectArt(O)}catch(S){if(S instanceof N.ImageFinder.MissingImageError)return;throw S}return L.ShpAggregator.getShpFrameInfo(B,O.hasShadow)}).filter(_.isNotNullOrUndefined);return this.shpAggregator.aggregate(O,S)}update(S){}updateLighting(){this.batchShpSpecsByObject.forEach((S,O)=>{S.main.lightMult?.copy(this.lighting.compute(O.art.lightingType,O.tile))}),[...this.batchShpBuilders.values()].flat().forEach(S=>S.updateLighting())}shouldBeBatched(S){return this.batchedObjectRules.has(S.rules)}getBatchKey(S){return S.art.paletteType+"_"+S.art.customPaletteName}addObject(S){var O=this.getBatchKey(S);let N=this.batchShpBuilders.get(O);N||(N=[],this.batchShpBuilders.set(O,N));let L,D=N.find(S=>!S.isFull());if(!D){if(!this.get3DObject())throw new Error("Not implemented");{var _=this.theater.getPalette(S.art.paletteType,S.art.customPaletteName);let O=new j.BatchShpBuilder(this.aggregatedImageData.file,_,this.camera,this.textureCache,void 0,void 0,void 0,B.Coords.ISO_WORLD_SCALE);N.push(O),this.get3DObject().add(O.build()),D=O}}if(_=this.buildBatchShpSpec(S,this.aggregatedImageData),D.add(_),S.art.hasShadow){let S=this.shadowBatchShpBuilders.find(S=>!S.isFull());if(!S){if(!this.get3DObject())throw new Error("Not implemented");{let O=new j.BatchShpBuilder(this.aggregatedImageData.file,F.ShadowRenderable.getOrCreateShadowPalette(),this.camera,this.textureCache,.5,!0,void 0,B.Coords.ISO_WORLD_SCALE);this.shadowBatchShpBuilders.push(O),this.get3DObject().add(O.build()),S=O}}L=this.buildShadowBatchShpSpec(_,this.aggregatedImageData),S.add(L)}this.batchShpSpecsByObject.set(S,{main:_,shadow:L})}buildBatchShpSpec(S,O){var B=S.getFoundation();let N=new D.MapSpriteTranslation(B.width,B.height),j=S.position.worldPosition.clone(),{spriteOffset:L,anchorPointWorld:F}=N.compute();j.x+=F.x,j.z+=F.y;var _=this.imageFinder.findByObjectArt(S.art);if(void 0===(B=O.imageIndexes.get(_)))throw new Error("SHP file not found in aggregated image data");return{shpFile:_,frameNo:B,depth:this.spriteUseDepth(S),flat:S.art.flat,position:j,offset:L.clone().add(S.art.getDrawOffset()),lightMult:this.lighting.compute(S.art.lightingType,S.tile)}}buildShadowBatchShpSpec(S,O){var B=O.imageIndexes.get(S.shpFile);if(void 0===B)throw new Error("SHP file not found in aggregated image data");return{...S,position:S.position.clone().add(new THREE.Vector3(0,.1,0)),flat:!0,frameNo:B+O.file.numImages/2,lightMult:void 0}}removeObject(S){const O=this.batchShpSpecsByObject.get(S);if(O){var B=this.getBatchKey(S);let N=this.batchShpBuilders.get(B),j=N?.find(S=>S.has(O.main));if(j){if(j.remove(O.main),j.isEmpty()&&1<N.length&&(this.get3DObject()?.remove(j.build()),j.dispose(),N?.splice(N.indexOf(j),1)),O.shadow){let S=this.shadowBatchShpBuilders.find(S=>S.has(O.shadow));S?.remove(O.shadow),S?.isEmpty()&&1<this.shadowBatchShpBuilders.length&&(this.get3DObject()?.remove(S.build()),S.dispose(),this.shadowBatchShpBuilders.splice(this.shadowBatchShpBuilders.indexOf(S),1))}this.batchShpSpecsByObject.delete(S)}}}hasObject(S){return this.batchShpSpecsByObject.has(S)}getObjectFrameCount(S){var O=this.batchShpSpecsByObject.get(S);if(!O)throw new Error(`Batch SHP spec for object "${S.name}" not found`);return O.main.shpFile.numImages*(O.shadow?.5:1)}setObjectFrame(S,O){const B=this.batchShpSpecsByObject.get(S);if(!B)throw new Error(`Batch SHP spec for object "${S.name}" not found`);if(!(O>=B.main.shpFile.numImages*(B.shadow?.5:1))){var N=this.aggregatedImageData.imageIndexes.get(B.main.shpFile);B.main.frameNo=N+O,B.shadow&&(B.shadow.frameNo=B.main.frameNo+this.aggregatedImageData.file.numImages/2),N=this.getBatchKey(S);let j=this.batchShpBuilders.get(N)?.find(S=>S.has(B.main));if(j?.update(B.main),B.shadow){let S=this.shadowBatchShpBuilders.find(S=>S.has(B.shadow));S?.update(B.shadow)}}}dispose(){[...this.batchShpBuilders.values(),...this.shadowBatchShpBuilders].flat().forEach(S=>S.dispose()),[...this.textureCache.values()].forEach(S=>S.dispose()),this.textureCache.clear()}})}}}),System.register("engine/renderable/entity/map/MapSurface",["game/Coords","game/theater/rampHeights","engine/gfx/BufferGeometryUtils","util/disposable/CompositeDisposable"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("MAGIC_OFFSET",.05),S("MapSurface",class{constructor(S,O){this.visible=!0,this.disposables=new L.CompositeDisposable,this.map=S,this.theater=O}get3DObject(){return this.target}create3DObject(){let S=this.get3DObject();S||(S=this.createObject(),S.name="map_surface_shadow",S.matrixAutoUpdate=!1,S.visible=this.visible,this.target=S)}update(){}setVisible(S){this.visible=S,this.target&&(this.target.visible=S)}createObject(){let S=[];this.map.tiles.forEach(O=>{var N=B.Coords.tile3dToWorld(O.rx,O.ry,O.z);let j=this.createRectGeometry(O.rampType);j.applyMatrix((new THREE.Matrix4).makeTranslation(N.x,N.y+.05,N.z)),S.push(j)});var O=j.BufferGeometryUtils.mergeBufferGeometries(S);let N=new THREE.ShadowMaterial;N.transparent=!0,N.opacity=.5;let L=new THREE.Mesh(O,N);return L.receiveShadow=!0,L.renderOrder=5,L.frustumCulled=!1,this.disposables.add(O,N),L}createRectGeometry(S){var O=B.Coords.getWorldTileSize(),j=N.rampHeights[S];let L=new THREE.BufferGeometry;return O=new Float32Array([0,B.Coords.tileHeightToWorld(j[0]),O,O,B.Coords.tileHeightToWorld(j[3]),O,0,B.Coords.tileHeightToWorld(j[1]),0,O,B.Coords.tileHeightToWorld(j[2]),0]),j=new Uint16Array([0,1,2,3,2,1]),L.addAttribute("position",new THREE.BufferAttribute(O,3)),L.setIndex(new THREE.BufferAttribute(j,1)),L}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/entity/map/MapTileLayer",["game/Coords","engine/gfx/TextureUtils","engine/gfx/drawable/TmpDrawable","engine/gfx/TextureAtlas","engine/gfx/SpriteUtils","engine/renderable/entity/Anim","engine/type/LightingType","util/disposable/CompositeDisposable","engine/gfx/BufferGeometryUtils","engine/gfx/material/PaletteBasicMaterial","util/math"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S}],execute:function(){S("MapTileLayer",class{constructor(S,O,B,N,j,L,D,F,_,H){this.theater=O,this.art=B,this.imageFinder=N,this.camera=j,this.debugFrame=L,this.gameSpeed=D,this.worldSound=F,this.lighting=_,this.useSpriteBatching=H,this.tileIndexes=new Map,this.tileAnimLightMultsByTile=new Map,this.disposables=new U.CompositeDisposable,this.theater=O,this.camera=j,this.allTiles=S.tiles.getAll()}get3DObject(){return this.target}create3DObject(){let S=this.get3DObject();S||(S=new THREE.Object3D,S.name="map_tile_layer",S.matrixAutoUpdate=!1,this.target=S,this.createTileObjects(S))}createTileObjects(S){let O=new Map,U=new Map;var z,K=this.theater.isoPalette,$=N.TextureUtils.textureFromPalette(K);let q=this.theater.tileSets;for(z of this.allTiles){var Q=z.tileNum;let S=q.getTile(Q);if(!S)return;var Z=S.getTmpFile(z.subTile,W.getRandomInt);if(!Z||z.subTile>=Z.images.length)return;var Y=Z.images[z.subTile];U.set(z,Y),(Q=O.get(Y))||(Q=(new j.TmpDrawable).draw(Y,Z.blockWidth,Z.blockHeight),O.set(Y,Q))}let X=new L.TextureAtlas,J=[];O.forEach(S=>{J.push(S)}),X.pack(J),this.disposables.add(X);let ee=[],te=[];for(let S=0,N=this.allTiles.length;S<N;S++){var ie,re=this.allTiles[S];if(!(ie=U.get(re)))throw new Error(`Missing tmp image for tile rx,ry=${re.rx},`+re.ry);let N=0,j=0;ie.hasExtraData&&(N+=Math.max(0,ie.x-ie.extraX),j+=Math.max(0,ie.y-ie.extraY));var se=B.Coords.tile3dToWorld(re.rx,re.ry,re.z),ne=O.get(ie);let L=D.SpriteUtils.createSpriteGeometry({texture:X.getTexture(),textureArea:X.getImageRect(ne),align:{x:0,y:-1},offset:{x:-N,y:-j},camera:this.camera,scale:B.Coords.ISO_WORLD_SCALE});L.applyMatrix((new THREE.Matrix4).makeTranslation(se.x,se.y,se.z)),ee.push(L);var{x:ie,y:ne,z:se}=this.lighting.compute(_.LightingType.Full,re);te.push(ie,ne,se),this.tileIndexes.set(re,S)}var ae=new V.PaletteBasicMaterial({map:X.getTexture(),palette:$,alphaTest:.5,flatShading:!0,useVertexColorMult:!0});let oe=H.BufferGeometryUtils.mergeBufferGeometries(ee);if(($=oe.getAttribute("position").count)!==D.SpriteUtils.VERTICES_PER_SPRITE*te.length/3)throw new Error("Vertex count mismatch");var le;$=new Float32Array(4*$),this.updateColorMultBuffer(te,$),$=new THREE.BufferAttribute($,4),oe.addAttribute("vertexColorMult",$),this.colorMultAttribute=$,ee.forEach(S=>S.dispose());let ce=new THREE.Mesh(oe,ae);ce.matrixAutoUpdate=!1,ce.frustumCulled=!1,S.add(ce),this.disposables.add(oe,ae);let he=[];for(le of this.allTiles){var ue=le.tileNum;let O=q.getTile(ue);if(!O)return;var de=O.getAnimation();if(de&&le.subTile===de.subTile){ue=this.lighting.compute(_.LightingType.Full,le).addScalar(-1),this.tileAnimLightMultsByTile.set(le,ue);let O=new F.Anim(de.name,this.art.getAnimation(de.name),{x:de.offsetX,y:de.offsetY+(B.Coords.ISO_TILE_SIZE+1)/2},this.imageFinder,this.theater,this.camera,this.debugFrame,this.gameSpeed,this.useSpriteBatching,ue,this.worldSound,K);ue=B.Coords.tile3dToWorld(le.rx,le.ry,le.z),O.setPosition(ue),O.create3DObject(),he.push(O),S.add(O.get3DObject()),this.disposables.add(O)}}this.anims=he}update(S){for(var O of this.anims)O.update(S)}updateLighting(S){if(S){for(var O of S){var B,N,j,L=this.tileIndexes.get(O);void 0!==L&&(({x:B,y:N,z:j}=this.lighting.compute(_.LightingType.Full,O)),this.updateColorMultBufferAtIndex(L,B,N,j,this.colorMultAttribute.array)),this.tileAnimLightMultsByTile.get(O)?.copy(this.lighting.compute(_.LightingType.Full,O))}this.colorMultAttribute.needsUpdate=!0}else{let S=[];for(var D of this.allTiles){var{x:F,y:U,z:D}=this.lighting.compute(_.LightingType.Full,D);S.push(F,U,D)}this.updateColorMultBuffer(S,this.colorMultAttribute.array),this.colorMultAttribute.needsUpdate=!0,this.tileAnimLightMultsByTile.forEach((S,O)=>{S.copy(this.lighting.compute(_.LightingType.Full,O))})}}updateColorMultBuffer(S,O){var B=D.SpriteUtils.VERTICES_PER_SPRITE,N=S.length/3;let j=0;for(let D=0;D<N;D++){var L=S[3*D],F=S[3*D+1],_=S[3*D+2];for(let S=0;S<B;S++)O[j++]=L,O[j++]=F,O[j++]=_,O[j++]=1}}updateColorMultBufferAtIndex(S,O,B,N,j){var L=D.SpriteUtils.VERTICES_PER_SPRITE;let F=S*L*4;for(let S=0;S<L;S++)j[F++]=O,j[F++]=B,j[F++]=N,j[F++]=1}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/entity/map/MapTileLayerDebug",["game/Coords","game/theater/rampHeights","engine/gfx/SpriteUtils","game/type/SpeedType","util/disposable/CompositeDisposable","engine/gfx/BufferGeometryUtils","engine/IsoCoords"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){S("MapTileLayerDebug",class e{constructor(S,O,B){this._textureTilesNo=20,this.visible=!0,this.needsLinesUpdate=!1,this.disposables=new D.CompositeDisposable,this.handleTileOccupationChanged=()=>this.needsLinesUpdate=!0,this.map=S,this.theater=O,this.camera=B}get3DObject(){return this.target}create3DObject(){let S=this.get3DObject();if(!S){if(S=new THREE.Object3D,S.name="map_tile_layer_debug",S.visible=this.visible,S.matrixAutoUpdate=!1,this.visible){if(!this.tileOverlay){let O=this.tileOverlay=this.createTileOverlay();O.matrixAutoUpdate=!1,O.frustumCulled=!1,S.add(O)}this.setupLines(S)}this.target=S}}update(){this.needsLinesUpdate&&this.visible&&(this.needsLinesUpdate=!1,this.destroyLines(),this.setupLines(this.target))}setVisible(S){if(S!==this.visible&&(this.visible=S,this.target))if(this.target.visible=S,this.visible){if(!this.tileOverlay){let S=this.tileOverlay=this.createTileOverlay();S.matrixAutoUpdate=!1,this.target.add(S)}this.setupLines(this.target)}else this.destroyLines()}setupLines(S){this.lines=new THREE.Object3D,this.lines.matrixAutoUpdate=!1,this.lines.add(this.createConnectivityLines(L.SpeedType.Foot,!1,65280));let O=this.createConnectivityLines(L.SpeedType.Float,!1,255);O.position.y=1,O.updateMatrix(),this.lines.add(O),S.add(this.lines),this.map.tileOccupation.onChange.subscribe(this.handleTileOccupationChanged)}destroyLines(){this.lines&&(this.target.remove(this.lines),this.lines=void 0,this.map.tileOccupation.onChange.unsubscribe(this.handleTileOccupationChanged))}createTileOverlay(){let S=[];this.map.tiles.forEach(O=>{var N=B.Coords.tile3dToWorld(O.rx,O.ry,O.z+1),L=_.IsoCoords.getScreenTileSize();let D=j.SpriteUtils.createSpriteGeometry({texture:this.getTileTexture(),textureArea:{x:O.z*L.width,y:2*O.rampType*L.height,width:L.width,height:2*L.height},align:{x:0,y:-1},camera:this.camera,scale:B.Coords.ISO_WORLD_SCALE});D.applyMatrix((new THREE.Matrix4).makeTranslation(N.x,N.y,N.z)),S.push(D)});var O=F.BufferGeometryUtils.mergeBufferGeometries(S),N=new THREE.MeshBasicMaterial({map:this.getTileTexture(),alphaTest:.5,transparent:!0,opacity:.7,flatShading:!0});return this.disposables.add(O,N),new THREE.Mesh(O,N)}getTileTexture(){let S=e.textureCache;if(!S){var O=_.IsoCoords.getScreenTileSize(),j=this._textureTilesNo;let V=document.createElement("canvas"),W=V.getContext("2d");if(!W)throw new Error("Could not acquire canvas 2d context");V.width=O.width*j,V.height=2*O.height*N.rampHeights.length;let z=_.IsoCoords.tileToScreen(0,0);z.x+=-O.width/2;var L=B.Coords.ISO_TILE_SIZE/2;for(let S=0;S<j;++S)for(let B=0;B<N.rampHeights.length;++B){var D=N.rampHeights[B],F=[[0,1],[0,0],[1,0],[1,1]];let j=16711680-(S<<11)-(S<<7);W.beginPath();var U=_.IsoCoords.tileToScreen.apply(this,F[0]);W.moveTo(-z.x+U.x+S*O.width,-z.y+U.y+(1-D[0])*L+2*B*O.height);for(let N=1;N<F.length;++N){var H=_.IsoCoords.tileToScreen.apply(this,F[N]);W.lineTo(-z.x+H.x+S*O.width,-z.y+H.y+(1-D[N])*L+2*B*O.height)}W.closePath(),W.lineWidth=1,W.fillStyle="#"+j.toString(16),W.fill(),W.strokeStyle="#"+(16777215-j).toString(16),W.stroke()}S=new THREE.Texture(V),S.minFilter=THREE.NearestFilter,S.magFilter=THREE.NearestFilter,S.needsUpdate=!0,e.textureCache=S}return S}createConnectivityLines(S,O,N){let j=this.map.terrain.computePassabilityGraph(S,O),L=new THREE.Geometry,D=new Set;j.forEachNode(S=>{let O=S;S.neighbors.forEach(S=>{var N=S,j=O.id+"->"+N.id;D.has(j)||(D.add(j),L.vertices.push(B.Coords.tile3dToWorld(O.data.tile.rx+.5,O.data.tile.ry+.5,O.data.tile.z+(O.data.onBridge?.tileElevation??0)),B.Coords.tile3dToWorld(N.data.tile.rx+.5,N.data.tile.ry+.5,N.data.tile.z+(N.data.onBridge?.tileElevation??0))))})});var F=new THREE.LineBasicMaterial({color:N,transparent:!0,depthTest:!1,depthWrite:!1});let _=new THREE.LineSegments(L,F);return _.matrixAutoUpdate=!1,this.disposables.add(L,F),_}onRemove(){this.lines&&this.destroyLines()}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/entity/map/MinimapModel",["game/map/MapShroud"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=new THREE.Color("rgb(173, 170, 132)"),j=new Map([["CAKRMW",new THREE.Color("rgb(107, 69, 49)")],["CAFNCW",new THREE.Color(16777215)],["CAFNCB",new THREE.Color(0)],["GASAND",new THREE.Color("rgb(82, 77, 57)")]]),L=new THREE.Color("rgb(90, 89, 82)"),D=new THREE.Color(0),F=new THREE.Color("rgb(173, 170, 132)"),_=new THREE.Color(0),S("MinimapModel",class{constructor(S,O,B,N,j,L){this.tiles=S,this.tileOccupation=O,this.shroud=B,this.localPlayer=N,this.alliances=j,this.paradropRules=L;var D=this.tiles.getMapSize();this.stride=D.width,this.tileColors=new Uint32Array(D.width*D.height),this.aboveShroudTiles=new Uint8Array(D.width*D.height),this.tileWithTechnos=new Uint8Array(D.width*D.height)}computeAllColors(){this.updateColors(this.tiles.getAll())}updateColors(S){for(var O of S){let S,H,V=-1;for(var B of this.tileOccupation.getObjectsOnTile(O)){var U;!((B.isTechno()||B.isOverlay()||B.isTerrain())&&!B.radarInvisible||B.isOverlay()&&B.isBridge()||B.isBuilding()&&!B.rules.invisibleInGame&&(!B.radarInvisible||B.rules.canBeOccupied&&B.owner.isCombatant()))||(U=4*Number(B.isTechno())+2*Number(B.isAircraft())+Number(B.name!==this.paradropRules.paradropPlane))>V&&(V=U,S=B)}if(S)if((S.isTechno()||S.isOverlay())&&S.rules.wall)H=j.get(S.name)??L;else if(S.isBuilding()&&S.isDestroyed&&S.rules.leaveRubble)H=D;else if(S.isTechno())if(S.cloakableTrait?.isCloaked()&&this.localPlayer&&!this.alliances.haveSharedIntel(this.localPlayer,S.owner))H=void 0;else{let O=(S.isInfantry()||S.isVehicle())&&S.disguiseTrait?.getDisguise();H=this.localPlayer&&O&&!this.alliances.haveSharedIntel(this.localPlayer,S.owner)&&!this.localPlayer.sharedDetectDisguiseTrait?.has(S)?O.owner?new THREE.Color(O.owner.color.asHex()):N:new THREE.Color(S.owner.color.asHex())}else if(S.isTerrain())H=N;else{if(!S.isOverlay())return;H=S.isTiberium()?F:_}H=H||this.tiles.getTileRadarColor(O),O=O.rx+O.ry*this.stride,this.tileColors[O]=H.getHex(),this.aboveShroudTiles[O]=S?.name===this.paradropRules.paradropPlane?1:0,this.tileWithTechnos[O]=S?.isTechno()?1:0}}getTileColor(S){var O=S.rx+S.ry*this.stride;if(this.shroud?.getShroudType(S)===B.ShroudType.Unexplored&&!this.aboveShroudTiles[O])return"#000000";let N=new THREE.Color(this.tileColors[O]);return this.shroud?.isFlagged(S,B.ShroudFlag.Darken)&&!this.tileWithTechnos[O]&&N.multiplyScalar(.35),"#"+N.getHexString()}})}}}),System.register("engine/renderable/entity/map/MinimapRenderer",["game/Coords"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("MinimapRenderer",class{constructor(S,O,B,N,j){this.map=S,this.minimapModel=O,this.borderColor=N,this.canvasRenderScale=j;var L=this.map.mapBounds.getRawLocalSize();this.dxySize={x:2*L.x,y:2*L.y+4,width:2*L.width,height:2*L.height+8},L=this.dxySize.height/this.dxySize.width,this.canvasSize=this.computeCanvasSize(B,L)}computeCanvasSize(S,O){var B=S.width,N=S.height;let j;return j=N/B<=O?{width:Math.floor(N/O),height:N}:{width:B,height:Math.floor(B*O)},j}renderFull(){if(this.canvas)this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvasRenderScale*this.canvasSize.width,this.canvasRenderScale*this.canvasSize.height);else{let S=this.canvas=document.createElement("canvas");S.width=this.canvasRenderScale*this.canvasSize.width,S.height=this.canvasRenderScale*this.canvasSize.height,(this.ctx=S.getContext("2d",{alpha:!1})).translate(.5,.5)}return this.renderTiles(this.map.tiles.getAll(),!0),this.canvas}renderIncremental(S){let O=new Set(S);for(var B of S)this.map.tiles.getAllNeighbourTiles(B).forEach(S=>O.add(S));this.renderTiles(O)}renderTiles(S,O=!1){var N,j=this.canvasSize.width/this.dxySize.width/B.Coords.COS_ISO_CAMERA_BETA;const L=this.ctx;if(!L)throw new Error("Must do a full render before re-rendering any individual tiles.");for(N of(L.imageSmoothingEnabled=!1,L.save(),L.rotate(B.Coords.ISO_CAMERA_BETA),L.scale(j,j),S)){var D,F=this.minimapModel.getTileColor(N);!F||O&&"#000000"===F||(L.fillStyle=F,({x:D,y:F}=this.tileToLocalRxyOrigin(N)),L.fillRect(this.canvasRenderScale*D,this.canvasRenderScale*F,this.canvasRenderScale+.5,this.canvasRenderScale+.5))}L.restore(),L.strokeStyle=this.borderColor,L.lineWidth=this.canvasRenderScale,L.strokeRect(0,0,L.canvas.width-this.canvasRenderScale,L.canvas.height-this.canvasRenderScale)}tileToLocalRxyOrigin(S){var O=this.dxyToLocalRxy(this.dxySize.x,this.dxySize.y);return{x:S.rx-O.x,y:S.ry-this.map.mapBounds.getFullSize().width/2-O.y}}dxyToLocalRxy(S,O){return{x:(S+O)/2,y:(O-S)/2}}dxyToCanvas(S,O){var B=this.canvasSize.width/this.dxySize.width;return{x:(S-this.dxySize.x)*B,y:(O-this.dxySize.y)*B}}canvasToDxy(S,O){var B=this.canvasSize.width/this.dxySize.width;return{x:S/B+this.dxySize.x,y:O/B+this.dxySize.y}}})}}}),System.register("engine/renderable/entity/plugin/ChronoSparkleFxPlugin",["game/Coords"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ChronoSparkleFxPlugin",class{constructor(S,O){this.gameObject=S,this.sparkleAnimName=O,this.objMoveTrait=S.isUnit()?S.moveTrait:void 0}onCreate(S){this.renderableManager=S}update(){if(!this.gameObject.isDestroyed&&!this.gameObject.isCrashing&&this.renderableManager){var S=this.objMoveTrait?.lastTeleportTick,O=S!==this.lastTeleport;let N=this.gameObject.warpedOutTrait.isActive();(N!==this.lastWarpedOut||O)&&(this.lastTeleport=S,(this.lastWarpedOut=N)||O?(this.chronoSparkleAnim?.endAnimationLoop(),this.chronoSparkleAnim=this.renderableManager.createTransientAnim(this.sparkleAnimName,S=>{S.extraOffset={x:0,y:B.Coords.ISO_TILE_SIZE/2},S.setPosition(this.gameObject.position.worldPosition.clone()),S.create3DObject(),S.getAnimProps().loopCount=N?-1:1})):N||this.chronoSparkleAnim?.endAnimationLoop())}}onRemove(){this.renderableManager=void 0,this.chronoSparkleAnim?.endAnimationLoop()}dispose(){}})}}}),System.register("engine/renderable/entity/plugin/DamageSmokePlugin",["engine/renderable/fx/DamageSmokeFx"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("DamageSmokePlugin",class{constructor(S,O,B,N,j){this.gameObject=S,this.art=O,this.theater=B,this.imageFinder=N,this.gameSpeed=j}onCreate(S){this.renderableManager=S}update(S){var O,N,j;this.renderableManager&&((j=this.gameObject.healthTrait.health<50)===this.lastDamaged||this.gameObject.isDestroyed||((this.lastDamaged=j)?this.smokeFx||(this.smokeStartTime=S,(O=this.art.getAnimation("SGRYSMK1"))&&(N=this.imageFinder.findByObjectArt(O),j=this.theater.getPalette(O.paletteType),this.smokeFx=new B.DamageSmokeFx(this.gameObject,O,N,j,this.gameSpeed),this.renderableManager.addEffect(this.smokeFx))):this.disposeSmokeFx()),this.smokeFx&&this.smokeStartTime&&S-this.smokeStartTime>=8e4/this.gameSpeed.value&&this.disposeSmokeFx())}disposeSmokeFx(){this.smokeFx&&(this.smokeFx.finishAndRemove(),this.smokeFx=void 0)}onRemove(S){this.renderableManager=void 0,this.disposeSmokeFx()}dispose(){this.disposeSmokeFx()}})}}}),System.register("engine/renderable/entity/plugin/HarvesterPlugin",["game/gameobject/trait/HarvesterTrait","game/Coords"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("HarvesterPlugin",class{constructor(S,O){this.gameObject=S,this.harvesterTrait=O}onCreate(S){this.renderableManager=S}update(S){if(this.gameObject.warpedOutTrait.isActive())return this.disposeHarvAnim(),void(this.lastHarvesterStatus=void 0);var O;!this.renderableManager||(O=this.harvesterTrait.status)!==this.lastHarvesterStatus&&(this.lastHarvesterStatus=O,this.disposeHarvAnim(),O===B.HarvesterStatus.Harvesting&&(this.harvestAnim=this.renderableManager.createTransientAnim("OREGATH",S=>{var O=this.gameObject.tile;S.setPosition(N.Coords.tile3dToWorld(O.rx+.5,O.ry+.5,O.z)),S.create3DObject();let B=S.getAnimProps();var j=Math.floor(S.getShpFile().numImages/8);O=(this.gameObject.direction-45+360)%360,O=Math.round(O/360*8)%8*j,B.loopStart=B.start=O,B.loopEnd=O+j-1,B.loopCount=-1})))}disposeHarvAnim(){this.harvestAnim?.remove(),this.harvestAnim?.dispose(),this.harvestAnim=void 0}onRemove(){this.disposeHarvAnim()}dispose(){this.disposeHarvAnim()}})}}}),System.register("engine/renderable/entity/plugin/InfantryDisguisePlugin",["engine/type/ObjectType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("InfantryDisguisePlugin",class{constructor(S,O,B,N,j,L,D){this.gameObject=S,this.disguiseTrait=O,this.localPlayer=B,this.alliances=N,this.renderable=j,this.art=L,this.gameSpeed=D,this.canSeeThroughDisguise=!1}onCreate(){}update(S){if(!this.gameObject.isDestroyed&&!this.gameObject.warpedOutTrait.isActive()){let N=this.disguiseTrait.getDisguise();var O;N!==this.lastDisguise&&(this.lastDisguise=N,this.disguisedAt=N?S:void 0);let j=this.localPlayer.value;N&&(this.canSeeThroughDisguise=!j||this.alliances.haveSharedIntel(j,this.gameObject.owner)||!!j.sharedDetectDisguiseTrait?.has(this.gameObject)),N&&this.canSeeThroughDisguise&&(N=j?.sharedDetectDisguiseTrait?.has(this.gameObject)?void 0:Math.floor((S-this.disguisedAt)*this.gameSpeed.value/1e3)%16<=3?N:void 0),this.lastRenderDisguise!==N&&(this.lastRenderDisguise=N,N?(O=this.art.getObject(N.rules.name,B.ObjectType.Infantry),this.renderable.setDisguise({objectArt:O,owner:N.owner})):this.renderable.setDisguise(void 0))}}onRemove(){}getUiNameOverride(){var S=this.gameObject.disguiseTrait?.getDisguise();if(S&&!this.canSeeThroughDisguise)return S.rules.uiName}dispose(){}})}}}),System.register("engine/renderable/entity/plugin/MindControlLinkPlugin",["engine/renderable/fx/MindControlLinkFx"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("MindControlLinkPlugin",class{constructor(S,O,B,N){this.source=S,this.selectionModel=O,this.alliances=B,this.viewer=N,this.links=new Map}onCreate(S){this.renderableManager=S}update(){if(!this.source.isDestroyed&&!this.source.isCrashing&&this.source.mindControllerTrait)if(!this.selectionModel.isSelected()||this.viewer.value&&!this.alliances.haveSharedIntel(this.source.owner,this.viewer.value))this.disposeLinks();else{let F=this.source.mindControllerTrait.getTargets();for(var[S,O]of this.links.entries())F.includes(S)||(O.removeAndDispose(),this.links.delete(S));var N,j=new THREE.Color(this.source.owner.color.asHex()),L=this.source.position.worldPosition.clone();for(N of F){var D=N.position.worldPosition.clone();let S=this.links.get(N);S||(S=new B.MindControlLinkFx(L,D,j,2),this.links.set(N,S),this.renderableManager?.addEffect(S)),S.updateEndpoints(L,D)}}}onRemove(){this.renderableManager=void 0,this.disposeLinks()}dispose(){this.disposeLinks()}disposeLinks(){this.links.forEach(S=>S.removeAndDispose()),this.links.clear()}})}}}),System.register("engine/renderable/entity/plugin/MoveSoundFxPlugin",["game/gameobject/unit/ZoneType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("MoveSoundFxPlugin",class{constructor(S,O,B){this.gameObject=S,this.moveSound=O,this.worldSound=B,this.lastMovingOrRotating=!1}onCreate(){}update(){var S;this.gameObject.isDestroyed||this.gameObject.isCrashing||(S=!this.gameObject.warpedOutTrait.isActive()&&!!(!this.gameObject.rules.balloonHover&&this.gameObject.rules.hoverAttack&&this.gameObject.zone===B.ZoneType.Air||this.gameObject.spinVelocity||!this.gameObject.moveTrait.isIdle()&&!this.gameObject.moveTrait.isWaiting()))!==this.lastMovingOrRotating&&((this.lastMovingOrRotating=S)?this.soundHandle&&this.soundHandle.isPlaying()||(this.soundHandle=this.worldSound.playEffect(this.moveSound,this.gameObject,this.gameObject.owner,.35)):this.soundHandle?.isLoop&&(this.soundHandle.stop(),this.soundHandle=void 0))}onRemove(){this.soundHandle?.stop()}dispose(){this.soundHandle?.stop()}})}}}),System.register("engine/renderable/entity/plugin/ObjectCloakPlugin",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("ObjectCloakPlugin",class{constructor(S,O,B,N){this.gameObject=S,this.localPlayer=O,this.alliances=B,this.renderable=N,this.lastCanSeeThroughCloak=!1}onCreate(){}update(S){var O=!!this.gameObject.cloakableTrait?.isCloaked()&&!this.gameObject.isDestroyed,B=O!==this.lastCloaked,N=O&&(!this.localPlayer.value||this.alliances.haveSharedIntel(this.localPlayer.value,this.gameObject.owner)),j=N!==this.lastCanSeeThroughCloak;(B||j)&&(this.lastCloaked=O,this.lastCanSeeThroughCloak=N,this.renderable.get3DObject().visible=!O||N)}onRemove(){}dispose(){}})}}}),System.register("engine/renderable/entity/plugin/ShipWakeTrailPlugin",["game/Coords","engine/renderable/fx/TrailerSmokeFx","game/gameobject/unit/ZoneType","game/type/LandType","game/type/LocomotorType"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){S("ShipWakeTrailPlugin",class{constructor(S,O,B,N,j,L){this.gameObject=S,this.rules=O,this.art=B,this.theater=N,this.imageFinder=j,this.gameSpeed=L,this.trailPos=new THREE.Vector3}onCreate(S){this.renderableManager=S}update(S){var O,F,_,U,H,V;this.renderableManager&&(this.trailPos.copy(this.gameObject.position.worldPosition),this.trailPos.y=B.Coords.tileHeightToWorld(this.gameObject.tile.z),this.gameObject.rules.locomotor===D.LocomotorType.Hover&&(_=this.rules.general.hover.height,this.trailPos.x-=_,this.trailPos.z-=_),O=(U=this.gameObject.moveTrait.isMoving())!==this.lastMoving,F=(H=this.gameObject.submergibleTrait?.isSubmerged())!==this.lastSubmerged,_=(V=this.gameObject.zone===j.ZoneType.Water&&this.gameObject.tile.landType===L.LandType.Water)!==this.lastInWater,(O||F||_)&&(this.lastMoving=U,this.lastSubmerged=H,this.lastInWater=V,U&&!H&&V?this.trailerFx?this.trailerFx.enable():(_=this.art.getAnimation(this.rules.audioVisual.wake))&&(U=this.imageFinder.findByObjectArt(_),H=this.theater.getPalette(_.paletteType),V=this.gameObject.art.spawnDelay,this.trailerFx=new N.TrailerSmokeFx(this.trailPos,V,_,U,H,this.gameSpeed),this.renderableManager.addEffect(this.trailerFx)):this.trailerFx?.disable()))}onRemove(S){this.renderableManager=void 0,this.trailerFx?.finishAndRemove()}dispose(){this.trailerFx?.finishAndRemove()}})}}}),System.register("engine/renderable/entity/plugin/TntFxPlugin",["engine/type/ObjectType","engine/sound/SoundKey"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("TntFxPlugin",class{constructor(S,O,B,N,j,L,D,F,_,U){this.gameObject=S,this.tntChargeTrait=O,this.frameDurationTicks=B,this.renderable=N,this.imageFinder=j,this.art=L,this.alliances=D,this.viewer=F,this.worldSound=_,this.animFactory=U,this.lastHasCharge=!1}onCreate(){this.animStepCount=Math.floor(this.imageFinder.findByObjectArt(this.art.getObject("BOMBCURS",B.ObjectType.Animation)).numImages/2)}update(S){if(this.gameObject.isDestroyed||this.gameObject.isCrashing)this.gameObject.rules.leaveRubble&&(this.disposeBombAnim(),this.soundHandle?.stop());else{var O=this.tntChargeTrait.hasCharge(),B=O!==this.lastHasCharge;let L;L=O?(j=1-this.tntChargeTrait.getTicksLeft()/this.tntChargeTrait.getInitialTicks(),Math.floor(2*j*(this.animStepCount-1))):0;var j=L!==this.lastStartFrame;if(this.bombAnim?.update(S),B||j)if(this.lastHasCharge=O,this.lastStartFrame=L,O){if(B&&(this.soundHandle?.stop(),this.soundHandle=this.worldSound?.playEffect(N.SoundKey.BombTickingSound,this.gameObject)),this.disposeBombAnim(),B=this.gameObject.tntChargeTrait.getChargeOwner(),!this.viewer.value||this.alliances.haveSharedIntel(B,this.viewer.value)){let S=this.bombAnim=this.animFactory("BOMBCURS");S.setRenderOrder(999995),S.create3DObject();let O=S.getAnimProps();O.loopCount=-1,O.start=O.loopStart=L,O.end=L+2-1,O.loopEnd=O.end,O.rate/=this.frameDurationTicks,this.renderable.get3DObject()?.add(S.get3DObject())}}else this.disposeBombAnim(),this.soundHandle?.stop()}}disposeBombAnim(){this.bombAnim?.get3DObject()&&this.renderable.get3DObject()?.remove(this.bombAnim.get3DObject()),this.bombAnim?.dispose()}onRemove(){this.disposeBombAnim(),this.soundHandle?.stop()}dispose(){this.disposeBombAnim(),this.soundHandle?.stop()}})}}}),System.register("engine/renderable/entity/plugin/TrailerSmokePlugin",["engine/renderable/fx/TrailerSmokeFx"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("TrailerSmokePlugin",class{constructor(S,O,B,N,j){this.gameObject=S,this.art=O,this.theater=B,this.imageFinder=N,this.gameSpeed=j}onCreate(S){this.initialPosition=this.gameObject.position.worldPosition.clone(),this.renderableManager=S}update(S){if(this.renderableManager&&!this.trailerFx&&!this.gameObject.position.worldPosition.equals(this.initialPosition)){if(this.gameObject.isAircraft()){let S;this.gameObject.rules.missileSpawn?S=this.art.getAnimation("V3TRAIL"):this.gameObject.isCrashing&&(S=this.art.getAnimation("SGRYSMK1")),S&&(N=this.imageFinder.findByObjectArt(S),j=this.theater.getPalette(S.paletteType),O=this.gameObject.art.spawnDelay,this.trailerFx=new B.TrailerSmokeFx(this.gameObject.position.worldPosition,O,S,N,j,this.gameSpeed),this.renderableManager.addEffect(this.trailerFx))}var O,N,j,L;!this.gameObject.isProjectile()&&!this.gameObject.isDebris()||(L=this.gameObject.isProjectile()?this.gameObject.art.trailer:this.gameObject.rules.trailerAnim)&&(O=this.art.getAnimation(L),N=this.imageFinder.findByObjectArt(O),j=this.theater.getPalette(O.paletteType),L=this.gameObject.isProjectile()?this.gameObject.art.spawnDelay:this.gameObject.rules.trailerSeparation,this.trailerFx=new B.TrailerSmokeFx(this.gameObject.position.worldPosition,L,O,N,j,this.gameSpeed),this.renderableManager.addEffect(this.trailerFx))}}onRemove(S){this.renderableManager=void 0,this.trailerFx?.finishAndRemove()}dispose(){this.trailerFx?.finishAndRemove()}})}}}),System.register("engine/renderable/entity/plugin/VehicleDisguisePlugin",["engine/renderable/MapSpriteTranslation","engine/renderable/ShpRenderable","engine/type/ObjectType"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("VehicleDisguisePlugin",class{constructor(S,O,B,N,j,L,D,F,_,U,H,V){this.gameObject=S,this.disguiseTrait=O,this.localPlayer=B,this.alliances=N,this.renderable=j,this.art=L,this.imageFinder=D,this.theater=F,this.camera=_,this.lighting=U,this.gameSpeed=H,this.useSpriteBatching=V,this.lastRenderDisguised=!1,this.canSeeThroughDisguise=!1}onCreate(){}update(S){if(!this.gameObject.isDestroyed&&!this.gameObject.warpedOutTrait.isActive()){let B=this.disguiseTrait.isDisguised();B!==this.lastDisguised&&(this.lastDisguised=B,this.disguisedAt=B?S:void 0);let N=this.localPlayer.value;if(B&&(this.canSeeThroughDisguise=!N||this.alliances.haveSharedIntel(N,this.gameObject.owner)||!!N.sharedDetectDisguiseTrait?.has(this.gameObject)),B&&this.canSeeThroughDisguise&&(B=!N?.sharedDetectDisguiseTrait?.has(this.gameObject)&&Math.floor((S-this.disguisedAt)*this.gameSpeed.value/1e3)%16<=3),this.lastRenderDisguised!==B&&(this.lastRenderDisguised=B,this.renderable.mainObj.visible=!B,this.renderable.posObj.visible=!B||this.canSeeThroughDisguise,this.disguiseObj&&(this.disguiseObj.visible=!1),B)){var O=this.disguiseTrait.getDisguise();if(O.rules.type!==j.ObjectType.Terrain)throw new Error("Unsupported disguise type "+j.ObjectType[O.rules.type]);O=this.art.getObject(O.rules.name,j.ObjectType.Terrain),this.disguiseObj||(this.disguiseObj=this.createDisguiseObj(O),this.renderable.get3DObject().add(this.disguiseObj)),this.disguiseObj.visible=!0,O=this.lighting.compute(O.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1),this.disguiseRenderable.setExtraLight(O)}}}createDisguiseObj(S){let O=new THREE.Object3D;O.matrixAutoUpdate=!1;let j=new B.MapSpriteTranslation(1,1);var{spriteOffset:L,anchorPointWorld:D}=j.compute();O.position.x=D.x,O.position.z=D.y,O.updateMatrix();var F=this.imageFinder.findByObjectArt(S),D=this.theater.getPalette(S.paletteType,S.customPaletteName);let _=N.ShpRenderable.factory(F,D,this.camera,L,S.hasShadow);return _.setBatched(this.useSpriteBatching),this.useSpriteBatching&&_.setBatchPalettes([D]),_.setFrame(0),_.create3DObject(),O.add(_.get3DObject()),this.disguiseRenderable=_,O}updateLighting(){if(this.disguiseObj?.visible&&this.disguiseRenderable){var S=this.disguiseTrait.getDisguise();if(S){if(S.rules.type!==j.ObjectType.Terrain)throw new Error("Unsupported disguise type "+j.ObjectType[S.rules.type]);S=this.art.getObject(S.rules.name,j.ObjectType.Terrain),this.disguiseRenderable.setExtraLight(this.lighting.compute(S.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1))}}}onRemove(){this.disguiseObj&&(this.renderable.get3DObject().remove(this.disguiseObj),this.disguiseObj=void 0)}getUiNameOverride(){if(this.gameObject.disguiseTrait?.hasTerrainDisguise()&&!this.canSeeThroughDisguise)return""}shouldDisableHighlight(){return!!this.gameObject.disguiseTrait?.hasTerrainDisguise()&&!this.canSeeThroughDisguise}dispose(){this.disguiseRenderable?.dispose()}})}}}),System.register("engine/renderable/entity/unit/BlobShadow",["game/Coords","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType","engine/gfx/batch/BatchedMesh"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("BlobShadow",D=class e{constructor(S,O,B){this.gameObject=S,this.radius=O,this.useMeshInstancing=B}get3DObject(){return this.obj}create3DObject(){if(!this.obj){let S=e.geometries.get(this.radius);S||(S=new THREE.CircleBufferGeometry(this.radius*B.Coords.ISO_WORLD_SCALE),e.geometries.set(this.radius,S)),this.obj=new(this.useMeshInstancing?L.BatchedMesh:THREE.Mesh)(S,e.mat),this.obj.rotation.x=-Math.PI/2,this.obj.matrixAutoUpdate=!1}}update(S,O){let L=this.obj;var D,F,_=this.gameObject.zone===N.ZoneType.Air||this.gameObject.isInfantry()&&this.gameObject.stance===j.StanceType.Paradrop;(L.visible=_)&&(D=this.gameObject.tile.z,F=this.gameObject.tileElevation,_=!!this.gameObject.tile.onBridgeLandType,D===this.lastTileZ&&F===this.lastTileElevation&&_===this.lastBridgeBelow||(this.lastTileZ=D,this.lastTileElevation=F,this.lastBridgeBelow=_,_=this.gameObject.position.getBridgeBelow(),L.position.y=B.Coords.tileHeightToWorld(-F)+(_?B.Coords.tileHeightToWorld(_.tileElevation)+.01*B.Coords.ISO_WORLD_SCALE:0),L.updateMatrix()))}dispose(){}}),D.geometries=new Map,D.mat=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:.5,alphaTest:0})}}}),System.register("engine/renderable/entity/unit/DebugLabel",["engine/gfx/SpriteUtils","engine/gfx/CanvasUtils","game/Coords"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("DebugLabel",class{constructor(S,O,B,N={}){this.text=S,this.color=O,this.camera=B,this.fontSize=N.fontSize??16}get3DObject(){return this.mesh}create3DObject(){if(!this.mesh){let O=new THREE.Color(this.color);var S=.5<.299*O.r+.587*O.g+.114*O.b?"black":"white";S=this.texture=this.createTexture(this.text,"#"+O.getHexString(),S),this.mesh=this.createMesh(S)}}createMesh(S){var O=B.SpriteUtils.createSpriteGeometry({texture:S,camera:this.camera,align:{x:0,y:-1},offset:{x:0,y:j.Coords.ISO_TILE_SIZE/4},scale:j.Coords.ISO_WORLD_SCALE}),N=new THREE.MeshBasicMaterial({map:S,side:THREE.DoubleSide,transparent:!0,depthTest:!1,flatShading:!0});let L=new THREE.Mesh(O,N);return L.matrixAutoUpdate=!1,L}createTexture(S,O,B){let j=document.createElement("canvas");j.width=j.height=0;let L=j.getContext("2d"),D=0;for(var F of S.split("\n"))D+=(F=N.CanvasUtils.drawText(L,F,0,D,{color:O,outlineColor:B,outlineWidth:2,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:this.fontSize??16,fontWeight:"400",paddingTop:3,paddingBottom:3,paddingLeft:3,paddingRight:3,autoEnlargeCanvas:!0})).height;var _=j.width,U=j.height;U=L.getImageData(0,0,_,U),j.width+=1,j.height+=1,L.putImageData(U,1,1);let H=new THREE.Texture(j);return H.minFilter=THREE.NearestFilter,H.magFilter=THREE.NearestFilter,H.needsUpdate=!0,H.flipY=!0,H}update(){}dispose(){this.texture?.dispose(),this.mesh?.material?.dispose(),this.mesh?.geometry.dispose()}})}}}),System.register("engine/renderable/entity/unit/ExtraLightHelper",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("ExtraLightHelper",class{static multiplyShp(S,O,B){S.copy(O).add(O.clone().addScalar(1).multiplyScalar(B))}static multiplyVxl(S,O,B,N){S.copy(O).addScalar(2*N*B)}})}}}),System.register("engine/renderable/entity/unit/FlyerHelperMode",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("FlyerHelperMode",B={}))[O.Always=0]="Always",O[O.Selected=1]="Selected",O[O.Never=2]="Never"}}}),System.register("engine/renderable/entity/unit/ModelQuality",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("ModelQuality",B={}))[O.Low=0]="Low",O[O.High=1]="High"}}}),System.register("engine/renderable/entity/unit/RotorHelper",["game/gameobject/unit/ZoneType","util/math"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("RotorHelper",class{static computeRotationStep(S,O,j){var L=S.zone===B.ZoneType.Air,D=S.rules.idleRate,F=L||!!j.idleSpeed||!!D;let _=j.speed??67;L||(j.idleSpeed?_=j.idleSpeed:D&&(_/=D));var U=Math.sign(_);return L=Math.abs(THREE.Math.degToRad(_)),D=Math.abs(O),U*N.clamp(D+.1*(F?1:D/L*-.5),0,L)}})}}}),System.register("engine/renderable/entity/unit/ShadowQuality",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("ShadowQuality",B={}))[O.Off=0]="Off",O[O.Low=1]="Low",O[O.Medium=2]="Medium",O[O.High=3]="High"}}}),System.register("engine/renderable/fx/DamageSmokeFx",["engine/AnimProps","engine/gfx/ImageUtils"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("DamageSmokeFx",j=class e{static clearTextureCache(){this.textureCache.forEach(S=>S.dispose()),this.textureCache.clear()}constructor(S,O,B,N,j){this.gameObject=S,this.smokeArt=O,this.shpFile=B,this.palette=N,this.gameSpeed=j,this.lifetimeSeconds=Number.POSITIVE_INFINITY,this.finishRequested=!1}setContainer(S){this.container=S}create3DObject(){if(!this.particleGroup){let D=e.textureCache.get(this.shpFile);D||(j=N.ImageUtils.convertShpToCanvas(this.shpFile,this.palette,!0),D=new THREE.Texture(j),D.minFilter=THREE.NearestFilter,D.magFilter=THREE.NearestFilter,D.needsUpdate=!0,D.flipY=!1,e.textureCache.set(this.shpFile,D)),this.particleGroup=new SPE.Group({texture:{value:D,frames:new THREE.Vector2(this.shpFile.numImages,1),frameCount:this.shpFile.numImages,loop:1},maxParticleCount:1e3,hasPerspective:!1,transparent:!0,alphaTest:0,blending:THREE.NormalBlending}),this.particleGroup.mesh.name="fx_damage_smoke",this.particleGroup.mesh.frustumCulled=!1;var S=new B.AnimProps(this.smokeArt.art,this.shpFile),O=(L=(this.smokeArt.art.getBool("Normalized")?2:1)*S.rate)/10,j=this.particleMaxAge=2*this.shpFile.numImages/S.rate,L=(S=9*L,.05*L);S=this.particleEmitter=new SPE.Emitter({particleCount:1e3,maxAge:{value:j},activeMultiplier:O/(1e3/j),position:{value:this.computeEmitterPosition()},acceleration:{value:new THREE.Vector3(0,-L,0),spread:new THREE.Vector3(2,0,2)},velocity:{value:new THREE.Vector3(0,S,0),spread:new THREE.Vector3(.1*S,0,.1*S)},opacity:{value:.5},size:{value:Math.max(this.shpFile.height,this.shpFile.width)}}),this.particleGroup.addEmitter(S)}}computeEmitterPosition(){return this.gameObject.position.worldPosition.clone().add(this.gameObject.rules.damageSmokeOffset)}get3DObject(){return this.particleGroup?.mesh}update(S){var O;this.particleEmitter.position.value=this.computeEmitterPosition(),this.lastUpdateMillis?(O=S-this.lastUpdateMillis,this.particleGroup.tick(O/1e3*this.gameSpeed.value)):(this.firstUpdateMillis=S,this.particleGroup.tick(0)),this.lastUpdateMillis=S,this.finishRequested&&(this.finishRequested=!1,this.particleEmitter.alive&&(O=(S-this.firstUpdateMillis)/1e3*this.gameSpeed.value,this.lifetimeSeconds=O+this.particleMaxAge,this.particleEmitter.disable())),this.timeLeft=Math.max(0,1-(S-this.firstUpdateMillis)/(1e3*this.lifetimeSeconds/this.gameSpeed.value)),this.timeLeft||(this.container.remove(this),this.dispose())}finishAndRemove(){this.finishRequested=!0}dispose(){this.particleGroup?.mesh.geometry.dispose(),this.particleGroup?.mesh.material.dispose()}}),j.textureCache=new Map}}}),System.register("engine/renderable/fx/DetectionLineFx",["three.meshline","game/Coords"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=new THREE.Color(16777215),S("DetectionLineFx",L=class e{constructor(S,O,B,N,j){this.camera=S,this.sourcePos=O,this.targetPos=B,this.color=N,this.renderOrder=j,this.needsUpdate=!1,this.cameraHash=this.camera.top+"_"+this.camera.right,this.computedColor=N,this.lineHeadMaterial=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,depthTest:!1,depthWrite:!1})}setContainer(S){this.container=S}get3DObject(){return this.wrapper}create3DObject(){this.wrapper||(this.wrapper=new THREE.Object3D,this.wrapper.name="fx_detectionline",this.lineMesh=this.createLineMesh(),this.srcLineHead=this.createLineHead(),this.destLineHead=this.createLineHead(),this.wrapper.add(this.srcLineHead),this.wrapper.add(this.destLineHead),this.wrapper.add(this.lineMesh),this.needsUpdate=!0)}update(S){this.lastUpdateMillis||(this.lastUpdateMillis=S);var O=(S-this.lastUpdateMillis)/(1e3/120);this.lastUpdateMillis=S;var B=this.camera.top+"_"+this.camera.right;B!==this.cameraHash&&(this.cameraHash=B,this.lineMesh.material.uniforms.resolution.value.copy(this.computeResolution(this.camera)));let N=this.lineMesh.material;this.needsUpdate&&(this.needsUpdate=!1,this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos),B=this.sourcePos.distanceTo(this.targetPos),N.uniforms.dashArray.value=this.computeDashArray(B),this.srcLineHead.position.copy(this.sourcePos),this.destLineHead.position.copy(this.targetPos)),N.uniforms.dashOffset.value-=N.uniforms.dashArray.value/50*O,O=Math.sin(S%1e3/1e3*Math.PI);let L=this.computedColor.copy(this.color).lerp(j,O);this.lineMesh.material.uniforms.color.value=L.clone(),this.lineHeadMaterial.color.set(L)}createLineMesh(){let S=this.sourcePos.clone();var O=this.targetPos.clone();let B=new THREE.Mesh(this.createLineGeometry(S,O),this.createLineMaterial(this.color.clone(),S.distanceTo(O)));return B.renderOrder=this.renderOrder,B}createLineGeometry(S,O){let N=new THREE.Geometry;N.vertices.push(S,O);let j=new B.MeshLine;return j.setGeometry(N),j.geometry}createLineMaterial(S,O){return new B.MeshLineMaterial({color:S,lineWidth:1,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,dashArray:this.computeDashArray(O),depthTest:!1})}createLineHead(){let S=new THREE.Mesh(e.lineHeadGeometry,this.lineHeadMaterial);var O=(new THREE.Quaternion).setFromEuler(this.camera.rotation);return S.setRotationFromQuaternion(O),S.renderOrder=this.renderOrder,S}computeDashArray(S){return Math.min(1,5/S)*N.Coords.ISO_WORLD_SCALE}computeResolution(S){var O=S.top,B=S.right/S.top,j=2*O/Math.cos(S.rotation.y);return new THREE.Vector2(j*B,j).multiplyScalar(O*Math.cos(this.camera.rotation.x)/N.Coords.ISO_WORLD_SCALE)}remove(){this.container.remove(this)}dispose(){this.wrapper&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose(),this.lineHeadMaterial.dispose())}}),L.lineHeadGeometry=new THREE.PlaneGeometry(3*N.Coords.ISO_WORLD_SCALE,3*N.Coords.ISO_WORLD_SCALE)}}}),System.register("engine/renderable/fx/Effect",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("engine/renderable/fx/LaserFx",["three.meshline","game/Coords"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("LaserFx",class{constructor(S,O,B,N,j,L){this.camera=S,this.sourcePos=O,this.targetPos=B,this.color=N,this.durationSeconds=j,this.width=L}setContainer(S){this.container=S}get3DObject(){return this.lineMesh}create3DObject(){this.lineMesh||(this.lineMesh=this.createObject(),this.lineMesh.name="fx_laser")}update(S){this.firstUpdateMillis||(this.firstUpdateMillis=S),this.timeLeft=Math.max(0,1-(S-this.firstUpdateMillis)/(1e3*this.durationSeconds)),this.lineMesh.material.uniforms.opacity.value=+this.timeLeft,this.isFinished()&&(this.container.remove(this),this.dispose())}createObject(){var S=this.sourcePos.clone(),O=this.targetPos.clone();let j=new THREE.Geometry;j.vertices.push(S,O);let L=new B.MeshLine;L.setGeometry(j);var D=this.camera.top;return S=this.camera.right/this.camera.top,S=(O=2*D/Math.cos(this.camera.rotation.y))*S,D=new B.MeshLineMaterial({color:this.color.clone(),lineWidth:this.width,resolution:new THREE.Vector2(S,O).multiplyScalar(D*Math.cos(this.camera.rotation.x)/N.Coords.ISO_WORLD_SCALE),transparent:!0,sizeAttenuation:0,blending:THREE.AdditiveBlending}),new THREE.Mesh(L.geometry,D)}isFinished(){return 0===this.timeLeft}dispose(){this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose())}})}}}),System.register("engine/renderable/fx/LineTrailFx",["game/art/ObjectArt","game/Coords"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("LineTrailFx",class{constructor(S,O,B,N,j){this.lazyTarget=S,this.trailColor=O,this.trailDecrement=B,this.gameSpeed=N,this.camera=j,this.trailInitialized=!1}setContainer(S){this.container=S}get3DObject(){return this.placeholderObj}create3DObject(){this.placeholderObj||(this.placeholderObj=new THREE.Object3D,this.placeholderObj.name="fx_linetrail_placeholder")}update(S){var O;void 0!==this.timeLeft&&(O=this.prevUpdateMillis,this.prevUpdateMillis=S,O&&(this.timeLeft=Math.max(0,this.timeLeft-(S-O)/1e3))),this.trailInitialized||(this.trailInitialized=!0,(O=this.createTrail(this.trailColor,this.trailDecrement))?this.trail=O:this.timeLeft=0),this.trail&&(this.trail.advance(),this.lastTargetMatrix=this.trail.targetObject.matrixWorld),this.isFinished()&&(this.container.remove(this),this.dispose())}createTrail(S,O){var j=this.lazyTarget();if(j){let F=new THREE.TrailRenderer(this.container.get3DObject()),_=THREE.TrailRenderer.createBaseMaterial();_.uniforms.headColor.value.set(S.r,S.g,S.b,1),_.uniforms.tailColor.value.set(S.r,S.g,S.b,0);var L=Math.floor(3/this.gameSpeed.value*50/(O/B.ObjectArt.DEFAULT_LINE_TRAIL_DEC)),D=.8*N.Coords.ISO_WORLD_SCALE;let U=new THREE.PlaneGeometry(D,D);return D=(new THREE.Quaternion).setFromEuler(this.camera.rotation),U.applyMatrix((new THREE.Matrix4).makeRotationFromQuaternion(D)),F.initialize(_,L,!1,0,U.vertices,j),F.activate(),F}}isFinished(){return 0===this.timeLeft}requestFinishAndDispose(){this.timeLeft=.8/this.gameSpeed.value}stopTracking(){if(this.trail&&this.lastTargetMatrix){let S=new THREE.Object3D;S.updateMatrixWorld=()=>{},S.matrixWorld=this.lastTargetMatrix,this.trail.targetObject=S}}dispose(){this.trail?.deactivate(),this.trail?.material.dispose(),this.trail?.geometry.dispose()}})}}}),System.register("engine/renderable/fx/MindControlLinkFx",["game/Coords"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("MindControlLinkFx",class{constructor(S,O,B,N){this.sourcePos=S,this.targetPos=O,this.color=B,this.heightTiles=N,this.colorAnimProgress=0}setContainer(S){this.container=S}get3DObject(){return this.lineMesh}create3DObject(){this.lineMesh||(this.lineMesh=this.createObject(),this.lineMesh.name="fx_mclink")}updateEndpoints(S,O){var B=!S.equals(this.sourcePos)||!O.equals(this.targetPos);this.sourcePos=S,this.targetPos=O,B&&this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos,this.heightTiles,this.color,this.colorAnimProgress))}update(S){this.lastUpdate??(this.lastUpdate=S),this.colorAnimProgress+=(S-this.lastUpdate)/1e3,this.colorAnimProgress-=Math.floor(this.colorAnimProgress),this.lastUpdate=S,this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos,this.heightTiles,this.color,this.colorAnimProgress)}createObject(){var S=this.sourcePos,O=this.targetPos;S=this.createLineGeometry(S,O,this.heightTiles,this.color,this.colorAnimProgress),O=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,transparent:!0});let B=new THREE.Line(S,O);return B.renderOrder=1e6,B}createLineGeometry(S,O,N,j,L){var D=new THREE.Color(16777215),F=1.5*L,_=O.clone().sub(S).length()/B.Coords.LEPTONS_PER_TILE,U=Math.floor(15*_);let H=new Float32Array(3*U),V=new Float32Array(3*U),W=new THREE.Vector3;for(let L=0;L<=U;L++){var z=L/U;W.lerpVectors(S,O,z),W.y+=B.Coords.LEPTONS_PER_TILE/4+N*B.Coords.LEPTONS_PER_TILE*Math.sin(z*Math.PI),H[3*L]=W.x,H[3*L+1]=W.y,H[3*L+2]=W.z;let _=j;z<F&&F-.5<=z&&(_=j.clone().lerp(D,(z-(F-.5))/.5)),V[3*L]=_.r,V[3*L+1]=_.g,V[3*L+2]=_.b}let K=new THREE.BufferGeometry;return K.addAttribute("position",new THREE.BufferAttribute(H,3)),K.addAttribute("color",new THREE.BufferAttribute(V,3)),K}removeAndDispose(){this.container.remove(this),this.dispose()}dispose(){this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose())}})}}}),System.register("engine/renderable/fx/RadBeamFx",["three.meshline","game/Coords","util/math"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("RadBeamFx",class{constructor(S,O,B,N,j,L){this.camera=S,this.sourcePos=O,this.targetPos=B,this.color=N,this.durationSeconds=j,this.width=L,this.amplitude=0}setContainer(S){this.container=S}get3DObject(){return this.lineMesh}create3DObject(){this.lineMesh||(this.lineMesh=this.createObject(),this.lineMesh.name="fx_radbeam")}update(S){this.firstUpdateMillis||(this.firstUpdateMillis=S),this.timeLeft=Math.max(0,1-(S-this.firstUpdateMillis)/(1e3*this.durationSeconds));var O=j.truncToDecimals(N.Coords.LEPTONS_PER_TILE/6*(1-this.timeLeft),1);O!==this.amplitude&&(this.amplitude=O,this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos,O)),this.isFinished()&&(this.container.remove(this),this.dispose())}createObject(){var S=this.sourcePos.clone(),O=this.targetPos.clone(),j=this.createLineGeometry(S,O,this.amplitude),L=this.camera.top;return S=this.camera.right/this.camera.top,S=(O=2*L/Math.cos(this.camera.rotation.y))*S,L=new B.MeshLineMaterial({color:this.color.clone(),lineWidth:this.width,resolution:new THREE.Vector2(S,O).multiplyScalar(L*Math.cos(this.camera.rotation.x)/N.Coords.ISO_WORLD_SCALE),transparent:!0,sizeAttenuation:0}),new THREE.Mesh(j,L)}createLineGeometry(S,O,j){let L=[];var D=O.clone().sub(S).length()/N.Coords.LEPTONS_PER_TILE,F=15*D;let _=new THREE.Vector3;for(let B=0;B<=F;B++){var U=B/F;_.lerpVectors(S,O,U),_.y+=j*Math.sin(U*D*(N.Coords.LEPTONS_PER_TILE/Math.PI)),L.push(_.x,_.y,_.z)}let H=new B.MeshLine;return H.setGeometry(L),H.geometry}isFinished(){return 0===this.timeLeft}dispose(){this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose())}})}}}),System.register("engine/renderable/fx/RallyPointFx",["three.meshline","game/Coords"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("RallyPointFx",class{constructor(S,O,B,N,j){this.camera=S,this.sourcePos=O,this.targetPos=B,this.color=N,this.renderOrder=j,this.needsUpdate=!1,this.visible=!0,this.cameraHash=this.camera.top+"_"+this.camera.right}setContainer(S){this.container=S}get3DObject(){return this.wrapper}create3DObject(){this.wrapper||(this.wrapper=new THREE.Object3D,this.wrapper.matrixAutoUpdate=!1,this.lineMesh=this.createLineMesh(),this.lineMesh.name="fx_rallypoint",this.lineMesh.matrixAutoUpdate=!1,this.shadowLineMesh=this.createLineShadowMesh(),this.shadowLineMesh.name="fx_rallypoint_shadow",this.shadowLineMesh.matrixAutoUpdate=!1,this.wrapper.add(this.lineMesh),this.wrapper.add(this.shadowLineMesh))}update(S){this.lastUpdateMillis||(this.lastUpdateMillis=S);let O=(S-this.lastUpdateMillis)/(1e3/120);this.lastUpdateMillis=S,this.wrapper.visible=this.visible;var B=this.camera.top+"_"+this.camera.right;if(B!==this.cameraHash&&(this.cameraHash=B,[this.lineMesh,this.shadowLineMesh].forEach(S=>{S.material.uniforms.resolution.value.copy(this.computeResolution(this.camera))})),this.needsUpdate){this.needsUpdate=!1,this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos),this.shadowLineMesh.geometry=this.createShadowLineGeometry(this.sourcePos,this.targetPos),this.lineMesh.material.uniforms.color.value=this.color.clone();let S=this.sourcePos.distanceTo(this.targetPos);[this.lineMesh,this.shadowLineMesh].forEach(O=>{let B=O.material;B.uniforms.dashArray.value=this.computeDashArray(S),B.depthTest=void 0===this.renderOrder}),this.lineMesh.renderOrder=this.renderOrder??0,this.shadowLineMesh.renderOrder=void 0!==this.renderOrder?this.renderOrder-1:0}[this.lineMesh,this.shadowLineMesh].forEach(S=>{let B=S.material;B.uniforms.dashOffset.value-=B.uniforms.dashArray.value/50*O})}createLineMesh(){let S=this.sourcePos.clone();var O=this.targetPos.clone();let B=new THREE.Mesh(this.createLineGeometry(S,O),this.createLineMaterial(this.color.clone(),S.distanceTo(O)));return this.renderOrder&&(B.renderOrder=this.renderOrder),B}createLineShadowMesh(){let S=new THREE.Mesh(this.createShadowLineGeometry(this.sourcePos,this.targetPos),this.createLineMaterial(new THREE.Color(0),this.sourcePos.distanceTo(this.targetPos)));return this.renderOrder&&(S.renderOrder=this.renderOrder-1),S}createShadowLineGeometry(S,O){var B=new THREE.Vector3(+N.Coords.ISO_WORLD_SCALE,0,+N.Coords.ISO_WORLD_SCALE);return this.createLineGeometry(S.clone().add(B),O.clone().add(B))}createLineGeometry(S,O){let N=new THREE.Geometry;N.vertices.push(S,O);let j=new B.MeshLine;return j.setGeometry(N),j.geometry}createLineMaterial(S,O){return new B.MeshLineMaterial({color:S,lineWidth:2,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,dashArray:this.computeDashArray(O),depthTest:void 0===this.renderOrder})}computeDashArray(S){return Math.min(1,5/S)*N.Coords.ISO_WORLD_SCALE}computeResolution(S){var O=S.top,B=S.right/S.top,j=2*O/Math.cos(S.rotation.y);return new THREE.Vector2(j*B,j).multiplyScalar(O*Math.cos(this.camera.rotation.x)/N.Coords.ISO_WORLD_SCALE)}remove(){this.container.remove(this)}dispose(){this.wrapper&&[this.lineMesh,this.shadowLineMesh].forEach(S=>{S&&(S.geometry.dispose(),S.material.dispose())})}})}}}),System.register("engine/renderable/fx/SparkFx",["game/Coords"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("SparkFx",class e{constructor(S,O,B,N){this.pos=S,this.color=O,this.spawnDurationSeconds=B,this.gameSpeed=N,this.totalDurationSeconds=B+1}setContainer(S){this.container=S}create3DObject(){var S;this.particleGroup||(e.sparkTex||(e.sparkTex=new THREE.DataTexture(new Uint8Array(4).fill(255),1,1,THREE.RGBAFormat),e.sparkTex.needsUpdate=!0),this.particleGroup=new SPE.Group({texture:{value:e.sparkTex},maxParticleCount:100}),this.particleGroup.mesh.name="fx_spark",this.particleGroup.mesh.frustumCulled=!1,S=this.particleEmitter=new SPE.Emitter({maxAge:{value:1},position:{value:this.pos,spread:new THREE.Vector3(10,0,10).multiplyScalar(B.Coords.ISO_WORLD_SCALE)},acceleration:{value:new THREE.Vector3(0,-50,0).multiplyScalar(B.Coords.ISO_WORLD_SCALE),spread:new THREE.Vector3(0,0,0)},velocity:{value:new THREE.Vector3(0,30,0).multiplyScalar(B.Coords.ISO_WORLD_SCALE),spread:new THREE.Vector3(40,5,40).multiplyScalar(B.Coords.ISO_WORLD_SCALE)},color:{value:[this.color]},opacity:{value:[1,.5]},size:{value:1},particleCount:100}),this.particleGroup.addEmitter(S))}get3DObject(){return this.particleGroup?.mesh}update(S){var O;this.lastUpdateMillis?(O=S-this.lastUpdateMillis,this.particleGroup.tick(O/1e3*this.gameSpeed.value)):(this.firstUpdateMillis=S,this.particleGroup.tick(0)),this.lastUpdateMillis=S,this.particleEmitter.alive&&S-this.firstUpdateMillis>=1e3*this.spawnDurationSeconds/this.gameSpeed.value&&this.particleEmitter.disable(),this.timeLeft=Math.max(0,1-(S-this.firstUpdateMillis)/(1e3*this.totalDurationSeconds/this.gameSpeed.value)),this.timeLeft||(this.container.remove(this),this.dispose())}dispose(){this.particleGroup?.mesh.geometry.dispose(),this.particleGroup?.mesh.material.dispose()}})}}}),System.register("engine/renderable/fx/TeslaFx",["game/Coords"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("TeslaFx",class{constructor(S,O,B,N,j){this.sourcePos=S,this.targetPos=O,this.primaryColor=B,this.secondaryColor=N,this.durationSeconds=j,this.bolts=[],this.boltMeshes=[]}setContainer(S){this.container=S}get3DObject(){return this.target}create3DObject(){if(!this.target){this.target=new THREE.Object3D,this.target.name="fx_tesla";var S=this.primaryColor.getHex();[S,S,this.secondaryColor.getHex()].forEach(S=>{try{var{mesh:O,bolt:B}=this.createBolt(S);this.boltMeshes.push(O),this.bolts.push(B),this.target.add(O)}catch(S){console.warn("Couldn't create lightning FX",[S])}})}}update(S){this.firstUpdateMillis||(this.firstUpdateMillis=S);let O=(S-this.firstUpdateMillis)/1e3;this.timeLeft=Math.max(0,1-O/this.durationSeconds);try{this.bolts.forEach(S=>S.update(O))}catch(S){console.warn("Couldn't update lightning FX",[S])}this.isFinished()&&(this.container.remove(this),this.dispose())}createBolt(S){var O=this.sourcePos.clone(),N=this.targetPos.clone();return O=new THREE.LightningStrike({sourceOffset:O,destOffset:N,radius0:.3*B.Coords.ISO_WORLD_SCALE,radius1:.3*B.Coords.ISO_WORLD_SCALE,isEternal:!0,timeScale:2,propagationTimeFactor:.05,vanishingTimeFactor:.95,ramification:0,roughness:.85,straightness:.7}),N=new THREE.MeshBasicMaterial({color:S}),{mesh:new THREE.Mesh(O,N),bolt:O}}isFinished(){return 0===this.timeLeft}dispose(){this.boltMeshes.forEach(S=>{S.geometry.dispose(),S.material.dispose()})}})}}}),System.register("engine/renderable/fx/TrailerSmokeFx",["engine/AnimProps","engine/gfx/ImageUtils"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("TrailerSmokeFx",j=class e{static clearTextureCache(){this.textureCache.forEach(S=>S.dispose()),this.textureCache.clear()}constructor(S,O,B,N,j,L){this.pos=S,this.spawnDelayFrames=O,this.smokeArt=B,this.shpFile=N,this.palette=j,this.gameSpeed=L,this.lifetimeSeconds=Number.POSITIVE_INFINITY,this.finishRequested=!1,this.finishProcessed=!1}setContainer(S){this.container=S}create3DObject(){if(!this.particleGroup){let j=e.textureCache.get(this.shpFile);j||(O=N.ImageUtils.convertShpToCanvas(this.shpFile,this.palette,!0),j=new THREE.Texture(O),j.minFilter=THREE.NearestFilter,j.magFilter=THREE.NearestFilter,j.needsUpdate=!0,j.flipY=!0,e.textureCache.set(this.shpFile,j)),this.particleGroup=new SPE.Group({texture:{value:j,frames:new THREE.Vector2(this.shpFile.numImages,1),frameCount:this.shpFile.numImages,loop:1},maxParticleCount:1e3,hasPerspective:!1,transparent:!0,alphaTest:0,blending:THREE.NormalBlending}),this.particleGroup.mesh.name="fx_trailer_smoke",this.particleGroup.mesh.frustumCulled=!1;var S=new B.AnimProps(this.smokeArt.art,this.shpFile),O=(this.smokeArt.art.getBool("Normalized")?2:1)*S.rate/this.spawnDelayFrames;S=this.particleMaxAge=this.shpFile.numImages/S.rate,S=this.particleEmitter=new SPE.Emitter({particleCount:1e3,maxAge:{value:S},activeMultiplier:O/(1e3/S),position:{value:this.pos},acceleration:{value:new THREE.Vector3},velocity:{value:new THREE.Vector3},opacity:{value:this.smokeArt.translucent?[1,0]:1-this.smokeArt.translucency},size:{value:Math.max(this.shpFile.height,this.shpFile.width)}}),this.particleGroup.addEmitter(S)}}get3DObject(){return this.particleGroup?.mesh}update(S){var O;this.particleEmitter.position.value=this.pos,this.lastUpdateMillis?(O=S-this.lastUpdateMillis,this.particleGroup.tick(O/1e3*this.gameSpeed.value)):(this.firstUpdateMillis=S,this.particleGroup.tick(0)),this.lastUpdateMillis=S,this.finishRequested&&(this.finishRequested=!1,this.finishProcessed||(this.finishProcessed=!0,O=(S-this.firstUpdateMillis)/1e3*this.gameSpeed.value,this.lifetimeSeconds=O+this.particleMaxAge),this.particleEmitter.alive&&this.particleEmitter.disable()),this.timeLeft=Math.max(0,1-(S-this.firstUpdateMillis)/(1e3*this.lifetimeSeconds/this.gameSpeed.value)),this.timeLeft||(this.container.remove(this),this.dispose())}finishAndRemove(){this.finishRequested=!0}disable(){this.particleEmitter.disable()}enable(){this.particleEmitter.enable()}dispose(){this.particleGroup?.mesh.geometry.dispose(),this.particleGroup?.mesh.material.dispose()}}),j.textureCache=new Map}}}),System.register("engine/renderable/fx/handler/BeaconFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords","engine/sound/SoundKey"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("BeaconFxHandler",class{constructor(S,O,B,D,F){this.game=S,this.localPlayer=O,this.renderableManager=B,this.renderer=D,this.worldSound=F,this.disposables=new N.CompositeDisposable,this.beacons=new Map,this.handlePingEvent=S=>{var O=this.localPlayer.value;if((!O||O.isObserver||S.player===O||this.game.alliances.areAllied(S.player,O))&&this.canPingLocation(S.player,S.tile)){let B=this.beacons.get(S.player);B||(B=[],this.beacons.set(S.player,B));let N=B.find(O=>O.tile===S.tile);O=S.tile.onBridgeLandType?this.game.map.tileOccupation.getBridgeOnTile(S.tile):void 0;let D=j.Coords.tile3dToWorld(S.tile.rx+.5,S.tile.ry+.5,S.tile.z+(O?.tileElevation??0));this.worldSound.playEffect(L.SoundKey.PlaceBeaconSound,D,S.player),N?N.startTime=this.now:(O=this.renderableManager.createTransientAnim("PBEACON",O=>{O.setPosition(D),O.setRenderOrder(1e6),O.remapColor(S.player.color),O.create3DObject()}),B.push({tile:S.tile,anim:O,startTime:this.now}))}},this.handleFrame=S=>{for(var O of(this.now=S,this.beacons.values()))for(var B of O.slice())if(void 0===B.startTime)B.startTime=S;else if(S>B.startTime+7e3){if(B.anim.endAnimationLoop(),-1===(B=O.indexOf(B)))throw new Error("Beacon not found in array");O.splice(B,1)}}}init(){this.disposables.add(this.game.events.subscribe(B.EventType.PingLocation,this.handlePingEvent)),this.renderer.onFrame.subscribe(this.handleFrame),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(this.handleFrame))}canPingLocation(S,O){let B=this.beacons.get(S)??[];var N=B.reduce((S,O)=>Math.max(S,O.startTime??0),0);return(B.length<3||B.some(S=>S.tile===O))&&(!this.now||this.now-N>=1e3/3)}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/ChronoFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords","game/gameobject/common/DeathType"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("ChronoFxHandler",class{constructor(S,O){this.game=S,this.renderableManager=O,this.disposables=new N.CompositeDisposable,this.handleObjectTeleport=S=>{if(S.isChronoshift){let O=S.target.position.getTileOffset().multiplyScalar(1/j.Coords.LEPTONS_PER_TILE);this.renderableManager.createTransientAnim(this.game.rules.audioVisual.warpOut,B=>{B.setPosition(j.Coords.tile3dToWorld(S.prevTile.rx+O.x,S.prevTile.ry+O.y,S.prevTile.z))}),this.renderableManager.createTransientAnim(this.game.rules.audioVisual.warpOut,B=>{var N=S.target.tile;B.setPosition(j.Coords.tile3dToWorld(N.rx+O.x,N.ry+O.y,N.z))})}},this.handleObjectDestroy=S=>{if(S.target.deathType===L.DeathType.Temporal){let O=S.target.isBuilding()?S.target.centerTile:S.target.tile,B=S.target.isBuilding()?new THREE.Vector2(.5,.5):S.target.position.getTileOffset().multiplyScalar(1/j.Coords.LEPTONS_PER_TILE);this.renderableManager.createTransientAnim(this.game.rules.audioVisual.warpAway,S=>{S.setPosition(j.Coords.tile3dToWorld(O.rx+B.x,O.ry+B.y,O.z))})}}}init(){this.disposables.add(this.game.events.subscribe(B.EventType.ObjectTeleport,this.handleObjectTeleport),this.game.events.subscribe(B.EventType.ObjectDestroy,this.handleObjectDestroy))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/CrateFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("CrateFxHandler",class{constructor(S,O){this.game=S,this.renderableManager=O,this.disposables=new N.CompositeDisposable}init(){this.disposables.add(this.game.events.subscribe(B.EventType.CratePickup,S=>{var O=S.target.animName;O&&this.renderableManager.createTransientAnim(O,O=>{O.setPosition(j.Coords.tile3dToWorld(S.tile.rx,S.tile.ry,S.tile.z+1)),O.setRenderOrder(1e6)})}))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/ParasiteSparkFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords","game/GameSpeed","engine/renderable/fx/SparkFx"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){S("ParasiteSparkFxHandler",class{constructor(S,O){this.game=S,this.renderableManager=O,this.disposables=new N.CompositeDisposable,this.handleObjectDamaged=S=>{if((S.target.isVehicle()||S.target.isAircraft())&&S.attacker?.obj&&!S.attacker.obj.rules.organic&&S.target.parasiteableTrait?.getParasite()===S.attacker.obj&&0<S.target.healthTrait.health){let B=S.target.position.worldPosition.clone();B.y+=j.Coords.tileHeightToWorld(.5);var O=20/L.GameSpeed.BASE_TICKS_PER_SECOND;O=new D.SparkFx(B,new THREE.Color(1,1,1),O,this.game.speed),this.renderableManager.addEffect(O)}}}init(){this.disposables.add(this.game.events.subscribe(B.EventType.InflictDamage,this.handleObjectDamaged))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/SuperWeaponFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","util/math","engine/gfx/lighting/LightningStormFx","game/GameSpeed","game/type/SuperWeaponType","game/Coords"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){S("SuperWeaponFxHandler",class{constructor(S,O,B){this.game=S,this.renderableManager=O,this.lightingDirector=B,this.disposables=new N.CompositeDisposable}init(){this.disposables.add(this.game.events.subscribe(B.EventType.LightningStormCloud,S=>{var O=(O=this.game.rules.audioVisual.weatherConClouds)[j.getRandomInt(0,O.length-1)];O=this.renderableManager.createTransientAnim(O,O=>{O.setPosition(S.position)}),this.lightingFx?.waitForCloudAnim(O)}),this.game.events.subscribe(B.EventType.LightningStormManifest,()=>{var S=this.lightingFx=new L.LightningStormFx(this.game.rules.general.lightningStorm.duration/D.GameSpeed.BASE_TICKS_PER_SECOND,this.game.map.getIonLighting());this.lightingDirector.addEffect(S)}),this.game.events.subscribe(B.EventType.SuperWeaponActivate,S=>{var O=S.target;if(O===F.SuperWeaponType.IronCurtain)this.renderableManager.createTransientAnim(this.game.rules.audioVisual.ironCurtainInvokeAnim,O=>{var B=_.Coords.tile3dToWorld(S.atTile.rx+.5,S.atTile.ry+.5,S.atTile.z);O.setPosition(B)});else if(O===F.SuperWeaponType.ChronoSphere){this.disposeChronoSphereAnim();var B=this.game.map.tileOccupation.getBridgeOnTile(S.atTile)?.tileElevation??0;let N=_.Coords.tile3dToWorld(S.atTile.rx+.5,S.atTile.ry+.5,S.atTile.z+B);O=S.atTile2,B=this.game.map.tileOccupation.getBridgeOnTile(O)?.tileElevation??0;let j=_.Coords.tile3dToWorld(O.rx+.5,O.ry+.5,O.z+B);this.renderableManager.createTransientAnim(this.game.rules.audioVisual.chronoBlast,S=>{S.setPosition(N)}),this.renderableManager.createTransientAnim(this.game.rules.audioVisual.chronoBlastDest,S=>{S.setPosition(j)})}}))}createChronoSphereAnim(S){this.chronoSphereAnim=this.renderableManager.createAnim(this.game.rules.audioVisual.chronoPlacement,O=>{var B=this.game.map.tileOccupation.getBridgeOnTile(S)?.tileElevation??0;B=_.Coords.tile3dToWorld(S.rx+.5,S.ry+.5,S.z+B),O.setPosition(B)})}disposeChronoSphereAnim(){let S=this.chronoSphereAnim;S&&(this.renderableManager.getRenderableContainer()?.remove(S),S.dispose())}dispose(){this.lightingFx=void 0,this.disposeChronoSphereAnim(),this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/TriggerActionFxHandler",["util/disposable/CompositeDisposable","game/Coords","game/event/EventType"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("TriggerActionFxHandler",class{constructor(S,O){this.game=S,this.renderableManager=O,this.disposables=new B.CompositeDisposable,this.handleEvent=S=>{switch(S.type){case j.EventType.TriggerAnim:{let B=S;var O=B.name;this.renderableManager.createTransientAnim(O,S=>{var O=N.Coords.tile3dToWorld(B.tile.rx+.5,B.tile.ry+.5,B.tile.z);S.setPosition(O)});break}}}}init(){this.disposables.add(this.game.events.subscribe(this.handleEvent))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/WarheadDetonateFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords","util/math"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("WarheadDetonateFxHandler",class{constructor(S,O){this.game=S,this.renderableManager=O,this.disposables=new N.CompositeDisposable,this.handleWarheadDetonation=S=>{var O=S.explodeAnim;O&&this.renderableManager.createTransientAnim(O,O=>{let B=S.position.clone();var N;S.target.rules.bullets&&(N=j.Coords.getWorldTileSize()/8,B=new THREE.Vector3(L.getRandomInt(-N,N),0,L.getRandomInt(-N,N)).add(B)),O.setPosition(B)}),S.isLightningStrike&&(O=(O=this.game.rules.audioVisual.weatherConBolts)[L.getRandomInt(0,O.length-1)],this.renderableManager.createTransientAnim(O,O=>{O.setPosition(S.position)}))}}init(){this.disposables.add(this.game.events.subscribe(B.EventType.WarheadDetonate,this.handleWarheadDetonation))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/resourceConfigs",["engine/TheaterType"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){var O;(O=N||S("ResourceType",N={}))[O.IsoSnow=0]="IsoSnow",O[O.IsoTemp=1]="IsoTemp",O[O.IsoUrb=2]="IsoUrb",O[O.BuildGen=3]="BuildGen",O[O.TheaterSnow=4]="TheaterSnow",O[O.TheaterTemp=5]="TheaterTemp",O[O.TheaterUrb=6]="TheaterUrb",O[O.TheaterSnow2=7]="TheaterSnow2",O[O.TheaterTemp2=8]="TheaterTemp2",O[O.TheaterUrb2=9]="TheaterUrb2",O[O.Ui=10]="Ui",O[O.UiAlly=11]="UiAlly",O[O.UiSov=12]="UiSov",O[O.Anims=13]="Anims",O[O.Vxl=14]="Vxl",O[O.Cameo=15]="Cameo",O[O.Ini=16]="Ini",O[O.Strings=17]="Strings",O[O.EvaAlly=18]="EvaAlly",O[O.EvaSov=19]="EvaSov",O[O.Sounds=20]="Sounds",O[O.HalloweenMix=21]="HalloweenMix",O[O.XmasMix=22]="XmasMix",S("resourceConfigs",(new Map).set(N.IsoSnow,{id:"isoSnow",src:"isosnow.mix",type:"binary",sizeHint:28758698}).set(N.IsoTemp,{id:"isoTemp",src:"isotemp.mix",type:"binary",sizeHint:29171410}).set(N.IsoUrb,{id:"isoUrb",src:"isourb.mix",type:"binary",sizeHint:31811402}).set(N.BuildGen,{id:"buildGen",src:"build-gen.mix",type:"binary",sizeHint:27801690}).set(N.TheaterSnow,{id:"theater.snow",src:"snow.mix",type:"binary",sizeHint:18421274}).set(N.TheaterTemp,{id:"theater.temp",src:"temperat.mix",type:"binary",sizeHint:2728266}).set(N.TheaterUrb,{id:"theater.urb",src:"urban.mix",type:"binary",sizeHint:2726218}).set(N.TheaterSnow2,{id:"theater.snow2",src:"sno.mix",type:"binary",sizeHint:10898}).set(N.TheaterTemp2,{id:"theater.temp2",src:"tem.mix",type:"binary",sizeHint:10850}).set(N.TheaterUrb2,{id:"theater.urb2",src:"urb.mix",type:"binary",sizeHint:10850}).set(N.UiAlly,{id:"uially",src:"sidec01.mix",type:"binary",sizeHint:2099412}).set(N.UiSov,{id:"uisov",src:"sidec02.mix",type:"binary",sizeHint:2102564}).set(N.Anims,{id:"anims",src:"anims.mix",type:"binary",sizeHint:15867898}).set(N.Vxl,{id:"vxl",src:"vxl.mix",type:"binary",sizeHint:5271701}).set(N.Cameo,{id:"cameo",src:"cameo.mix",type:"binary",sizeHint:608120}).set(N.Ini,{id:"ini",src:"ini.mix",type:"binary",sizeHint:1000842}).set(N.Ui,{id:"ui",src:"ui.mix",type:"binary",sizeHint:4424093}).set(N.Strings,{id:"strings",src:"strings.mix",type:"binary",sizeHint:485818}).set(N.EvaAlly,{id:"evaally",src:"eva-ally.mix",type:"binary",sizeHint:1835436}).set(N.EvaSov,{id:"evasov",src:"eva-sov.mix",type:"binary",sizeHint:2021760}).set(N.Sounds,{id:"sounds",src:"sounds.mix",type:"binary",sizeHint:17684750}).set(N.HalloweenMix,{id:"halloweenmix",src:"expandspawn09.mix",type:"binary",sizeHint:20312}).set(N.XmasMix,{id:"xmasmix",src:"expandspawn10.mix",type:"binary",sizeHint:10318})),S("resourcesForPrefetch",[N.BuildGen,N.Sounds,N.Anims,N.Vxl,N.IsoUrb,N.TheaterUrb,N.TheaterUrb2,N.IsoTemp,N.TheaterTemp,N.TheaterTemp2,N.IsoSnow,N.TheaterSnow,N.TheaterSnow2]),S("theaterSpecificResources",new Map([[B.TheaterType.Snow,[N.TheaterSnow,N.TheaterSnow2,N.IsoSnow]],[B.TheaterType.Temperate,[N.TheaterTemp,N.TheaterTemp2,N.IsoTemp]],[B.TheaterType.Urban,[N.TheaterUrb,N.TheaterUrb2,N.IsoUrb]]]))}}}),System.register("engine/sound/AudioLoop",["util/math"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("AudioLoop",class{constructor(S,O,B,N,j,L,D,F,_){this.audioContext=S,this.volume=O,this.pan=B,this.rate=N,this.delayMs=j,this.attack=L,this.decay=D,this.playBuffer=_,this.isLoop=!0,this.items=[],this.playing=!1,this.handleSoundEnded=()=>{this.playing&&(this.removeCompleted(),this.fill(this.buffers),this.remainingLoops||this.items.length||this.stop())},this.remainingLoops=F}setBuffers(S){this.buffers=S,this.playing&&(this.timePointer=Math.max(this.timePointer,this.audioContext.currentTime),this.fill(this.buffers))}start(S){if(this.playing)throw new Error("Already playing");this.timePointer=S,this.playing=!0,this.buffers&&this.fill(this.buffers)}isPlaying(){return this.playing}stop(){var S;this.playing&&(this.playing=!1,this.decay&&this.buffers?(this.removeCompleted(),this.items.length&&(S=this.items[0].startTime+this.items[0].duration,this.items.splice(1).forEach(S=>S.handle.stop()),this.queueBuffer(this.buffers[this.buffers.length-1],S))):(this.items.forEach(S=>S.handle.stop()),this.items.length=0))}setVolume(S){this.volume=S,this.items.forEach(O=>O.handle.setVolume(S))}setPan(S){this.pan=S,this.items.forEach(O=>O.handle.setPan(S))}add(S){this.items.push(S)}removeCompleted(){this.items=this.items.filter(S=>S.startTime+S.duration>=this.audioContext.currentTime)}fill(S){let O=this.items.length?this.timePointer-this.items[0].startTime:0;for(;O<.1||this.items.length<3;){if(!this.attack||void 0!==this.bufferPointer){if(this.remainingLoops<=0)break;this.remainingLoops--}this.attack?this.bufferPointer=void 0===this.bufferPointer?0:B.getRandomInt(1,S.length-1-(this.decay?1:0)):this.bufferPointer=B.getRandomInt(0,S.length-1);var N=S[this.bufferPointer];N=this.queueBuffer(N,this.timePointer),this.timePointer+=N,O+=N}}queueBuffer(S,O){var N=this.delayMs?B.getRandomInt(this.delayMs.min,this.delayMs.max)/1e3:0,j=O+N,L=S.duration/this.rate;let{handle:D,source:F}=this.playBuffer(S,j,this.volume,this.pan,this.rate);return F.addEventListener("ended",this.handleSoundEnded),this.add({startTime:j,duration:L,handle:D}),L+N}})}}}),System.register("engine/sound/AudioSequence",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("AudioSequence",class{constructor(S,O,B,N,j,L){this.audioContext=S,this.volume=O,this.pan=B,this.rate=N,this.delayMs=j,this.playBuffer=L,this.isLoop=!1,this.items=[],this.playing=!1,this.handleSoundEnded=()=>{this.playing&&(this.removeCompleted(),this.items.length||(this.playing=!1))}}setBuffers(S){this.buffers=S,this.playing&&(this.timePointer=Math.max(this.timePointer,this.audioContext.currentTime),this.fill(this.buffers))}start(S){if(this.playing)throw new Error("Already playing");this.timePointer=S,this.playing=!0,this.buffers&&this.fill(this.buffers)}isPlaying(){return this.playing}stop(){this.playing&&(this.playing=!1,this.items.forEach(S=>S.handle.stop()),this.items.length=0)}setVolume(S){this.volume=S,this.items.forEach(O=>O.handle.setVolume(S))}setPan(S){this.pan=S,this.items.forEach(O=>O.handle.setPan(S))}add(S){this.items.push(S)}removeCompleted(){this.items=this.items.filter(S=>S.startTime+S.duration>=this.audioContext.currentTime)}fill(S){let O=this.delayMs?this.delayMs/1e3:0;for(var B of S)B=this.queueBuffer(B,this.timePointer,O),this.timePointer+=B,O=0}queueBuffer(S,O,B){var N=O+B,j=S.duration/this.rate;let{handle:L,source:D}=this.playBuffer(S,N,this.volume,this.pan,this.rate);return D.addEventListener("ended",this.handleSoundEnded),this.add({startTime:N,duration:j,handle:L}),j+B}})}}}),System.register("engine/sound/AudioSystem",["engine/sound/ChannelType","util/disposable/CompositeDisposable","engine/sound/InternalPlaybackHandle","engine/sound/AudioLoop","engine/sound/AudioSequence"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F="data:audio/mpeg;base64,/+MYxAAAAANIAUAAAASEEB/jwOFM/0MM/90b/+RhST//w4NFwOjf///PZu////9lns5GFDv//l9GlUIEEIAAAgIg8Ir/JGq3/+MYxDsLIj5QMYcoAP0dv9HIjUcH//yYSg+CIbkGP//8w0bLVjUP///3Z0x5QCAv/yLjwtGKTEFNRTMuOTeqqqqqqqqqqqqq/+MYxEkNmdJkUYc4AKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq",S("AudioSystem",class{constructor(S){this.mixer=S,this.channels=new Map,this.audioBufferCache=new Map,this.disposables=new N.CompositeDisposable,this.soundsPlaying=new Set,this.handleVolumeChange=(S,O)=>{this.getChannel(S).gain.value=O.isMuted(S)?0:O.getVolume(S)}}isInitialized(){return!!this.audioContext}isSuspended(){return"running"!==this.audioContext?.state}initialize(){this.isInitialized()||(this.audioContext=new AudioContext,this.mixer.onVolumeChange.subscribe(this.handleVolumeChange),this.disposables.add(()=>this.mixer.onVolumeChange.unsubscribe(this.handleVolumeChange)),this.createChannels(this.audioContext,this.mixer))}dispose(){this.disposables.dispose(),this.audioContext&&(this.audioContext.close(),this.soundsPlaying.clear())}createChannels(S,O){let N=Object.keys(B.ChannelType).map(Number).filter(S=>!Number.isNaN(S));N.forEach(B=>{let N=S.createGain();N.gain.value=O.getVolume(B),this.channels.set(B,N)});let j=this.getChannel(B.ChannelType.Master);N.forEach(O=>{let N=this.getChannel(O);var L;O===B.ChannelType.Master?N.connect(S.destination):O===B.ChannelType.Effect?(L=S.createDynamicsCompressor(),N.connect(L).connect(j)):N.connect(j)})}getChannel(S){if(!this.channels.has(S))throw new Error(`Sound channel "${S}" doesn't exist`);return this.channels.get(S)}setMuted(S){this.mixer.setMuted(B.ChannelType.Master,S)}playWavFile(S,O,B=1,N=0,j=0,L=1,D=!1){if(!this.isInitialized())throw new Error("Can't play audio file because audio system is not initialized");var F=this.audioContext.currentTime+j/1e3;return this.removeSuspendedSounds(),this.playWavFileAtTime(S,O,F,B,N,L,D)}removeSuspendedSounds(){this.isSuspended()&&this.soundsPlaying.forEach(S=>{try{S.stop()}catch(S){console.error(S)}})}playWavLoop(S,O,B=1,N=0,D,F=1,_=!1,U=!1,H=Number.POSITIVE_INFINITY){if(!this.isInitialized())throw new Error("Can't play audio sequence because audio system is not initialized");let V=this.audioContext;this.removeSuspendedSounds();let W=new L.AudioLoop(V,B,N,F,D,_,U,H,(S,B,N,L,D)=>{var F=new j.InternalPlaybackHandle;return{handle:F,source:this.playAudioBuffer(F,S,O,N,L,B,D,!1)}});return Promise.all(S.map(S=>this.decodeFile(S,V))).then(S=>{W.setBuffers(S)}).catch(S=>console.error(S)),W.start(V.currentTime),W}playWavSequence(S,O,B=1,N=0,L=0,F=1){if(!this.isInitialized())throw new Error("Can't play audio sequence because audio system is not initialized");let _=this.audioContext;this.removeSuspendedSounds();let U=new D.AudioSequence(_,B,N,F,L,(S,B,N,L,D)=>{var F=new j.InternalPlaybackHandle;return{handle:F,source:this.playAudioBuffer(F,S,O,N,L,B,D,!1)}});return Promise.all(S.map(S=>this.decodeFile(S,_))).then(S=>{U.setBuffers(S)}).catch(S=>console.error(S)),U.start(_.currentTime),U}async decodeFile(S,O){let B=this.audioBufferCache.get(S);var N;return B||(N=new Uint8Array(S.getData()).buffer,B=await O.decodeAudioData(N),100<=this.audioBufferCache.size&&this.audioBufferCache.delete(this.audioBufferCache.keys().next().value),this.audioBufferCache.set(S,B)),B}playWavFileAtTime(S,O,B,N=1,L=0,D=1,F=!1){if(!this.isInitialized())throw new Error("Can't play audio file because audio system is not initialized");let _=this.audioContext,U=new j.InternalPlaybackHandle;var H=this.audioBufferCache.get(S);if(H)this.playAudioBuffer(U,H,O,N,L,B,D,F);else{let j;try{var V=S.getData();j=new Uint8Array(V).buffer}catch(H){return console.error("Failed to decode wav file",H),U}(async()=>{var H=await _.decodeAudioData(j);100<=this.audioBufferCache.size&&this.audioBufferCache.delete(this.audioBufferCache.keys().next().value),this.audioBufferCache.set(S,H),U.stopRequested||this.playAudioBuffer(U,H,O,N,L,B,D,F)})().catch(S=>console.error(S))}return U}playAudioBuffer(S,O,B,N,j,L,D,F){let _=this.audioContext,U=_.createGain();U.gain.value=N;let H=_.createStereoPanner();H.pan.value=j;let V=_.createBufferSource();return V.buffer=O,V.playbackRate.value=D,V.loop=F,V.connect(H).connect(U).connect(this.getChannel(B)),S.setNodes(V,U,H),V.addEventListener("ended",()=>{this.soundsPlaying.delete(V),S.playing=!1}),this.soundsPlaying.add(V),V.start(L),V}async initMusicLoop(){if(!this.isInitialized())throw new Error("Can't initialize music loop because audio system is not initialized");this.musicState||this.initMusicNode()}async playMusicFile(S,O,B){if(!this.isInitialized())throw new Error("Can't play audio file because audio system is not initialized");this.removeSuspendedSounds(),this.stopMusic();let N=this.musicState??this.initMusicNode(),j=N.source.mediaElement;j.loop=O;let L=j.src=URL.createObjectURL(S.asFile());j.onended=j.onpause=()=>{URL.revokeObjectURL(L),j=void 0},B&&(N.onEnd=B,j.addEventListener("ended",N.onEnd,{once:!0})),await this.playOrResumeMusic()}initMusicNode(){let S=this.audioContext,O=S.createGain();O.gain.value=1;let N=S.createStereoPanner();N.pan.value=0;let j=document.createElement("audio");j.src=F,j.loop=!0;let L=S.createMediaElementSource(j);return this.musicState={source:L,playing:!1},L.addEventListener("ended",()=>{this.musicState.playing=!1}),L.connect(N).connect(O).connect(this.getChannel(B.ChannelType.Music)),this.musicState}async playOrResumeMusic(){if(this.musicState&&!this.musicState.playing){this.musicState.playing=!0;try{await(this.musicState.source.mediaElement.play()?.catch(S=>console.error(S)))}catch(S){console.error(S),this.musicState.playing=!1}}}stopMusic(){if(this.musicState?.playing)try{this.musicState.onEnd&&this.musicState.source.mediaElement.removeEventListener("ended",this.musicState.onEnd),this.musicState.source.mediaElement.pause(),this.musicState.source.mediaElement.src=F,this.musicState.playing=!1,this.musicState.onEnd=void 0}catch(S){console.error(S)}}})}}}),System.register("engine/sound/ChannelType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("ChannelType",B={}))[O.Master=0]="Master",O[O.Ui=1]="Ui",O[O.Ambient=2]="Ambient",O[O.Effect=3]="Effect",O[O.Voice=4]="Voice",O[O.Music=5]="Music",O[O.CreditTicks=6]="CreditTicks"}}}),System.register("engine/sound/Eva",["engine/sound/ChannelType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("Eva",class{constructor(S,O,N){this.evaSpecs=S,this.sound=O,this.renderer=N,this.evaWaitingList=[],this.lastEvaEventBySpec=new Map,this.handleFrame=S=>{var O,N;this.currentEvaPlaying?.isPlaying()?this.evaWaitingList=this.evaWaitingList.filter(S=>S.queue):(this.currentEvaPlaying=void 0,this.evaWaitingList.sort((S,O)=>O.priority-S.priority),this.evaWaitingList=this.evaWaitingList.filter(O=>5e3<=S-(this.lastEvaEventBySpec.get(O)||0)),this.evaWaitingList.length&&(O=this.evaWaitingList.shift(),(N=this.sound.getWavFile(O.sound))&&(this.currentEvaPlaying=this.sound.audioSystem.playWavFile(N,B.ChannelType.Voice),this.lastEvaEventBySpec.set(O,S),this.evaWaitingList.splice(1))))}}init(){this.renderer.onFrame.subscribe(this.handleFrame)}dispose(){this.renderer.onFrame.unsubscribe(this.handleFrame),this.currentEvaPlaying?.stop()}play(S,O=!1){let B=this.evaSpecs.getSpec(S);B?(O&&(B={...B,queue:!0}),this.evaWaitingList.push(B)):console.warn(`No EVA with name ${S} was found. Skipping.`)}})}}}),System.register("engine/sound/EvaSpecs",["game/SideType"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){var O;(O=N||S("EvaPriority",N={}))[O.Low=0]="Low",O[O.Normal=1]="Normal",O[O.Important=2]="Important",O[O.Critical=3]="Critical",S("EvaSpecs",class{constructor(S){this.sideType=S,this.specs=new Map}readIni(S){let O=S.getSection("DialogList");if(!O)throw new Error("Missing eva.ini [DialogList] section");var j,L,D=new Set(O.entries.values()),F=this.sideType===B.SideType.GDI?"Allied":"Russian";for(j of D)if(j){let O=S.getSection(j);O?(L={text:O.getString("Text"),sound:O.getString(F),priority:O.getEnum("Priority",N,N.Normal,!0),queue:"queue"===O.getString("Type").trim().toLowerCase()},this.specs.set(j,L)):console.warn(`Missing eva section [${j}]`)}return this}getSpec(S){return this.specs.get(S)}})}}}),System.register("engine/sound/InternalPlaybackHandle",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("InternalPlaybackHandle",class{constructor(){this.playing=!0,this.isLoop=!1,this.stopRequested=!1}setNodes(S,O,B){this.sourceNode=S,this.gainNode=O,this.panNode=B,this.stopRequested?this.stop():(this.volumeRequested&&(O.gain.value=this.volumeRequested),this.panRequested&&(B.pan.value=this.panRequested))}isPlaying(){return this.playing}stop(){try{this.sourceNode?this.sourceNode.stop():this.stopRequested=!0,this.playing=!1}catch(S){console.error(S)}}setVolume(S){this.gainNode?this.gainNode.gain.value=S:this.volumeRequested=S}setPan(S){this.panNode?this.panNode.pan.value=S:this.panRequested=S}})}}}),System.register("engine/sound/Mixer",["util/event"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("Mixer",class{constructor(){this.volumes=new Map,this.mutes=new Map,this._onVolumeChange=new B.EventDispatcher}get onVolumeChange(){return this._onVolumeChange.asEvent()}setVolume(S,O){this.getVolume(S)!==O&&(this.volumes.set(S,O),this._onVolumeChange.dispatch(this,S))}getVolume(S){return this.volumes.get(S)??1}setMuted(S,O){this.mutes.set(S,O),this._onVolumeChange.dispatch(this,S)}isMuted(S){return!!this.mutes.get(S)}serialize(){return[...this.volumes.entries()].map(([S,O])=>S+","+O).join(";")}unserialize(S){return this.volumes=new Map(S.split(";").map(S=>S.split(",").map(Number))),this}})}}}),System.register("engine/sound/Music",["util/math"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){var O;(O=N||S("MusicType",N={}))[O.Normal=0]="Normal",O[O.NormalShuffle=1]="NormalShuffle",O.Intro="INTRO",O.Score="SCORE",O.Loading="LOADING",O.Credits="CREDITS",O.Options="RA2Options",S("Music",class{constructor(S,O,B){this.audioSystem=S,this.audioFiles=O,this.musicSpecs=B,this.playlist=[],this.currentPlaylistIdx=-1,this.shuffle=!1,this.repeat=!1}unserializeOptions(S){var[O,B,N]=S.split(",");this.shuffle=Boolean(Number(O)),this.repeat=Boolean(Number(B)),this.initialRepeatName=N}serializeOptions(){return[Number(this.shuffle),Number(this.repeat),this.repeat&&-1!==this.currentPlaylistIdx?this.playlist[this.currentPlaylistIdx].name:void 0].join(",")}getShuffleMode(){return this.shuffle}getRepeatMode(){return this.repeat}getPlaylist(){return this.buildPlaylist(!1)}getCurrentPlaylistItem(){if(-1!==this.currentPlaylistIdx)return this.playlist[this.currentPlaylistIdx]}dispose(){this.stopPlaying()}getMusicSpec(S){var O=this.musicSpecs.getSpec(S);if(O)return O;console.warn(`Music "${S}" is not defined`)}async play(S){var O,B;this.currentMusicType!==S&&(S===N.Normal||S===N.NormalShuffle?(O=this.shuffle||S===N.NormalShuffle,this.playlist=this.buildPlaylist(O),this.currentPlaylistIdx=0,!this.initialRepeatName||-1!==(B=this.playlist.findIndex(S=>S.name===this.initialRepeatName))&&(this.currentPlaylistIdx=B),await this.playSpec(this.playlist[this.currentPlaylistIdx],()=>this.advancePlaylist())&&(this.currentMusicType=S)):(B=this.getMusicSpec(S))?await this.playSpec(B)&&(this.currentMusicType=S):console.warn(`No music spec found for type "${S}"`))}stopPlaying(){this.audioSystem.stopMusic(),this.currentMusicType=void 0}setShuffleMode(S){if(S!==this.shuffle){this.shuffle=S;let O=-1!==this.currentPlaylistIdx?this.playlist[this.currentPlaylistIdx]:void 0;this.playlist=this.buildPlaylist(this.shuffle),this.currentPlaylistIdx=O?this.playlist.findIndex(S=>S===O):-1}}setRepeatMode(S){this.repeat=S}async playSpec(S,O){var B=await this.getMp3File(S.sound);return!!B&&(await this.audioSystem.playMusicFile(B,S.repeat,O),!0)}async getMp3File(S){var O=S.toLowerCase()+".mp3";let B;try{B=await this.audioFiles.get(O)}catch(S){return void console.error("Failed to fetch audio file",S)}if(B)return B;console.warn(`Audio file "${O}" not found.`)}buildPlaylist(S){let O=this.musicSpecs.getAll().filter(S=>S.normal);return S&&(O=this.shufflePlaylist(O)),O}shufflePlaylist(S){let O=[];for(S=[...S];S.length;)O.push(...S.splice(B.getRandomInt(0,S.length-1),1));return O}async advancePlaylist(){this.currentPlaylistIdx=this.repeat?this.currentPlaylistIdx:(this.currentPlaylistIdx+1)%this.playlist.length,await this.playSpec(this.playlist[this.currentPlaylistIdx],()=>this.advancePlaylist())}async selectPlaylistItem(S){var O=this.playlist?.findIndex(O=>O===S);-1!==O&&(this.currentPlaylistIdx=O,this.stopPlaying(),await this.playSpec(this.playlist[this.currentPlaylistIdx],()=>this.advancePlaylist()))}})}}}),System.register("engine/sound/MusicSpecs",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("MusicSpecs",class{constructor(S){this.ini=S,this.specs=new Map,this.parse()}parse(){let S=this.ini.getSection("Themes");if(S){for(var O of S.entries.values())if(O){let S=this.ini.getSection(O);var B;S?(B={name:S.getString("Name"),sound:S.getString("Sound"),normal:S.getBool("Normal",!0),repeat:S.getBool("Repeat")},this.specs.set(O,B)):console.warn(`Music section [${O}] not found. Skipping.`)}}else console.warn("[Themes] section missing. Music will not be played.")}getSpec(S){return this.specs.get(S)}getAll(){return[...this.specs.values()]}})}}}),System.register("engine/sound/Sound",["engine/sound/ChannelType","engine/sound/SoundKey","engine/sound/SoundSpecs","util/math","util/typeGuard"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){S("Sound",class{constructor(S,O,j,L,D){this.audioSystem=S,this.audioFiles=O,this.soundSpecs=j,this.audioVisualRules=L,this.document=D,this.playbackHandles=new Map,this.handleClick=S=>{let O=S.target;O.matches("button, .menu-button:not(.disabled)")?this.play(N.SoundKey.GUIMainButtonSound,B.ChannelType.Ui):O.matches(".list-item")?this.play(N.SoundKey.GenericClick,B.ChannelType.Ui):O instanceof HTMLInputElement&&["checkbox","radio","range"].includes(O.type)&&!O.disabled?this.play(N.SoundKey.GUICheckboxSound,B.ChannelType.Ui):(O instanceof HTMLSelectElement&&!O.disabled||O.matches(".select:not(.disabled) *"))&&this.play(N.SoundKey.GUIComboOpenSound,B.ChannelType.Ui)}}initialize(){this.audioSystem.initialize(),this.document.addEventListener("click",this.handleClick)}dispose(){this.audioSystem.dispose(),this.document.removeEventListener("click",this.handleClick)}getSoundKey(S){let O;if("string"==typeof N.SoundKey[S]){if(O=this.audioVisualRules.ini.getString(N.SoundKey[S]),!O)return}else O=S;return O}getSoundSpec(S){var O=this.getSoundKey(S);if(O){var B=this.soundSpecs.getSpec(O);if(B)return B;console.warn(`Sound "${O}" is not defined`)}else console.warn(`No sound is defined for key "${N.SoundKey[S]}"`)}play(S,O){let B=this.getSoundSpec(S);if(B){var N=B.control.has(j.SoundControl.Loop)?B.loop||Number.POSITIVE_INFINITY:0;return this.playWithOptions(B,O,B.volume/100,0,B.limit,N)}}playWithOptions(S,O,B,N,F,_){if(S.sounds.length){this.cleanOldHandles();let K=this.playbackHandles.get(S.name);if(K||(K=[],this.playbackHandles.set(S.name,K)),F&&K.length>=F){if(!S.control.has(j.SoundControl.Interrupt))return;K.shift().stop()}var U=1+(S.fShift?L.getRandomInt(S.fShift.min,S.fShift.max)/100:0);let $;var H=S.control.has(j.SoundControl.Attack),V=S.control.has(j.SoundControl.Decay);if(_&&(1<S.sounds.length||_!==Number.POSITIVE_INFINITY||S.delay)){var W=this.buildAttackDecaySequence(S,H,V,!0).map(S=>this.getWavFile(S)).filter(D.isNotNullOrUndefined);$=this.audioSystem.playWavLoop(W,O,B,N,S.delay,U,H,V,_)}else{let F=0;if(S.delay&&(F=L.getRandomInt(S.delay.min,S.delay.max)),H||V){var z=this.buildAttackDecaySequence(S,H,V,!1).map(S=>this.getWavFile(S)).filter(D.isNotNullOrUndefined);$=this.audioSystem.playWavSequence(z,O,B,N,F,U)}else{let D;if(D=S.control.has(j.SoundControl.Random)?S.sounds[L.getRandomInt(0,S.sounds.length-1)]:S.sounds[0],!(z=this.getWavFile(D)))return;$=this.audioSystem.playWavFile(z,O,B,N,F,U,0!==_)}}return $&&K.push($),$}}buildAttackDecaySequence(S,O,B,N){var j=O?S.attack||1:0,D=B?S.decay||1:0,F=S.sounds.slice(j,S.sounds.length-D);let _=[];return 0<j&&(j=S.sounds[L.getRandomInt(0,j-1)],_.push(j)),N?_.push(...F):_.push(F[L.getRandomInt(0,F.length-1)]),0<D&&(D=S.sounds[L.getRandomInt(S.sounds.length-D,S.sounds.length-1)],_.push(D)),_}getWavFile(S){var O=S+".wav",B=this.audioFiles.get(O);if(B)return B;console.error(`Audio file "${O}" not found.`)}cleanOldHandles(){for(var[S,O]of this.playbackHandles)O=O.filter(S=>S.isPlaying()),this.playbackHandles.set(S,O)}})}}}),System.register("engine/sound/SoundKey",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("SoundKey",B={}))[O.CreateInfantrySound=0]="CreateInfantrySound",O[O.CreateUnitSound=1]="CreateUnitSound",O[O.CreateAircraftSound=2]="CreateAircraftSound",O[O.SpySatActivationSound=3]="SpySatActivationSound",O[O.SpySatDeactivationSound=4]="SpySatDeactivationSound",O[O.UpgradeVeteranSound=5]="UpgradeVeteranSound",O[O.UpgradeEliteSound=6]="UpgradeEliteSound",O[O.BaseUnderAttackSound=7]="BaseUnderAttackSound",O[O.BuildingGarrisonedSound=8]="BuildingGarrisonedSound",O[O.BuildingRepairedSound=9]="BuildingRepairedSound",O[O.CheerSound=10]="CheerSound",O[O.PlaceBeaconSound=11]="PlaceBeaconSound",O[O.StartPlanningModeSound=12]="StartPlanningModeSound",O[O.EndPlanningModeSound=13]="EndPlanningModeSound",O[O.AddPlanningModeCommandSound=14]="AddPlanningModeCommandSound",O[O.ExecutePlanSound=15]="ExecutePlanSound",O[O.CratePromoteSound=16]="CratePromoteSound",O[O.CrateMoneySound=17]="CrateMoneySound",O[O.CrateRevealSound=18]="CrateRevealSound",O[O.CrateFireSound=19]="CrateFireSound",O[O.CrateArmourSound=20]="CrateArmourSound",O[O.CrateSpeedSound=21]="CrateSpeedSound",O[O.CrateUnitSound=22]="CrateUnitSound",O[O.GUIMainButtonSound=23]="GUIMainButtonSound",O[O.GUIBuildSound=24]="GUIBuildSound",O[O.GUITabSound=25]="GUITabSound",O[O.GUIOpenSound=26]="GUIOpenSound",O[O.GUICloseSound=27]="GUICloseSound",O[O.GUIMoveOutSound=28]="GUIMoveOutSound",O[O.GUIMoveInSound=29]="GUIMoveInSound",O[O.GUIComboOpenSound=30]="GUIComboOpenSound",O[O.GUIComboCloseSound=31]="GUIComboCloseSound",O[O.GUICheckboxSound=32]="GUICheckboxSound",O[O.ScoreAnimSound=33]="ScoreAnimSound",O[O.SinkingSound=34]="SinkingSound",O[O.ImpactWaterSound=35]="ImpactWaterSound",O[O.ImpactLandSound=36]="ImpactLandSound",O[O.BombTickingSound=37]="BombTickingSound",O[O.ChronoInSound=38]="ChronoInSound",O[O.ChronoOutSound=39]="ChronoOutSound",O[O.BombAttachSound=40]="BombAttachSound",O[O.YuriMindControlSound=41]="YuriMindControlSound",O[O.DigSound=42]="DigSound",O[O.CloakSound=43]="CloakSound",O[O.SellSound=44]="SellSound",O[O.GameClosed=45]="GameClosed",O[O.IncomingMessage=46]="IncomingMessage",O[O.MessageCharTyped=47]="MessageCharTyped",O[O.SystemError=48]="SystemError",O[O.OptionsChanged=49]="OptionsChanged",O[O.GameForming=50]="GameForming",O[O.PlayerLeft=51]="PlayerLeft",O[O.PlayerJoined=52]="PlayerJoined",O[O.Construction=53]="Construction",O[O.BuildingDieSound=54]="BuildingDieSound",O[O.BuildingSlam=55]="BuildingSlam",O[O.RadarOn=56]="RadarOn",O[O.RadarOff=57]="RadarOff",O[O.MovieOn=58]="MovieOn",O[O.MovieOff=59]="MovieOff",O[O.ScoldSound=60]="ScoldSound",O[O.TeslaCharge=61]="TeslaCharge",O[O.TeslaZap=62]="TeslaZap",O[O.BuildingDamageSound=63]="BuildingDamageSound",O[O.ChuteSound=64]="ChuteSound",O[O.GenericClick=65]="GenericClick",O[O.GenericBeep=66]="GenericBeep",O[O.BuildingDrop=67]="BuildingDrop",O[O.StopSound=68]="StopSound",O[O.GuardSound=69]="GuardSound",O[O.ScatterSound=70]="ScatterSound",O[O.DeploySound=71]="DeploySound",O[O.StormSound=72]="StormSound",O[O.LightningSounds=73]="LightningSounds",O[O.ShellButtonSlideSound=74]="ShellButtonSlideSound",O[O.QuickMatchTimer=75]="QuickMatchTimer"}}}),System.register("engine/sound/SoundSpec",["engine/sound/SoundSpecs"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("SoundSpec",class{read(S,O){let N=S.getNumber("Range",O.range);var j;return-2===N&&(N=Number.POSITIVE_INFINITY),this.name=S.name,this.control=new Set(S.getEnumArray("Control",B.SoundControl,/\s+/,[],!0)),this.sounds=S.getArray("Sounds",/\s+/).map(S=>S.replace(/^\$/,"")),this.volume=S.has("Volume")?S.getNumber("Volume",O.volume):S.getNumber("volume",O.volume),this.delay=this.createMinMaxPair(S.getNumberArray("Delay",/\s+/,[])),this.priority=S.getEnum("Priority",B.SoundPriority,O.priority,!0),this.type=S.getEnumArray("Type",B.SoundType,/\s+/,O.type,!0),this.type.some(S=>[B.SoundType.Screen,B.SoundType.Local,B.SoundType.Global].includes(S))||(j=O.type.find(S=>[B.SoundType.Screen,B.SoundType.Local,B.SoundType.Global].includes(S)))&&this.type.push(j),this.fShift=this.createMinMaxPair(S.getNumberArray("FShift",/\s+/,[])),this.limit=S.getNumber("Limit",O.limit),this.loop=S.getNumber("Loop"),this.range=N,this.minVolume=S.getNumber("MinVolume",O.minVolume),this.vShift=this.createMinMaxPair(S.getNumberArray(S.has("Vshift")?"Vshift":"VShift",/\s+/,[])),this.attack=S.getNumber("Attack"),this.decay=S.getNumber("Decay"),this}createMinMaxPair(S){if(S.length){let[O,B]=S;return void 0===B&&(B=O),{min:O,max:B}}}})}}}),System.register("engine/sound/SoundSpecs",["engine/sound/SoundSpec"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S}],execute:function(){var O;(O=N||S("SoundType",N={}))[O.Global=0]="Global",O[O.Normal=1]="Normal",O[O.Screen=2]="Screen",O[O.Local=3]="Local",O[O.Player=4]="Player",O[O.Unshroud=5]="Unshroud",O[O.Shroud=6]="Shroud",(O=j||S("SoundPriority",j={}))[O.Lowest=0]="Lowest",O[O.Low=1]="Low",O[O.Normal=2]="Normal",O[O.High=3]="High",O[O.Critical=4]="Critical",(O=L||S("SoundControl",L={}))[O.All=0]="All",O[O.Loop=1]="Loop",O[O.Random=2]="Random",O[O.Predelay=3]="Predelay",O[O.Interrupt=4]="Interrupt",O[O.Attack=5]="Attack",O[O.Decay=6]="Decay",O[O.Ambient=7]="Ambient",S("SoundSpecs",class{constructor(S){this.ini=S,this.specs=new Map,this.parse()}parse(){let S=this.ini.getSection("Defaults");if(S){this.defaults={minVolume:S.getNumber("MinVolume"),range:S.getNumber("Range"),volume:S.getNumber("Volume"),limit:S.getNumber("Limit"),type:S.getEnumArray("Type",N,/\s+/,[],!0),priority:S.getEnum("Priority",j,j.Normal,!0)};let D=this.ini.getSection("SoundList");var O,L;if(D)for(O of new Set(D.entries.values()))O&&((L=this.ini.getSection(O))?this.specs.set(O,(new B.SoundSpec).read(L,this.defaults)):console.warn(`Missing sound section [${O}]`));else console.warn("Missing sound [SoundList] section. Sounds will not be played.")}else console.warn("Missing sound [Defaults] section. Sounds will not be played.")}getSpec(S){return this.specs.get(S)}getAll(){return[...this.specs.values()]}})}}}),System.register("engine/sound/WorldSound",["engine/sound/SoundKey","engine/sound/ChannelType","engine/sound/SoundSpecs","util/math","util/geometry","game/map/MapShroud","game/Coords","util/typeGuard"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){S("WorldSound",H=class e{constructor(S,O,B,N,j,L,F,_){this.sound=S,this.localPlayer=O,this.shroud=B,this.worldViewportHelper=N,this.mapTileIntersectHelper=j,this.world=L,this.worldScene=F,this.renderer=_,this.soundInstances=[],this.handleObjectRemoved=S=>{this.soundInstances.forEach(O=>{O.gameObject===S&&O.handle.stop()})},this.handleFrame=S=>{let O=!1;this.lastViewport&&D.rectEquals(this.worldScene.viewport,this.lastViewport)||(this.lastViewport=this.worldScene.viewport,O=!0),(!this.lastUpdate||200<=S-this.lastUpdate)&&(O=!0),O&&(this.update(),this.lastUpdate=S)},this.noShroudSpecs=e.noShroudKeys.map(S=>{var O=this.sound.getSoundSpec(S);if(O)return O;console.warn(`Sound key "${S}" doesn't have a corresponding sound.ini entry`)}).filter(U.isNotNullOrUndefined)}init(){this.renderer.onFrame.subscribe(this.handleFrame),this.world.onObjectRemoved.subscribe(this.handleObjectRemoved)}changeLocalPlayer(S,O){this.localPlayer=S,this.shroud=O}dispose(){this.renderer.onFrame.unsubscribe(this.handleFrame),this.world.onObjectRemoved.unsubscribe(this.handleObjectRemoved),this.soundInstances.forEach(S=>S.handle.stop())}update(){var S=this.mapTileIntersectHelper.getTileAtScreenPoint({x:this.worldScene.viewport.x+this.worldScene.viewport.width/2,y:this.worldScene.viewport.y+this.worldScene.viewport.height/2});if(S){this.tileAtViewportCenter=S,this.cleanOldInstances();let N=new Map;for(var O of this.soundInstances){var B=O.gameObject?.position.worldPosition??O.worldPos;let{volume:S,pan:j}=this.computeVolumeAndPan(O.spec,B,O.player,O.gain);0<S&&(B=N.get(O.spec)??0,O.loop&&B>=O.spec.limit?S=0:N.set(O.spec,B+1)),O.handle.setVolume(S),O.handle.setPan(j),O.volume=S}}else console.warn("No tile found at viewport center. Can't update local sound positions.")}cleanOldInstances(){this.soundInstances=this.soundInstances.filter(S=>S.handle.isPlaying())}playEffect(S,O,B,L=1,D){let F=this.sound.getSoundSpec(S);if(F&&(!F.type.includes(j.SoundType.Player)||B===this.localPlayer)){let S,V;O.position?(S=O.position.worldPosition,V=O):S=O;var _=F.control.has(j.SoundControl.Loop)||F.control.has(j.SoundControl.Ambient),U=_?F.loop||Number.POSITIVE_INFINITY:0;_&&void 0!==D&&(L=D);let{volume:W,pan:z}=this.computeVolumeAndPan(F,S,B,L),K=F.limit;if(_&&F.limit&&(K=0,this.cleanOldInstances(),this.soundInstances.filter(S=>S.spec===F&&0<S.volume).length>=F.limit&&(W=0)),_||W||!F.limit){var H=F.control.has(j.SoundControl.Ambient)||F.name.startsWith("_Amb_")?N.ChannelType.Ambient:N.ChannelType.Effect;return(U=this.sound.playWithOptions(F,H,W,z,K,U))&&this.soundInstances.push({spec:F,gameObject:V,worldPos:S,player:B,handle:U,gain:L,volume:W,loop:_}),U}}}computeVolumeAndPan(S,O,B,N=1){let D=S.volume/100,U=0;var H,V,W;return S.type.includes(j.SoundType.Global)&&B!==this.localPlayer&&(D=S.minVolume/100),D*=N,(S.type.includes(j.SoundType.Screen)||S.type.includes(j.SoundType.Global))&&(H=this.worldViewportHelper.distanceToViewportCenter(O),U=L.clamp(H.x/(this.worldScene.viewport.width/2),-1,1)),S.type.includes(j.SoundType.Screen)?(V=this.worldViewportHelper.distanceToViewport(O),W=(this.worldScene.viewport.height+this.worldScene.viewport.width)/2/3,D*=THREE.Math.lerp(1,0,Math.min(1,V/W))):S.type.includes(j.SoundType.Local)&&(this.tileAtViewportCenter?(V=new THREE.Vector2(O.x/_.Coords.LEPTONS_PER_TILE-this.tileAtViewportCenter.rx,O.z/_.Coords.LEPTONS_PER_TILE-this.tileAtViewportCenter.ry).length(),(W=S.range*Math.SQRT2)<V?D=0:(S.vShift&&(D*=L.getRandomInt(S.vShift.min,S.vShift.max)/100),D*=1-Math.min(1,(V/W)**2))):D=0),this.noShroudSpecs.includes(S)&&!S.type.includes(j.SoundType.Global)&&this.shroud?.getShroudTypeByTileCoords(Math.floor(O.x/_.Coords.LEPTONS_PER_TILE),Math.floor(O.z/_.Coords.LEPTONS_PER_TILE),Math.floor(_.Coords.worldToTileHeight(O.y)))===F.ShroudType.Unexplored&&(D=0),{volume:D,pan:U}}}),H.noShroudKeys=[B.SoundKey.BuildingSlam,B.SoundKey.SellSound,B.SoundKey.BuildingGarrisonedSound,B.SoundKey.BuildingRepairedSound,B.SoundKey.SpySatActivationSound,B.SoundKey.SpySatDeactivationSound]}}}),System.register("engine/type/LightingType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("LightingType",B={}))[O.None=0]="None",O[O.Global=1]="Global",O[O.Level=2]="Level",O[O.Ambient=3]="Ambient",O[O.Full=4]="Full",O[O.Default=5]="Default"}}}),System.register("engine/type/ObjectType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("ObjectType",B={}))[O.None=0]="None",O[O.Aircraft=1]="Aircraft",O[O.Building=2]="Building",O[O.Infantry=3]="Infantry",O[O.Overlay=4]="Overlay",O[O.Smudge=5]="Smudge",O[O.Terrain=6]="Terrain",O[O.Vehicle=7]="Vehicle",O[O.Animation=8]="Animation",O[O.Projectile=9]="Projectile",O[O.VoxelAnim=10]="VoxelAnim",O[O.Debris=11]="Debris"}}}),System.register("engine/type/OverlayTibType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("OverlayTibType",B={}))[O.NotSpecial=0]="NotSpecial",O[O.Riparius=1]="Riparius",O[O.Cruentus=2]="Cruentus",O[O.Vinifera=4]="Vinifera",O[O.Aboreus=8]="Aboreus",O[O.Ore=1]="Ore",O[O.Gems=2]="Gems",O[O.All=15]="All"}}}),System.register("engine/type/PaletteType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("PaletteType",B={}))[O.None=0]="None",O[O.Iso=1]="Iso",O[O.Unit=2]="Unit",O[O.Overlay=3]="Overlay",O[O.Anim=4]="Anim",O[O.Custom=5]="Custom",O[O.Default=6]="Default"}}}),System.register("engine/type/PointerType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("PointerType",B={}))[O.Default=0]="Default",O[O.Mini=1]="Mini",O[O.Scroll=2]="Scroll",O[O.NoScroll=10]="NoScroll",O[O.Select=18]="Select",O[O.Move=31]="Move",O[O.NoMove=41]="NoMove",O[O.MoveMini=42]="MoveMini",O[O.NoActionMini=52]="NoActionMini",O[O.AttackRange=53]="AttackRange",O[O.AttackNoRange=58]="AttackNoRange",O[O.AttackMini=63]="AttackMini",O[O.Guard=68]="Guard",O[O.GuardMini=73]="GuardMini",O[O.Unknown1=78]="Unknown1",O[O.Unknown2=88]="Unknown2",O[O.Occupy=89]="Occupy",O[O.NoOccupy=99]="NoOccupy",O[O.OccupyMini=100]="OccupyMini",O[O.Deploy=110]="Deploy",O[O.NoDeploy=119]="NoDeploy",O[O.Unknown3=120]="Unknown3",O[O.Sell=129]="Sell",O[O.SellMini=139]="SellMini",O[O.NoSell=149]="NoSell",O[O.RepairMove=150]="RepairMove",O[O.SideRepair=170]="SideRepair",O[O.NoRepair=190]="NoRepair",O[O.Unknown4=191]="Unknown4",O[O.Unknown5=199]="Unknown5",O[O.Dynamite=204]="Dynamite",O[O.Unknown6=209]="Unknown6",O[O.Unknown7=214]="Unknown7",O[O.Unknown8=219]="Unknown8",O[O.Unknown9=224]="Unknown9",O[O.Unknown10=229]="Unknown10",O[O.Unknown11=234]="Unknown11",O[O.Unknwon12=239]="Unknwon12",O[O.Unknown13=249]="Unknown13",O[O.Para=259]="Para",O[O.Unknown14=269]="Unknown14",O[O.Storm=279]="Storm",O[O.EngineerDamage=299]="EngineerDamage",O[O.C4=309]="C4",O[O.Nuke=319]="Nuke",O[O.Unknown16=329]="Unknown16",O[O.Power=339]="Power",O[O.Unknown17=345]="Unknown17",O[O.Iron=346]="Iron",O[O.Unknown18=351]="Unknown18",O[O.Unknown19=356]="Unknown19",O[O.Chrono=357]="Chrono",O[O.DefuseBomb=369]="DefuseBomb",O[O.NoAction=384]="NoAction",O[O.Pan=385]="Pan",O[O.Unknown21=394]="Unknown21",O[O.AttackMove=404]="AttackMove",O[O.Unknown23=413]="Unknown23",O[O.Unknown24=422]="Unknown24",O[O.Unknown25=431]="Unknown25",O[O.Unknown26=432]="Unknown26",O[O.Unknown27=433]="Unknown27",O[O.Unknown28=434]="Unknown28",O[O.Beacon=435]="Beacon"}}}),System.register("engine/type/TerrainType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("TerrainType",B={}))[O.Default=0]="Default",O[O.Tunnel=5]="Tunnel",O[O.Railroad=6]="Railroad",O[O.Rock1=7]="Rock1",O[O.Rock2=8]="Rock2",O[O.Water=9]="Water",O[O.Shore=10]="Shore",O[O.Pavement=11]="Pavement",O[O.Dirt=12]="Dirt",O[O.Clear=13]="Clear",O[O.Rough=14]="Rough",O[O.Cliff=15]="Cliff"}}}),System.register("engine/type/TiberiumType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("TiberiumType",B={}))[O.Riparius=0]="Riparius",O[O.Cruentus=1]="Cruentus",O[O.Vinifera=2]="Vinifera",O[O.Aboreus=3]="Aboreus",O[O.Ore=0]="Ore",O[O.Gems=1]="Gems"}}}),System.register("engine/util/EntityIntersectHelper",["util/geometry"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("EntityIntersectHelper",class{constructor(S,O,B,N,j,L){this.map=S,this.renderableManager=O,this.mapTileIntersectHelper=B,this.raycastHelper=N,this.scene=j,this.worldViewportHelper=L}getEntitiesAtScreenBox(S){let O=this.renderableManager.getRenderableContainer();if(!O)return[];let B=this.collectIntersectTargets(O.get3DObject()),N=new Set;return B.forEach(S=>N.add(this.renderableManager.getRenderableById(this.findRenderableId(S)))),[...N].filter(O=>this.worldViewportHelper.intersectsScreenBox(O.gameObject.position.worldPosition,S))}getEntityAtScreenPoint(S){var O=this.scene.viewport;if(B.rectContainsPoint(O,S)){let B=this.renderableManager.getRenderableContainer();if(B){var N=this.collectIntersectTargets(B.get3DObject());let j=this.raycastHelper.intersect(S,N,!1);if(j.length){let B=j.map(S=>({renderable:this.renderableManager.getRenderableById(this.findRenderableId(S.object)),point:S.point}));if(O=B.find(S=>S.renderable.gameObject.isUnit()),O)return O;if(N=B.find(S=>S.renderable.gameObject.isBuilding()&&S.renderable.getIntersectTarget?.()),!N)return B[0];if((O=this.mapTileIntersectHelper.getTileAtScreenPoint(S))&&(O=this.map.getObjectsOnTile(O).find(S=>{if(!S.isBuilding())return!1;let O=this.renderableManager.getRenderableByGameObject(S);return void 0!==O.getIntersectTarget?.()}),O))return{renderable:this.renderableManager.getRenderableByGameObject(O),point:N.point}}}}}collectIntersectTargets(S){let O=[];if(!S.visible)return O;if(void 0!==S.userData.id){let N=this.renderableManager.getRenderableById(S.userData.id);if(!N)throw new Error(`Entity not found (id = "${S.userData.id}")`);var B;N.gameObject.isDestroyed||N.gameObject.isCrashing||(B=N.getIntersectTarget?.(),Array.isArray(B)?O.push(...B):B&&O.push(B))}return S.children.forEach(S=>{S.visible&&O.push(...this.collectIntersectTargets(S))}),O}findRenderableId(S){let O;for(;O=S.userData.id,S=S.parent,void 0===O&&S.parent;);if(void 0===O)throw new Error("No attached renderable ID found for Object3D.");return O}})}}}),System.register("engine/util/MapPanningHelper",["engine/IsoCoords"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("MapPanningHelper",class{constructor(S){this.map=S}computeCameraPanFromTile(S,O){var N=this.map.tiles.getByMapCoords(S,O)??this.map.tiles.getPlaceholderTile(S,O);return N=B.IsoCoords.tile3dToScreen(S+.5,O+.5,N.z),this.computeCameraPanFromScreen(N)}computeCameraPanFromWorld(S){var O=B.IsoCoords.vecWorldToScreen(S);return this.computeCameraPanFromScreen(O)}computeCameraPanFromScreen(S){var O=this.getScreenPanOrigin();return{x:Math.floor(S.x-O.x),y:Math.floor(S.y-O.y)}}getScreenPanOrigin(){return B.IsoCoords.worldToScreen(0,0)}computeCameraPanLimits(S,O){var B=this.getScreenPanOrigin();return{x:Math.ceil(O.x-B.x+S.width/2),y:Math.ceil(O.y-B.y+S.height/2-1),width:O.width-S.width-1,height:O.height-S.height-1}}})}}}),System.register("engine/util/MapTileIntersectHelper",["util/geometry","game/Coords","engine/IsoCoords"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("MapTileIntersectHelper",class{constructor(S,O){this.map=S,this.scene=O}getTileAtScreenPoint(S){var O=this.scene.viewport;if(B.rectContainsPoint(O,S))return(O=this.intersectTilesByScreenPos(S)).length?O[0]:void 0}intersectTilesByScreenPos(S){var O=j.IsoCoords.worldToScreen(0,0),B=this.scene.cameraPan.getPan(),L=(O={x:S.x+O.x+B.x-this.scene.viewport.width/2,y:S.y+O.y+B.y-this.scene.viewport.height/2},B=j.IsoCoords.screenToWorld(O.x,O.y),B=new THREE.Vector2(B.x,B.y).multiplyScalar(1/N.Coords.LEPTONS_PER_TILE).floor(),this.map.tiles.getByMapCoords(B.x,B.y));if(!L)return console.warn(`Tile coordinates (${B.x},${B.y}) out of range`),[];let D=[];var F;for(let S=0;S<30;S++)for(F of[{x:L.rx+S,y:L.ry+S},{x:L.rx+S+1,y:L.ry+S},{x:L.rx+S,y:L.ry+S+1}]){var _={x:F.x,y:F.y};(_=this.map.tiles.getByMapCoords(_.x,_.y))&&D.push(_)}let U=[],H=new THREE.Triangle;var V,W=new THREE.Vector3(O.x,0,O.y);for(V of D){var z=j.IsoCoords.tile3dToScreen(V.rx,V.ry,V.z),K=j.IsoCoords.tile3dToScreen(V.rx,V.ry+1.1,V.z),$=j.IsoCoords.tile3dToScreen(V.rx+1.1,V.ry,V.z),q=j.IsoCoords.tile3dToScreen(V.rx+1.1,V.ry+1.1,V.z);H.b.x=K.x,H.b.z=K.y,H.c.x=$.x,H.c.z=$.y,H.a.x=z.x,H.a.z=z.y,z=H.containsPoint(W),H.a.x=q.x,H.a.z=q.y,q=H.containsPoint(W),(z||q)&&U.unshift(V)}for(;!U.length;)U=this.intersectTilesByScreenPos({x:S.x,y:S.y-j.IsoCoords.tileHeightToScreen(1)});return U}})}}}),System.register("engine/util/RaycastHelper",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("RaycastHelper",class{constructor(S){this.scene=S}intersect(S,O,B=!1){let N=new THREE.Raycaster;var j=this.normalizePointer(S,this.scene.viewport);return N.setFromCamera(j,this.scene.camera),N.intersectObjects(O,B)}normalizePointer(S,O){return{x:(S.x-O.x)/O.width*2-1,y:-(S.y-O.y)/O.height*2+1}}})}}}),System.register("engine/util/WorldViewportHelper",["engine/IsoCoords"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("WorldViewportHelper",class{constructor(S){this.scene=S}distanceToViewport(S){var O=this.scene.viewport;return O=new THREE.Box2(new THREE.Vector2(O.x,O.y),new THREE.Vector2(O.x+O.width-1,O.x+O.height-1)),this.distanceToScreenBox(S,O)}distanceToScreenBox(S,O){var N=B.IsoCoords.vecWorldToScreen(S),j=B.IsoCoords.worldToScreen(0,0),L=this.scene.cameraPan.getPan();return O.distanceToPoint(new THREE.Vector2(N.x-j.x-L.x+this.scene.viewport.width/2,N.y-j.y-L.y+this.scene.viewport.height/2))}distanceToViewportCenter(S){var O=B.IsoCoords.vecWorldToScreen(S),N=B.IsoCoords.worldToScreen(0,0),j=this.scene.cameraPan.getPan(),L=this.scene.viewport;return new THREE.Vector2(O.x-N.x-j.x+this.scene.viewport.width/2,O.y-N.y-j.y+this.scene.viewport.height/2).sub(new THREE.Vector2(L.x+L.width/2,L.y+L.height/2))}intersectsScreenBox(S,O){return 0===this.distanceToScreenBox(S,O)}})}}}),System.register("game/Alliances",["util/math"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S}],execute:function(){var O;N=class{constructor(S,O){this.first=S,this.second=O}has(S){return this.first===S||this.second===S}equals(S){return this.first===S.first&&this.second===S.second||this.first===S.second&&this.second===S.first}},(O=j||S("AllianceStatus",j={}))[O.Requested=0]="Requested",O[O.Formed=1]="Formed",S("Alliances",class{constructor(S){this.playerList=S,this.alliances=[]}findByPlayers(S,O){let B=new N(S,O);return this.alliances.find(S=>S.players.equals(B))}filterByPlayer(S){return this.alliances.filter(O=>O.players.first===S||O.players.second===S)}request(S,O){if(!this.canRequestAlliance(O))throw new Error(`Player ${O.name} is not a human combatant.`);if(this.canFormAlliance(S,O)){if(this.findByPlayers(S,O))throw new Error(`Can't request alliance because an alliance is already pending or formed between ${S.name} and ${O.name}.`);return this.setAlliance(S,O,j.Requested)}}cancelRequest(S,O){var B=this.findByPlayers(S,O);if(!B||B.status!==j.Requested)throw new Error(`There is no pending alliance request for player ${O.name} from player `+S.name);if(B.players.first!==S)throw new Error(`Can't cancel request initiated by the other player (${O.name})`);this.alliances.splice(this.alliances.indexOf(B),1)}acceptRequest(S,O){if(this.canFormAlliance(S,O)){let B=this.findByPlayers(S,O);if(!B||B.status!==j.Requested)throw new Error(`There is no pending alliance request for player ${O.name} from player `+S.name);if(B.players.first!==S)throw new Error("Can't accept own alliance request for player "+O.name);B.status=j.Formed}}setAlliance(S,O,B){if(!this.canFormAlliance(S,O))throw new Error(`Can't form alliance between players "${S.name}" and "${O.name}"`);var j;if(this.findByPlayers(S,O))throw new Error(`An alliance already exists between players ${S.name} and `+O.name);return j={players:new N(S,O),status:B},this.alliances.push(j),j}breakAlliance(S,O){var B=this.findByPlayers(S,O);if(!B||B.status!==j.Formed)throw new Error(`There is no alliance between player ${S.name} and player `+O.name);this.alliances.splice(this.alliances.indexOf(B),1)}areAllied(S,O){var B=this.findByPlayers(S,O);return!!B&&B.status===j.Formed}getAllies(S){return this.filterByPlayer(S).filter(S=>S.status===j.Formed).map(O=>O.players.first===S?O.players.second:O.players.first)}haveSharedIntel(S,O){return S.isObserver||O.isObserver||S===O||this.areAllied(S,O)}canRequestAlliance(S){return S.isCombatant()&&!S.isAi}canFormAlliance(S,O){let B=this.getHostilePlayers();if(0===B.filter(B=>B.has(S)&&!B.has(O)).length)return!1;if(0===B.filter(B=>B.has(O)&&!B.has(S)).length)return!1;let j=new N(S,O);return!!B.filter(S=>!S.equals(j)).length}getHostilePlayers(){var S,O=this.playerList.getCombatants();let B=[];for(let j=0;j<O.length;j++)for(let L=j+1;L<O.length;L++)this.getAllies(O[j]).includes(O[L])||(S=new N(O[j],O[L]),B.push(S));return B}getHash(){return B.fnv32a(this.alliances.map(S=>[this.playerList.getPlayerNumber(S.players.first),this.playerList.getPlayerNumber(S.players.second),S.status]).flat())}debugGetState(){return this.alliances.map(S=>({first:S.players.first,second:S.players.second,status:S.status}))}})}}}),System.register("game/AttackerInfo",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/BotManager",["util/disposable/CompositeDisposable","util/Logger","game/action/ActionQueue","game/api/ActionsApi","game/api/EventsApi","game/api/GameApi","game/api/LoggerApi","game/api/ProductionApi"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){S("BotManager",class{static factory(S,O,B,N){return new this(S,new j.ActionQueue,O,B,N)}constructor(S,O,N,j,L){this.actionFactory=S,this.actionQueue=O,this.botFactory=N,this.botDebugIndex=j,this.actionLogger=L,this.bots=new Map,this.disposables=new B.CompositeDisposable}init(S){this.gameApi=new F.GameApi(S,!0);let O=new D.EventsApi(S.events);var B,j;for(B of S.getCombatants().filter(S=>S.isAi))this.bots.set(B,this.botFactory.create(B));this.updateDebugBotIndex(this.botDebugIndex.value,S);let h=O=>this.updateDebugBotIndex(O,S);for(j of(this.botDebugIndex.onChange.subscribe(h),this.disposables.add(()=>this.botDebugIndex.onChange.unsubscribe(h)),O.subscribe(S=>this.bots.forEach(O=>O.onGameEvent(S,this.gameApi))),this.disposables.add(O),this.bots.values()))j.setGameApi(this.gameApi),j.setActionsApi(new L.ActionsApi(S,this.actionFactory,this.actionQueue,j)),j.setProductionApi(new U.ProductionApi(S.getPlayerByName(j.name).production)),j.setLogger(new _.LoggerApi(N.AppLogger.get(j.name),this.gameApi)),j.onGameStart(this.gameApi)}update(S){var O,B;for(O of this.actionQueue.dequeueAll()){O.process();var N=O.print();N&&this.actionLogger.debug(`(${O.player.name})@${S.currentTick}: `+N)}for(B of S.getCombatants().filter(S=>S.isAi))this.bots.get(B).onGameTick(this.gameApi)}updateDebugBotIndex(S,O){var B,N=0<S?O.getAiPlayerName(S):void 0;for(B of this.bots.values())B.setDebugMode(B.name===N)}dispose(){this.gameApi=void 0,this.bots.clear(),this.disposables.dispose()}})}}}),System.register("game/ConstructionWorker",["util/geometry","engine/type/ObjectType","game/type/SpeedType","game/gameobject/task/morph/PackBuildingTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","util/disposable/CompositeDisposable","game/event/EventType","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S}],execute:function(){S("ConstructionWorker",class{constructor(S,O,B,N,j){this.player=S,this.rules=O,this.art=B,this.map=N,this.game=j,this.adjacencyMaps=new Map,this.disposables=new _.CompositeDisposable;let a=({object:S})=>{S.isBuilding()&&this.adjacencyMaps.clear()};this.map.tileOccupation.onChange.subscribe(a),this.disposables.add(()=>this.map.tileOccupation.onChange.unsubscribe(a)),this.disposables.add(this.game.events.subscribe(U.EventType.AllianceChange,()=>this.adjacencyMaps.clear()),this.game.events.subscribe(U.EventType.ObjectOwnerChange,S=>{S.target.isBuilding()&&this.adjacencyMaps.clear()}),this.game.events.subscribe(U.EventType.ObjectDestroy,S=>{S.target.isBuilding()&&S.target.rules.leaveRubble&&this.adjacencyMaps.clear()}))}getAdjacentRect(S,O,B){return{x:S.rx-B,y:S.ry-B,width:O.width+2*B,height:O.height+2*B}}getAdjacencyMap(S){var O;let B=[];for(O of[...this.player.buildings,...this.game.gameOpts.buildOffAlly?this.game.alliances.getAllies(this.player).map(S=>[...S.buildings].filter(S=>S.rules.eligibileForAllyBuilding)).flat():[]])O.rules.baseNormal&&B.push(this.getAdjacentRect(O.tile,O.art.foundation,S));return B}meetsAdjacency(S,O){let N=this.adjacencyMaps.get(O);for(var j of(N||(N=this.getAdjacencyMap(O),this.adjacencyMaps.set(O,N)),N))if(B.rectIntersect(S,j))return!0;return!1}getPlacementPreview(S,O,B={}){var{normalizedTile:j=!1,ignoreObjects:L,ignoreAdjacent:D=!1}=B,F=this.rules.getBuilding(S),_=this.art.getObject(S,N.ObjectType.Building);let U=[];var H=_.foundation,V=j?O:this.normalizePlacementTileCoords(_,O);let W=!0;_={x:V.rx,y:V.ry,width:H.width,height:H.height},F.constructionYard||D||this.meetsAdjacency(_,F.adjacent)||(W=!1);for(let S=0;S<H.width;S++)for(let O=0;O<H.height;O++){var z={x:V.rx+S,y:V.ry+O},K=this.map.tiles.getByMapCoords(z.x,z.y);K&&U.push({rx:z.x,ry:z.y,buildable:W&&this.isTileBuildable(K,F,L)})}return F.wall&&U[0].buildable&&this.getWallConnectingTiles(V,F).forEach(S=>{U.push({rx:S.rx,ry:S.ry,buildable:!0})}),U}canPlaceAt(S,O,B={}){var{normalizedTile:j=!1,ignoreObjects:L,ignoreAdjacent:D=!1}=B,F=this.rules.getBuilding(S),_=(H=this.art.getObject(S,N.ObjectType.Building)).foundation,U=j?O:this.normalizePlacementTileCoords(H,O),H={x:U.rx,y:U.ry,width:_.width,height:_.height};if(!F.constructionYard&&!D&&!this.meetsAdjacency(H,F.adjacent))return!1;for(let S=0;S<_.width;S++)for(let O=0;O<_.height;O++){var V={x:U.rx+S,y:U.ry+O};if(!(V=this.map.tiles.getByMapCoords(V.x,V.y))||!this.isTileBuildable(V,F,L))return!1}return!0}placeAt(S,O,B=!1){let N=[],j=this.rules.getBuilding(S),L=B?O:this.normalizePlacementTile(S,O);if(j.wall){let S=[[L,j]],O=this.getWallConnectingTiles(L,j);for(var D of(O.forEach(O=>{O!==L&&S.push([O,j])}),S))N.push(this.executePlacement(D[0],D[1]))}else{var F,_=this.executePlacement(L,j);for(F of(N.push(_),this.map.tileOccupation.calculateTilesForGameObject(L,_))){var U=this.map.getObjectsOnTile(F).find(S=>S.isSmudge());U&&this.game.unspawnObject(U)}}return N}normalizePlacementTileCoords(S,O){var B=S.foundationCenter;return{rx:O.rx-B.x,ry:O.ry-B.y}}normalizePlacementTile(S,O){var B=this.art.getObject(S,N.ObjectType.Building),j=this.normalizePlacementTileCoords(B,O);if(!(B=this.map.tiles.getByMapCoords(j.rx,j.ry)))throw new Error(`Can't build outside map (${j.rx}, ${j.ry})`);return B}unplace(S,O){S.unitOrderTrait.cancelAllTasks(),S.unitOrderTrait.addTasks(new F.TaskGroup(new L.PackBuildingTask(this.game),new D.CallbackTask(()=>{this.game.unspawnObject(S),O()})).setCancellable(!1)),S.unitOrderTrait[H.NotifyTick.onTick](S,this.game)}executePlacement(S,O){let B=this.game.createObject(N.ObjectType.Building,O.name);return this.game.changeObjectOwner(B,this.player),B.purchaseValue=this.game.sellTrait.computePurchaseValue(O,this.player),this.game.spawnObject(B,S),B}getWallConnectingTiles(S,O){var B,N=O.guardRange+1;let j=[];for(B of[[0,1],[0,-1],[1,0],[-1,0]]){let D=[];for(let F=0;F<N;++F){var L={x:S.rx+B[0]*F,y:S.ry+B[1]*F};if(!(L=this.map.tiles.getByMapCoords(L.x,L.y)))break;if(this.map.getObjectsOnTile(L).find(S=>S.isBuilding()&&S.name===O.name&&S.owner===this.player)){j=j.concat(D);break}if(!this.isTileBuildable(L,O))break;D.push(L)}}return j}isTileBuildable(S,O,B){return!!this.map.isWithinBounds(S)&&!this.game.mapShroudTrait.getPlayerShroud(this.player)?.isShrouded(S)&&!this.map.getGroundObjectsOnTile(S).some(S=>!(B?.includes(S)||S.isBuilding()&&S.rules.invisibleInGame||S.isSmudge()))&&(O.waterBound?0<this.rules.getLandRules(S.landType).getSpeedModifier(j.SpeedType.Float):0===S.rampType&&this.rules.getLandRules(S.landType).buildable)}dispose(){this.disposables.dispose()}})}}}),System.register("game/Coords",["game/math/GameMath","game/math/Vector2","game/math/Vector3"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("Coords",L=class e{static tileToWorld(S,O){return{x:S*e.LEPTONS_PER_TILE,y:O*e.LEPTONS_PER_TILE}}static vecWorldToGround(S){return new N.Vector2(S.x,S.z)}static vecGroundToWorld(S){return new j.Vector3(S.x,0,S.y)}static tileHeightToWorld(S){return S*(e.LEPTONS_PER_TILE/2)*e.zScale}static worldToTileHeight(S){return S/(e.LEPTONS_PER_TILE/2*e.zScale)}static tile3dToWorld(S,O,B){var N=e.tileToWorld(S,O),L=e.tileHeightToWorld(B);return new j.Vector3(N.x,L,N.y)}static screenDistanceToWorld(S,O){return{x:Math.floor((S+2*O)/2*e.ISO_WORLD_SCALE),y:Math.floor((2*O-S)/2*e.ISO_WORLD_SCALE)}}static getWorldTileSize(){return e.LEPTONS_PER_TILE}}),L.ISO_TILE_SIZE=30,L.LEPTONS_PER_TILE=256,L.ISO_WORLD_SCALE=L.LEPTONS_PER_TILE/L.ISO_TILE_SIZE,L.ISO_CAMERA_ALPHA=Math.PI/6,L.ISO_CAMERA_BETA=Math.PI/4,L.COS_ISO_CAMERA_BETA=B.GameMath.cos(L.ISO_CAMERA_BETA),L.zScale=L.COS_ISO_CAMERA_BETA/B.GameMath.cos(L.ISO_CAMERA_ALPHA)}}}),System.register("game/CountdownTimer",["game/event/TimerExpireEvent","game/GameSpeed"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("CountdownTimer",class{constructor(){this.ticks=0,this.running=!1}getSeconds(){return Math.floor(this.ticks/N.GameSpeed.BASE_TICKS_PER_SECOND)}setSeconds(S){this.ticks=Math.max(0,Math.floor(N.GameSpeed.BASE_TICKS_PER_SECOND*S))}addSeconds(S){this.ticks=Math.max(0,this.ticks+Math.floor(N.GameSpeed.BASE_TICKS_PER_SECOND*S))}start(){this.running=!0}stop(){this.running=!1}isRunning(){return this.running}update(S){this.running&&(0<this.ticks?this.ticks--:(this.running=!1,S.events.dispatch(new B.TimerExpireEvent(this))))}})}}}),System.register("game/Country",["engine/type/ObjectType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("Country",class{static factory(S,O){return new this(O.getCountry(S))}constructor(S){this.rules=S}get id(){return this.rules.id}get side(){return this.rules.side}get name(){return this.rules.name}isPlayable(){return this.rules.multiplay&&!this.rules.multiplayPassive}hasVeteranUnit(S,O){let N=[];switch(S){case B.ObjectType.Aircraft:N=this.rules.veteranAircraft;break;case B.ObjectType.Infantry:N=this.rules.veteranInfantry;break;case B.ObjectType.Vehicle:N=this.rules.veteranUnits;break;default:throw new Error(`Unsupported object type "${B.ObjectType[S]}"`)}return N.includes(O)}})}}}),System.register("game/Game",["game/ConstructionWorker","game/gameopts/GameOpts","engine/type/ObjectType","util/event","game/map/OreSpread","game/gameobject/Infantry","game/Alliances","util/BoxedVar","game/StartingUnitsGenerator","game/map/tileFinder/CardinalTileFinder","game/type/SpeedType","game/Target","game/map/BridgeOverlayTypes","util/math","game/GameEventBus","game/event/ObjectDestroyEvent","game/event/PlayerDefeatedEvent","game/ini/GameModeType","game/Traits","game/trait/interface/NotifyTick","game/trait/interface/NotifyDestroy","game/trait/interface/NotifySpawn","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyOwnerChange","game/event/ObjectOwnerChangeEvent","game/event/ObjectUnspawnEvent","game/trait/interface/NotifyTargetDestroy","game/gameobject/unit/VeteranLevel","game/event/ObjectSpawnEvent","engine/type/OverlayTibType","game/map/OreOverlayTypes","game/Weapon","game/GameSpeed","game/gameobject/common/DeathType","game/map/Bridges","game/SuperWeapon","game/event/AllianceChangeEvent","game/trait/interface/NotifyAllianceChange","game/gameopts/constants","game/gameobject/unit/ZoneType","game/Prng","game/trigger/TriggerManager","game/CountdownTimer","game/WeaponType","game/Warhead","game/trait/interface/NotifyObjectTraitAdd","game/event/RadarOnOffEvent"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,xe,Oe,Ae,Me;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S},function(S){ge=S},function(S){pe=S},function(S){me=S},function(S){fe=S},function(S){ye=S},function(S){Te=S},function(S){ve=S},function(S){be=S},function(S){Se=S},function(S){we=S},function(S){Ee=S},function(S){xe=S},function(S){Oe=S},function(S){Ae=S}],execute:function(){var O;(O=Me||S("GameStatus",Me={}))[O.NotStarted=0]="NotStarted",O[O.Started=1]="Started",O[O.Ended=2]="Ended",S("Game",class{get onEnd(){return this._onEnd.asEvent()}constructor(S,O,B,N,j,D,F,_,H,V,W,z,K,$,Q){this.updatableObjects=new Set,this.constructionWorkers=new Map,this.currentTick=0,this.currentTime=0,this.countdownTimer=new we.CountdownTimer,this._onEnd=new L.EventDispatcher,this.afterTickCallbacks=[],this.events=new q.GameEventBus,this.traits=new X.Traits,this.debugText=new U.BoxedVar(""),this.world=S,this.map=O,this.rules=B,this.art=N,this.ai=j,this.id=D,this.startTimestamp=F,this.prng=be.Prng.factory(D,F),this.gameOpts=_,this.gameModeType=H,this.playerList=V,this.unitSelection=W,this.alliances=z,this.desiredSpeed=new U.BoxedVar(de.GameSpeed.computeGameSpeed(_.gameSpeed)),this.speed=new U.BoxedVar(this.desiredSpeed.value),this.nextObjectId=K,this.objectFactory=$,this.botManager=Q,this.triggers=new Se.TriggerManager}addPlayer(S){this.playerList.addPlayer(S),this.constructionWorkers.set(S,this.createConstructionWorker(S))}getPlayer(S){return this.playerList.getPlayerAt(S)}getPlayerByName(S){return this.playerList.getPlayerByName(S)}getAiPlayerName(S){let O;return O="number"==typeof S?S:this.gameOpts.aiPlayers.indexOf(S),`@@AI${O+1}@@`}getPlayerNumber(S){return this.playerList.getPlayerNumber(S)}getCombatants(){return this.playerList.getCombatants()}getCivilianPlayer(){return this.playerList.getCivilian()}getAllPlayers(){return this.playerList.getAll()}getNonNeutralPlayers(){return this.playerList.getNonNeutral()}areFriendly(S,O){return S.owner===O.owner||this.alliances.areAllied(S.owner,O.owner)}getWorld(){return this.world}createConstructionWorker(S){return new B.ConstructionWorker(S,this.rules,this.art,this.map,this)}getConstructionWorker(S){var O=this.constructionWorkers.get(S);if(!O)throw new Error(`No construction worker found for player "${S.name}"`);return O}getUnitSelection(){return this.unitSelection}init(S){this.localPlayer=S,this.createMapObjects(),this.createPlayerInitialUnits(),this.map.terrain.computeAllPassabilityGraphs(),this.mapShroudTrait.init(this),this.crateGeneratorTrait.init(this),this.playerList.getAll().forEach(S=>S.credits=this.gameOpts.credits),this.rules.mpDialogSettings.alliesAllowed&&this.createInitialTeams()}start(){this.status=Me.Started,this.currentTick=0,this.currentTime=0,this.botManager.init(this),this.triggers.init(this)}createInitialTeams(){for(let j=0;j<this.gameOpts.maxSlots;j++){var S=[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].filter(S=>S?.teamId===j&&S.countryId!==Te.OBS_COUNTRY_ID).map(S=>N.isHumanPlayerInfo(S)?S.name:this.getAiPlayerName(S));if(1<S.length)for(let N=0;N<S.length-1;N++)for(let j=N+1;j<S.length;j++){var O=this.getPlayerByName(S[N]),B=this.getPlayerByName(S[j]);B=this.alliances.setAlliance(O,B,_.AllianceStatus.Formed),this.onAllianceChange(B,O,!0)}}}createMapObjects(){var S=this.rules.general.harvesterUnit.every(S=>!$.isBetween(this.rules.getObject(S,j.ObjectType.Vehicle).techLevel,0,this.rules.mpDialogSettings.techLevel)),O=this.map.getInitialMapObjects();this.createInitialMapTerrains(O.terrains,S),this.createInitialMapOverlays(O.overlays,S),this.createInitialMapSmudges(O.smudges),this.createInitialMapTechnos(O.technos)}createInitialMapTerrains(S,O){for(var B of S){var N,L,D=B.name;this.validateMapObjectRulesAndArt(D,j.ObjectType.Terrain)&&((N=this.map.tiles.getByMapCoords(B.rx,B.ry))?(L=this.rules.getObject(D,j.ObjectType.Terrain),O&&L.spawnsTiberium||(D=this.createObject(j.ObjectType.Terrain,D),this.spawnObject(D,N))):console.warn(`Invalid map object location (${B.rx},${B.ry})`,B))}}createInitialMapOverlays(S,O){let B=new Map,N=new Map;for(var L of S){var F=this.rules.getOverlayName(L.id);if(this.validateMapObjectRulesAndArt(F,j.ObjectType.Overlay)){let S=this.createObject(j.ObjectType.Overlay,F);S.overlayId=L.id,S.value=L.value;let U=L.rx,H=L.ry;S.isBridge()&&S.isHighBridge()&&(S.position.tileElevation=4,U+=S.isXBridge()?0:-1,H+=S.isXBridge()?-1:0);var _=this.map.tiles.getByMapCoords(U,H);if(_)if(S.rules.tiberium&&(F=he.OreOverlayTypes.getOverlayTibType(L.id),void 0!==(F=D.OreSpread.calculateOverlayId(F,_))&&F!==L.id&&(S.dispose(),S=this.createObject(j.ObjectType.Overlay,this.rules.getOverlayName(F)),S.overlayId=F,S.value=L.value)),K.BridgeOverlayTypes.isLowBridge(L.id))K.BridgeOverlayTypes.isBridgePlaceholder(L.id)||(B.set(_,L.value),1===L.value?N.set(_,S):S.dispose());else{if(S.isTiberium()){if(![ce.OverlayTibType.Ore,ce.OverlayTibType.Gems,ce.OverlayTibType.Vinifera].includes(he.OreOverlayTypes.getOverlayTibType(S.overlayId))){console.warn(`Found unsupported TS tiberium overlay ${S.overlayId} @${_.rx},${_.ry}. Skipping.`);continue}if(this.map.getObjectsOnTile(_).find(S=>S.isTerrain())){S.dispose();continue}}O&&S.isTiberium()?S.dispose():this.spawnObject(S,_)}else console.warn(`Invalid map object location (${U},${H})`,L),S.dispose()}}for(var[U,H]of N){var V=H.isXBridge(),W=this.map.tiles.getByMapCoords(U.rx+(V?0:-1),U.ry+(V?-1:0));V=this.map.tiles.getByMapCoords(U.rx+(V?0:1),U.ry+(V?1:0)),W&&V&&(0===B.get(W)||2===B.get(V))?(H.value=0,this.spawnObject(H,W)):(H.dispose(),console.warn(`Invalid bridge segment @${U.rx},${U.ry}. Skipping.`))}var z,$=[...N.keys()].filter(S=>this.map.bridges.getPieceAtTile(S)?.headType!==pe.BridgeHeadType.None),q=this.map.bridges.findMapHighBridgeHeadTiles();let Q=this.map.bridges.findBridgeSpecsForHeadTiles([...$,...q]);for(z of Q)for(var Z of this.map.bridges.findBridgePieces(z))Z.obj.bridgeTrait.bridgeSpec=z;q=Q.map(S=>this.map.bridges.findAllBridgeTiles(S)).flat();var Y,X=K.BridgeOverlayTypes.bridgePlaceholderIds[0],J=this.rules.getOverlayName(X);for(Y of q){let S=this.createObject(j.ObjectType.Overlay,J);S.overlayId=X,this.spawnObject(S,Y)}}createInitialMapSmudges(S){for(var O of S){var B=O.name,N=this.map.tiles.getByMapCoords(O.rx,O.ry);N?(B=this.createObject(j.ObjectType.Smudge,B),this.spawnObject(B,N)):console.warn(`Invalid map object location (${O.rx},${O.ry})`,O)}}createInitialMapTechnos(S){let O=new Map(this.playerList.getAll().filter(S=>!!S.country).map(S=>[S.country.name,S])),B=this.map.getTags();for(let D of S){var N=D.name;if(this.validateMapObjectRulesAndArt(N,D.type)){var j=this.map.tiles.getByMapCoords(D.rx,D.ry);if(j){var L=O.get(D.owner);if(L){if(L.isNeutral){let S=this.createObject(D.type,N);D.tag&&(S.tag=B.find(S=>S.id===D.tag)),S.healthTrait.health=D.health/256*100;let O=!1;if(!S.healthTrait.health){if(!S.isBuilding()||!S.rules.leaveRubble){S.dispose();continue}O=!0}if(D.isInfantry()||D.isVehicle()||D.isAircraft()){S.direction=(-D.direction/256*360+360)%360,D.isInfantry()&&(S.position.subCell=D.subCell);let O=!1;D.onBridge&&(void 0===j.onBridgeLandType?console.warn(`Cannot place unit "${D.name}" on a bridge because no bridge was found at ${j.rx}, `+j.ry):O=!0),S.onBridge=O,S.zone=ve.getZoneType(O?j.onBridgeLandType:j.landType),O&&(S.position.tileElevation+=this.map.tileOccupation.getBridgeOnTile(j)?.tileElevation??0),D.veterancy&&S.veteranTrait?.setRelativeXP(D.veterancy)}else S.poweredTrait?.setTurnedOn(D.poweredOn);this.changeObjectOwner(S,L),this.spawnObject(S,j),O&&this.destroyObject(S,void 0,!0)}}else console.warn(`Invalid owner "${D.owner}" for map object`,D)}else console.warn(`Invalid map object location (${D.rx},${D.ry})`,D)}}}validateMapObjectRulesAndArt(S,O){return this.rules.hasObject(S,O)?!!this.art.hasObject(S,O)||(console.warn(`Map object '${S}' has no art section. Skipping.`),!1):(console.warn(`Map object '${S}' has no rules section. Skipping.`),!1)}createPlayerInitialUnits(){let S=this.playerList.getCombatants().map(S=>S.country);var O=[...this.rules.infantryRules.values(),...this.rules.vehicleRules.values()].filter(O=>O.allowedToStartInMultiplayer&&!O.naval&&-1!==O.techLevel&&O.techLevel<=this.rules.mpDialogSettings.techLevel&&!this.rules.general.baseUnit.includes(O.name)&&S.some(S=>O.isAvailableTo(S)&&O.hasOwner(S)));for(let S of this.playerList.getCombatants()){var B=this.map.startingLocations[S.startLocation],N=this.map.tiles.getByMapCoords(B.x,B.y);let $=this.rules.general.baseUnit.find(O=>{let B=this.rules.getObject(O,j.ObjectType.Vehicle);return B.isAvailableTo(S.country)&&B.hasOwner(S.country)});if(!$)throw new Error("No suitable MCV found for player country "+S.country?.name);B=this.rules.getObject($,j.ObjectType.Vehicle),B=this.createUnitForPlayer(B,S),this.spawnObject(B,N);let q=H.StartingUnitsGenerator.generate(this.gameOpts.unitCount,[...this.rules.vehicleRules.keys()],O,S.country);var L,D,_;this.gameModeType===Y.GameModeType.Unholy&&q.push(...this.rules.general.baseUnit.filter(S=>S!==$).map(S=>({name:S,type:j.ObjectType.Vehicle,count:1})));let Q=[],Z=!1,X=new V.CardinalTileFinder(this.map.tiles,this.map.mapBounds,N,4,4,S=>!this.map.getGroundObjectsOnTile(S).find(S=>!(S.isSmudge()||S.isOverlay()&&S.isTiberium()))&&0<this.map.terrain.getPassableSpeed(S,W.SpeedType.Foot,!1,!1)),J=new Map,ee=0;for({name:L,type:D,count:_}of q){let O=_;for(;0<O;){let B;if(Z||(B=X.getNextTile(),B?Q.push(B):Z=!0),Z&&Q.length){var U=Q[ee];let S=J.get(U);S||(S=new V.CardinalTileFinder(this.map.tiles,this.map.mapBounds,U,1,0,S=>!this.map.getGroundObjectsOnTile(S).find(S=>!(S.isSmudge()||S.isOverlay()&&S.isTiberium()))&&0<this.map.terrain.getPassableSpeed(S,W.SpeedType.Foot,!1,!1)),J.set(U,S)),ee=(ee+1)%Q.length,B=S.getNextTile()}if(B){var z,K=this.rules.getObject(L,D);if(D===j.ObjectType.Vehicle)U=this.createUnitForPlayer(K,S),this.applyInitialVeteran(U,S),this.spawnObject(U,B),O--;else{if(D!==j.ObjectType.Infantry)throw new Error("Should not reach this line");for(z of F.Infantry.SUB_CELLS.slice(0,O)){let N=this.createUnitForPlayer(K,S);N.position.subCell=z,this.applyInitialVeteran(N,S),this.spawnObject(N,B),O--}}}else O--}}}}applyInitialVeteran(S,O){S.veteranTrait&&(this.rules.general.veteran.initialVeteran?S.veteranTrait.setVeteranLevel(oe.VeteranLevel.Elite):O.country.hasVeteranUnit(S.type,S.name)&&S.veteranTrait.setVeteranLevel(oe.VeteranLevel.Veteran))}createObject(S,O){return this.objectFactory.create(S,O,this.rules,this.art)}createUnitForPlayer(S,O){if(![j.ObjectType.Aircraft,j.ObjectType.Vehicle,j.ObjectType.Infantry].includes(S.type))throw new Error(`Attempted to create an invalid unit type "${S.type}"`);let B=this.createObject(S.type,S.name);return this.changeObjectOwner(B,O),B.purchaseValue=this.sellTrait.computePurchaseValue(B.rules,O),B}createProjectile(S,O,B,N,L){let D=this.createObject(j.ObjectType.Projectile,S);return D.fromWeapon=B,D.fromObject=O,D.fromPlayer=O.owner,D.target=N,D.isShrapnel=L,D}createLooseProjectile(S,O,B){var N=this.rules.getWeapon(S),L=N.projectile,D=this.rules.getProjectile(L),F=this.rules.getWarhead(N.warhead);F={minRange:0,projectileRules:D,range:Number.POSITIVE_INFINITY,rules:N,speed:ue.Weapon.computeSpeed(N,D),type:Ee.WeaponType.Primary,warhead:new xe.Warhead(F)};let _=this.createObject(j.ObjectType.Projectile,L);return _.fromWeapon=F,_.fromObject=void 0,_.fromPlayer=O,_.target=B,_}createSuperWeapon(S,O,B=!1){var N=this.rules.getSuperWeapon(S);return new me.SuperWeapon(S,N,O,B)}createTarget(S,O){return new z.Target(S,O,this.map.tileOccupation)}isValidTarget(S){if(S){if(!S.isSpawned||S.isCrashing)return!1;if(!(S.rules.legalTarget||S.isBuilding()&&S.rules.hospital))return!1;if(S.isBuilding()&&S.rules.invisibleInGame)return!1}return!0}spawnObject(S,O){if(S.isTechno()&&S.limboData)throw new Error(`Object ${S.name}#${S.id} is in limbo. Use unlimboObject instead or clear limboData first`);this.doSpawnObject(S,O)}unspawnObject(S){S.isTechno()&&S.owner&&S.owner.removeOwnedObject(S),this.doUnspawnObject(S)}limboObject(S,O){S.limboData=O,this.doUnspawnObject(S)}unlimboObject(S,O,B=!1){var N=S.limboData;if(!N)throw new Error(`Object ${S.name}#${S.id} has no limboData attached`);S.limboData=void 0,this.doSpawnObject(S,O);let j=this.getUnitSelection();N.selected&&!B&&j.addToSelection(S),void 0!==N.controlGroup&&j.addUnitsToGroup(N.controlGroup,[S],!1)}doSpawnObject(S,O){var B,N;S.position.tile=O,S.isBuilding()&&(N=S.art.foundationCenter,B=O.rx+N.x,N=O.ry+N.y,S.centerTile=this.map.tiles.getByMapCoords(B,N)??this.map.tiles.getPlaceholderTile(B,N)),this.world.spawnObject(S),(S.cachedTraits.tick.length||S.isProjectile()||S.isDebris()||S.isTechno())&&this.updatableObjects.add(S),S.isTechno()&&this.map.technosByTile.add(S),S.isProjectile()||S.isDebris()||this.map.tileOccupation.occupyTileRange(O,S),S.art.canHideThings&&this.map.tileOcclusion.addOccluder(S),S.onSpawn(this),this.traits.filter(te.NotifySpawn).forEach(O=>{O[te.NotifySpawn.onSpawn](S,this)}),this.events.dispatch(new le.ObjectSpawnEvent(S))}doUnspawnObject(S){var O=S.tile;S.isProjectile()||S.isDebris()||this.map.tileOccupation.unoccupyTileRange(O,S),S.art.canHideThings&&this.map.tileOcclusion.removeOccluder(S),S.isTechno()&&(this.unitSelection.cleanupUnit(S),this.map.technosByTile.remove(S)),this.world.removeObject(S),this.updatableObjects.delete(S),S.onUnspawn(this),this.traits.filter(ie.NotifyUnspawn).forEach(O=>{O[ie.NotifyUnspawn.onUnspawn](S,this)}),this.events.dispatch(new ne.ObjectUnspawnEvent(S))}destroyObject(S,O,B=!1,N=!1){if(S.isDestroyed)throw new Error(`Object with ID "${S.id}" is already destroyed`);if(S.isTechno()){let B=S.mindControllableTrait?.getOriginalOwner()??S.owner;!O||S.isBuilding()&&!B.isCombatant()||(O.player.addUnitsKilled(S.type,1),O.player===B||this.alliances.areAllied(O.player,B)||(O.player.score+=S.rules.points)),B.isNeutral||B.addUnitsLost(S.type,1)}if(S.isDestroyed=!0,S.healthTrait&&(S.healthTrait.health=0),S.onDestroy(this,O,B),this.traits.filter(ee.NotifyDestroy).forEach(B=>{B[ee.NotifyDestroy.onDestroy](S,this,O)}),O?.obj?.traits.filter(ae.NotifyTargetDestroy).forEach(B=>{B[ae.NotifyTargetDestroy.onDestroy](O.obj,S,O.weapon,this)}),this.events.dispatch(new Q.ObjectDestroyEvent(S,O,N)),S.isBuilding()&&S.rules.leaveRubble&&S.deathType!==ge.DeathType.Temporal){S.owner.removeOwnedObject(S),this.unitSelection.cleanupUnit(S);var j=this.map.tileOccupation.calculateTilesForGameObject(S.tile,S);this.map.terrain.invalidateTiles(j),S.art.canHideThings&&this.map.tileOcclusion.removeOccluder(S),this.updatableObjects.delete(S),S.onUnspawn(this),this.traits.filter(ie.NotifyUnspawn).forEach(O=>{O[ie.NotifyUnspawn.onUnspawn](S,this)}),this.events.dispatch(new ne.ObjectUnspawnEvent(S))}else if(S.isSpawned)this.unspawnObject(S);else if(S.isTechno()&&S.owner){if(!S.limboData)throw new Error(`Object with ID "${S.id}" should be in limbo but has no limboData`);S.owner.removeOwnedObject(S)}S.dispose()}getObjectById(S){return this.world.getObjectById(S)}changeObjectOwner(S,O){const B=S.owner;B&&B.removeOwnedObject(S),O.addOwnedObject(S),B&&B!==O&&(this.traits.filter(re.NotifyOwnerChange).forEach(O=>{O[re.NotifyOwnerChange.onChange](S,B,this)}),S.onOwnerChange(B,this),this.events.dispatch(new se.ObjectOwnerChangeEvent(S,B)),B===this.localPlayer&&S.owner!==this.localPlayer&&(this.unitSelection.removeFromSelection([S]),this.unitSelection.removeUnitsFromGroup([S])))}addObjectTrait(S,O){S.addTrait(O),this.traits.filter(Oe.NotifyObjectTraitAdd).forEach(B=>{B[Oe.NotifyObjectTraitAdd.onAdd](S,O,this)})}onAllianceChange(S,O,B){this.events.dispatch(new fe.AllianceChangeEvent(S,B?fe.AllianceEventType.Formed:fe.AllianceEventType.Broken,O)),this.traits.filter(ye.NotifyAllianceChange).forEach(O=>{O[ye.NotifyAllianceChange.onChange](S,B,this)})}update(){if(this.status!==Me.NotStarted){for(var S of(this.botManager.update(this),this.status!==Me.Ended&&(void 0===this.lastGameEndCheck||1e3<=this.currentTime-this.lastGameEndCheck)&&(this.checkGameEndConditions(),this.lastGameEndCheck=this.currentTime),[...this.updatableObjects]))S.isSpawned&&S.update(this);if(this.playerList.getCombatants().forEach(S=>S.cheerCooldownTicks=Math.max(0,S.cheerCooldownTicks-1)),this.traits.filter(J.NotifyTick).forEach(S=>{S[J.NotifyTick.onTick](this)}),this.localPlayer&&!this.localPlayer.isObserver&&!this.localPlayer.defeated){var O=this.unitSelection.getSelectedUnits();if(1===O.length){let S=O[0];if(S.isTechno()&&S.owner!==this.localPlayer){let O=this.mapShroudTrait.getPlayerShroud(this.localPlayer);this.map.tileOccupation.calculateTilesForGameObject(S.tile,S).find(B=>!O.isShrouded(B,S.tileElevation))||(this.unitSelection.deselectAll(),this.unitSelection.cleanupUnit(S))}}}for(var B of this.afterTickCallbacks)B();this.afterTickCallbacks.length=0,this.triggers.update(this),this.countdownTimer.update(this),this.currentTick++,this.currentTime+=1e3/de.GameSpeed.BASE_TICKS_PER_SECOND}}afterTick(S){this.afterTickCallbacks.push(S)}checkGameEndConditions(){this.updateDefeatedPlayers(this.playerList.getCombatants()),(this.localPlayer?.defeated&&!this.localPlayer.isObserver||!this.alliances.getHostilePlayers().length&&1<this.gameOpts.humanPlayers.length+this.gameOpts.aiPlayers.filter(S=>!!S).length)&&this.end()}end(){this.status!==Me.Ended&&(this.status=Me.Ended,this._onEnd.dispatch(this,void 0))}updateDefeatedPlayers(S){let O=this.stalemateDetectTrait?.isStale()&&0===this.stalemateDetectTrait.getCountdownTicks(),B=this.gameOpts.shortGame;S.forEach(S=>{let N;if(O)N=!0;else{let O;O=B?(O=[...S.getOwnedObjectsByType(j.ObjectType.Building,!0)].some(S=>!S.rules.insignificant),O||S.getOwnedObjects(!0).some(S=>this.rules.general.baseUnit.includes(S.name))):S.getOwnedObjects(!0).some(S=>!S.rules.insignificant&&!S.limboData?.inTransport),N=!O}var L;N&&(S.defeated=!0,(L=this.alliances.getHostilePlayers().some(S=>!S.first.isAi||!S.second.isAi))&&(S.isObserver=!0),this.removeAllPlayerAssets(S),this.events.dispatch(new Z.PlayerDefeatedEvent(S)),L&&(this.mapShroudTrait.getPlayerShroud(S)?.revealAll(),L=S.radarTrait.isDisabled(),S.radarTrait.setDisabled(!1),L&&this.events.dispatch(new Ae.RadarOnOffEvent(S,!0))))})}removeAllPlayerAssets(S){S.getOwnedObjects().forEach(S=>{S.isDestroyed||(S.isBuilding()&&S.rules.returnable&&S.rules.needsEngineer&&!S.garrisonTrait?this.changeObjectOwner(S,this.getCivilianPlayer()):S.isBuilding()&&S.wallTrait||this.destroyObject(S,void 0,!0))}),S.getOwnedObjects(!0).forEach(S=>{S.isDestroyed||(S.limboData?.inTransport||S.isBuilding()&&S.wallTrait?this.changeObjectOwner(S,this.getCivilianPlayer()):this.destroyObject(S,void 0,!0))})}redistributeAllPlayerAssets(S){if(S.isObserver)return!1;if(!this.rules.mpDialogSettings.mustAlly||this.rules.mpDialogSettings.allyChangeAllowed)return!1;let O=this.alliances.getAllies(S).filter(S=>!S.isAi&&!S.defeated);if(0<O.length){var B,N=[...O].sort((S,O)=>O.score-S.score)[0];for(B of S.getOwnedObjects(!0))this.changeObjectOwner(B,N);var j,L=Math.floor(S.credits/O.length),D=S.credits%O.length;for(j of O)j.credits+=L;return O[0].credits+=D,!0}return!1}generateRandomInt(S,O){return this.prng.generateRandomInt(S,O)}generateRandom(){return this.prng.generateRandom()}getHash(){return $.fnv32a([...new Uint8Array(new Float64Array([this.prng.getLastRandom()]).buffer),this.nextObjectId.value,...this.world.getAllObjects().map(S=>S.getHash()),...this.playerList.getAll().map(S=>S.getHash()),this.alliances.getHash(),...this.traits.getAll().map(S=>S.getHash?.()??0)])}debugGetState(){return{currentTick:this.currentTick,lastRandom:this.prng.getLastRandom(),nextObjectId:this.nextObjectId.value,objects:this.world.getAllObjects().map(S=>S.debugGetState()),players:this.playerList.getAll().map(S=>S.debugGetState()),alliances:this.alliances.debugGetState(),traits:this.traits.getAll().reduce((S,O)=>{var B=O.debugGetState?.();return void 0!==B&&(S[O.constructor.name]=B),S},{})}}dispose(){this.world.getAllObjects().forEach(S=>S.dispose()),this.playerList.getAll().forEach(S=>S.dispose()),this.constructionWorkers.forEach(S=>S.dispose()),this.botManager.dispose(),this.triggers.dispose(),this.map.dispose(),this.traits.dispose()}})}}}),System.register("game/GameEventBus",["util/event"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("GameEventBus",class{constructor(){this.dispatcher=new B.EventDispatcher,this.dispatchersByType=new Map}dispatch(S){this.dispatcher.dispatch(void 0,S),this.dispatchersByType.get(S.type)?.dispatch(void 0,S)}subscribe(S,O){let B,N;return N="function"==typeof S?S:(B=S,O),void 0===B?(this.dispatcher.subscribe(N),()=>this.unsubscribe(N)):this.subscribeType(B,N)}unsubscribe(S,O){let B,N;N="function"==typeof S?S:(B=S,O),void 0===B?this.dispatcher.unsubscribe(N):this.unsubscribeType(B,N)}subscribeType(S,O){let N=this.dispatchersByType.get(S);return N||(N=new B.EventDispatcher,this.dispatchersByType.set(S,N)),N.subscribe(O),()=>this.unsubscribeType(S,O)}unsubscribeType(S,O){this.dispatchersByType.get(S)?.unsubscribe(O)}})}}}),System.register("game/GameFactory",["game/rules/Rules","game/art/Art","data/IniFile","game/Country","game/gameobject/ObjectFactory","game/World","game/GameMap","game/gameopts/GameOpts","game/gameopts/constants","util/typeGuard","game/Alliances","game/PlayerList","game/gameobject/selection/UnitSelection","util/BoxedVar","game/player/PlayerFactory","game/trait/PowerTrait","game/trait/SellTrait","game/trait/RadarTrait","game/trait/ProductionTrait","game/trait/MapShroudTrait","game/Game","game/trait/MapRadiationTrait","game/action/ActionFactory","game/action/ActionFactoryReg","game/trait/SuperWeaponsTrait","game/trait/SharedDetectDisguiseTrait","game/trait/SharedDetectCloakTrait","game/trait/CrateGeneratorTrait","game/trait/StalemateDetectTrait","game/gameopts/GameOptSanitizer","game/gameopts/GameOptRandomGen","game/trait/MapLightingTrait","game/Prng","game/ai/Ai","game/bot/BotFactory","game/BotManager"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S},function(S){ge=S},function(S){pe=S},function(S){me=S}],execute:function(){S("GameFactory",class{static create(S,O,fe,ye,Te,ve,be,Se,we,Ee,xe,Oe,Ae,Me,Re,Pe,Ie){let ke=fe.clone().mergeWith(ve);for(var Be of be)ke.mergeWith(Be);ke.mergeWith(S);var Ne=ye.clone().mergeWith(S.artOverrides??new j.IniFile);let je=new B.Rules(ke,Me);var Le=new N.Art(je,Ne,S,Me),De=new ge.Ai(Te);je.applySpecialFlags(S.specialFlags),ce.GameOptSanitizer.sanitize(Ee,je);let Fe=new B.Rules(fe),_e=Fe.getMultiplayerCountries(),Ue=[...Fe.getMultiplayerColors().values()],He=de.Prng.factory(Se,we),Ge=new _.GameMap(S,O,je,He.generateRandomInt.bind(He));var Ve=new F.World,We=xe.getById(Ee.gameMode).type,ze=new z.PlayerList,Ke=new W.Alliances(ze),$e=new K.UnitSelection,qe=new $.BoxedVar(1),Qe=new D.ObjectFactory(Ge.tiles,Ge.tileOccupation,Ge.bridges,qe),Ze=new ie.ActionFactory;Ne=new pe.BotFactory(Ae),Ne=me.BotManager.factory(Ze,Ne,Pe,Ie);let Ye=new ee.Game(Ve,Ge,je,Le,De,Se,we,Ee,We,ze,$e,Ke,qe,Qe,Ne);(new re.ActionFactoryReg).register(Ze,Ye,void 0),Ye.traits.add(new Q.PowerTrait),Ye.sellTrait=new Z.SellTrait(Ye,je.general),Ye.traits.add(Ye.sellTrait),Ye.traits.add(new Y.RadarTrait);let Xe=new X.ProductionTrait(je,Re);Ye.traits.add(Xe),Ye.mapShroudTrait=new J.MapShroudTrait(Ge,Ke),Ye.traits.add(Ye.mapShroudTrait),Ye.mapRadiationTrait=new te.MapRadiationTrait(Ge),Ye.traits.add(Ye.mapRadiationTrait),Ye.mapLightingTrait=new ue.MapLightingTrait(je.audioVisual,Ge.getLighting()),Ye.traits.add(Ye.mapLightingTrait),Ye.traits.add(new se.SuperWeaponsTrait),Ye.traits.add(new ne.SharedDetectDisguiseTrait),Ye.traits.add(new ae.SharedDetectCloakTrait),Ye.crateGeneratorTrait=new oe.CrateGeneratorTrait(Ee.cratesAppear),Ye.traits.add(Ye.crateGeneratorTrait),Oe||(Ye.stalemateDetectTrait=new le.StalemateDetectTrait,Ye.traits.add(Ye.stalemateDetectTrait));let Je=new q.PlayerFactory(je,Ee,Xe.getAvailableObjects()),et=he.GameOptRandomGen.factory(Se,we),it=et.generateColors(Ee),rt=et.generateCountries(Ee,Fe),st=et.generateStartLocations(Ee,Ge.startingLocations);return[...Ee.humanPlayers,...Ee.aiPlayers].filter(V.isNotNullOrUndefined).forEach(S=>{let O,B,N;if(U.isHumanPlayerInfo(S)?(O=S.name,B=!1):(O=Ye.getAiPlayerName(S),B=!0,N=S.difficulty),S.countryId!==H.OBS_COUNTRY_ID){var j=rt.get(S)??S.countryId,D=it.get(S)??S.colorId,F=st.get(S)??S.startPos;if(j===H.RANDOM_COUNTRY_ID)throw new Error("Random country should have been resolved by now");if(D===H.RANDOM_COLOR_ID)throw new Error("Random color should have been resolved by now");if(F===H.RANDOM_START_POS)throw new Error("Random start location should have been resolved by now");j=_e[j].name,j=L.Country.factory(j,je),D=Ue[D],Ye.addPlayer(Je.createCombatant(O,j,F,D,B,N))}else Ye.addPlayer(Je.createObserver(O,je))}),Ye.addPlayer(Je.createNeutral(je,"@@NEUTRAL@@")),Ye}})}}}),System.register("game/GameMap",["game/map/TileCollection","game/map/TileOccupation","game/map/Terrain","game/map/MapBounds","game/map/Bridges","util/QuadTree","game/map/TileOcclusion","game/theater/AutoLat","engine/TheaterType","game/math/Vector2","game/math/Box2"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S}],execute:function(){S("GameMap",class{get startingLocations(){return this.mapFile.startingLocations}constructor(S,O,z,K){this.mapFile=S,this.tiles=new B.TileCollection(this.mapFile.tiles,O,z.general,K),this.mapBounds=(new L.MapBounds).fromMapFile(this.mapFile,this.tiles),this.tileOccupation=new N.TileOccupation(this.tiles),this.tileOcclusion=new _.TileOcclusion(this.tiles),this.terrain=new j.Terrain(this.tiles,this.mapFile.theaterType,this.mapBounds,this.tileOccupation,z),this.bridges=new D.Bridges(O,this.tiles,this.tileOccupation,this.mapBounds,z);let $=this.mapFile.tags;for(let S of this.mapFile.cellTags){let O=this.tiles.getByMapCoords(S.coords.x,S.coords.y);O&&(O.tag=$.find(O=>O.id===S.tagId))}var q=this.tiles.getMapSize(),Q=Math.max(q.width,q.height)/5;this.technosByTile=new F.QuadTree(new W.Box2(new V.Vector2(0,0),new V.Vector2(q.width,q.height)),{getKey:S=>{var O=S.isBuilding()?S.centerTile:S.tile;return new V.Vector2(O.rx,O.ry)},maxDepth:this.computeQuadDepth(Q),splitThreshold:10,joinThreshold:5}),this.mapFile.theaterType!==H.TheaterType.Snow&&U.AutoLat.calculate(this.tiles,O)}computeQuadDepth(S){if(S<=1)return 1;let O=0;for(;1<=S/2;)S/=2,O++;return O+(1<S?1:0)}getLighting(){return this.mapFile.lighting}getIonLighting(){return this.mapFile.ionLighting}getTheaterType(){return this.mapFile.theaterType}getTags(){return this.mapFile.tags}getTriggers(){return this.mapFile.triggers}getCellTags(){return this.mapFile.cellTags}getVariables(){return this.mapFile.variables}getWaypoint(S){return this.mapFile.waypoints.find(O=>O.number===S)}getTileAtWaypoint(S){var O=this.getWaypoint(S);if(O&&(O=this.tiles.getByMapCoords(O.rx,O.ry)))return O}isWithinBounds(S){return this.mapBounds.isWithinBounds(S)}clampWithinBounds(S){var O=this.mapBounds.clampWithinBounds(S);let B=this.tiles.getByDisplayCoords(O.dx,O.dy);if(B&&this.mapBounds.isWithinBounds(B)){let S=B,O=B.z;for(;0<=O&&S&&this.mapBounds.isWithinBounds(S);)B=S,S=this.tiles.getByDisplayCoords(S.dx,S.dy+2),O-=2}else{let S=0;for(;!B||!this.mapBounds.isWithinBounds(B);){if(30<S)throw new Error("Exceeded max elevation while trying to clamp tile to map bounds");B=this.tiles.getByDisplayCoords(O.dx,O.dy+S),S+=2}}return B}isWithinHardBounds(S){return this.mapBounds.isWithinHardBounds(S)}getInitialMapObjects(){return{terrains:this.mapFile.terrains,overlays:this.mapFile.overlays,smudges:this.mapFile.smudges,technos:[...this.mapFile.structures,...this.mapFile.infantries,...this.mapFile.vehicles,...this.mapFile.aircrafts]}}getObjectsOnTile(S){return this.tileOccupation.getObjectsOnTile(S)}getGroundObjectsOnTile(S){return this.tileOccupation.getGroundObjectsOnTile(S)}getTileZone(S,O=!1){return this.tileOccupation.getTileZone(S,O)}dispose(){this.terrain.dispose(),this.bridges.dispose()}})}}}),System.register("game/GameSpeed",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){S("GameSpeed",B=class e{static computeGameSpeed(S){let O;return O=6===S?60:5===S?45:60/(6-S),O/e.BASE_TICKS_PER_SECOND}}),B.BASE_TICKS_PER_SECOND=15}}}),System.register("game/GameTurnManager",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/Hashable",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/Player",["util/Color","engine/type/ObjectType","game/Traits","util/math"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("Player",class{get credits(){return this._credits}set credits(S){if(S<0)throw new RangeError("Can't set credits to a negative value");this._credits=S}constructor(S,O=void 0,N,L=new B.Color(255,0,0)){this.name=S,this.country=O,this.startLocation=N,this.color=L,this.isAi=!1,this.defeated=!1,this.resigned=!1,this.dropped=!1,this.objectsByType=new Map,this.objectsById=new Map,this.traits=new j.Traits,this._credits=0,this.score=0,this.limitedUnitsBuiltByName=new Map,this.unitsBuiltByType=new Map,this.unitsKilledByType=new Map,this.unitsLostByType=new Map,this.buildingsCaptured=0,this.cratesPickedUp=0,this.cheerCooldownTicks=0,this.isObserver=!O,this.isNeutral=!!O&&!O.isPlayable()}getOrCreateObjectsForType(S){let O=this.objectsByType.get(S);return O||(O=new Set,this.objectsByType.set(S,O)),O}addOwnedObject(S){this.getOrCreateObjectsForType(S.type).add(S),(S.owner=this).objectsById.set(S.id,S)}removeOwnedObject(S){let O=this.objectsByType.get(S.type);if(!O||!O.has(S))throw new Error(`GameObject ${S.name} does not belong to player `+this.name);O.delete(S),this.objectsById.delete(S.id)}getOwnedObjectById(S){return this.objectsById.get(S)}getOwnedObjectsByType(S,O=!1){let B=[];return B=[...this.objectsByType.get(S)||new Set],O||(B=B.filter(S=>!S.limboData)),B}getOwnedObjects(S=!1){let O=[];return[...this.objectsByType.values()].forEach(S=>{S.forEach(S=>O.push(S))}),S||(O=O.filter(S=>!S.limboData)),O}removeAllOwnedObjects(){this.objectsByType.forEach(S=>S.clear()),this.objectsById.clear()}get buildings(){return this.getOrCreateObjectsForType(N.ObjectType.Building)}addUnitsBuilt(S,O){this.unitsBuiltByType.set(S.type,(this.unitsBuiltByType.get(S.type)??0)+O),S.buildLimit<0&&this.limitedUnitsBuiltByName.set(S.name,(this.limitedUnitsBuiltByName.get(S.name)??0)+O)}getUnitsBuilt(S){return void 0!==S?this.unitsBuiltByType.get(S)??0:[...this.unitsBuiltByType.values()].reduce((S,O)=>S+O,0)}getLimitedUnitsBuilt(S){return this.limitedUnitsBuiltByName.get(S)??0}addUnitsKilled(S,O){this.unitsKilledByType.set(S,(this.unitsKilledByType.get(S)??0)+O)}getUnitsKilled(S){return void 0!==S?this.unitsKilledByType.get(S)??0:[...this.unitsKilledByType.values()].reduce((S,O)=>S+O,0)}addUnitsLost(S,O){this.unitsLostByType.set(S,(this.unitsLostByType.get(S)??0)+O)}getUnitsLost(S){return void 0!==S?this.unitsLostByType.get(S)??0:[...this.unitsLostByType.values()].reduce((S,O)=>S+O,0)}isCombatant(){return!this.isNeutral&&!this.isObserver&&!this.defeated}canProduceVeteran(S){if(!this.production||!this.country)throw new Error("Non-combatants can't produce units");var O=this.production.getQueueTypeForObject(S);return O=this.production.getFactoryTypeForQueueType(O),this.production.hasVeteranType(O)||this.country.hasVeteranUnit(S.type,S.name)}getHash(){return L.fnv32a([this.credits,...this.traits.getAll().map(S=>S.getHash?.()??0)])}debugGetState(){return{name:this.name,credits:this.credits,traits:this.traits.getAll().reduce((S,O)=>{var B=O.debugGetState?.();return void 0!==B&&(S[O.constructor.name]=B),S},{})}}dispose(){this.traits.dispose(),this.production?.dispose()}})}}}),System.register("game/PlayerList",["game/SideType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("PlayerList",class{constructor(){this.players=[]}addPlayer(S){this.players.push(S)}getPlayerAt(S){if(S>=this.players.length)throw new RangeError(`Player #${S} out of bounds`);return this.players[S]}getPlayerByName(S){var O=this.players.find(O=>O.name===S);if(!O)throw new Error(`Player with name "${S}" not found`);return O}getPlayerNumber(S){var O=this.players.indexOf(S);if(-1===O)throw new Error(`Player ${S.name} not found`);return O}getCombatants(){return this.players.filter(S=>S.isCombatant())}getNonNeutral(){return this.players.filter(S=>!S.isNeutral)}getCivilian(){return this.players.find(S=>S.country?.side===B.SideType.Civilian)}getAll(){return this.players}})}}}),System.register("game/Prng",["mersenne-twister","data/Crc32","util/string"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("Prng",class e{static factory(S,O){var B=Number.isNaN(Number(S))?N.Crc32.calculateCrc(j.binaryStringToUint8Array(S)):Number(S+""+O);return new e(B)}constructor(S){this.prng=new B.default(S)}generateRandomInt(S,O){var B=this.prng.random();return this.lastRandom=B,Math.round(B*(O-S))+S}generateRandom(){var S=this.prng.random();return this.lastRandom=S}getLastRandom(){return this.lastRandom}})}}}),System.register("game/SideType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("SideType",B={}))[O.GDI=0]="GDI",O[O.Nod=1]="Nod",O[O.Civilian=2]="Civilian",O[O.Mutant=3]="Mutant"}}}),System.register("game/SpecialWarheadType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("SpecialWarheadType",B={}))[O.None=0]="None",O[O.Shrapnel=1]="Shrapnel",O[O.LightningStrike=2]="LightningStrike",O[O.TntCharge=3]="TntCharge"}}}),System.register("game/StartingUnitsGenerator",["engine/type/ObjectType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("StartingUnitsGenerator",class{static generate(S,O,N,j){var L,D=N.reduce((S,O)=>S+O.cost,0)/N.length*S;let F=[],_=D,U=(N=N.filter(S=>S.isAvailableTo(j)&&S.hasOwner(j))).filter(S=>O.includes(S.name));for(L of U){if(_<=0)break;var H=2/3/U.length;_-=(H=Math.ceil(H*D/L.cost))*L.cost,F.push({name:L.name,type:B.ObjectType.Vehicle,count:H})}var V,W=N.filter(S=>!U.includes(S)),z=_/W.length;for(V of W){if(_<=0)break;var K=Math.ceil(z/V.cost);_-=K*V.cost,F.push({name:V.name,type:B.ObjectType.Infantry,count:K})}return F}})}}}),System.register("game/SuperWeapon",["game/event/SuperWeaponReadyEvent","game/GameSpeed"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){var O;(O=j||S("SuperWeaponStatus",j={}))[O.Charging=0]="Charging",O[O.Paused=1]="Paused",O[O.Ready=2]="Ready",S("SuperWeapon",class{constructor(S,O,B,L=!1){this.name=S,this.rules=O,this.owner=B,this.oneTimeOnly=L,this.status=j.Charging,this.isGift=!1,this.rechargeTicks=60*O.rechargeTime*N.GameSpeed.BASE_TICKS_PER_SECOND,this.chargeTicks=this.rechargeTicks,L&&(this.status=j.Ready,this.chargeTicks=0)}update(S){0<this.chargeTicks&&this.status!==j.Paused&&(this.chargeTicks--,0===this.chargeTicks&&(this.status=j.Ready,S.events.dispatch(new B.SuperWeaponReadyEvent(this))))}pauseTimer(){this.status=j.Paused}resumeTimer(){this.status=0<this.chargeTicks?j.Charging:j.Ready}resetTimer(){this.chargeTicks=this.rechargeTicks,this.status===j.Ready&&(this.status=j.Charging)}getTimerSeconds(){return this.chargeTicks/N.GameSpeed.BASE_TICKS_PER_SECOND}getChargeProgress(){return(this.rechargeTicks-this.chargeTicks)/this.rechargeTicks}})}}}),System.register("game/Target",["game/Coords","game/type/LandType"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("Target",class{constructor(S,O,B){this.tileOccupation=B,this.isOre=!1,S?S.isOverlay()&&S.isBridge()?(this.bridge=S,this.tile=O):S.isOverlay()&&S.isTiberium()?(this.isOre=!0,this.tile=S.tile):(this.obj=S,this.tile=S.isBuilding()?S.centerTile:S.tile):(O.landType===N.LandType.Tiberium&&(this.isOre=!0),this.tile=O)}equals(S){return this.obj===S.obj&&this.tile===S.tile&&this.bridge===S.bridge&&this.isOre===S.isOre}getWorldCoords(){return this.obj?this.obj.position.worldPosition:B.Coords.tile3dToWorld(this.tile.rx+.5,this.tile.ry+.5,this.tile.z+(this.bridge?.tileElevation??0))}isBridge(){return!this.obj&&!!this.bridge}getBridge(){return this.bridge||(this.obj?.isUnit()&&this.obj.onBridge?this.tileOccupation.getBridgeOnTile(this.obj.tile):void 0)}})}}}),System.register("game/Traits",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("Traits",class{constructor(){this.allTraits=[],this.traitsByTypeCache=new Map}add(S){this.allTraits.push(S),this.traitsByTypeCache.clear()}addToFront(S){this.allTraits.unshift(S),this.traitsByTypeCache.clear()}remove(S){var O=this.allTraits.indexOf(S);-1!==O&&(this.allTraits.splice(O,1),this.traitsByTypeCache.clear())}filter(S){let O=this.traitsByTypeCache.get(S);return O||(O="function"==typeof S?this.allTraits.filter(O=>O instanceof S):this.allTraits.filter(O=>this.traitImplements(O,S)),this.traitsByTypeCache.set(S,O)),O}get(S){var O=this.find(S);if(!O)throw new Error("No matching trait found");return O}find(S){return this.filter(S)[0]}getAll(){return this.allTraits}traitImplements(S,O){for(var B of Object.getOwnPropertyNames(O))if(void 0===S[O[B]])return!1;return!0}clear(){this.allTraits.length=0,this.traitsByTypeCache.clear()}dispose(){this.getAll().forEach(S=>S.dispose?.()),this.clear()}})}}}),System.register("game/Warhead",["game/gameobject/common/DeathType","game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/gameobject/task/system/CallbackTask","game/gameobject/task/ScatterTask","game/map/BridgeOverlayTypes","game/trait/interface/NotifyAttack","game/type/ArmorType","game/gameobject/unit/CollisionType","game/gameobject/unit/RangeHelper","game/map/tileFinder/RadialTileFinder","game/Coords","util/math","game/gameobject/unit/FacingUtil","engine/type/ObjectType","game/event/WarheadDetonateEvent","game/WeaponType","game/rules/WeaponRules","data/IniSection","game/rules/ProjectileRules","game/gameobject/common/AnimTerrainEffect","game/event/ObjectAttackedEvent","game/SpecialWarheadType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S}],execute:function(){S("Warhead",re=class{constructor(S){this.rules=S}canDamage(S,O,B){return!(!S.isSpawned||S.isDisposed||S.isDestroyed||S.isCrashing||S.isTechno()&&S.warpedOutTrait.isInvulnerable()&&!this.rules.temporal||S.isUnit()&&S.moveTrait.reservedPathNodes.find(S=>S.tile===O)||!S.healthTrait||S.isUnit()&&S.zone===j.ZoneType.Air&&B!==j.ZoneType.Air||!S.isUnit()&&B===j.ZoneType.Air||S.isBuilding()&&S.rules.invisibleInGame||(S.isTechno()||S.isTerrain())&&S.rules.immune&&!this.rules.temporal||S.isTechno()&&!S.rules.warpable&&this.rules.temporal||this.rules.radiation&&(!S.isUnit()||S.rules.immuneToRadiation)||this.rules.psychicDamage&&(!S.isUnit()||S.rules.immuneToPsionics)||S.isOverlay()&&F.BridgeOverlayTypes.isLowBridgeHead(S.overlayId))}computeDamage(S,O,B,L=!1){let D=S;if(0<S&&O.isTechno()&&O.invulnerableTrait.isActive())return 0;if(O.isAircraft()&&O.missileSpawnTrait&&O.zone!==j.ZoneType.Air)return 0;if(!B.gameOpts.destroyableBridges&&O.isOverlay()&&O.bridgeTrait)return 0;if(this.rules.radiation||this.rules.temporal||!O.isInfantry()||O.stance!==N.StanceType.Prone||(D*=this.rules.proneDamage),O.isTechno()||O.isOverlay()||O.isTerrain()){let S=O.isTerrain()?U.ArmorType.Wood:O.rules.armor;var _;O.isOverlay()&&O.isBridge()&&((_=F.BridgeOverlayTypes.getOverlayBridgeType(O.overlayId))===F.OverlayBridgeType.Wood?S=U.ArmorType.Wood:_===F.OverlayBridgeType.Concrete&&(S=U.ArmorType.Concrete)),L&&O.isOverlay()&&(O.isBridge()||O.rules.wall)||(D*=this.rules.verses.get(S)),0<D&&O.isTechno()&&O.veteranTrait&&(D/=O.veteranTrait.getVeteranArmorMultiplier()),0<D&&O.isUnit()&&(D/=O.crateBonuses.armor)}return(O.isOverlay()||O.isBuilding())&&O.rules.wall&&(this.rules.wallAbsoluteDestroyer?D=Number.POSITIVE_INFINITY:this.rules.wall||this.rules.wood&&O.rules.armor===U.ArmorType.Wood||(D=0)),O.isOverlay()&&O.isBridge()&&(this.rules.wall||(D=0)),D=0<D?Math.floor(D):Math.ceil(D),D}inflictDamage(S,O,N,L,D=!1){let F=O.healthTrait;return S===Number.POSITIVE_INFINITY&&(S=F.getHitPoints()),F.inflictDamage(S,N,L),L.traits.filter(_.NotifyAttack).forEach(S=>{S[_.NotifyAttack.onAttack](O,N?.obj,L)}),O.onAttack(L,N),L.events.dispatch(new te.ObjectAttackedEvent(O,N,D)),O.isTechno()&&!this.rules.temporal&&this.supressOrScatterTarget(O,L),!F.health&&(O.isInfantry()&&(O.infDeathType=this.rules.infDeath),this.rules.temporal&&(O.deathType=B.DeathType.Temporal),O.isUnit()&&O.crashableTrait&&O.zone===j.ZoneType.Air&&!this.rules.temporal?O.crashableTrait.crash(N):L.destroyObject(O,N,void 0,D),!0)}supressOrScatterTarget(S,O){S.rules.fraidycat||S.isVehicle()&&!S.owner.isCombatant()&&S.rules.insignificant?S.unitOrderTrait.hasTasks()||(S.isInfantry()&&(S.isPanicked=!0),S.unitOrderTrait.addTask(new D.ScatterTask(O)),S.isInfantry()&&S.unitOrderTrait.addTask(new L.CallbackTask(()=>S.isPanicked=!1).setCancellable(!1))):S.isInfantry()&&(S.moveTrait.isIdle()||S.suppressionTrait?.isSuppressed())&&S.suppressionTrait?.suppress()}createDummyWeaponInfo(){return{minRange:0,range:0,speed:Number.POSITIVE_INFINITY,type:Z.WeaponType.Primary,rules:new Y.WeaponRules(new X.IniSection("Dummy")),projectileRules:new J.ProjectileRules(q.ObjectType.Projectile,new X.IniSection("Dummy")),warhead:this}}detonate(S,O,B,N,L,D,F,_,U,q=ie.SpecialWarheadType.None,Z,Y,X=!1){var J,te,re,se,ne,ae=U?.weapon??this.createDummyWeaponInfo(),oe=U?.obj,le=U?.player,ce=q===ie.SpecialWarheadType.Shrapnel,he=q===ie.SpecialWarheadType.LightningStrike,ue=q===ie.SpecialWarheadType.TntCharge,de=Y?Y/z.Coords.LEPTONS_PER_TILE:this.rules.cellSpread,ge=this.rules.percentAtMax;let pe=new Set,me=new Map,fe=new V.RangeHelper(S.map.tileOccupation),ye=new W.RadialTileFinder(S.map.tiles,S.map.mapBounds,B,{width:1,height:1},0,Math.ceil(de),()=>!0);for(;J=ye.getNextTile();)for(te of S.map.getObjectsOnTile(J))if((!pe.has(te)||te.isBuilding())&&(F!==H.CollisionType.UnderBridge||!te.isUnit()||!te.onBridge)&&!(oe&&te.isTechno()&&te.rules.typeImmune&&te.owner===le&&te.name===oe.name)&&(!ue||te!==oe)&&this.canDamage(te,J,D)&&(!te.isOverlay()||!(!F&&.1<Math.abs(te.tileElevation-N)||F===H.CollisionType.OnBridge&&!te.isBridge()))){let O=te.isBuilding()?J===B?0:fe.distance3(J,L)/z.Coords.LEPTONS_PER_TILE:te.isTerrain()||te.isOverlay()?fe.distance3(J,B)/z.Coords.LEPTONS_PER_TILE:fe.distance3(te,L)/z.Coords.LEPTONS_PER_TILE;if(O<.001&&(O=0),!(ce&&te.isInfantry()&&le)||te.owner!==le&&!S.alliances.areAllied(te.owner,le)){if(!de)if(te.isTerrain()){if(J!==B||!this.rules.wall)continue}else if(!ce&&(J!==B||!te.isBuilding()&&te!==(_.obj||_.getBridge())))continue;de&&O>de||(pe.add(te),me.set(te,te.isBuilding()?(me.get(te)||[]).concat(O):[O]))}}let Te,ve=!1;for(re of pe)if(!re.isDestroyed&&!re.isCrashing){let B=this.computeDamage(O,re,S,he);if(0<O&&!this.rules.affectsAllies&&re.isTechno()&&le&&(S.alliances.areAllied(re.owner,le)||re.owner===le)&&(B=0),B)for(var be of me.get(re)){let O=B;if(0<de&&Number.isFinite(O)&&(O=K.lerp(O,ge*O,be/de)),Math.abs(O)<1&&(!de||.25<=O/B)&&(O=+Math.sign(O)),O=0<O?Math.floor(O):Math.ceil(O),O){let N=re.healthTrait;if(O<0){if(!oe)throw new Error("Expected healer object to be set");if(N.healBy(-O,oe,S),100===N.health)break}else{if(re===_.obj&&be<1&&(Te=re),this.rules.causesDelayKill&&re.isBuilding()&&re.delayedKillTrait&&O>=(se=re.healthTrait.getHitPoints())&&(O=se-1,re.delayedKillTrait.isActive()||(se=this.rules.delayKillAtMax,ne=this.rules.delayKillFrames,ne=K.lerp(ne,se*ne,be/de),re.delayedKillTrait.activate(ne,U))),this.inflictDamage(O,re,U,S,!Te))break;re.isVehicle()&&this.rules.rocker&&0<(be=K.clamp(B/300,0,1))&&(ne=$.FacingUtil.fromMapCoords(re.position.getMapPosition().clone().sub(z.Coords.vecWorldToGround(L)))-re.direction,re.applyRocking(ne,be))}}}else re.isTechno()&&re.invulnerableTrait.isActive()&&(ve=!0)}if((ae=ae.rules.radLevel)&&de&&S.mapRadiationTrait.createRadSite(B,ae,de+1),ae=X?void 0:ve?S.rules.audioVisual.weaponNullifyAnim:this.pickExplodeAnim(O,Te,D,S,he),!ve&&D===j.ZoneType.Ground){let O=new ee.AnimTerrainEffect;ae&&O.destroyOre(ae,B,S),Z&&O.spawnSmudges(Z,B,S),ae&&O.spawnSmudges(ae,B,S)}S.events.dispatch(new Q.WarheadDetonateEvent(this,L,ae,he))}pickExplodeAnim(S,O,B,N,L){if(S){if(L)return N.rules.audioVisual.weatherConBoltExplosion;if(this.rules.conventional&&B===j.ZoneType.Water&&(!O||O.isBuilding()||O.isVehicle()&&O.submergibleTrait)){var D=N.rules.combatDamage.splashList;return D[K.clamp(Math.floor(S/50),0,D.length-1)]}let F;return(D=this.rules.animList.length)?(F=N.rules.combatDamage.c4Warhead===this.rules.name?D-1:this.rules.emEffect?N.generateRandomInt(0,D-1):K.clamp(Math.floor(S/25),0,D-1),this.rules.animList[F]):void 0}}}),re.SPECIAL_WARHEAD_NAME="Special",re.HE_WARHEAD_NAME="HE"}}}),System.register("game/Weapon",["game/Warhead","game/art/FlhCoords","game/event/WeaponFireEvent","game/math/geometry","game/rules/ObjectRules","game/Coords","engine/type/ObjectType","game/WeaponTargeting","game/WeaponType","game/math/Vector2","game/math/Vector3"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S}],execute:function(){S("Weapon",z=class e{static factory(S,O,j,L,D){var F=L.getWeapon(S);let _=F.warhead;_===B.Warhead.SPECIAL_WARHEAD_NAME&&(_=e.findSpecialWarheadName(F,j,L));var H=new B.Warhead(L.getWarhead(_)),V=L.getProjectile(F.projectile),W=new U.WeaponTargeting(O,V,F,H.rules,j,L.general);return new this(O,j,F,H,V,D||new N.FlhCoords,W)}static findSpecialWarheadName(S,O,B){let N;if(!S.spawner)throw new Error(`Weapon "${S.name} can't use "Special" warhead without Spawner=yes`);if(O.rules.spawns===B.general.v3Rocket.type)N=B.combatDamage.v3Warhead;else if(O.rules.spawns===B.general.dMisl.type)N=B.combatDamage.dMislWarhead;else{if(!O.rules.spawns)throw new Error(`Can't use "Special" warhead on unit type "${O.name}" without "Spawns"`);var j=B.getObject(O.rules.spawns,_.ObjectType.Aircraft);if(!j.primary)throw new Error(`Spawned unit "${j.name}" doesn't have a primary weapon`);N=B.getWeapon(j.primary).warhead}return N}static computeSpeed(S,O){return O.arcing?.75*D.ObjectRules.iniSpeedToLeptonsPerTick(50,100):!O.rot||O.inviso||S.isLaser||S.isElectricBolt?Number.POSITIVE_INFINITY:S.speed}constructor(S,O,B,N,j,L,D){this.type=S,this.gameObject=O,this.rules=B,this.warhead=N,this.projectileRules=j,this.flh=L,this.targeting=D,this.cooldownTicks=0,this.burstsLeft=0,this.burstIndex=0,this.useBurstDelay=!1,this.lateralMuzzleMult=1,this.distributedFireAngle=O.rules.distributedFire&&O.rules.radialFireSegments?-90:0}get name(){return this.rules.name}get minRange(){return this.rules.minimumRange}get range(){return this.gameObject.isBuilding()&&!this.gameObject.overpoweredTrait&&this.type===H.WeaponType.Secondary&&this.gameObject.primaryWeapon?Math.min(this.gameObject.primaryWeapon.rules.range,this.rules.range):this.rules.range}get speed(){return e.computeSpeed(this.rules,this.projectileRules)}get rof(){let S=this.rules.rof;return this.gameObject.isBuilding()&&this.gameObject.garrisonTrait?.isOccupied()&&(S/=this.gameObject.garrisonTrait.units.length),this.gameObject.veteranTrait&&(S*=this.gameObject.veteranTrait.getVeteranRofMultiplier()),Math.floor(S)}getCooldownTicks(){return this.cooldownTicks}expireCooldown(){this.cooldownTicks=0}resetCooldown(){this.cooldownTicks=this.rof}hasBurstsLeft(){return 0<this.burstsLeft}resetBursts(){this.burstsLeft=0,this.burstIndex=0,this.resetCooldown(),this.gameObject.ammoTrait&&0<this.gameObject.ammoTrait.ammo&&this.gameObject.ammoTrait.ammo--}tick(){0<this.cooldownTicks&&this.cooldownTicks--}getBurstsFired(){return this.burstIndex}fire(S,O,B=1){let N,D=this.gameObject,_=0;if(!D.airSpawnTrait||!this.rules.spawner||(N=D.airSpawnTrait.prepareLaunch(D,S,O),_=D.airSpawnTrait.availableSpawns,N)){this.burstsLeft?(this.burstsLeft--,this.burstIndex++,this.lateralMuzzleMult*=-1):(this.useBurstDelay=!1,this.burstIndex=0,N?this.burstsLeft=_:this.gameObject.isAircraft()?this.burstsLeft=this.projectileRules.iniRot<=1?4:this.gameObject.rules.fighter?0:1:(this.burstsLeft=this.rules.burst-1,this.useBurstDelay=!0),this.lateralMuzzleMult=1),0<this.burstsLeft&&(N&&0<_?this.cooldownTicks=this.rules.iniSpeed:this.gameObject.isAircraft()?this.cooldownTicks=this.rules.rof:this.cooldownTicks=this.useBurstDelay&&void 0!==this.gameObject.rules.burstDelay[this.burstIndex]?this.gameObject.rules.burstDelay[this.burstIndex]:O.generateRandomInt(3,5)),this.burstsLeft||this.resetBursts(),this.rules.limboLaunch&&(O.limboObject(this.gameObject,{selected:O.getUnitSelection().isSelected(this.gameObject),controlGroup:O.getUnitSelection().getOrCreateSelectionModel(this.gameObject).getControlGroupNumber()}),this.warhead.rules.parasite&&(S.obj?.isVehicle()||S.obj?.isAircraft())&&S.obj.parasiteableTrait&&(S.obj.parasiteableTrait.beingBoarded=!0));let K=N??O.createProjectile(this.projectileRules.name,this.gameObject,this,S,!1);K.isAircraft()||(K.baseDamageMultiplier=B*(this.gameObject.isUnit()?this.gameObject.crateBonuses.firepower:1));let $=this.flh.clone();$.lateral*=this.lateralMuzzleMult;var U=D.position.getMapPosition();if(O.map.isWithinHardBounds(U)){K.position.moveToLeptons(U),K.position.tileElevation=D.position.tileElevation;let B=new V.Vector2($.lateral,$.forward);var H=this.getMuzzleFacing()+this.distributedFireAngle;B=L.rotateVec2(B,H),U=new V.Vector2(0,D.art.turretOffset),U=L.rotateVec2(U,D.direction),B.add(U),D.rules.radialFireSegments&&D.rules.distributedFire&&(U=Math.floor(180/D.rules.radialFireSegments),this.distributedFireAngle=(this.distributedFireAngle+U+90)%180-90),K.direction=H,D.isBuilding()&&D.rules.turretAnim&&(z=F.Coords.screenDistanceToWorld(D.rules.turretAnimX,D.rules.turretAnimY),H=D.getFoundationCenterOffset(),K.position.moveByLeptons(-H.x+z.x,-H.y+z.y));let N=new W.Vector3(B.x,$.vertical,-B.y);var z=N.clone().add(K.position.worldPosition);if(O.map.isWithinHardBounds(z)&&K.position.moveByLeptons3(N),K.tileElevation<0&&(K.position.tileElevation=0),K.isAircraft()?O.unlimboObject(K,K.position.tile):O.spawnObject(K,K.position.tile),this.rules.revealOnFire&&S.obj?.isTechno()){let B=O.mapShroudTrait.getPlayerShroud(S.obj.owner);B?.isShrouded(D.tile,D.tileElevation)&&B.revealTemporarily(D)}this.rules.decloakToFire&&this.gameObject.cloakableTrait?.uncloak(O),O.events.dispatch(new j.WeaponFireEvent(this,this.gameObject))}else N&&(N.owner.removeOwnedObject(N),N.dispose())}}getMuzzleFacing(){let S,O=this.gameObject;return S=O.isInfantry()||O.isAircraft()||!O.isBuilding()&&!O.isVehicle()||!O.turretTrait?O.direction:O.turretTrait.facing,S}}),z.NUKE_PAYLOAD_NAME="NukePayload"}}}),System.register("game/WeaponInfo",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/WeaponTargeting",["game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/type/LandTargeting","game/type/LandType","game/type/NavalTargeting","game/type/SpeedType","game/WeaponType"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){S("WeaponTargeting",class{constructor(S,O,B,N,j,L){this.weaponType=S,this.projectileRules=O,this.weaponRules=B,this.warheadRules=N,this.gameObject=j,this.generalRules=L,this.targetChecks=[],this.initConditions()}initConditions(){this.projectileRules.isAntiGround||this.targetChecks.push(S=>!!S);const S=this.generalRules.prism.type;this.gameObject.name===S&&this.weaponType===_.WeaponType.Secondary?this.targetChecks.push((O,B,N,j,L)=>!(!L||!O?.isBuilding()||O.name!==S||O.owner!==this.gameObject.owner)):this.warheadRules.electricAssault?this.targetChecks.push((S,O,B,N,j)=>!(!N&&!j||!S?.isBuilding()||!S.overpoweredTrait||S.owner!==this.gameObject.owner)):this.weaponRules.damage<0?this.targetChecks.push((S,O,B)=>!!(S!==this.gameObject&&S?.isUnit()&&B.areFriendly(S,this.gameObject)&&S.healthTrait.health<100&&this.gameObject.isAircraft()===S.isAircraft())):(this.gameObject.rules.attackCursorOnFriendlies||this.warheadRules.bombDisarm?this.targetChecks.push((S,O,B,N,j)=>!j&&!!(!this.warheadRules.bombDisarm||S?.isTechno()&&S.tntChargeTrait?.hasCharge())):this.targetChecks.push((S,O,B,N)=>!((!N||this.warheadRules.mindControl)&&S?.isTechno()&&B.areFriendly(S,this.gameObject))),this.targetChecks.push((S,O,B)=>!(S?.isTechno()&&S.cloakableTrait?.isCloaked()&&!B.alliances.haveSharedIntel(this.gameObject.owner,S.owner))),this.weaponRules.limboLaunch&&this.targetChecks.push((S,O,B,N,j)=>!(j&&S&&(S.isVehicle()||S.isAircraft())&&S.parasiteableTrait?.isInfested())),this.warheadRules.ivanBomb&&this.targetChecks.push(S=>!(!S?.isTechno()||!S.tntChargeTrait||S.tntChargeTrait.hasCharge())),this.warheadRules.parasite&&this.targetChecks.push((S,O,B,N)=>!!(!S&&N||S?.isInfantry()||(S?.isVehicle()||S?.isAircraft())&&S.parasiteableTrait)),this.warheadRules.mindControl&&this.targetChecks.push(S=>!(!S?.isTechno()||!S.mindControllableTrait)),this.warheadRules.temporal||this.targetChecks.push((S,O,B,N,j)=>!(j&&S?.isTechno()&&S.warpedOutTrait.isInvulnerable())),this.gameObject.rules.natural&&this.targetChecks.push(S=>!S?.isTechno()||!S.rules.unnatural)),this.targetChecks.push((S,O)=>this.canTargetZone(S,O))}canTarget(S,O,B,N,j){return this.targetChecks.every(L=>L(S,O,B,N,j))}canTargetZone(S,O){let j;if(S?.isUnit()){if(S?.isInfantry()&&S.stance===B.StanceType.Paradrop&&2<S.tileElevation)return this.projectileRules.isAntiAir&&(this.projectileRules.isAntiGround||this.weaponType===_.WeaponType.Secondary);if(S.zone===N.ZoneType.Air)return this.projectileRules.isAntiAir;if(this.weaponType===_.WeaponType.Secondary&&this.projectileRules.isAntiAir&&!this.projectileRules.isAntiGround)return!1;j=S.zone}else j=O.landType===L.LandType.Water?N.ZoneType.Water:N.ZoneType.Ground;return j===N.ZoneType.Water?this.canTargetNaval(this.gameObject.rules.navalTargeting,this.gameObject,S,this.weaponType):this.canTargetLand(this.gameObject.rules.landTargeting,this.weaponType)}canTargetLand(S,O){switch(S){case j.LandTargeting.LandOk:return!0;case j.LandTargeting.LandNotOk:return!1;case j.LandTargeting.LandSecondary:return O===_.WeaponType.Secondary;default:throw new Error(`Unhandled LandTargeting value "${S}"`)}}canTargetNaval(S,O,B,N){switch(S){case D.NavalTargeting.UnderwaterNever:return!B||!(B.isVehicle()&&B.submergibleTrait?.isSubmerged());case D.NavalTargeting.UnderwaterSecondary:return B&&B.isVehicle()&&B.submergibleTrait&&!O.rules.spawned?N===_.WeaponType.Secondary:N===_.WeaponType.Primary;case D.NavalTargeting.UnderwaterOnly:return!!(B&&B.isVehicle()&&B.submergibleTrait);case D.NavalTargeting.OrganicSecondary:return B?.isTechno()&&B.rules.organic?N===_.WeaponType.Secondary:N===_.WeaponType.Primary;case D.NavalTargeting.SealSpecial:return B?.isTechno()&&B.rules.naval&&!B.rules.organic&&(B.isBuilding()||B.rules.speedType===F.SpeedType.Float)?N===_.WeaponType.Secondary:N===_.WeaponType.Primary;case D.NavalTargeting.NavalAll:return!0;case D.NavalTargeting.NavalNone:return!1;default:throw new Error(`Unhandled NavalTargeting value "${S}"`)}}})}}}),System.register("game/WeaponType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("WeaponType",B={}))[O.Primary=0]="Primary",O[O.Secondary=1]="Secondary",O[O.DeathWeapon=2]="DeathWeapon"}}}),System.register("game/World",["util/event"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("World",class{constructor(){this.allObjects=new Map,this._onObjectSpawned=new B.EventDispatcher,this._onObjectRemoved=new B.EventDispatcher}get onObjectSpawned(){return this._onObjectSpawned.asEvent()}get onObjectRemoved(){return this._onObjectRemoved.asEvent()}spawnObject(S){if(this.allObjects.has(S.id))throw new Error("Trying to add an already existing object");this.allObjects.set(S.id,S),this._onObjectSpawned.dispatch(this,S)}removeObject(S){if(!this.allObjects.has(S.id))throw new Error("Trying to remove non-existent object");this.allObjects.delete(S.id),this._onObjectRemoved.dispatch(this,S)}hasObjectId(S){return this.allObjects.has(S)}getObjectById(S){if(!this.allObjects.has(S))throw new Error(`Object with id ${S} doesn't exist`);return this.allObjects.get(S)}getAllObjects(){return[...this.allObjects.values()]}})}}}),System.register("game/action/Action",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("Action",class{constructor(S){this.actionType=S}unserialize(S){}serialize(){return new Uint8Array}print(){return""}})}}}),System.register("game/action/ActionFactory",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("ActionFactory",class{constructor(){this.factories=new Map}registerFactory(S,O){this.factories.set(S,O)}create(S){let O=this.factories.get(S);if(!O)throw new Error("No factory registered for action type "+S);return O.create()}})}}}),System.register("game/action/ActionFactoryReg",["game/action/OrderActionContext","game/action/ActionType","game/action/factories/NoActionFactory","game/action/factories/PlaceBuildingActionFactory","game/action/factories/SellObjectActionFactory","game/action/factories/SelectUnitsActionFactory","game/action/factories/OrderUnitsActionFactory","game/action/factories/UpdateQueueActionFactory","game/action/factories/DropPlayerActionFactory","game/action/factories/ToggleRepairActionFactory","game/action/factories/ToggleAllianceFactory","game/action/factories/ActivateSuperWeaponActionFactory","game/action/factories/PingLocationActionFactory","game/action/factories/ObserveGameActionFactory","game/action/factories/ResignGameActionFactory","game/action/factories/DebugActionFactory"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S}],execute:function(){S("ActionFactoryReg",class{register(S,O,Z){var Y=new B.OrderActionContext;S.registerFactory(N.ActionType.NoAction,new j.NoActionFactory),S.registerFactory(N.ActionType.PlaceBuilding,new L.PlaceBuildingActionFactory(O)),S.registerFactory(N.ActionType.SellObject,new D.SellObjectActionFactory(O)),S.registerFactory(N.ActionType.ToggleRepair,new V.ToggleRepairActionFactory(O)),S.registerFactory(N.ActionType.SelectUnits,new F.SelectUnitsActionFactory(O,Y)),S.registerFactory(N.ActionType.OrderUnits,new _.OrderUnitsActionFactory(O,O.map,Y)),S.registerFactory(N.ActionType.UpdateQueue,new U.UpdateQueueActionFactory(O)),S.registerFactory(N.ActionType.ToggleAlliance,new W.ToggleAllianceActionFactory(O)),S.registerFactory(N.ActionType.ActivateSuperWeapon,new z.ActivateSuperWeaponActionFactory(O)),S.registerFactory(N.ActionType.PingLocation,new K.PingLocationActionFactory(O)),S.registerFactory(N.ActionType.DropPlayer,new H.DropPlayerActionFactory(O,Z)),S.registerFactory(N.ActionType.ObserveGame,new $.ObserveGameActionFactory(O)),S.registerFactory(N.ActionType.ResignGame,new q.ResignGameActionFactory(O,Z)),S.registerFactory(N.ActionType.DebugCommand,new Q.DebugActionFactory(O))}})}}}),System.register("game/action/ActionQueue",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("ActionQueue",class{constructor(){this.actions=[]}push(...S){this.actions.push(...S)}getLast(){return this.actions[this.actions.length-1]}dequeueAll(){var S=[...this.actions];return this.actions.length=0,S}dequeueLast(){return this.actions.pop()}clear(){this.actions.length=0}})}}}),System.register("game/action/ActionType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("ActionType",B={}))[O.NoAction=0]="NoAction",O[O.DropPlayer=1]="DropPlayer",O[O.ObserveGame=2]="ObserveGame",O[O.ResignGame=3]="ResignGame",O[O.DebugCommand=4]="DebugCommand",O[O.PlaceBuilding=5]="PlaceBuilding",O[O.SellObject=6]="SellObject",O[O.ToggleRepair=7]="ToggleRepair",O[O.SelectUnits=8]="SelectUnits",O[O.OrderUnits=9]="OrderUnits",O[O.UpdateQueue=10]="UpdateQueue",O[O.ToggleAlliance=11]="ToggleAlliance",O[O.ActivateSuperWeapon=12]="ActivateSuperWeapon",O[O.PingLocation=13]="PingLocation"}}}),System.register("game/action/ActivateSuperWeaponAction",["data/DataStream","game/action/Action","game/action/ActionType","game/type/SuperWeaponType","game/trait/SuperWeaponsTrait"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends N.Action{constructor(S){super(j.ActionType.ActivateSuperWeapon),this.game=S}unserialize(S){let O=new B.DataStream(S);this.superWeaponType=O.readUint8();var N=O.readUint8();this.tile={x:O.readUint16(),y:O.readUint16()},this.tile2=2<N?{x:O.readUint16(),y:O.readUint16()}:void 0}serialize(){let S=new B.DataStream(6+(this.tile2?4:0));return S.dynamicSize=!1,S.writeUint8(this.superWeaponType),S.writeUint8(this.tile2?4:2),S.writeUint16(this.tile.x),S.writeUint16(this.tile.y),this.tile2&&(S.writeUint16(this.tile2.x),S.writeUint16(this.tile2.y)),S.toUint8Array()}print(){return`Activate SuperW ${L.SuperWeaponType[this.superWeaponType]} at tile (${this.tile.x}, ${this.tile.y})`+(this.tile2?`, (${this.tile2.x}, ${this.tile2.y})`:"")}process(){var S,O=this.player,B=this.game.map.tiles.getByMapCoords(this.tile.x,this.tile.y);B?(S=this.tile2?this.game.map.tiles.getByMapCoords(this.tile2.x,this.tile2.y):void 0,this.game.traits.get(D.SuperWeaponsTrait).activateSuperWeapon(this.superWeaponType,O,this.game,B,S)):console.warn(`Tile ${this.tile.x},${this.tile.y} doesn't exist`)}},S("ActivateSuperWeaponAction",F)}}}),System.register("game/action/DebugAction",["data/DataStream","game/action/Action","game/action/ActionType"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){var O;(O=L||S("DebugCommandType",L={}))[O.SetGlobalDebugText=0]="SetGlobalDebugText",O[O.SetUnitDebugText=1]="SetUnitDebugText",S("DebugCommand",D=class{constructor(S,O){this.type=S,this.params=O}}),F=class extends N.Action{constructor(S){super(j.ActionType.DebugCommand),this.game=S}unserialize(S){let O=new B.DataStream(S);var N=O.readUint8();N===L.SetUnitDebugText?this.command=new D(N,{unitId:O.readUint32(),label:O.readCString()||void 0}):N===L.SetGlobalDebugText?this.command=new D(N,{text:O.readCString()}):console.warn(`Debug command ${N} not implemented`)}serialize(){let S=new B.DataStream;if(S.writeUint8(this.command.type),this.command.type===L.SetUnitDebugText){var O=this.command.params;S.writeUint32(O.unitId),S.writeCString(O.label||"")}else{if(this.command.type!==L.SetGlobalDebugText)throw new Error(`Debug command ${this.command.type} not implemented`);O=this.command.params,S.writeCString(O.text)}return S.toUint8Array()}process(){if(this.command.type===L.SetUnitDebugText){var{unitId:S,label:O}=this.command.params;if(this.game.getWorld().hasObjectId(S)){let B=this.game.getObjectById(S);B.isTechno()&&(B.debugLabel=O)}}else this.command.type===L.SetGlobalDebugText?(O=this.command.params.text,this.game.debugText.value=O):console.warn(`Debug command ${this.command.type} not implemented`)}},S("DebugAction",F)}}}),System.register("game/action/DropPlayerAction",["game/action/Action","game/action/ActionType","game/event/PlayerDroppedEvent"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends B.Action{constructor(S,O){super(N.ActionType.DropPlayer),this.game=S,this.localPlayerName=O}process(){if(this.localPlayerName!==this.player.name){let O=this.player;var S;O.defeated||(S=this.game.redistributeAllPlayerAssets(O),this.game.removeAllPlayerAssets(O),O.dropped=!0,this.game.events.dispatch(new j.PlayerDroppedEvent(O,S)))}}},S("DropPlayerAction",L)}}}),System.register("game/action/NoAction",["game/action/Action","game/action/ActionType"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends B.Action{constructor(){super(N.ActionType.NoAction)}process(){}},S("NoAction",j)}}}),System.register("game/action/ObserveGameAction",["game/action/Action","game/event/PlayerResignedEvent","game/action/ActionType","game/event/PlayerDefeatedEvent","game/event/RadarOnOffEvent"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends B.Action{constructor(S){super(j.ActionType.ObserveGame),this.game=S}process(){let S=this.player;var O;this.game.removeAllPlayerAssets(S),!S.isCombatant()||S.defeated||S.isObserver||(S.resigned=!0,S.defeated=!0,S.isObserver=!0,this.game.events.dispatch(new N.PlayerResignedEvent(S)),this.game.events.dispatch(new L.PlayerDefeatedEvent(S)),this.game.mapShroudTrait.getPlayerShroud(S)?.revealAll(),O=S.radarTrait.isDisabled(),S.radarTrait.setDisabled(!1),O&&this.game.events.dispatch(new D.RadarOnOffEvent(S,!0)))}},S("ObserveGameAction",F)}}}),System.register("game/action/OrderActionContext",["game/gameobject/selection/UnitSelectionLite"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("OrderActionContext",class{constructor(){this.unitSelectionByPlayer=new Map}getOrCreateSelection(S){let O=this.unitSelectionByPlayer.get(S);return O||(O=new B.UnitSelectionLite(S),this.unitSelectionByPlayer.set(S,O)),O}})}}}),System.register("game/action/OrderUnitsAction",["data/DataStream","game/action/Action","game/order/OrderType","game/order/orderPriorities","game/order/MoveOrder","game/gameobject/unit/MovePositionHelper","game/order/DeployOrder","game/event/CheerEvent","game/event/DeployNotAllowedEvent","util/typeGuard","game/gameobject/unit/ScatterPositionHelper","game/action/ActionType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S}],execute:function(){S("ORDER_UNIT_LIMIT",128),K=class extends N.Action{constructor(S,O,B,N){super(z.ActionType.OrderUnits),this.game=S,this.map=O,this.orderActionContext=B,this.orderFactory=N,this.queue=!1,this.isInvalid=!1}unserialize(S){let O=new B.DataStream(S);this.orderType=O.readUint8();var N=O.readUint8();if(0!==N){var j=O.readUint16(),L=O.readUint16();let S;if(this.queue=2<N&&Boolean(O.readUint8()),3<N){if(N=O.readUint32(),!this.game.getWorld().hasObjectId(N))return void(this.isInvalid=!0);S=this.game.getObjectById(N)}else S=void 0;(L=this.map.tiles.getByMapCoords(j,L))?this.target=this.game.createTarget(S,L):this.isInvalid=!0}}serialize(){let S=new B.DataStream(11);S.dynamicSize=!1,S.writeUint8(this.orderType);let O=0;S.writeUint8(O),this.target&&(S.writeUint16(this.target.tile.rx),S.writeUint16(this.target.tile.ry),O+=2,N=(this.target.obj||this.target.getBridge())?.id,!this.queue&&void 0===N||(S.writeUint8(Number(this.queue)),O+=1),void 0!==N&&(S.writeUint32(N),O+=1));var N=S.position;return 0<O&&(S.seek(1),S.writeUint8(O)),new Uint8Array(S.buffer,S.byteOffset,N)}print(){return this.isInvalid?"":j.OrderType[this.orderType]+" order "+(this.target?`[obj: ${(this.target.obj||this.target.getBridge())?.name||"<none>"}, tile: ${this.target.tile.rx},${this.target.tile.ry}]`+(this.queue?"(queue)":""):"")}process(){if(!this.isInvalid){let N=this.player;const L=this.game.mapShroudTrait.getPlayerShroud(N);if(L){const _=this.target?.obj;if(_&&!this.game.map.tileOccupation.calculateTilesForGameObject(_.tile,_).find(S=>!L.isShrouded(S,_.tileElevation)))return;let H=this.validateOrders(N).slice(0,128),V=[],z=[],K=[],$=[],q=[];if(H.forEach(S=>{(S instanceof D.MoveOrder?z:S.orderType===j.OrderType.Scatter?K:S.orderType===j.OrderType.DeploySelected?$:S.orderType===j.OrderType.Cheer?q:V).push(S)}),z.length&&this.target){var S=z[0].isEnemyBuildingBlock(),O=z[0].isFollowMove();if(S||O)z.forEach(S=>V.push(S));else{let S=this.target.getBridge();var B=z[0].forceMove;O=z.map(S=>S.sourceObject);let N=new F.MovePositionHelper(this.map).findPositions(O,this.target.tile,S,B);z.forEach(O=>{var B=N.get(O.sourceObject),j=!S||S.isHighBridge()?this.map.tileOccupation.getBridgeOnTile(B):S;B=this.game.createTarget(j,B),O.target=B,V.push(O)})}}if(K.length){B=K.map(S=>S.sourceObject).filter(S=>S.isInfantry()||S.isVehicle());let S=new W.ScatterPositionHelper(this.game).findPositions(B);K.forEach(O=>{var B=S.get(O.sourceObject);B&&(B=this.game.createTarget(B.onBridge,B.tile),O.target=B,V.push(O))})}if($.length){let S=[];$.forEach(O=>{((O.sourceObject.isInfantry()||O.sourceObject.isVehicle())&&O.sourceObject.deployerTrait?S:V).push(O)});let O=S.filter(S=>!S.sourceObject.deployerTrait.isDeployed());O.length?O.forEach(S=>V.push(S)):S.forEach(S=>V.push(S))}q.length&&(N.cheerCooldownTicks||(N.cheerCooldownTicks=this.game.rules.general.maximumCheerRate,V.push(...q),this.game.events.dispatch(new U.CheerEvent(N)))),V.forEach(S=>S.sourceObject.unitOrderTrait.addOrder(S,this.queue)),this.updateWaypointPaths(V)}}}validateOrders(S){let O=this.orderActionContext.getOrCreateSelection(S);var B,N=O.getSelectedUnits();let D=this.orderFactory.create(this.orderType,O);D.target=this.target;let F=[];for(B of N)if(!(B.owner!==S||B.rules.spawned||B.isDestroyed||B.isCrashing||B.isDisposed||B.warpedOutTrait.isActive()||(D.sourceObject=B,D instanceof _.DeployOrder&&D.isValid()&&!D.isAllowed()&&this.game.events.dispatch(new H.DeployNotAllowedEvent(B)),D.singleSelectionRequired&&1<N.length)))if(D.isValid()&&D.isAllowed()){let S=this.orderFactory.create(this.orderType,O);S.set(B,this.target),F.push(S)}else{let S=!1;for(var U of L.orderPriorities){let j=this.orderFactory.create(U,O);if(j.set(B,this.target),!(j.singleSelectionRequired&&1<N.length)&&j.targetOptional===!this.target&&j.isValid()&&j.isAllowed()){F.push(j),S=!0;break}}if(!S&&this.target&&this.orderType!==j.OrderType.Deploy){let S=this.orderFactory.create(j.OrderType.Move,O);S.set(B,this.target),S.isValid()&&S.isAllowed()&&F.push(S)}}return F}updateWaypointPaths(S){if(this.queue&&this.target){let N=S.map(S=>S.sourceObject);var O=[...new Set(N.map(S=>S.unitOrderTrait.waypointPath).filter(V.isNotNullOrUndefined))];if(O.length<=1){var B={orderType:this.orderType,target:this.target,terminal:S.some(S=>S.terminal),next:void 0};if(0===O.length){let S={units:N,waypoints:[B]};N.forEach(O=>{O.unitOrderTrait.waypointPath=S})}else{let S=O[0];S.waypoints[S.waypoints.length-1].next=B,S.waypoints.push(B)}}}}},S("OrderUnitsAction",K)}}}),System.register("game/action/PingLocationAction",["game/action/Action","data/DataStream","game/action/ActionType","game/event/PingLocationEvent","game/event/RadarEvent","game/rules/general/RadarRules"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class extends B.Action{constructor(S){super(j.ActionType.PingLocation),this.game=S}unserialize(S){let O=new N.DataStream(S);this.tile={x:O.readUint16(),y:O.readUint16()}}serialize(){let S=new N.DataStream(4);return S.writeUint16(this.tile.x),S.writeUint16(this.tile.y),S.toUint8Array()}print(){return`Ping location at tile (${this.tile.x}, ${this.tile.y})`}process(){var S=this.player,O=this.game.map.tiles.getByMapCoords(this.tile.x,this.tile.y);if(O)for(var B of(this.game.events.dispatch(new L.PingLocationEvent(O,S)),[S,...this.game.alliances.getAllies(S)]))this.game.events.dispatch(new D.RadarEvent(B,F.RadarEventType.GenericNonCombat,O));else console.warn(`Tile ${this.tile.x},${this.tile.y} doesn't exist`)}},S("PingLocationAction",_)}}}),System.register("game/action/PlaceBuildingAction",["game/action/Action","data/DataStream","game/event/BuildingPlaceEvent","game/player/production/ProductionQueue","game/rules/TechnoRules","game/gameobject/trait/FactoryTrait","game/action/ActionType","game/event/BuildingFailedPlaceEvent","game/trait/interface/NotifyPlaceBuilding","engine/type/ObjectType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){W=class extends B.Action{constructor(S){super(_.ActionType.PlaceBuilding),this.game=S}unserialize(S){let O=new N.DataStream(S);this.buildingRules=this.game.rules.getTechnoByInternalId(O.readUint32(),V.ObjectType.Building),this.tile={x:O.readUint16(),y:O.readUint16()}}serialize(){let S=new N.DataStream(8);return S.writeUint32(this.buildingRules.index),S.writeUint16(this.tile.x),S.writeUint16(this.tile.y),S.toUint8Array()}print(){return`Place building ${this.buildingRules.name} at tile (${this.tile.x}, ${this.tile.y})`}process(){var S=this.game.map.tiles.getByMapCoords(this.tile.x,this.tile.y);if(S){var O=this.player;const B=this.tryPlaceBuilding(O,S);B?(this.game.traits.filter(H.NotifyPlaceBuilding).forEach(S=>{S[H.NotifyPlaceBuilding.onPlace](B,this.game)}),this.game.events.dispatch(new j.BuildingPlaceEvent(B))):this.game.events.dispatch(new U.BuildingFailedPlaceEvent(this.buildingRules.name,O,S))}else console.warn(`Tile ${this.tile.x},${this.tile.y} doesn't exist`)}tryPlaceBuilding(S,O){var B=this.buildingRules;if(S.production){let j=S.production.getQueueForObject(B);if(j.status===L.QueueStatus.Ready&&j.getFirst().rules===B){let L=this.game.getConstructionWorker(S);if(S.production.isAvailableForProduction(B)&&L.canPlaceAt(B.name,O,{normalizedTile:!0})){var N=L.placeAt(B.name,O,!0);S.addUnitsBuilt(B,1),j.shift(B,1);let _=S.production.getPrimaryFactory(D.FactoryType.BuildingType);return _&&(_.factoryTrait.status=F.FactoryStatus.Delivering),N[0]}}}}},S("PlaceBuildingAction",W)}}}),System.register("game/action/ResignGameAction",["game/action/Action","game/event/PlayerResignedEvent","game/action/ActionType"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends B.Action{constructor(S,O){super(j.ActionType.ResignGame),this.game=S,this.localPlayerName=O}process(){if(this.localPlayerName!==this.player.name){let O=this.player;var S=this.game.redistributeAllPlayerAssets(O);this.game.removeAllPlayerAssets(O),O.isCombatant()&&(O.resigned=!0,this.game.events.dispatch(new N.PlayerResignedEvent(O,S)))}}},S("ResignGameAction",L)}}}),System.register("game/action/SelectUnitsAction",["game/action/Action","game/action/ActionType","data/DataStream","game/action/OrderUnitsAction"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends B.Action{get unitIds(){return this._unitIds}set unitIds(S){this._unitIds=S.slice(0,L.ORDER_UNIT_LIMIT)}constructor(S,O){super(N.ActionType.SelectUnits),this.orderActionContext=O}unserialize(S){let O=new j.DataStream(S);this.unitIds=new Array(S.byteLength/4);for(let B=0;B<S.byteLength/4;B++)this.unitIds[B]=O.readUint32()}serialize(){let S=new j.DataStream(4*this.unitIds.length);for(var O of(S.dynamicSize=!1,this.unitIds))S.writeUint32(O);return S.toUint8Array()}print(){return`Select unit(s) [${this.unitIds.join(",")}]`}process(){let S=this.player,O=[];for(var B of this.unitIds)(B=S.getOwnedObjectById(B))&&O.push(B);this.orderActionContext.getOrCreateSelection(S).update(O)}},S("SelectUnitsAction",D)}}}),System.register("game/action/SellObjectAction",["game/action/Action","data/DataStream","game/gameobject/Building","game/action/ActionType","game/gameobject/trait/DockableTrait"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends B.Action{constructor(S){super(L.ActionType.SellObject),this.game=S}unserialize(S){this.objectId=new N.DataStream(S).readUint32()}serialize(){return new N.DataStream(4).writeUint32(this.objectId).toUint8Array()}print(){return"Sell object "+this.objectId}process(){var S=this.player;if(this.game.getWorld().hasObjectId(this.objectId)){let O=this.game.getObjectById(this.objectId);O.isTechno()&&S===O.owner&&O.isSpawned&&(O.isBuilding()?O.buildStatus===j.BuildStatus.Ready&&!O.warpedOutTrait.isActive():O.traits.find(D.DockableTrait)?.dock?.rules.unitSell)&&this.game.sellTrait.sell(O)}}},S("SellObjectAction",F)}}}),System.register("game/action/ToggleAllianceAction",["game/action/Action","game/Alliances","game/event/AllianceChangeEvent","game/trait/interface/NotifyAllianceChange","game/action/ActionType"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends B.Action{constructor(S){super(D.ActionType.ToggleAlliance),this.game=S}unserialize(S){this.toPlayer=this.game.getPlayer(S[0]),this.toggle=Boolean(S[1])}serialize(){return new Uint8Array([this.game.getPlayerNumber(this.toPlayer),this.toggle?1:0])}print(){return`Toggle alliance ${this.toggle?"on":"off"} with `+this.toPlayer.name}process(){if((D=this.game.rules.mpDialogSettings).alliesAllowed&&D.allyChangeAllowed){var S,O=this.player,B=this.toPlayer,D=this.toggle;let F=O,_=B,U=this.game.alliances;if(!O.defeated&&U.canRequestAlliance(_)){let B=U.findByPlayers(F,_);B?B.status===N.AllianceStatus.Formed?D||(U.breakAlliance(F,_),this.game.onAllianceChange(B,F,!1)):B.status===N.AllianceStatus.Requested&&(B.players.first===_?D&&U.canFormAlliance(F,_)&&(U.acceptRequest(_,F),this.game.onAllianceChange(B,F,!0),1!==(O=this.game.getCombatants().filter(S=>S!==F&&!U.areAllied(F,S))).length||(S=U.findByPlayers(O[0],F))&&U.cancelRequest(S.players.first,S.players.second),1!==(S=this.game.getCombatants().filter(S=>S!==_&&!U.areAllied(_,S))).length||(S=U.findByPlayers(S[0],_))&&U.cancelRequest(S.players.first,S.players.second)):D||(U.cancelRequest(F,_),this.game.events.dispatch(new j.AllianceChangeEvent(B,j.AllianceEventType.Broken,F)),this.game.traits.filter(L.NotifyAllianceChange).forEach(S=>{S[L.NotifyAllianceChange.onChange](B,!1,this.game)}))):D&&U.canFormAlliance(F,_)&&(D=U.request(F,_))&&this.game.events.dispatch(new j.AllianceChangeEvent(D,j.AllianceEventType.Requested,F))}}}},S("ToggleAllianceAction",F)}}}),System.register("game/action/ToggleRepairAction",["game/action/Action","data/DataStream","game/gameobject/trait/AutoRepairTrait","game/event/BuildingRepairStartEvent","game/action/ActionType"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends B.Action{constructor(S){super(D.ActionType.ToggleRepair),this.game=S}unserialize(S){this.buildingId=new N.DataStream(S).readUint32()}serialize(){return new N.DataStream(4).writeUint32(this.buildingId).toUint8Array()}print(){return"Toggle repair "+this.buildingId}process(){var S=this.player;if(this.game.getWorld().hasObjectId(this.buildingId)){let O=this.game.getObjectById(this.buildingId);if(O.isBuilding()&&S===O.owner&&!O.isDestroyed&&O.rules.repairable&&O.rules.clickRepairable&&100!==O.healthTrait.health){let S=O.traits.get(j.AutoRepairTrait);S.setDisabled(!S.isDisabled()),S.isDisabled()||this.game.events.dispatch(new L.BuildingRepairStartEvent(O))}}}},S("ToggleRepairAction",F)}}}),System.register("game/action/UpdateQueueAction",["game/action/Action","data/DataStream","game/player/production/ProductionQueue","engine/type/ObjectType","game/action/ActionType"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){var O;(O=F||S("UpdateType",F={}))[O.Add=0]="Add",O[O.Cancel=1]="Cancel",O[O.Pause=2]="Pause",O[O.Resume=3]="Resume",_=class extends B.Action{constructor(S){super(D.ActionType.UpdateQueue),this.game=S}unserialize(S){let O=new N.DataStream(S);var B,j;this.queueType=O.readUint8(),this.updateType=O.readUint8(),this.updateType!==F.Add&&this.updateType!==F.Cancel||(B=O.readUint32(),j=O.readUint8(),this.item=this.game.rules.getTechnoByInternalId(B,j),this.quantity=O.readUint16())}serialize(){let S=new N.DataStream(9);if(S.dynamicSize=!1,S.writeUint8(this.queueType),S.writeUint8(this.updateType),this.updateType===F.Add||this.updateType===F.Cancel){if(void 0===this.quantity)throw new Error("Missing quantity");if(65535<this.quantity)throw new Error("Maximum quantity exceeded");S.writeUint32(this.item.index),S.writeUint8(this.item.type),S.writeUint16(this.quantity)}return new Uint8Array(S.buffer,S.byteOffset,S.position)}print(){return this.updateType===F.Resume?"Resume queue "+j.QueueType[this.queueType]:this.updateType===F.Add?`Add to queue ${this.item.name} x `+this.quantity:this.updateType===F.Pause?`Put queue ${j.QueueType[this.queueType]} on hold.`:this.updateType===F.Cancel?`Cancel ${this.item.name} x `+this.quantity:"Unhandled queue update type "+this.updateType}process(){let S=this.player,O=this.item,B=S.production.getQueue(this.queueType);if(this.updateType===F.Resume)B.status===j.QueueStatus.OnHold&&(B.status=j.QueueStatus.Active);else if(this.updateType===F.Add){let F=B.find(O);if(B.status===j.QueueStatus.Active||B.status===j.QueueStatus.Idle||B.status===j.QueueStatus.OnHold&&F[0]!==B.getFirst()||B.status===j.QueueStatus.Ready&&O.type!==L.ObjectType.Building){let j;var N=F.reduce((S,O)=>S+O.quantity,0);if(Number.isFinite(O.buildLimit)){let B;B=0<=O.buildLimit?S.getOwnedObjectsByType(O.type,!0).filter(S=>S.name===O.name).length:S.getLimitedUnitsBuilt(O.name),j=Math.max(0,Math.abs(O.buildLimit)-(B+N))}else j=Number.POSITIVE_INFINITY;j&&S.production.isAvailableForProduction(O)&&(D=Math.min(B.maxSize-B.currentSize,B.maxItemQuantity-N,j),0<(_=Math.min(this.quantity,D))&&B.push(O,_,O.cost))}}else if(this.updateType===F.Cancel){if([j.QueueStatus.Ready,j.QueueStatus.OnHold,j.QueueStatus.Active].includes(B.status)){let N=B.find(O);var D,_;N.length&&(D=N.reduce((S,O)=>S+O.quantity,0),0<(_=Math.min(D,this.quantity))&&(B.pop(O,_),_===D&&(S.credits+=N[0].creditsSpent)))}}else this.updateType===F.Pause&&B.status===j.QueueStatus.Active&&(B.status=j.QueueStatus.OnHold)}},S("UpdateQueueAction",_)}}}),System.register("game/action/factories/ActivateSuperWeaponActionFactory",["game/action/ActivateSuperWeaponAction"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ActivateSuperWeaponActionFactory",class{constructor(S){this.game=S}create(){return new B.ActivateSuperWeaponAction(this.game)}})}}}),System.register("game/action/factories/DebugActionFactory",["game/action/DebugAction"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("DebugActionFactory",class{constructor(S){this.game=S}create(){return new B.DebugAction(this.game)}})}}}),System.register("game/action/factories/DropPlayerActionFactory",["game/action/DropPlayerAction"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("DropPlayerActionFactory",class{constructor(S,O){this.game=S,this.localPlayerName=O}create(){return new B.DropPlayerAction(this.game,this.localPlayerName)}})}}}),System.register("game/action/factories/NoActionFactory",["game/action/NoAction"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("NoActionFactory",class{create(){return new B.NoAction}})}}}),System.register("game/action/factories/ObserveGameActionFactory",["game/action/ObserveGameAction"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ObserveGameActionFactory",class{constructor(S){this.game=S}create(){return new B.ObserveGameAction(this.game)}})}}}),System.register("game/action/factories/OrderUnitsActionFactory",["game/action/OrderUnitsAction","game/order/OrderFactory"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("OrderUnitsActionFactory",class{constructor(S,O,B){this.game=S,this.map=O,this.orderActionContext=B}create(){return new B.OrderUnitsAction(this.game,this.map,this.orderActionContext,new N.OrderFactory(this.game,this.map))}})}}}),System.register("game/action/factories/PingLocationActionFactory",["game/action/PingLocationAction"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("PingLocationActionFactory",class{constructor(S){this.game=S}create(){return new B.PingLocationAction(this.game)}})}}}),System.register("game/action/factories/PlaceBuildingActionFactory",["game/action/PlaceBuildingAction"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("PlaceBuildingActionFactory",class{constructor(S){this.game=S}create(){return new B.PlaceBuildingAction(this.game)}})}}}),System.register("game/action/factories/ResignGameActionFactory",["game/action/ResignGameAction"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ResignGameActionFactory",class{constructor(S,O){this.game=S,this.localPlayerName=O}create(){return new B.ResignGameAction(this.game,this.localPlayerName)}})}}}),System.register("game/action/factories/SelectUnitsActionFactory",["game/action/SelectUnitsAction"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("SelectUnitsActionFactory",class{constructor(S,O){this.game=S,this.orderActionContext=O}create(){return new B.SelectUnitsAction(this.game,this.orderActionContext)}})}}}),System.register("game/action/factories/SellObjectActionFactory",["game/action/SellObjectAction"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("SellObjectActionFactory",class{constructor(S){this.game=S}create(){return new B.SellObjectAction(this.game)}})}}}),System.register("game/action/factories/ToggleAllianceFactory",["game/action/ToggleAllianceAction"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ToggleAllianceActionFactory",class{constructor(S){this.game=S}create(){return new B.ToggleAllianceAction(this.game)}})}}}),System.register("game/action/factories/ToggleRepairActionFactory",["game/action/ToggleRepairAction"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ToggleRepairActionFactory",class{constructor(S){this.game=S}create(){return new B.ToggleRepairAction(this.game)}})}}}),System.register("game/action/factories/UpdateQueueActionFactory",["game/action/UpdateQueueAction"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("UpdateQueueActionFactory",class{constructor(S){this.game=S}create(){return new B.UpdateQueueAction(this.game)}})}}}),System.register("game/ai/Ai",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("Ai",class{constructor(S){this.ini=S}getIni(){return this.ini}})}}}),System.register("game/api/ActionsApi",["game/action/ActionType","game/action/UpdateQueueAction","game/action/DebugAction"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V;return O&&O.id,{setters:[function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){S("ActionsApi",class{constructor(S,O,_,U,H){B.add(this),N.set(this,void 0),j.set(this,void 0),L.set(this,void 0),D.set(this,void 0),F.set(this,void 0),__classPrivateFieldSet(this,N,O,"f"),__classPrivateFieldSet(this,j,_,"f"),__classPrivateFieldSet(this,L,S,"f"),__classPrivateFieldSet(this,D,U,"f"),__classPrivateFieldSet(this,F,H,"f")}placeBuilding(S,O,N){__classPrivateFieldGet(this,B,"m",_).call(this,U.ActionType.PlaceBuilding,B=>{B.buildingRules=__classPrivateFieldGet(this,L,"f").rules.getBuilding(S),B.tile={x:O,y:N}})}sellObject(S){__classPrivateFieldGet(this,B,"m",_).call(this,U.ActionType.SellObject,O=>{O.objectId=S})}sellBuilding(S){this.sellObject(S)}toggleRepairWrench(S){__classPrivateFieldGet(this,B,"m",_).call(this,U.ActionType.ToggleRepair,O=>{O.buildingId=S})}toggleAlliance(S,O){__classPrivateFieldGet(this,B,"m",_).call(this,U.ActionType.ToggleAlliance,B=>{B.toPlayer=__classPrivateFieldGet(this,L,"f").getPlayerByName(S),B.toggle=O})}pauseProduction(S){__classPrivateFieldGet(this,B,"m",_).call(this,U.ActionType.UpdateQueue,O=>{O.queueType=S,O.updateType=H.UpdateType.Pause})}resumeProduction(S){__classPrivateFieldGet(this,B,"m",_).call(this,U.ActionType.UpdateQueue,O=>{O.queueType=S,O.updateType=H.UpdateType.Resume})}queueForProduction(S,O,N,j){let D=__classPrivateFieldGet(this,L,"f").rules.getObject(O,N);__classPrivateFieldGet(this,B,"m",_).call(this,U.ActionType.UpdateQueue,O=>{O.queueType=S,O.updateType=H.UpdateType.Add,O.item=D,O.quantity=j})}unqueueFromProduction(S,O,N,j){let D=__classPrivateFieldGet(this,L,"f").rules.getObject(O,N);__classPrivateFieldGet(this,B,"m",_).call(this,U.ActionType.UpdateQueue,O=>{O.queueType=S,O.updateType=H.UpdateType.Cancel,O.item=D,O.quantity=j})}activateSuperWeapon(S,O,N){__classPrivateFieldGet(this,B,"m",_).call(this,U.ActionType.ActivateSuperWeapon,B=>{B.superWeaponType=S,B.tile={x:O.rx,y:O.ry},B.tile2=N?{x:N.rx,y:N.ry}:void 0})}orderUnits(S,O,N,j,D){let F;if(__classPrivateFieldGet(this,B,"m",_).call(this,U.ActionType.SelectUnits,O=>{O.unitIds=S}),N){let S,O;if(j){S=void 0;var H=__classPrivateFieldGet(this,L,"f").map.tiles.getByMapCoords(N,j);if(!H)throw new Error(`No tile found at rx,ry=${N},`+j);O=H,D&&(S=__classPrivateFieldGet(this,L,"f").map.tileOccupation.getBridgeOnTile(H))}else{if(!__classPrivateFieldGet(this,L,"f").getWorld().hasObjectId(N))return;S=__classPrivateFieldGet(this,L,"f").getObjectById(N),O=S.tile}F=__classPrivateFieldGet(this,L,"f").createTarget(S,O)}__classPrivateFieldGet(this,B,"m",_).call(this,U.ActionType.OrderUnits,S=>{S.orderType=O,S.target=F})}sayAll(S){__classPrivateFieldGet(this,F,"f")?.sayAll(__classPrivateFieldGet(this,D,"f").name,S)}setGlobalDebugText(S){__classPrivateFieldGet(this,D,"f").getDebugMode()&&__classPrivateFieldGet(this,B,"m",_).call(this,U.ActionType.DebugCommand,O=>{O.command=new V.DebugCommand(V.DebugCommandType.SetGlobalDebugText,{text:S||""})})}setUnitDebugText(S,O){__classPrivateFieldGet(this,D,"f").getDebugMode()&&__classPrivateFieldGet(this,B,"m",_).call(this,U.ActionType.DebugCommand,B=>{B.command=new V.DebugCommand(V.DebugCommandType.SetUnitDebugText,{unitId:S,label:O})})}quitGame(){__classPrivateFieldGet(this,B,"m",_).call(this,U.ActionType.ResignGame)}}),N=new WeakMap,j=new WeakMap,L=new WeakMap,D=new WeakMap,F=new WeakMap,B=new WeakSet,_=function(S,O){let B=__classPrivateFieldGet(this,N,"f").create(S);B.player=__classPrivateFieldGet(this,L,"f").getPlayerByName(__classPrivateFieldGet(this,D,"f").name),O?.(B),__classPrivateFieldGet(this,j,"f").push(B)}}}}),System.register("game/api/ChatApi",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/api/EventsApi",["game/event/EventType"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){D=S}],execute:function(){var O;(O=F||S("ApiEventType",F={}))[O.ObjectOwnerChange=0]="ObjectOwnerChange",O[O.ObjectSpawn=1]="ObjectSpawn",O[O.ObjectUnspawn=2]="ObjectUnspawn",O[O.ObjectDestroy=3]="ObjectDestroy",S("EventsApi",class{constructor(S){B.add(this),N.set(this,void 0),j.set(this,[]),__classPrivateFieldSet(this,N,S,"f")}subscribe(S,O){let D,F;F="function"==typeof S?S:(D=S,O);var _=__classPrivateFieldGet(this,N,"f").subscribe(S=>{var O=__classPrivateFieldGet(this,B,"m",L).call(this,S);!O||void 0!==D&&D!==O.type||F(O)});return __classPrivateFieldGet(this,j,"f").push(_),_}dispose(){for(var S of __classPrivateFieldGet(this,j,"f"))S();__classPrivateFieldGet(this,j,"f").length=0}}),N=new WeakMap,j=new WeakMap,B=new WeakSet,L=function(S){switch(S.type){case D.EventType.ObjectOwnerChange:return{type:F.ObjectOwnerChange,prevOwnerName:S.prevOwner.name,newOwnerName:S.target.owner.name,target:S.target.id};case D.EventType.ObjectSpawn:return{type:F.ObjectSpawn,target:S.gameObject.id};case D.EventType.ObjectUnspawn:return{type:F.ObjectUnspawn,target:S.gameObject.id};case D.EventType.ObjectDestroy:{let O=S;return O.target.isProjectile()?void 0:{type:F.ObjectDestroy,target:O.target.id,attackerInfo:O.attackerInfo?{playerName:O.attackerInfo.player.name,objId:O.attackerInfo.obj?.id,weaponName:O.attackerInfo.weapon?.rules.name}:void 0}}default:return}}}}}),System.register("game/api/GameApi",["game/player/trait/PowerTrait","game/api/MapApi","engine/type/ObjectType","game/GameSpeed","game/api/RulesApi"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;return O&&O.id,{setters:[function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S}],execute:function(){S("GameApi",class{constructor(S,O){B.add(this),N.set(this,void 0),j.set(this,void 0),__classPrivateFieldSet(this,N,S,"f"),__classPrivateFieldSet(this,j,O,"f"),this.mapApi=new F.MapApi(S),this.rulesApi=new H.RulesApi(S.rules)}isPlayerDefeated(S){return __classPrivateFieldGet(this,N,"f").getPlayerByName(S).defeated}areAlliedPlayers(S,O){var B=__classPrivateFieldGet(this,N,"f").getPlayerByName(S);if(!B)throw new Error(`Player "${S}" doesn't exist`);var j=__classPrivateFieldGet(this,N,"f").getPlayerByName(O);if(!j)throw new Error(`Player "${O}" doesn't exist`);return __classPrivateFieldGet(this,N,"f").alliances.areAllied(B,j)}canPlaceBuilding(S,O,B){var j=__classPrivateFieldGet(this,N,"f").getPlayerByName(S);if(!j)throw new Error(`Player "${S}" doesn't exist`);return __classPrivateFieldGet(this,N,"f").getConstructionWorker(j).canPlaceAt(O,B,{normalizedTile:!0})}getBuildingPlacementData(S){var O=__classPrivateFieldGet(this,N,"f").art.getObject(S,_.ObjectType.Building);return{foundation:O.foundation,foundationCenter:O.foundationCenter}}getPlayers(){return __classPrivateFieldGet(this,N,"f").getNonNeutralPlayers().map(S=>S.name)}getPlayerData(S){let O=__classPrivateFieldGet(this,N,"f").getPlayerByName(S);if(!O)throw new Error(`Player "${S}" doesn't exist`);return{name:O.name,country:O.country,startLocation:this.mapApi.getStartingLocations()[O.startLocation??0],isObserver:O.isObserver,isAi:O.isAi,isCombatant:O.isCombatant(),credits:O.credits,power:{total:O.powerTrait?.power??0,drain:O.powerTrait?.drain??0,isLowPower:O.powerTrait?.level===D.PowerLevel.Low},radarDisabled:!!O.radarTrait?.isDisabled()}}getAllTerrainObjects(){return __classPrivateFieldGet(this,N,"f").getWorld().getAllObjects().filter(S=>S.isTerrain()).map(S=>S.id)}getAllUnits(S=()=>!0){return __classPrivateFieldGet(this,N,"f").getWorld().getAllObjects().filter(O=>O.isTechno()&&S(O.rules)).map(S=>S.id)}getNeutralUnits(S=()=>!0){return __classPrivateFieldGet(this,N,"f").getCivilianPlayer().getOwnedObjects().filter(O=>S(O.rules)).map(S=>S.id)}getUnitsInArea(S){return __classPrivateFieldGet(this,N,"f").map.technosByTile.queryRange(S).map(S=>S.id)}getVisibleUnits(S,O,B=()=>!0){const j=__classPrivateFieldGet(this,N,"f").getPlayerByName(S);if(!j)throw new Error(`Player "${S}" doesn't exist`);if("self"===O)return j.getOwnedObjects().filter(S=>B(S.rules)).map(S=>S.id);let L;if("allied"===O)L=S=>S.owner===j||__classPrivateFieldGet(this,N,"f").alliances.areAllied(S.owner,j);else{if("hostile"!==O&&"enemy"!==O)throw new Error("Unexpected type "+O);{let S=__classPrivateFieldGet(this,N,"f").mapShroudTrait.getPlayerShroud(j);L=B=>__classPrivateFieldGet(this,N,"f").map.tileOccupation.calculateTilesForGameObject(B.tile,B).some(O=>!S?.isShrouded(O,B.tileElevation))&&B.owner!==j&&!__classPrivateFieldGet(this,N,"f").alliances.areAllied(B.owner,j)&&("enemy"!==O||B.owner.isCombatant())}}return __classPrivateFieldGet(this,N,"f").getWorld().getAllObjects().filter(S=>S.isTechno()&&!S.isDestroyed&&L(S)&&B(S.rules)).map(S=>S.id)}getGameObjectData(S){if(__classPrivateFieldGet(this,N,"f").getWorld().hasObjectId(S)){let O=__classPrivateFieldGet(this,N,"f").getObjectById(S);return{id:O.id,type:O.type,name:O.name,rules:O.rules,tile:O.tile,tileElevation:O.tileElevation,worldPosition:O.position.worldPosition.clone(),foundation:O.getFoundation(),hitPoints:O.healthTrait?.getHitPoints(),maxHitPoints:O.healthTrait?.maxHitPoints,owner:O.isTechno()?O.owner.name:void 0}}}getUnitData(S){var O=this.getGameObjectData(S);if(O){let j=__classPrivateFieldGet(this,N,"f").getObjectById(S);if(!j.isTechno())throw new Error(`Game object with id ${S} is not a Techno type`);return{...O,owner:j.owner.name,sight:j.sight,veteranLevel:j.veteranLevel,guardMode:j.guardMode,purchaseValue:j.purchaseValue,primaryWeapon:j.primaryWeapon?__classPrivateFieldGet(this,B,"m",L).call(this,j.primaryWeapon):void 0,secondaryWeapon:j.secondaryWeapon?__classPrivateFieldGet(this,B,"m",L).call(this,j.secondaryWeapon):void 0,deathWeapon:j.armedTrait?.deathWeapon?__classPrivateFieldGet(this,B,"m",L).call(this,j.armedTrait.deathWeapon):void 0,attackState:j.attackTrait?.attackState,direction:j.direction,onBridge:j.isInfantry()||j.isVehicle()?j.onBridge:void 0,zone:j.isUnit()?j.zone:void 0,buildStatus:j.isBuilding()?j.buildStatus:void 0,factory:j.isBuilding()&&j.factoryTrait?{deliveringUnit:j.factoryTrait.deliveringUnit?.id,status:j.factoryTrait.status}:void 0,rallyPoint:j.isBuilding()?j.rallyTrait?.getRallyPoint():void 0,isPoweredOn:j.isBuilding()&&j.poweredTrait?.isPoweredOn(),hasWrenchRepair:j.isBuilding()&&!j.autoRepairTrait.isDisabled(),turretFacing:j.isBuilding()||j.isVehicle()?j.turretTrait?.facing:void 0,turretNo:j.isVehicle()?j.turretNo:void 0,garrisonUnitCount:j.isBuilding()?j.garrisonTrait?.units.length:void 0,garrisonUnitsMax:j.isBuilding()?j.garrisonTrait?.maxOccupants:void 0,passengerSlotCount:j.isVehicle()?j.transportTrait?.getOccupiedCapacity():void 0,passengerSlotMax:j.isVehicle()?j.transportTrait?.getMaxCapacity():void 0,isIdle:!j.unitOrderTrait.hasTasks(),canMove:j.isUnit()?!j.moveTrait.isDisabled():void 0,velocity:j.isUnit()?j.moveTrait.velocity.clone():void 0,stance:j.isInfantry()?j.stance:void 0,harvestedOre:j.isVehicle()?j.harvesterTrait?.ore:void 0,harvestedGems:j.isVehicle()?j.harvesterTrait?.gems:void 0,ammo:j.isAircraft()?j.ammo:void 0,isWarpedOut:j.warpedOutTrait.isActive(),mindControlledBy:j.mindControllableTrait?.getController()?.id,tntTimer:j.tntChargeTrait?.getTicksLeft()}}}getAllSuperWeaponData(){return __classPrivateFieldGet(this,N,"f").getCombatants().map(S=>S.superWeaponsTrait.getAll().map(O=>({playerName:S.name,type:O.rules.type,status:O.status,timerSeconds:O.getTimerSeconds()}))).flat()}getGeneralRules(){return __classPrivateFieldGet(this,N,"f").rules.general}getRulesIni(){return __classPrivateFieldGet(this,N,"f").rules.getIni()}getArtIni(){return __classPrivateFieldGet(this,N,"f").art.getIni()}getAiIni(){return __classPrivateFieldGet(this,N,"f").ai.getIni()}generateRandomInt(S,O){if(__classPrivateFieldGet(this,j,"f"))return __classPrivateFieldGet(this,N,"f").generateRandomInt(S,O);var B=this.generateRandom();return Math.round(B*(O-S))+S}generateRandom(){return __classPrivateFieldGet(this,j,"f")?__classPrivateFieldGet(this,N,"f").generateRandom():Math.random()}getTickRate(){return __classPrivateFieldGet(this,N,"f").speed.value*U.GameSpeed.BASE_TICKS_PER_SECOND}getBaseTickRate(){return U.GameSpeed.BASE_TICKS_PER_SECOND}getCurrentTick(){return __classPrivateFieldGet(this,N,"f").currentTick}getCurrentTime(){return __classPrivateFieldGet(this,N,"f").currentTime/1e3}}),N=new WeakMap,j=new WeakMap,B=new WeakSet,L=function(S){return{type:S.type,rules:S.rules,projectileRules:S.projectileRules,warheadRules:S.warhead.rules,minRange:S.minRange,maxRange:S.range,speed:S.speed,cooldownTicks:S.getCooldownTicks()}}}}}),System.register("game/api/LoggerApi",["util/format","util/Logger"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){D=S},function(S){F=S}],execute:function(){S("LoggerApi",class{constructor(S,O){B.add(this),N.set(this,void 0),j.set(this,void 0),__classPrivateFieldSet(this,N,S,"f"),__classPrivateFieldSet(this,j,O,"f")}setDebugLevel(S){__classPrivateFieldGet(this,N,"f").setLevel(S?F.AppLogger.DEBUG:F.AppLogger.WARN)}debug(...S){__classPrivateFieldGet(this,N,"f").debug(__classPrivateFieldGet(this,B,"m",L).call(this),...S)}info(...S){__classPrivateFieldGet(this,N,"f").info(__classPrivateFieldGet(this,B,"m",L).call(this),...S)}log(...S){__classPrivateFieldGet(this,N,"f").log(__classPrivateFieldGet(this,B,"m",L).call(this),...S)}warn(...S){__classPrivateFieldGet(this,N,"f").warn(__classPrivateFieldGet(this,B,"m",L).call(this),...S)}error(...S){__classPrivateFieldGet(this,N,"f").error(__classPrivateFieldGet(this,B,"m",L).call(this),...S)}time(S){__classPrivateFieldGet(this,N,"f").time(S)}timeEnd(S){__classPrivateFieldGet(this,N,"f").timeEnd(S)}}),N=new WeakMap,j=new WeakMap,B=new WeakSet,L=function(){return"["+D.formatTimeDuration(Math.floor(__classPrivateFieldGet(this,j,"f").getCurrentTime()))+"]"}}}}),System.register("game/api/MapApi",["game/type/SpeedType","game/gameobject/trait/TiberiumTrait","engine/type/TiberiumType","game/math/Vector2"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){S("MapApi",class{constructor(S){B.add(this),N.set(this,void 0),j.set(this,void 0),__classPrivateFieldSet(this,N,S,"f"),__classPrivateFieldSet(this,j,S.map,"f")}getRealMapSize(){return __classPrivateFieldGet(this,j,"f").tiles.getMapSize()}getStartingLocations(){return __classPrivateFieldGet(this,j,"f").startingLocations.map(S=>new U.Vector2(S.x,S.y))}getTheaterType(){return __classPrivateFieldGet(this,j,"f").getTheaterType()}getTile(S,O){var B=__classPrivateFieldGet(this,j,"f").tiles.getByMapCoords(S,O);if(B&&__classPrivateFieldGet(this,j,"f").mapBounds.isWithinBounds(B))return B}getTilesInRect(S,O){return(O?__classPrivateFieldGet(this,j,"f").tiles.getInRectangle(S,O):__classPrivateFieldGet(this,j,"f").tiles.getInRectangle(S)).filter(S=>__classPrivateFieldGet(this,j,"f").mapBounds.isWithinBounds(S))}getObjectsOnTile(S){return __classPrivateFieldGet(this,j,"f").getObjectsOnTile(S).map(S=>S.id)}hasBridgeOnTile(S){return!!S.onBridgeLandType}hasHighBridgeOnTile(S){return!!__classPrivateFieldGet(this,j,"f").tileOccupation.getBridgeOnTile(S)?.isHighBridge()}isPassableTile(S,O,B,N){return N=N??O===D.SpeedType.Foot,0<__classPrivateFieldGet(this,j,"f").terrain.getPassableSpeed(S,O,N,B)}findPath(S,...O){const[B,j,L,F]=O="boolean"!=typeof O[0]?[S===D.SpeedType.Foot,...O]:O;let _=__classPrivateFieldGet(this,N,"f").map.terrain.computePath(S,B,j.tile,j.onBridge,L.tile,L.onBridge,{bestEffort:F?.bestEffort,excludeTiles:F?.excludeNodes?S=>F.excludeNodes({tile:S.tile,onBridge:!!S.onBridge}):void 0,maxExpandedNodes:F?.maxExpandedNodes});return _.map(S=>({tile:S.tile,onBridge:!!S.onBridge}))}isVisibleTile(S,O,B=0){var j=__classPrivateFieldGet(this,N,"f").getPlayerByName(O);if(!j)throw new Error(`Player "${O}" doesn't exist`);return!__classPrivateFieldGet(this,N,"f").mapShroudTrait.getPlayerShroud(j)?.isShrouded(S,B)}getTileResourceData(S){var O=__classPrivateFieldGet(this,j,"f").getObjectsOnTile(S).find(S=>S.isOverlay()&&S.isTiberium()||S.isTerrain()&&S.rules.spawnsTiberium);return O?__classPrivateFieldGet(this,B,"m",L).call(this,O):void 0}getAllTilesResourceData(){var S;let O=[];for(S of __classPrivateFieldGet(this,N,"f").getWorld().getAllObjects()){var j=__classPrivateFieldGet(this,B,"m",L).call(this,S);j&&O.push(j)}return O}}),N=new WeakMap,j=new WeakMap,B=new WeakSet,L=function(S){let O;if(S.isOverlay()&&S.isTiberium()){let j=S.traits.get(F.TiberiumTrait);var B=j.getTiberiumType(),N=j.getBailCount();O={tile:S.tile,ore:B===_.TiberiumType.Ore?N:0,gems:B===_.TiberiumType.Gems?N:0,spawnsOre:!1}}else S.isTerrain()&&S.rules.spawnsTiberium&&(O={tile:S.tile,ore:0,gems:0,spawnsOre:!0});return O}}}}),System.register("game/api/ProductionApi",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){S("ProductionApi",class{constructor(S){B.set(this,void 0),__classPrivateFieldSet(this,B,S,"f")}isAvailableForProduction(S){return __classPrivateFieldGet(this,B,"f").isAvailableForProduction(S)}getAvailableObjects(S){let O=__classPrivateFieldGet(this,B,"f").getAvailableObjects();return void 0!==S&&(O=O.filter(O=>this.getQueueTypeForObject(O)===S)),O}getQueueTypeForObject(S){return __classPrivateFieldGet(this,B,"f").getQueueTypeForObject(S)}getQueueData(S){let O=__classPrivateFieldGet(this,B,"f").getQueue(S);return{size:O.currentSize,maxSize:O.maxSize,status:O.status,type:O.type,items:O.getAll().map(S=>({rules:S.rules,quantity:S.quantity}))}}}),B=new WeakMap}}}),System.register("game/api/RulesApi",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){S("RulesApi",class{get allObjectRules(){return __classPrivateFieldGet(this,B,"f").allObjectRules}get buildingRules(){return __classPrivateFieldGet(this,B,"f").buildingRules}get infantryRules(){return __classPrivateFieldGet(this,B,"f").infantryRules}get vehicleRules(){return __classPrivateFieldGet(this,B,"f").vehicleRules}get aircraftRules(){return __classPrivateFieldGet(this,B,"f").aircraftRules}get terrainRules(){return __classPrivateFieldGet(this,B,"f").terrainRules}get overlayRules(){return __classPrivateFieldGet(this,B,"f").overlayRules}get countryRules(){return __classPrivateFieldGet(this,B,"f").countryRules}get general(){return __classPrivateFieldGet(this,B,"f").general}get ai(){return __classPrivateFieldGet(this,B,"f").ai}get crateRules(){return __classPrivateFieldGet(this,B,"f").crateRules}get combatDamage(){return __classPrivateFieldGet(this,B,"f").combatDamage}get radiation(){return __classPrivateFieldGet(this,B,"f").radiation}constructor(S){B.set(this,void 0),__classPrivateFieldSet(this,B,S,"f")}hasObject(S,O){return __classPrivateFieldGet(this,B,"f").hasObject(S,O)}getObject(S,O){return __classPrivateFieldGet(this,B,"f").getObject(S,O)}getBuilding(S){return __classPrivateFieldGet(this,B,"f").getBuilding(S)}getWeapon(S){return __classPrivateFieldGet(this,B,"f").getWeapon(S)}getWarhead(S){return __classPrivateFieldGet(this,B,"f").getWarhead(S)}getProjectile(S){return __classPrivateFieldGet(this,B,"f").getProjectile(S)}getOverlayName(S){return __classPrivateFieldGet(this,B,"f").getOverlayName(S)}getOverlayId(S){return __classPrivateFieldGet(this,B,"f").getOverlayId(S)}getOverlay(S){return __classPrivateFieldGet(this,B,"f").getOverlay(S)}getCountry(S){return __classPrivateFieldGet(this,B,"f").getCountry(S)}getMultiplayerCountries(){return __classPrivateFieldGet(this,B,"f").getMultiplayerCountries()}getIni(){return __classPrivateFieldGet(this,B,"f").getIni()}}),B=new WeakMap}}}),System.register("game/api/index",["game/bot/Bot","game/api/EventsApi","game/math/GameMath","game/math/Box2","game/math/Vector2","game/math/Vector3","game/math/Euler","game/math/Quaternion","game/math/Matrix4","game/math/Spherical","game/math/Cylindrical","engine/TheaterType","engine/type/ObjectType","game/gameobject/Building","game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/gameobject/trait/AttackTrait","game/gameobject/trait/FactoryTrait","game/gameobject/unit/VeteranLevel","game/order/OrderType","game/player/production/ProductionQueue","game/rules/GeneralRules","game/rules/general/RadarRules","game/type/SpeedType","game/WeaponType","game/rules/TechnoRules","data/map/tag/TagRepeatType","engine/type/TerrainType","game/gameobject/infantry/InfDeathType","game/gameobject/unit/VeteranAbility","game/SideType","game/type/ArmorType","game/type/LandTargeting","game/type/LandType","game/type/LocomotorType","game/type/MovementZone","game/type/NavalTargeting","game/type/PipColor","game/type/SuperWeaponType","game/SuperWeapon","game/type/VhpScan"],function(S,O){"use strict";return O&&O.id,{setters:[function(O){S({Bot:O.Bot})},function(O){S({ApiEventType:O.ApiEventType})},function(O){S({GameMath:O.GameMath})},function(O){S({Box2:O.Box2})},function(O){S({Vector2:O.Vector2})},function(O){S({Vector3:O.Vector3})},function(O){S({Euler:O.Euler})},function(O){S({Quaternion:O.Quaternion})},function(O){S({Matrix4:O.Matrix4})},function(O){S({Spherical:O.Spherical})},function(O){S({Cylindrical:O.Cylindrical})},function(O){S({TheaterType:O.TheaterType})},function(O){S({ObjectType:O.ObjectType})},function(O){S({BuildStatus:O.BuildStatus})},function(O){S({StanceType:O.StanceType})},function(O){S({ZoneType:O.ZoneType})},function(O){S({AttackState:O.AttackState})},function(O){S({FactoryStatus:O.FactoryStatus})},function(O){S({VeteranLevel:O.VeteranLevel})},function(O){S({OrderType:O.OrderType})},function(O){S({QueueType:O.QueueType}),S({QueueStatus:O.QueueStatus})},function(O){S({PrereqCategory:O.PrereqCategory})},function(O){S({RadarEventType:O.RadarEventType})},function(O){S({SpeedType:O.SpeedType})},function(O){S({WeaponType:O.WeaponType})},function(O){S({FactoryType:O.FactoryType}),S({BuildCat:O.BuildCat})},function(O){S({TagRepeatType:O.TagRepeatType})},function(O){S({TerrainType:O.TerrainType})},function(O){S({InfDeathType:O.InfDeathType})},function(O){S({VeteranAbility:O.VeteranAbility})},function(O){S({SideType:O.SideType})},function(O){S({ArmorType:O.ArmorType})},function(O){S({LandTargeting:O.LandTargeting})},function(O){S({LandType:O.LandType})},function(O){S({LocomotorType:O.LocomotorType})},function(O){S({MovementZone:O.MovementZone})},function(O){S({NavalTargeting:O.NavalTargeting})},function(O){S({PipColor:O.PipColor})},function(O){S({SuperWeaponType:O.SuperWeaponType})},function(O){S({SuperWeaponStatus:O.SuperWeaponStatus})},function(O){S({VhpScan:O.VhpScan})}],execute:function(){}}}),System.register("game/api/interface/BuildingPlacementData",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/GameObjectData",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/PathFinderOptions",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/PathNode",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/PlayerData",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/PlayerStats",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/SuperWeaponData",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/TileResourceData",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/UnitData",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/art/Art",["game/art/ObjectArt","engine/type/ObjectType","game/rules/ObjectRules","data/IniSection"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("Art",class{constructor(S,O,B,N){this.rules=S,this.artIni=O,this.mapFile=B,this.logger=N,this.objectArt=new Map,this.parse()}hasObject(S,O){return this.objectArt.get(O)?.has(S)}getObject(S,O){if(!S)throw new Error(`Must specify an art name for type "${N.ObjectType[O]}"`);var D=this.objectArt.get(O)?.get(S);return D||(this.logger?.debug(`Missing art for object "${S}"`),new B.ObjectArt(O,this.rules.hasObject(S,O)?this.rules.getObject(S,O):new j.ObjectRules(O,new L.IniSection(S)),new L.IniSection(S)))}getAnimation(S){return this.getObject(S,N.ObjectType.Animation)}getProjectile(S){var O=this.rules.getProjectile(S),N=O.imageName;let j=this.artIni.getSection(N);return j||(this.logger?.debug(`Image ${N} (Projectile: ${S}) has no section in art.ini`),j=new L.IniSection(N)),B.ObjectArt.factory(O.type,O,this.artIni,j)}getIni(){return this.artIni}parse(){this.rules.allObjectRules.forEach((S,O)=>{let j=new Map;this.objectArt.set(O,j),S.forEach(S=>{var O=this.artIni.getSection(S.imageName),L=this.artIni.getSection(S.name);(O=this.applyUnitMapOverrides(S,this.mapFile,L,O))?(O=B.ObjectArt.factory(S.type,S,this.artIni,O),j.set(S.name,O)):this.logger?.debug(`${N.ObjectType[S.type]} "${S.name}" has no art section "${S.imageName}"`)})}),[[N.ObjectType.Animation,this.rules.animationNames]].forEach(([S,O])=>{let D=new Map;this.objectArt.set(S,D),O.forEach(O=>{var F,_=this.artIni.getSection(O);_?(F=new j.ObjectRules(S,new L.IniSection(O)),_=new B.ObjectArt(S,F,_),D.set(O,_)):this.logger?.debug(N.ObjectType[S]+` "${O}" has no art section`)})})}applyUnitMapOverrides(S,O,B,j){if([N.ObjectType.Infantry,N.ObjectType.Vehicle,N.ObjectType.Aircraft].includes(S.type)&&O?.getSection(S.name)?.getString("Image")&&B){let O=B.clone();j?.entries.forEach((S,B)=>{O.set(B,S)}),j=O,this.logger?.debug(`${N.ObjectType[S.type]} "${S.name}": Using merged art sections ${S.name} and `+S.imageName)}return j}})}}}),System.register("game/art/FlhCoords",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("FlhCoords",class e{constructor(S){this.forward=0,this.lateral=0,this.vertical=0,S&&3===S.length&&this.fromArray(S)}fromArray(S){return this.forward=S[0],this.lateral=S[1],this.vertical=S[2],this}clone(){return new e([this.forward,this.lateral,this.vertical])}})}}}),System.register("game/art/ObjectArt",["engine/type/PaletteType","engine/type/ObjectType","game/Coords","game/art/SequenceReader","engine/type/LightingType","game/type/LandType","game/rules/OverlayRules","game/rules/TechnoRules","game/rules/TerrainRules","game/rules/ProjectileRules","game/art/FlhCoords","game/math/Vector2","game/math/Vector3"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S}],execute:function(){S("ObjectArt",$=class e{static getDefaultPalette(S){switch(S){case N.ObjectType.Building:case N.ObjectType.Aircraft:case N.ObjectType.Infantry:case N.ObjectType.Vehicle:case N.ObjectType.Projectile:case N.ObjectType.VoxelAnim:return B.PaletteType.Unit;case N.ObjectType.Overlay:return B.PaletteType.Overlay;case N.ObjectType.Smudge:case N.ObjectType.Terrain:return B.PaletteType.Iso;default:return N.ObjectType.Animation,B.PaletteType.Anim}}static getDefaultLighting(S){switch(S){case N.ObjectType.Animation:return D.LightingType.None;case N.ObjectType.Aircraft:case N.ObjectType.Building:case N.ObjectType.Infantry:case N.ObjectType.Vehicle:return D.LightingType.Ambient;case N.ObjectType.Projectile:case N.ObjectType.VoxelAnim:return D.LightingType.Global;case N.ObjectType.Overlay:case N.ObjectType.Smudge:case N.ObjectType.Terrain:default:return D.LightingType.Full}}static getDefaultRemapability(S){switch(S){case N.ObjectType.Aircraft:case N.ObjectType.Building:case N.ObjectType.Infantry:case N.ObjectType.Vehicle:return!0;case N.ObjectType.Overlay:case N.ObjectType.Smudge:case N.ObjectType.Terrain:case N.ObjectType.Animation:case N.ObjectType.Projectile:case N.ObjectType.VoxelAnim:return!1;default:throw new Error("Unknown object type "+S)}}static getDefaultDrawOffset(S){switch(S){case N.ObjectType.Animation:case N.ObjectType.Building:case N.ObjectType.Vehicle:case N.ObjectType.Infantry:case N.ObjectType.Overlay:case N.ObjectType.Smudge:case N.ObjectType.Projectile:case N.ObjectType.VoxelAnim:return new z.Vector2(0,0);case N.ObjectType.Terrain:case N.ObjectType.Aircraft:return new z.Vector2(0,(j.Coords.ISO_TILE_SIZE+1)/2);default:throw new Error("Unknown object type "+S)}}static getDefaultShadow(S){switch(S){case N.ObjectType.Overlay:case N.ObjectType.Building:case N.ObjectType.Infantry:case N.ObjectType.Terrain:case N.ObjectType.Vehicle:case N.ObjectType.Aircraft:return!0;default:case N.ObjectType.Smudge:case N.ObjectType.Animation:case N.ObjectType.Projectile:case N.ObjectType.VoxelAnim:return!1}}static getDefaultHeight(S){switch(S){case N.ObjectType.Building:return 2;case N.ObjectType.Infantry:case N.ObjectType.Vehicle:case N.ObjectType.Aircraft:return 1;default:return 0}}static factory(S,O,B,j){let D=new this(S,O,j);var F;return S===N.ObjectType.Infantry&&(!(F=j.getString("Sequence"))||(F=B.getSection(F))&&(D.sequences=(new L.SequenceReader).readIni(F))),D}constructor(S,O,B){this.sequences=new Map,this.dockingOffsets=[],this.type=S,this.rules=O,this.art=B,this.init()}init(){this.image=[N.ObjectType.Infantry,N.ObjectType.Vehicle,N.ObjectType.Aircraft].includes(this.type)?"":this.art.getString("Image"),this.report=this.art.getString("Report")||void 0,this.readRotors(),this.noHva=this.art.getBool("NoHVA"),this.startSound=this.art.getString("StartSound")||void 0,this.readMuzzleFlash(),this.readPaletteAndLightingTypes(),this.readRemapability(),this.readFlatness(),this.readDockingOffsets();var S=this.art.getNumberArray("QueueingCell");this.queueingCell=S.length?new z.Vector2(S[0],S[1]):void 0,this.demandLoad=this.art.getBool("DemandLoad");var O=this.art.getBool("UseLineTrail"),B=this.art.getNumberArray("LineTrailColor");S=this.art.getNumber("LineTrailColorDecrement",e.DEFAULT_LINE_TRAIL_DEC),O&&B.length?(this.useLineTrail=!0,this.lineTrailColor=B,this.lineTrailColorDecrement=S):this.useLineTrail=!1,this.crater=this.art.getBool("Crater"),this.forceBigCraters=this.art.getBool("ForceBigCraters"),this.scorch=this.art.getBool("Scorch"),this.height=this.art.getNumber("Height",e.getDefaultHeight(this.type)),this.isVoxel=this.art.getBool("Voxel"),this.occupyHeight=this.art.getNumber("OccupyHeight",this.height),this.type===N.ObjectType.Building?this.canHideThings=this.art.getBool("CanHideThings",!0):this.canHideThings=!1,this.canBeHidden=this.art.getBool("CanBeHidden",!0),this.addOccupy=this.readAddRemoveOccupy("AddOccupy"),this.removeOccupy=this.readAddRemoveOccupy("RemoveOccupy"),this.rotates=this.art.getBool("Rotates")}get imageName(){return(this.image||this.rules.imageName)+(this.rules.alternateArcticArt?"A":"")}get cameo(){return(this.art.getString("Cameo")||e.MISSING_CAMEO).toLowerCase()}get altCameo(){return(this.art.getString("AltCameo")||this.cameo).toLowerCase()}get useTheaterExtension(){return this.art.getBool("Theater")}readPaletteAndLightingTypes(){this.paletteType=B.PaletteType.Default,this.lightingType=D.LightingType.Default,(this.rules instanceof _.OverlayRules?this.rules.noUseTileLandType:void 0)&&(this.paletteType=B.PaletteType.Iso,this.lightingType=D.LightingType.Full),this.art.getBool("TerrainPalette")||this.art.getBool("ShouldUseCellDrawer")?this.paletteType=B.PaletteType.Iso:this.art.getBool("AnimPalette")?(this.paletteType=B.PaletteType.Anim,this.lightingType=D.LightingType.None):this.art.getString("Palette")&&(this.paletteType=B.PaletteType.Custom,this.customPaletteName=this.art.getString("Palette")),this.art.getBool("AltPalette")&&(this.paletteType=B.PaletteType.Unit),(this.rules instanceof _.OverlayRules||this.rules instanceof U.TechnoRules)&&this.rules.wall&&(this.paletteType=B.PaletteType.Unit,this.lightingType=D.LightingType.Ambient),(this.rules instanceof H.TerrainRules||this.rules instanceof U.TechnoRules)&&this.rules.gate&&(this.paletteType=B.PaletteType.Unit),this.rules instanceof H.TerrainRules&&this.rules.spawnsTiberium&&(this.paletteType=B.PaletteType.Unit,this.lightingType=D.LightingType.None),this.rules instanceof _.OverlayRules&&(this.rules.isVeins&&(this.paletteType=B.PaletteType.Unit,this.lightingType=D.LightingType.None),this.rules.isVeinholeMonster&&(this.paletteType=B.PaletteType.Unit,this.lightingType=D.LightingType.None),this.rules.tiberium&&(this.lightingType=D.LightingType.None),this.rules.land===F.LandType.Railroad&&(this.paletteType=B.PaletteType.Iso,this.lightingType=D.LightingType.Full),this.rules.crate&&(this.paletteType=B.PaletteType.Iso,this.lightingType=D.LightingType.Full)),this.paletteType===B.PaletteType.Default&&(this.paletteType=e.getDefaultPalette(this.type)),this.lightingType===D.LightingType.Default&&(this.lightingType=e.getDefaultLighting(this.type))}readRemapability(){this.remapable=e.getDefaultRemapability(this.type),this.art.getBool("TerrainPalette")||this.art.getBool("AnimPalette")?this.remapable=!1:this.rules instanceof V.ProjectileRules&&this.rules.firersPalette&&(this.remapable=!0)}readFlatness(){let S=!1;this.type===N.ObjectType.Building||this.type===N.ObjectType.Animation?S=this.art.getBool("Flat"):this.type===N.ObjectType.Smudge&&(S=!0),this.rules instanceof _.OverlayRules&&(this.rules.wall||this.rules.crate||this.rules.isARock||(S=!0)),this.flat=S}readRotors(){var S=this.art.getArray("Rotors");if(S.length){let B=[];for(let N=0;N<S.length;++N){var O=this.art.getNumberArray(`Rotor${N+1}Axis`,void 0,[0,1,0]);O=new K.Vector3(-O[2],-O[0],O[1]).normalize(),B.push({name:S[N],axis:O,speed:this.art.getNumber(`Rotor${N+1}Rate`)||void 0,idleSpeed:this.art.getNumber(`Rotor${N+1}IdleRate`)||void 0})}B.length&&(this.rotors=B)}}readMuzzleFlash(){let S=0,O="MuzzleFlash"+S,B=[];for(;this.art.has(O);){var[N,j]=this.art.getNumberArray(O);B.push({x:N,y:j}),S++,O="MuzzleFlash"+S}this.muzzleFlash=B.length?B:void 0}readDockingOffsets(){if(this.type===N.ObjectType.Building){var S=this.rules.numberOfDocks;for(let N=0;N<S;N++){var[O,B,j]=this.art.getNumberArray("DockingOffset"+N,/,\s*/,[0,0,0]);this.dockingOffsets.push(new K.Vector3(O,j,B))}}}readAddRemoveOccupy(S){let O=0,B=[];for(;;){var N=this.art.getNumberArray(S+ ++O);if(!N.length)break;B.push(new z.Vector2(N[0],N[1]))}return B}get bibShape(){return this.art.getString("BibShape")}get foundation(){let S=this.art.getString("Foundation","1x1");var[O,B]=S.split("x");return{width:parseInt(O,10),height:parseInt(B,10)}}get foundationCenter(){return new z.Vector2(Math.floor(this.foundation.width/2-.5),Math.floor(this.foundation.height/2-.5))}getDrawOffset(){if(this.rules instanceof H.TerrainRules&&this.rules.spawnsTiberium)return new z.Vector2(0,0);let S=e.getDefaultDrawOffset(this.type);return this.rules instanceof _.OverlayRules&&this.rules.isARock&&(S.y+=(j.Coords.ISO_TILE_SIZE+1)/2),S}get hasShadow(){return this.art.getBool("Shadow",e.getDefaultShadow(this.type))&&!this.rules.noShadow}get turretOffset(){return this.art.getNumber("TurretOffset")}get facings(){return this.art.getNumber("Facings",8)}get walkFrames(){return this.art.getNumber("WalkFrames")}get firingFrames(){return this.art.getNumber("FiringFrames")}get standingFrames(){return this.art.getNumber("StandingFrames",1)}get startWalkFrame(){return this.art.getNumber("StartWalkFrame",0)}get startStandFrame(){return this.art.getNumber("StartStandFrame",this.walkFrames*this.facings)}get startFiringFrame(){return this.art.getNumber("StartFiringFrame",(this.walkFrames+this.standingFrames)*this.facings)}get isFlamingGuy(){return this.art.getBool("IsFlamingGuy")}get runningFrames(){return this.art.getNumber("RunningFrames")}get crawls(){return this.art.getBool("Crawls",!0)}get primaryFireFlh(){return new W.FlhCoords(this.art.getNumberArray("PrimaryFireFLH"))}get elitePrimaryFireFlh(){var S=this.art.getNumberArray("ElitePrimaryFireFLH");return S.length?new W.FlhCoords(S):this.primaryFireFlh}get primaryFirePixelOffset(){return this.art.getNumberArray("PrimaryFirePixelOffset")}get secondaryFirePixelOffset(){return this.art.getNumberArray("SecondaryFirePixelOffset")}get secondaryFireFlh(){return new W.FlhCoords(this.art.getNumberArray("SecondaryFireFLH"))}get eliteSecondaryFireFlh(){var S=this.art.getNumberArray("EliteSecondaryFireFLH");return S.length?new W.FlhCoords(S):this.secondaryFireFlh}getSpecialWeaponFlh(S){return new W.FlhCoords(this.art.getNumberArray(`Weapon${S+1}FLH`))}get fireUp(){return this.art.getNumber("FireUp")||this.art.getNumber("DelayedFireDelay")}get isAnimDelayedFire(){return this.art.getBool("IsAnimDelayedFire")}get zShapePointMove(){return this.art.getNumberArray("ZShapePointMove")}get zAdjust(){return this.art.getNumber("ZAdjust")}get trailer(){return this.art.getString("Trailer")}get spawnDelay(){return this.art.getNumber("SpawnDelay",1)}get translucent(){return this.art.getBool("Translucent")}get translucency(){var S=(S=this.art.getNumber("Translucency",0))/25*25;return S/100}}),$.DEFAULT_LINE_TRAIL_DEC=16,$.MISSING_CAMEO="xxicon"}}}),System.register("game/art/RotorData",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/art/SequenceReader",["game/art/SequenceType"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=new Map([["E",5],["S",3],["W",1],["N",7]]),S("SequenceReader",class{readIni(S){let O=new Map;for(var[j,L]of S.entries)void 0!==(j=B.SequenceType[j])&&(L=L.split(","),L={type:j,startFrame:Number(L[0]),frameCount:Number(L[1]),facingMult:Number(L[2]),onlyFacing:L[3]?N.get(L[3]):void 0},O.set(j,L));return O}})}}}),System.register("game/art/SequenceType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("SequenceType",B={}))[O.Ready=0]="Ready",O[O.Guard=1]="Guard",O[O.Prone=2]="Prone",O[O.Walk=3]="Walk",O[O.FireUp=4]="FireUp",O[O.Down=5]="Down",O[O.Crawl=6]="Crawl",O[O.Up=7]="Up",O[O.FireProne=8]="FireProne",O[O.Idle1=9]="Idle1",O[O.Idle2=10]="Idle2",O[O.Die1=11]="Die1",O[O.Die2=12]="Die2",O[O.Hover=13]="Hover",O[O.Fly=14]="Fly",O[O.FireFly=15]="FireFly",O[O.Tumble=16]="Tumble",O[O.AirDeathStart=17]="AirDeathStart",O[O.AirDeathFalling=18]="AirDeathFalling",O[O.AirDeathFinish=19]="AirDeathFinish",O[O.Tread=20]="Tread",O[O.Swim=21]="Swim",O[O.WetAttack=22]="WetAttack",O[O.WetIdle1=23]="WetIdle1",O[O.WetIdle2=24]="WetIdle2",O[O.WetDie1=25]="WetDie1",O[O.WetDie2=26]="WetDie2",O[O.Deploy=27]="Deploy",O[O.Deployed=28]="Deployed",O[O.DeployedFire=29]="DeployedFire",O[O.DeployedIdle=30]="DeployedIdle",O[O.Undeploy=31]="Undeploy",O[O.Paradrop=32]="Paradrop",O[O.Cheer=33]="Cheer",O[O.Panic=34]="Panic"}}}),System.register("game/bot/Bot",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){S("Bot",class{constructor(S,O){this.name=S,this.country=O,B.set(this,!1)}setGameApi(S){this.gameApi=S}setActionsApi(S){this.actionsApi=S}setProductionApi(S){this.productionApi=S}setLogger(S){this.logger=S,this.logger.setDebugLevel(__classPrivateFieldGet(this,B,"f"))}setDebugMode(S){return __classPrivateFieldSet(this,B,S,"f"),this.logger?.setDebugLevel(S),this}getDebugMode(){return __classPrivateFieldGet(this,B,"f")}onGameStart(S){}onGameTick(S){}onGameEvent(S,O){}}),B=new WeakMap}}}),System.register("game/bot/BotFactory",["game/gameopts/GameOpts","game/bot/DummyBot"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("BotFactory",class{constructor(S,O){this.botsLib=S,this.customBots=O||S.customBots||new Map}create(S){if(!S.isAi)throw new Error(`Player "${S.name}" is not an AI`);if(B.isCustomAiDifficulty&&B.isCustomAiDifficulty(S.aiDifficulty)){const O=this.customBots.get(S.aiDifficulty);if(O&&O.BotClass)return new O.BotClass(S.name,S.country.name);throw new Error(`Custom AI with ID "${S.aiDifficulty}" not found`)}switch(S.aiDifficulty){case B.AiDifficulty.Easy:return new N.DummyBot(S.name,S.country.name);case B.AiDifficulty.Medium:if(this.botsLib.SupalosaBot)return new this.botsLib.SupalosaBot(S.name,S.country.name);default:throw new Error(`Unsupported AI difficulty "${S.aiDifficulty}"`)}}getCustomBots(){return this.customBots}})}}}),System.register("game/bot/BotsLib",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/bot/CustomAiLoader",["engine/Engine"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("CUSTOM_AI_ID_START",100),S("CustomAiLoader",class{constructor(S){this.logger=S,this.gameApi=null,this.three=null}async loadDependencies(){this.gameApi||(this.gameApi=await SystemJS.import("@chronodivide/game-api")),this.three||(this.three=window.THREE||await SystemJS.import("three").catch(()=>({})))}async loadAll(){const S=new Map;await this.loadDependencies();try{const O=await B.Engine.getOrCreateDir(B.Engine.rfsSettings.customAiDir);if(!O)return this.logger?.info("Custom AI directory not available"),S;const N=(await O.listEntries()).filter(S=>S.toLowerCase().endsWith(".js"));this.logger?.info(`Found ${N.length} custom AI files`);let j=100;for(const B of N)try{const N=await this.loadSingleBot(O,B,j);N&&(S.set(j,N),this.logger?.info(`Loaded custom AI: ${N.name} (ID: ${j})`),j++)}catch(S){this.logger?.warn(`Failed to load custom AI "${B}": ${S.message}`),console.error(`Failed to load custom AI "${B}":`,S)}}catch(S){this.logger?.warn(`Failed to access custom AI directory: ${S.message}`),console.error("Failed to access custom AI directory:",S)}return S}async loadSingleBot(S,O,B){const N=(await S.openFile(O)).readAsString("utf-8"),j=await this.executeAmdModule(N,O);if(!j)throw new Error("Failed to parse AMD module");let L=null;const D=O.replace(/\.js$/i,"");if(j.SupalosaBot)L=j.SupalosaBot;else for(const[S,O]of Object.entries(j))if("function"==typeof O&&O.prototype&&"version"!==S&&("function"==typeof O.prototype.onGameStart||"function"==typeof O.prototype.onGameTick)){L=O;break}if(!L)throw new Error("No valid Bot class found in module");return{name:D,filename:O,BotClass:L,version:j.version||"unknown"}}async executeAmdModule(S,O){const B=this.gameApi,N=this.three;return new Promise((j,L)=>{const D=window.define;let F=null,_=null;window.define=function(S,j,L){"function"==typeof S?(L=S,j=[]):Array.isArray(S)&&(L=j,j=S);const D=(j||[]).map(S=>"@chronodivide/game-api"===S?B:"three"===S?N:(console.warn(`Unknown dependency requested: ${S}`),{}));try{F=L(...D)}catch(S){_=S,console.error(`Error executing module factory for "${O}":`,S)}},window.define.amd=!0;try{new Function(S)(),window.define=D,_?L(_):j(F)}catch(S){window.define=D,L(S)}})}})}}}),System.register("game/bot/DummyBot",["game/bot/Bot","game/order/OrderType"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){var O;(O=j=j||{})[O.Initial=0]="Initial",O[O.Deployed=1]="Deployed",O[O.Attacking=2]="Attacking",O[O.Defeated=3]="Defeated",L=class extends B.Bot{constructor(){super(...arguments),this.botState=j.Initial}onGameStart(S){var O=S.getTickRate();this.tickRatio=Math.ceil(O/5),this.enemyPlayers=S.getPlayers().filter(O=>O!==this.name&&!S.areAlliedPlayers(this.name,O))}onGameTick(S){if(S.getCurrentTick()%this.tickRatio==0)switch(this.botState){case j.Initial:{const B=S.getGeneralRules().baseUnit;if(S.getVisibleUnits(this.name,"self",S=>S.constructionYard).length){this.botState=j.Deployed;break}var O=S.getVisibleUnits(this.name,"self",S=>B.includes(S.name));O.length&&this.actionsApi.orderUnits([O[0]],N.OrderType.DeploySelected);break}case j.Deployed:break;case j.Attacking:S.getVisibleUnits(this.name,"self",S=>S.isSelectableCombatant).length||(this.botState=j.Defeated,this.actionsApi.quitGame())}}},S("DummyBot",L)}}}),System.register("game/event/AllianceChangeEvent",["game/event/EventType"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){var O;(O=N||S("AllianceEventType",N={}))[O.Requested=0]="Requested",O[O.Formed=1]="Formed",O[O.Broken=2]="Broken",S("AllianceChangeEvent",class{constructor(S,O,N){this.alliance=S,this.changeType=O,this.from=N,this.type=B.EventType.AllianceChange}})}}}),System.register("game/event/BridgeRepairEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("BridgeRepairEvent",class{constructor(S,O){this.source=S,this.tile=O,this.type=B.EventType.BridgeRepair}})}}}),System.register("game/event/BuildStatusChangeEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("BuildStatusChangeEvent",class{constructor(S,O){this.target=S,this.status=O,this.type=B.EventType.BuildStatusChange}})}}}),System.register("game/event/BuildingCaptureEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("BuildingCaptureEvent",class{constructor(S){this.target=S,this.type=B.EventType.BuildingCapture}})}}}),System.register("game/event/BuildingEvacuateEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("BuildingEvacuateEvent",class{constructor(S,O){this.target=S,this.player=O,this.type=B.EventType.BuildingEvacuate}})}}}),System.register("game/event/BuildingFailedPlaceEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("BuildingFailedPlaceEvent",class{constructor(S,O,N){this.name=S,this.player=O,this.tile=N,this.type=B.EventType.BuildingFailedPlace}})}}}),System.register("game/event/BuildingGarrisonEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("BuildingGarrisonEvent",class{constructor(S){this.target=S,this.type=B.EventType.BuildingGarrison}})}}}),System.register("game/event/BuildingInfiltrationEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("BuildingInfiltrationEvent",class{constructor(S,O){this.target=S,this.source=O,this.type=B.EventType.BuildingInfiltration}})}}}),System.register("game/event/BuildingPlaceEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("BuildingPlaceEvent",class{constructor(S){this.target=S,this.type=B.EventType.BuildingPlace}})}}}),System.register("game/event/BuildingRepairFullEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("BuildingRepairFullEvent",class{constructor(S,O){this.target=S,this.source=O,this.type=B.EventType.BuildingRepairFull}})}}}),System.register("game/event/BuildingRepairStartEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("BuildingRepairStartEvent",class{constructor(S){this.target=S,this.type=B.EventType.BuildingRepairStart}})}}}),System.register("game/event/CheerEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("CheerEvent",class{constructor(S){this.player=S,this.type=B.EventType.Cheer}})}}}),System.register("game/event/CratePickupEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("CratePickupEvent",class{constructor(S,O,N,j){this.target=S,this.player=O,this.source=N,this.tile=j,this.type=B.EventType.CratePickup}})}}}),System.register("game/event/DeployNotAllowedEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("DeployNotAllowedEvent",class{constructor(S){this.target=S,this.type=B.EventType.DeployNotAllowed}})}}}),System.register("game/event/EnterObjectEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("EnterObjectEvent",class{constructor(S,O){this.target=S,this.source=O,this.type=B.EventType.EnterObject}})}}}),System.register("game/event/EnterTileEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("EnterTileEvent",class{constructor(S,O){this.target=S,this.source=O,this.type=B.EventType.EnterTile}})}}}),System.register("game/event/EnterTransportEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("EnterTransportEvent",class{constructor(S){this.target=S,this.type=B.EventType.EnterTransport}})}}}),System.register("game/event/EventMap",["game/event/EventType"],function(S,O){"use strict";return O&&O.id,{setters:[function(S){}],execute:function(){}}}),System.register("game/event/EventType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("EventType",B={}))[O.Cheer=0]="Cheer",O[O.UnitDeployUndeploy=1]="UnitDeployUndeploy",O[O.WeaponFire=2]="WeaponFire",O[O.ObjectDestroy=3]="ObjectDestroy",O[O.ObjectSpawn=4]="ObjectSpawn",O[O.ObjectUnspawn=5]="ObjectUnspawn",O[O.ObjectMorph=6]="ObjectMorph",O[O.ObjectLiftOff=7]="ObjectLiftOff",O[O.ObjectLand=8]="ObjectLand",O[O.ObjectCrashing=9]="ObjectCrashing",O[O.ObjectDisguiseChange=10]="ObjectDisguiseChange",O[O.ObjectCloakChange=11]="ObjectCloakChange",O[O.ObjectAttacked=12]="ObjectAttacked",O[O.ShipSubmergeChange=13]="ShipSubmergeChange",O[O.BridgeRepair=14]="BridgeRepair",O[O.BuildStatusChange=15]="BuildStatusChange",O[O.BuildingPlace=16]="BuildingPlace",O[O.BuildingFailedPlace=17]="BuildingFailedPlace",O[O.ObjectSell=18]="ObjectSell",O[O.BuildingRepairFull=19]="BuildingRepairFull",O[O.BuildingCapture=20]="BuildingCapture",O[O.BuildingInfiltration=21]="BuildingInfiltration",O[O.BuildingGarrison=22]="BuildingGarrison",O[O.BuildingEvacuate=23]="BuildingEvacuate",O[O.BuildingRepairStart=24]="BuildingRepairStart",O[O.UnitRepairStart=25]="UnitRepairStart",O[O.UnitRepairFinish=26]="UnitRepairFinish",O[O.UnitRecycle=27]="UnitRecycle",O[O.InflictDamage=28]="InflictDamage",O[O.HealthChange=29]="HealthChange",O[O.WarheadDetonate=30]="WarheadDetonate",O[O.PlayerDefeated=31]="PlayerDefeated",O[O.PlayerResigned=32]="PlayerResigned",O[O.PlayerDropped=33]="PlayerDropped",O[O.DeployNotAllowed=34]="DeployNotAllowed",O[O.PowerChange=35]="PowerChange",O[O.PowerLow=36]="PowerLow",O[O.PowerRestore=37]="PowerRestore",O[O.RadarOnOff=38]="RadarOnOff",O[O.ObjectOwnerChange=39]="ObjectOwnerChange",O[O.RadarEvent=40]="RadarEvent",O[O.InsufficientFunds=41]="InsufficientFunds",O[O.RallyPointChange=42]="RallyPointChange",O[O.PrimaryFactoryChange=43]="PrimaryFactoryChange",O[O.FactoryProduceUnit=44]="FactoryProduceUnit",O[O.ObjectTeleport=45]="ObjectTeleport",O[O.AllianceChange=46]="AllianceChange",O[O.UnitPromote=47]="UnitPromote",O[O.EnterTransport=48]="EnterTransport",O[O.LeaveTransport=49]="LeaveTransport",O[O.EnterObject=50]="EnterObject",O[O.EnterTile=51]="EnterTile",O[O.SuperWeaponReady=52]="SuperWeaponReady",O[O.SuperWeaponActivate=53]="SuperWeaponActivate",O[O.LightningStormManifest=54]="LightningStormManifest",O[O.LightningStormCloud=55]="LightningStormCloud",O[O.CratePickup=56]="CratePickup",O[O.PingLocation=57]="PingLocation",O[O.StalemateDetect=58]="StalemateDetect",O[O.TriggerSoundFx=59]="TriggerSoundFx",O[O.TriggerStopSoundFx=60]="TriggerStopSoundFx",O[O.TriggerEva=61]="TriggerEva",O[O.TriggerAnim=62]="TriggerAnim",O[O.TriggerText=63]="TriggerText",O[O.TimerExpire=64]="TimerExpire"}}}),System.register("game/event/FactoryProduceUnitEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("FactoryProduceUnitEvent",class{constructor(S){this.target=S,this.type=B.EventType.FactoryProduceUnit}})}}}),System.register("game/event/GameEvent",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/event/HealthChangeEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("HealthChangeEvent",class{constructor(S,O,N){this.target=S,this.currentHealth=O,this.prevHealth=N,this.type=B.EventType.HealthChange}})}}}),System.register("game/event/InflictDamageEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("InflictDamageEvent",class{constructor(S,O,N,j,L){this.target=S,this.attacker=O,this.damageHitPoints=N,this.currentHealth=j,this.prevHealth=L,this.type=B.EventType.InflictDamage}})}}}),System.register("game/event/InsufficientFundsEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("InsufficientFundsEvent",class{constructor(S){this.target=S,this.type=B.EventType.InsufficientFunds}})}}}),System.register("game/event/LeaveTransportEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("LeaveTransportEvent",class{constructor(S){this.target=S,this.type=B.EventType.LeaveTransport}})}}}),System.register("game/event/LightningStormCloudEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("LightningStormCloudEvent",class{constructor(S){this.position=S,this.type=B.EventType.LightningStormCloud}})}}}),System.register("game/event/LightningStormManifestEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("LightningStormManifestEvent",class{constructor(S){this.target=S,this.type=B.EventType.LightningStormManifest}})}}}),System.register("game/event/ObjectAttackedEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ObjectAttackedEvent",class{constructor(S,O,N){this.target=S,this.attacker=O,this.incidental=N,this.type=B.EventType.ObjectAttacked}})}}}),System.register("game/event/ObjectCloakChangeEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ObjectCloakChangeEvent",class{constructor(S){this.target=S,this.type=B.EventType.ObjectCloakChange}})}}}),System.register("game/event/ObjectCrashingEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ObjectCrashingEvent",class{constructor(S){this.gameObject=S,this.type=B.EventType.ObjectCrashing}})}}}),System.register("game/event/ObjectDestroyEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ObjectDestroyEvent",class{constructor(S,O,N){this.target=S,this.attackerInfo=O,this.incidental=N,this.type=B.EventType.ObjectDestroy}})}}}),System.register("game/event/ObjectDisguiseChangeEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ObjectDisguiseChangeEvent",class{constructor(S){this.target=S,this.type=B.EventType.ObjectDisguiseChange}})}}}),System.register("game/event/ObjectLandEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ObjectLandEvent",class{constructor(S){this.gameObject=S,this.type=B.EventType.ObjectLand}})}}}),System.register("game/event/ObjectLiftOffEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ObjectLiftOffEvent",class{constructor(S){this.gameObject=S,this.type=B.EventType.ObjectLiftOff}})}}}),System.register("game/event/ObjectMorphEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ObjectMorphEvent",class{constructor(S,O){this.from=S,this.to=O,this.type=B.EventType.ObjectMorph}})}}}),System.register("game/event/ObjectOwnerChangeEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ObjectOwnerChangeEvent",class{constructor(S,O){this.target=S,this.prevOwner=O,this.type=B.EventType.ObjectOwnerChange}})}}}),System.register("game/event/ObjectSellEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ObjectSellEvent",class{constructor(S){this.target=S,this.type=B.EventType.ObjectSell}})}}}),System.register("game/event/ObjectSpawnEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ObjectSpawnEvent",class{constructor(S){this.gameObject=S,this.type=B.EventType.ObjectSpawn}})}}}),System.register("game/event/ObjectTeleportEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ObjectTeleportEvent",class{constructor(S,O,N){this.target=S,this.isChronoshift=O,this.prevTile=N,this.type=B.EventType.ObjectTeleport}})}}}),System.register("game/event/ObjectUnspawnEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ObjectUnspawnEvent",class{constructor(S){this.gameObject=S,this.type=B.EventType.ObjectUnspawn}})}}}),System.register("game/event/PingLocationEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("PingLocationEvent",class{constructor(S,O){this.tile=S,this.player=O,this.type=B.EventType.PingLocation}})}}}),System.register("game/event/PlayerDefeatedEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("PlayerDefeatedEvent",class{constructor(S){this.target=S,this.type=B.EventType.PlayerDefeated}})}}}),System.register("game/event/PlayerDroppedEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("PlayerDroppedEvent",class{constructor(S,O){this.target=S,this.assetsRedistributed=O,this.type=B.EventType.PlayerDropped}})}}}),System.register("game/event/PlayerResignedEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("PlayerResignedEvent",class{constructor(S,O){this.target=S,this.assetsRedistributed=O,this.type=B.EventType.PlayerResigned}})}}}),System.register("game/event/PowerChangeEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("PowerChangeEvent",class{constructor(S,O,N){this.target=S,this.power=O,this.drain=N,this.type=B.EventType.PowerChange}})}}}),System.register("game/event/PowerLowEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("PowerLowEvent",class{constructor(S){this.target=S,this.type=B.EventType.PowerLow}})}}}),System.register("game/event/PowerRestoreEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("PowerRestoreEvent",class{constructor(S){this.target=S,this.type=B.EventType.PowerRestore}})}}}),System.register("game/event/PrimaryFactoryChangeEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("PrimaryFactoryChangeEvent",class{constructor(S){this.target=S,this.type=B.EventType.PrimaryFactoryChange}})}}}),System.register("game/event/RadarEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("RadarEvent",class{constructor(S,O,N){this.target=S,this.radarEventType=O,this.tile=N,this.type=B.EventType.RadarEvent}})}}}),System.register("game/event/RadarOnOffEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("RadarOnOffEvent",class{constructor(S,O){this.target=S,this.radarEnabled=O,this.type=B.EventType.RadarOnOff}})}}}),System.register("game/event/RallyPointChangeEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("RallyPointChangeEvent",class{constructor(S){this.target=S,this.type=B.EventType.RallyPointChange}})}}}),System.register("game/event/ShipSubmergeChangeEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ShipSubmergeChangeEvent",class{constructor(S){this.target=S,this.type=B.EventType.ShipSubmergeChange}})}}}),System.register("game/event/StalemateDetectEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("StalemateDetectEvent",class{constructor(){this.type=B.EventType.StalemateDetect}})}}}),System.register("game/event/SuperWeaponActivateEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("SuperWeaponActivateEvent",class{constructor(S,O,N,j,L){this.target=S,this.owner=O,this.atTile=N,this.atTile2=j,this.noSfxWarning=L,this.type=B.EventType.SuperWeaponActivate}})}}}),System.register("game/event/SuperWeaponReadyEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("SuperWeaponReadyEvent",class{constructor(S){this.target=S,this.type=B.EventType.SuperWeaponReady}})}}}),System.register("game/event/TimerExpireEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("TimerExpireEvent",class{constructor(S){this.target=S,this.type=B.EventType.TimerExpire}})}}}),System.register("game/event/TriggerAnimEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("TriggerAnimEvent",class{constructor(S,O){this.name=S,this.tile=O,this.type=B.EventType.TriggerAnim}})}}}),System.register("game/event/TriggerEvaEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("TriggerEvaEvent",class{constructor(S){this.soundId=S,this.type=B.EventType.TriggerEva}})}}}),System.register("game/event/TriggerSoundFxEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("TriggerSoundFxEvent",class{constructor(S,O){this.soundId=S,this.tile=O,this.type=B.EventType.TriggerSoundFx}})}}}),System.register("game/event/TriggerStopSoundFxEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("TriggerStopSoundFxEvent",class{constructor(S){this.tile=S,this.type=B.EventType.TriggerStopSoundFx}})}}}),System.register("game/event/TriggerTextEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("TriggerTextEvent",class{constructor(S){this.label=S,this.type=B.EventType.TriggerText}})}}}),System.register("game/event/UnitDeployUndeployEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("UnitDeployUndeployEvent",class{constructor(S,O){this.unit=S,this.deployType=O,this.type=B.EventType.UnitDeployUndeploy}})}}}),System.register("game/event/UnitPromoteEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("UnitPromoteEvent",class{constructor(S){this.target=S,this.type=B.EventType.UnitPromote}})}}}),System.register("game/event/UnitRecycleEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("UnitRecycleEvent",class{constructor(S){this.target=S,this.type=B.EventType.UnitRecycle}})}}}),System.register("game/event/UnitRepairFinishEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("UnitRepairFinishEvent",class{constructor(S,O){this.target=S,this.from=O,this.type=B.EventType.UnitRepairFinish}})}}}),System.register("game/event/UnitRepairStartEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("UnitRepairStartEvent",class{constructor(S){this.target=S,this.type=B.EventType.UnitRepairStart}})}}}),System.register("game/event/WarheadDetonateEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("WarheadDetonateEvent",class{constructor(S,O,N,j){this.target=S,this.position=O,this.explodeAnim=N,this.isLightningStrike=j,this.type=B.EventType.WarheadDetonate}})}}}),System.register("game/event/WeaponFireEvent",["game/event/EventType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("WeaponFireEvent",class{constructor(S,O){this.weapon=S,this.gameObject=O,this.type=B.EventType.WeaponFire}})}}}),System.register("game/gameobject/Aircraft",["engine/type/ObjectType","game/gameobject/trait/MoveTrait","game/gameobject/unit/ZoneType","game/gameobject/trait/DockableTrait","game/gameobject/Techno","game/gameobject/trait/ParasiteableTrait","game/gameobject/trait/CrashableTrait","game/gameobject/trait/AirportBoundTrait","game/gameobject/trait/SpawnLinkTrait","game/gameobject/trait/MissileSpawnTrait","game/gameobject/unit/CrateBonuses","game/gameobject/trait/UnlandableTrait"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S}],execute:function(){K=class extends D.Techno{get direction(){return this.yaw}set direction(S){this.yaw=S}get isMoving(){return this.moveTrait.isMoving()}static factory(S,O,B,j,D){let W=new this(S,O,B);return W.rules.airportBound&&W.rules.dock.length&&(W.airportBoundTrait=new U.AirportBoundTrait(W.rules.dock),W.traits.add(W.airportBoundTrait)),W.rules.missileSpawn||(W.crashableTrait=new _.CrashableTrait(W),W.traits.add(W.crashableTrait)),W.rules.spawned&&(W.rules.missileSpawn?(W.missileSpawnTrait=new V.MissileSpawnTrait,W.traits.add(W.missileSpawnTrait)):(W.spawnLinkTrait=new H.SpawnLinkTrait,W.traits.add(W.spawnLinkTrait))),W.moveTrait=new N.MoveTrait(W,D),W.traits.add(W.moveTrait),O.dock.length&&W.traits.add(new L.DockableTrait),O.landable&&S!==j.general.paradrop.paradropPlane||W.traits.add(new z.UnlandableTrait),O.parasiteable&&(W.parasiteableTrait=new F.ParasiteableTrait(W),W.traits.add(W.parasiteableTrait)),W}constructor(S,O,N){super(B.ObjectType.Aircraft,S,O,N),this.pitch=0,this.yaw=0,this.roll=0,this.onBridge=!1,this.zone=j.ZoneType.Ground,this.crateBonuses=new W.CrateBonuses}isUnit(){return!0}isAircraft(){return!0}},S("Aircraft",K)}}}),System.register("game/gameobject/Building",["engine/type/ObjectType","game/gameobject/trait/GarrisonTrait","game/gameobject/trait/TurretTrait","game/rules/TechnoRules","game/event/BuildStatusChangeEvent","game/gameobject/trait/PoweredTrait","game/gameobject/trait/FactoryTrait","game/gameobject/trait/DockTrait","game/gameobject/trait/FreeUnitTrait","game/gameobject/Techno","game/gameobject/trait/CrewedTrait","game/gameobject/trait/CabHutTrait","game/gameobject/trait/OilDerrickTrait","game/gameobject/trait/WallTrait","game/Coords","game/gameobject/trait/OverpoweredTrait","game/gameobject/trait/UnitRepairTrait","game/gameobject/trait/RallyTrait","game/gameobject/trait/C4ChargeTrait","game/gameobject/trait/HelipadTrait","game/gameobject/trait/UnitReloadTrait","game/gameobject/task/WaitForBuildUpTask","game/gameobject/trait/SuperWeaponTrait","game/gameobject/trait/GapGeneratorTrait","game/gameobject/trait/PsychicDetectorTrait","game/gameobject/trait/HospitalTrait","game/math/Vector2","game/gameobject/trait/DelayedKillTrait","game/gameobject/trait/interface/NotifyBuildStatus"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S}],execute:function(){var O;(O=ce||S("BuildStatus",ce={}))[O.BuildUp=0]="BuildUp",O[O.Ready=1]="Ready",O[O.BuildDown=2]="BuildDown",he=class extends V.Techno{get buildStatus(){return this._buildStatus}static factory(S,O,B,D,V,q){let te=new this(S,O,D);return O.canBeOccupied&&(te.garrisonTrait=new N.GarrisonTrait(te,B.audioVisual.conditionRed,O.maxNumberOccupants),te.traits.add(te.garrisonTrait)),O.canC4&&!O.wall&&(te.c4ChargeTrait=new X.C4ChargeTrait,te.traits.add(te.c4ChargeTrait)),O.eligibleForDelayKill&&(te.delayedKillTrait=new oe.DelayedKillTrait,te.traits.add(te.delayedKillTrait)),O.bridgeRepairHut&&(te.cabHutTrait=new z.CabHutTrait(te,q),te.traits.add(te.cabHutTrait)),O.crewed&&(te.crewedTrait=new W.CrewedTrait,te.traits.add(te.crewedTrait)),O.turret&&(te.turretTrait=new j.TurretTrait,te.traits.add(te.turretTrait)),O.overpowerable&&(te.overpoweredTrait=new Q.OverpoweredTrait(te),te.traits.add(te.overpoweredTrait)),(O.powered&&0!==O.power||O.needsEngineer)&&(te.poweredTrait=new F.PoweredTrait(te),te.traits.add(te.poweredTrait)),(O.factory||O.cloning)&&(te.factoryTrait=new _.FactoryTrait(O.cloning?L.FactoryType.InfantryType:O.factory,O.cloning),te.traits.add(te.factoryTrait)),O.superWeapon&&(te.superWeaponTrait=new ie.SuperWeaponTrait(O.superWeapon),te.traits.add(te.superWeaponTrait)),O.numberOfDocks&&(te.dockTrait=new U.DockTrait(te,V,O.numberOfDocks,D.dockingOffsets),te.traits.add(te.dockTrait),O.helipad&&(te.helipadTrait=new J.HelipadTrait,te.traits.add(te.helipadTrait)),(O.unitRepair||O.unitReload)&&(te.unitRepairTrait=new Z.UnitRepairTrait,te.traits.add(te.unitRepairTrait)),O.unitReload&&(te.unitReloadTrait=new ee.UnitReloadTrait,te.traits.add(te.unitReloadTrait))),O.hospital&&(te.hospitalTrait=new ne.HospitalTrait,te.traits.add(te.hospitalTrait)),(O.factory||O.cloning||O.numberOfDocks)&&(te.rallyTrait=new Y.RallyTrait,te.traits.add(te.rallyTrait)),O.freeUnit&&te.traits.add(new H.FreeUnitTrait),O.produceCashStartup&&te.traits.add(new K.OilDerrickTrait),O.wall&&(te.wallTrait=new $.WallTrait,te.traits.add(te.wallTrait)),O.gapGenerator&&(te.gapGeneratorTrait=new re.GapGeneratorTrait(O.gapRadiusInCells),te.traits.add(te.gapGeneratorTrait)),O.psychicDetectionRadius&&(te.psychicDetectorTrait=new se.PsychicDetectorTrait(O.psychicDetectionRadius),te.traits.add(te.psychicDetectorTrait)),te}constructor(S,O,N){super(B.ObjectType.Building,S,O,N),this.showWeaponRange=!1,this.direction=0,this._buildStatus=ce.BuildUp,this.lastBuildStatus=this.buildStatus}isBuilding(){return!0}getFoundation(){return this.art.foundation}getFoundationCenterOffset(){var S=this.getFoundation();return new ae.Vector2(S.width/2*q.Coords.LEPTONS_PER_TILE,S.height/2*q.Coords.LEPTONS_PER_TILE)}update(S){this.buildStatus!==ce.BuildUp||this.unitOrderTrait.hasTasks()||this.unitOrderTrait.addTask(new te.WaitForBuildUpTask(S.rules.general.buildupTime,S)),this.attackTrait?.setDisabled(this.buildStatus!==ce.Ready||!!this.poweredTrait&&!this.poweredTrait.isPoweredOn()),super.update(S)}setBuildStatus(S,O){this._buildStatus=S;let B=this.lastBuildStatus;this.buildStatus!==B&&(this.lastBuildStatus=this.buildStatus,this.traits.filter(le.NotifyBuildStatus).forEach(S=>{S[le.NotifyBuildStatus.onStatusChange](B,this,O)}),O.events.dispatch(new D.BuildStatusChangeEvent(this,this.buildStatus)))}},S("Building",he)}}}),System.register("game/gameobject/Debris",["game/gameobject/GameObject","engine/type/ObjectType","game/gameobject/unit/ZoneType","game/Warhead","game/gameobject/unit/FacingUtil","game/gameobject/common/AnimTerrainEffect","game/gameobject/unit/CollisionHelper","game/gameobject/unit/CollisionType","game/math/Vector3","util/math","game/SpecialWarheadType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S}],execute:function(){z=class extends B.GameObject{static factory(S,O,B,N){return new this(S,O,B,N)}constructor(S,O,B,L){super(N.ObjectType.Debris,S,O,B),this.age=0,this.direction=0,this.rotationAxis=new H.Vector3,this.angularVelocity=0,this.zone=j.ZoneType.Air,this.velocity=new H.Vector3,this.collisionHelper=new _.CollisionHelper(L)}onSpawn(S){super.onSpawn(S),this.direction=S.generateRandomInt(0,359),this.xySpeed=V.lerp(0,this.rules.maxXYVel,S.generateRandom()),this.zSpeed=V.lerp(this.rules.minZVel,this.rules.maxZVel||1.5*this.rules.minZVel,S.generateRandom()),this.rotationAxis.set(S.generateRandom(),S.generateRandom(),S.generateRandom()).normalize(),this.angularVelocity=V.lerp(this.rules.minAngularVelocity,this.rules.maxAngularVelocity,S.generateRandom())}update(S){if(super.update(S),this.age++,this.rules.duration&&this.age>this.rules.duration)return this.velocity.set(0,0,0),void this.detonate(S);--this.zSpeed;var O=D.FacingUtil.toMapCoords(this.direction).setLength(this.xySpeed);let B=new H.Vector3(O.x,this.zSpeed,O.y);var N=this.position.clone();if(O=B.clone().add(this.position.worldPosition),S.map.isWithinHardBounds(O)){this.position.moveByLeptons3(B);let L=!1;var{type:O,target:N}=this.collisionHelper.checkCollisions(this.position,N,{cliffs:!0,ground:!0,shore:!1,walls:!0,units:!1});if(O&&(!([U.CollisionType.Ground,U.CollisionType.OnBridge].includes(O)&&0<this.rules.elasticity&&S.map.getTileZone(this.tile)!==j.ZoneType.Water)||Math.abs(this.zSpeed)<1?L=!0:(this.zSpeed=-this.zSpeed*this.rules.elasticity,this.velocity.y=-this.velocity.y*this.rules.elasticity,this.rotationAxis.negate())),L){if(this.velocity.set(0,0,0),N&&O===U.CollisionType.Wall){let S=N.position.worldPosition;this.position.moveByLeptons3(S.clone().sub(this.position.worldPosition))}this.detonate(S,O)}else this.velocity.copy(B)}else S.unspawnObject(this)}detonate(S,O=U.CollisionType.None){var B,N=this.rules.warhead?S.rules.getWarhead(this.rules.warhead):void 0,D=this.zone=this.collisionHelper.computeDetonationZone(this.tile,this.tileElevation,O);let _;D===j.ZoneType.Water?_=(B=S.rules.combatDamage.splashList)[0]:(B=this.rules.expireAnim)&&S.rules.animationNames.has(B)&&(_=B),this.explodeAnim=_;let H=new F.AnimTerrainEffect;_&&H.spawnSmudges(_,this.tile,S),S.destroyObject(this),N&&new L.Warhead(N).detonate(S,this.rules.damage,this.tile,this.tileElevation,this.position.worldPosition,D,O,S.createTarget(void 0,this.tile),void 0,W.SpecialWarheadType.None,void 0,this.rules.damageRadius||void 0,!0)}},S("Debris",z)}}}),System.register("game/gameobject/GameObject",["engine/type/ObjectType","game/Traits","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","util/math","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyAttack","game/gameobject/common/DeathType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){S("GameObject",class{get tile(){return this.position.tile}get tileElevation(){return this.position.tileElevation}constructor(S,O,B,j){this.traits=new N.Traits,this.cachedTraits={tick:[]},this.isCrashing=!1,this.isDestroyed=!1,this.deathType=V.DeathType.Normal,this.isDisposed=!1,this.isSpawned=!1,this.type=S,this.name=O,this.rules=B,this.art=j}getFoundation(){return{width:1,height:1}}isSmudge(){return this.type===B.ObjectType.Smudge}isOverlay(){return this.type===B.ObjectType.Overlay}isTerrain(){return this.type===B.ObjectType.Terrain}isProjectile(){return this.type===B.ObjectType.Projectile}isDebris(){return this.type===B.ObjectType.Debris}isBuilding(){return!1}isInfantry(){return!1}isVehicle(){return!1}isAircraft(){return!1}isUnit(){return!1}isTechno(){return!1}update(S){for(var O of this.cachedTraits.tick)O[j.NotifyTick.onTick](this,S)}onSpawn(S){this.isSpawned=!0,this.traits.filter(_.NotifySpawn).forEach(O=>{O[_.NotifySpawn.onSpawn](this,S)})}onUnspawn(S){this.isSpawned=!1,this.traits.filter(U.NotifyUnspawn).forEach(O=>{O[U.NotifyUnspawn.onUnspawn](this,S)})}onDestroy(S,O,B){this.traits.filter(L.NotifyDestroy).forEach(N=>{N[L.NotifyDestroy.onDestroy](this,S,O,B)})}onOwnerChange(S,O){this.traits.filter(F.NotifyOwnerChange).forEach(B=>{B[F.NotifyOwnerChange.onChange](this,S,O)})}onAttack(S,O){this.traits.filter(H.NotifyAttack).forEach(B=>{B[H.NotifyAttack.onAttack](this,O,S)})}addTrait(S){this.traits.add(S),S[j.NotifyTick.onTick]&&this.cachedTraits.tick.push(S)}getUiName(){return this.rules.uiName}getHash(){var S=this.position.worldPosition;return D.fnv32a([this.id,...new Uint8Array(new Float64Array([S.x,S.y,S.z]).buffer),...this.traits.getAll().map(S=>S.getHash?.()??0)])}debugGetState(){return{id:this.id,position:this.position.worldPosition.toArray(),traits:this.traits.getAll().reduce((S,O)=>{var B=O.debugGetState?.();return void 0!==B&&(S[O.constructor.name]=B),S},{})}}dispose(){this.isDisposed=!0,this.traits.dispose(),this.cachedTraits.tick.length=0}})}}}),System.register("game/gameobject/Infantry",["engine/type/ObjectType","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType","game/gameobject/infantry/InfDeathType","game/gameobject/trait/MoveTrait","game/gameobject/trait/SuppressionTrait","game/gameobject/Techno","game/gameobject/trait/IdleActionTrait","game/gameobject/trait/CrashableTrait","game/gameobject/trait/AgentTrait","game/gameobject/unit/CrateBonuses"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S}],execute:function(){z=class extends _.Techno{get isMoving(){return this.moveTrait.isMoving()}static factory(S,O,B,N){let j=new this(S,O,B);return j.moveTrait=new D.MoveTrait(j,N),j.traits.add(j.moveTrait),j.rules.crashable&&(j.crashableTrait=new H.CrashableTrait(j),j.traits.add(j.crashableTrait)),j.rules.fearless||(j.suppressionTrait=new F.SuppressionTrait,j.traits.add(j.suppressionTrait)),j.rules.agent&&(j.agentTrait=new V.AgentTrait,j.traits.add(j.agentTrait)),j.idleActionTrait=new U.IdleActionTrait,j.traits.add(j.idleActionTrait),j}constructor(S,O,D){super(B.ObjectType.Infantry,S,O,D),this.direction=0,this.onBridge=!1,this.zone=N.ZoneType.Ground,this._stance=j.StanceType.None,this.isFiring=!1,this.isPanicked=!1,this.infDeathType=L.InfDeathType.Gunfire,this.crateBonuses=new W.CrateBonuses}get stance(){return this._stance===j.StanceType.None&&this.suppressionTrait?.isSuppressed()?j.StanceType.Prone:this._stance}set stance(S){this._stance=S,this.moveTrait.setDisabled([j.StanceType.Deployed,j.StanceType.Cheer].includes(S)),this.attackTrait?.setDisabled([j.StanceType.Paradrop,j.StanceType.Cheer].includes(S))}isUnit(){return!0}isInfantry(){return!0}},S("Infantry",z),z.SUB_CELLS=[2,4,3]}}}),System.register("game/gameobject/ObjectFactory",["engine/type/ObjectType","game/gameobject/Building","game/gameobject/Terrain","game/gameobject/Overlay","game/gameobject/Smudge","game/gameobject/Infantry","game/gameobject/Vehicle","game/gameobject/Aircraft","game/art/ObjectArt","data/IniSection","game/gameobject/trait/UnitOrderTrait","game/gameobject/ObjectPosition","game/gameobject/trait/AttackTrait","game/gameobject/Projectile","game/gameobject/trait/DeployerTrait","game/gameobject/trait/HealthTrait","game/gameobject/trait/BridgeTrait","game/map/BridgeOverlayTypes","game/map/OreOverlayTypes","engine/type/OverlayTibType","game/gameobject/trait/TiberiumTrait","game/gameobject/trait/TiberiumTreeTrait","game/gameobject/trait/AutoRepairTrait","game/gameobject/trait/VeteranTrait","game/gameobject/trait/ArmedTrait","game/gameobject/trait/SelfHealingTrait","game/gameobject/trait/AmmoTrait","game/gameobject/trait/DisguiseTrait","game/gameobject/trait/InvulnerableTrait","game/gameobject/trait/WarpedOutTrait","game/gameobject/trait/TntChargeTrait","game/gameobject/trait/MindControllableTrait","game/gameobject/trait/MindControllerTrait","game/gameobject/trait/TemporalTrait","game/gameobject/trait/CloakableTrait","game/gameobject/trait/AirSpawnTrait","game/gameobject/trait/SpawnDebrisTrait","game/gameobject/Debris","game/rules/DebrisRules","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/SensorsTrait"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S},function(S){ge=S},function(S){pe=S},function(S){me=S},function(S){fe=S},function(S){ye=S},function(S){Te=S},function(S){ve=S},function(S){be=S}],execute:function(){S("ObjectFactory",class{constructor(S,O,B,N){this.tiles=S,this.tileOccupation=O,this.bridges=B,this.nextObjectId=N}create(S,O,Se,we){let Ee,xe,Oe;switch(S===B.ObjectType.Debris?Ee=Se.hasObject(O,B.ObjectType.VoxelAnim)?(xe=we.getObject(O,B.ObjectType.VoxelAnim),Se.getObject(O,B.ObjectType.VoxelAnim)):(xe=we.getAnimation(O),new Te.DebrisRules(B.ObjectType.Debris,we.getIni().getOrCreateSection(O))):xe=S===B.ObjectType.Projectile?(Ee=Se.getProjectile(O),Ee.inviso?new H.ObjectArt(B.ObjectType.Projectile,Ee,new V.IniSection(O)):we.getProjectile(O)):(Ee=Se.getObject(O,S),we.getObject(O,S)),S){case B.ObjectType.Building:Oe=N.Building.factory(O,Ee,Se,xe,this.tiles,this.bridges);break;case B.ObjectType.Infantry:Oe=F.Infantry.factory(O,Ee,xe,this.tileOccupation);break;case B.ObjectType.Vehicle:Oe=_.Vehicle.factory(O,Ee,xe,Se,this.tileOccupation);break;case B.ObjectType.Aircraft:Oe=U.Aircraft.factory(O,Ee,xe,Se,this.tileOccupation);break;case B.ObjectType.Terrain:Oe=j.Terrain.factory(O,Ee,xe);break;case B.ObjectType.Overlay:Oe=L.Overlay.factory(O,Ee,xe);break;case B.ObjectType.Smudge:Oe=D.Smudge.factory(O,Ee,xe);break;case B.ObjectType.Projectile:Oe=$.Projectile.factory(O,Ee,xe,this.tileOccupation);break;case B.ObjectType.Debris:Oe=ye.Debris.factory(O,Ee,xe,this.tileOccupation);break;default:throw new Error("Not implemented")}if(Oe.id=this.nextObjectId.value++,Oe.position=new z.ObjectPosition(this.tiles,this.tileOccupation),Oe.isUnit()?Oe.position.subCell=0:Oe.isBuilding()&&Oe.position.setCenterOffset(Oe.getFoundationCenterOffset()),Oe.isTechno()&&((Oe.rules.primary||Oe.rules.secondary||Oe.rules.weaponCount||Oe.rules.explodes)&&(Oe.armedTrait=new se.ArmedTrait(Oe,Se),Oe.traits.add(Oe.armedTrait)),-1!==Oe.rules.ammo&&(Ae=Oe.rules.initialAmmo,Oe.ammoTrait=new ae.AmmoTrait(Oe.rules.ammo,-1!==Ae?Ae:void 0),Oe.traits.add(Oe.ammoTrait)),Oe.unitOrderTrait=new W.UnitOrderTrait(Oe),Oe.traits.addToFront(Oe.unitOrderTrait),(Oe.primaryWeapon||Oe.secondaryWeapon)&&(Oe.attackTrait=new K.AttackTrait(this.tiles,this.tileOccupation),Oe.traits.add(Oe.attackTrait)),(Oe.isInfantry()||Oe.isVehicle())&&Oe.rules.deployer&&(Oe.deployerTrait=new q.DeployerTrait(Oe),Oe.traits.add(Oe.deployerTrait)),(Oe.isInfantry()||Oe.isVehicle())&&Oe.rules.canDisguise&&(Oe.disguiseTrait=new oe.DisguiseTrait,Oe.traits.add(Oe.disguiseTrait)),Oe.rules.cloakable&&(Oe.cloakableTrait=new pe.CloakableTrait(Oe,Se.general.cloakDelay),Oe.traits.add(Oe.cloakableTrait)),Oe.rules.sensors&&(Oe.sensorsTrait=new be.SensorsTrait,Oe.traits.add(Oe.sensorsTrait)),Oe.autoRepairTrait=new ie.AutoRepairTrait(!Oe.isBuilding()),Oe.traits.add(Oe.autoRepairTrait),Oe.rules.trainable&&(Oe.veteranTrait=new re.VeteranTrait(Oe,Se.general.veteran),Oe.traits.add(Oe.veteranTrait)),Oe.rules.selfHealing&&Oe.traits.add(new ne.SelfHealingTrait),Oe.invulnerableTrait=new le.InvulnerableTrait,Oe.traits.add(Oe.invulnerableTrait),Oe.warpedOutTrait=new ce.WarpedOutTrait(Oe),Oe.traits.add(Oe.warpedOutTrait),Oe.temporalTrait=new ge.TemporalTrait(Oe),Oe.traits.add(Oe.temporalTrait),Oe.rules.bombable&&(Oe.tntChargeTrait=new he.TntChargeTrait,Oe.traits.add(Oe.tntChargeTrait)),Oe.rules.immuneToPsionics||Oe.isBuilding()||(Oe.mindControllableTrait=new ue.MindControllableTrait(Oe),Oe.traits.add(Oe.mindControllableTrait)),[Oe.primaryWeapon,Oe.secondaryWeapon].some(S=>S?.warhead.rules.mindControl)&&(Oe.mindControllerTrait=new de.MindControllerTrait(Oe),Oe.traits.add(Oe.mindControllerTrait)),Oe.rules.spawns&&(Oe.airSpawnTrait=new me.AirSpawnTrait,Oe.traits.add(Oe.airSpawnTrait)),Oe.rules.maxDebris&&Oe.traits.add(new fe.SpawnDebrisTrait)),Oe.isTechno()||Oe.isOverlay()||Oe.isTerrain()){var Ae=Oe.isOverlay()&&Y.BridgeOverlayTypes.isBridge(Se.getOverlayId(Oe.name));let S=Oe.rules.strength;!S&&Oe.isTerrain()&&(S=Se.general.treeStrength),Ae&&(S=Se.combatDamage.bridgeStrength),(S||Oe.isTechno())&&(Oe.healthTrait=new Q.HealthTrait(S,Oe,Se.audioVisual.conditionYellow,Se.audioVisual.conditionRed),Oe.traits.add(Oe.healthTrait)),Oe.isOverlay()&&Ae&&(Oe.bridgeTrait=new Z.BridgeTrait(this.bridges),Oe.traits.add(Oe.bridgeTrait),Y.BridgeOverlayTypes.getOverlayBridgeType(Se.getOverlayId(Oe.name))===Y.OverlayBridgeType.Concrete&&Oe.traits.add(new fe.SpawnDebrisTrait))}return Oe.isOverlay()&&Oe.isOverlay()&&X.OreOverlayTypes.getOverlayTibType(Se.getOverlayId(Oe.name))!==J.OverlayTibType.NotSpecial&&Oe.traits.add(new ee.TiberiumTrait(Oe)),Oe.isTerrain()&&Oe.rules.spawnsTiberium&&Oe.traits.add(new te.TiberiumTreeTrait(Oe.rules)),Oe.cachedTraits.tick.push(...Oe.traits.filter(ve.NotifyTick)),Oe}})}}}),System.register("game/gameobject/ObjectPosition",["game/Coords","util/event","game/theater/rampHeights","game/math/Vector3","game/math/Vector2","util/math"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){S("ObjectPosition",class e{get onPositionChange(){return this._onPositionChange.asEvent()}get worldPosition(){return this._worldPosition}get tile(){return this._tile}set tile(S){var O=!!this._tile&&S!==this._tile;(this._tile=S)&&(this.updateWorldPosition(S,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:O}))}get tileElevation(){return void 0===this._tileElevation?(void 0===this._computedTileElevation&&(this._computedTileElevation=this.computeTileElevationFromWorldPos()),this._computedTileElevation):this._tileElevation}set tileElevation(S){this._absoluteElevation=void 0,this._tileElevation=S,this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}get subCell(){if(!this._tileOffset.x&&!this._tileOffset.y)return 0;var S=Math.sign(this._tileOffset.x/B.Coords.LEPTONS_PER_TILE-.5),O=Math.sign(this._tileOffset.y/B.Coords.LEPTONS_PER_TILE-.5);return S&&O?O+1+(S+1)/2+1:0}set subCell(S){this._tileOffset=this.computeSubCellOffset(S),this.desiredSubCell=S,this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}constructor(S,O){this.tiles=S,this.tileOccupation=O,this._worldPosition=new L.Vector3,this._tileOffset=new D.Vector2,this._centerOffset=new D.Vector2,this.desiredSubCell=0,this._tileElevation=0,this._onPositionChange=new N.EventDispatcher}getTileOffset(){return this._tileOffset.clone()}setTileOffset(S){this._tileOffset.copy(S),this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}setCenterOffset(S){this._centerOffset.copy(S),this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}getMapPosition(){if(this._tile)return new D.Vector2(this._tile.rx*B.Coords.LEPTONS_PER_TILE+this._tileOffset.x+this._centerOffset.x,this._tile.ry*B.Coords.LEPTONS_PER_TILE+this._tileOffset.y+this._centerOffset.y)}getBridgeBelow(){return this._tile?.onBridgeLandType?this.tileOccupation.getBridgeOnTile(this._tile):void 0}moveToTileCell(S,O=0){if(!this._tile)throw new Error("Tile is not set");var B=S!==this._tile;this._tile=S,this._tileOffset=this.computeSubCellOffset(O),this.desiredSubCell=O,this.updateWorldPosition(S,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:B})}moveToTileCoords(S,O,N=!1){var j=Math.floor(S),L=Math.floor(O),D=!this._tile||this._tile.rx!==j||this._tile.ry!==L;if(D){let S=this.tiles.getByMapCoords(j,L);if(!S){if(!N)throw new RangeError(`Attempted move to a non-existent tile: [${j},${L}]`);S=this.tiles.getPlaceholderTile(j,L)}this._tile=S}this._tileOffset.set((S-j)*B.Coords.LEPTONS_PER_TILE,(O-L)*B.Coords.LEPTONS_PER_TILE),this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:D})}moveToLeptons(S,O=!1){this.moveToTileCoords(S.x/B.Coords.LEPTONS_PER_TILE,S.y/B.Coords.LEPTONS_PER_TILE,O)}moveByLeptons(S,O,N=!1){if(!this._tile)throw new Error("Tile is not set");this.moveToTileCoords(this._tile.rx+(this._tileOffset.x+S)/B.Coords.LEPTONS_PER_TILE,this._tile.ry+(this._tileOffset.y+O)/B.Coords.LEPTONS_PER_TILE,N)}moveByLeptons3(S,O=!1){var B=this._worldPosition.y;this.moveByLeptons(S.x,S.z,O),this.setAbsoluteElevationWorld(B+S.y)}setAbsoluteElevationWorld(S){this._absoluteElevation=S,this._tileElevation=void 0,this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}computeSubCellOffset(S){let O={width:0,height:0};var N;S&&(N=(S-1)%2*2-1,j=2*Math.floor((S-1)/2)-1,O={width:N*B.Coords.LEPTONS_PER_TILE/4,height:j*B.Coords.LEPTONS_PER_TILE/4});var j=B.Coords.LEPTONS_PER_TILE/2;return new D.Vector2(j+O.width,j+O.height)}interpolateRampHeight(S,O,B){var N=j.rampHeights[B],L=N[1],D=N[0];return L*(1-S)*(1-O)+N[2]*S*(1-O)+D*(1-S)*O+N[3]*S*O}updateWorldPosition(S,O){var N=O.x+this._centerOffset.x,j=O.y+this._centerOffset.y,L=N/B.Coords.LEPTONS_PER_TILE,D=j/B.Coords.LEPTONS_PER_TILE;let F;if(void 0!==this._tileElevation){let O=0;0!==S.rampType&&(O=this.interpolateRampHeight(L,D,S.rampType)),F=B.Coords.tileHeightToWorld(S.z+O+this._tileElevation)}else F=this._absoluteElevation;this._worldPosition.set(S.rx*B.Coords.LEPTONS_PER_TILE+N,F,S.ry*B.Coords.LEPTONS_PER_TILE+j),void 0===this._tileElevation&&(this._computedTileElevation=this.computeTileElevationFromWorldPos())}computeTileElevationFromWorldPos(){if(!this._tile)return 0;var S=F.roundToDecimals(B.Coords.worldToTileHeight(this._worldPosition.y),14),O=(this._tileOffset.x+this._centerOffset.x)/B.Coords.LEPTONS_PER_TILE,N=(this._tileOffset.y+this._centerOffset.y)/B.Coords.LEPTONS_PER_TILE;let j=0;return 0!==this._tile.rampType&&(j=this.interpolateRampHeight(O,N,this._tile.rampType)),S-this._tile.z-j}clone(){let S=new e(this.tiles,this.tileOccupation);return S._worldPosition=this._worldPosition.clone(),S._tile=this._tile,S._tileOffset=this._tileOffset.clone(),S._centerOffset=this._centerOffset.clone(),S._tileElevation=this._tileElevation,S._absoluteElevation=this._absoluteElevation,S._computedTileElevation=this._computedTileElevation,S}})}}}),System.register("game/gameobject/Overlay",["engine/type/ObjectType","game/gameobject/GameObject","game/map/BridgeOverlayTypes","game/map/OreOverlayTypes","engine/type/OverlayTibType","game/gameobject/trait/WallTrait"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class extends N.GameObject{static factory(S,O,B){let N=new this(S,O,B);return O.wall&&(N.wallTrait=new F.WallTrait,N.traits.add(N.wallTrait)),N}constructor(S,O,N){super(B.ObjectType.Overlay,S,O,N),this.radarInvisible=this.rules.radarInvisible}isTiberium(){return L.OreOverlayTypes.getOverlayTibType(this.overlayId)!==D.OverlayTibType.NotSpecial}isBridge(){return j.BridgeOverlayTypes.isBridge(this.overlayId)}isXBridge(){return j.BridgeOverlayTypes.isXBridge(this.overlayId)}isHighBridge(){return j.BridgeOverlayTypes.isHighBridge(this.overlayId)}isLowBridge(){return j.BridgeOverlayTypes.isLowBridge(this.overlayId)}isBridgePlaceholder(){return j.BridgeOverlayTypes.isBridgePlaceholder(this.overlayId)}getFoundation(){let S={width:1,height:1};return this.isBridge()&&(this.isXBridge()?S.height+=2:S.width+=2),S}},S("Overlay",_)}}}),System.register("game/gameobject/Projectile",["game/gameobject/GameObject","engine/type/ObjectType","game/Weapon","game/WeaponType","game/gameobject/unit/FacingUtil","game/Coords","game/gameobject/unit/ZoneType","game/map/TileOccupation","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/RangeHelper","game/gameobject/unit/TargetUtil","game/math/geometry","game/map/tileFinder/RandomTileFinder","util/math","game/type/MovementZone","game/gameobject/infantry/StanceType","game/gameobject/unit/MovePositionHelper","game/GameSpeed","game/gameobject/unit/VeteranLevel","game/gameobject/task/ScatterTask","game/Warhead","game/rules/ObjectRules","game/gameobject/unit/CollisionHelper","game/gameobject/unit/CollisionType","game/math/Vector2","game/math/Vector3","game/SpecialWarheadType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S}],execute:function(){var O;(O=oe||S("ProjectileState",oe={}))[O.Travel=0]="Travel",O[O.Impact=1]="Impact",O[O.Detonation=2]="Detonation",le=class extends B.GameObject{get fromObject(){return this._fromObject}set fromObject(S){(this._fromObject=S)&&S.veteranTrait&&!S.isDestroyed&&(this.veteranDamageMult=S.veteranTrait.getVeteranDamageMultiplier())}get rot(){return this.fromWeapon.rules.isSonic?te.ObjectRules.iniRotToDegsPerTick(this.iniRot):this.rules.rot}get iniRot(){return this.fromWeapon.rules.isSonic?10:this.rules.iniRot}static factory(S,O,B,N){return new this(S,O,B,N)}constructor(S,O,B,j){super(N.ObjectType.Projectile,S,O,B),this.tileOccupation=j,this.state=oe.Travel,this.detonationTimer=0,this.collisionType=re.CollisionType.None,this.direction=0,this.zone=_.ZoneType.Air,this.isShrapnel=!1,this.isNuke=!1,this.baseDamageMultiplier=1,this.veteranDamageMult=1,this.snapToTarget=!1,this.targetLockLost=!1,this.limboTravelTicks=0,this.homingTravelDistance=0,this.homingTravelTicks=0,this.velocity=new ne.Vector3,this.sonicVisitedObjects=new Map,this.collisionHelper=new ie.CollisionHelper(j)}onSpawn(S){var O;if(super.onSpawn(S),this.initialSelfPosition=this.position.worldPosition.clone(),!this.target.obj||this.fromWeapon.type===L.WeaponType.DeathWeapon||this.fromWeapon.rules.limboLaunch||!this.isHoming()&&this.fromWeapon.speed===Number.POSITIVE_INFINITY||this.rules.inaccurate||this.rules.arcing||this.rules.flakScatter||0<(O=this.computeBaseDamage(S))&&(O=this.fromWeapon.warhead.computeDamage(O,this.target.obj,S),this.target.obj.healthTrait?.projectDamage(O)),S.afterTick(()=>{var O=new V.RangeHelper(this.tileOccupation).distance2(this.target.getWorldCoords(),this)/F.Coords.LEPTONS_PER_TILE;this.initialTileDistToTarget=O,this.maxSpeed=this.computeMaxSpeed(this.fromWeapon.speed,O,S.rules.audioVisual.gravity)}),this.isHoming()){if(1===this.iniRot&&(this.homingMoveDir=this.target.getWorldCoords().clone().sub(this.position.worldPosition)),this.fromObject?.isAircraft()&&this.rules.isAntiGround&&!this.rules.isAntiAir){let O=this.target.obj;!O?.isVehicle()||O.isDestroyed||O.veteranLevel!==X.VeteranLevel.Elite||O.unitOrderTrait.hasTasks()||O.unitOrderTrait.addTask(new J.ScatterTask(S))}}else if(this.rules.vertical){let S=this.position.clone();S.tileElevation=this.fromWeapon.warhead.rules.nukeMaker?F.Coords.worldToTileHeight(this.fromWeapon.projectileRules.detonationAltitude):0,this.aimPoint=S.worldPosition.clone()}else{let O=this.target.getWorldCoords().clone();S.afterTick(()=>{var B=this.target.getWorldCoords().clone().sub(O).length()>F.Coords.LEPTONS_PER_TILE;let N=B?O:this.target.obj?.isUnit()&&this.target.obj.moveTrait.velocity.length()&&isFinite(this.maxSpeed)?this.computeAimPointVersusMovingTarget(this.target.obj,this.maxSpeed,this.position.worldPosition,S.map):this.target.getWorldCoords().clone();this.aimPoint=N,this.snapToTarget=!B&&isFinite(this.maxSpeed)&&!this.fromWeapon.warhead.rules.sonic,(this.rules.inaccurate||this.rules.flakScatter)&&(this.adjustAimForBallisticScatter(S,N),this.snapToTarget=!1),!B&&this.rules.arcing&&(this.rules.inaccurate?(this.overshootTiles=this.calculateInaccurateBallisticOvershoot(S),this.snapToTarget=!1):this.target.obj?.isVehicle()&&this.target.obj.moveTrait.isMoving()&&(this.overshootTiles=this.calculateBallisticOvershootVsMoving(S,this.target.obj),this.overshootTiles&&(this.snapToTarget=!1))),N.clone().sub(this.position.worldPosition).length()<this.fromWeapon.speed&&this.update(S)})}}adjustAimForBallisticScatter(S,O){let B,N=S.rules.combatDamage.ballisticScatter;B=this.rules.flakScatter?(this.rules.inviso&&(N*=2),S.generateRandom()*N):N/2+S.generateRandom()*(N/2);let j=B*F.Coords.LEPTONS_PER_TILE;this.rules.flakScatter&&(j*=(D=O.clone().sub(this.initialSelfPosition).length())/(this.fromWeapon.range*F.Coords.LEPTONS_PER_TILE));var L=z.rotateVec2(new se.Vector2(j,0),S.generateRandomInt(0,360)),D=F.Coords.vecWorldToGround(O).add(L).multiplyScalar(1/F.Coords.LEPTONS_PER_TILE).floor();S.map.tiles.getByMapCoords(D.x,D.y)&&O.add(new ne.Vector3(L.x,0,L.y))}calculateBallisticOvershootVsMoving(S,O){let B=this.target.getWorldCoords().clone().sub(this.initialSelfPosition);var N=F.Coords.vecWorldToGround(B),j=F.Coords.vecWorldToGround(O.moveTrait.velocity);return j=(j=(90<(N=z.angleDegBetweenVec2(N,j))?180-N:N)/90)*(N=B.length()/F.Coords.LEPTONS_PER_TILE)/5,S.generateRandom()<=j?2*Math.min(1,N/5):0}calculateInaccurateBallisticOvershoot(S){return S.generateRandom()<=.5?2:0}update(S){if(void 0!==this.maxSpeed)if(super.update(S),this.state!==oe.Impact){var O=this.velocity.clone(),B=this.position.clone();if(this.velocity.set(0,0,0),this.fromWeapon.rules.limboLaunch){if(!this.fromObject)throw new Error("Limbo launch projectile must be fired from a unit");if(this.fromObject.isDestroyed)return void S.destroyObject(this)}var N=this.updateSpeed(this.maxSpeed);this.speed=N;let ie=this.target.getWorldCoords();if(this.lastTargetLockPosition&&(this.targetLockLost||ie.clone().sub(this.lastTargetLockPosition).length()>=F.Coords.LEPTONS_PER_TILE)?(ie=this.lastTargetLockPosition,this.targetLockLost=!0):this.lastTargetLockPosition=ie.clone(),this.isHoming()){if(this.target.obj?.isUnit()&&(this.target.obj.isDestroyed||this.target.obj.isCrashing||!this.target.obj.isSpawned)&&(this.fromWeapon.rules.limboLaunch||this.homingTravelDistance>=2*F.Coords.LEPTONS_PER_TILE))return void this.detonate(S);if(this.homingMoveDir||(L=D.FacingUtil.toMapCoords(this.direction),this.homingMoveDir=new ne.Vector3(L.x,0,L.y),this.fromObject?.isAircraft()&&(this.homingMoveDir.y=-9999999,this.homingMoveDir.normalize())),this.fromWeapon.rules.limboLaunch){if(!this.targetLockLost){if(10<this.limboTravelTicks)return this.position.moveToLeptons(this.target.obj.position.getMapPosition()),this.position.tileElevation=this.target.obj.position.tileElevation,void this.detonate(S);this.limboTravelTicks++}}else if(!this.isInHomingRange(ie,S))return void this.detonate(S);let O=new V.RangeHelper(this.tileOccupation);var j=Math.floor(O.distance2(ie,this)/F.Coords.LEPTONS_PER_TILE),L=2<j&&1<this.iniRot;let W=ie.clone().sub(this.position.worldPosition),q=0;this.homingTravelTicks<this.rules.courseLockDuration||(L?(z.rotateVec3Towards(this.homingMoveDir,new ne.Vector3(W.x,this.homingMoveDir.y,W.z),this.rot),this.rules.level||(j=$.clamp(Math.floor(this.initialTileDistToTarget)-1,0,2)+$.clamp(j-2,0,3),_=this.tileOccupation.getBridgeOnTile(this.tile)?.tileElevation??0,(_=j-(this.position.tileElevation-_))&&(U=.25+6/this.iniRot*.1,q=F.Coords.tileHeightToWorld(Math.sign(_)*Math.min(Math.abs(_),U))))):z.rotateVec3Towards(this.homingMoveDir,W,this.rot)),this.direction=D.FacingUtil.fromMapCoords(new se.Vector2(this.homingMoveDir.x,this.homingMoveDir.z));var _=W.length(),U=Math.min(_,N);this.homingTravelDistance+=U,this.homingTravelTicks++;let Q,Z=!1,Y=re.CollisionType.None;if(1<=U){let O=this.homingMoveDir.clone().setLength(U);q&&(O.y+=q),U===N&&this.velocity.copy(O);var H=O.clone().add(this.position.worldPosition);S.map.mapBounds.isWithinHardBounds(H)?this.position.moveByLeptons3(O):Z=!0,Y=(K=this.checkObstacles(B,S)).type,Q=K.target,(Y||U<N)&&(Z=!0)}else this.position.moveByLeptons3(W),Z=!0;if(Z){if(Q&&Y===re.CollisionType.Wall){let S=Q.position.worldPosition;this.position.moveByLeptons3(S.clone().sub(this.position.worldPosition))}this.collisionType=Y,this.detonate(S,Y)}}else{let j=this.aimPoint.clone().sub(this.position.worldPosition);if(this.rules.vertical||(this.direction=D.FacingUtil.fromMapCoords(new se.Vector2(j.x,j.z))),this.rules.arcing&&(j.y=0),_=Math.min(j.length(),N),j.setLength(_),this.rules.arcing){let O=F.Coords.vecWorldToGround(this.position.worldPosition.clone().sub(this.initialSelfPosition).add(j));H=this.aimPoint.clone().sub(this.initialSelfPosition);var W=O.length(),K=F.Coords.vecWorldToGround(H).length();U=H.y,H=S.rules.audioVisual.gravity,j.y=(U/K*N+H/2*K/N)*W/N-H*(W/N)*(W/N)/2+this.initialSelfPosition.y-this.position.worldPosition.y}let L=!1;W=j.clone().add(this.position.worldPosition),S.map.isWithinHardBounds(W)?this.position.moveByLeptons3(j):L=!0;let V,$=re.CollisionType.None;if(1<=_?(_!==N&&!this.overshootTiles||this.velocity.copy(j),$=(B=this.checkObstacles(B,S)).type,V=B.target,($||_<N)&&(L=!0)):L=!0,L){if($){if(V&&$===re.CollisionType.Wall){let S=V.isBuilding()?F.Coords.tile3dToWorld(V.tile.rx+.5,V.tile.ry+.5,V.tile.z):V.position.worldPosition;this.position.moveByLeptons3(S.clone().sub(this.position.worldPosition))}}else if(this.overshootTiles){var q=F.Coords.vecWorldToGround(O).setLength(this.overshootTiles*F.Coords.LEPTONS_PER_TILE);if(z.rotateVec2(q,S.generateRandomInt(-45,45)),W=F.Coords.vecGroundToWorld(q).add(this.position.worldPosition),!S.map.isWithinHardBounds(W))return void S.unspawnObject(this);this.position.moveByLeptons(q.x,q.y)}else if(this.snapToTarget&&!this.targetLockLost){if(!S.map.isWithinHardBounds(ie))return void S.unspawnObject(this);this.position.moveByLeptons3(ie.clone().sub(this.position.worldPosition))}this.collisionType=$,this.isNuke?(this.state=oe.Impact,this.detonationTimer=2.5*Y.GameSpeed.BASE_TICKS_PER_SECOND):this.detonate(S,$)}}let ae=this.fromWeapon.warhead;if(ae.rules.sonic){q=11/30*F.Coords.LEPTONS_PER_TILE,q=this.position.worldPosition.clone().add(this.velocity.clone().setLength(q)),q=F.Coords.vecWorldToGround(q).multiplyScalar(1/F.Coords.LEPTONS_PER_TILE).floor();var Q,Z,X=S.map.tiles.getByMapCoords(q.x,q.y);if(X&&X!==this.fromObject?.tile){var J,ee=S.map.getTileZone(X);for(J of S.map.getGroundObjectsOnTile(X))if((!J.isUnit()||!J.onBridge)&&(!J.isTechno()||!J.rules.typeImmune||J.owner!==this.fromPlayer||J.name!==this.fromObject?.name)&&(!J.isAircraft()||!J.rules.spawned)&&ae.canDamage(J,X,ee)){let S=this.sonicVisitedObjects.get(J)??new Set;S.add(X),this.sonicVisitedObjects.set(J,S)}}for([Q,Z]of this.sonicVisitedObjects)for(var te of Z)S.map.tileOccupation.isTileOccupiedBy(te,Q)&&Q.isSpawned&&(te=this.fromWeapon.rules.ambientDamage*this.veteranDamageMult*this.baseDamageMultiplier,te=ae.computeDamage(te,Q,S),ae.inflictDamage(te,Q,{player:this.fromPlayer,weapon:this.fromWeapon,obj:this.fromObject},S,Q!==this.target.obj))}}else 0<this.detonationTimer?this.detonationTimer--:this.detonate(S,this.collisionType)}isHoming(){return!!this.rot&&!this.rules.arcing}isInHomingRange(S,O){let B=!0,N=this.target.obj;if(N?.isUnit()&&this.fromObject){let D=new V.RangeHelper(this.tileOccupation);var j,L=D.computeWeaponRangeVsTarget(this.fromObject,N,this.fromWeapon,O.rules).range;this.fromWeapon.rules.limboLaunch?B=D.isInRange3(this.initialSelfPosition,S,0,L+.5):(j=N.moveTrait.velocity.length())&&(this.fromObject.rules.movementZone===q.MovementZone.Fly?5<this.speed/j&&(B=D.isInRange2(this.initialSelfPosition,this.position.worldPosition,0,L)):isFinite(this.fromWeapon.speed)&&3.5<this.fromWeapon.speed/N.rules.speed&&(B=D.isInRange3(this.initialSelfPosition,this.position.worldPosition,0,L)))}return B}updateSpeed(S){let O;return O=this.isHoming()||this.rules.vertical?void 0===this.speed?Math.min(S,this.rules.acceleration):Math.min(S,this.speed+this.rules.acceleration):S,O}computeMaxSpeed(S,O,B){let N=S;return this.rules.arcing&&(N*=(1+B/6)/2,N*=(O=Math.floor(O))<=8?1:1+O/8*.5),this.fromWeapon.warhead.rules.sonic&&(N=Math.ceil(O*F.Coords.LEPTONS_PER_TILE/21)),N}checkObstacles(S,O){return this.fromWeapon.rules.limboLaunch?{type:re.CollisionType.None}:this.collisionHelper.checkCollisions(this.position,S,{cliffs:this.rules.subjectToCliffs,ground:this.isHoming(),shore:this.rules.level,walls:this.rules.subjectToWalls,units:!this.rules.inaccurate&&(S=>this.fromPlayer!==S&&!O.alliances.areAllied(this.fromPlayer,S))})}computeBaseDamage(S){var O=this.fromWeapon,B=O.warhead;let N=O.rules.damage;O.type===L.WeaponType.DeathWeapon&&B.rules.ivanBomb&&(N=S.rules.combatDamage.ivanDamage);let j=N*this.baseDamageMultiplier;return O.type===L.WeaponType.DeathWeapon&&this.fromObject&&(j*=this.fromObject.rules.deathWeaponDamageModifier),j*=this.veteranDamageMult,j}detonate(S,O=re.CollisionType.None){var B=this.fromWeapon;let N=B.warhead;var D,F=this.zone=this.collisionHelper.computeDetonationZone(this.tile,this.tileElevation,O);let _=this.tile;B.type===L.WeaponType.DeathWeapon&&N.rules.ivanBomb&&(N=new ee.Warhead(S.rules.getWarhead(S.rules.combatDamage.ivanWarhead)));let W=this.computeBaseDamage(S);S.destroyObject(this),this.state=oe.Detonation;let z=this.target.obj,$=!1;if(N.rules.parasite&&z?.isUnit()&&_===z.tile&&N.canDamage(z,_,F))if(z.isInfantry())W=Number.POSITIVE_INFINITY;else if(z.parasiteableTrait&&this.fromObject?.isUnit()){if(!(this.fromWeapon instanceof j.Weapon))throw new Error("Projectile with parasite warhead must have a weapon reference");z.parasiteableTrait.infest(this.fromObject,this.fromWeapon),$=!0}let Y=!0;if($&&(Y=!1),N.rules.sonic&&(Y=!1),N.rules.ivanBomb&&(Y=!1,!z?.isTechno()||!z.tntChargeTrait||z.tntChargeTrait.hasCharge()||z.isDestroyed||z.warpedOutTrait.isInvulnerable()||(D=S.rules.combatDamage.ivanTimedDelay,z.tntChargeTrait.setCharge(D,S.currentTick,{player:this.fromPlayer,obj:this.fromObject}))),N.rules.bombDisarm&&(Y=!1,z?.isTechno()&&z.tntChargeTrait?.hasCharge()&&!z.isDestroyed&&z.tntChargeTrait.removeCharge()),N.rules.mindControl&&(Y=!1,this.fromObject&&!this.fromObject.isDestroyed&&z?.isTechno()&&z.mindControllableTrait&&!z.mindControllableTrait?.isActive()&&!S.areFriendly(z,this.fromObject)&&N.canDamage(z,_,F)&&!z.invulnerableTrait.isActive()&&this.fromObject.mindControllerTrait.control(z,S)),N.rules.temporal&&(Y=!1,this.fromObject&&!this.fromObject.isDestroyed&&z?.isTechno()&&N.canDamage(z,_,F)&&!z.invulnerableTrait.isActive()&&(N.inflictDamage(0,z,{player:this.fromPlayer,weapon:B,obj:this.fromObject},S),this.fromObject.temporalTrait.updateTarget(z,B,S))),N.rules.makesDisguise&&(Y=!1,this.fromObject&&!this.fromObject.isDestroyed&&(this.fromObject.isInfantry()||this.fromObject.isVehicle())&&z?.isUnit()&&z.type===this.fromObject.type&&this.fromObject.disguiseTrait?.disguiseAs(z,this.fromObject,S)),N.rules.electricAssault&&(this.fromObject?.isUnit()&&!this.fromObject.isDestroyed&&z?.isBuilding()&&!z.isDestroyed&&z.overpoweredTrait&&z.owner===this.fromPlayer&&z.overpoweredTrait.chargeFrom(this.fromObject),Y=!1),Y&&N.detonate(S,W,_,this.tileElevation,this.position.worldPosition,F,O,this.target,{player:this.fromPlayer,weapon:B,obj:this.fromObject},this.isShrapnel?ae.SpecialWarheadType.Shrapnel:ae.SpecialWarheadType.None,this.impactAnim),N.rules.nukeMaker){let O;O=this.fromObject?(X=j.Weapon.factory(j.Weapon.NUKE_PAYLOAD_NAME,L.WeaponType.Primary,this.fromObject,S.rules),S.createProjectile(X.projectileRules.name,this.fromObject,X,this.target,!1)):S.createLooseProjectile(j.Weapon.NUKE_PAYLOAD_NAME,this.fromPlayer,this.target),O.isNuke=!0,O.impactAnim="NUKEBALL";var X=this.target.tile;O.position.moveToTileCoords(X.rx+.5,X.ry+.5),O.position.tileElevation=this.position.tileElevation,S.spawnObject(O,X)}if(this.rules.shrapnelCount&&this.rules.shrapnelWeapon&&((this.target.obj?!this.target.obj.isBuilding():S.map.getGroundObjectsOnTile(this.target.tile).some(S=>S.isTerrain())&&!B.projectileRules.isAntiAir)||this.isShrapnel)){let O=S.rules.getWeapon(this.rules.shrapnelWeapon);var J,te=S.rules.getProjectile(O.projectile);let B=this.rules.shrapnelCount,N=new V.RangeHelper(S.map.tileOccupation),j=new H.RadialTileFinder(S.map.tiles,S.map.mapBounds,_,{width:1,height:1},1,O.range,S=>N.isInTileRange(_,S,O.minimumRange,O.range)),L=new Set;for(;0<Math.floor(B);){var ie,se=j.getNextTile();if(!se)break;for(ie of S.map.tileOccupation.getObjectsOnTileByLayer(se,te.isAntiAir?U.LayerType.Air:U.LayerType.Ground).filter(O=>S.isValidTarget(O)&&(O.isTerrain()||O.isTechno()&&O.owner!==this.fromPlayer&&!S.alliances.areAllied(O.owner,this.fromPlayer)&&!(O.isInfantry()&&O.stance===Q.StanceType.Paradrop))))if(!L.has(ie)&&(L.add(ie),B=Math.max(0,B-1-(ie.isTechno()?.5:0)),Math.floor(B)<=0))break}for(J of L){var ne=S.createTarget(J.isTerrain()?void 0:J,J.tile);this.createShrapnel(S,ne,O.name)}B=Math.floor(B);let D=new K.RandomTileFinder(S.map.tiles,S.map.mapBounds,_,O.range,S,S=>N.isInTileRange(_,S,O.minimumRange,O.range));for(let N=0;N<B;N++){var le=D.getNextTile();if(!le)break;le=S.createTarget(void 0,le),this.createShrapnel(S,le,O.name)}}if(B.rules.limboLaunch&&!$&&this.fromObject?.isUnit()){let O,j,L=this.fromObject;if(N.rules.parasite&&(this.target.obj.isVehicle()||this.target.obj?.isAircraft())&&this.target.obj.parasiteableTrait&&(this.target.obj.parasiteableTrait.beingBoarded=!1),B=L.rules.movementZone===q.MovementZone.Fly)O=_,j=!1;else{let B=this.target.obj.isUnit()&&this.target.obj.tile.onBridgeLandType&&!this.target.obj.onBridge?void 0:S.map.tileOccupation.getBridgeOnTile(_),N=new Z.MovePositionHelper(S.map),D=new H.RadialTileFinder(S.map.tiles,S.map.mapBounds,_,{width:1,height:1},0,1,O=>{var j=S.map.tileOccupation.getBridgeOnTile(O);return 0<S.map.terrain.getPassableSpeed(O,L.rules.speedType,L.isInfantry(),!!j)&&N.isEligibleTile(O,j,B,_)&&(O===_||!S.map.terrain.findObstacles({tile:O,onBridge:B},L).length)});O=D.getNextTile(),j=!!O?.onBridgeLandType}O?(!B&&this.target.obj.isUnit()&&(L.onBridge=j,L.position.tileElevation=j?S.map.tileOccupation.getBridgeOnTile(O)?.tileElevation??0:0),S.unlimboObject(L,O),L.isInfantry()&&(L.position.subCell=this.target.obj.position.subCell),L.direction=this.direction):L.owner.removeOwnedObject(L)}}createShrapnel(S,O,B){let N=S.createLooseProjectile(B,this.fromPlayer,O);N.isShrapnel=!0,N.veteranDamageMult=this.veteranDamageMult,N.position.moveToLeptons(this.position.getMapPosition()),N.position.tileElevation=this.position.tileElevation,S.spawnObject(N,N.position.tile)}computeAimPointVersusMovingTarget(S,O,B,N){let j=S.position.worldPosition,L=j.clone();var D=O,U=S.moveTrait.velocity.length();if(D<3*U)return j.clone();let H=W.TargetUtil.computeInterceptPoint(B,D,j,S.moveTrait.velocity);if(H.length()){let O=H.clone().sub(j);if(D=O.length(),D=U?Math.ceil(D/U):0,H=j.clone().add(O.setLength(D*U)),N.isWithinHardBounds(H))if(S.zone!==_.ZoneType.Air){H.multiplyScalar(1/F.Coords.LEPTONS_PER_TILE);let O=S.position.clone();O.moveToTileCoords(H.x,H.z),L=O.worldPosition}else L=H;else L=j}return L.clone()}},S("Projectile",le)}}}),System.register("game/gameobject/Smudge",["engine/type/ObjectType","game/gameobject/GameObject"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.GameObject{static factory(S,O,B){return new this(S,O,B)}constructor(S,O,N){super(B.ObjectType.Smudge,S,O,N)}getFoundation(){return{width:this.rules.width,height:this.rules.height}}},S("Smudge",j)}}}),System.register("game/gameobject/Techno",["game/gameobject/GameObject","game/rules/TechnoRules","game/gameobject/unit/VeteranLevel","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends B.GameObject{get primaryWeapon(){return this.armedTrait?.primaryWeapon}get secondaryWeapon(){return this.armedTrait?.secondaryWeapon}get ammo(){return this.ammoTrait?.ammo}get sight(){return Math.min(N.TechnoRules.MAX_SIGHT,this.rules.sight*(this.veteranTrait?.getVeteranSightMultiplier()??1))}get veteranLevel(){return this.veteranTrait?.veteranLevel??j.VeteranLevel.None}constructor(S,O,B,N){super(S,O,B,N),this.explodes=this.rules.explodes,this.radarInvisible=this.rules.radarInvisible,this.c4=this.rules.c4,this.crusher=this.rules.crusher,this.defaultToGuardArea=this.rules.defaultToGuardArea,this.guardMode=this.rules.defaultToGuardArea,this.purchaseValue=this.rules.cost}resetGuardModeToIdle(){this.guardMode=this.defaultToGuardArea,this.guardArea=void 0}update(S){if(this.warpedOutTrait.isActive())for(var O of this.cachedTraits.tick)O.ticksWhenWarpedOut&&O[L.NotifyTick.onTick](this,S);else super.update(S)}isTechno(){return!0}},S("Techno",D)}}}),System.register("game/gameobject/Terrain",["engine/type/ObjectType","game/gameobject/GameObject"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.GameObject{static factory(S,O,B){return new this(S,O,B)}constructor(S,O,N){super(B.ObjectType.Terrain,S,O,N),this.radarInvisible=this.rules.radarInvisible}},S("Terrain",j)}}}),System.register("game/gameobject/Unit",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/gameobject/Vehicle",["engine/type/ObjectType","game/gameobject/trait/HarvesterTrait","game/gameobject/trait/TransportTrait","game/gameobject/trait/MoveTrait","game/gameobject/trait/TurretTrait","game/gameobject/unit/ZoneType","game/gameobject/trait/DockableTrait","game/gameobject/Techno","game/gameobject/trait/CrewedTrait","game/gameobject/trait/GunnerTrait","game/gameobject/trait/ParasiteableTrait","game/gameobject/trait/CrashableTrait","game/gameobject/trait/SubmergibleTrait","game/type/LocomotorType","game/gameobject/trait/HoverBobTrait","game/gameobject/unit/CrateBonuses","game/gameobject/trait/TilterTrait"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S}],execute:function(){S("ROCKING_TICKS",34),Y=class extends U.Techno{get isMoving(){return this.moveTrait.isMoving()}static factory(S,O,B,F,U){let Q=new this(S,O,B);return Q.isSinker=!O.underwater&&(O.weight>=F.general.shipSinkingWeight||!O.naval),Q.moveTrait=new L.MoveTrait(Q,U),Q.traits.add(Q.moveTrait),O.crashable&&(Q.crashableTrait=new z.CrashableTrait(Q),Q.traits.add(Q.crashableTrait)),O.crewed&&(Q.crewedTrait=new H.CrewedTrait,Q.traits.add(Q.crewedTrait)),O.harvester&&(Q.harvesterTrait=new N.HarvesterTrait(O.storage),Q.traits.add(Q.harvesterTrait)),O.passengers&&(Q.transportTrait=new j.TransportTrait(Q),Q.traits.add(Q.transportTrait),O.gunner&&(Q.gunnerTrait=new V.GunnerTrait,Q.traits.add(Q.gunnerTrait))),O.turret&&(Q.turretTrait=new D.TurretTrait,Q.traits.add(Q.turretTrait)),O.consideredAircraft&&!O.landable||Q.traits.add(new _.DockableTrait),O.parasiteable&&(Q.parasiteableTrait=new W.ParasiteableTrait(Q),Q.traits.add(Q.parasiteableTrait)),O.naval&&O.underwater&&(Q.submergibleTrait=new K.SubmergibleTrait,Q.traits.add(Q.submergibleTrait)),O.locomotor===$.LocomotorType.Hover&&Q.traits.add(new q.HoverBobTrait),[$.LocomotorType.Vehicle,$.LocomotorType.Chrono].includes(O.locomotor)&&B.isVoxel&&(Q.tilterTrait=new Z.TilterTrait,Q.traits.add(Q.tilterTrait)),Q}constructor(S,O,N){super(B.ObjectType.Vehicle,S,O,N),this.direction=0,this.spinVelocity=0,this.crateBonuses=new Q.CrateBonuses,this.turretNo=0,this.onBridge=!1,this.isSinker=!1,this.isFiring=!1,this.zone=O.naval?F.ZoneType.Water:F.ZoneType.Ground}isUnit(){return!0}isVehicle(){return!0}getUiName(){if(this.gunnerTrait){var S=this.armedTrait.getSpecialWeaponIndex(),O=this.gunnerTrait.getUiNameForIfvMode(S,this.transportTrait?.units[0]?.name);return S="name:"+this.name,O?`{${O}} {${S}}`:S}return super.getUiName()}update(S){this.rocking&&(this.rocking.ticksLeft--,this.rocking.ticksLeft||(this.rocking=void 0)),super.update(S)}applyRocking(S,O){this.rules.consideredAircraft||(this.rocking={ticksLeft:this.rocking?.ticksLeft??34,facing:S,factor:O})}},S("Vehicle",Y)}}}),System.register("game/gameobject/common/AnimTerrainEffect",["engine/type/ObjectType","game/map/TileCollection","game/type/LandType","game/gameobject/trait/TiberiumTrait"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("AnimTerrainEffect",class{destroyOre(S,O,N){if(O.landType===j.LandType.Tiberium&&(N.art.hasObject(S,B.ObjectType.Animation)?N.art.getAnimation(S):void 0)?.crater){let B=N.map.getObjectsOnTile(O).find(S=>S.isOverlay()&&S.isTiberium());if(B){var D=Math.ceil(L.TiberiumTrait.maxBails/2);D=S.startsWith("S_CLSN")?D:N.generateRandomInt(1,D);let O=B.traits.get(L.TiberiumTrait);O.removeBails(D),O.getBailCount()||N.unspawnObject(B)}}}spawnSmudges(S,O,L){if(O.landType===j.LandType.Clear&&0===O.rampType&&L.map.mapBounds.isWithinBounds(O)&&!L.map.getObjectsOnTile(O).find(S=>!S.isUnit())){var D=L.art.hasObject(S,B.ObjectType.Animation)?L.art.getAnimation(S):void 0;if(D?.crater){let S=D?.forceBigCraters?2:1,j=D?.scorch,F=[N.TileDirection.Bottom,N.TileDirection.BottomLeft,N.TileDirection.BottomRight].every(S=>L.map.tiles.getNeighbourTile(O,S));D=[...L.rules.smudgeRules.values()].filter(O=>(O.crater&&O.width===S&&O.height===S||j&&O.burn)&&!((1<O.width||1<O.height)&&!F)),D.length&&(D=D[L.generateRandomInt(0,D.length-1)].name,D=L.createObject(B.ObjectType.Smudge,D),L.spawnObject(D,O))}}}})}}}),System.register("game/gameobject/common/DeathType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("DeathType",B={}))[O.None=0]="None",O[O.Normal=1]="Normal",O[O.Demolish=2]="Demolish",O[O.Crush=3]="Crush",O[O.Temporal=4]="Temporal",O[O.Sink=5]="Sink"}}}),System.register("game/gameobject/infantry/InfDeathType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("InfDeathType",B={}))[O.None=0]="None",O[O.Gunfire=1]="Gunfire",O[O.Explode=2]="Explode",O[O.ExplodeAlt=3]="ExplodeAlt",O[O.Fire=4]="Fire",O[O.Electro=5]="Electro",O[O.HeadExplode=6]="HeadExplode",O[O.Nuke=7]="Nuke"}}}),System.register("game/gameobject/infantry/StanceType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("StanceType",B={}))[O.None=0]="None",O[O.Guard=1]="Guard",O[O.Prone=2]="Prone",O[O.Deployed=3]="Deployed",O[O.Paradrop=4]="Paradrop",O[O.Cheer=5]="Cheer"}}}),System.register("game/gameobject/infantry/sequenceMap",["game/gameobject/unit/ZoneType","game/art/SequenceType","game/gameobject/infantry/StanceType","game/gameobject/infantry/InfDeathType"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("getFireSequenceBy",D=(S,O=j.StanceType.None)=>O===j.StanceType.Deployed?N.SequenceType.DeployedFire:S===B.ZoneType.Water?N.SequenceType.WetAttack:S===B.ZoneType.Air?N.SequenceType.FireFly:O===j.StanceType.Prone?N.SequenceType.FireProne:N.SequenceType.FireUp),S("getMoveSequenceBy",F=(S,O,L)=>S===B.ZoneType.Air?N.SequenceType.Fly:S===B.ZoneType.Water?N.SequenceType.Swim:O===j.StanceType.Prone?N.SequenceType.Crawl:L?N.SequenceType.Panic:N.SequenceType.Walk),S("getIdleSequenceBy",(S,O=j.StanceType.None)=>O===j.StanceType.Deployed?[N.SequenceType.DeployedIdle]:S===B.ZoneType.Water?[N.SequenceType.WetIdle1,N.SequenceType.WetIdle2]:S!==B.ZoneType.Air?[N.SequenceType.Idle1,N.SequenceType.Idle2]:void 0),S("getStillSequenceBy",_=(S,O=j.StanceType.None)=>O===j.StanceType.Deployed?N.SequenceType.Deployed:S===B.ZoneType.Water?N.SequenceType.Tread:S===B.ZoneType.Air?N.SequenceType.Hover:O===j.StanceType.Prone?N.SequenceType.Prone:O===j.StanceType.Guard?N.SequenceType.Guard:O===j.StanceType.Paradrop?N.SequenceType.Paradrop:N.SequenceType.Ready),S("getStanceTransitionSequenceBy",(S,O)=>S===j.StanceType.Prone?N.SequenceType.Up:O===j.StanceType.Prone?N.SequenceType.Down:S===j.StanceType.Deployed?N.SequenceType.Undeploy:O===j.StanceType.Deployed?N.SequenceType.Deploy:O===j.StanceType.Cheer?N.SequenceType.Cheer:void 0),S("getCrashingSequences",S=>{let O=[...S.art.sequences.keys()];var B=[N.SequenceType.AirDeathStart,N.SequenceType.AirDeathFalling].filter(S=>O.includes(S));if(B.length)return B}),S("getDeathSequence",(S,O)=>{var j=S.zone,D=S.rules.isHuman;let F,_=[...S.art.sequences.keys()];return S.isCrashing?F=[N.SequenceType.AirDeathFinish]:j===B.ZoneType.Air?F=[N.SequenceType.Tumble]:j===B.ZoneType.Water?![L.InfDeathType.Gunfire,L.InfDeathType.Explode].includes(O)&&D||(F=[N.SequenceType.WetDie1,N.SequenceType.WetDie2]):O!==L.InfDeathType.Gunfire&&D?O===L.InfDeathType.Explode&&(F=[N.SequenceType.Die2]):F=[N.SequenceType.Die1],F&&(F=F.filter(S=>_.includes(S)),F.length||(F=void 0)),F}),S("getDeathAnim",(S,O)=>O===L.InfDeathType.ExplodeAlt?S.audioVisual.infantryExplode:O===L.InfDeathType.Fire?S.audioVisual.flamingInfantry:O===L.InfDeathType.Electro?[...S.animationNames][1]:O===L.InfDeathType.HeadExplode?S.audioVisual.infantryHeadPop:O===L.InfDeathType.Nuke?S.audioVisual.infantryNuked:void 0),S("findSequence",(S,O,N,L,U,H)=>{var u=S=>-1!==H.indexOf(S);let V;return L&&(V=D(S,O),u(V)||(V=D(S),u(V)||(V=void 0))),void 0===V&&N&&(V=F(S,O,U),u(V)||(V=F(S,j.StanceType.None,U),u(V)||(V=void 0))),void 0===V&&(V=_(S,O),u(V)||(V=_(S),u(V)||(V=_(B.ZoneType.Ground)))),V})}}}),System.register("game/gameobject/locomotor/ChronoLocomotor",["game/math/Vector2","game/math/Vector3"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("ChronoLocomotor",class{constructor(S){this.game=S,this.ignoresTerrain=!0,this.distanceToWaypoint=new B.Vector2}onNewWaypoint(S,O){}tick(S,O,B,j){if(j)return{distance:new N.Vector3,done:!0};this.distanceToWaypoint.copy(O).sub(S.position.getMapPosition());var L,D=this.game.rules.general;return D.chronoTrigger&&(D=(L=this.distanceToWaypoint.length())<D.chronoRangeMinimum?D.chronoMinimumDelay:L/D.chronoDistanceFactor,S.warpedOutTrait.setTimed(D,!1,this.game)),{distance:new N.Vector3(this.distanceToWaypoint.x,0,this.distanceToWaypoint.y),done:!0,isTeleport:!0}}})}}}),System.register("game/gameobject/locomotor/DriveLocomotor",["game/gameobject/unit/FacingUtil","game/gameobject/task/TurnTask","game/Coords","game/math/geometry","game/math/Vector2","game/math/Vector3","game/math/CurvePath","game/math/LineCurve","game/math/QuadraticBezierCurve","util/math"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){var O;(O=W=W||{})[O.None=0]="None",O[O.Start=1]="Start",O[O.Normal=2]="Normal",O[O.End=3]="End",O[O.Single=4]="Single",S("DriveLocomotor",class{constructor(S){this.game=S,this.hasMomentum=!1,this.moveOnCurve=!1,this.currentSpeed=0,this.distanceTravelled=0,this.carryOverDistance=0,this.currentWaypointType=W.None}selectNextWaypoint(S,O){if(this.currentWaypointType=this.currentWaypointType&&this.currentWaypointType!==W.End?W.Normal:W.Start,this.initialPosition=S.position.getMapPosition(),this.currentWaypointType!==W.Start?S.moveTrait.speedPenalty=0:this.currentSpeed=0,1<O.length){var N=O[O.length-1],F=O[O.length-2],V=new D.Vector2(N.tile.rx-S.tile.rx,N.tile.ry-S.tile.ry),z=Math.abs(L.angleDegFromVec2(V)-L.angleDegFromVec2(new D.Vector2(F.tile.rx-N.tile.rx,F.tile.ry-N.tile.ry)));if(!Math.abs(B.FacingUtil.fromMapCoords(V)-S.direction)&&0<z&&z<90&&this.hasMomentum){this.moveOnCurve=!0,this.currentWaypointType=2===O.length?this.currentWaypointType===W.Start?W.Single:W.End:W.Normal;let S=this.initialPosition;V=new D.Vector2(N.tile.rx+.5,N.tile.ry+.5).multiplyScalar(j.Coords.LEPTONS_PER_TILE);let B=new D.Vector2(F.tile.rx+.5,F.tile.ry+.5).multiplyScalar(j.Coords.LEPTONS_PER_TILE);return z=S.clone().lerp(V,.5),N=B.clone().lerp(V,.5),this.steerCurve=new _.CurvePath,this.steerCurve.add(new U.LineCurve(S,z)),this.steerCurve.add(new H.QuadraticBezierCurve(z,V,N)),this.steerCurve.add(new U.LineCurve(N,B)),this.lastPosition=S,F}}else this.currentWaypointType=this.currentWaypointType===W.Start?W.Single:W.End;return this.hasMomentum=!0,this.moveOnCurve=!1,O[O.length-1]}onNewWaypoint(S,O,j){let L=(new D.Vector2).copy(O).sub(this.initialPosition);this.distanceTravelled=0,this.totalDistanceToTravel=this.moveOnCurve?this.steerCurve.getLength():L.length();var F=B.FacingUtil.fromMapCoords(L);if(F!==S.direction&&(this.pointTurretToTarget(S,j),!this.moveOnCurve))return S.moveTrait.velocity.set(0,0,0),[new N.TurnTask(F)]}tick(S,O,N){this.pointTurretToTarget(S,N);let L=this.currentSpeed;L=S.rules.accelerates?(W=this.distanceTravelled/this.totalDistanceToTravel,this.currentSpeed=this.applyAcceleration(S,L,S.moveTrait.baseSpeed,W)):this.currentSpeed=S.moveTrait.baseSpeed,1<L&&(L=Math.floor(L));let _=this.game.map.terrain.getPassableSpeed(S.tile,S.rules.speedType,S.isInfantry(),S.onBridge,void 0,!0);_?S.moveTrait.lastTileSpeed=_:_=S.moveTrait.lastTileSpeed||1,L*=_,1<L&&(L=Math.floor(L)),this.carryOverDistance&&(L=this.carryOverDistance);var U=S.position.getMapPosition();let H;if(this.moveOnCurve){var V=this.steerCurve.getLength(),W=Math.min(this.distanceTravelled+L,V);this.carryOverDistance=Math.max(0,this.distanceTravelled+L-V),this.distanceTravelled=W;let O=this.steerCurve.getPointAt(this.distanceTravelled/V),N=this.steerCurve.getTangentAt(this.distanceTravelled/V);W=N.clone().setLength(L),S.moveTrait.velocity.set(W.x,0,W.y),V=S.rules.rot;var{facing:W,delta:V}=B.FacingUtil.tick(S.direction,B.FacingUtil.fromMapCoords(N),V);S.direction=W,S.spinVelocity=V,V=this.lastPosition,this.lastPosition=O.clone(),H=O.sub(V)}else{let B=(new D.Vector2).copy(O).sub(U);U=Math.min(B.length(),L),H=B.clone().setLength(U);let N=H.clone();this.carryOverDistance&&N.add(j.Coords.vecWorldToGround(S.moveTrait.velocity)),S.moveTrait.velocity.set(N.x,0,N.y),this.distanceTravelled+=U,this.carryOverDistance=Math.max(0,L-B.length())}return{distance:new F.Vector3(H.x,0,H.y),done:!H.length()||!!this.carryOverDistance}}pointTurretToTarget(S,O){if(S.turretTrait){S.attackTrait?.currentTarget?.obj&&(O=S.attackTrait.currentTarget.obj.position.getMapPosition());var N=S.position.getMapPosition();let j=(new D.Vector2).copy(O).sub(N);j.length()&&(N=B.FacingUtil.fromMapCoords(j),S.turretTrait.desiredFacing=N)}}applyAcceleration(S,O,B,N){return this.currentWaypointType===W.Single?B/2:this.currentWaypointType!==W.End?Math.min(O+S.rules.accelerationFactor*B,B):(this.moveOnCurve&&this.currentWaypointType===W.End&&(N=N<=.5?0:2*(N-.5)),V.lerp(1,B,1-N))}})}}}),System.register("game/gameobject/locomotor/FootLocomotor",["game/gameobject/unit/FacingUtil","game/gameobject/infantry/StanceType","game/math/Vector2","game/math/Vector3"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("FootLocomotor",class{constructor(S){this.game=S,this.currentMoveDirection=new j.Vector2,this.distanceToWaypoint=new j.Vector2,this.endPauseFrames=0}onNewWaypoint(S,O){this.currentMoveDirection.copy(O).sub(S.position.getMapPosition());var N=B.FacingUtil.fromMapCoords(this.currentMoveDirection);N!==S.direction&&(S.direction=N),this.endPauseFrames=1}onWaypointUpdate(S,O){this.onNewWaypoint(S,O)}tick(S,O,B){let j=S.moveTrait.baseSpeed;j=Math.floor(j),S.stance===N.StanceType.Prone&&(j*=S.art.crawls?.5:2),S.isPanicked&&(j*=2);let D=this.game.map.terrain.getPassableSpeed(S.tile,S.rules.speedType,S.isInfantry(),S.onBridge,void 0,!0);D?S.moveTrait.lastTileSpeed=D:D=S.moveTrait.lastTileSpeed||1,j*=D,j=Math.floor(j),this.distanceToWaypoint.copy(O).sub(S.position.getMapPosition());let F=this.distanceToWaypoint.clone().setLength(j);(F.length()||O.equals(B))&&S.moveTrait.velocity.set(F.x,0,F.y);var _=Math.min(this.distanceToWaypoint.length(),j),U=!_&&0<this.endPauseFrames--;return this.distanceToWaypoint.setLength(_),{distance:new L.Vector3(this.distanceToWaypoint.x,0,this.distanceToWaypoint.y),done:!this.distanceToWaypoint.length()&&!U}}})}}}),System.register("game/gameobject/locomotor/HoverLocomotor",["game/Coords","game/gameobject/unit/FacingUtil","game/GameSpeed","game/math/geometry","game/math/Vector2","game/math/Vector3"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){var O;(O=_=_||{})[O.None=0]="None",O[O.Start=1]="Start",O[O.Normal=2]="Normal",O[O.End=3]="End",O[O.Single=4]="Single",S("HoverLocomotor",class{constructor(S){this.hoverRules=S,this.currentSpeed=0,this.distanceTravelled=0,this.carryOverDistance=0,this.currentWaypointType=_.None,this.nextWaypointDir=new D.Vector2}selectNextWaypoint(S,O){var B,N;return this.currentWaypointType=this.currentWaypointType&&this.currentWaypointType!==_.End?_.Normal:_.Start,this.initialPosition=S.position.getMapPosition(),this.currentWaypointType===_.Start&&(this.currentSpeed=0),O.length<=1?(this.currentWaypointType=this.currentWaypointType===_.Start?_.Single:_.End,(N=O[O.length-1])&&this.nextWaypointDir.set(N.tile.rx-S.tile.rx,N.tile.ry-S.tile.ry)):(B=O[O.length-1],N=O[O.length-2],this.nextWaypointDir.set(N.tile.rx-B.tile.rx,N.tile.ry-B.tile.ry)),O[O.length-1]}onNewWaypoint(S,O,B){let N=(new D.Vector2).copy(O).sub(this.initialPosition);this.distanceTravelled=0,this.totalDistanceToTravel=N.length();var L=this.maxSpeed=S.moveTrait.baseSpeed,F=60*this.hoverRules.acceleration*j.GameSpeed.BASE_TICKS_PER_SECOND;this.acceleration=L/F,F=60*this.hoverRules.brake*j.GameSpeed.BASE_TICKS_PER_SECOND,this.deceleration=L/F}tick(S,O){var j=S.position.getMapPosition();let D=O.clone().sub(j);var U=D.length();j=this.maxSpeed,this.currentWaypointType===_.Single?this.currentSpeed=j/2:this.currentWaypointType===_.End?(H=this.computeBrakeDistance(this.currentSpeed,this.deceleration),this.totalDistanceToTravel-this.distanceTravelled<=H&&(this.currentSpeed=Math.max(1,this.currentSpeed-this.deceleration))):this.currentSpeed=Math.min(this.currentSpeed+this.acceleration,j);var H=N.FacingUtil.fromMapCoords(D);j=N.FacingUtil.fromMapCoords(this.nextWaypointDir);let V=H,W=S.rules.rot;this.currentWaypointType===_.Normal&&H!==j&&(H=(z=L.angleDegBetweenVec2(this.nextWaypointDir,N.FacingUtil.toMapCoords(S.direction)))/W,H=Math.max(this.currentSpeed*H,this.totalDistanceToTravel),this.totalDistanceToTravel-this.distanceTravelled<=H&&(V=j,W=z/((this.totalDistanceToTravel-this.distanceTravelled)/this.currentSpeed)));var z=N.FacingUtil.tick(S.direction,V,W).facing;S.direction=z;let K=this.currentSpeed;this.carryOverDistance&&(K=this.carryOverDistance),z=Math.min(K,U);let $=D.clone().setLength(z),q=$.clone();return this.carryOverDistance&&q.add(B.Coords.vecWorldToGround(S.moveTrait.velocity)),S.moveTrait.velocity.set(q.x,0,q.y),this.distanceTravelled+=z,this.carryOverDistance=Math.max(0,K-U),{distance:new F.Vector3($.x,0,$.y),done:!$.length()||!!this.carryOverDistance}}computeBrakeDistance(S,O){var B=S/O;return Math.max(0,S*B-O*B*B/2)}})}}}),System.register("game/gameobject/locomotor/JumpjetLocomotor",["game/Coords","game/gameobject/unit/FacingUtil","game/gameobject/unit/TargetUtil","util/geometry","game/gameobject/unit/ZoneType","game/event/ObjectLiftOffEvent","game/event/ObjectLandEvent","game/type/SpeedType","game/gameobject/infantry/StanceType","game/math/Vector2","game/math/Vector3"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S}],execute:function(){S("JumpjetLocomotor",class{static tickStationary(S,O){if(S.zone===D.ZoneType.Air){var N=S.tile.onBridgeLandType?O.map.tileOccupation.getBridgeOnTile(S.tile):void 0,j=!S.rules.balloonHover&&(!S.unitOrderTrait.getCurrentTask()?.preventLanding||!S.rules.hoverAttack)&&(O.map.getGroundObjectsOnTile(S.tile).find(O=>O.isBuilding()&&O.dockTrait?.isDocked(S))||O.map.getTileZone(S.tile)!==D.ZoneType.Water&&0<O.map.terrain.getPassableSpeed(S.tile,U.SpeedType.Foot,!0,!!S.tile.onBridgeLandType)&&0===O.map.terrain.findObstacles({tile:S.tile,onBridge:N},S).length);let z;z=j?(L=S.tile.z+(N?.tileElevation??0),B.Coords.tileHeightToWorld(L)):(F=S.tile.z+O.map.getGroundObjectsOnTile(S.tile).filter(S=>!(S.isInfantry()&&S.stance===H.StanceType.Paradrop)).reduce((S,O)=>Math.max(S,O.tileElevation+O.art.height),0),B.Coords.tileHeightToWorld(F)+S.rules.jumpjetHeight);var L,F,V=S.position.worldPosition.y;z!==V?(L=S.rules.jumpjetClimb,F=Math.abs(z-V),L=Math.sign(z-V)*Math.min(L,F),F=S.tileElevation,S.position.moveByLeptons3(new W.Vector3(0,L,0)),S.moveTrait.handleElevationChange(F,O)):j&&(S.zone=D.ZoneType.Ground,S.onBridge=!!N,O.events.dispatch(new _.ObjectLandEvent(S)),(N=O.map.tileOccupation.getGroundObjectsOnTile(S.tile).find(S=>S.isOverlay()&&S.rules.crate))&&O.crateGeneratorTrait.pickupCrate(S,N,O))}}static tickCrash(S,O,B){var N=2*S.rules.jumpjetCrash;return S.direction=(S.direction-6+360)%360,new W.Vector3(0,-N,0)}constructor(S){this.game=S,this.allowOutOfBounds=!0,this.currentMoveDir=new V.Vector2,this.currentHorizSpeed=0}onNewWaypoint(S,O,B){this.currentMoveDir=N.FacingUtil.toMapCoords(S.direction),this.cancelDestLeptons=void 0}tick(S,O,_,U){if(S.zone!==D.ZoneType.Air&&(S.onBridge=!1,S.zone=D.ZoneType.Air,this.game.events.dispatch(new F.ObjectLiftOffEvent(S))),U){if(!this.cancelDestLeptons){let O=S.tile;this.game.map.isWithinBounds(O)||(O=this.game.map.clampWithinBounds(O)),this.cancelDestLeptons=this.computeCancelDest(O,_)}_=this.cancelDestLeptons}var V=S.position.getMapPosition();let z=_.clone().sub(V);var K=this.findTilesToCheckForBlockers(S.tile,V,this.currentMoveDir,z.length()).map(S=>S.z+this.game.map.getGroundObjectsOnTile(S).filter(S=>!(S.isDestroyed||S.isInfantry()&&S.stance===H.StanceType.Paradrop)).reduce((S,O)=>Math.max(S,O.tileElevation+O.art.height),0)).reduce((S,O)=>Math.max(S,O),0);let $=0;(void 0===this.lastClearZ||2<K-this.lastClearZ)&&($=4);var q,Q=B.Coords.tileHeightToWorld(K),Z=B.Coords.tileHeightToWorld(K+$),Y=S.position.worldPosition.y,X=N.FacingUtil.fromMapCoords(z),J=z.length()<S.rules.jumpjetSpeed;let ee=0;Q<=Y&&!J&&(({facing:ne,delta:q}=N.FacingUtil.tick(S.direction,X,S.rules.jumpjetTurnRate)),ee=q,S.direction=ne,this.currentMoveDir.copy(N.FacingUtil.toMapCoords(S.direction))),S.isVehicle()&&(S.spinVelocity=ee);let te,ie=!1,re=0,se=0;var ne=S.rules.jumpjetClimb;let ae;Y<Z?(re=Math.min(ne,Z-Y),te=!1,this.currentHorizSpeed=0):(this.lastClearZ=K,te=!0,(K=Q+S.rules.jumpjetHeight)!==Y&&(Q=Math.abs(K-Y),re=Math.sign(K-Y)*Math.min(ne,Q),te=Q<=ne),ne=this.currentHorizSpeed,this.currentHorizSpeed=Math.min(this.currentHorizSpeed+2,S.rules.jumpjetSpeed),ie=X===S.direction?(se=Math.min(ne,z.length()),ne>=z.length()):((V=ne||ee?j.TargetUtil.computeTurnCircle(V,this.currentMoveDir,Math.sign(ee)*S.rules.jumpjetTurnRate,ne):void 0)&&L.circleContainsPoint(V,_)?(se=0,this.currentHorizSpeed=0):se=ne,!1)),ae=J?(ie=!0,z):this.currentMoveDir.clone().setLength(se);let oe=new W.Vector3(ae.x,re,ae.y);return J=oe.clone(),S.moveTrait.velocity.copy(J),{distance:oe,done:ie&&te}}findTilesToCheckForBlockers(S,O,N,j){var L=N.clone().setLength(Math.min(j,B.Coords.LEPTONS_PER_TILE)).add(O).multiplyScalar(1/B.Coords.LEPTONS_PER_TILE).floor(),D=this.game.map.tiles.getByMapCoords(L.x,L.y);if(!D||D===S)return[S];L=Math.sign(D.rx-S.rx),D=Math.sign(D.ry-S.ry);let F,_=[S];return L&&(F=this.game.map.tiles.getByMapCoords(S.rx+L,S.ry),F&&_.push(F)),D&&(F=this.game.map.tiles.getByMapCoords(S.rx,S.ry+D),F&&_.push(F)),L&&D&&(F=this.game.map.tiles.getByMapCoords(S.rx+L,S.ry+D),F&&_.push(F)),_}computeCancelDest(S,O){var N=O.clone().multiplyScalar(1/B.Coords.LEPTONS_PER_TILE).floor().multiplyScalar(B.Coords.LEPTONS_PER_TILE);return N=O.clone().sub(N),new V.Vector2(S.rx,S.ry).multiplyScalar(B.Coords.LEPTONS_PER_TILE).add(N)}})}}}),System.register("game/gameobject/locomotor/Locomotor",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/gameobject/locomotor/LocomotorFactory",["game/type/LocomotorType","game/gameobject/locomotor/ChronoLocomotor","game/gameobject/locomotor/DriveLocomotor","game/gameobject/locomotor/FootLocomotor","game/gameobject/locomotor/HoverLocomotor","game/gameobject/locomotor/JumpjetLocomotor","game/gameobject/locomotor/MissileLocomotor","game/gameobject/locomotor/WingedLocomotor"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){S("LocomotorFactory",class{constructor(S){this.game=S}create(S){var O=S.rules.locomotor;switch(O){case B.LocomotorType.Infantry:return new L.FootLocomotor(this.game);case B.LocomotorType.Jumpjet:return new F.JumpjetLocomotor(this.game);case B.LocomotorType.Vehicle:case B.LocomotorType.Ship:return new j.DriveLocomotor(this.game);case B.LocomotorType.Chrono:return S.isVehicle()&&S.harvesterTrait&&S.rules.teleporter?new j.DriveLocomotor(this.game):new N.ChronoLocomotor(this.game);case B.LocomotorType.Aircraft:return new U.WingedLocomotor(this.game);case B.LocomotorType.Missile:return new _.MissileLocomotor(this.game,this.game.rules.general.getMissileRules(S.name));case B.LocomotorType.Hover:return new D.HoverLocomotor(this.game.rules.general.hover);default:throw new Error("Unhandled locomotor type "+O)}}})}}}),System.register("game/gameobject/locomotor/MissileLocomotor",["game/Coords","game/gameobject/unit/ZoneType","game/event/ObjectLiftOffEvent","game/math/geometry","game/gameobject/unit/FacingUtil","game/math/Vector3","game/math/Vector2","game/math/CubicBezierCurve3","game/math/GameMath"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S}],execute:function(){var O;(O=V=V||{})[O.Boost=0]="Boost",O[O.Midcourse=1]="Midcourse",O[O.Terminal=2]="Terminal",S("MissileLocomotor",class{constructor(S,O){this.game=S,this.missileRules=O,this.flightPhase=V.Boost}selectNextWaypoint(S,O){var N=O[O.length-1],j=this.game.map.tileOccupation.getBridgeOnTile(N.tile);return j=N.tile.z+(j?.tileElevation??0),this.targetPosition=B.Coords.tile3dToWorld(N.tile.rx+.5,N.tile.ry+.5,j),this.cruiseAltitude=B.Coords.tileHeightToWorld(j)+this.missileRules.altitude,N}onNewWaypoint(S,O,B){}tick(S,O,W){let z,K=S.position.worldPosition.clone(),$=this.targetPosition.clone().sub(K);var q;S.zone!==N.ZoneType.Air&&(S.onBridge=!1,S.zone=N.ZoneType.Air,this.game.events.dispatch(new j.ObjectLiftOffEvent(S))),z=this.currentVelocity?(q=S.rules.speed,Math.min(this.currentVelocity.length()+this.missileRules.acceleration,q)):(te=this.missileRules.acceleration,this.missileRules.lazyCurve?this.currentVelocity=new F.Vector3($.x,0,$.z):this.currentVelocity=B.Coords.vecGroundToWorld(D.FacingUtil.toMapCoords(S.direction)),L.rotateVec3Towards(this.currentVelocity,new F.Vector3(this.currentVelocity.x,1e8,this.currentVelocity.z),S.pitch),te),this.currentVelocity.setLength(z);let Q=!1;switch(this.flightPhase){case V.Boost:if(!(S.position.worldPosition.y>=this.cruiseAltitude)){Q=!1;break}this.flightPhase=V.Midcourse;case V.Midcourse:var Z,Y=new _.Vector2($.x,$.z).length();if(!this.missileRules.lazyCurve){L.rotateVec3Towards(this.currentVelocity,new F.Vector3(this.currentVelocity.x,0,this.currentVelocity.z),S.rules.rot),this.currentVelocity.y<1&&(Z=this.currentVelocity.length(),this.currentVelocity.y=0,this.currentVelocity.setLength(Z)),L.rotateVec3Towards(this.currentVelocity,new F.Vector3($.x,this.currentVelocity.y,$.z),S.rules.rot),S.direction=D.FacingUtil.fromMapCoords(B.Coords.vecWorldToGround(this.currentVelocity)),S.pitch=Math.sign(this.currentVelocity.y)*L.angleDegBetweenVec3(this.currentVelocity,new F.Vector3(this.currentVelocity.x,0,this.currentVelocity.z)),Y/(K.y-this.targetPosition.y)<1&&(this.flightPhase=V.Terminal);break}this.flightPhase=V.Terminal;var X=K.clone().add(this.currentVelocity.clone().setLength(Y/3/H.GameMath.cos(L.degToRad(S.pitch)))),J=this.targetPosition.clone().lerp(K,.15).setY(X.y);this.descentCurve=new U.CubicBezierCurve3(K,X,J,this.targetPosition);case V.Terminal:if(X=this.missileRules.bodyLength,this.missileRules.lazyCurve){var ee=this.descentCurve.getLength();this.descentTravelled??(this.descentTravelled=0),this.descentTravelled+=Math.min(z,ee-X-this.descentTravelled),J=this.descentTravelled/ee;let O=this.descentCurve.getPointAt(J),B=this.descentCurve.getTangentAt(J);this.currentVelocity.copy(O.sub(K)),J=B.clone().setY(0),S.pitch=Math.sign(B.y-J.y)*L.angleDegBetweenVec3(J,B),Q=1<=(this.descentTravelled+X)/ee}else L.rotateVec3Towards(this.currentVelocity,$,S.rules.rot),S.direction=D.FacingUtil.fromMapCoords(B.Coords.vecWorldToGround(this.currentVelocity)),S.pitch=Math.sign(this.currentVelocity.y)*L.angleDegBetweenVec3(this.currentVelocity,new F.Vector3(this.currentVelocity.x,0,this.currentVelocity.z)),((ee=$.length()-X)<z||ee<1)&&(this.currentVelocity.copy($.clone().addScalar(-X)),Q=!0);break;default:throw new Error(`Unhandled flight phase "${this.flightPhase}"`)}var te=K.clone().add(this.currentVelocity);return this.game.map.isWithinHardBounds(te)?(S.moveTrait.velocity.copy(this.currentVelocity),{distance:this.currentVelocity,done:Q}):(this.game.destroyObject(S),{done:!0,distance:new F.Vector3})}})}}}),System.register("game/gameobject/locomotor/WingedLocomotor",["game/Coords","game/gameobject/unit/FacingUtil","game/gameobject/unit/TargetUtil","util/geometry","game/gameobject/unit/ZoneType","game/event/ObjectLiftOffEvent","game/event/ObjectLandEvent","game/type/SpeedType","game/gameobject/task/MoveToDockTask","game/gameobject/trait/interface/NotifyTick","game/math/Vector2","game/math/Vector3","util/math","game/math/GameMath"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S}],execute:function(){var O;(O=q=q||{})[O.None=0]="None",O[O.CircleStrafe=1]="CircleStrafe",O[O.HoverStrafe=2]="HoverStrafe",S("WingedLocomotor",class{static tickStationary(S,O){if(S.zone===D.ZoneType.Air){var j=S.tile.onBridgeLandType?O.map.tileOccupation.getBridgeOnTile(S.tile):void 0;let $,q=S.rules.landable&&!S.unitOrderTrait.getCurrentTask()?.preventLanding,Q=S.spawnLinkTrait?.getParent();if(q&&Q?q=!((!Q.isUnit()||!Q.onBridge)&&j||Q.tile!==S.tile):q&&!S.airportBoundTrait&&(q=O.map.getTileZone(S.tile)!==D.ZoneType.Water&&0<O.map.terrain.getPassableSpeed(S.tile,U.SpeedType.Foot,!0,!!S.tile.onBridgeLandType)&&0===O.map.terrain.findObstacles({tile:S.tile,onBridge:j},S).length),q){let D=S.airportBoundTrait?.preferredAirport?.dockTrait;var L=D?.isDocked(S)||D?.hasReservedDockForUnit(S);if(!S.airportBoundTrait||L){var F=L?0:270;if(S.direction!==F)return void(S.direction=N.FacingUtil.tick(S.direction,F,S.rules.rot).facing)}if(S.airportBoundTrait){let B=S.airportBoundTrait.preferredAirport;if(!B?.dockTrait?.isDocked(S))return B?.dockTrait?.getAvailableDockCount()||(B=S.airportBoundTrait.findAvailableAirport(S),S.airportBoundTrait.preferredAirport=B,B&&(F=B.dockTrait.getFirstAvailableDockNumber(),B.dockTrait.reserveDockAt(S,F))),void(B?(S.unitOrderTrait.addTask(new H.MoveToDockTask(O,B)),S.unitOrderTrait[V.NotifyTick.onTick](S,O)):S.crashableTrait.crash(void 0))}let _;_=Q?Q.tile.z+Q.tileElevation:S.tile.z+(j?.tileElevation??0),$=B.Coords.tileHeightToWorld(_)}else{var W=S.tile.z+(j?.tileElevation??0),K=S.rules.flightLevel??O.rules.general.flightLevel;$=B.Coords.tileHeightToWorld(W)+K}$!==(W=S.position.worldPosition.y)?(K=Math.abs($-W),W=Math.sign($-W)*Math.min(30,K),K=S.tileElevation,S.position.moveByLeptons3(new z.Vector3(0,W,0)),S.moveTrait.handleElevationChange(K,O)):q&&(S.zone=D.ZoneType.Ground,Q?Q.airSpawnTrait.storeAircraft(S,O):S.onBridge=!!j,O.events.dispatch(new _.ObjectLandEvent(S)),(j=O.map.tileOccupation.getGroundObjectsOnTile(S.tile).find(S=>S.isOverlay()&&S.rules.crate))&&O.crateGeneratorTrait.pickupCrate(S,j,O))}}static tickCrash(S,O,N){N.rollDelta??(N.rollDelta=O.generateRandomInt(-15,15)),N.pitchDelta??(N.pitchDelta=O.generateRandomInt(0,15)),S.roll+=N.rollDelta,S.pitch+=N.pitchDelta;var j=B.Coords.vecWorldToGround(S.moveTrait.velocity);return new z.Vector3(j.x,-30,j.y)}constructor(S){this.game=S,this.allowOutOfBounds=!0,this.lastDestLeptons=new W.Vector2,this.currentMoveDir=new W.Vector2,this.currentHorizSpeed=0,this.maneuverType=q.None,this.deceleratingToTurn=!1}onNewWaypoint(S,O,N){this.currentHorizSpeed=B.Coords.vecWorldToGround(S.moveTrait.velocity).length(),this.cancelDestLeptons=void 0}tick(S,O,_,U){if(U){if(!this.cancelDestLeptons){let O=S.tile;this.game.map.isWithinBounds(O)||(O=this.game.map.clampWithinBounds(O)),this.cancelDestLeptons=this.computeCancelDest(O,_)}_=this.cancelDestLeptons}var H=S.position.getMapPosition();let V=_.clone().sub(H);var W=V.length();this.lastDestLeptons.equals(_)||(this.lastDestLeptons.copy(_),U?this.maneuverType=q.HoverStrafe:S.zone===D.ZoneType.Air&&this.currentHorizSpeed<5?this.maneuverType=W>B.Coords.LEPTONS_PER_TILE?q.CircleStrafe:q.HoverStrafe:this.maneuverType=q.None,this.deceleratingToTurn=!1),S.zone!==D.ZoneType.Air&&(S.onBridge=!1,S.zone=D.ZoneType.Air,this.game.events.dispatch(new F.ObjectLiftOffEvent(S)));var Q=S.tile.onBridgeLandType?this.game.map.tileOccupation.getBridgeOnTile(S.tile):void 0,Z=S.tile.z+(Q?.tileElevation??0),Y=S.rules.flightLevel??this.game.rules.general.flightLevel,X=B.Coords.tileHeightToWorld(Z)+Y,J=(Q=S.position.worldPosition.y,N.FacingUtil.fromMapCoords(V));let ee;switch(S.direction===J&&this.maneuverType===q.None&&W<=B.Coords.LEPTONS_PER_TILE?this.maneuverType=q.HoverStrafe:S.direction===J&&this.maneuverType===q.CircleStrafe&&(this.maneuverType=q.None),this.maneuverType){case q.HoverStrafe:if(S.attackTrait?.currentTarget){let O=B.Coords.vecWorldToGround(S.attackTrait.currentTarget.getWorldCoords());ee=N.FacingUtil.fromMapCoords(O.sub(H))}else ee=S.airportBoundTrait?.preferredAirport?.dockTrait?.hasReservedDockForUnit(S)?0:270;break;case q.CircleStrafe:case q.None:ee=J;break;default:throw new Error('Unknown maneuver type "'+this.maneuverType)}var{facing:te,delta:ie}=N.FacingUtil.tick(S.direction,ee,S.rules.rot);let re;switch(S.direction=te,S.roll=Math.sign(ie)*S.rules.pitchAngle,this.maneuverType){case q.HoverStrafe:re=J;break;case q.CircleStrafe:re=(te-90*Math.sign(ie)+360)%360;break;case q.None:re=te;break;default:throw new Error('Unknown maneuver type "'+this.maneuverType)}void 0===this.thrustFacing&&(this.thrustFacing=re),Z=5<this.currentHorizSpeed?S.rules.rot:Number.POSITIVE_INFINITY;var{facing:Y,delta:Z}=N.FacingUtil.tick(this.thrustFacing,re,Z);this.thrustFacing=Y,this.currentMoveDir.copy(N.FacingUtil.toMapCoords(this.thrustFacing));let se=!1,ne=0,ae=0,oe=!0;X!==Q&&(ce=Math.abs(X-Q),ne=Math.sign(X-Q)*Math.min(30,ce),oe=ce<=30);let le=S.rules.speed;W<=B.Coords.LEPTONS_PER_TILE&&this.maneuverType!==q.CircleStrafe&&(le=K.lerp(1,le/2,$.GameMath.sqrt(W/B.Coords.LEPTONS_PER_TILE))),this.deceleratingToTurn?this.currentHorizSpeed=Math.max(0,this.currentHorizSpeed-2):this.currentHorizSpeed=Math.min(this.currentHorizSpeed+2,le);var ce=this.currentHorizSpeed;let he;this.deceleratingToTurn=!1,se=Z?(Z=ce||Z?j.TargetUtil.computeTurnCircle(H,this.currentMoveDir,Math.sign(Z)*S.rules.rot,ce):void 0,0!==ce&&!L.circleContainsPoint(Z,_)||(this.maneuverType===q.HoverStrafe||W>B.Coords.LEPTONS_PER_TILE?this.deceleratingToTurn=!0:this.maneuverType===q.None&&(this.maneuverType=q.HoverStrafe)),ae=ce,!1):(ae=Math.min(ce,W),W<=ce),he=W<1?(se=!0,V):se?V:this.currentMoveDir.clone().setLength(ae);let ue=new z.Vector3(he.x,ne,he.y);return W=ue.clone(),S.moveTrait.velocity.copy(W),{distance:ue,done:se&&oe}}computeCancelDest(S,O){var N=O.clone().multiplyScalar(1/B.Coords.LEPTONS_PER_TILE).floor().multiplyScalar(B.Coords.LEPTONS_PER_TILE);return N=O.clone().sub(N),new W.Vector2(S.rx,S.ry).multiplyScalar(B.Coords.LEPTONS_PER_TILE).add(N)}})}}}),System.register("game/gameobject/selection/SelectionLevel",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("SelectionLevel",B={}))[O.None=0]="None",O[O.Hover=1]="Hover",O[O.Selected=2]="Selected",O[O.SelectedHover=3]="SelectedHover"}}}),System.register("game/gameobject/selection/SelectionList",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/gameobject/selection/SelectionModel",["game/gameobject/selection/SelectionLevel"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("SelectionModel",class{constructor(S){this.selectionLevel=B.SelectionLevel.None,S.isBuilding()&&S.rules.wall?this.maxSelectionLevel=B.SelectionLevel.None:this.maxSelectionLevel=S.rules.selectable?B.SelectionLevel.Selected|B.SelectionLevel.Hover:B.SelectionLevel.Hover}getSelectionLevel(){return this.selectionLevel}setSelectionLevel(S){this.selectionLevel=Math.min(this.maxSelectionLevel,S)}setHover(S){this.setSelectionLevel(S?this.selectionLevel|B.SelectionLevel.Hover:this.selectionLevel&~B.SelectionLevel.Hover)}setSelected(S){this.setSelectionLevel(S?this.selectionLevel|B.SelectionLevel.Selected:this.selectionLevel&~B.SelectionLevel.Selected)}isHovered(){return this.selectionLevel>>B.SelectionLevel.Hover&1}isSelected(){return this.selectionLevel>=B.SelectionLevel.Selected}getControlGroupNumber(){return this.controlGroupNumber}setControlGroupNumber(S){this.controlGroupNumber=S}})}}}),System.register("game/gameobject/selection/UnitSelection",["game/gameobject/selection/SelectionModel","util/math"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("UnitSelection",class{constructor(){this.selectedUnits=new Set,this.selectionModelsByUnit=new Map,this.groups=new Map,this.hashNeedsUpdate=!0}getOrCreateSelectionModel(S){let O=this.selectionModelsByUnit.get(S);return O||(O=new B.SelectionModel(S),this.selectionModelsByUnit.set(S,O)),O}deselectAll(){this.selectedUnits.forEach(S=>this.selectionModelsByUnit.get(S)?.setSelected(!1)),this.selectedUnits.clear(),this.hashNeedsUpdate=!0}addToSelection(S){this.selectedUnits.add(S),this.getOrCreateSelectionModel(S).setSelected(!0),this.hashNeedsUpdate=!0}removeFromSelection(S){S.forEach(S=>{this.selectedUnits.delete(S),this.getOrCreateSelectionModel(S).setSelected(!1)}),this.hashNeedsUpdate=!0}getSelectedUnits(){return[...this.selectedUnits].filter(S=>!S.isDestroyed&&!S.isCrashing&&!S.isDisposed&&S.isSpawned)}isSelected(S){return this.selectedUnits.has(S)}cleanupUnit(S){this.selectionModelsByUnit.delete(S),this.selectedUnits.delete(S),this.removeUnitsFromGroup([S]),this.hashNeedsUpdate=!0}updateHash(){this.hash=N.fnv32a([...this.selectedUnits].map(S=>S.id))}getHash(){return this.hashNeedsUpdate&&(this.updateHash(),this.hashNeedsUpdate=!1),this.hash}createGroup(S){this.addUnitsToGroup(S,this.getSelectedUnits())}addUnitsToGroup(S,O,B=!0){this.removeUnitsFromGroup(O);let N=this.groups.get(S);for(var j of(N||(N=new Set,this.groups.set(S,N)),B&&([...N.values()].forEach(S=>this.selectionModelsByUnit.get(S)?.setControlGroupNumber(void 0)),N.clear()),O))N.add(j),this.getOrCreateSelectionModel(j).setControlGroupNumber(S)}addGroupToSelection(S){if(this.groups.has(S))for(var O of[...this.groups.get(S)])this.addToSelection(O)}selectGroup(S){this.deselectAll(),this.addGroupToSelection(S)}getGroupUnits(S){return[...this.groups.get(S)??[]]}removeUnitsFromGroup(S){for(var O of this.groups.values())for(var B of S)O.delete(B),this.selectionModelsByUnit.get(B)?.setControlGroupNumber(void 0)}})}}}),System.register("game/gameobject/selection/UnitSelectionLite",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("UnitSelectionLite",class{constructor(S){this.player=S,this.selectedUnits=new Set}update(S){var O,B=[...S].reverse().find(S=>S.owner!==this.player);for(O of(B&&(S=[B]),this.selectedUnits.clear(),S))O.rules.selectable&&this.selectedUnits.add(O)}getSelectedUnits(){return[...this.selectedUnits].filter(S=>!S.isDestroyed&&!S.isCrashing)}isSelected(S){return this.selectedUnits.has(S)}})}}}),System.register("game/gameobject/task/AttackTask",["game/gameobject/task/system/Task","game/gameobject/unit/RangeHelper","game/gameobject/task/system/WaitMinutesTask","game/WeaponType","game/gameobject/task/move/MoveInWeaponRangeTask","game/gameobject/unit/FacingUtil","game/gameobject/task/TurnTask","game/gameobject/task/system/WaitTicksTask","game/gameobject/trait/AttackTrait","game/gameobject/GameObject","game/gameobject/unit/LosHelper","game/gameobject/trait/MoveTrait","game/GameSpeed","game/Coords","engine/type/ObjectType","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/MovePositionHelper","game/gameobject/unit/ZoneType","game/type/MovementZone","game/gameobject/task/system/TaskStatus","game/gameobject/task/move/MoveTask","game/math/Vector3","game/math/Vector2"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S}],execute:function(){re=class e extends B.Task{constructor(S,O,B,j={}){super(),this.game=S,this.target=O,this.weapon=B,this.options=j,this.moveExecuted=!1,this.moveAttempts=0,this.rangeCheckCooldown=0,this.lastInRangeTargetPosition=new te.Vector3,this.lastInRangeSelfPosition=new te.Vector3,this.initialIndirectTarget=!1,this.forceDropTarget=!1,this.rangeHelper=new N.RangeHelper(S.map.tileOccupation),this.losHelper=new W.LosHelper(S.map.tiles,S.map.tileOccupation),this.targetLinesConfig={pathNodes:[]},this.updateTargetLines(this.target,!0)}duplicate(){return new e(this.game,this.target,this.weapon,this.options)}getWeapon(){return this.weapon}setWeapon(S){this.weapon=S}setForceAttack(S){this.options.force=S}requestTargetUpdate(S){this.target.equals(S)||(this.needsTargetUpdate=S)}onTargetChange(S){let O=S.attackTrait,B=this.target;O.currentTarget=B,this.lastValidTargetPosition=B.obj?{tile:B.tile,onBridge:B.getBridge()}:void 0,this.initialTargetOwner=B.obj?.isTechno()?B.obj.owner:void 0,this.initialIndirectTarget=!B.obj&&this.game.map.tileOccupation.getObjectsOnTile(B.tile).some(S=>S.isOverlay()&&!S.isBridgePlaceholder()||S.isTerrain()),this.updateTargetLines(B,!0)}updateTargetLines(S,O){this.targetLinesConfig.target=S.obj,this.targetLinesConfig.pathNodes=S.obj?[]:[{tile:S.tile,onBridge:S.getBridge()}],this.targetLinesConfig.isAttack=O}onStart(S){if(!S.attackTrait)throw new Error(`Object ${S.name} has no attack trait`);if(0!==S.ammo){let N=this.game.map.tileOccupation;var O,B;S.attackTrait.attackState=H.AttackState.CheckRange,this.onTargetChange(S),this.initialSelfPosition={tile:S.tile,onBridge:S.isUnit()&&S.onBridge?N.getBridgeOnTile(S.tile):void 0},this.weapon.rules.limboLaunch&&S.isUnit()&&!this.target.obj&&(this.forceDropTarget=!0,({reachable:O,fallback:B}=this.findReachableMeleePosition(this.target.tile,!!this.target.getBridge(),{width:1,height:1},S)),!O&&B&&(this.lastValidTargetPosition=B,this.updateTargetLines(this.game.createTarget(B.onBridge,B.tile),!1))),this.weapon.rules.limboLaunch&&this.target.obj?.isTechno()&&S.isUnit()&&!this.rangeHelper.isInWeaponRange(S,this.target.obj,this.weapon,this.game.rules)&&(({reachable:O,fallback:B}=this.findReachableMeleePosition(this.target.obj.tile,this.target.obj.isUnit()&&this.target.obj.onBridge,this.target.obj.getFoundation(),S)),O||(1<(S.unitOrderTrait.waypointPath?.waypoints?.length??0)?this.cancel():(this.forceDropTarget=!0,B&&(this.lastValidTargetPosition=B,this.updateTargetLines(this.game.createTarget(B.onBridge,B.tile),!1))))),this.rangeHelper.isInWeaponRange(S,this.target.obj??this.target.tile,this.weapon,this.game.rules)&&S.isUnit()&&S.rules.movementZone===X.MovementZone.Fly&&S.zone!==Y.ZoneType.Air&&(S.rules.hoverAttack||S.isAircraft())&&this.children.push(new ee.MoveTask(this.game,S.tile,!1).setCancellable(!1))}else this.cancel()}findReachableMeleePosition(S,O,B,N){let j,L=this.game.map,D=L.tileOccupation,F=O?D.getBridgeOnTile(S):void 0,_=new Z.MovePositionHelper(L),U=N.rules.movementZone===X.MovementZone.Fly,h=(O,B)=>U||0<L.terrain.getPassableSpeed(O,N.rules.speedType,N.isInfantry(),!!B)&&_.isEligibleTile(O,B,F,S)&&!L.terrain.findObstacles({tile:O,onBridge:B},N).length,H=new Q.RadialTileFinder(L.tiles,L.mapBounds,S,B,1,Math.ceil(this.weapon.rules.range),O=>{let B=!1;var L;return h(O,void 0)&&(j=j??{tile:O,onBridge:void 0},B=!0),void 0!==O.onBridgeLandType&&(L=D.getBridgeOnTile(O),h(O,L)&&(j=j??{tile:O,onBridge:L},B=!0)),!!B&&this.rangeHelper.isInWeaponRange(N,S,this.weapon,this.game.rules,O)});return{reachable:H.getNextTile(),fallback:j}}onEnd(S){S.isVehicle()&&S.turretTrait&&(S.turretTrait.desiredFacing=S.direction),S.attackTrait.attackState=H.AttackState.Idle,S.attackTrait.currentTarget=void 0;var O=this.game.rules.general.prism.type;S.isBuilding()&&S.name===O&&this.weapon.type!==L.WeaponType.Secondary&&this.countSupportBeamsAndFireDownTowers(S,O),this.weapon.rules.limboLaunch&&S.attackTrait.expirePassiveScanCooldown(),(S.isInfantry()||S.isVehicle())&&(S.isFiring=!1),this.weapon.hasBurstsLeft()&&this.weapon.resetBursts()}forceCancel(S){if(S.rules.movementZone!==X.MovementZone.Fly)return!1;if(!this.cancellable||this.children.some(S=>!S.cancellable))return!1;if(this.status===J.TaskStatus.Running||this.status===J.TaskStatus.Cancelling){if(this.children.filter(S=>S instanceof ee.MoveTask).some(O=>!O.forceCancel(S)))return!1;this.onEnd(S),(S.isInfantry()||S.isVehicle())&&(S.isFiring=!1)}return this.status=J.TaskStatus.Cancelled,!0}onTick(S){let O=S.attackTrait;(S.isInfantry()||S.isVehicle())&&O.attackState!==H.AttackState.Firing&&(S.isFiring=!1);let B=this.target.obj,N=this.children.find(S=>S instanceof D.MoveInWeaponRangeTask);if(this.isCancelling()&&O.attackState!==H.AttackState.FireUp)return!S.airSpawnTrait?.isLaunchingMissiles()&&(N?.cancel(),!0);let W=!1;if(O.attackState===H.AttackState.FireUp){if(O.isDisabled())return!0;O.attackState=H.AttackState.Firing,W=!0}if(O.attackState===H.AttackState.Firing){if(this.initialIndirectTarget&&!this.game.map.getObjectsOnTile(this.target.tile).find(S=>S.isOverlay()&&!S.isBridgePlaceholder()||S.isTerrain()))return this.cancel(),this.onTick(S);if(W){var q=this.target.obj||this.target.tile;if(!this.game.isValidTarget(this.target.obj)||this.shouldDropTarget(this.target.obj)||!this.weapon.targeting.canTarget(this.target.obj,this.target.tile,this.game,!!this.options.force,!!this.options.passive)||!this.rangeHelper.isInWeaponRange(S,q,this.weapon,this.game.rules)||!this.losHelper.hasLineOfSight(S,q,this.weapon))return O.attackState=H.AttackState.CheckRange,this.onTick(S)}if(this.weapon.rules.limboLaunch){if((B?.isVehicle()||B?.isAircraft())&&B.parasiteableTrait?.isInfested())return!0;if(S.rules.movementZone!==X.MovementZone.Fly&&B?.isUnit()&&B.zone===Y.ZoneType.Air)return!0}if(this.target.tile.onBridgeLandType&&S.tile.onBridgeLandType&&S.isUnit()&&(this.game.map.tileOccupation.getBridgeOnTile(this.target.tile)?.isHighBridge()||this.game.map.tileOccupation.getBridgeOnTile(S.tile)?.isHighBridge())&&(B?B.isUnit()&&(B.zone===Y.ZoneType.Air||B.onBridge):this.target.isBridge())!==(S.zone===Y.ZoneType.Air||S.onBridge))return!0;let j=1;if(q=this.game.rules.general.prism.type,S.isBuilding()&&S.name===q&&this.weapon.type!==L.WeaponType.Secondary&&(j=1+(q=this.countSupportBeamsAndFireDownTowers(S,q))*this.game.rules.general.prism.supportModifier),this.weapon.rules.spawner&&(S.isVehicle()||S.isAircraft())&&S.parasiteableTrait?.isParalyzed())return!0;if(0===S.ammo)return S.isAircraft()&&(S.rules.fighter||S.rules.spawned)&&N?.cancel(),!0;let D=!1;if(this.weapon.rules.limboLaunch){let O=N;if(!O){let B=S.unitOrderTrait.getCurrentTask();if(B&&B!==this){if(!(B instanceof ee.MoveTask))return B.cancel(),!1;O=B}}if(O){if(!O.forceCancel(S))return!1;S.moveTrait.lastTargetOffset=void 0,S.moveTrait.lastVelocity=void 0}D=!0}return this.weapon.fire(this.target,this.game,j),!(!D&&!this.weapon.rules.fireOnce&&(!this.options.passive||!S.rules.distributedFire)&&(O.attackState=H.AttackState.JustFired,1))}if(O.attackState===H.AttackState.JustFired)return O.attackState=H.AttackState.PrepareToFire,this.onTick(S);this.needsTargetUpdate&&(this.target=this.needsTargetUpdate,B=this.target.obj,this.needsTargetUpdate=void 0,this.onTargetChange(S),B||N?.retarget(this.target.tile,!!this.target.getBridge())),B?.isTechno()&&B.replacedBy&&(Z=this.game.createTarget(B.replacedBy,B.replacedBy.tile),this.target=Z,B=B.replacedBy,this.onTargetChange(S));let Q=this.game.isValidTarget(B)&&!this.shouldDropTarget(B);if(Q){let N=this.weapon.targeting.canTarget(B,this.target.tile,this.game,!!this.options.force,!!this.options.passive);if(!N||!S.armedTrait.isEquippedWithWeapon(this.weapon)){var Z=O.selectWeaponVersus(S,this.target,this.game,this.options.force,this.options.passive);if(Z){if(this.setWeapon(Z),O.attackState!==H.AttackState.CheckRange)return O.attackState=H.AttackState.CheckRange,this.onTick(S);N=!0}else N=!1}Q=N}if(Q&&(J=this.lastTargetTpCheck,B?.isUnit()&&J&&B.moveTrait.lastTeleportTick>=J?(Q=!1,this.rangeCheckCooldown=0):this.lastTargetTpCheck=this.game.currentTick),Q&&B&&(this.lastValidTargetPosition={tile:B.tile,onBridge:this.target.getBridge()}),Q||(this.targetLinesConfig.isAttack=!1),O.attackState===H.AttackState.CheckRange){if(0<this.rangeCheckCooldown)return this.rangeCheckCooldown--,!1;let L=this.target.obj?Q?this.target.obj:this.lastValidTargetPosition.tile:this.target.tile;var J=this.target.obj?Q?this.target.obj.isBuilding()?this.target.obj.centerTile:this.target.obj.tile:this.lastValidTargetPosition.tile:this.target.tile;if(!this.rangeHelper.isInWeaponRange(S,L,this.weapon,this.game.rules)||!this.losHelper.hasLineOfSight(S,L,this.weapon)||S.isUnit()&&S.rules.balloonHover&&!S.rules.hoverAttack&&!N&&S.tile!==J&&!this.options.holdGround||S.isAircraft()&&this.weapon.projectileRules.iniRot<=1&&!N){if(S.isUnit()&&!this.options.holdGround&&this.game.map.isWithinBounds(J)){if(N){if(N.target!==this.target.obj||Q)if(Q&&this.target.obj&&this.rangeHelper.tileDistance(this.target.obj,this.lastSelfMoveTargetTile)>this.weapon.range)N.retarget(this.target.obj,!!this.target.getBridge()),this.lastSelfTileBeforeMove=S.tile,this.lastSelfMoveTargetTile=this.target.obj?.tile??this.target.tile;else{if(void 0!==this.options.leashTiles&&this.rangeHelper.tileDistance(this.initialSelfPosition.tile,S.tile)>this.options.leashTiles)return N.cancel(),!0;var re=L instanceof V.GameObject&&L.isUnit()?L.moveTrait.baseSpeed:0,se=Math.ceil((this.rangeHelper.tileDistance(S,L)-(this.weapon.range+1))/((S.moveTrait.baseSpeed+re)/$.Coords.LEPTONS_PER_TILE));0<se&&(this.rangeCheckCooldown=Math.min(K.GameSpeed.BASE_TICKS_PER_SECOND,se))}else{let S;S=void 0!==this.options.leashTiles?this.game.createTarget(this.initialSelfPosition.onBridge,this.initialSelfPosition.tile):this.game.createTarget(this.lastValidTargetPosition.onBridge,this.lastValidTargetPosition.tile),O.currentTarget=S,N.retarget(S.tile,S.isBridge()),this.updateTargetLines(S,!1)}return!1}return!(S.moveTrait&&!S.moveTrait.isDisabled())||!!this.isCancelling()||(S.tile===this.lastSelfTileBeforeMove||this.moveExecuted&&S.moveTrait.lastMoveResult===z.MoveResult.Fail?this.moveAttempts++:this.moveAttempts=0,!!(this.weapon.rules.limboLaunch&&S.defaultToGuardArea&&B&&this.moveExecuted&&S.moveTrait.lastMoveResult===z.MoveResult.Fail&&this.rangeHelper.isInRange(S,B,0,S.armedTrait.computeGuardScanRange(this.weapon),!0))||this.moveAttempts>3||(0<this.moveAttempts&&this.children.push(new j.WaitMinutesTask(1/60)),re=L,se=B&&!Q?this.lastValidTargetPosition.onBridge:this.target.getBridge(),N=new D.MoveInWeaponRangeTask(this.game,re,!!se,this.weapon),N.blocking=!1,this.children.push(N),this.moveExecuted=!0,this.lastSelfTileBeforeMove=S.tile,this.lastSelfMoveTargetTile=re instanceof V.GameObject?re.tile:re,this.onTick(S)))}return!0}if(this.moveExecuted=!1,this.moveAttempts=0,N&&(S.rules.balloonHover&&!S.rules.hoverAttack||S.rules.fighter||S.rules.spawned||S.rules.movementZone===X.MovementZone.Fly&&!this.rangeHelper.isInRange2(S,this.target.obj??this.target.tile,this.weapon.minRange,this.weapon.range-1)||N.cancel()),N&&(S.isInfantry()||this.weapon.rules.spawner))return!1;if(N?.children.some(S=>!S.cancellable)&&this.weapon.rules.limboLaunch)return!1;if(N&&N.shouldAirStrafe(S)&&this.target.obj?.isUnit()&&this.target.obj.moveTrait.isMoving()&&1<this.weapon.range&&!this.rangeHelper.isInRange2(S,this.target.obj,this.weapon.minRange,this.weapon.range-1))return!1;O.attackState=H.AttackState.PrepareToFire}if(O.attackState!==H.AttackState.PrepareToFire)return!1;if(!Q||O.isDisabled())return N?.cancel(),!0;if(se=this.target.getWorldCoords(),re=S.position.worldPosition,!(this.lastInRangeTargetPosition.length()&&this.lastInRangeTargetPosition.equals(se)&&this.lastInRangeSelfPosition.length()&&this.lastInRangeSelfPosition.equals(re)))return this.lastInRangeTargetPosition.copy(se),this.lastInRangeSelfPosition.copy(re),O.attackState=H.AttackState.CheckRange,this.onTick(S);if(!(this.weapon.rules.omniFire||S.rules.omniFire&&S.rules.fighter)){re=(new te.Vector3).copy(se).sub(re);var ne=F.FacingUtil.fromMapCoords(new ie.Vector2(re.x,re.z));if(re=this.weapon.projectileRules.rot?45:11.25,(S.isVehicle()||S.isBuilding())&&S.turretTrait){if(S.turretTrait.desiredFacing=ne,Math.abs(ne-S.turretTrait.facing)>=re)return!1}else if(Math.abs(ne-S.direction)>=re){if(S.isAircraft())return S.direction=F.FacingUtil.tick(S.direction,ne,S.rules.rot).facing,!1;if(N)return!1;if(this.options.disallowTurning)return!0;if(S.isVehicle())return this.children.push(new _.TurnTask(ne)),!1;S.direction=ne}}return this.losHelper.hasLineOfSight(S,this.target.obj||this.target.tile,this.weapon)?!O.isOnCooldown(S)&&(!this.weapon.warhead.rules.temporal||S.temporalTrait.getTarget()!==this.target.obj)&&(this.weapon.rules.suicide&&this.weapon.type!==L.WeaponType.DeathWeapon?(this.game.destroyObject(S,{player:S.owner,obj:S,weapon:this.weapon}),!0):(ne=this.game.rules.general.prism.type,S.isBuilding()&&S.name===ne&&this.weapon.type!==L.WeaponType.Secondary&&this.fireUpPrismSupportTowers(S,ne),(S.isInfantry()||S.isVehicle())&&(S.isFiring=!0),S.art.fireUp?(this.children.push(new U.WaitTicksTask(S.art.fireUp).setCancellable(!1)),O.attackState=H.AttackState.FireUp,!1):(O.attackState=H.AttackState.Firing,this.onTick(S)))):(O.attackState=H.AttackState.CheckRange,this.onTick(S))}shouldDropTarget(S){return this.forceDropTarget||S?.isTechno()&&(this.weapon.rules.limboLaunch&&((S.isVehicle()||S.isAircraft())&&S.parasiteableTrait?.isInfested()||S.invulnerableTrait.isActive())||S.warpedOutTrait.isInvulnerable()&&!this.weapon.warhead.rules.temporal||this.initialTargetOwner!==S.owner)}fireUpPrismSupportTowers(S,O){var B;for(B of S.owner.getOwnedObjectsByType(q.ObjectType.Building).filter(S=>S.name===O&&S.secondaryWeapon&&!S.unitOrderTrait.hasTasks()&&S.attackTrait&&!S.attackTrait.isDisabled()&&!S.attackTrait.isOnCooldown(S)).filter(O=>this.rangeHelper.isInWeaponRange(O,S,O.secondaryWeapon,this.game.rules)).slice(0,this.game.rules.general.prism.supportMax))B.unitOrderTrait.addTask(B.attackTrait.createAttackTask(this.game,S,S.centerTile,B.secondaryWeapon,{passive:!0}))}countSupportBeamsAndFireDownTowers(S,O){var B,N=S.owner.getOwnedObjectsByType(q.ObjectType.Building).filter(B=>B.name===O&&B.attackTrait?.currentTarget?.obj===S);for(B of N)B.unitOrderTrait.getCurrentTask()?.cancel();return Math.min(this.game.rules.general.prism.supportMax,N.length)}getTargetLinesConfig(){return this.targetLinesConfig}},S("AttackTask",re)}}}),System.register("game/gameobject/task/CaptureBuildingTask",["game/gameobject/Building","game/event/BuildingCaptureEvent","game/Warhead","game/gameobject/unit/CollisionType","game/gameobject/unit/ZoneType","game/gameobject/task/EnterBuildingTask","game/SpecialWarheadType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){U=class extends F.EnterBuildingTask{isAllowed(S){return S.rules.engineer&&this.target.rules.capturable&&!this.target.isDestroyed&&this.target.buildStatus!==B.BuildStatus.BuildDown&&!this.game.areFriendly(S,this.target)}onEnter(S){if(this.game.unspawnObject(S),this.game.gameOpts.multiEngineer){var O=this.game.rules.general;if((!this.target.rules.needsEngineer||!O.engineerAlwaysCaptureTech)&&this.target.healthTrait.health>100*O.engineerCaptureLevel){var B=Math.floor(O.engineerDamage*this.target.healthTrait.maxHitPoints);if(O=Math.floor((1-Math.floor(1/O.engineerDamage)*O.engineerDamage)*this.target.healthTrait.maxHitPoints),0<(B=Math.min(B,this.target.healthTrait.getHitPoints()-O)))return O=this.game.rules.combatDamage.c4Warhead,void new j.Warhead(this.game.rules.getWarhead(O)).detonate(this.game,B,this.target.tile,0,this.target.position.worldPosition,D.ZoneType.Ground,L.CollisionType.None,this.game.createTarget(this.target,this.target.tile),{player:S.owner,obj:S,weapon:void 0},_.SpecialWarheadType.None,void 0,0)}}S.owner.buildingsCaptured++,this.game.changeObjectOwner(this.target,S.owner),this.game.events.dispatch(new N.BuildingCaptureEvent(this.target))}},S("CaptureBuildingTask",U)}}}),System.register("game/gameobject/task/CheerTask",["game/gameobject/task/system/Task","game/art/SequenceType","game/gameobject/infantry/StanceType","game/gameobject/task/system/WaitMinutesTask"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends B.Task{constructor(){super(),this.executed=!1,this.cancellable=!1}onTick(S){return this.executed?(S.stance=j.StanceType.None,!0):!S.isInfantry()||!S.art.sequences.has(N.SequenceType.Cheer)||S.stance!==j.StanceType.None&&S.stance!==j.StanceType.Guard||(S.stance=j.StanceType.Cheer,this.children.push(new L.WaitMinutesTask(1/60).setCancellable(!1)),!(this.executed=!0))}},S("CheerTask",D)}}}),System.register("game/gameobject/task/EnterBuildingTask",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/event/EnterObjectEvent"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends B.Task{constructor(S,O){super(),this.game=S,this.target=O,this.aborted=!1,this.movePerformed=!1,this.preventOpportunityFire=!1}onTick(S){return!(!(this.isCancelling()&&!this.movePerformed||this.aborted||S.moveTrait.isDisabled())&&(this.movePerformed&&this.children.length?(S.tile===this.lastOutsideTile||this.game.map.tileOccupation.isTileOccupiedBy(S.tile,this.target)||(this.lastOutsideTile=S.tile),1):this.game.map.tileOccupation.isTileOccupiedBy(S.tile,this.target)?!this.isAllowed(S)||this.isCancelling()?(this.children.push(new N.MoveOutsideTask(this.game,this.target,this.lastOutsideTile)),this.aborted=!0):(this.game.events.dispatch(new L.EnterObjectEvent(this.target,S)),!1===this.onEnter(S)&&(this.children.push(new N.MoveOutsideTask(this.game,this.target,this.lastOutsideTile)),this.aborted=!0)):!this.movePerformed&&(this.children.push(new j.MoveInsideTask(this.game,this.target).setBlocking(!1)),this.movePerformed=!0,this.preventOpportunityFire=!0)))}getTargetLinesConfig(S){return{target:this.target,pathNodes:[]}}},S("EnterBuildingTask",D)}}}),System.register("game/gameobject/task/EnterHospitalTask",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/type/MovementZone","game/gameobject/unit/MovePositionHelper","game/map/tileFinder/RadialTileFinder","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/event/EnterObjectEvent"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){var O;(O=W=W||{})[O.MoveToQueueingTile=0]="MoveToQueueingTile",O[O.WaitForTurn=1]="WaitForTurn",O[O.MoveToTarget=2]="MoveToTarget",O[O.EnterTarget=3]="EnterTarget",O[O.ClearTarget=4]="ClearTarget",z=class extends B.Task{constructor(S,O){super(),this.game=S,this.target=O,this.movePerformed=!1}isAllowed(S){return S.rules.movementZone!==L.MovementZone.Fly&&S.healthTrait.health<100&&this.target.hospitalTrait&&!this.target.isDestroyed&&!this.target.warpedOutTrait.isActive()&&this.game.areFriendly(S,this.target)&&(!this.target.ammoTrait||0<this.target.ammoTrait.ammo)}onStart(S){if(!this.target.hospitalTrait)throw new Error(`Target ${this.target.name} is not a valid hospital`);0<this.target.hospitalTrait.addToHealQueue(S)?this.state=W.MoveToQueueingTile:this.state=W.MoveToTarget}onEnd(S){!this.target.isDestroyed&&S.isSpawned&&this.target.hospitalTrait.removeFromHealQueue(S)}onTick(S){if(this.isCancelling()&&this.state!==W.EnterTarget||this.state===W.ClearTarget||S.moveTrait.isDisabled())return!0;if(this.state===W.MoveToQueueingTile){let B=new D.MovePositionHelper(this.game.map);var O=new F.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,O=>0<this.game.map.terrain.getPassableSpeed(O,S.rules.speedType,S.isInfantry(),!1)&&B.isEligibleTile(O,void 0,void 0,this.target.tile)).getNextTile();return!O||(this.children.push(new _.MoveTask(this.game,O,!1,{closeEnoughTiles:5})),this.children.push(new U.CallbackTask(()=>{[H.MoveResult.Success,H.MoveResult.CloseEnough].includes(S.moveTrait.lastMoveResult)||this.cancel()})),this.state=W.WaitForTurn,this.queueingTile=O,!1)}if(this.state===W.WaitForTurn){if(!this.target.hospitalTrait.unitIsFirstInHealQueue(S))return!1;this.queueingTile=void 0,this.state=W.MoveToTarget}if(this.state===W.MoveToTarget){if(this.movePerformed&&this.children.length)return S.tile===this.lastOutsideTile||this.game.map.tileOccupation.isTileOccupiedBy(S.tile,this.target)||(this.lastOutsideTile=S.tile),!1;if(!this.isAllowed(S))return!0;if(!this.game.map.tileOccupation.isTileOccupiedBy(S.tile,this.target))return!(!this.movePerformed&&(this.children.push(new j.MoveInsideTask(this.game,this.target).setBlocking(!1)),this.movePerformed=!0));this.state=W.EnterTarget}return this.state===W.EnterTarget&&(!this.isAllowed(S)||this.isCancelling()?(this.children.push(new N.MoveOutsideTask(this.game,this.target,this.lastOutsideTile)),this.state=W.ClearTarget,!1):(this.game.limboObject(S,{selected:!1,controlGroup:this.game.getUnitSelection().getOrCreateSelectionModel(S).getControlGroupNumber()}),this.target.hospitalTrait.startHealing(S),this.game.events.dispatch(new V.EnterObjectEvent(this.target,S)),!0))}getTargetLinesConfig(S){return{target:this.queueingTile?void 0:this.target,pathNodes:this.queueingTile?[{tile:this.queueingTile,onBridge:void 0}]:[]}}},S("EnterHospitalTask",z)}}}),System.register("game/gameobject/task/EnterRecyclerTask",["game/gameobject/Building","game/type/LocomotorType","game/type/MovementZone","game/event/UnitRecycleEvent","game/gameobject/task/EnterBuildingTask"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends D.EnterBuildingTask{isAllowed(S){return S.rules.movementZone!==j.MovementZone.Fly&&S.rules.locomotor!==N.LocomotorType.Chrono&&!S.rules.engineer&&0<this.game.sellTrait.computeRefundValue(S)&&(S.isInfantry()&&this.target.rules.cloning||this.target.rules.grinding)&&!this.target.isDestroyed&&this.target.buildStatus===B.BuildStatus.Ready&&S.owner===this.target.owner}onEnter(S){this.game.sellTrait.sell(S),this.game.events.dispatch(new L.UnitRecycleEvent(S))}},S("EnterRecyclerTask",F)}}}),System.register("game/gameobject/task/EnterTransportTask",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/event/EnterTransportEvent","game/gameobject/unit/ZoneType","game/gameobject/trait/MoveTrait","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/MovePositionHelper","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/event/EnterObjectEvent"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S}],execute:function(){var O;(O=z=z||{})[O.MoveToQueueingTile=0]="MoveToQueueingTile",O[O.WaitForTurn=1]="WaitForTurn",O[O.MoveToTransport=2]="MoveToTransport",O[O.EnterTransport=3]="EnterTransport",O[O.ClearTransport=4]="ClearTransport",K=class extends B.Task{constructor(S,O){super(),this.game=S,this.target=O,this.movePerformed=!1,this.preventOpportunityFire=!1}isAllowed(S){return!this.target.isDestroyed&&!this.target.isCrashing&&this.game.areFriendly(this.target,S)&&S.zone!==D.ZoneType.Air&&this.target.zone!==D.ZoneType.Air&&this.target.transportTrait.unitFitsInside(S)&&this.target.moveTrait.moveState===F.MoveState.Idle&&!this.target.warpedOutTrait.isActive()&&!S.mindControllableTrait?.isActive()&&!S.mindControllerTrait?.isActive()}onStart(S){if(!this.target.transportTrait)throw new Error(`Unit ${this.target.name} is not a valid transport`);this.initialTargetTile=this.target.tile,0<this.target.transportTrait.addToLoadQueue(S)?this.state=z.MoveToQueueingTile:this.state=z.MoveToTransport}onEnd(S){this.target.isDestroyed||this.target.transportTrait?.removeFromLoadQueue(S)}onTick(S){if(this.isCancelling()&&this.state!==z.EnterTransport||this.state===z.ClearTransport||S.moveTrait.isDisabled())return!0;if(this.target.tile!==this.initialTargetTile||this.target.moveTrait.moveState!==F.MoveState.Idle)return!0;if(this.state===z.MoveToQueueingTile){let B,N=new U.MovePositionHelper(this.game.map),j=this.target.onBridge?this.game.map.tileOccupation.getBridgeOnTile(this.target.tile):void 0;var O=new _.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,O=>{let L=[this.game.map.tileOccupation.getBridgeOnTile(O)];for(var D of(L[0]&&L.push(void 0),L))if(0<this.game.map.terrain.getPassableSpeed(O,S.rules.speedType,S.isInfantry(),!!D)&&N.isEligibleTile(O,D,j,this.target.tile))return B=D,!0;return!1}).getNextTile();return!O||(this.children.push(new H.MoveTask(this.game,O,!!B,{closeEnoughTiles:5})),this.children.push(new V.CallbackTask(()=>{[F.MoveResult.Success,F.MoveResult.CloseEnough].includes(S.moveTrait.lastMoveResult)||this.cancel()})),this.queueingNode={tile:O,onBridge:B},this.state=z.WaitForTurn,!1)}if(this.state===z.WaitForTurn){if(!this.target.transportTrait.unitIsFirstInLoadQueue(S))return!1;this.queueingNode=void 0,this.state=z.MoveToTransport}if(this.state===z.MoveToTransport){if(!this.isAllowed(S))return!0;if(!this.game.map.tileOccupation.isTileOccupiedBy(S.tile,this.target))return!(!this.movePerformed&&(this.children.push(new j.MoveInsideTask(this.game,this.target)),this.movePerformed=!0,this.preventOpportunityFire=!0));this.state=z.EnterTransport}return this.state===z.EnterTransport&&(!this.isAllowed(S)||this.isCancelling()?(this.children.push(new N.MoveOutsideTask(this.game,this.target)),this.state=z.ClearTransport,!1):(this.game.limboObject(S,{selected:!1,controlGroup:this.game.getUnitSelection().getOrCreateSelectionModel(S).getControlGroupNumber(),inTransport:!0}),this.game.events.dispatch(new L.EnterTransportEvent(this.target)),this.game.events.dispatch(new W.EnterObjectEvent(this.target,S)),this.target.transportTrait.units.push(S),!0))}getTargetLinesConfig(S){return{target:this.queueingNode?void 0:this.target,pathNodes:this.queueingNode?[this.queueingNode]:[]}}},S("EnterTransportTask",K)}}}),System.register("game/gameobject/task/EvacuateTransportTask",["game/event/LeaveTransportEvent","game/gameobject/unit/FacingUtil","game/gameobject/unit/MovePositionHelper","game/gameobject/task/move/MoveTask","game/gameobject/task/ScatterTask","game/gameobject/task/system/Task","game/gameobject/task/TurnTask","game/gameobject/task/system/WaitMinutesTask","game/gameobject/unit/ZoneType","game/gameobject/task/system/CallbackTask"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){var O;(O=W=W||{})[O.None=0]="None",O[O.OnlyPassengers=1]="OnlyPassengers",O[O.All=2]="All",z=class extends F.Task{constructor(S,O){super(),this.game=S,this.soft=O,this.evacState=W.None,this.evacTries=0,this.turnPerformed=!1,this.preventLanding=!1}forceEvac(){this.evacState=W.All}onStart(S){if(!S.transportTrait)throw new Error(`Object "${S.name}" is not a valid transport`);var O=S.transportTrait;0<O.units.length&&(this.evacState=this.evacState!==W.OnlyPassengers&&1!==O.units.length||!S.rules.gunner?W.OnlyPassengers:W.All)}onTick(S){if(this.isCancelling()||this.evacState===W.None)return!0;if(S.zone===H.ZoneType.Air)return this.children.push(new V.CallbackTask(()=>S.zone!==H.ZoneType.Air)),!1;let O=S.transportTrait.units;if(!O.length||S.rules.gunner&&1===O.length&&this.evacState!==W.All)return!0;var B=O[O.length-1],N=this.findValidEvacTarget(S,B);if(N&&!this.turnPerformed){this.turnPerformed=!0;var j=(N.dir+180)%360;if(S.direction!==j)return this.children.push(new _.TurnTask(j)),!1}return this.evacuateUnit(B,S,N)?(O.pop(),this.children.push(new U.WaitMinutesTask(1/60)),!1):!(++this.evacTries<=3&&(this.children.push(new U.WaitMinutesTask(.05)),1))}evacuateUnit(S,O,N){if(!N)return!this.soft&&(S.position.tile=O.tile,S.position.tileElevation=O.tileElevation,S.onBridge=O.onBridge,S.zone=O.zone,this.game.destroyObject(S,{player:S.owner}),!0);var{spawnNode:j,moveNode:F}=N;return S.position.tileElevation=j.onBridge?.tileElevation??0,S.onBridge=!!j.onBridge,S.zone=this.game.map.getTileZone(j.tile,!j.onBridge),this.game.unlimboObject(S,j.tile),S.unitOrderTrait.unmarkNextQueuedOrder(),F?S.unitOrderTrait.addTask(new L.MoveTask(this.game,F.tile,!!F.onBridge)):S.unitOrderTrait.addTask(new D.ScatterTask(this.game)),this.game.events.dispatch(new B.LeaveTransportEvent(O)),!0}findValidEvacTarget(S,O){let B=this.game.map,L=new j.MovePositionHelper(B);var D,F,_,U,H,V=S.onBridge?B.tileOccupation.getBridgeOnTile(S.tile):void 0,W=(S.direction+180)%360;let z;for(let j=0;j<=180;j+=45)for(D of j&&j<180?[W+j,W-j]:[W]){var K=N.FacingUtil.toMapCoords(D);let j,W=S.tile,Y=V;for(let N=1;N<=2;N++){if(2===N){if(!j)break;W=j.tile,Y=j.onBridge}var $,q=S.tile.rx+Math.sign(K.x)*N,Q=S.tile.ry+Math.sign(K.y)*N,Z=B.tiles.getByMapCoords(q,Q);if(!Z||!B.mapBounds.isWithinBounds(Z))break;let V=[B.tileOccupation.getBridgeOnTile(Z)];for($ of(V[0]&&V.push(void 0),V))if(F=Z,_=$,U=Y,H=W,0<B.terrain.getPassableSpeed(F,O.rules.speedType,O.isInfantry(),!!_)&&L.isEligibleTile(F,_,U,H)&&!B.terrain.findObstacles({tile:F,onBridge:_},O).length){if(1!==N)return{spawnNode:j,moveNode:{tile:Z,onBridge:$},dir:D};j={tile:Z,onBridge:$},z={spawnNode:j,moveNode:void 0,dir:D}}}}if(z)return z}},S("EvacuateTransportTask",z)}}}),System.register("game/gameobject/task/GarrisonBuildingTask",["game/event/BuildingGarrisonEvent","game/gameobject/task/EnterBuildingTask"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.EnterBuildingTask{isAllowed(S){return!this.target.isDestroyed&&!!this.target.garrisonTrait?.canBeOccupied()&&this.target.garrisonTrait.units.length<this.target.garrisonTrait.maxOccupants&&!(this.target.garrisonTrait.units.length&&this.target.garrisonTrait.units[0].owner!==S.owner)&&!S.mindControllableTrait?.isActive()}onEnter(S){this.game.limboObject(S,{selected:!1,controlGroup:this.game.getUnitSelection().getOrCreateSelectionModel(S).getControlGroupNumber()});let O=this.target.garrisonTrait;O.units.length||(S.owner.buildingsCaptured++,this.game.changeObjectOwner(this.target,S.owner),this.game.events.dispatch(new B.BuildingGarrisonEvent(this.target))),O.units.push(S)}},S("GarrisonBuildingTask",j)}}}),System.register("game/gameobject/task/InfiltrateBuildingTask",["game/gameobject/Building","game/event/BuildingInfiltrationEvent","game/gameobject/task/EnterBuildingTask"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.EnterBuildingTask{isAllowed(S){return S.rules.infiltrate&&this.target.rules.spyable&&!this.target.isDestroyed&&this.target.buildStatus!==B.BuildStatus.BuildDown&&!this.game.areFriendly(S,this.target)}onEnter(S){this.game.unspawnObject(S),S.agentTrait?.infiltrate(S,this.target,this.game),this.game.events.dispatch(new N.BuildingInfiltrationEvent(this.target,S))}},S("InfiltrateBuildingTask",L)}}}),System.register("game/gameobject/task/MoveToDockTask",["game/gameobject/task/system/Task","game/map/tileFinder/RadialTileFinder","game/gameobject/task/move/MoveTask","game/gameobject/task/system/WaitMinutesTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/type/MovementZone","game/gameobject/trait/interface/NotifyTick","game/Coords","game/math/Vector2"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){var O;(O=W=W||{})[O.Idle=0]="Idle",O[O.MoveToQueueingTile=1]="MoveToQueueingTile",O[O.WaitForTurn=2]="WaitForTurn",O[O.MoveToDock=3]="MoveToDock",O[O.Docking=4]="Docking",O[O.Docked=5]="Docked",z=class extends B.Task{constructor(S,O){super(),this.game=S,this.target=O,this.useChildTargetLines=!0,this.preventOpportunityFire=!1,this.dockingStatus=W.Idle}onStart(S){if(!this.target.dockTrait)throw new Error(`Target object "${this.target.name}" is not a valid dock`);var O;this.target.dockTrait.hasReservedDockForUnit(S)?this.dockingStatus=W.MoveToDock:void 0!==(O=this.target.dockTrait.getFirstAvailableDockNumber())?(this.target.dockTrait.reserveDockAt(S,O),this.dockingStatus=W.MoveToDock):this.target.helipadTrait?this.cancel():this.dockingStatus=W.MoveToQueueingTile}onEnd(S){this.dockingStatus!==W.Docked&&this.target.isSpawned&&(this.target.dockTrait.undockUnit(S),this.target.dockTrait.unreserveDockForUnit(S)),this.dockingStatus=W.Idle}onTick(S){if(this.isCancelling())return!0;if(!this.isValidTarget(this.target,S))return!0;if(this.dockingStatus===W.MoveToQueueingTile){var O=this.findReachableQueueingTile(S);if(!O)return!0;if(S.tile!==O)return this.children.push(new j.MoveTask(this.game,O,!1,{closeEnoughTiles:5}),new D.CallbackTask(()=>{S.moveTrait.lastMoveResult===F.MoveResult.Fail?this.cancel():S.moveTrait.lastMoveResult===F.MoveResult.CloseEnough&&(this.game.map.tileOccupation.isTileOccupiedBy(S.tile,this.target)||(this.dockingStatus=W.WaitForTurn))})),!1;this.dockingStatus=W.WaitForTurn}if(this.dockingStatus===W.WaitForTurn){if(void 0===(N=this.target.dockTrait.getFirstAvailableDockNumber()))return this.children.push(new L.WaitMinutesTask(1/60)),!1;this.target.dockTrait.reserveDockAt(S,N),this.dockingStatus=W.MoveToDock}if(this.dockingStatus===W.MoveToDock){var B=this.target.dockTrait.getReservedDockForUnit(S),N=this.target.dockTrait.getDockTile(B);if(B=H.Coords.vecWorldToGround(this.target.dockTrait.getDockOffset(B)).add(this.target.position.getMapPosition()).sub(new V.Vector2(N.rx,N.ry).multiplyScalar(H.Coords.LEPTONS_PER_TILE)),S.tile!==N)return this.children.push(new j.MoveTask(this.game,N,!1,{targetOffset:S.isAircraft()?B:void 0,closeEnoughTiles:0,strictCloseEnough:!0}),new D.CallbackTask(()=>{S.moveTrait.lastMoveResult===F.MoveResult.Fail&&this.cancel()})),this.game.afterTick(()=>S.unitOrderTrait[U.NotifyTick.onTick](S,this.game)),!1;this.dockingStatus=W.Docking}return this.dockingStatus===W.Docking&&(B=this.target.dockTrait.getReservedDockForUnit(S),this.target.dockTrait.unreserveDockForUnit(S),this.target.dockTrait.dockUnitAt(S,B),S.isAircraft()&&S.airportBoundTrait&&this.target.helipadTrait&&(S.airportBoundTrait.preferredAirport=this.target),this.dockingStatus=W.Docked,!0)}isValidTarget(S,O){return S.isSpawned&&this.game.areFriendly(S,O)}findReachableQueueingTile(S){var O=this.target.getFoundation();return O=new V.Vector2(this.target.tile.rx+O.width,this.target.tile.ry+O.height),(O=this.game.map.tiles.getByMapCoords(O.x,O.y))&&this.isValidQueueingTile(O,S)?O:new N.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,O=>this.isValidQueueingTile(O,S)).getNextTile()}isValidQueueingTile(S,O){var B=O.rules.movementZone===_.MovementZone.Fly,N=O.rules.speedType,j=O.isInfantry();let L=!B&&this.game.map.terrain.getPassableSpeed(O.tile,N,j,O.onBridge)?this.game.map.terrain.getIslandIdMap(N,j):void 0;return(B||L?.get(S,!1)===L?.get(O.tile,O.onBridge)&&Math.abs(S.z-this.target.tile.z)<2&&!S.onBridgeLandType&&!this.game.map.terrain.findObstacles({tile:S,onBridge:void 0},O).length)&&!this.game.map.tileOccupation.isTileOccupiedBy(S,this.target)}},S("MoveToDockTask",z)}}}),System.register("game/gameobject/task/ParadropTask",["game/Coords","game/math/Vector3","game/gameobject/infantry/InfDeathType","game/gameobject/infantry/StanceType","game/gameobject/task/system/Task"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends D.Task{constructor(S){super(),this.game=S}onTick(S){var O=Math.abs(this.game.rules.general.parachuteMaxFallRate),D=S.tile.onBridgeLandType?this.game.map.tileOccupation.getBridgeOnTile(S.tile).tileElevation:0,F=B.Coords.tileHeightToWorld(D),_=S.tileElevation,U=B.Coords.tileHeightToWorld(_);return F<Math.max(F,U-O)?(S.position.moveByLeptons3(new N.Vector3(0,-O,0)),S.moveTrait.handleElevationChange(_,this.game),!1):(S.position.tileElevation=D,S.stance=L.StanceType.None,this.game.map.terrain.getPassableSpeed(S.tile,S.rules.speedType,S.isInfantry(),S.onBridge)||(S.infDeathType=j.InfDeathType.None,this.game.destroyObject(S,void 0,!0)),!0)}},S("ParadropTask",F)}}}),System.register("game/gameobject/task/PlantC4Task",["game/GameSpeed","game/event/EnterObjectEvent","game/gameobject/task/EnterBuildingTask"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.EnterBuildingTask{isAllowed(S){return!this.target.isDestroyed&&!this.target.invulnerableTrait.isActive()}onEnter(S){var O=Math.floor(60*this.game.rules.combatDamage.c4Delay*B.GameSpeed.BASE_TICKS_PER_SECOND);return this.target.c4ChargeTrait.setCharge(O,{player:S.owner,obj:S}),this.game.events.dispatch(new N.EnterObjectEvent(this.target,S)),!1}getTargetLinesConfig(S){return{target:this.target,pathNodes:[],isAttack:!0}}},S("PlantC4Task",L)}}}),System.register("game/gameobject/task/RepairBuildingTask",["game/event/BuildingRepairFullEvent","game/event/BridgeRepairEvent","game/gameobject/task/EnterBuildingTask"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.EnterBuildingTask{isAllowed(S){return this.target.cabHutTrait?this.target.cabHutTrait.canRepairBridge():S.rules.engineer&&!this.target.isDestroyed&&this.target.rules.repairable&&this.target.healthTrait.health<100&&(!this.target.owner.isCombatant()&&!!this.target.garrisonTrait||this.game.areFriendly(S,this.target))}onEnter(S){this.game.unspawnObject(S),this.target.cabHutTrait?(this.target.cabHutTrait.repairBridge(this.game,S.owner),this.game.events.dispatch(new N.BridgeRepairEvent(S.owner,this.target.centerTile))):(this.target.healthTrait.healToFull(S,this.game),this.game.events.dispatch(new B.BuildingRepairFullEvent(this.target,S.owner)))}},S("RepairBuildingTask",L)}}}),System.register("game/gameobject/task/ScatterTask",["game/gameobject/task/move/MoveTask","game/gameobject/task/system/Task","game/gameobject/unit/ScatterPositionHelper","game/type/MovementZone"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends N.Task{constructor(S,O,B){super(),this.game=S,this.target=O,this.options=B}onStart(S){if(!S.moveTrait.isDisabled()&&S.rules.movementZone!==L.MovementZone.Fly){let N,L;if(this.target)({tile:N,toBridge:L}=this.target);else{var O=new j.ScatterPositionHelper(this.game).findPositions([S],this.options).get(S);if(!O)return;N=O.tile,L=!!O.onBridge}this.children.push(new B.MoveTask(this.game,N,L,{closeEnoughTiles:0,ignoredBlockers:this.options?.ignoredBlockers}))}}onTick(S){return!0}},S("ScatterTask",D)}}}),System.register("game/gameobject/task/TurnTask",["game/gameobject/task/system/Task","game/gameobject/unit/FacingUtil"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends B.Task{constructor(S){super(),this.direction=S,this.cancellable=!1}onTick(S){if(S.direction===this.direction)return!(S.spinVelocity=0);var O=S.rules.rot,{facing:B,delta:O}=N.FacingUtil.tick(S.direction,this.direction,O);return S.direction=B,S.spinVelocity=O,!1}},S("TurnTask",j)}}}),System.register("game/gameobject/task/WaitForBuildUpTask",["game/gameobject/Building","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/task/system/WaitMinutesTask"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends j.TaskGroup{constructor(S,O){super(new L.WaitMinutesTask(S),new N.CallbackTask(S=>S.setBuildStatus(B.BuildStatus.Ready,O))),this.cancellable=!1}},S("WaitForBuildUpTask",D)}}}),System.register("game/gameobject/task/harvester/GatherOreTask",["game/gameobject/task/system/Task","game/map/tileFinder/RadialTileFinder","game/gameobject/trait/HarvesterTrait","game/type/LandType","game/gameobject/task/move/MoveTask","game/gameobject/trait/TiberiumTrait","engine/type/TiberiumType","game/gameobject/task/system/WaitMinutesTask","game/gameobject/task/harvester/ReturnOreTask","game/gameobject/unit/RangeHelper","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/type/MovementZone"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S}],execute:function(){$=[[8,5,6],[3,0,2],[7,4,1]],q=class extends B.Task{constructor(S,O,B=!1){super(),this.game=S,this.initialTarget=O,this.explicitOrder=B,this.forceMoveTried=!1,this.useChildTargetLines=!0,this.preventOpportunityFire=!1,this.rangeHelper=new V.RangeHelper(S.map.tileOccupation),this.scanNearRadius=S.rules.ai.tiberiumNearScan,this.scanFarRadius=S.rules.ai.tiberiumFarScan}onStart(S){if(!S.isVehicle()||!S.harvesterTrait)throw new Error(`Unit ${S.name} is not a harvester.`);S.harvesterTrait.status=j.HarvesterStatus.MovingToOreSite,S.harvesterTrait.lastGatherExplicit=this.explicitOrder}onEnd(S){S.harvesterTrait.status!==j.HarvesterStatus.LookingForOreSite&&(S.harvesterTrait.status=j.HarvesterStatus.Idle)}onTick(S){if(this.isCancelling())return!0;let O=S.harvesterTrait;if(O.status===j.HarvesterStatus.MovingToOreSite){var B=this.target;if(this.target=this.findClosestReachableOreSite(S,this.target||this.initialTarget?.landType!==L.LandType.Tiberium?O.lastOreSite??S.tile:this.initialTarget,!0),O.lastOreSite=this.target,!this.target){O.status=j.HarvesterStatus.LookingForOreSite;let B=this.getRefineryOnTile(S.tile);if(B&&1===S.unitOrderTrait.getTasks().length){let O=S.rules.movementZone===K.MovementZone.Fly;var H=new N.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,B.tile,B.getFoundation(),1,5,B=>O||0<this.game.map.terrain.getPassableSpeed(B,S.rules.speedType,S.isInfantry(),!1)&&Math.abs(B.z-S.tile.z)<2&&!this.game.map.terrain.findObstacles({tile:B,onBridge:void 0},S).length).getNextTile();H&&S.unitOrderTrait.addTasks(new D.MoveTask(this.game,H,!1),new W.CallbackTask(()=>{[z.MoveResult.Success,z.MoveResult.CloseEnough,z.MoveResult.Cancel].includes(S.moveTrait.lastMoveResult)||this.children.push(new U.WaitMinutesTask(1/60))}))}return!0}if(H=this.game.rules.general.closeEnough,B=B&&this.rangeHelper.tileDistance(S.tile,this.target)<=H,!(S.tile===this.target||S.tile.landType===L.LandType.Tiberium&&B)){if(S.tile!==this.target&&B&&S.tile.landType!==L.LandType.Tiberium)if(B=this.findClosestReachableOreSite(S,S.tile,!1,!0))this.target=B,O.lastOreSite=this.target;else{if(!this.forceMoveTried)return this.forceMoveTried=!0,this.children.push(new D.MoveTask(this.game,this.target,!1,{closeEnoughTiles:0,strictCloseEnough:!0})),!1;if(this.forceMoveTried=!1,!O.isEmpty())return this.returnOreIfPossible(S),!0;if(!(B=this.findClosestReachableOreSite(S,S.tile,!0,!0)))return O.status=j.HarvesterStatus.LookingForOreSite,!0;this.target=B,O.lastOreSite=this.target}return this.children.push(new D.MoveTask(this.game,this.target,!1,{closeEnoughTiles:H}),new W.CallbackTask(()=>{[z.MoveResult.Success,z.MoveResult.CloseEnough,z.MoveResult.Cancel].includes(S.moveTrait.lastMoveResult)||this.children.push(new U.WaitMinutesTask(5/60))})),!1}this.target=S.tile,O.lastOreSite=this.target,O.status=j.HarvesterStatus.Harvesting,this.forceMoveTried=!1}if(O.status!==j.HarvesterStatus.Harvesting)return!1;{if(O.isFull())return this.returnOreIfPossible(S),!0;let B=this.game.map.getObjectsOnTile(S.tile).find(S=>S.isOverlay()&&S.isTiberium());if(!B)return this.findClosestReachableOreSite(S,O.lastOreSite??S.tile,!1)||O.isEmpty()?(O.status=j.HarvesterStatus.MovingToOreSite,this.onTick(S)):(this.returnOreIfPossible(S),!0);let N=B.traits.get(F.TiberiumTrait);if(H=N.collectBail(),N.getBailCount()||this.game.unspawnObject(B),void 0!==H)if(H===_.TiberiumType.Ore)O.ore++;else{if(H!==_.TiberiumType.Gems)throw new Error("Unsupported tiberium type "+H);O.gems++}return![...S.owner.buildings].some(S=>S.rules.refinery)&&!this.explicitOrder||(this.children.push(new U.WaitMinutesTask(1/60)),!1)}}findClosestReachableOreSite(S,O,B,j=!1){let D=S.rules.movementZone===K.MovementZone.Fly;var F=S.rules.speedType,_=S.isInfantry();let U=!D&&this.game.map.terrain.getPassableSpeed(S.tile,F,_,S.onBridge)?this.game.map.terrain.getIslandIdMap(F,_):void 0,H=U?.get(S.tile,S.onBridge);var V;if(F=O=>O.landType===L.LandType.Tiberium&&U?.get(O,!1)===H&&(!j||D||!this.game.map.terrain.findObstacles({tile:O,onBridge:void 0},S).length),F(O))return O;let W=1;if(!B){let S=new N.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,O,{width:1,height:1},W,W,F),B=[];for(;V=S.getNextTile();)B.push(V);if(B.length){let S=B.map(S=>{var O=this.game.map.getObjectsOnTile(S).find(S=>S.isOverlay()&&S.isTiberium());if(!O)throw new Error(`Ore should exist on tile ${S.rx},${S.ry} b/c of landType`);return{tile:S,ore:O}});return S.sort((S,B)=>1e3*(B.ore.value-S.ore.value)+($[1+B.tile.ry-O.ry][1+B.tile.rx-O.rx]-$[1+S.tile.ry-O.ry][1+S.tile.rx-O.rx])),S[0].tile}W=2}return _=B?this.scanFarRadius:this.scanNearRadius,new N.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,O,{width:1,height:1},W,_,F).getNextTile()}getRefineryOnTile(S){return this.game.map.getObjectsOnTile(S).find(S=>S.isBuilding()&&S.rules.refinery)}returnOreIfPossible(S){1===S.unitOrderTrait.getTasks().length&&S.unitOrderTrait.addTask(new H.ReturnOreTask(this.game))}getTargetLinesConfig(S){return{pathNodes:this.initialTarget?[{tile:this.initialTarget,onBridge:void 0}]:[]}}},S("GatherOreTask",q)}}}),System.register("game/gameobject/task/harvester/ReturnOreTask",["game/gameobject/task/system/Task","game/gameobject/unit/RangeHelper","game/map/tileFinder/RadialTileFinder","game/gameobject/task/move/MoveTask","game/gameobject/task/TurnTask","game/gameobject/task/system/WaitMinutesTask","engine/type/TiberiumType","game/gameobject/trait/HarvesterTrait","game/gameobject/task/harvester/TeleportMoveToRefineryTask","game/gameobject/task/harvester/GatherOreTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/gameobject/unit/ZoneType","game/math/Vector2"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S}],execute:function(){q=class extends B.Task{constructor(S,O,B=!1,j=!1){super(),this.game=S,this.forceTarget=O,this.resetLastOreSite=B,this.explicitOrder=j,this.useChildTargetLines=!0,this.preventOpportunityFire=!1,this.rangeHelper=new N.RangeHelper(S.map.tileOccupation)}onStart(S){if(!S.isVehicle()||!S.harvesterTrait)throw new Error(`Unit ${S.name} is not a harvester.`);S.harvesterTrait.status=U.HarvesterStatus.MovingToRefinery,this.resetLastOreSite&&(S.harvesterTrait.lastOreSite=void 0)}onEnd(S){this.target?.isSpawned&&(this.target.dockTrait.undockUnit(S),this.target.dockTrait.unreserveDockForUnit(S)),S.harvesterTrait.status!==U.HarvesterStatus.LookingForRefinery&&(S.harvesterTrait.status=U.HarvesterStatus.Idle)}onTick(S){if(this.isCancelling())return!0;let O=S.harvesterTrait;if(O.status===U.HarvesterStatus.LookingForRefinery)return!0;if(O.status===U.HarvesterStatus.MovingToRefinery){if(!this.target||!this.isValidTargetRefinery(this.target,S)||S.tile!==this.findRefineryDockingTile(this.target)){var B=this.forceTarget??this.findClosestReachableRefinery(S);if(!B)return O.status=U.HarvesterStatus.LookingForRefinery,!0;this.target&&this.target!==B&&this.target.dockTrait.hasReservedDockForUnit(S)&&this.target.dockTrait.unreserveDockForUnit(S),this.target=B}let D=this.target.dockTrait.getFirstAvailableDockNumber(),_=!1;void 0===D&&(D=this.target.dockTrait.getFirstEmptyDockNumber(),void 0!==D&&(_=!this.target.dockTrait.hasReservedDockForUnit(S)));let V=this.findRefineryDockingTile(this.target);var N=this.rangeHelper.tileDistance(S,V);if(void 0===D||_||N>this.game.rules.general.harvesterTooFarDistance&&!this.explicitOrder){var j=this.findReachableQueueingTile(S);return!j||(S.tile!==j&&this.children.push(S.rules.teleporter?new H.TeleportMoveToRefineryTask(this.game,V,j,()=>this.chronoMinerCanTeleport(S,V,this.target)):new L.MoveTask(this.game,j,!1),new W.CallbackTask(()=>{S.moveTrait.lastMoveResult===z.MoveResult.Fail?O.status=U.HarvesterStatus.LookingForRefinery:S.moveTrait.lastMoveResult===z.MoveResult.CloseEnough?this.children.push(new F.WaitMinutesTask(5/60)):S.moveTrait.lastMoveResult===z.MoveResult.Success&&this.children.push(new F.WaitMinutesTask(2/60))})),!1)}if(this.target.dockTrait.hasReservedDockForUnit(S)||this.target.dockTrait.reserveDockAt(S,D),void 0===this.reservedDockNumber&&(this.reservedDockNumber=this.target.dockTrait.getReservedDockForUnit(S)),S.tile!==V)return this.children.push(S.rules.teleporter?new H.TeleportMoveToRefineryTask(this.game,V,void 0,()=>this.chronoMinerCanTeleport(S,V,this.target)):new L.MoveTask(this.game,V,!1,{closeEnoughTiles:0,strictCloseEnough:!0}),new W.CallbackTask(()=>{S.moveTrait.lastMoveResult===z.MoveResult.Fail&&(O.status=U.HarvesterStatus.LookingForRefinery)})),!1;O.status=U.HarvesterStatus.Docking}if(!this.isValidTargetRefinery(this.target,S))return O.status=U.HarvesterStatus.MovingToRefinery,this.forceTarget=void 0,this.onTick(S);if(O.status===U.HarvesterStatus.Docking){if(270!==S.direction)return this.children.push(new D.TurnTask(270)),!1;this.target.dockTrait.dockUnitAt(S,this.reservedDockNumber),this.reservedDockNumber=void 0,O.status=U.HarvesterStatus.PreparingToUnload}return O.status===U.HarvesterStatus.PreparingToUnload?(this.preventOpportunityFire=!0,this.children.push(new F.WaitMinutesTask(2/60)),O.status=U.HarvesterStatus.Unloading,!1):O.status===U.HarvesterStatus.Unloading&&(B=O.ore*this.game.rules.getTiberium(_.TiberiumType.Ore).value+O.gems*this.game.rules.getTiberium(_.TiberiumType.Gems).value,this.target.owner.credits+=B,N=[...this.target.owner.buildings].filter(S=>S.rules.orePurifier&&(!S.poweredTrait||!this.target.owner.powerTrait?.isLowPower())).length,j=this.game.rules.general.purifierBonus,this.target.owner.credits+=N*Math.floor(B*j),O.ore=0,O.gems=0,1===S.unitOrderTrait.getTasks().length&&S.unitOrderTrait.addTask(new V.GatherOreTask(this.game)),!0)}isValidTargetRefinery(S,O){return S.isSpawned&&this.game.areFriendly(S,O)&&!S.warpedOutTrait.isActive()}findClosestReachableRefinery(S){let O=this.rangeHelper;var B=S.zone===K.ZoneType.Air,N=S.rules.speedType,j=S.isInfantry();let L=!B&&this.game.map.terrain.getPassableSpeed(S.tile,N,j,S.onBridge)?this.game.map.terrain.getIslandIdMap(N,j):void 0,D=[...S.owner.buildings].filter(O=>O.rules.refinery&&O.dockTrait&&!O.warpedOutTrait.isActive()&&(O=>S.rules.teleporter||L?.get(O,!1)===L?.get(S.tile,S.onBridge))(this.findRefineryDockingTile(O))).sort((B,N)=>O.distance2(S,B)-O.distance2(S,N));return N=D[0],j=D.find(S=>0<S.dockTrait.getAvailableDockCount()),!j||N&&O.tileDistance(S,j.centerTile)-O.tileDistance(S,N.centerTile)>this.game.rules.general.harvesterTooFarDistance?N:j}findReachableQueueingTile(S){if(this.target.art.queueingCell){var O=new $.Vector2(this.target.tile.rx,this.target.tile.ry).add(this.target.art.queueingCell);if((O=this.game.map.tiles.getByMapCoords(O.x,O.y))&&this.isValidQueueingTile(O,S))return O}return new j.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,O=>this.isValidQueueingTile(O,S)).getNextTile()}isValidQueueingTile(S,O){var B=O.zone===K.ZoneType.Air,N=O.rules.speedType,j=O.isInfantry();let L=!B&&this.game.map.terrain.getPassableSpeed(O.tile,N,j,O.onBridge)?this.game.map.terrain.getIslandIdMap(N,j):void 0;return B||L?.get(S,!1)===L?.get(O.tile,O.onBridge)&&Math.abs(S.z-this.target.tile.z)<2&&!S.onBridgeLandType}findRefineryDockingTile(S){var O={x:S.tile.rx+S.getFoundation().width-1,y:S.tile.ry+Math.floor(S.getFoundation().height/2)};return this.game.map.tiles.getByMapCoords(O.x,O.y)}chronoMinerCanTeleport(S,O,B){var N=this.rangeHelper.tileDistance(S,O);return!(!this.forceTarget&&N>this.game.rules.general.chronoHarvTooFarDistance||N<=1||!this.isValidTargetRefinery(B,S)||0===B.dockTrait.getAvailableDockCount()&&!B.dockTrait.hasReservedDockForUnit(S))}},S("ReturnOreTask",q)}}}),System.register("game/gameobject/task/harvester/TeleportMoveToRefineryTask",["game/gameobject/task/move/MoveTask","game/type/LocomotorType","game/gameobject/trait/MoveTrait","game/gameobject/unit/ZoneType"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends B.MoveTask{constructor(S,O,B,N){super(S,B??O,!1,{closeEnoughTiles:B?void 0:0,strictCloseEnough:!B}),this.teleportTile=O,this.teleportCondition=N}onStart(S){if(super.onStart(S),!S.harvesterTrait||S.rules.locomotor!==N.LocomotorType.Chrono)throw new Error(`Vehicle ${S.name} is not a chrono miner`)}onTick(S){return!S.moveTrait.isDisabled()&&(!(this.isCancelling()||S.moveTrait.moveState!==j.MoveState.ReachedNextWaypoint||S.tile===this.teleportTile||!this.tryTeleportToRefinery(S))||!0===super.onTick(S)&&(this.isCancelling()||S.tile===this.teleportTile||this.tryTeleportToRefinery(S),!0))}tryTeleportToRefinery(S){return!(this.teleportCondition&&!1===this.teleportCondition(S,this.teleportTile)||this.game.map.terrain.findObstacles({tile:this.teleportTile,onBridge:void 0},S).length||(S.moveTrait.teleportUnitToTile(this.teleportTile,void 0,!0,!0,this.game),S.zone===L.ZoneType.Air&&(S.zone=L.ZoneType.Ground,S.position.tileElevation=0),0))}},S("TeleportMoveToRefineryTask",D)}}}),System.register("game/gameobject/task/morph/DeployIntoTask",["game/gameobject/task/morph/MorphIntoTask","engine/type/ObjectType"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends B.MorphIntoTask{onStart(S){var O=S.rules.deploysInto;if(!O)throw new Error(`Object type "${S.name}" doesn't deploy into anything`);this.morphInto=this.game.rules.getObject(O,N.ObjectType.Building),super.onStart(S)}onTick(S){return!!this.isCancelling()||super.onTick(S)}},S("DeployIntoTask",j)}}}),System.register("game/gameobject/task/morph/MorphIntoTask",["game/gameobject/task/system/Task","engine/type/ObjectType","game/gameobject/Building","game/gameobject/task/move/MoveTask","game/event/ObjectMorphEvent","game/gameobject/task/TurnTask","game/gameobject/task/morph/PackBuildingTask"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){U=class extends B.Task{constructor(S){super(),this.game=S}onStart(S){if(!this.morphInto)throw new Error("morphInto not set");S.isBuilding()&&S.buildStatus!==j.BuildStatus.BuildDown&&this.morphInto.type!==N.ObjectType.Building&&this.children.push(new _.PackBuildingTask(this.game)),S.isVehicle()&&this.morphInto.type===N.ObjectType.Building&&this.children.push(new F.TurnTask(180))}onTick(S){if(!this.morphInto)throw new Error("morphInto not set");let O=this.game.getUnitSelection();var B=O.isSelected(S),j=O.getOrCreateSelectionModel(S).getControlGroupNumber();let F;if(this.morphInto.type===N.ObjectType.Building){if(S.isVehicle()&&S.parasiteableTrait?.isInfested()&&!S.parasiteableTrait.beingBoarded)return!0;var _=S.tile;let O=this.game.getConstructionWorker(S.owner);if(!O.canPlaceAt(this.morphInto.name,_,{ignoreAdjacent:!0,ignoreObjects:[S]}))return!0;this.game.unspawnObject(S),S.dispose(),[F]=O.placeAt(this.morphInto.name,_),F.healthTrait.health=S.healthTrait.health}else{let O=S.unitOrderTrait.getTasks().filter(S=>S instanceof L.MoveTask);this.game.unspawnObject(S),S.dispose(),F=this.game.createUnitForPlayer(this.morphInto,S.owner),F.direction=180,F.healthTrait.health=S.healthTrait.health,_=S.art.foundationCenter,this.game.spawnObject(F,this.game.map.tiles.getByMapCoords(S.tile.rx+_.x,S.tile.ry+_.y)),O.forEach(S=>F.unitOrderTrait.addTask(S))}return F.purchaseValue=S.purchaseValue,S.replacedBy=F,B&&O.addToSelection(F),void 0!==j&&O.addUnitsToGroup(j,[F],!1),this.game.events.dispatch(new D.ObjectMorphEvent(S,F)),!0}},S("MorphIntoTask",U)}}}),System.register("game/gameobject/task/morph/PackBuildingTask",["game/gameobject/task/system/Task","game/gameobject/Building","game/gameobject/task/system/WaitMinutesTask"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends B.Task{constructor(S){super(),this.game=S}onTick(S){return!(S.buildStatus!==N.BuildStatus.BuildDown&&(S.setBuildStatus(N.BuildStatus.BuildDown,this.game),!S.rules.wall)&&(this.children.push(new j.WaitMinutesTask(this.game.rules.general.buildupTime)),1))}},S("PackBuildingTask",L)}}}),System.register("game/gameobject/task/morph/UndeployIntoTask",["game/gameobject/task/morph/MorphIntoTask","engine/type/ObjectType"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends B.MorphIntoTask{onStart(S){var O=S.rules.undeploysInto;if(!O)throw new Error(`Object type "${S.name}" doesn't undeploy into anything`);this.morphInto=this.game.rules.getObject(O,N.ObjectType.Vehicle),super.onStart(S)}},S("UndeployIntoTask",j)}}}),System.register("game/gameobject/task/move/AttackMoveTargetTask",["game/gameobject/task/AttackTask","game/gameobject/trait/MoveTrait"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class e extends B.AttackTask{constructor(S,O,B){if(super(S,O,B),this.isAttackMove=!0,this.attackPerformed=!1,this.passedFirstWaypoint=!1,this.internalTargetUpdateRequested=!1,this.scanCooldownTicks=0,!O.obj?.isTechno())throw new Error("Target must be a techno object");this.initialTarget=O,this.initialWeapon=B,this.requestedTarget=O}duplicate(){return new e(this.game,this.initialTarget,this.initialWeapon)}requestTargetUpdate(S){this.internalTargetUpdateRequested?(this.requestedTarget=S,this.internalTargetUpdateRequested=!1):(this.requestedTarget===this.initialTarget?this.requestedTarget=S:this.attackPerformed=!0,this.initialTarget=S),super.requestTargetUpdate(S)}onTargetChange(S){super.onTargetChange(S);var O=S.attackTrait.currentTarget;O&&O.obj!==this.initialTarget.obj&&O.obj!==this.requestedTarget.obj&&(this.requestedTarget===this.initialTarget&&(this.requestedTarget=O),this.initialTarget=O)}onTick(S){if(S.moveTrait.moveState===N.MoveState.Moving&&(this.passedFirstWaypoint=!0),this.scanCooldownTicks=Math.max(0,this.scanCooldownTicks-1),S.attackTrait&&!S.attackTrait.isDisabled()&&!this.isCancelling()&&(this.requestedTarget===this.initialTarget||this.attackPerformed)){if(!(S.moveTrait.isIdle()||S.tile===this.lastScanTile&&this.scanCooldownTicks)){this.lastScanTile=S.tile,this.scanCooldownTicks=this.game.rules.general.normalTargetingDelay;let N=S.attackTrait.selectDefaultWeapon(S);if(N&&(this.passedFirstWaypoint||!N.getCooldownTicks())){var O=S.attackTrait.scanForTarget(S,N,this.game);if(O.target){let{target:S,weapon:N}=O;if(!N.getCooldownTicks()){this.options.holdGround=!0,this.options.passive=!0,this.setWeapon(N);var B=this.game.createTarget(S,S.tile);return this.internalTargetUpdateRequested=!0,this.requestTargetUpdate(B),this.attackPerformed=!1}}}}if(this.attackPerformed){if(!S.isSpawned){if(!this.forceCancel(S))throw new Error("Force cancel failed");return!0}this.attackPerformed=!1,this.passedFirstWaypoint=!1,this.options.holdGround=!1,this.options.passive=!1,this.setWeapon(this.initialWeapon),this.internalTargetUpdateRequested=!0,this.requestTargetUpdate(this.initialTarget)}}return(B=super.onTick(S))&&this.requestedTarget!==this.initialTarget?(this.attackPerformed=!0,this.isCancelling()||S.attackTrait.isDisabled()):B}},S("AttackMoveTargetTask",j)}}}),System.register("game/gameobject/task/move/AttackMoveTask",["game/gameobject/task/move/MoveTask","game/gameobject/trait/MoveTrait","game/type/MovementZone"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class e extends B.MoveTask{constructor(){super(...arguments),this.isAttackMove=!0,this.attackPerformed=!1,this.passedFirstWaypoint=!1}duplicate(){return new e(this.game,this.targetTile,this.toBridge,this.options)}onTick(S){if(S.moveTrait.moveState===N.MoveState.Moving&&(this.passedFirstWaypoint=!0),S.moveTrait.moveState===N.MoveState.ReachedNextWaypoint&&S.attackTrait&&!S.attackTrait.isDisabled()&&(S.rules.movementZone!==j.MovementZone.Fly||!S.rules.balloonHover)&&(!S.ammoTrait||S.ammoTrait.ammo||!S.rules.manualReload)&&!this.isCancelling()){let B=S.attackTrait.selectDefaultWeapon(S);if(B&&(this.passedFirstWaypoint||B&&!B.getCooldownTicks())){var O=S.attackTrait.scanForTarget(S,B,this.game);if(O.target){let{target:B,weapon:j}=O;if(!j.getCooldownTicks())return O=S.attackTrait.createAttackTask(this.game,B,B.tile,j,{holdGround:!0,passive:!0}),this.children.push(O),this.useChildTargetLines=!0,this.attackPerformed=!0,S.moveTrait.velocity.set(0,0,0),S.moveTrait.currentWaypoint=void 0,S.moveTrait.collisionState=N.CollisionState.Waiting,!1}}if(this.attackPerformed){if(!S.isSpawned){if(!this.forceCancel(S))throw new Error("Force cancel failed");return!0}this.attackPerformed=!1,this.passedFirstWaypoint=!1,this.useChildTargetLines=!1,S.moveTrait.collisionState=N.CollisionState.Resolved,this.updateTarget(this.targetTile,this.toBridge)}}return super.onTick(S)}},S("AttackMoveTask",L)}}}),System.register("game/gameobject/task/move/ExitFactoryTask",["game/gameobject/task/move/MoveTask","game/gameobject/trait/MoveTrait","game/rules/TechnoRules","game/gameobject/task/ScatterTask","game/gameobject/task/AttackTask","game/gameobject/task/move/AttackMoveTargetTask","game/gameobject/task/move/AttackMoveTask"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){U=class extends B.MoveTask{constructor(S,O,B,N){super(S,B,!1,{ignoredBlockers:[O],closeEnoughTiles:0,strictCloseEnough:!0,forceWaitOnPathBlocked:O.factoryTrait?.type!==j.FactoryType.InfantryType}),this.factory=O,this.rallyPoint=N,this.preventOpportunityFire=!0,this.rampBlockersPushed=!1,this.cancellable=!1}onStart(S){super.onStart(S),this.factory.factoryTrait?.type===j.FactoryType.UnitType&&(this.checkRampTiles=this.game.map.tileOccupation.calculateTilesForGameObject(this.factory.tile,this.factory).filter(O=>0<this.game.map.terrain.getPassableSpeed(O,S.rules.speedType,S.isInfantry(),!1)))}canStopAtTile(S,O,B){return!this.game.map.tileOccupation.isTileOccupiedBy(O,this.factory)&&super.canStopAtTile(S,O,B)}onTick(S){if(this.checkRampTiles){for(var O of this.checkRampTiles){var j,U;for(j of this.game.map.tileOccupation.getGroundObjectsOnTile(O))if(j.isUnit()){if(this.rampBlockersPushed)return!1;let S=new L.ScatterTask(this.game,void 0,{excludedTiles:this.checkRampTiles});S.setCancellable(!1);let O=j.unitOrderTrait.getCurrentTask();O?O.constructor!==B.MoveTask&&O.constructor!==D.AttackTask&&O.constructor!==_.AttackMoveTask&&O.constructor!==F.AttackMoveTargetTask||(U=O.duplicate(),O.cancel(),j.unitOrderTrait.addTaskNext(U),j.unitOrderTrait.addTaskNext(S)):j.unitOrderTrait.addTask(S)}}if(!this.rampBlockersPushed)return!(this.rampBlockersPushed=!0);this.checkRampTiles=void 0}return S.moveTrait.moveState===N.MoveState.ReachedNextWaypoint&&this.options?.ignoredBlockers&&!this.game.map.terrain.isBlockerObject(this.factory,S.tile,!1,S.rules.speedType,S.isInfantry())&&(this.options.ignoredBlockers=void 0,this.preventOpportunityFire=!1,this.rallyPoint&&(this.updateTarget(this.rallyPoint.tile,!!this.rallyPoint.onBridge),this.cancellable=!0,this.options.closeEnoughTiles=this.game.rules.general.closeEnough,this.options.strictCloseEnough=!1,this.options.forceWaitOnPathBlocked=!1)),super.onTick(S)}},S("ExitFactoryTask",U)}}}),System.register("game/gameobject/task/move/MoveAsideTask",["game/gameobject/task/system/Task","game/gameobject/unit/MovePositionHelper","game/gameobject/task/system/WaitTicksTask","game/gameobject/trait/MoveTrait","game/gameobject/task/move/MoveTask","game/math/geometry","game/type/MovementZone","game/gameobject/infantry/StanceType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){H=class e extends B.Task{constructor(S,O){super(),this.game=S,this.fromDirection=O,this.resolved=!1,this.chainPushIssued=!1}onEnd(S){S.moveTrait.collisionState=L.CollisionState.Resolved}onTick(S){if(this.timeoutTicks=void 0===this.timeoutTicks?0:this.timeoutTicks+1,40<this.timeoutTicks||this.resolved||this.isCancelling())return!0;let O=this.game.map,B=new N.MovePositionHelper(O);var H=S.onBridge?O.tileOccupation.getBridgeOnTile(S.tile):void 0;let V,W;for(let N=0;N<360;N+=45)if((0!==N||this.chainPushIssued)&&180!==N){var z=F.rotateVec2(this.fromDirection.clone(),N).round();if((z=O.tiles.getByMapCoords(S.tile.rx+Math.sign(z.x),S.tile.ry+Math.sign(z.y)))&&O.mapBounds.isWithinBounds(z)&&(W=O.tileOccupation.getBridgeOnTile(z),S.rules.movementZone===_.MovementZone.Fly||!O.terrain.findObstacles({tile:z,onBridge:W},S).length&&B.isEligibleTile(z,W,H,S.tile))){V=z;break}}if(V)return this.resolved=!0,S.isInfantry()&&S.deployerTrait&&S.deployerTrait.isDeployed()&&S.deployerTrait.setDeployed(!1),!!S.moveTrait.isDisabled()||(this.children.push(new D.MoveTask(this.game,V,!!W,{closeEnoughTiles:0,strictCloseEnough:!0})),!1);{if(this.chainPushIssued)return this.children.push(new j.WaitTicksTask(5)),!1;let B=O.tiles.getByMapCoords(S.tile.rx+Math.sign(this.fromDirection.x),S.tile.ry+Math.sign(this.fromDirection.y));if(!B||!O.mapBounds.isWithinBounds(B))return!0;W=O.tileOccupation.getBridgeOnTile(B);let N=O.tileOccupation.getGroundObjectsOnTile(B).filter(O=>O.isUnit()&&O.owner===S.owner&&O.tile===B&&O.onBridge===!!W&&!(O.isInfantry()&&O.stance===U.StanceType.Paradrop)&&!(O.isAircraft()&&O.missileSpawnTrait));return N.find(S=>S.moveTrait.collisionState===L.CollisionState.Waiting||S.unitOrderTrait.hasTasks())?(this.children.push(new j.WaitTicksTask(5)),S.moveTrait.collisionState=L.CollisionState.Waiting,S.moveTrait.moveState=L.MoveState.PlanMove,!1):(N.forEach(S=>{S.unitOrderTrait.addTask(new e(this.game,this.fromDirection))}),this.children.push(new j.WaitTicksTask(1)),S.moveTrait.collisionState=L.CollisionState.Waiting,S.moveTrait.moveState=L.MoveState.PlanMove,!(this.chainPushIssued=!0))}}},S("MoveAsideTask",H)}}}),System.register("game/gameobject/task/move/MoveInWeaponRangeTask",["game/gameobject/task/move/MoveTask","game/gameobject/GameObject","game/gameobject/unit/RangeHelper","game/Coords","game/gameobject/unit/LosHelper","game/map/tileFinder/RadialTileFinder","game/type/MovementZone","game/gameobject/unit/ZoneType","game/gameobject/trait/MoveTrait","game/map/tileFinder/RandomTileFinder","game/type/LocomotorType","util/bresenham","game/gameobject/unit/FacingUtil","game/math/Vector2"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S}],execute:function(){S("STRAFE_CLOSE_ENOUGH",2),q=class extends B.MoveTask{constructor(S,O,B,L){super(S,O instanceof N.GameObject?O.isBuilding()?O.centerTile:O.tile:O,B,{pathFinderIgnoredBlockers:O instanceof N.GameObject&&0<L.range?[O]:void 0}),this.target=O,this.weapon=L,this.recalcMinRange=!0,this.cancelRequested=!1,this.bomberInitialLock=!1,this.rangeHelper=new j.RangeHelper(S.map.tileOccupation),this.losHelper=new D.LosHelper(S.map.tiles,S.map.tileOccupation)}onStart(S){let O=this.target,B=this.game.map;if(O instanceof N.GameObject&&O.isBuilding()&&S.rules.movementZone!==_.MovementZone.Fly){let L=O.tile;var j=O instanceof N.GameObject?O.getFoundation():{width:1,height:1};j=new F.RadialTileFinder(B.tiles,B.mapBounds,L,j,1,5,O=>0<B.terrain.getPassableSpeed(O,S.rules.speedType,S.isInfantry(),!1)&&Math.abs(O.z-L.z)<2).getNextTile(),j&&this.rangeHelper.tileDistance(O,j)>Math.SQRT2&&this.updateTarget(j,!1)}this.bomberInitialLock=this.isCloseEnoughToDest(S,S.tile),super.onStart(S)}cancel(){this.bomberManeuverTile?this.cancelRequested=!0:super.cancel()}shouldAirStrafe(S){return S.rules.movementZone===_.MovementZone.Fly&&S.rules.locomotor===W.LocomotorType.Aircraft&&S.rules.fighter&&1<this.weapon.projectileRules.iniRot}isBombingRun(S){return S.rules.movementZone===_.MovementZone.Fly&&S.rules.locomotor===W.LocomotorType.Aircraft&&this.weapon.projectileRules.iniRot<=1}isAirStrafeCloseEnough(S){return this.rangeHelper.tileDistance(S,this.targetTile)<Math.min(this.weapon.range,2)}bomberCanReturn(S){return!this.bomberManeuverTile||this.rangeHelper.tileDistance(S,this.bomberManeuverTile)<=1}findStrafeDestination(S,O){return new V.RandomTileFinder(this.game.map.tiles,this.game.map.mapBounds,O,this.weapon.range,this.game,B=>this.rangeHelper.isInWeaponRange(S,O,this.weapon,this.game.rules,B)).getNextTile()}hasReachedDestination(S){return super.hasReachedDestination(S)||this.canStopAtTile(S,S.tile,S.onBridge)}canStopAtTile(S,O,B){if(S.zone!==U.ZoneType.Air&&this.target instanceof N.GameObject&&this.game.map.tileOccupation.isTileOccupiedBy(O,this.target)&&(!this.target.isUnit()||this.target.tile===O&&this.target.moveTrait.moveState!==H.MoveState.Moving))return!1;if(S.zone!==U.ZoneType.Air){if(!super.canStopAtTile(S,O,B))return!1}else if(this.game.map.tileOccupation.getAirObjectsOnTile(O).filter(O=>O.isUnit()&&O.moveTrait.moveState!==H.MoveState.Moving&&O!==S).length)return!1;return!(this.isBombingRun(S)&&!this.bomberCanReturn(O))&&(!!this.isCancelling()||this.isCloseEnoughToDest(S,O))}isCloseEnoughToDest(S,O){if(S.rules.balloonHover&&!S.rules.hoverAttack)return this.rangeHelper.isInTileRange(O,this.target,0,0);if(this.weapon.rules.cellRangefinding||!S.isInfantry())return this.rangeHelper.isInWeaponRange(S,this.target,this.weapon,this.game.rules,O)&&this.losHelper.hasLineOfSight(O,this.target,this.weapon);var B=S.zone===U.ZoneType.Air?S.position.computeSubCellOffset(S.position.desiredSubCell):S.position.getTileOffset(),{minRange:N,range:j}=this.rangeHelper.computeWeaponRangeVsTarget(O,this.target,this.weapon,this.game.rules);return B=L.Coords.tile3dToWorld(O.rx+B.x/L.Coords.LEPTONS_PER_TILE,O.ry+B.y/L.Coords.LEPTONS_PER_TILE,O.z+S.position.tileElevation),(S.isUnit()&&S.rules.movementZone===_.MovementZone.Fly?this.rangeHelper.isInRange2(B,this.target,N,j):this.rangeHelper.isInRange3(B,this.target,N,j))&&this.losHelper.hasLineOfSight(O,this.target,this.weapon)}findRelocationTile(S,O,B){if(B.rules.movementZone!==_.MovementZone.Fly)return super.findRelocationTile(S,O,B);var N=this.game.map;return new V.RandomTileFinder(N.tiles,N.mapBounds,S,1,this.game,S=>this.isCancelling()||this.isCloseEnoughToDest(B,S)).getNextTile()}retarget(S,O){var B=S instanceof N.GameObject?S.isBuilding()?S.centerTile:S.tile:S;this.bomberManeuverTile?this.bomberQueuedTargetTile=B:(this.updateTarget(B,O),this.recalcMinRange=!0),this.target=S,this.options?.ignoredBlockers&&(this.options.ignoredBlockers=S instanceof N.GameObject?[S]:void 0),this.options??(this.options={}),this.options.pathFinderIgnoredBlockers=S instanceof N.GameObject?[S]:void 0}onTick(S){if(this.recalcMinRange){this.recalcMinRange=!1;var O=this.findMinRangeRelocationTile(S,this.targetTile);if(O!==this.targetTile){if(!O)return this.cancel(),!1;this.updateTarget(O,!!O.onBridgeLandType)}}if(this.shouldAirStrafe(S)&&!this.isCancelling()&&(this.updateTarget(this.target instanceof N.GameObject?this.target.isBuilding()?this.target.centerTile:this.target.tile:this.target,!1),!this.isAirStrafeCloseEnough(S)||(B=this.findStrafeDestination(S,this.targetTile))&&this.updateTarget(B,!1)),this.isBombingRun(S)&&!this.isCancelling()&&(!S.ammo||this.weapon.getBurstsFired()||this.bomberInitialLock)&&!this.bomberManeuverTile){this.bomberInitialLock=!1;let O=S.position.getMapPosition();var B=this.target instanceof N.GameObject?this.target.isBuilding()?this.target.centerTile:this.target.tile:this.target;let j=new $.Vector2(B.rx+.5,B.ry+.5).clone().multiplyScalar(L.Coords.LEPTONS_PER_TILE).sub(O),D=j.length();if(D||(j.copy(K.FacingUtil.toMapCoords(S.direction)),D=Number.EPSILON),B=O.clone().add(j.setLength(D+7*L.Coords.LEPTONS_PER_TILE)).multiplyScalar(1/L.Coords.LEPTONS_PER_TILE).floor(),!(B=z.bresenham(B.x,B.y,S.tile.rx,S.tile.ry)).length)throw new Error("Bresenham returned no tiles");B=B[0],this.bomberManeuverTile=this.game.map.tiles.getByMapCoords(B.x,B.y)??this.game.map.tiles.getPlaceholderTile(B.x,B.y),this.options.allowOutOfBoundsTarget=!0,this.updateTarget(this.bomberManeuverTile,!1)}return this.bomberManeuverTile&&this.bomberCanReturn(S.tile)&&(this.bomberManeuverTile=void 0,this.bomberQueuedTargetTile&&(this.updateTarget(this.bomberQueuedTargetTile,!1),this.recalcMinRange=!0,this.bomberQueuedTargetTile=void 0)),this.cancelRequested&&(this.bomberManeuverTile||(this.cancelRequested=!1,this.cancel())),!!(this.isBombingRun(S)&&this.isCancelling()&&this.forceCancel(S))||super.onTick(S)}forceCancel(S){return!this.bomberManeuverTile&&super.forceCancel(S)}findMinRangeRelocationTile(S,O){var{minRange:B,range:N}=this.rangeHelper.computeWeaponRangeVsTarget(S,this.target,this.weapon,this.game.rules);return S.rules.locomotor===W.LocomotorType.Chrono?this.rangeHelper.isInRange(S,this.target,N-1,N,this.weapon.rules.cellRangefinding)?O:this.findTileInRange(S,O,N-1,2*N)??O:this.rangeHelper.isInRange(S,this.target,B,Number.POSITIVE_INFINITY,this.weapon.rules.cellRangefinding)?O:this.findTileInRange(S,O,2*B,N-B)}findTileInRange(S,O,B,N){let j=this.game.map;var L,D=new $.Vector2(S.tile.rx-O.rx,S.tile.ry-O.ry).setLength(B).floor().add(new $.Vector2(O.rx,O.ry));let _;for(L of z.bresenham(D.x,D.y,O.rx,O.ry))if(_=j.tiles.getByMapCoords(L.x,L.y),_)break;if(_)return new F.RadialTileFinder(j.tiles,j.mapBounds,_,{width:1,height:1},0,N,O=>this.rangeHelper.isInWeaponRange(S,this.target,this.weapon,this.game.rules,O)&&this.losHelper.hasLineOfSight(O,this.target,this.weapon)&&0<j.terrain.getPassableSpeed(O,S.rules.speedType,S.isInfantry(),!!O.onBridgeLandType)&&!j.terrain.findObstacles({tile:O,onBridge:!!O.onBridgeLandType},S).length).getNextTile()}},S("MoveInWeaponRangeTask",q)}}}),System.register("game/gameobject/task/move/MoveInsideTask",["game/gameobject/task/move/MoveTask"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class e extends B.MoveTask{static chooseTargetFoundationTile(S,O){if(S.isBuilding()){let B=S.centerTile;return O.map.mapBounds.isWithinBounds(B)||(B=O.map.tileOccupation.calculateTilesForGameObject(S.tile,S).find(S=>O.map.mapBounds.isWithinBounds(S))??S.tile),B}return S.tile}constructor(S,O){super(S,e.chooseTargetFoundationTile(O,S),!1,{ignoredBlockers:[O],closeEnoughTiles:0}),this.target=O}hasReachedDestination(S){return super.hasReachedDestination(S)||this.canStopAtTile(S,S.tile,S.onBridge)}canStopAtTile(S,O,B){var N=this.game.map.tileOccupation.isTileOccupiedBy(O,this.target);return!(this.isCancelling()&&N||!this.isCancelling()&&!N)}isCloseEnoughToDest(S,O,B){return this.game.map.tileOccupation.isTileOccupiedBy(O,this.target)}},S("MoveInsideTask",N)}}}),System.register("game/gameobject/task/move/MoveOutsideTask",["game/gameobject/task/move/MoveTask"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.MoveTask{constructor(S,O,B){super(S,B??O.tile,!1,{ignoredBlockers:[O]}),this.target=O,this.cancellable=!1}canStopAtTile(S,O,B){return!this.game.map.tileOccupation.isTileOccupiedBy(O,this.target)&&super.canStopAtTile(S,O,B)}},S("MoveOutsideTask",N)}}}),System.register("game/gameobject/task/move/MoveTargetTask",["game/gameobject/task/move/MoveTask","game/gameobject/trait/MoveTrait"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends B.MoveTask{constructor(S,O){super(S,O.tile,O.onBridge,{forceMove:!0,pathFinderIgnoredBlockers:[O]}),this.target=O,this.tilesSinceTargetUpdate=0}onTick(S){if(!(this.isCancelling()||S.moveTrait.moveState!==N.MoveState.ReachedNextWaypoint||this.target.tile===this.targetTile&&this.target.onBridge===this.toBridge&&this.target.moveTrait.isIdle())){let B=!1;var O;(S.tile===this.targetTile&&this.target.tile!==this.targetTile||10<this.tilesSinceTargetUpdate++)&&(B=!0),B&&(this.tilesSinceTargetUpdate=0,(O=this.target.moveTrait.currentWaypoint)?this.updateTarget(O.tile,!!O.onBridge):this.updateTarget(this.target.tile,this.target.onBridge))}return super.onTick(S)}forceCancel(S){return super.forceCancel(S)}getTargetLinesConfig(S){return{target:this.target,pathNodes:[]}}},S("MoveTargetTask",j)}}}),System.register("game/gameobject/task/move/MoveTask",["game/gameobject/task/system/Task","game/gameobject/Infantry","game/type/MovementZone","util/array","game/type/SpeedType","game/gameobject/trait/MoveTrait","game/gameobject/task/system/WaitTicksTask","game/gameobject/task/move/MoveAsideTask","game/gameobject/unit/MovePositionHelper","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/RangeHelper","util/Logger","game/Coords","game/gameobject/task/system/TaskStatus","game/gameobject/unit/ZoneType","game/gameobject/locomotor/LocomotorFactory","game/map/tileFinder/RandomTileFinder","game/event/ObjectTeleportEvent","game/gameobject/trait/interface/NotifyTeleport","game/type/PowerupType","game/gameobject/task/ScatterTask","game/gameobject/unit/VeteranAbility","game/math/Vector2"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S}],execute:function(){re=class e extends B.Task{constructor(S,O,B,N){super(),this.game=S,this.targetTile=O,this.toBridge=B,this.options=N,this.preventOpportunityFire=!1,this.logger=z.AppLogger.get("move"),this.destinationLeptons=new ie.Vector2,this.currentWaypointLeptons=new ie.Vector2,this.needsPathUpdate=!1,this.targetChangeRequested=!1,this.allObstaclesAreBlockers=!1,this.blockedPathNodes=[],this.unreachableTargets=[],this.pushTried=!1,this.cancelProcessed=!1,this.cancelRepositionPending=!1,this.targetLinesConfig={pathNodes:[]}}duplicate(){return new e(this.game,this.targetTile,this.toBridge,this.options)}setForceMove(S){S?(this.options??(this.options={}),this.options.forceMove=!0):this.options?.forceMove&&(this.options.forceMove=void 0)}onStart(S){if(S.moveTrait.currentWaypoint)throw new Error("Nested move tasks are not supported");void 0===S.moveTrait.locomotor&&(S.moveTrait.locomotor=new Q.LocomotorFactory(this.game).create(S)),S.moveTrait.lastTargetOffset?this.targetOffset=S.moveTrait.lastTargetOffset:this.targetOffset=this.computeTargetOffset(S),S.moveTrait.lastVelocity&&(S.moveTrait.velocity=S.moveTrait.lastVelocity),this.path||(this.groundPathPlan?(this.groundPathPlan.path[this.groundPathPlan.path.length-1].tile===S.tile?this.path=this.applyGroundPathPlan(this.groundPathPlan):this.computePath(S,S.moveTrait.locomotor),this.groundPathPlan=void 0):this.computePath(S,S.moveTrait.locomotor),this.targetLinesConfig.isRecalc=!1),this.updateDestination(this.path,this.targetOffset),S.moveTrait.moveState=F.MoveState.ReachedNextWaypoint,S.moveTrait.lastMoveResult=void 0,S.moveTrait.lastTargetOffset=void 0,S.moveTrait.lastVelocity=void 0}computeTargetOffset(S){return this.options?.targetOffset??(S.isInfantry()?S.position.getTileOffset():S.position.computeSubCellOffset(0))}computePath(S,O){let B;var N;B=this.options?.allowOutOfBoundsTarget||this.game.map.mapBounds.isWithinBounds(this.targetTile)?S.rules.movementZone===j.MovementZone.Fly?this.computeAirPath(S):O.ignoresTerrain?this.computeDirectJumpPath(S):(N=this.computeGroundPath(S),this.applyGroundPathPlan(N)):[],S.rules.movementZone===j.MovementZone.Fly?(this.targetLinesConfig.pathNodes=B.map(({tile:S,onBridge:O})=>({tile:S,onBridge:O})),B.length&&(this.targetLinesConfig.pathNodes[0].onBridge=this.toBridge?this.game.map.tileOccupation.getBridgeOnTile(this.targetTile):void 0)):this.targetLinesConfig.pathNodes=B,this.path=B}computeAirPath(S){return[{tile:this.targetTile,onBridge:void 0},{tile:S.tile,onBridge:void 0}]}computeDirectJumpPath(S){let O=this.game.map;var B=S.onBridge?O.tileOccupation.getBridgeOnTile(S.tile):void 0;let N=this.targetTile,j=this.toBridge?O.tileOccupation.getBridgeOnTile(this.targetTile):void 0,L=this.options?.ignoredBlockers;var D=new V.RadialTileFinder(O.tiles,O.mapBounds,N,{width:1,height:1},0,5,B=>0<O.terrain.getPassableSpeed(B,S.rules.speedType,S.isInfantry(),!!B.onBridgeLandType,L)&&!O.terrain.findObstacles({tile:B,onBridge:!!B.onBridgeLandType},S).find(S=>!L?.includes(S.obj))).getNextTile();return D?(D!==N&&(N=D,j=O.tileOccupation.getBridgeOnTile(N)),[{tile:N,onBridge:j},{tile:S.tile,onBridge:B}]):[]}computeGroundPath(S){let O=S.tile,B=S.onBridge?this.game.map.tileOccupation.getBridgeOnTile(O):void 0;S.moveTrait.moveState===F.MoveState.Moving&&S.moveTrait.currentWaypoint&&(O=S.moveTrait.currentWaypoint.tile,B=S.moveTrait.currentWaypoint.onBridge);let N={path:[],ignoredBlockers:[],blockedPathNodes:[]};const j=this.game.map.getObjectsOnTile(O).find(S=>S.isBuilding());if(j&&!this.game.map.terrain.getPassableSpeed(O,S.rules.speedType,S.isInfantry(),!1)){var L=this.options?.ignoredBlockers?.includes(j);if(L||N.ignoredBlockers.push(j),!L&&j.dockTrait){let S=new Set(j.dockTrait?.getAllDockTiles());this.game.map.tileOccupation.calculateTilesForGameObject(j.tile,j).filter(O=>!S.has(O)).forEach(S=>N.blockedPathNodes.push({node:{tile:S,onBridge:void 0},obj:j}))}}var D=this.game.map.getGroundObjectsOnTile(this.targetTile).find(O=>(O.isInfantry()||O.isVehicle())&&O.disguiseTrait?.hasTerrainDisguise()&&!(this.game.alliances.haveSharedIntel(S.owner,O.owner)||O.owner.sharedDetectDisguiseTrait?.has(S)));D&&(L=this.toBridge?this.game.map.tileOccupation.getBridgeOnTile(this.targetTile):void 0,N.blockedPathNodes.push({node:{tile:this.targetTile,onBridge:L},obj:D}));let _=[...new Set([...this.options?.ignoredBlockers??[],...this.options?.pathFinderIgnoredBlockers??[],...N.ignoredBlockers])],U=[...this.blockedPathNodes,...N.blockedPathNodes];return D=this.game.map.terrain.computePath(S.rules.speedType,S.isInfantry(),O,!!B,this.targetTile,this.toBridge,{maxExpandedNodes:this.allObstaclesAreBlockers?Math.min(300,this.options?.maxExpandedPathNodes??Number.POSITIVE_INFINITY):this.options?.maxExpandedPathNodes,bestEffort:!this.options?.strictCloseEnough,ignoredBlockers:_,excludeTiles:this.allObstaclesAreBlockers||U.length?O=>this.nodeIsBlockedForPathfinding(O,S,_,U):void 0}),N.path=D,N}nodeIsBlockedForPathfinding(S,O,B,N){return this.allObstaclesAreBlockers?!!this.game.map.terrain.findObstacles(S,O).find(S=>!B?.includes(S.obj)):!!N.find(({node:O})=>O.tile===S.tile&&O.onBridge===S.onBridge)}applyGroundPathPlan(S){var O;return this.blockedPathNodes=this.blockedPathNodes.filter(S=>S.obj.isSpawned&&S.node.tile===S.obj.tile),S.ignoredBlockers.length&&(this.options??(this.options={}),(O=this.options).ignoredBlockers??(O.ignoredBlockers=[]),this.options.ignoredBlockers.push(...S.ignoredBlockers)),this.blockedPathNodes.push(...S.blockedPathNodes),S.path}updateDestination(S,O){var B=S.length?S[0].tile:this.targetTile;this.destinationLeptons.set(B.rx*K.Coords.LEPTONS_PER_TILE,B.ry*K.Coords.LEPTONS_PER_TILE).add(O)}canStopAtTile(S,O,B){if(S.zone===q.ZoneType.Air){if((!S.isAircraft()||!S.airportBoundTrait)&&!S.rules.spawned&&(!this.options?.forceMove||!S.rules.balloonHover||S.rules.hoverAttack)&&(!this.game.map.terrain.getPassableSpeed(O,D.SpeedType.Amphibious,!1,B)||this.game.map.getObjectsOnTile(O).filter(B=>B.isBuilding()&&!B.isDestroyed&&!B.dockTrait?.hasReservedDockForUnit(S)&&!S.rules.dock.includes(B.name)||B.isUnit()&&B.tile===O&&B.moveTrait.moveState!==F.MoveState.Moving&&B!==S).length))return!1}else if(S.isInfantry()){let N=this.game.map.getGroundObjectsOnTile(O).filter(N=>N.isInfantry()&&N.tile===O&&N.onBridge===B&&N.moveTrait.moveState!==F.MoveState.Moving&&N!==S);if(2<N.length||N.find(O=>O.position.subCell===S.position.subCell))return!1}return!(S.zone!==q.ZoneType.Air&&S.rules.tooBigToFitUnderBridge&&!B&&O.onBridgeLandType&&this.game.map.tileOccupation.getBridgeOnTile(O)?.isHighBridge()||!this.isCancelling()&&this.options?.strictCloseEnough&&void 0!==this.options?.closeEnoughTiles&&!this.isCloseEnoughToDest(S,O,this.options.closeEnoughTiles))}isCloseEnoughToDest(S,O,B){return void 0===B||!(new W.RangeHelper(this.game.map.tileOccupation).tileDistance(this.targetTile,O)>B)}hasReachedDestination(S){return!this.path.length}updateTarget(S,O){this.targetTile=S,this.toBridge=O,this.needsPathUpdate=!0,this.targetChangeRequested=!0}onEnd(S){S.moveTrait.collisionState=F.CollisionState.Resolved,S.moveTrait.currentWaypoint=void 0,this.targetOffset.equals(this.computeTargetOffset(S))||(S.moveTrait.lastTargetOffset=this.targetOffset)}forceCancel(S){return!(!this.cancellable||this.children.some(S=>!S.cancellable)||!this.options?.allowOutOfBoundsTarget&&!this.game.map.isWithinBounds(S.tile)||(this.status!==$.TaskStatus.Running&&this.status!==$.TaskStatus.Cancelling||(S.moveTrait.unreservePathNodes(),S.moveTrait.lastMoveResult=F.MoveResult.Cancel,this.onEnd(S),S.moveTrait.lastTargetOffset=this.targetOffset,S.moveTrait.lastVelocity=S.moveTrait.velocity.clone()),this.status=$.TaskStatus.Cancelled,0))}onTick(S){if(S.moveTrait.isDisabled()&&S.moveTrait.moveState===F.MoveState.ReachedNextWaypoint)return!!this.isCancelling()&&(S.moveTrait.lastMoveResult=F.MoveResult.Cancel,!0);this.needsPathUpdate&&(S.moveTrait.moveState===F.MoveState.PlanMove&&(this.inPlanningForTicks=void 0,S.moveTrait.currentWaypoint=void 0,S.moveTrait.collisionState=F.CollisionState.Resolved,S.moveTrait.moveState=F.MoveState.ReachedNextWaypoint,S.moveTrait.velocity.set(0,0,0)),this.computePath(S,S.moveTrait.locomotor),this.path.length||this.unreachableTargets.push({tile:this.targetTile,toBridge:this.toBridge}),this.updateDestination(this.path,this.targetOffset),this.targetLinesConfig.isRecalc=!this.targetChangeRequested,this.targetChangeRequested=!1,this.needsPathUpdate=!1,this.allObstaclesAreBlockers=!1);let O=this.game.map;if(S.moveTrait.moveState===F.MoveState.ReachedNextWaypoint){S.moveTrait.unreservePathNodes();var B=this.path.findIndex(O=>O===S.moveTrait.currentWaypoint);if(-1!==B?this.path.splice(B):this.path.pop(),S.moveTrait.currentWaypoint=void 0,this.isCancelling()?!this.cancelProcessed:this.hasReachedDestination(S)){var N=!this.isCancelling()&&!this.isCloseEnoughToDest(S,S.tile,this.options?.closeEnoughTiles);if(!N&&this.canStopAtTile(S,S.tile,S.onBridge))return S.moveTrait.lastMoveResult=this.isCancelling()?F.MoveResult.Cancel:F.MoveResult.Success,!0;{if(this.unreachableTargets.length>5)return S.moveTrait.lastMoveResult=F.MoveResult.Fail,this.log(S,"bail_max_unreachable_dest"),!0;let j=S.tile,L=S.onBridge?O.tileOccupation.getBridgeOnTile(j):void 0;return N&&(j=this.targetTile,L=this.toBridge?O.tileOccupation.getBridgeOnTile(j):void 0),(B=this.findRelocationTile(j,L,S))?(N=!L||L.isHighBridge()?O.tileOccupation.getBridgeOnTile(B):void 0,this.updateTarget(B,!!N),this.isCancelling()&&(this.cancelProcessed=!0,this.cancelRepositionPending=!0),!1):(S.moveTrait.lastMoveResult=N?F.MoveResult.Fail:F.MoveResult.CloseEnough,this.log(S,"bail_no_free_dest"),!0)}}if(this.cancelProcessed&&!this.path.length)return S.moveTrait.lastMoveResult=F.MoveResult.Cancel,!0;this.cancelProcessed=!1,S.moveTrait.moveState=F.MoveState.PlanMove;let j=S.moveTrait.locomotor;if(S.moveTrait.currentWaypoint=j.selectNextWaypoint?j.selectNextWaypoint(S,this.path):this.path[this.path.length-1],this.currentWaypointLeptons.set(S.moveTrait.currentWaypoint.tile.rx,S.moveTrait.currentWaypoint.tile.ry).multiplyScalar(K.Coords.LEPTONS_PER_TILE).add(this.targetOffset),N=j.onNewWaypoint(S,this.currentWaypointLeptons,this.destinationLeptons))return this.children.push(...N),!1}if(S.moveTrait.moveState===F.MoveState.PlanMove){if(this.isCancelling()&&!this.cancelRepositionPending)return S.moveTrait.currentWaypoint=void 0,S.moveTrait.moveState=F.MoveState.ReachedNextWaypoint,this.onTick(S);if(this.inPlanningForTicks=void 0===this.inPlanningForTicks?0:this.inPlanningForTicks+1,this.inPlanningForTicks>200)return this.needsPathUpdate=!0,this.allObstaclesAreBlockers=!0,S.moveTrait.velocity.set(0,0,0),this.log(S,"repath_plan_timeout"),!1;if(S.rules.movementZone!==j.MovementZone.Fly&&!S.moveTrait.locomotor.ignoresTerrain){let B=this.path.slice(this.path.indexOf(S.moveTrait.currentWaypoint)).reverse();var H,V,W,z,$=S.moveTrait.velocity.length();for(H of B)H.onBridge?.isDestroyed&&(H.onBridge=void 0);for(V of B){if(!O.terrain.getPassableSpeed(V.tile,S.rules.speedType,S.isInfantry(),!!V.onBridge,this.options?.ignoredBlockers))return this.options?.stopOnBlocker&&O.terrain.findObstacles(V,S).some(S=>S.obj===this.options.stopOnBlocker)?(S.moveTrait.lastMoveResult=F.MoveResult.CloseEnough,!0):(this.needsPathUpdate=!0,S.moveTrait.currentWaypoint=void 0,S.moveTrait.moveState=F.MoveState.ReachedNextWaypoint,this.onTick(S));if(!V.onBridge){var Q=O.getGroundObjectsOnTile(V.tile).find(S=>S.isOverlay()&&S.rules.crate);if(Q&&this.game.crateGeneratorTrait.peekInsideCrate(Q)===J.PowerupType.Unit&&(this.game.crateGeneratorTrait.pickupCrate(S,Q,this.game),Q=this.game.map.getGroundObjectsOnTile(V.tile).find(S=>S.isUnit()&&!S.onBridge),Q))return this.needsPathUpdate=!0,this.blockedPathNodes.push({node:V,obj:Q}),S.moveTrait.currentWaypoint=void 0,S.moveTrait.moveState=F.MoveState.ReachedNextWaypoint,this.onTick(S)}for(W of O.terrain.findObstacles(V,S).filter(S=>!this.options?.ignoredBlockers?.includes(S.obj))){if(W.static)return this.needsPathUpdate=!0,S.moveTrait.currentWaypoint=void 0,S.moveTrait.moveState=F.MoveState.ReachedNextWaypoint,this.onTick(S);if(W.obj.rules.crushable){if([D.SpeedType.Track,D.SpeedType.Hover].includes(S.rules.speedType)&&S.crusher&&(!W.obj.isTechno()||!this.game.areFriendly(W.obj,S)))continue;if(!W.obj.isTechno())return this.needsPathUpdate=!0,S.moveTrait.currentWaypoint=void 0,S.moveTrait.moveState=F.MoveState.ReachedNextWaypoint,this.onTick(S)}if(W.obj.isTerrain()){if(!S.isInfantry())throw new Error(`Obstacle ${W.obj.name} should be a blocker for non infantry`);var Z=this.findFreeSubCell(S,V);return void 0!==Z?this.relocateToSubCell(S,Z):(this.needsPathUpdate=!0,this.blockedPathNodes.push({node:V,obj:W.obj}),S.moveTrait.currentWaypoint=void 0,S.moveTrait.moveState=F.MoveState.ReachedNextWaypoint),this.onTick(S)}if(!W.obj.isTechno())throw new Error("Unexpected obstacle of type "+W.obj.type);const N=W.obj;var re=N.isUnit()?N.moveTrait.velocity.length():0;if(!N.isAircraft()||N.zone!==q.ZoneType.Ground||!this.options?.ignoredBlockers?.some(S=>S.isBuilding()&&S.dockTrait?.isDocked(N))){if(1===B.length&&N.isUnit()&&re&&$&&$<=re&&S.direction===N.direction&&N.tile===V.tile&&N.moveTrait.currentWaypoint?.tile!==V.tile)break;if(N.isBuilding()||N.moveTrait.moveState===F.MoveState.Idle||N.moveTrait.collisionState!==F.CollisionState.Resolved){if(!$&&S.moveTrait.collisionState!==F.CollisionState.Resolved&&N.isUnit()&&N.moveTrait.collisionState!==F.CollisionState.Resolved)return this.inPlanningForTicks+1>200&&(this.needsPathUpdate=!0,this.allObstaclesAreBlockers=!0,this.log(S,"repath_waited_too_long_blocker "+N.id),S.moveTrait.velocity.set(0,0,0)),!1;{if(N.isInfantry()&&S.isInfantry()&&N.moveTrait.collisionState===F.CollisionState.Resolved){var se=this.findFreeSubCell(S,V);if(void 0!==se)return this.relocateToSubCell(S,se),this.onTick(S)}if(Z=L.findIndexReverse(this.path.slice(0,this.path.indexOf(V)),B=>!O.terrain.findObstacles(B,S).filter(S=>!this.options?.ignoredBlockers?.includes(S.obj)).length),-1===Z){if(this.canStopAtTile(S,S.tile,S.onBridge)&&this.isCloseEnoughToDest(S,S.tile,this.options?.closeEnoughTiles))return S.moveTrait.lastMoveResult=F.MoveResult.CloseEnough,this.log(S,"bail_waypoints_blocked_close_enough"),!0;if(!(0===this.options?.closeEnoughTiles||Math.abs(S.tile.rx-this.targetTile.rx)<=1&&Math.abs(S.tile.ry-this.targetTile.ry)<=1))return this.needsPathUpdate=!0,this.blockedPathNodes.push(...this.path.slice(0,this.path.indexOf(V)+1).map(B=>({node:B,obj:O.terrain.findObstacles(B,S)[0].obj}))),S.moveTrait.velocity.set(0,0,0),this.log(S,"repath_waypoints_blocked_too_far"),!1}let j;return j=-1!==Z?(se=this.path[Z],O.terrain.computePath(S.rules.speedType,S.isInfantry(),S.tile,S.onBridge,se.tile,!!se.onBridge,{maxExpandedNodes:15,bestEffort:!1,excludeTiles:B=>!!O.terrain.findObstacles(B,S).filter(S=>!this.options?.ignoredBlockers?.includes(S.obj)).length,ignoredBlockers:this.options?.ignoredBlockers})):[],j.length||N.owner!==S.owner||1!==B.length?j.length?(this.path.splice(Z,this.path.length,...j),S.moveTrait.currentWaypoint=void 0,S.moveTrait.moveState=F.MoveState.ReachedNextWaypoint,this.onTick(S)):((ne=this.selectWeaponVsObstacle(S,N))?(this.children.push(S.attackTrait.createAttackTask(this.game,N,N.tile,ne,{passive:!0,holdGround:!0})),S.moveTrait.velocity.set(0,0,0)):this.options?.forceWaitOnPathBlocked?(this.children.push(new _.WaitTicksTask(40)),this.inPlanningForTicks=0,S.moveTrait.velocity.set(0,0,0),S.moveTrait.collisionState=F.CollisionState.Waiting):(this.needsPathUpdate=!0,this.blockedPathNodes.push({node:V,obj:N}),N.isBuilding()&&(this.allObstaclesAreBlockers=!0),this.log(S,"repath_unavoidable_blocker "+N.id),S.moveTrait.velocity.set(0,0,0)),!1):(ne=N.unitOrderTrait.hasTasks(),this.pushTried||N.isBuilding()||N.moveTrait.collisionState===F.CollisionState.Waiting||ne||N.isAircraft()&&N.missileSpawnTrait?(!this.options?.forceWaitOnPathBlocked&&(N.isBuilding()||ne&&N.moveTrait.moveState===F.MoveState.Idle||this.inPlanningForTicks+40>200)?(this.needsPathUpdate=!0,this.allObstaclesAreBlockers=!0,this.log(S,"repath_blocker_busy_wait_timeout "+N.id),S.moveTrait.velocity.set(0,0,0)):(this.children.push(new _.WaitTicksTask(40)),this.options?.forceWaitOnPathBlocked?this.inPlanningForTicks=0:this.inPlanningForTicks+=40,S.moveTrait.velocity.set(0,0,0),S.moveTrait.collisionState=F.CollisionState.Waiting),!1):(ne=new ie.Vector2(N.tile.rx-S.tile.rx,N.tile.ry-S.tile.ry),this.pushTried=!0,N.unitOrderTrait.addTask(new U.MoveAsideTask(this.game,ne)),this.children.push(new _.WaitTicksTask(1)),S.moveTrait.velocity.set(0,0,0),S.moveTrait.collisionState=F.CollisionState.Waiting,this.log(S,"push "+N.id),!1))}}if(N.isInfantry()&&S.isInfantry()){var ne=this.findFreeSubCell(S,V);if(void 0!==ne)return this.relocateToSubCell(S,ne),this.onTick(S)}if(!$)return this.inPlanningForTicks>40&&(S.moveTrait.collisionState=F.CollisionState.Waiting),!1;if(180===Math.abs(S.direction-N.direction))return S.moveTrait.velocity.set(0,0,0),S.moveTrait.collisionState=F.CollisionState.Waiting,!1;if(Math.abs(S.direction-N.direction)<=45&&1.5*re<$){if(5<=(re=this.path.indexOf(V))){let B=L.findIndexReverse(this.path.slice(0,re-5),B=>!O.terrain.findObstacles(B,S).length);if(-1!==B&&(re=this.path[B],re=O.terrain.computePath(S.rules.speedType,S.isInfantry(),S.tile,S.onBridge,re.tile,!!re.onBridge,{maxExpandedNodes:15,bestEffort:!1,excludeTiles:N=>!!O.terrain.findObstacles(N,S).length||this.path.findIndex(S=>S.tile===N.tile&&S.onBridge===N.onBridge)>B}),re.length))return this.path.splice(B,this.path.length,...re),S.moveTrait.currentWaypoint=void 0,S.moveTrait.moveState=F.MoveState.ReachedNextWaypoint,this.onTick(S)}return S.moveTrait.collisionState=F.CollisionState.Waiting,S.moveTrait.velocity.set(0,0,0),!1}return S.moveTrait.velocity.set(0,0,0),S.moveTrait.collisionState=F.CollisionState.Waiting,!1}}}if(S.rules.speedType===D.SpeedType.Track&&$&&0<(oe=this.path.indexOf(S.moveTrait.currentWaypoint))){let B=this.path[oe-1];for(z of O.getGroundObjectsOnTile(B.tile).filter(O=>O.isUnit()&&O.onBridge===!!B.onBridge&&O.rules.crushable&&O.veteranTrait?.hasVeteranAbility(te.VeteranAbility.SCATTER)&&!this.game.areFriendly(O,S)))z.unitOrderTrait.hasTasks()||z.unitOrderTrait.addTask(new ee.ScatterTask(this.game))}S.moveTrait.reservedPathNodes.length||(S.moveTrait.reservedPathNodes.push(...B),B.forEach(B=>{O.tileOccupation.occupySingleTile(B.tile,S)}))}S.moveTrait.moveState=F.MoveState.Moving,this.inPlanningForTicks=void 0,this.unreachableTargets.length=0,this.pushTried=!1,S.moveTrait.collisionState===F.CollisionState.Waiting&&(S.moveTrait.collisionState=F.CollisionState.Resolved)}if(S.moveTrait.moveState===F.MoveState.Moving){let O=S.moveTrait.locomotor,{distance:B,done:j,isTeleport:D}=O.tick(S,this.currentWaypointLeptons,this.destinationLeptons,(this.isCancelling()||!this.path.length)&&!this.cancelRepositionPending);if(D&&S.traits.filter(X.NotifyTeleport).forEach(O=>{O[X.NotifyTeleport.onBeforeTeleport](S,this.game,!0,!0)}),B.length()&&(N=S.tile,oe=O.allowOutOfBounds,B.y?(ae=S.tileElevation,S.position.moveByLeptons3(B,oe),S.moveTrait.handleElevationChange(ae,this.game)):S.position.moveByLeptons(B.x,B.z,oe),S.tile!==N)){var ae=S.onBridge?this.game.map.tileOccupation.getBridgeOnTile(N):void 0,oe=L.findReverse(this.path,O=>O.tile===S.tile);let O=oe?oe.onBridge:ae||S.moveTrait.currentWaypoint.onBridge?this.game.map.tileOccupation.getBridgeOnTile(S.tile):void 0;if(O?.isDestroyed&&(O=void 0),S.moveTrait.handleTileChange(N,O,!1,this.game,D),D&&(S.moveTrait.lastTeleportTick=this.game.currentTick,this.game.events.dispatch(new Y.ObjectTeleportEvent(S,!0,N))),S.isDestroyed)return!0}if(j)return S.moveTrait.moveState=F.MoveState.ReachedNextWaypoint,this.onTick(S)}return!1}selectWeaponVsObstacle(S,O){let B;if(!this.game.areFriendly(O,S)&&S.attackTrait&&!S.attackTrait.isDisabled()&&S.attackTrait.isIdle()&&(B=S.attackTrait.selectWeaponVersus(S,O,this.game,!1,!0))&&B.name!==S.armedTrait?.deathWeapon?.name&&(!B.rules.limboLaunch||!B.warhead.rules.parasite)&&!B.warhead.rules.mindControl)return B}findRelocationTile(S,O,B){let N,L=this.game.map;if(B.rules.movementZone===j.MovementZone.Fly){var n=S=>!L.tileOccupation.getGroundObjectsOnTile(S).some(S=>S.isBuilding()&&!S.isDestroyed||S.isTerrain()||S.isOverlay()&&S.rules.isARock);N=new Z.RandomTileFinder(L.tiles,L.mapBounds,S,1,this.game,n).getNextTile(),N||(N=new V.RadialTileFinder(L.tiles,L.mapBounds,S,B.getFoundation(),2,15,n).getNextTile())}else{let j=!this.options?.ignoredBlockers?.length&&L.terrain.getPassableSpeed(B.tile,B.rules.speedType,B.isInfantry(),B.onBridge)?this.game.map.terrain.getIslandIdMap(B.rules.speedType,B.isInfantry()):void 0,D=j?.get(B.tile,B.onBridge),F=new H.MovePositionHelper(L),_=new V.RadialTileFinder(L.tiles,L.mapBounds,S,{width:1,height:1},0,5,N=>{let _=!O||O.isHighBridge()?L.tileOccupation.getBridgeOnTile(N):void 0;return!this.unreachableTargets.find(S=>S.tile===N&&S.toBridge===!!_)&&(B.zone===q.ZoneType.Air||j?.get(N,!!_)===D&&!L.terrain.findObstacles({tile:N,onBridge:_},B).length&&F.isEligibleTile(N,_,O,S))&&this.canStopAtTile(B,N,!!_)});N=_.getNextTile()}return N}findFreeSubCell(S,O){let B=this.game.map.getGroundObjectsOnTile(O.tile);var j=B.filter(B=>B.isInfantry()&&B.onBridge===!!O.onBridge&&B!==S).map(S=>S.position.desiredSubCell),L=B.filter(S=>S.isTerrain()).map(S=>S.rules.getOccupiedSubCells(this.game.map.getTheaterType())).flat();let D=[...j,...L];return N.Infantry.SUB_CELLS.find(S=>-1===D.indexOf(S))}relocateToSubCell(S,O){S.position.desiredSubCell=O;var B=S.position.computeSubCellOffset(O);this.targetOffset=B,this.currentWaypointLeptons.set(S.moveTrait.currentWaypoint.tile.rx,S.moveTrait.currentWaypoint.tile.ry).multiplyScalar(K.Coords.LEPTONS_PER_TILE).add(this.targetOffset),this.updateDestination(this.path,this.targetOffset),S.moveTrait.locomotor.onWaypointUpdate?.(S,this.currentWaypointLeptons,this.destinationLeptons)}getTargetLinesConfig(S){var O,B;return this.path||(O=new Q.LocomotorFactory(this.game).create(S),(this.options?.allowOutOfBoundsTarget||this.game.map.mapBounds.isWithinBounds(this.targetTile))&&S.rules.movementZone!==j.MovementZone.Fly&&!O.ignoresTerrain&&S.unitOrderTrait.getCurrentTask()?.isCancelling()?this.groundPathPlan||(B=this.computeGroundPath(S),this.targetLinesConfig.pathNodes=B.path,B.path.length&&(this.groundPathPlan=B)):((B=S.moveTrait).locomotor??(B.locomotor=O),this.computePath(S,S.moveTrait.locomotor)),this.targetLinesConfig.isRecalc=!1),this.targetLinesConfig}log(S,O){this.logger.debug(`<${S.id}>: `+O)}},S("MoveTask",re)}}}),System.register("game/gameobject/task/move/MoveToBlockTask",["game/gameobject/trait/MoveTrait","game/gameobject/task/system/Task","game/gameobject/task/move/MoveTask"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends N.Task{constructor(S,O){super(),this.game=S,this.target=O,this.preventOpportunityFire=!1,this.useChildTargetLines=!0,this.attackPerformed=!1}onStart(S){this.children.push(new j.MoveTask(this.game,this.target.centerTile,!1,{closeEnoughTiles:1,pathFinderIgnoredBlockers:[this.target],stopOnBlocker:this.target}))}onTick(S){if(this.attackPerformed||this.isCancelling()||!S.attackTrait||S.attackTrait.isDisabled())return!0;if(S.moveTrait.lastMoveResult!==B.MoveResult.CloseEnough)return!0;var O=S.attackTrait.selectWeaponVersus(S,this.target,this.game,!0);return!(O&&(this.children.push(S.attackTrait.createAttackTask(this.game,this.target,this.target.tile,O,{force:!0})),this.attackPerformed=!0))}},S("MoveToBlockTask",L)}}}),System.register("game/gameobject/task/system/CallbackTask",["game/gameobject/task/system/Task"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.Task{constructor(S){super(),this.cb=S}onTick(S){return this.cb(S),!0}},S("CallbackTask",N)}}}),System.register("game/gameobject/task/system/TargetLinesConfig",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("cloneConfig",S=>S?{...S}:void 0),S("configsAreEqual",(S,O)=>!S&&!O||S?.isAttack===O?.isAttack&&S?.pathNodes===O?.pathNodes&&S?.target===O?.target),S("configHasTarget",S=>!(!S?.pathNodes.length&&!S?.target))}}}),System.register("game/gameobject/task/system/Task",["game/gameobject/task/system/TaskStatus"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("Task",class{constructor(){this.status=B.TaskStatus.NotStarted,this.children=[],this.cancellable=!0,this.useChildTargetLines=!1,this.blocking=!0,this.waitingForChildrenToFinish=!1,this.preventOpportunityFire=!0,this.preventLanding=!0,this.isAttackMove=!1}isRunning(){return this.status===B.TaskStatus.Running}isCancelling(){return this.status===B.TaskStatus.Cancelling}setCancellable(S){return this.cancellable=S,this}setBlocking(S){return this.blocking=S,this}onStart(S){}onEnd(S){}cancel(){if(this.cancellable)if(this.status===B.TaskStatus.Running)this.status=B.TaskStatus.Cancelling,this.children.length&&this.children.forEach(S=>S.cancel());else if(this.status===B.TaskStatus.NotStarted&&(this.status=B.TaskStatus.Cancelled,this.children.length))throw new Error("Should't have any children before starting a task")}getTargetLinesConfig(S){}})}}}),System.register("game/gameobject/task/system/TaskGroup",["game/gameobject/task/system/Task"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.Task{constructor(...S){super(),this.children.push(...S)}onTick(S){return!0}},S("TaskGroup",N)}}}),System.register("game/gameobject/task/system/TaskRunner",["game/gameobject/task/system/TaskStatus"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("TaskRunner",class{tick(S,O){this.tickChildren(S,O)}startTask(S,O){if(S.status!==B.TaskStatus.NotStarted)throw new Error("Attempted to start a task with status "+S.status);S.status=B.TaskStatus.Running,S.onStart(O)}tickTask(S,O){let N=this.tickChildren(S.children,O);var j=S.children.find(S=>S.blocking);if(!N&&j)return!1;if(!O.isSpawned)return!1;if(S.status===B.TaskStatus.NotStarted)throw new Error("Attempted tick on a non-started task");if(S.isRunning()||S.isCancelling()){var L=S.isCancelling(),D=!!S.waitingForChildrenToFinish||S.onTick(O);return S.children.length&&!j&&D&&(N=S.children.every(S=>S.status===B.TaskStatus.Cancelled||S.status===B.TaskStatus.Finished),S.waitingForChildrenToFinish=!N),(D=D&&N)&&(S.onEnd(O),S.status=L?B.TaskStatus.Cancelled:B.TaskStatus.Finished),D}return!0}tickChildren(S,O){let N=!0;if(S.length){let L,D=new Set;for(;O.isSpawned&&(L=S.find(S=>!D.has(S)));){let F;if(L.status===B.TaskStatus.NotStarted&&this.startTask(L,O),L.status===B.TaskStatus.Running||L.status===B.TaskStatus.Cancelling)F=!0===this.tickTask(L,O);else{if(L.status!==B.TaskStatus.Cancelled)throw new Error("Unhandled task status "+B.TaskStatus[L.status]);F=!0}if(F){var j=S.indexOf(L);-1!==j&&S.splice(j,1)}else{if(N=!1,L.blocking)break;D.add(L)}}}return N}})}}}),System.register("game/gameobject/task/system/TaskStatus",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("TaskStatus",B={}))[O.NotStarted=0]="NotStarted",O[O.Running=1]="Running",O[O.Finished=2]="Finished",O[O.Cancelling=3]="Cancelling",O[O.Cancelled=4]="Cancelled"}}}),System.register("game/gameobject/task/system/WaitMinutesTask",["game/gameobject/task/system/WaitTicksTask","game/GameSpeed"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends B.WaitTicksTask{constructor(S){super(Math.floor(N.GameSpeed.BASE_TICKS_PER_SECOND*S*60))}},S("WaitMinutesTask",j)}}}),System.register("game/gameobject/task/system/WaitTicksTask",["game/gameobject/task/system/Task"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.Task{constructor(S){super(),this.ticks=S}onTick(){return!(!this.isCancelling()&&0<this.ticks--)}},S("WaitTicksTask",N)}}}),System.register("game/gameobject/trait/AgentTrait",["game/rules/TechnoRules","util/math"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("AgentTrait",class{infiltrate(S,O,j){var L,D;O.rules.radar&&![...O.owner.buildings].some(S=>S.rules.spySat)&&j.mapShroudTrait.resetShroud(O.owner,j),0<O.rules.power&&(L=j.rules.general.spyPowerBlackout,O.owner.powerTrait?.setBlackoutFor(L,j)),O.superWeaponTrait&&O.superWeaponTrait.getSuperWeapon(O)?.resetTimer(),0<O.rules.storage&&(D=N.clamp(j.rules.general.spyMoneyStealPercent,0,1),D=Math.floor(O.owner.credits*D),O.owner.credits-=D,S.owner.credits+=D),!j.rules.ai.buildTech.includes(O.name)||void 0!==(D=O.rules.aiBasePlanningSide)&&S.owner.production.addStolenTech(D),O.factoryTrait&&[B.FactoryType.InfantryType,B.FactoryType.UnitType].includes(O.factoryTrait.type)&&S.owner.production?.addVeteranType(O.factoryTrait.type)}})}}}),System.register("game/gameobject/trait/AirSpawnTrait",["game/Coords","engine/type/ObjectType","game/Warhead","game/gameobject/unit/CollisionType","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/unit/FacingUtil","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyWarpChange","game/gameobject/unit/ZoneType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S}],execute:function(){Z=class{constructor(){this.spawns=[],this.storage=[],this.missileLaunches=[],this.nextRegenTicks=[]}get availableSpawns(){return this.storage.length}debugSetStorage(S,O){this.storage.length=O,this.storage.fill(S,0,O)}isLaunchingMissiles(){return 0<this.missileLaunches.length}[W.NotifySpawn.onSpawn](S,O){var B=O.rules.getObject(S.rules.spawns,N.ObjectType.Aircraft);for(let N=0;N<S.rules.spawnsNumber;N++)this.pushNewSpawn(B,O,S)}[$.NotifyUnspawn.onUnspawn](S,O){this.destroySpawns(S,O)}[H.NotifyDestroy.onDestroy](S,O,B,N){this.destroySpawns(S,O,B,N)}pushNewSpawn(S,O,B){let N=O.createUnitForPlayer(S,B.owner);N.limboData={selected:!1,controlGroup:void 0},S.missileSpawn&&(N.pitch=90*O.rules.general.getMissileRules(S.name).pitchInitial),this.spawns.push(N),this.storage.push(N)}destroySpawns(S,O,B,N){for(var j of this.spawns)j.isDestroyed||(j.isSpawned&&!j.rules.missileSpawn&&j.crashableTrait?j.crashableTrait.crash(B):(j.isSpawned||(j.armedTrait&&(j.armedTrait.deathWeapon=void 0),j.position.tileElevation=S.position.tileElevation,j.zone=S.isUnit()?S.zone:Q.ZoneType.Ground,j.onBridge=!!S.isUnit()&&S.onBridge,j.position.tile=S.tile),O.destroyObject(j,B,N)));this.spawns.length=0,this.storage.length=0,this.missileLaunches.length=0}[K.NotifyTick.onTick](S,O){var j;if(this.spawns=this.spawns.filter(S=>!S.isDestroyed),this.missileLaunches=this.missileLaunches.filter(S=>!S.missile.isDestroyed),this.spawns.length<S.rules.spawnsNumber){var H=S.rules.spawnsNumber-this.spawns.length,V=O.rules.getObject(S.rules.spawns,N.ObjectType.Aircraft);for(let B=0;B<H;B++)V.missileSpawn&&B&&void 0===this.nextRegenTicks[B]?this.nextRegenTicks[B]=this.nextRegenTicks[0]:((j=this.nextRegenTicks)[B]??(j[B]=S.rules.spawnRegenRate),0<this.nextRegenTicks[B]&&this.nextRegenTicks[B]--),this.nextRegenTicks[B]<=0&&this.pushNewSpawn(V,O,S);this.nextRegenTicks=this.nextRegenTicks.filter(S=>0<S)}if(this.storage.length){if(this.nextReloadTicks??(this.nextReloadTicks=S.rules.spawnReloadRate),0<this.nextReloadTicks&&this.nextReloadTicks--,this.nextReloadTicks<=0){for(var W of this.storage)W.ammoTrait&&W.ammoTrait.ammo<W.ammoTrait.maxAmmo&&W.ammoTrait.ammo++;this.nextReloadTicks=S.rules.spawnReloadRate}}else this.nextReloadTicks=void 0;for(let N of this.missileLaunches.slice()){var z=O.rules.general.getMissileRules(N.missile.name);if(N.pauseFrames??(N.pauseFrames=z.pauseFrames),0<N.pauseFrames&&N.pauseFrames--,N.pauseFrames<=0){var K=90*z.pitchFinal;z=90*(z.pitchFinal-z.pitchInitial)/z.tiltFrames;let j=N.missile;if(j.pitch<K)j.pitch=Math.min(K,j.pitch+z);else{if(j.unitOrderTrait.addTask(new _.TaskGroup(new D.MoveTask(O,N.targetTile,!!N.targetBridge),new F.CallbackTask(()=>{var D,F;j.isDestroyed||(O.unspawnObject(j),j.dispose(),F=B.Coords.vecGroundToWorld(U.FacingUtil.toMapCoords(j.direction).multiplyScalar(1)),D=N.targetWorldPos.clone().add(F),F=O.map.getTileZone(N.targetTile),N.warhead.detonate(O,N.damage,N.targetTile,N.targetBridge?.tileElevation??0,D,F,N.targetBridge?L.CollisionType.OnBridge:L.CollisionType.None,N.target,{player:j.owner,obj:S,weapon:void 0}))})).setCancellable(!1)),-1===(z=this.spawns.indexOf(j)))throw new Error("Missile not found in spawns list");this.spawns.splice(z,1),this.missileLaunches.splice(this.missileLaunches.indexOf(N),1)}}}}[V.NotifyOwnerChange.onChange](S,O,B){for(var N of this.spawns)N.isDestroyed||B.changeObjectOwner(N,S.owner)}[q.NotifyWarpChange.onChange](S,O,B){B&&this.removeMissileLaunches(O)}[z.NotifyTeleport.onBeforeTeleport](S,O,B,N){N||this.removeMissileLaunches(O)}removeMissileLaunches(S){if(this.missileLaunches.length){for(var O of this.missileLaunches){if(S.unspawnObject(O.missile),O.missile.dispose(),-1===(O=this.spawns.indexOf(O.missile)))throw new Error("Missile not found in spawns list");this.spawns.splice(O,1)}this.missileLaunches.length=0}}prepareLaunch(S,O,B){if(this.storage.length){let D=this.storage[0];if(!D.ammo)return;if(this.storage.shift(),D.missileSpawnTrait){let F,_;var N=S.veteranTrait?.isElite(),L=B.rules;if(S.rules.spawns===L.general.v3Rocket.type)F=N?L.combatDamage.v3EliteWarhead:L.combatDamage.v3Warhead,_=N?L.general.v3Rocket.eliteDamage:L.general.v3Rocket.damage;else{if(S.rules.spawns!==L.general.dMisl.type)throw new Error(`Unhandled missile type "${S.rules.spawns}"`);F=N?L.combatDamage.dMislEliteWarhead:L.combatDamage.dMislWarhead,_=N?L.general.dMisl.eliteDamage:L.general.dMisl.damage}L=new j.Warhead(B.rules.getWarhead(F)),D.missileSpawnTrait.setDamage(_).setWarhead(L).setLauncher(S),this.missileLaunches.push({missile:D,targetTile:(O.obj?.isUnit()?O.obj:O).tile,targetBridge:O.getBridge(),targetWorldPos:O.getWorldCoords().clone(),target:O,warhead:L,damage:_,pauseFrames:void 0})}else{if(!D.spawnLinkTrait)throw new Error(`Aircraft "${D.name}" must have Spawned=yes to be launchable`);D.spawnLinkTrait.setParent(S)}return D}}storeAircraft(S,O){if(!this.spawns.includes(S))throw new Error(`Object "${S.name}#${S.id}" not found in list of linked spawns`);if(S.limboData)throw new Error(`Object "${S.name}#${S.id}" is already in limbo`);O.limboObject(S,{selected:!1,controlGroup:void 0}),this.storage.push(S)}},S("AirSpawnTrait",Z)}}}),System.register("game/gameobject/trait/AirportBoundTrait",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("AirportBoundTrait",class{constructor(S){this.airportNames=S}findAvailableAirport(S){return[...S.owner.buildings].find(S=>S.dockTrait&&this.airportNames.includes(S.name)&&0<S.dockTrait.getAvailableDockCount())}})}}}),System.register("game/gameobject/trait/AmmoTrait",["util/math"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("AmmoTrait",class{constructor(S,O=S){this.maxAmmo=S,this.ammo=O}get ammo(){return this._ammo}set ammo(S){this._ammo=B.clamp(S,0,this.maxAmmo)}isFull(){return this.ammo===this.maxAmmo}})}}}),System.register("game/gameobject/trait/ArmedTrait",["game/Weapon","game/WeaponType","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/unit/VeteranLevel","util/typeGuard"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class{constructor(S,O){this.gameObject=S,this.rules=O,this.specialWeaponIndex=0;var B=S.veteranLevel===D.VeteranLevel.Elite;S.rules.weaponCount?(this.selectSpecialWeapon(0,B),this.guardWeaponRangeOverride=this.primaryWeapon?.range):this.selectStandardWeapons(B)}selectStandardWeapons(S=!1){var O=this.gameObject,j=S&&O.rules.elitePrimary||O.rules.primary;j?(D=S?O.art.elitePrimaryFireFlh:O.art.primaryFireFlh,this.primaryWeapon=B.Weapon.factory(j,N.WeaponType.Primary,O,this.rules,D)):this.primaryWeapon=void 0;var L,D=S&&O.rules.eliteSecondary||O.rules.secondary;D?(L=S?O.art.eliteSecondaryFireFlh:O.art.secondaryFireFlh,this.secondaryWeapon=B.Weapon.factory(D,N.WeaponType.Secondary,O,this.rules,L)):this.secondaryWeapon=void 0,(O.explodes||O.crashableTrait)&&(L=O.rules.deathWeapon||!!O.crashableTrait&&this.secondaryWeapon?.rules.name||this.primaryWeapon?.rules.name||this.rules.combatDamage.deathWeapon,this.deathWeapon=B.Weapon.factory(L,N.WeaponType.DeathWeapon,O,this.rules))}selectSpecialWeapon(S,O=!1){let j=this.gameObject;var L=j.rules.weaponCount;if(L<1)throw new Error(`Object "${j.name}" doesn't support special weapons`);if(L-1<S)throw new RangeError(`Weapon index ${S} out of bounds (max ${L}) for object `+j.name);var D=O&&j.rules.getEliteWeaponAtIndex(S)||j.rules.getWeaponAtIndex(S);if(!D)throw new Error(`Missing weapon at index ${S} for object "${j.name}"`);L=j.art.getSpecialWeaponFlh(S),this.primaryWeapon=B.Weapon.factory(D,N.WeaponType.Primary,j,this.rules,L),this.secondaryWeapon=void 0,this.specialWeaponIndex=S,this.deathWeapon=this.primaryWeapon.rules.suicide?B.Weapon.factory(j.rules.deathWeapon||this.primaryWeapon.name,N.WeaponType.DeathWeapon,j,this.rules):void 0}toggleEliteWeapons(S){this.gameObject.rules.weaponCount?this.selectSpecialWeapon(this.specialWeaponIndex,S):this.selectStandardWeapons(S)}getSpecialWeaponIndex(){return this.specialWeaponIndex}computeGuardScanRange(S){var O=this.guardWeaponRangeOverride??[this.primaryWeapon,this.secondaryWeapon].filter(O=>O===S||O?.rules.neverUse).reduce((S,O)=>Math.max(S,O.range),0);return O=Math.max(O,this.gameObject.rules.guardRange),Math.min(15,2*O-1)}getDeployFireWeapon(){if(this.gameObject.rules.deployFire)return this.gameObject.rules.deployFireWeapon===N.WeaponType.Primary?this.primaryWeapon:this.secondaryWeapon}isEquippedWithWeapon(S){return[this.primaryWeapon,this.secondaryWeapon].includes(S)}getWeapons(){return[this.primaryWeapon,this.secondaryWeapon].filter(F.isNotNullOrUndefined)}[j.NotifyTick.onTick](){this.primaryWeapon&&this.primaryWeapon.tick(),this.secondaryWeapon&&this.secondaryWeapon.tick()}[L.NotifyDestroy.onDestroy](S,O,B){!this.deathWeapon||B?.weapon?.warhead.rules.temporal||S.crashableTrait&&!S.isCrashing||B?.obj?.isVehicle()&&B.weapon?.rules.suicide&&B.obj.transportTrait?.units.find(O=>O===S)||this.deathWeapon.fire(O.createTarget(S,S.tile),O)}dispose(){this.gameObject=void 0,this.primaryWeapon=void 0,this.secondaryWeapon=void 0,this.deathWeapon=void 0}},S("ArmedTrait",_)}}}),System.register("game/gameobject/trait/AttackTrait",["util/typeGuard","game/type/ArmorType","game/gameobject/unit/ZoneType","game/gameobject/task/AttackTask","game/SideType","game/gameobject/trait/interface/NotifyTick","game/gameobject/unit/RangeHelper","game/gameobject/trait/interface/NotifyDamage","game/gameobject/task/system/TaskRunner","game/Target","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/type/MovementZone","game/Coords","game/gameobject/trait/interface/NotifyTeleport","game/type/VhpScan","game/gameobject/unit/LosHelper","game/math/Vector2","game/math/Box2"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S}],execute:function(){var O;(O=ee||S("AttackState",ee={}))[O.Idle=0]="Idle",O[O.CheckRange=1]="CheckRange",O[O.PrepareToFire=2]="PrepareToFire",O[O.FireUp=3]="FireUp",O[O.Firing=4]="Firing",O[O.JustFired=5]="JustFired",te=class{constructor(S,O){this.disabled=!1,this.attackState=ee.Idle,this.passiveScanCooldownTicks=0,this.taskRunner=new H.TaskRunner,this.distributedFireHistory=new Map,this.rangeHelper=new _.RangeHelper(O),this.losHelper=new Y.LosHelper(S,O)}isIdle(){return this.attackState===ee.Idle}isDisabled(){return this.disabled}setDisabled(S){this.disabled=S}isOnCooldown(S){let O=[S.primaryWeapon,S.secondaryWeapon],B=S.armedTrait?.getDeployFireWeapon();return B?.rules.areaFire&&!B.rules.fireOnce&&(O=O.filter(S=>S!==B)),O.some(S=>0<(S?.getCooldownTicks()??0))}expirePassiveScanCooldown(){this.passiveScanCooldownTicks=0}increasePassiveScanCooldown(S){this.passiveScanCooldownTicks+=S}cancelOpportunityFire(){this.opportunityFireTask?.cancel()}selectDefaultWeapon(S){let O;if((S.isInfantry()||S.isVehicle())&&S.rules.deployFire){let B=S.armedTrait?.getDeployFireWeapon();O=S.deployerTrait?.isDeployed()?B&&!B.rules.areaFire?B:void 0:[S.primaryWeapon,S.secondaryWeapon].find(S=>S!==B)}else O=S.isBuilding()&&S.garrisonTrait?S.garrisonTrait.isOccupied()?S.owner.country.side===D.SideType.GDI?S.primaryWeapon:S.secondaryWeapon??S.primaryWeapon:void 0:S.isBuilding()&&S.overpoweredTrait?S.overpoweredTrait.getWeapon():S.primaryWeapon;return O}selectWeaponVersus(S,O,B,N=!1,j=!1){var L=O.tile;const D=O instanceof V.Target?O.obj:O;var F=this.getAvailableWeapons(S,j,D?.isOverlay()||N&&!D);return this.selectWeaponFromList(S,D,L,F,B,N,j,!1)}selectWeaponFromList(S,O,B,N,L,D,F,_){if((!O?.isInfantry()&&!O?.isVehicle()||!O.disguiseTrait||this.canAttackThroughDisguise(S,O,O.disguiseTrait,L,D,F,_))&&(O?.isBuilding()&&O.overpoweredTrait&&O.owner===S.owner&&N.find(S=>S.warhead.rules.electricAssault)&&(N=N.filter(S=>S.warhead.rules.electricAssault)),!(F&&O?.isAircraft()&&O.missileSpawnTrait&&O.zone!==j.ZoneType.Air))){var U=O?.isTechno()?O.rules.armor:void 0;for(const S of N)if(S.targeting.canTarget(O,B,L,D,F)&&(void 0===U||this.checkArmor(S.warhead.rules,U,F)))return S}}getAvailableWeapons(S,O,B){let N;var j;return N=(S.isInfantry()||S.isVehicle())&&S.rules.deployFire&&S.armedTrait?(j=S.armedTrait.getDeployFireWeapon(),[S.deployerTrait?.isDeployed()?j.rules.areaFire?void 0:j:j===S.secondaryWeapon?S.primaryWeapon:S.secondaryWeapon]):S.isBuilding()&&S.garrisonTrait?S.garrisonTrait.isOccupied()?[S.owner.country.side===D.SideType.GDI?S.primaryWeapon:S.secondaryWeapon??S.primaryWeapon]:[]:S.isBuilding()&&S.overpoweredTrait?[S.overpoweredTrait.getWeapon()]:B||O?[S.primaryWeapon,!B&&O&&S.secondaryWeapon?S.secondaryWeapon:void 0]:[S.primaryWeapon,S.secondaryWeapon],N.filter(S=>S&&!S.rules.neverUse)}canAttackThroughDisguise(S,O,B,N,j,L,D){if(!j&&B.hasTerrainDisguise()&&!N.areFriendly(S,O)&&!S.owner.sharedDetectDisguiseTrait?.has(O))return!1;if(L){if(D&&O.moveTrait.isIdle()&&!S.rules.detectDisguise&&!S.owner.sharedDetectDisguiseTrait?.has(O)&&!N.areFriendly(O,S))return!1;var F=B.getDisguise();if(F?.owner&&!S.rules.detectDisguise&&!S.owner.sharedDetectDisguiseTrait?.has(O)&&(F.owner===S.owner||N.alliances.areAllied(S.owner,F.owner)))return!1}return!0}checkArmor(S,O,B){var j=S.ivanBomb||S.bombDisarm||S.nukeMaker?1:S.verses.get(O);return void 0===j?(console.warn(`Unhandled ArmorType ${N.ArmorType[O]} in warhead ${S.name} verses`),!1):!(100*j<=(B?1:0))}createAttackTask(S,O,B,N,j){return new L.AttackTask(S,S.createTarget(O,B),N,j)}[F.NotifyTick.onTick](S,O){if(!this.isDisabled()){if(this.opportunityFireTask&&(!S.unitOrderTrait.hasTasks()||S.isUnit()&&!S.unitOrderTrait.getTasks()[0].preventOpportunityFire||(S.unitOrderTrait.getTasks()[0]instanceof L.AttackTask?this.opportunityFireTask=void 0:this.opportunityFireTask.cancel()),this.opportunityFireTask&&(D=[this.opportunityFireTask],this.taskRunner.tick(D,S),D.length||(this.opportunityFireTask=void 0))),!this.opportunityFireTask&&this.retaliateTarget){var B=this.retaliateTarget;let N;this.retaliateTarget=void 0,!S.unitOrderTrait.hasTasks()&&O.isValidTarget(B)&&(N=this.selectWeaponVersus(S,B,O,!1))&&S.unitOrderTrait.addTask(this.createAttackTask(O,B,B.tile,N,{holdGround:S.rules.movementZone===$.MovementZone.Fly}))}if(!this.opportunityFireTask&&this.shouldPassiveAcquire(S))if(0<this.passiveScanCooldownTicks)this.passiveScanCooldownTicks--;else{this.passiveScanCooldownTicks=S.guardMode?O.rules.general.guardAreaTargetingDelay:O.rules.general.normalTargetingDelay;let L=this.selectDefaultWeapon(S);var N,j,D=S.unitOrderTrait.hasTasks();let _,U,H;!D&&S.guardMode&&L&&S.owner.isCombatant()&&(_=S.armedTrait?.computeGuardScanRange(L),U=S.guardArea?.tile,H=50);let V=!1;!L||(B=this.scanForTarget(S,L,O,_,U)).target&&(({target:N,weapon:j}=B),N=this.createAttackTask(O,N,N.tile,j,{holdGround:D||!S.guardMode,disallowTurning:D,leashTiles:H,passive:!0}),D?this.opportunityFireTask=N:S.unitOrderTrait.addTask(N),V=!0,D||!S.guardMode||S.guardArea||(S.guardArea={tile:S.tile,onBridge:!!S.isUnit()&&S.onBridge}),V&&!D&&S.unitOrderTrait[F.NotifyTick.onTick](S,O)),V||D||!S.secondaryWeapon?.warhead.rules.electricAssault||(L=S.secondaryWeapon,(j=this.scanForTarget(S,L,O,void 0,void 0,!0)).target&&(({target:N,weapon:j}=j),j=this.createAttackTask(O,N,N.tile,j,{passive:!0}),S.unitOrderTrait.addTask(j),V=!0)),!V&&!D&&S.guardArea&&S.isUnit()&&S.moveTrait&&!S.moveTrait.isDisabled()&&S.guardArea.tile!==S.tile&&S.unitOrderTrait.addTasks(new W.MoveTask(O,S.guardArea.tile,S.guardArea.onBridge),new z.CallbackTask(()=>{[K.MoveResult.Success,K.MoveResult.CloseEnough].includes(S.moveTrait.lastMoveResult)||S.resetGuardModeToIdle(),S.guardArea=void 0}))}}}[U.NotifyDamage.onDamage](S,O,B,N){this.isDisabled()||!this.retaliateTarget&&!this.opportunityFireTask&&N&&N.obj&&N.weapon&&this.shouldRetaliate(S,O,B,N.obj,N.weapon.warhead)&&(this.retaliateTarget=N.obj)}[Q.NotifyTeleport.onBeforeTeleport](S,O,B,N){N||(this.attackState=ee.Idle,this.currentTarget=void 0,this.retaliateTarget=void 0,this.opportunityFireTask=void 0)}shouldPassiveAcquire(S){if(!S.owner.isCombatant()&&S.rules.needsEngineer||!S.rules.canPassiveAquire||!S.primaryWeapon||S.ammoTrait&&!S.ammoTrait.ammo&&S.rules.manualReload)return!1;if(S.mindControllerTrait?.isAtCapacity())return!1;var O=S.rules.opportunityFire||S.rules.balloonHover&&S.unitOrderTrait.getCurrentTask()?.isAttackMove;if(S.isUnit()&&O){if(S.unitOrderTrait.hasTasks()&&S.unitOrderTrait.getTasks()[0].preventOpportunityFire)return!1}else if(S.unitOrderTrait.hasTasks())return!1;return!0}shouldRetaliate(S,O,B,N,j){if(B<1||O.areFriendly(S,N)||!S.rules.canRetaliate||!S.primaryWeapon||S.ammoTrait&&!S.ammoTrait.ammo&&S.rules.manualReload||j.rules.temporal||N.rules.missileSpawn||S.unitOrderTrait.hasTasks()||!O.isValidTarget(N)||(N.isInfantry()||N.isVehicle())&&N.disguiseTrait&&!S.rules.detectDisguise||S.mindControllerTrait?.isAtCapacity())return!1;var L=this.selectWeaponVersus(S,N,O,!1);return!(!L||(S.isBuilding()||N.isBuilding()?this.rangeHelper.tileDistance(S,N):this.rangeHelper.distance2(S,N)/q.Coords.LEPTONS_PER_TILE)>Math.max(L.range,S.sight))}scanForTarget(S,O,B,N,j,L=!1){let D={},F=Number.NEGATIVE_INFINITY;var _=this.getAvailableWeapons(S,!0,!1),U=N??(S.rules.guardRange||O.range)+1+3+B.rules.elevationModel.bonusCap+(O.projectileRules.isAntiAir?S.rules.airRangeBonus:0);for(const O of this.scanTechnosAround(S,U,B)){var H,V=this.selectWeaponFromList(S,O,O.tile,_,B,!1,!0,!0);V&&this.canPassiveAcquire(O,B)&&B.isValidTarget(O)&&(N?this.rangeHelper.isInRange(S,O,V.minRange,N,V.rules.cellRangefinding)&&(!j||this.rangeHelper.isInRange2(j,O,0,N)):this.rangeHelper.isInWeaponRange(S,O,V,B.rules))&&(L||this.losHelper.hasLineOfSight(S,O,V))&&(H=this.rangeHelper.distance3(S,O)/q.Coords.LEPTONS_PER_TILE,(H=this.computeThreat(O,S,V,H,B.rules.general.threat))>F&&(D={target:O,weapon:V},F=H))}return D.target&&S.rules.distributedFire&&this.updateDistributedFireHistory(D),D}scanTechnosAround(S,O,B){var N=S.getFoundation();const j=new X.Vector2(S.tile.rx,S.tile.ry),L=new X.Vector2(S.tile.rx+N.width-1,S.tile.ry+N.height-1);return j.addScalar(-O),L.addScalar(O),N=new J.Box2(j,L),B.map.technosByTile.queryRange(N)}canPassiveAcquire(S,O){return!S.owner.isNeutral&&!S.rules.civilian&&!S.rules.insignificant&&(1<S.rules.threatPosed||0<S.rules.specialThreatValue&&!S.isBuilding()||S.rules.harvester||S.name===O.rules.general.paradrop.paradropPlane)}computeThreat(S,O,N,j,L){var D;let F=[S.primaryWeapon,S.secondaryWeapon].filter(B.isNotNullOrUndefined).map(S=>S.warhead.rules.verses.get(O.rules.armor)??0).reduce((S,O)=>Math.max(S,O),0)*L.targetEffectivenessCoefficientDefault;return S.attackTrait?.currentTarget?.obj===O&&(F*=-1),F+=S.rules.specialThreatValue*L.targetSpecialThreatCoefficientDefault,F+=(N.warhead.rules.verses.get(S.rules.armor)??0)*L.myEffectivenessCoefficientDefault,F+=S.healthTrait.health/100*L.targetStrengthCoefficientDefault,F+=j*L.targetDistanceCoefficientDefault,F+=1e5,O.rules.vhpScan!==Z.VhpScan.None&&(D=S.healthTrait.getProjectedHitPoints(),O.rules.vhpScan===Z.VhpScan.Strong?D<=0&&(F=Number.NEGATIVE_INFINITY):O.rules.vhpScan===Z.VhpScan.Normal&&(D<=0?F/=2:D<=S.healthTrait.maxHitPoints/2&&(F*=2))),O.rules.distributedFire&&(F-=1e6*(this.distributedFireHistory.get(S)??0)),F}updateDistributedFireHistory(S){if(50!==this.distributedFireHistory.get(S.target)){for(var[O,B]of this.distributedFireHistory)--B<=0?this.distributedFireHistory.delete(O):this.distributedFireHistory.set(O,B);this.distributedFireHistory.set(S.target,50)}}dispose(){this.distributedFireHistory.clear()}},S("AttackTrait",te)}}}),System.register("game/gameobject/trait/AutoRepairTrait",["game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyOwnerChange","game/GameSpeed"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class{constructor(S=!1){this.freeRepair=S,this.disabled=!0,this.cooldownTicks=0,this.healLeftover=0}isDisabled(){return this.disabled}setDisabled(S){this.disabled=S}[B.NotifyTick.onTick](S,O){if(!this.isDisabled())if(100===S.healthTrait.health&&this.setDisabled(!0),this.cooldownTicks<=0){var B=O.rules.general.repair,N=S.isInfantry()?B.iRepairRate:S.isBuilding()?B.repairRate:B.uRepairRate;this.cooldownTicks+=j.GameSpeed.BASE_TICKS_PER_SECOND*N*60;var L=S.isInfantry()?B.iRepairStep:B.repairStep;let D;(N=this.freeRepair?0:B.repairPercent)?(B=N*S.purchaseValue/S.healthTrait.maxHitPoints,(N=Math.min(S.owner.credits,Math.max(1,Math.floor(B*L))))?(D=B?N/B:L,S.owner.credits-=N):(D=0,this.setDisabled(!0))):D=L,D&&(D+=this.healLeftover,D=Math.min(S.healthTrait.maxHitPoints-S.healthTrait.getHitPoints(),D),D&&(L=Math.floor(D),this.healLeftover=D-L,L&&S.healthTrait.healBy(L,S,O)))}else this.cooldownTicks--}[N.NotifyOwnerChange.onChange](){this.setDisabled(!0)}},S("AutoRepairTrait",L)}}}),System.register("game/gameobject/trait/BridgeTrait",["game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/infantry/InfDeathType","game/type/LandType","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){U=class e{constructor(S){this.bridges=S,this.needsImageUpdate=!1,this.dominoHandled=!1}[B.NotifyDamage.onDamage](){this.needsImageUpdate=!0}[N.NotifyTick.onTick](S){this.needsImageUpdate&&(this.needsImageUpdate=!1,this.bridges.handlePieceHealthChange(this.bridges.getPieceAtTile(S.tile)))}[j.NotifyDestroy.onDestroy](S,O,B){var N=this.bridges.getPieceAtTile(S.tile);this.dominoHandled||this.bridges.findDominoPieces(N).filter(S=>!S.obj.isDestroyed).forEach(S=>{S.obj.traits.get(e).dominoHandled=!0,O.destroyObject(S.obj,B)}),O.map.tileOccupation.calculateTilesForGameObject(S.tile,S).forEach(N=>{let j=D.getLandType(N.terrainType),U=O.rules.getLandRules(j);O.map.getGroundObjectsOnTile(N).forEach(N=>{if(N.isUnit()&&(N.onBridge||N.moveTrait.reservedPathNodes.some(O=>O.onBridge===S))&&!N.isDestroyed)if(S.isLowBridge()&&0<U.getSpeedModifier(N.rules.speedType)||N.isInfantry()&&N.stance===_.StanceType.Paradrop){for(var D of(N.onBridge&&(N.onBridge=!1,N.zone=F.getZoneType(j)),N.moveTrait.reservedPathNodes))D.onBridge===S&&(D.onBridge=void 0);N.moveTrait.currentWaypoint?.onBridge===S&&(N.moveTrait.currentWaypoint.onBridge=void 0)}else N.isInfantry()&&(N.infDeathType=L.InfDeathType.None),O.destroyObject(N,B,!0)})})}},S("BridgeTrait",U)}}}),System.register("game/gameobject/trait/C4ChargeTrait",["game/gameobject/common/DeathType","game/gameobject/unit/Timer","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class{constructor(){this.timer=new N.Timer}hasCharge(){return this.timer.isActive()}setCharge(S,O){this.hasCharge()||(this.timer.setActiveFor(S),this.attackerInfo=O)}[j.NotifyTick.onTick](S,O){this.timer.isActive()&&!0===this.timer.tick(O.currentTick)&&(S.invulnerableTrait.isActive()||(S.isBuilding()&&S.cabHutTrait?S.cabHutTrait.demolishBridge(O,this.attackerInfo):(S.deathType=B.DeathType.Demolish,O.destroyObject(S,this.attackerInfo,!0))))}},S("C4ChargeTrait",L)}}}),System.register("game/gameobject/trait/CabHutTrait",["engine/type/ObjectType","game/map/BridgeOverlayTypes","game/gameobject/task/ScatterTask","game/gameobject/unit/ZoneType","game/gameobject/common/DeathType"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){S("CabHutTrait",class{constructor(S,O){this.gameObject=S,this.bridges=O,this.checkedClosestBridge=!1}canRepairBridge(){var S=this.findClosestBridgeBounds();return S?this.bridges.canBeRepaired(S):(console.warn(`No bridge associated with hut at ${this.gameObject.tile.rx}, ${this.gameObject.tile.ry}.`),!1)}repairBridge(S,O){var j=this.findClosestBridgeBounds();if(!j)throw new Error("No bridge bounds found");var L=this.bridges.findDestroyedPieceTiles(j),D=j.start.rx!==j.end.rx;let F;F=j.isHigh?N.BridgeOverlayTypes.calculateHighBridgeOverlayId(j.type,D):N.BridgeOverlayTypes.calculateLowBridgeOverlayId(j.type,D);var _,U,H=S.rules.getOverlayName(F);for(_ of L){let N=S.createObject(B.ObjectType.Overlay,H);N.overlayId=F,N.value=0,N.position.tileElevation=j.isHigh?4:0,S.spawnObject(N,_),this.updateUnitsUnderBridgePiece(_,j,S,O)}for(U of this.bridges.findBridgePieces(j))U.obj.bridgeTrait.bridgeSpec=j}updateUnitsUnderBridgePiece(S,O,B,N){var D;for(let F of this.bridges.getPieceTiles(this.bridges.getPieceAtTile(S)))if(O.isHigh)B.map.getGroundObjectsOnTile(F).filter(S=>S.tile===F&&S.isUnit()&&!S.unitOrderTrait.hasTasks()&&S.rules.tooBigToFitUnderBridge).forEach(S=>S.unitOrderTrait.addTask(new j.ScatterTask(B)));else for(D of B.map.getGroundObjectsOnTile(F))D.isUnit()&&(B.map.terrain.getPassableSpeed(F,D.rules.speedType,D.isInfantry(),!0)?(D.zone=L.ZoneType.Ground,D.onBridge=!0):D.isDestroyed||B.destroyObject(D,{player:N}))}demolishBridge(S,O){var B=this.getBridgePieces();if(B)for(var N of B)N.obj.isLowBridge()&&S.map.getTileZone(N.obj.tile,!0)!==L.ZoneType.Water||N.obj.isDestroyed||(N.obj.deathType=D.DeathType.Demolish,S.destroyObject(N.obj,O,!0))}getBridgePieces(){var S=this.findClosestBridgeBounds();if(S)return this.bridges.findBridgePieces(S)}findClosestBridgeBounds(){return this.checkedClosestBridge||(this.checkedClosestBridge=!0,this.closestBridge=this.bridges.findClosestBridgeSpec(this.gameObject.tile)),this.closestBridge}dispose(){this.gameObject=void 0}})}}}),System.register("game/gameobject/trait/CloakableTrait",["game/event/ObjectCloakChangeEvent","game/GameSpeed","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class{constructor(S,O){this.gameObject=S,this.cloakDelayMinutes=O,this.isActive=!1,this.resetCloakCooldown()}isCloaked(){return this.isActive}uncloak(S){var O=this.isActive;this.resetCloakCooldown(),O&&(this.isActive=!1,S.events.dispatch(new B.ObjectCloakChangeEvent(this.gameObject)))}resetCloakCooldown(){this.cooldownTicks=Math.floor(60*this.cloakDelayMinutes*N.GameSpeed.BASE_TICKS_PER_SECOND)}[L.NotifySpawn.onSpawn](S,O){this.resetCloakCooldown()}[D.NotifyTick.onTick](S,O){0<this.cooldownTicks&&this.cooldownTicks--,!(this.cooldownTicks<=0)||this.isActive||S.isVehicle()&&S.submergibleTrait&&!S.submergibleTrait.isSubmerged()||S.temporalTrait.getTarget()||(this.isActive=!0,O.events.dispatch(new B.ObjectCloakChangeEvent(this.gameObject)))}[j.NotifyDamage.onDamage](S,O){this.uncloak(O)}dispose(){this.gameObject=void 0}},S("CloakableTrait",F)}}}),System.register("game/gameobject/trait/CrashableTrait",["game/event/ObjectCrashingEvent","game/type/LocomotorType","game/gameobject/trait/interface/NotifyTick","game/gameobject/locomotor/JumpjetLocomotor","game/gameobject/locomotor/WingedLocomotor","game/gameobject/trait/interface/NotifyCrash"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class{constructor(S){this.gameObject=S,this.crashingEvtSent=!1,this.crashState={}}[j.NotifyTick.onTick](S,O){if(S.isCrashing){if(this.crashingEvtSent||(this.crashingEvtSent=!0,S.traits.filter(F.NotifyCrash).forEach(B=>B[F.NotifyCrash.onCrash](S,O)),O.events.dispatch(new B.ObjectCrashingEvent(S))),S.rules.locomotor!==N.LocomotorType.Jumpjet&&S.rules.locomotor!==N.LocomotorType.Aircraft)throw new Error("Crashing logic not implemented for locomotor "+N.LocomotorType[S.rules.locomotor]);{let B;if(S.rules.locomotor===N.LocomotorType.Jumpjet)B=L.JumpjetLocomotor.tickCrash(S,O,this.crashState);else{if(S.rules.locomotor!==N.LocomotorType.Aircraft)throw new Error(`Unhandled locomotor type "${S.rules.locomotor}"`);if(!S.isAircraft())throw new Error(`Obj "${S.name}#${S.id} is not an aircraft`);B=D.WingedLocomotor.tickCrash(S,O,this.crashState)}let F=!1;var j,_,U=B.clone().add(S.position.worldPosition);O.map.isWithinHardBounds(U)?(_=S.tile,j=S.tileElevation,S.position.moveByLeptons3(B),S.tile!==_&&S.moveTrait.handleTileChange(_,void 0,!1,O),_=(U=S.tile.onBridgeLandType?O.map.tileOccupation.getBridgeOnTile(S.tile):void 0)?.tileElevation??0,S.position.tileElevation=Math.max(S.position.tileElevation,_),S.position.tileElevation===_&&(S.zone=O.map.getTileZone(S.tile),S.onBridge=!!U,F=!0),S.tileElevation!==j&&S.moveTrait.handleElevationChange(j,O)):F=!0,F&&O.destroyObject(S,this.attackerInfo)}}}crash(S){this.attackerInfo=S,this.gameObject.isCrashing=!0,this.gameObject.cachedTraits.tick.length=0,this.gameObject.cachedTraits.tick=[this]}dispose(){this.gameObject=void 0}},S("CrashableTrait",_)}}}),System.register("game/gameobject/trait/CrewedTrait",["game/gameobject/trait/interface/NotifySell","game/gameobject/trait/interface/NotifyDestroy","game/SideType","engine/type/ObjectType","game/gameobject/task/ScatterTask","game/gameobject/Infantry","game/gameobject/unit/VeteranLevel"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){U=class{[B.NotifySell.onSell](S,O){this.spawnSurvivors(S,O)}[N.NotifyDestroy.onDestroy](S,O,B,N){N||B?.obj===S&&B.weapon?.rules.suicide||S.isVehicle()&&S.moveTrait.isMoving()||S.crashableTrait||this.spawnSurvivors(S,O)}spawnSurvivors(S,O){var B=O.rules.general.crew,N=S.owner.country.side;let U,H;if(N===j.SideType.GDI)U=B.alliedSurvivorDivisor,H=B.alliedCrew;else{if(N!==j.SideType.Nod)return;U=B.sovietSurvivorDivisor,H=B.sovietCrew}let V=O.sellTrait.computeRefundValue(S)/U;V=0<V&&V<1?1:Math.floor(V),V=S.isVehicle()?Math.min(1,V):Math.min(5,V);let W=[];for(let S=0;S<V;S++)W.push(H);if(0<W.length){S.rules.constructionYard&&(W[W.length-1]=O.rules.general.engineer);var z,K=O.map.tiles.getInRectangle(S.tile,S.getFoundation()).filter(S=>O.map.isWithinBounds(S));let B=[...K];for(z of W){var $=O.rules.getObject(z,L.ObjectType.Infantry);if(O.map.terrain.getPassableSpeed(S.tile,$.speedType,!0,!S.isBuilding()&&S.onBridge,void 0,!0)){let N=O.createUnitForPlayer($,S.owner),j=B.length?B.splice(O.generateRandomInt(0,B.length-1),1)[0]:void 0;j=j||K[O.generateRandomInt(0,K.length-1)],N.isInfantry()&&(N.position.subCell=F.Infantry.SUB_CELLS[0]),N.veteranTrait&&S.owner.canProduceVeteran(N.rules)&&N.veteranTrait.setVeteranLevel(_.VeteranLevel.Veteran),O.spawnObject(N,j),S.isBuilding()&&N.unitOrderTrait.addTask(new D.ScatterTask(O,void 0,{ignoredBlockers:S.isDestroyed?void 0:[S]}))}}}}},S("CrewedTrait",U)}}}),System.register("game/gameobject/trait/DelayedKillTrait",["game/gameobject/unit/Timer","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class{constructor(){this.timer=new B.Timer}isActive(){return this.timer.isActive()}activate(S,O){this.isActive()||(this.timer.setActiveFor(S),this.attackerInfo=O)}[N.NotifyTick.onTick](S,O){this.timer.isActive()&&!0===this.timer.tick(O.currentTick)&&(S.invulnerableTrait.isActive()||S.isBuilding()&&S.cabHutTrait||O.destroyObject(S,this.attackerInfo,!0,!0))}},S("DelayedKillTrait",j)}}}),System.register("game/gameobject/trait/DeployerTrait",["game/gameobject/infantry/StanceType","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){var O;(O=j=j||{})[O.None=0]="None",O[O.PreparingToFire=1]="PreparingToFire",O[O.FiringUp=2]="FiringUp",O[O.Firing=3]="Firing",L=class{constructor(S){this.gameObject=S,this.deployed=!1,this.deployFireDelay=0,this.deployFireState=j.None,this.fireUpDelay=0,this.deployFireCount=0}isDeployed(){return this.deployed}setDeployed(S){var O=this.deployed;if((this.deployed=S)!==O){let N=this.gameObject;N.isInfantry()&&(N.stance=S?B.StanceType.Deployed:B.StanceType.None),S?(this.deployFireState=j.PreparingToFire,O=this.gameObject.armedTrait?.getDeployFireWeapon(),this.deployWeapon=O?.rules.areaFire?O:void 0,this.deployFireDelay=15+((O===N.primaryWeapon?N.secondaryWeapon:N.primaryWeapon)?.getCooldownTicks()??0),this.deployFireCount=0,this.undeployDelay=this.gameObject.rules.undeployDelay||void 0):(this.deployFireState===j.FiringUp&&(N.isFiring=!1),this.deployFireState=j.None,this.deployWeapon=void 0)}}toggleDeployed(){this.setDeployed(!this.isDeployed())}[N.NotifyTick.onTick](S,O){if(void 0!==this.undeployDelay&&(0<this.undeployDelay&&this.undeployDelay--,this.undeployDelay<=0&&[j.None,j.PreparingToFire].includes(this.deployFireState)))return this.undeployDelay=void 0,void this.setDeployed(!1);if(this.deployWeapon&&this.deployFireState!==j.None){if(this.deployFireState===j.PreparingToFire){if(0<this.deployFireDelay--||0===S.ammo)return;if(0<this.computeDeployFireCooldown(this.deployWeapon,O))return;this.fireUpDelay=Math.max(1,S.art.fireUp),this.deployFireState=j.FiringUp}if(this.deployFireState===j.FiringUp){if(S.isFiring=!0,0<this.fireUpDelay--)return;this.deployFireState=j.Firing}var B;this.deployFireState===j.Firing&&(S.isFiring=!1,B=S.onBridge?O.map.tileOccupation.getBridgeOnTile(S.tile):void 0,this.deployWeapon.fire(O.createTarget(B,S.tile),O),this.deployFireCount++,(this.deployWeapon===S.primaryWeapon?S.secondaryWeapon:S.primaryWeapon)?.resetCooldown(),this.deployWeapon.rules.fireOnce?(this.deployFireState=j.None,this.deployWeapon=void 0):this.deployFireState=j.PreparingToFire)}}computeDeployFireCooldown(S,O){if(S.rules.radLevel&&S.rules.areaFire){var B=this.gameObject.tile,N=O.mapRadiationTrait.getRadSiteLevel(B);if(!N)return 0;B=O.rules.radiation;let j=Math.max(0,N*B.radDurationMultiple-B.radLevelDelay);return 1===this.deployFireCount&&(B=B.radDurationMultiple*S.rules.radLevel,j=Math.max(0,j-Math.floor(.25*B))),j}return S.getCooldownTicks()}getHash(){return this.deployed?1:0}debugGetState(){return{deployed:this.deployed}}dispose(){this.gameObject=void 0}},S("DeployerTrait",L)}}}),System.register("game/gameobject/trait/DisguiseTrait",["engine/type/ObjectType","game/event/ObjectDisguiseChangeEvent","game/SideType","game/gameobject/trait/AttackTrait","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/MoveTrait"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){H=class{constructor(){this.isActive=!1,this.cooldownTicks=0}isDisguised(){return this.isActive}getDisguise(){return this.isActive?this.disguisedAs:void 0}hasTerrainDisguise(){return this.getDisguise()?.rules.type===B.ObjectType.Terrain}disguiseAs(S,O,B){this.disguisedAs={rules:S.rules,owner:S.owner},this.isActive=!0,B.events.dispatch(new N.ObjectDisguiseChangeEvent(O))}revealDisguise(S,O){this.cooldownTicks=O.rules.general.infantryBlinkDisguiseTime,this.isActive=!1,O.events.dispatch(new N.ObjectDisguiseChangeEvent(S))}[F.NotifySpawn.onSpawn](S,O){var N;!this.disguisedAs&&S.rules.permaDisguise&&S.isInfantry()&&S.owner.country&&(N=this.getDefaultInfantryDisguise(S.owner.country.side,O.rules.general))&&(N=O.rules.getObject(N,B.ObjectType.Infantry),this.disguisedAs={rules:N,owner:S.owner},this.isActive=!0)}getDefaultInfantryDisguise(S,O){switch(S){case j.SideType.GDI:return O.alliedDisguise;case j.SideType.Nod:return O.sovietDisguise;default:return}}[_.NotifyTick.onTick](S,O){S.rules.permaDisguise||(S.attackTrait?.attackState===L.AttackState.JustFired||S.moveTrait.moveState!==U.MoveState.Idle?this.revealDisguise(S,O):0<this.cooldownTicks?this.cooldownTicks--:!this.isActive&&S.rules.disguiseWhenStill&&(this.isActive=!0,this.disguisedAs={rules:this.selectRandomMirageDisguise(O),owner:void 0},O.events.dispatch(new N.ObjectDisguiseChangeEvent(S))))}[D.NotifyDamage.onDamage](S,O){this.revealDisguise(S,O)}selectRandomMirageDisguise(S){var O=S.rules.general.defaultMirageDisguises;if(!O.length)throw new Error("No default mirage disguises are defined");return O=O[S.generateRandomInt(0,O.length-1)],S.rules.getObject(O,B.ObjectType.Terrain)}},S("DisguiseTrait",H)}}}),System.register("game/gameobject/trait/DockTrait",["game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySell","game/gameobject/trait/DockableTrait","game/Coords","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifySpawn","util/typeGuard","game/gameobject/task/MoveToDockTask","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/trait/interface/NotifyUnspawn"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S}],execute:function(){$=class{constructor(S,O,B,N){this.building=S,this.tiles=O,this.numberOfDocks=B,this.dockingOffsets=N,this.ticksWhenWarpedOut=!0,this.unitsByDockNumber=new Array(B).fill(void 0),this.reservedDocks=new Array(B).fill(void 0)}[_.NotifySpawn.onSpawn](){this.dockTiles=[];for(let O=0;O<this.numberOfDocks;O++){var S=this.findDockTile(O);if(!S)throw new Error(`Docking tile ${O} not found for object "${this.building.name}"`);this.dockTiles[O]=S}}[K.NotifyUnspawn.onUnspawn](){for(let S=0;S<this.numberOfDocks;S++)this.unreserveDockAt(S)}[F.NotifyTick.onTick](){for(let O=0;O<this.numberOfDocks;O++){var S=this.unitsByDockNumber[O];S&&S.tile!==this.getDockTile(O)&&this.undockUnit(S)}}[B.NotifyDestroy.onDestroy](S,O,B,N){var j=(S.rules.unitRepair||S.helipadTrait)&&!S.rules.naval&&!B?.weapon?.warhead.rules.temporal;if(j)for(var L of this.unitsByDockNumber)L&&!L.isDestroyed&&(j?O.destroyObject(L,B,N):this.undockUnit(L))}[j.NotifySell.onSell](S,O){if(S.helipadTrait&&this.hasDockedUnits()){var B,N,j;let L=[],D=0;for(B of[...S.owner.buildings].filter(O=>O.helipadTrait&&(O.dockTrait?.getAvailableDockCount()??!1)&&O!==S)){let S=B.dockTrait?.getAvailableDockCount()??0;for(;0<S&&D<this.unitsByDockNumber.length;)L.push(B),S--,D++;if(D===this.unitsByDockNumber.length)break}for(N of(D=0,this.unitsByDockNumber))N&&((j=L[D])?N.unitOrderTrait.addTask(new H.MoveToDockTask(O,j)):N.unitOrderTrait.addTask(new z.TaskGroup(new V.MoveTask(O,N.tile,!1),new W.CallbackTask(B=>{B.crashableTrait?B.crashableTrait.crash({player:S.owner}):O.destroyObject(B,{player:S.owner})})).setCancellable(!1))),D++}else{var L,D=S.rules.unitRepair&&!S.rules.naval;for(L of this.unitsByDockNumber)L&&(D?O.sellTrait.sell(L):this.undockUnit(L))}}[N.NotifyOwnerChange.onChange](S,O,B){for(var N of this.unitsByDockNumber)N&&B.changeObjectOwner(N,S.owner)}getFirstAvailableDockNumber(){if(!this.building?.warpedOutTrait.isActive()){var S=this.unitsByDockNumber.findIndex((S,O)=>!S&&!this.reservedDocks[O]);if(-1!==S)return S}}getAvailableDockCount(){return this.building?.warpedOutTrait.isActive()?0:this.unitsByDockNumber.filter((S,O)=>!S&&!this.reservedDocks[O]).length}getFirstEmptyDockNumber(){if(!this.building?.warpedOutTrait.isActive()){var S=this.unitsByDockNumber.findIndex(S=>!S);if(-1!==S)return S}}getDockOffset(S){if(S>this.numberOfDocks-1)throw new RangeError(`Index ${S} exceeds available docks (${this.numberOfDocks})`);return this.dockingOffsets[S]}getDockTile(S){if(S>this.numberOfDocks-1)throw new RangeError(`Index ${S} exceeds available docks (${this.numberOfDocks})`);return this.dockTiles[S]}getDockNumberByTile(S){var O=this.dockTiles.indexOf(S);if(-1!==O)return O}getAllDockTiles(){return[...this.dockTiles]}findDockTile(S){if(S>this.numberOfDocks-1)throw new RangeError(`Index ${S} exceeds available docks (${this.numberOfDocks})`);var O=this.building.position.getMapPosition(),B=this.getDockOffset(S);return this.tiles.getByMapCoords(Math.floor((O.x+B.x)/D.Coords.LEPTONS_PER_TILE),Math.floor((O.y+B.z)/D.Coords.LEPTONS_PER_TILE))}isValidUnitForDock(S){return(this.building.unitRepairTrait&&S.isVehicle()&&!this.building.helipadTrait&&(!S.rules.consideredAircraft||S.rules.landable)||S.rules.dock.includes(this.building.name)&&!(S.isAircraft()&&!this.building.helipadTrait))&&this.building.rules.naval===S.rules.naval}dockUnitAt(S,O){if(O>this.numberOfDocks-1)throw new RangeError(`Index ${O} exceeds available docks (${this.numberOfDocks})`);if(this.unitsByDockNumber[O])throw new Error("Another unit is already docked at dock #"+O);let B=S.traits.find(L.DockableTrait);if(!B)throw new Error(`Unit "${S.name}" cannot be docked to `+this.building.name);this.unitsByDockNumber[O]=S,B.dock=this.building}undockUnitAt(S){if(S>this.numberOfDocks-1)throw new RangeError(`Index ${S} exceeds available docks (${this.numberOfDocks})`);let O=this.unitsByDockNumber[S];O&&(this.unitsByDockNumber[S]=void 0,O.traits.get(L.DockableTrait).dock=void 0)}undockUnit(S){var O=this.unitsByDockNumber.indexOf(S);-1!==O&&this.undockUnitAt(O)}isDocked(S){return this.unitsByDockNumber.includes(S)}hasDockedUnits(){return!!this.unitsByDockNumber.find(S=>S)}getDockedUnits(){return this.unitsByDockNumber.filter(U.isNotNullOrUndefined)}reserveDockAt(S,O){if(O>this.numberOfDocks-1)throw new RangeError(`Index ${O} exceeds available docks (${this.numberOfDocks})`);if(this.reservedDocks[O])throw new Error(`Dock #${O} is already reserved by `+this.reservedDocks[O].name);(this.reservedDocks[O]=S).traits.get(L.DockableTrait).reservedDock?.dockTrait.unreserveDockForUnit(S),S.traits.get(L.DockableTrait).reservedDock=this.building}unreserveDockAt(S){if(S>this.numberOfDocks-1)throw new RangeError(`Index ${S} exceeds available docks (${this.numberOfDocks})`);let O=this.reservedDocks[S];O&&(this.reservedDocks[S]=void 0,O.traits.get(L.DockableTrait).reservedDock=void 0)}unreserveDockForUnit(S){var O=this.reservedDocks.indexOf(S);-1!==O&&this.unreserveDockAt(O)}hasReservedDockForUnit(S){return!!this.reservedDocks.includes(S)}hasReservedDockAt(S){return!!this.reservedDocks[S]}getReservedDockForUnit(S){var O=this.reservedDocks.indexOf(S);if(-1!==O)return O}dispose(){this.building=void 0}},S("DockTrait",$)}}}),System.register("game/gameobject/trait/DockableTrait",["game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifyTeleport"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class{[B.NotifyUnspawn.onUnspawn](S){this.undock(S),this.reservedDock?.dockTrait.unreserveDockForUnit(S)}[N.NotifyOwnerChange.onChange](S){S.owner!==this.dock?.owner&&this.undock(S),S.owner!==this.reservedDock?.owner&&this.reservedDock?.dockTrait.unreserveDockForUnit(S)}[j.NotifyTeleport.onBeforeTeleport](S,O,B,N){N||this.undock(S)}undock(S){this.dock&&!this.dock.isDisposed&&this.dock.dockTrait.undockUnit(S)}dispose(){this.dock=void 0,this.reservedDock=void 0}},S("DockableTrait",L)}}}),System.register("game/gameobject/trait/FactoryTrait",["game/gameobject/Building","game/gameobject/trait/interface/NotifyTick","game/player/production/ProductionQueue","game/rules/TechnoRules","game/gameobject/task/move/ExitFactoryTask","engine/type/TerrainType","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/MoveTrait","game/map/tileFinder/CardinalTileFinder","game/gameobject/trait/DockTrait","game/event/FactoryProduceUnitEvent","game/gameobject/Infantry","game/map/TileOccupation","game/gameobject/task/move/MoveTask","game/map/tileFinder/RadialTileFinder","game/gameobject/trait/interface/NotifyWarpChange","game/gameobject/unit/VeteranLevel","game/trait/interface/NotifyProduceUnit","game/math/Vector2","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/unit/ZoneType","game/gameobject/task/system/WaitMinutesTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/common/DeathType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S}],execute:function(){var O;(O=ae||S("FactoryStatus",ae={}))[O.Idle=0]="Idle",O[O.Delivering=1]="Delivering",oe=class{constructor(S,O=!1){this.type=S,this.isCloningVats=O,this.status=ae.Idle}[_.NotifySpawn.onSpawn](S,O){this.resetRallyPoint(S,O)}resetRallyPoint(S,O){var B;[L.FactoryType.BuildingType,L.FactoryType.AircraftType].includes(this.type)||(B=this.computeDefaultRallyPoint(S,this.type,O.map),S.rallyTrait?.changeRallyPoint(B,S,O))}[Q.NotifyWarpChange.onChange](S,O,B){if(S.owner.production){let O=[];for(var N of(O=this.type===L.FactoryType.BuildingType?[j.QueueType.Structures,j.QueueType.Armory]:[S.owner.production.getQueueTypeForFactory(this.type)],O))S.owner.production.getQueue(N).notifyUpdated()}}[J.NotifyOwnerChange.onChange](S,O,B){this.status===ae.Delivering&&S.rules.deployTime&&this.deliveringUnit&&!this.deliveringUnit.isDestroyed&&this.unitIsInsideFactory(this.deliveringUnit,S,B)&&B.changeObjectOwner(this.deliveringUnit,S.owner)}[ee.NotifyDestroy.onDestroy](S,O,B,N){this.status===ae.Delivering&&S.rules.deployTime&&this.deliveringUnit&&!this.deliveringUnit.isDestroyed&&S.deathType!==ne.DeathType.Temporal&&this.unitIsInsideFactory(this.deliveringUnit,S,O)&&O.destroyObject(this.deliveringUnit,B,N)}[N.NotifyTick.onTick](S,O){if(this.status===ae.Delivering){if(!this.deliveringUnit||this.deliveringUnit.isDestroyed){if(this.buildingProductionTicks=this.buildingProductionTicks??1,0<this.buildingProductionTicks--)return;this.buildingProductionTicks=void 0}else if(!this.unitHasClearedFactory(this.deliveringUnit,S,O))return;return this.status=ae.Idle,void(this.deliveringUnit=void 0)}if(S.owner.production&&!S.warpedOutTrait.isActive()){let D=S.owner.production.getPrimaryFactory(this.type);if((D?.warpedOutTrait.isActive()||D===S||D?.factoryTrait?.deliveringUnit&&D.factoryTrait.type===L.FactoryType.UnitType)&&this.type!==L.FactoryType.BuildingType){let D=S.owner.production.getQueueForFactory(this.type);if(D&&D.status===j.QueueStatus.Ready){let F=D.getFirst();if(this.type===L.FactoryType.AircraftType){let N=this.produceAircraftAt(S,F,O);var B;if(!N)for(B of[...S.owner.buildings].filter(S=>S.factoryTrait?.type===L.FactoryType.AircraftType&&S.helipadTrait)){if(N)break;N=this.produceAircraftAt(B,F,O)}if(!N)return}else{var N;if(this.produceGroundUnitAt(S,F,O),!this.isCloningVats&&this.type===L.FactoryType.InfantryType)for(N of[...S.owner.buildings].filter(S=>S.factoryTrait&&S.rules.cloning))N.factoryTrait.status===ae.Idle&&N.factoryTrait.produceGroundUnitAt(N,F,O)}S.owner.addUnitsBuilt(F.rules,1),F.creditsSpent=0,F.progress=0,D.shift(F.rules,1),D.currentSize&&(D.status=j.QueueStatus.Active)}}}}unitIsInsideFactory(S,O,B){return B.map.tileOccupation.isTileOccupiedBy(S.tile,O)&&S.zone!==te.ZoneType.Air}unitHasClearedFactory(S,O,B){return!B.map.tileOccupation.isTileOccupiedBy(S.tile,O)||S.rules.consideredAircraft&&S.position.tileElevation>=O.art.height}produceGroundUnitAt(S,O,N){let j=N.createUnitForPlayer(O.rules,S.owner);O.rules.trainable&&S.owner.canProduceVeteran(j.rules)&&j.veteranTrait?.setVeteranLevel(Z.VeteranLevel.Veteran),j.isInfantry()&&(j.position.subCell=z.Infantry.SUB_CELLS[0]);let F,_=this.computeInternalRallyPoint(S,this.type,S.rallyTrait.getRallyPoint(),N.map);var H;let V;if(this.type!==L.FactoryType.UnitType&&(_=S.rallyTrait.findRallyPointforUnit(j,_,N.map,!1,S.tile.z)),F=this.type===L.FactoryType.NavalUnitType?_:(H=this.computeExitCoords(S,this.type),N.map.tiles.getByMapCoords(Math.floor(H.rx),Math.floor(H.ry))),j.rules.consideredAircraft&&(_=F),S.rallyTrait.getRallyPoint()!==_&&(V=S.rallyTrait.findRallyNodeForUnit(j,N.map)),j.isInfantry()){let S=N.map.tileOccupation.getObjectsOnTileByLayer(V?.tile??_,j.rules.consideredAircraft?K.LayerType.Air:K.LayerType.Ground).filter(S=>S.isInfantry()&&S.moveTrait.moveState!==U.MoveState.Moving).map(S=>S.position.subCell);j.position.subCell=z.Infantry.SUB_CELLS.find(O=>!S.includes(O))??z.Infantry.SUB_CELLS[0]}function f(){var O;j.rules.consideredAircraft?(O=V??{tile:_,onBridge:void 0},j.unitOrderTrait.addTaskNext(new $.MoveTask(N,O.tile,!!O.onBridge,{closeEnoughTiles:N.rules.general.closeEnough}))):j.unitOrderTrait.addTaskNext(new D.ExitFactoryTask(N,S,_,V))}j.direction=270,N.spawnObject(j,F),N.traits.filter(Y.NotifyProduceUnit).forEach(S=>{S[Y.NotifyProduceUnit.onProduce](j,N)}),N.events.dispatch(new W.FactoryProduceUnitEvent(j)),S.rules.deployTime?j.unitOrderTrait.addTask(new se.TaskGroup(new ie.WaitMinutesTask(S.rules.deployTime),new re.CallbackTask(()=>{S.isSpawned&&S.buildStatus!==B.BuildStatus.BuildDown&&f()})).setCancellable(!1)):f(),this.status=ae.Delivering,this.deliveringUnit=j}produceAircraftAt(S,O,B){let N=S.traits.find(V.DockTrait);if(!N)return!1;var j=N.getFirstAvailableDockNumber();if(void 0===j)return!1;let L=B.createUnitForPlayer(O.rules,S.owner);O.rules.trainable&&S.owner.canProduceVeteran(L.rules)&&L.veteranTrait?.setVeteranLevel(Z.VeteranLevel.Veteran);var D=N.getDockOffset(j);return L.position.moveToLeptons(S.position.getMapPosition()),L.position.moveByLeptons3(D),B.spawnObject(L,L.position.tile),N.dockUnitAt(L,j),L.isAircraft()&&L.airportBoundTrait&&(L.airportBoundTrait.preferredAirport=S),B.traits.filter(Y.NotifyProduceUnit).forEach(S=>{S[Y.NotifyProduceUnit.onProduce](L,B)}),B.events.dispatch(new W.FactoryProduceUnitEvent(L)),!0}computeExitCoords(S,O){if(O===L.FactoryType.InfantryType)return this.computeBarracksDefaultExitCoords(S);if(O===L.FactoryType.UnitType)return this.computeWarFactoryExitCoords(S);throw new Error("Unsupported factory type "+L.FactoryType[O])}computeInternalRallyPoint(S,O,B,N){let j,D;if(O===L.FactoryType.NavalUnitType)D=this.computeNavalInternalRallyPoint(S,B,N);else{if(O===L.FactoryType.InfantryType)j=this.computeBarracksInternalRallyCoords(S);else{if(O!==L.FactoryType.UnitType)throw new Error("Unsupported factory type "+L.FactoryType[O]);j=this.computeWarFactoryInternalRallyCoords(S)}D=N.tiles.getByMapCoords(j.rx,j.ry)}return D??this.findTileAdjacentToBuilding(S,N)}computeDefaultRallyPoint(S,O,B){let N,j;if(O===L.FactoryType.NavalUnitType)j=this.computeNavalDefaultRallyPoint(S,B);else{if(O===L.FactoryType.InfantryType)N=this.computeBarracksInternalRallyCoords(S);else{if(O!==L.FactoryType.UnitType)throw new Error("Unsupported factory type "+L.FactoryType[O]);N=this.computeWarFactoryDefaultRallyCoords(S)}j=B.tiles.getByMapCoords(N.rx,N.ry)}return j??this.findTileAdjacentToBuilding(S,B)}findTileAdjacentToBuilding(S,O){return new q.RadialTileFinder(O.tiles,O.mapBounds,S.tile,S.getFoundation(),1,1,()=>!0).getNextTile()}computeBarracksDefaultExitCoords(S){var O=S.getFoundation();let B,N;return O.width<=2||O.height<=2?(B=O.width-1,N=O.height-1,S.rules.gdiBarracks&&2<O.width&&(B=Math.floor(O.width/2))):(B=0,N=O.height-1),{rx:S.tile.rx+B,ry:S.tile.ry+N}}computeBarracksInternalRallyCoords(S){var O=S.getFoundation();let{rx:B,ry:N}=this.computeBarracksDefaultExitCoords(S);return!(O.width<=2||O.height<=2)||S.rules.gdiBarracks?N+=1:S.rules.nodBarracks&&(B+=O.width<=2?1:0,N+=O.height<=2?1:0),{rx:B,ry:N}}computeWarFactoryExitCoords(S){var O=S.getFoundation();return{rx:S.tile.rx+Math.floor(O.width/2),ry:S.tile.ry+Math.floor(O.height/2)}}computeWarFactoryInternalRallyCoords(S){var O=S.getFoundation();return{rx:S.tile.rx+O.width-1,ry:S.tile.ry+Math.floor(O.height/2)}}computeWarFactoryDefaultRallyCoords(S){var O=S.getFoundation();return{rx:S.tile.rx+O.width,ry:S.tile.ry+Math.floor(O.height/2)}}computeNavalDefaultRallyPoint(S,O){let B=new H.CardinalTileFinder(O.tiles,O.mapBounds,S.centerTile,5,5,S=>S.terrainType===F.TerrainType.Water&&!O.getObjectsOnTile(S).find(S=>S.isBuilding()||S.isOverlay()&&S.isBridge()));return B.diagonal=!1,B.getNextTile()??O.tiles.getByMapCoords(S.tile.rx+S.getFoundation().width,S.tile.ry+S.getFoundation().height)}computeNavalInternalRallyPoint(S,O,B){var N=new X.Vector2(O.rx,O.ry).sub(new X.Vector2(S.centerTile.rx,S.centerTile.ry));return B.tiles.getByMapCoords(S.centerTile.rx+Math.sign(N.x)*(Math.floor(S.getFoundation().width/2)+1),S.centerTile.ry+Math.sign(N.y)*(Math.floor(S.getFoundation().height/2)+1))}},S("FactoryTrait",oe)}}}),System.register("game/gameobject/trait/FreeUnitTrait",["game/gameobject/trait/interface/NotifyBuildStatus","game/gameobject/Building","engine/type/ObjectType","game/map/tileFinder/RadialBackFirstTileFinder"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class{[B.NotifyBuildStatus.onStatusChange](S,O,B){if(O.buildStatus===N.BuildStatus.Ready&&S===N.BuildStatus.BuildUp&&!O.owner.isNeutral){let S;if(B.rules.hasObject(O.rules.freeUnit,j.ObjectType.Vehicle))S=B.rules.getObject(O.rules.freeUnit,j.ObjectType.Vehicle);else{if(!B.rules.hasObject(O.rules.freeUnit,j.ObjectType.Infantry))return void console.warn(`Free unit "${O.rules.freeUnit}" is not a vehicle or infantry type.`);S=B.rules.getObject(O.rules.freeUnit,j.ObjectType.Infantry)}let N,F=B.createUnitForPlayer(S,O.owner);var D=new L.RadialBackFirstTileFinder(B.map.tiles,B.map.mapBounds,O.tile,O.getFoundation(),1,1,S=>{var j=0<B.map.terrain.getPassableSpeed(S,F.rules.speedType,F.isInfantry(),!1)&&Math.abs(S.z-O.tile.z)<2&&!B.map.terrain.findObstacles({tile:S,onBridge:void 0},F).length;return!N&&j&&(N=S),j&&!B.map.getObjectsOnTile(S).find(S=>S.isOverlay())}).getNextTile()??N;if(!D)return O.owner.removeOwnedObject(F),F.dispose(),void(O.owner.credits+=F.purchaseValue);B.spawnObject(F,D)}}},S("FreeUnitTrait",D)}}}),System.register("game/gameobject/trait/GapGeneratorTrait",["game/GameSpeed","game/map/MapShroud","game/math/Box2","game/math/Vector2","game/rules/TechnoRules","game/gameobject/unit/RangeHelper","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyWarpChange"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S}],execute:function(){z=class{constructor(S){this.radiusTiles=S,this.refreshTicks=0}[H.NotifyTick.onTick](S,O){0<this.refreshTicks&&this.refreshTicks--,this.refreshTicks<=0&&this.update(S,O)}[U.NotifySpawn.onSpawn](S,O){this.markGapTilesForFriendlies(S,S.owner,O,!0)}[V.NotifyUnspawn.onUnspawn](S,O){this.markGapTilesForFriendlies(S,S.owner,O,!1),this.update(S,O)}[_.NotifyOwnerChange.onChange](S,O,B){this.markGapTilesForFriendlies(S,O,B,!1),this.markGapTilesForFriendlies(S,S.owner,B,!0),this.update(S,B)}[W.NotifyWarpChange.onChange](S,O,B){this.markGapTilesForFriendlies(S,S.owner,O,!B),B&&this.update(S,O)}markGapTilesForFriendlies(S,O,B,j){let L,D=[O,...B.alliances.getAllies(O)];for(var _ of D){let O=B.mapShroudTrait.getPlayerShroud(_);if(O&&(O.toggleFlagsAround(S.tile,this.radiusTiles,N.ShroudFlag.Darken,j),!j)){if(!L){let O=new F.RangeHelper(B.map.tileOccupation);L=D.map(S=>[...S.buildings]).flat().filter(B=>B.gapGeneratorTrait&&B!==S&&O.tileDistance(B,S)<=B.gapGeneratorTrait.radiusTiles+this.radiusTiles)}for(var U of L)O.toggleFlagsAround(U.tile,U.gapGeneratorTrait.radiusTiles,N.ShroudFlag.Darken,!0)}}}update(S,O){let N;this.refreshTicks=5*B.GameSpeed.BASE_TICKS_PER_SECOND;var F,_,U,H,V=S.owner.buildings.has(S)&&S.poweredTrait?.isPoweredOn();for(F of O.getCombatants())if(F!==S.owner&&!O.alliances.areAllied(S.owner,F)){let B=O.mapShroudTrait.getPlayerShroud(F);if(B)if(V)for(H of(B.unrevealAround(S.tile,this.radiusTiles),N||(U=this.radiusTiles+D.TechnoRules.MAX_SIGHT,_=new L.Vector2(S.tile.rx,S.tile.ry).addScalar(-U),U=new L.Vector2(S.tile.rx,S.tile.ry).addScalar(U),N=O.map.technosByTile.queryRange(new j.Box2(_,U))),N))H.owner===F||O.alliances.areAllied(H.owner,F)?B.revealFrom(H):H.rules.revealToAll&&B.revealObject(H);else[...F.buildings].some(S=>S.rules.spySat)&&B.revealAround(S.tile,this.radiusTiles)}}},S("GapGeneratorTrait",z)}}}),System.register("game/gameobject/trait/GarrisonTrait",["game/gameobject/trait/interface/NotifyDestroy","game/map/tileFinder/RadialTileFinder","game/gameobject/trait/interface/NotifyDamage","util/math","game/event/BuildingEvacuateEvent","game/gameobject/task/ScatterTask"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class{constructor(S,O,B){this.building=S,this.evacThreshold=O,this.maxOccupants=B,this.units=[]}isOccupied(){return!!this.units.length}canBeOccupied(){return this.building.healthTrait.health>100*this.evacThreshold}[j.NotifyDamage.onDamage](S,O){S.healthTrait.health<=100*this.evacThreshold&&this.evacuate(O)}[B.NotifyDestroy.onDestroy](S,O,B,N){if(N){for(var j of this.units)j.deathType=S.deathType,O.destroyObject(j,B,!0);this.units=[]}else this.evacuate(O)}getHash(){return L.fnv32a(this.units.map(S=>S.getHash()))}debugGetState(){return{units:this.units.map(S=>S.debugGetState())}}dispose(){this.building=void 0}evacuate(S,O=!1){let B=this.building,j=this.units;if(j.length){let W=new Map;for(var L of j)W.set(L.rules.speedType,(W.get(L.rules.speedType)||[]).concat(L));for(let[L,D]of W){var _,U=new N.RadialTileFinder(S.map.tiles,S.map.mapBounds,B.tile,B.art.foundation,1,1,O=>0<S.map.terrain.getPassableSpeed(O,L,!0,!1)&&Math.abs(O.z-B.tile.z)<2&&!S.map.terrain.findObstacles({tile:O,onBridge:void 0},D[0]).length).getNextTile();for(_ of D){var H=j.indexOf(_);U?(j.splice(H,1),S.unlimboObject(_,U),_.onBridge=S.map.tileOccupation.getBridgeOnTile(U)?.isLowBridge()??!1,_.position.tileElevation=0,_.unitOrderTrait.addTask(new F.ScatterTask(S))):O||(S.destroyObject(_,{player:_.owner}),j.splice(H,1))}}var V=B.owner;j.length||B.isDestroyed||S.changeObjectOwner(B,S.getCivilianPlayer()),S.events.dispatch(new D.BuildingEvacuateEvent(B,V))}}},S("GarrisonTrait",_)}}}),System.register("game/gameobject/trait/GunnerTrait",["game/gameobject/unit/VeteranLevel","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class{[N.NotifyTick.onTick](S){var O,N;!!S.transportTrait.units.length!==this.lastHadGunner&&(this.lastHadGunner=!!S.transportTrait.units.length,N=O=S.transportTrait.units[0]?.rules.ifvMode??0,(O=S.rules.turretIndexesByIfvMode.get(O)??0)<S.rules.turretCount&&(S.turretNo=O,S.armedTrait?.selectSpecialWeapon(N,S.veteranLevel===B.VeteranLevel.Elite)))}getUiNameForIfvMode(S,O){switch(S){case 0:return"tip:rocket";case 1:return"tip:repair";case 2:case 4:case 5:return"tip:machinegun";default:return O?"name:"+O.toLowerCase():void 0}}},S("GunnerTrait",j)}}}),System.register("game/gameobject/trait/HarvesterTrait",["game/gameobject/trait/interface/NotifyTick","game/gameobject/task/harvester/ReturnOreTask","game/gameobject/task/harvester/GatherOreTask","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyOwnerChange","game/GameSpeed","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyOrder","game/order/OrderType","game/type/LandType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){var O;(O=W||S("HarvesterStatus",W={}))[O.Idle=0]="Idle",O[O.LookingForOreSite=1]="LookingForOreSite",O[O.MovingToOreSite=2]="MovingToOreSite",O[O.Harvesting=3]="Harvesting",O[O.LookingForRefinery=4]="LookingForRefinery",O[O.MovingToRefinery=5]="MovingToRefinery",O[O.Docking=6]="Docking",O[O.PreparingToUnload=7]="PreparingToUnload",O[O.Unloading=8]="Unloading",z=class{constructor(S){this.storage=S,this.ore=0,this.gems=0,this.status=W.Idle,this.lastGatherExplicit=!1,this.autoGatherOnNextIdle=!1,this.ticksSinceLastRefineryCheck=0,this.ticksSinceLastOreCheck=0}[L.NotifySpawn.onSpawn](S,O){S.owner.isCombatant()&&(O.afterTick(()=>{S.unitOrderTrait.addTask(new j.GatherOreTask(O))}),S.attackTrait?.increasePassiveScanCooldown(1))}[D.NotifyOwnerChange.onChange](S,O,B){(!O.isCombatant()&&S.owner.isCombatant()||B.alliances.areAllied(S.owner,O))&&B.afterTick(()=>{S.unitOrderTrait.addTask(new j.GatherOreTask(B))})}[B.NotifyTick.onTick](S,O){this.status===W.LookingForRefinery?this.ticksSinceLastRefineryCheck++>5*F.GameSpeed.BASE_TICKS_PER_SECOND&&(this.ticksSinceLastRefineryCheck=0,S.unitOrderTrait.hasTasks()?this.ticksSinceLastRefineryCheck=-25*F.GameSpeed.BASE_TICKS_PER_SECOND:[...S.owner.buildings].some(S=>S.rules.refinery)||this.lastGatherExplicit?S.unitOrderTrait.addTask(new N.ReturnOreTask(O)):this.status=W.Idle):this.status===W.LookingForOreSite?this.ticksSinceLastOreCheck++>20*F.GameSpeed.BASE_TICKS_PER_SECOND&&(this.ticksSinceLastOreCheck=0,S.unitOrderTrait.hasTasks()||S.unitOrderTrait.addTask(new j.GatherOreTask(O))):this.status===W.Idle&&this.autoGatherOnNextIdle&&S.unitOrderTrait.isIdle()&&S.tile.landType===V.LandType.Tiberium&&(this.autoGatherOnNextIdle=!1,S.unitOrderTrait.addTask(new j.GatherOreTask(O,S.tile,!0)))}[_.NotifyTeleport.onBeforeTeleport](S,O,B,L){!L&&S.owner.isCombatant()&&(this.status=W.Idle,this.lastOreSite=void 0,B&&S.rules.teleporter&&O.afterTick(()=>{S.unitOrderTrait.addTask(new(this.isFull()?N.ReturnOreTask:j.GatherOreTask)(O))}))}[U.NotifyOrder.onPush](S,O){this.autoGatherOnNextIdle=[H.OrderType.AttackMove,H.OrderType.Move,H.OrderType.ForceMove,H.OrderType.Scatter].includes(O),[W.LookingForRefinery,W.LookingForOreSite].includes(this.status)&&(this.status=W.Idle)}isFull(){return this.ore+this.gems>=this.storage}isEmpty(){return!this.ore&&!this.gems}getHash(){return 100*this.ore+this.gems}debugGetState(){return{ore:this.ore,gems:this.gems}}},S("HarvesterTrait",z)}}}),System.register("game/gameobject/trait/HealthTrait",["util/math","game/gameobject/trait/interface/NotifyDamage","game/trait/interface/NotifyHealthChange","game/event/InflictDamageEvent","game/gameobject/trait/interface/NotifyHealthChange","game/gameobject/trait/interface/NotifyHeal","game/gameobject/unit/HealthLevel","game/gameobject/trait/interface/NotifyTick","game/event/HealthChangeEvent"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S}],execute:function(){V=class{get health(){return this._computedHealth}set health(S){this.setHitPoints(0<S?Math.max(1,Math.floor(S*this.maxHitPoints/100)):0),this.projectedHitPoints=this.hitPoints}get level(){return this.health>100*this.conditionYellow?_.HealthLevel.Green:this.health>100*this.conditionRed?_.HealthLevel.Yellow:_.HealthLevel.Red}constructor(S,O,B,N){this.maxHitPoints=S,this.gameObject=O,this.conditionYellow=B,this.conditionRed=N,this.setHitPoints(S),this.projectedHitPoints=this.hitPoints}setHitPoints(S){if(S!==Math.floor(S))throw new Error(`Value ${S} is not an integer`);this.hitPoints=B.clamp(S,0,this.maxHitPoints),this._computedHealth=this.hitPoints/this.maxHitPoints*100}getHitPoints(){return this.hitPoints}getProjectedHitPoints(){return this.projectedHitPoints}inflictDamage(S,O,B){var j=this.hitPoints,D=this.health;this.applyHitPoints(j-S,B),j!==this.hitPoints&&0<S&&(this.gameObject.traits.filter(N.NotifyDamage).forEach(j=>{j[N.NotifyDamage.onDamage](this.gameObject,B,S,O)}),B.events.dispatch(new L.InflictDamageEvent(this.gameObject,O,S,this.health,D)))}healBy(S,O,B){if(S<0)throw new Error("Can't heal by negative value "+S);if(this.hitPoints<this.maxHitPoints){var N=this.hitPoints;this.applyHitPoints(this.hitPoints+S,B),this.projectedHitPoints=this.hitPoints;let j=this.hitPoints-N;this.gameObject.traits.filter(F.NotifyHeal).forEach(S=>{S[F.NotifyHeal.onHeal]?.(this.gameObject,B,j,O)})}}healToFull(S,O){if(this.hitPoints<this.maxHitPoints){var B=this.hitPoints;this.applyHitPoints(this.maxHitPoints,O),this.projectedHitPoints=this.hitPoints;let N=this.hitPoints-B;this.gameObject.traits.filter(F.NotifyHeal).forEach(B=>{B[F.NotifyHeal.onHeal]?.(this.gameObject,O,N,S)})}}applyHitPoints(S,O){let B=this.health;this.setHitPoints(S),B!==this.health&&(O.traits.filter(j.NotifyHealthChange).forEach(S=>{S[j.NotifyHealthChange.onChange](this.gameObject,O,B)}),this.gameObject.traits.filter(D.NotifyHealthChange).forEach(S=>{S[D.NotifyHealthChange.onChange](this.gameObject,O,B)}),O.events.dispatch(new H.HealthChangeEvent(this.gameObject,this.health,B)))}projectDamage(S){if(S<0)throw new Error("Projected damage must be positive");this.projectedHitPoints=Math.max(-30,this.projectedHitPoints-S)}[U.NotifyTick.onTick](S,O){O.currentTick%4==0&&(this.projectedHitPoints=Math.min(this.projectedHitPoints+1,this.hitPoints))}getHash(){return this.hitPoints}debugGetState(){return{hitPoints:this.hitPoints}}dispose(){this.gameObject=void 0}},S("HealthTrait",V)}}}),System.register("game/gameobject/trait/HelipadTrait",["engine/type/ObjectType","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifyUnspawn"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class{[N.NotifyOwnerChange.onChange](S,O,B){this.checkAircraftsForPlayer(O,B)}[j.NotifyUnspawn.onUnspawn](S,O){this.checkAircraftsForPlayer(S.owner,O)}checkAircraftsForPlayer(S,O){let N=O.rules.general.padAircraft;var j;for(j of S.getOwnedObjectsByType(B.ObjectType.Aircraft).filter(S=>N.includes(S.name)))j.airportBoundTrait&&(j.airportBoundTrait.preferredAirport=void 0)}},S("HelipadTrait",L)}}}),System.register("game/gameobject/trait/HospitalTrait",["engine/type/ObjectType","game/event/UnitRepairFinishEvent","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/gameobject/task/ScatterTask","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){U=class{constructor(){this.healQueue=[]}addToHealQueue(S){return this.healQueue.push(S),this.healQueue.length-1}unitIsFirstInHealQueue(S){return this.healQueue[0]===S}removeFromHealQueue(S){var O=this.healQueue.indexOf(S);-1!==O&&this.healQueue.splice(O,1)}startHealing(S){if(this.unit)throw new Error(`Already busy healing unit ${B.ObjectType[this.unit.type]}#${this.unit.id}}`);this.unit=S,this.healTicks=5*j.GameSpeed.BASE_TICKS_PER_SECOND}[_.NotifyTick.onTick](S,O){var B;this.healQueue=this.healQueue.filter(S=>!S.isDestroyed&&!S.isCrashing),this.unit&&void 0!==this.healTicks&&(0<this.healTicks&&this.healTicks--,this.healTicks<=0&&(this.healTicks=void 0,this.removeFromHealQueue(this.unit),this.unit.healthTrait.healToFull(S,O),S.ammoTrait&&S.ammoTrait.ammo--,this.evacuate(this.unit,S,O),B=this.unit,this.unit=void 0,O.events.dispatch(new N.UnitRepairFinishEvent(B,S))))}[F.NotifyDestroy.onDestroy](S,O,B){this.unit&&(this.unit.deathType=S.deathType,O.destroyObject(this.unit,B,!0),this.unit=void 0)}evacuate(S,O,B){let N;var j={x:O.tile.rx,y:O.tile.ry+O.art.foundation.height};(j=B.map.tiles.getByMapCoords(j.x,j.y))&&B.map.isWithinBounds(j)&&this.canEvacuateTo(j,S,O,B)&&(N=j),N=N||new L.RadialTileFinder(B.map.tiles,B.map.mapBounds,O.tile,O.art.foundation,1,1,N=>this.canEvacuateTo(N,S,O,B)).getNextTile(),N?(B.unlimboObject(S,N),S.unitOrderTrait.addTask(new D.ScatterTask(B))):B.destroyObject(S,{player:S.owner})}canEvacuateTo(S,O,B,N){return 0<N.map.terrain.getPassableSpeed(S,O.rules.speedType,O.isInfantry(),!1)&&Math.abs(S.z-B.tile.z)<2&&!N.map.terrain.findObstacles({tile:S,onBridge:void 0},O).length}},S("HospitalTrait",U)}}}),System.register("game/gameobject/trait/HoverBobTrait",["game/GameSpeed","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifySpawn","game/Coords","game/gameobject/trait/interface/NotifyTileChange","game/math/GameMath"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class{constructor(){this.prevHoverBobLeptons=0,this.spawnTick=0}[j.NotifySpawn.onSpawn](S,O){this.setBaseElevation(S,O),this.spawnTick=O.currentTick}[D.NotifyTileChange.onTileChange](S,O,B,N){N&&(this.prevHoverBobLeptons=0,this.setBaseElevation(S,O))}setBaseElevation(S,O){S.position.tileElevation=(S.onBridge?O.map.tileOccupation.getBridgeOnTile(S.tile)?.tileElevation??0:0)+L.Coords.worldToTileHeight(O.rules.general.hover.height)}[N.NotifyTick.onTick](S,O){var B=this.computeHoverBobLeptons(O.currentTick,O.rules.general.hover),N=B-this.prevHoverBobLeptons;this.prevHoverBobLeptons=B,B=L.Coords.tileHeightToWorld(S.position.tileElevation),S.position.tileElevation=L.Coords.worldToTileHeight(B+N)}computeHoverBobLeptons(S,O){var N=(S-this.spawnTick)/B.GameSpeed.BASE_TICKS_PER_SECOND/(60*O.bob);return.1*O.height*F.GameMath.sin(2*N*Math.PI)}},S("HoverBobTrait",_)}}}),System.register("game/gameobject/trait/IdleActionTrait",["game/gameobject/trait/interface/NotifyTick","game/gameobject/task/ScatterTask","game/GameSpeed"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class{constructor(){this.cooldownTicks=Number.POSITIVE_INFINITY,this._actionDueThisTick=!1}[B.NotifyTick.onTick](S,O){this._actionDueThisTick=!1;var B=!S.unitOrderTrait.hasTasks();B&&!this.idle?this.resetCooldown(O):B?0===this.cooldownTicks?(this.doIdleAction(S,O),this.resetCooldown(O)):this.cooldownTicks--:this.cooldownTicks=Number.POSITIVE_INFINITY,this.idle=B}doIdleAction(S,O){if(S.isInfantry()){if(S.rules.fraidycat&&.5<O.generateRandom())return void S.unitOrderTrait.addTask(new N.ScatterTask(O,void 0,{noSlopes:!0}));this._actionDueThisTick=!0}}actionDueThisTick(){return this._actionDueThisTick}resetCooldown(S){var O=S.rules.audioVisual.idleActionFrequency,B=S.generateRandom()*O*.5;B=Math.max(0,O-B),this.cooldownTicks=Math.floor(B*j.GameSpeed.BASE_TICKS_PER_SECOND)}},S("IdleActionTrait",L)}}}),System.register("game/gameobject/trait/InvulnerableTrait",["game/gameobject/unit/Timer","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class{constructor(){this.timer=new B.Timer}isActive(){return this.timer.isActive()}setActiveFor(S,O){this.timer.setActiveFor(S,O)}[N.NotifyTick.onTick](S,O){this.timer.tick(O.currentTick)}},S("InvulnerableTrait",j)}}}),System.register("game/gameobject/trait/MindControllableTrait",["game/gameobject/trait/interface/NotifyUnspawn"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class{constructor(S){this.gameObject=S}getOriginalOwner(){return this.prevOwner}isActive(){return!!this.controller}getController(){return this.controller}controlBy(S,O){if(this.controller)throw new Error(`Object "${this.gameObject?.name}" is already mind controlled by "${S.name}"`);this.controller=S,this.prevOwner=this.gameObject.owner,O.changeObjectOwner(this.gameObject,S.owner)}restore(S){this.prevOwner&&(S.changeObjectOwner(this.gameObject,this.prevOwner),this.prevOwner=void 0,this.controller=void 0)}[B.NotifyUnspawn.onUnspawn](S,O){this.controller&&(this.controller.mindControllerTrait.cleanTarget(S),!S.isDestroyed&&S.limboData&&this.restore(O))}dispose(){this.gameObject=void 0}},S("MindControllableTrait",N)}}}),System.register("game/gameobject/trait/MindControllerTrait",["game/gameobject/trait/interface/NotifyUnspawn"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class{constructor(S,O=1){this.gameObject=S,this.maxCapacity=O,this.targets=[]}isActive(){return 0<this.targets.length}isAtCapacity(){return this.targets.length===this.maxCapacity}getTargets(){return this.targets}control(S,O){if(!this.gameObject)throw new Error("Trait already disposed");if(!S.mindControllableTrait)throw new Error(`Target "${S.name}" cannot be mind controlled`);if(S.isDisposed)throw new Error(`Target "${S.name}" is disposed`);for(S.mindControllableTrait.controlBy(this.gameObject,O),this.targets.push(S);this.targets.length>this.maxCapacity;)this.targets.shift().mindControllableTrait.restore(O)}cleanTarget(S){var O=this.targets.indexOf(S);-1!==O&&this.targets.splice(O,1)}[B.NotifyUnspawn.onUnspawn](S,O){for(var B of this.targets)B.mindControllableTrait.restore(O);this.targets.length=0}dispose(){this.gameObject=void 0}},S("MindControllerTrait",N)}}}),System.register("game/gameobject/trait/MissileSpawnTrait",["game/gameobject/unit/CollisionType","game/gameobject/trait/interface/NotifyDestroy"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class{setWarhead(S){return this.warhead=S,this}setDamage(S){return this.damage=S,this}setLauncher(S){return this.launcher=S,this}[N.NotifyDestroy.onDestroy](S,O){this.warhead&&this.damage&&this.launcher&&this.warhead.detonate(O,this.damage,S.tile,S.tileElevation,S.position.worldPosition,S.zone,B.CollisionType.None,O.createTarget(void 0,S.tile),{player:S.owner,obj:this.launcher,weapon:void 0})}dispose(){this.launcher=void 0}},S("MissileSpawnTrait",j)}}}),System.register("game/gameobject/trait/MoveTrait",["game/gameobject/task/move/MoveTask","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/unit/ZoneType","game/gameobject/infantry/InfDeathType","game/event/ObjectTeleportEvent","game/gameobject/common/DeathType","game/gameobject/trait/interface/NotifyTeleport","game/type/LocomotorType","game/gameobject/locomotor/JumpjetLocomotor","game/type/SpeedType","game/gameobject/locomotor/WingedLocomotor","game/gameobject/infantry/StanceType","game/trait/interface/NotifyTileChange","game/gameobject/trait/interface/NotifyTileChange","game/event/EnterTileEvent","game/math/Vector3","game/trait/interface/NotifyElevationChange"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S}],execute:function(){var O;(O=X||S("MoveState",X={}))[O.Idle=0]="Idle",O[O.ReachedNextWaypoint=1]="ReachedNextWaypoint",O[O.PlanMove=2]="PlanMove",O[O.Moving=3]="Moving",(O=J||S("MoveResult",J={}))[O.Success=0]="Success",O[O.Cancel=1]="Cancel",O[O.CloseEnough=2]="CloseEnough",O[O.Fail=3]="Fail",(O=ee||S("CollisionState",ee={}))[O.Waiting=0]="Waiting",O[O.Resolved=1]="Resolved",te=S=>S instanceof B.MoveTask||S.children[0]&&te(S.children[0]),ie=class{get baseSpeed(){return this.gameObject.rules.speed*(this.gameObject.veteranTrait?.getVeteranSpeedMultiplier()??1)*this.gameObject.crateBonuses.speed*(this.gameObject.isVehicle()&&this.gameObject.healthTrait.health<=50&&this.gameObject.rules.locomotor!==H.LocomotorType.Hover?.75:1)*(1-this.speedPenalty)}constructor(S,O){this.gameObject=S,this.tileOccupation=O,this.disabled=!1,this.speedPenalty=0,this.velocity=new Z.Vector3,this.reservedPathNodes=[],this.moveState=X.Idle,this.collisionState=ee.Resolved}isDisabled(){return this.disabled}setDisabled(S){this.disabled=S}isMoving(){return this.moveState===X.Moving}isIdle(){return this.moveState===X.Idle}isWaiting(){return this.collisionState===ee.Waiting}[N.NotifyTick.onTick](S,O){var B;this.moveState!==X.Idle&&this.collisionState===ee.Resolved&&((B=S.unitOrderTrait.getCurrentTask())&&te(B)||(this.velocity.set(0,0,0),this.moveState=X.Idle,this.locomotor=void 0,!B&&!S.attackTrait?.currentTarget&&S.isVehicle()&&S.turretTrait&&(S.turretTrait.desiredFacing=S.direction))),this.moveState===X.Idle&&(S.rules.locomotor===H.LocomotorType.Jumpjet?V.JumpjetLocomotor.tickStationary(S,O):S.isAircraft()&&S.rules.locomotor===H.LocomotorType.Aircraft&&z.WingedLocomotor.tickStationary(S,O))}[j.NotifyDestroy.onDestroy](S,O){this.unreservePathNodes()}teleportUnitToTile(S,O,B,N,j){let L=this.gameObject;var D=L.tile;L.traits.filter(U.NotifyTeleport).forEach(S=>{S[U.NotifyTeleport.onBeforeTeleport](L,j,B,N)}),L.position.tileElevation=L.tileElevation,L.position.tile=S,L.position.subCell=L.position.desiredSubCell,this.handleTileChange(D,O,!0,j,!0),N||(this.unreservePathNodes(),this.speedPenalty=0,this.velocity.set(0,0,0),this.moveState=X.Idle,this.collisionState=ee.Resolved,this.locomotor=void 0,this.currentWaypoint=void 0,this.lastTargetOffset=void 0,this.lastVelocity=void 0,this.lastMoveResult=J.Cancel,L.isVehicle()&&(L.spinVelocity=0,L.turretTrait&&(L.turretTrait.desiredFacing=L.direction))),this.lastTeleportTick=j.currentTick,j.events.dispatch(new F.ObjectTeleportEvent(L,B,D))}handleTileChange(S,O,B,N,j=!1){const F=this.gameObject;if(N.map.tileOccupation.unoccupyTileRange(S,F),N.map.tileOccupation.occupyTileRange(F.tile,F),N.map.technosByTile.updateObject(F),F.zone!==L.ZoneType.Air){var U,H=F.onBridge?N.map.tileOccupation.getBridgeOnTile(S):void 0,V=F.onBridge?S.onBridgeLandType:S.landType,z=O?F.tile.onBridgeLandType:F.tile.landType;if(V!==z&&(0<N.rules.getLandRules(z).getSpeedModifier(F.rules.speedType)||F.rules.speedType===W.SpeedType.Amphibious||j)&&(F.zone=L.getZoneType(z)),O!==H&&(F.position.tileElevation+=-(H?.tileElevation??0)+(O?.tileElevation??0),F.onBridge=!!O),H=F.moveTrait.reservedPathNodes.findIndex(S=>S.tile===F.tile),-1!==H&&F.moveTrait.reservedPathNodes.splice(H,1),F.crusher)for(U of N.map.getGroundObjectsOnTile(F.tile).filter(S=>(!S.isUnit()||S.onBridge===F.onBridge)&&S.rules.crushable&&!(S.isInfantry()&&S.stance===K.StanceType.Paradrop)&&(!(S.isTechno()&&!B)||!N.areFriendly(S,F))))U.isDestroyed||(U.isInfantry()&&(U.infDeathType=D.InfDeathType.None),F.isVehicle()&&U.isOverlay()&&U.rules.wall&&F.applyRocking(0,.5),U.deathType=_.DeathType.Crush,N.destroyObject(U,{player:F.owner,obj:F}));F.onBridge||(H=N.map.tileOccupation.getGroundObjectsOnTile(F.tile).find(S=>S.isOverlay()&&S.rules.crate))&&N.crateGeneratorTrait.pickupCrate(F,H,N)}N.traits.filter($.NotifyTileChange).forEach(O=>{O[$.NotifyTileChange.onTileChange](F,N,S,j)}),F.traits.filter(q.NotifyTileChange).forEach(O=>{O[q.NotifyTileChange.onTileChange](F,N,S,j)}),N.events.dispatch(new Q.EnterTileEvent(F.tile,F))}handleElevationChange(S,O){O.traits.filter(Y.NotifyElevationChange).forEach(B=>{B[Y.NotifyElevationChange.onElevationChange](this.gameObject,O,S)})}unreservePathNodes(){this.reservedPathNodes.forEach(S=>{S.tile!==this.gameObject.tile&&this.tileOccupation.unoccupySingleTile(S.tile,this.gameObject)}),this.reservedPathNodes.length=0}dispose(){this.gameObject=void 0}},S("MoveTrait",ie)}}}),System.register("game/gameobject/trait/OilDerrickTrait",["game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifySpawn"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class{constructor(){this.isActive=!1,this.produceCashCooldown=0}[j.NotifySpawn.onSpawn](S){S.owner.isNeutral||(this.isActive=!0)}[B.NotifyOwnerChange.onChange](S,O){O.isNeutral&&!S.owner.isNeutral&&(S.owner.credits=Math.max(0,S.owner.credits+S.rules.produceCashStartup),this.isActive=!0,this.produceCashCooldown=S.rules.produceCashDelay)}[N.NotifyTick.onTick](S){this.isActive&&(this.produceCashCooldown--,this.produceCashCooldown<=0&&(this.produceCashCooldown=S.rules.produceCashDelay,S.owner.credits=Math.max(0,S.owner.credits+S.rules.produceCashAmount)))}},S("OilDerrickTrait",L)}}}),System.register("game/gameobject/trait/OverpoweredTrait",["game/gameobject/task/AttackTask","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class{constructor(S){this.obj=S,this.chargers=new Set}isOverpowered(){let S=1;return this.obj?.poweredTrait?.isPoweredOn(!0)||(S+=2),this.chargers.size>=S}hasChargersToPowerOn(){return 2<=this.chargers.size}chargeFrom(S){this.chargers.add(S),this.swapAttackTaskWeapon()}[N.NotifyTick.onTick](S){if(0<this.chargers.size){let O=!1;this.chargers.forEach(B=>{(B.isDestroyed||B.isCrashing||B.owner!==S.owner||B.attackTrait?.currentTarget?.obj!==S)&&(this.chargers.delete(B),O=!0)}),O&&this.swapAttackTaskWeapon()}}swapAttackTaskWeapon(){let S=this.obj?.unitOrderTrait.getCurrentTask();var O;S instanceof B.AttackTask&&((O=this.getWeapon())?S.setWeapon(O):S.cancel())}getWeapon(){return this.isOverpowered()?this.obj?.secondaryWeapon:this.obj?.primaryWeapon}dispose(){this.obj=void 0,this.chargers.clear()}},S("OverpoweredTrait",j)}}}),System.register("game/gameobject/trait/ParasiteableTrait",["game/gameobject/common/DeathType","game/gameobject/unit/ZoneType","game/gameobject/Vehicle","game/gameobject/trait/interface/NotifyAttack","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyHeal","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyTick","game/gameobject/task/system/WaitMinutesTask","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/gameobject/task/AttackTask"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S}],execute:function(){$=()=>j.ROCKING_TICKS+2,q=class{constructor(S){this.gameObject=S,this.beingBoarded=!1}infest(S,O){this.beingBoarded=!1,this.parasite=S,this.parasiteWeapon=O,S.rules.organic?this.damageTickCooldown=$():this.damageTickCooldown=0,this.lastExternalDamageInflicted=void 0,this.lastExternalDamageTick=void 0,O.warhead.rules.paralyzes&&this.gameObject.moveTrait.setDisabled(!0)}isInfested(){return!(!this.parasite||this.parasite.isDestroyed)||this.beingBoarded}isParalyzed(){return!!this.parasiteWeapon?.warhead.rules.paralyzes}uninfest(){this.parasite&&(this.parasiteWeapon.warhead.rules.paralyzes&&this.gameObject.moveTrait.setDisabled(!1),this.parasite=void 0,this.parasiteWeapon=void 0)}getParasite(){return this.parasite}[H.NotifyTick.onTick](S,O){if(this.parasite)if(this.parasite.isDestroyed)this.uninfest();else if(0<this.damageTickCooldown)this.damageTickCooldown--;else{let B=this.parasiteWeapon;this.damageTickCooldown=this.parasite.rules.organic?$():B.getCooldownTicks();let j=B.rules.damage;this.parasite.veteranTrait&&(j*=this.parasite.veteranTrait.getVeteranDamageMultiplier());let L=B.warhead.computeDamage(j,S,O);this.canBeCulled(S,this.parasite,B,O)&&(L=S.healthTrait.getHitPoints()),B.warhead.inflictDamage(L,S,{player:this.parasite.owner,obj:this.parasite,weapon:B},O),S.isCrashing?(this.parasiteWeapon.expireCooldown(),this.evictOrDestroyParasite(S,O)):!S.isDestroyed&&S.isVehicle()&&S.zone!==N.ZoneType.Air&&B.warhead.rules.rocker&&S.applyRocking(90*(.5<=O.generateRandom()?1:-1),1)}}canBeCulled(S,O,B,N){if(!B.warhead.rules.culling)return!1;var j=N.rules.audioVisual;return j=O.veteranTrait?.isElite()?j.conditionYellow:j.conditionRed,S.healthTrait.health<=100*j}[F.NotifyHeal.onHeal](S,O,N,j){var L;!this.parasite||this.parasite.isDestroyed||j===S||S.isAircraft()&&j?.rules.unitReload||(this.parasite.rules.organic?(L=this.parasite,this.evictOrDestroyParasite(S,O),this.stunParasite(L,O)):(this.parasite.deathType=B.DeathType.None,O.destroyObject(this.parasite,j?{player:j.owner,obj:j}:void 0),this.uninfest()))}[_.NotifyDamage.onDamage](S,O,B,N){N?.obj!==this.parasite&&(this.lastExternalDamageInflicted=B,this.lastExternalDamageTick=O.currentTick)}[L.NotifyAttack.onAttack](S,O,B){if(this.parasite&&!this.parasite.isDestroyed&&O?.weapon?.warhead.rules.sonic){var N,j=this.parasite;this.evictOrDestroyParasite(S,B),this.stunParasite(j,B);let L=O.weapon.warhead;L.canDamage(j,j.tile,j.zone)&&(N=L.computeDamage(O.weapon.rules.damage,j,B),L.inflictDamage(N,j,O,B));let D=O.obj?.unitOrderTrait.getCurrentTask();D instanceof K.AttackTask&&D.getWeapon().warhead.rules.sonic&&D.cancel()}}[D.NotifyDestroy.onDestroy](S,O,N,j){this.parasite&&!this.parasite.isDestroyed&&(j||!this.parasite.invulnerableTrait.isActive()&&this.shouldSupressParasite(O,this.parasite,N)?(this.parasite.deathType=B.DeathType.None,O.destroyObject(this.parasite,N,j),this.uninfest()):(this.parasiteWeapon.expireCooldown(),this.evictOrDestroyParasite(S,O)))}shouldSupressParasite(S,O,B){return B?.obj!==O||this.lastExternalDamageInflicted&&this.lastExternalDamageInflicted>O.rules.suppressionThreshold&&S.currentTick-this.lastExternalDamageTick<2*this.lastExternalDamageInflicted}[U.NotifyTeleport.onBeforeTeleport](S,O,B,N){var j;B&&N&&this.parasite&&!this.parasite.isDestroyed&&(this.parasiteWeapon.expireCooldown(),j=this.parasite,this.evictOrDestroyParasite(S,O,!0),j.isDestroyed||this.stunParasite(j,O))}stunParasite(S,O){S.unitOrderTrait.addTaskToFront(new V.WaitMinutesTask(10/60).setCancellable(!1)),S.isVehicle()&&S.submergibleTrait&&(S.submergibleTrait.emerge(S,O),S.cloakableTrait?.uncloak(O),S.submergibleTrait.setCooldown(10*W.GameSpeed.BASE_TICKS_PER_SECOND))}evictOrDestroyParasite(S,O,N=!1){if(this.parasite&&!this.parasite.isDestroyed){if(O.map.terrain.getPassableSpeed(S.tile,this.parasite.rules.speedType,this.parasite.isInfantry(),S.onBridge)||O.map.getObjectsOnTile(S.tile).find(S=>S.isBuilding())){let L=S.tile,D=S.onBridge;if(!N&&!S.isDestroyed||this.parasite.rules.organic){var j=new z.RadialTileFinder(O.map.tiles,O.map.mapBounds,L,{width:1,height:1},1,1,S=>0<O.map.terrain.getPassableSpeed(S,this.parasite.rules.speedType,this.parasite.isInfantry(),D)&&!O.map.terrain.findObstacles({tile:S,onBridge:D},this.parasite).length).getNextTile();if(!j)return this.parasite.deathType=B.DeathType.None,O.destroyObject(this.parasite,{player:S.owner,obj:S}),void this.uninfest();L=j}this.parasite.onBridge=D,this.parasite.position.subCell=this.parasite.isInfantry()?S.position.subCell:0,this.parasite.zone=O.map.getTileZone(L,!D),this.parasite.position.tileElevation=D?O.map.tileOccupation.getBridgeOnTile(L).tileElevation:0,this.parasite.resetGuardModeToIdle(),O.unlimboObject(this.parasite,L,!0)}else this.parasite.deathType=B.DeathType.None,O.destroyObject(this.parasite,{player:S.owner,obj:S});this.uninfest()}}destroyParasite(S,O){this.parasite&&(this.parasite.deathType=B.DeathType.None,O.destroyObject(this.parasite,S),this.uninfest())}dispose(){this.gameObject=void 0}},S("ParasiteableTrait",q)}}}),System.register("game/gameobject/trait/PoweredTrait",["game/player/trait/PowerTrait"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("PoweredTrait",class{constructor(S){this.obj=S,this.turnedOn=!0}setTurnedOn(S){this.turnedOn=S}isCharged(){return!!this.obj.isBuilding()&&!!this.obj.overpoweredTrait?.hasChargersToPowerOn()}isPoweredOn(S=!1){return!(!this.obj||!this.turnedOn||(S||!this.isCharged())&&(!this.obj.rules.power&&this.obj.rules.needsEngineer?this.obj.owner.isNeutral:!this.obj.owner.powerTrait||this.obj.owner.powerTrait?.level===B.PowerLevel.Low))}dispose(){this.obj=void 0}})}}}),System.register("game/gameobject/trait/PsychicDetectorTrait",["game/Coords","game/GameSpeed","game/gameobject/unit/RangeHelper","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyWarpChange"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=N.GameSpeed.BASE_TICKS_PER_SECOND,_=class{constructor(S){this.radiusTiles=S,this.detectionLines=[],this.nextScan=F}[L.NotifyTick.onTick](S,O){S.owner.powerTrait?.isLowPower()?this.disable():(0<this.nextScan&&this.nextScan--,this.nextScan<=0&&(this.nextScan=F,this.detectionLines=this.scan(S,O)))}[D.NotifyWarpChange.onChange](S,O,B){B&&this.disable()}disable(){this.detectionLines.length&&(this.detectionLines=[],this.nextScan=0)}scan(S,O){var N=O.getCombatants().filter(B=>B!==S.owner&&!O.alliances.areAllied(B,S.owner));let L=[],D=new j.RangeHelper(O.map.tileOccupation);var F,_,U,h=O=>D.distance2(O,S)/B.Coords.LEPTONS_PER_TILE<=this.radiusTiles;for(F of N)for(var H of F.getOwnedObjects())H.attackTrait?.currentTarget?h((_=H.attackTrait.currentTarget).obj??_.tile)&&L.push({source:H,target:_}):H.isUnit()&&H.unitOrderTrait.targetLinesConfig&&((U=H.unitOrderTrait.targetLinesConfig).target?h(U.target)&&(_=O.createTarget(U.target,U.target.tile),L.push({source:H,target:_})):(U=U.pathNodes[0])&&h(U.tile)&&(U=O.createTarget(U.onBridge,U.tile),L.push({source:H,target:U})));return L}},S("PsychicDetectorTrait",_)}}}),System.register("game/gameobject/trait/RallyTrait",["engine/type/TerrainType","game/map/tileFinder/RadialTileFinder","game/rules/TechnoRules","game/type/MovementZone","game/type/SpeedType"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){S("RallyTrait",class{getRallyPoint(){return this.rallyPoint}changeRallyPoint(S,O,B){var N=this.findValidRallyPoint(O,S,B.map);N&&(this.rallyPoint=N)}findValidRallyPoint(S,O,L){let F=new N.RadialTileFinder(L.tiles,L.mapBounds,O,{width:1,height:1},0,20,O=>S.rules.naval===(O.terrainType===B.TerrainType.Water)&&!L.tileOccupation.isTileOccupiedBy(O,S)),_=F.getNextTile();if(!_&&S.factoryTrait?.type===j.FactoryType.NavalUnitType){var{width:U,height:H}=S.getFoundation();for(let O=0;O<U;O++)for(let B=0;B<H;B++){var V=L.tiles.getByMapCoords(S.tile.rx+O,S.tile.ry+B);if(!V)break;if(0<L.terrain.getPassableSpeed(V,D.SpeedType.Float,!1,!1)){_=V;break}}}return _}findRallyNodeForUnit(S,O){if(this.rallyPoint){var B=this.findRallyPointforUnit(S,this.rallyPoint,O,!0);return{tile:B,onBridge:S.rules.naval?void 0:O.tileOccupation.getBridgeOnTile(B)}}}findRallyPointforUnit(S,O,B,j,D){let F=S.rules.naval?void 0:B.tileOccupation.getBridgeOnTile(O),_=S.rules.movementZone===L.MovementZone.Fly,U=new N.RadialTileFinder(B.tiles,B.mapBounds,O,{width:1,height:1},0,5,O=>{var N=!F||F.isHighBridge()?B.tileOccupation.getBridgeOnTile(O):void 0;return!(_?[]:B.terrain.findObstacles({tile:O,onBridge:N},S)).length&&(void 0===D||Math.abs(D-(O.z+(N?.tileElevation??0)))<4)&&(!j||!B.getObjectsOnTile(O).find(S=>S.isBuilding()&&!S.isDestroyed))&&(_||0<B.terrain.getPassableSpeed(O,S.rules.speedType,S.isInfantry(),!!N))});return U.getNextTile()??O}})}}}),System.register("game/gameobject/trait/SelfHealingTrait",["game/gameobject/trait/interface/NotifyTick","game/GameSpeed"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class{constructor(){this.cooldownTicks=0}[B.NotifyTick.onTick](S,O){100!==S.healthTrait.health&&(this.cooldownTicks<=0?(this.cooldownTicks+=N.GameSpeed.BASE_TICKS_PER_SECOND*O.rules.general.repair.repairRate*60,S.healthTrait.healBy(1,S,O)):this.cooldownTicks--)}},S("SelfHealingTrait",j)}}}),System.register("game/gameobject/trait/SensorsTrait",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("SensorsTrait",class{})}}}),System.register("game/gameobject/trait/SpawnDebrisTrait",["engine/type/ObjectType","game/gameobject/common/DeathType","game/gameobject/trait/interface/NotifyCrash","game/gameobject/trait/interface/NotifyDestroy"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class{[j.NotifyCrash.onCrash](S,O){this.handleDestroy(S,O)}[L.NotifyDestroy.onDestroy](S,O,B){B?.weapon?.warhead.rules.temporal||S.isCrashing||S.deathType!==N.DeathType.Sink&&S.isSpawned&&this.handleDestroy(S,O)}handleDestroy(S,O){var B,N;(S.isVehicle()||S.isBuilding()||S.isOverlay())&&(B=S.isOverlay()?0:S.rules.minDebris,N=S.isOverlay()?O.rules.general.bridgeVoxelMax:S.rules.maxDebris,0<(N=O.generateRandomInt(B,N))&&this.spawnDebris(S,O,N))}spawnDebris(S,O,N){let j=S.position.getMapPosition();if(O.map.isWithinHardBounds(j)){let L=S.isOverlay()?[]:S.isVehicle()?S.rules.debrisTypes:S.rules.debrisAnims;L.length||(L=O.rules.audioVisual.metallicDebris),L=L.filter(S=>O.rules.hasObject(S,B.ObjectType.VoxelAnim)||O.art.hasObject(S,B.ObjectType.Animation)),new Array(N).fill(0).map(()=>L[O.generateRandomInt(0,L.length-1)]).map(S=>O.createObject(B.ObjectType.Debris,S)).forEach(B=>{B.position.moveToLeptons(j),B.position.tileElevation=S.position.tileElevation,O.spawnObject(B,B.position.tile)})}}},S("SpawnDebrisTrait",D)}}}),System.register("game/gameobject/trait/SpawnLinkTrait",["game/gameobject/task/AttackTask","game/gameobject/task/move/MoveTask","game/gameobject/unit/RangeHelper","game/gameobject/trait/AttackTrait","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class{setParent(S){this.parent=S}getParent(){return this.parent}[D.NotifyTick.onTick](S,O){if(this.parent&&S.attackTrait&&S.primaryWeapon){let F=this.parent.attackTrait?.currentTarget,_=S.unitOrderTrait.getCurrentTask(),U=new j.RangeHelper(O.map.tileOccupation);var D=this.parent.armedTrait?.getWeapons().find(S=>S.rules.spawner);S.ammo&&!(F&&S.attackTrait.currentTarget?F.equals(S.attackTrait.currentTarget):F===S.attackTrait.currentTarget||!F&&this.parent.isUnit()&&(this.parent.unitOrderTrait.getCurrentTask()instanceof N.MoveTask||this.parent.unitOrderTrait.getCurrentTask()instanceof B.AttackTask))&&(!F||D&&U.isInWeaponRange(this.parent,F.obj??F.tile,D,O.rules))?F&&S.primaryWeapon.targeting.canTarget(F.obj,F.tile,O,!0,!1)?!_||_ instanceof N.MoveTask?(S.unitOrderTrait.cancelAllTasks(),S.unitOrderTrait.addTask(S.attackTrait.createAttackTask(O,F.obj,F.tile,S.primaryWeapon,{force:!0}))):S.attackTrait.attackState!==L.AttackState.Idle&&_.requestTargetUpdate(F):_?_ instanceof N.MoveTask||_.cancel():this.tryMoveToParent(S,this.parent,O):this.tryMoveToParent(S,this.parent,O)}}tryMoveToParent(S,O,B){if(S.tile!==O.tile){let j=S.unitOrderTrait.getCurrentTask();j?j instanceof N.MoveTask&&j.updateTarget(O.tile,!!O.isUnit()&&O.onBridge):S.unitOrderTrait.addTask(new N.MoveTask(B,O.tile,!!O.isUnit()&&O.onBridge,{closeEnoughTiles:0,strictCloseEnough:!0}))}}},S("SpawnLinkTrait",F)}}}),System.register("game/gameobject/trait/SubmergibleTrait",["game/event/ShipSubmergeChangeEvent","game/GameSpeed","game/gameobject/trait/AttackTrait","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class{constructor(){this.isActive=!1}isSubmerged(){return this.isActive}setCooldown(S){this.cooldownTicks=S}[D.NotifyTick.onTick](S,O){this.isActive||S.parasiteableTrait?.isInfested()||(S.attackTrait&&S.attackTrait.attackState!==j.AttackState.Idle&&!S.moveTrait.isMoving()?this.cooldownTicks=Math.max(this.cooldownTicks??0,5*N.GameSpeed.BASE_TICKS_PER_SECOND):this.cooldownTicks??(this.cooldownTicks=Math.floor(60*O.rules.general.cloakDelay*N.GameSpeed.BASE_TICKS_PER_SECOND)),0<this.cooldownTicks&&this.cooldownTicks--,this.cooldownTicks<=0&&(this.isActive=!0,O.events.dispatch(new B.ShipSubmergeChangeEvent(S))))}[L.NotifyDamage.onDamage](S,O){this.emerge(S,O)}emerge(S,O){this.isActive&&(this.isActive=!1,this.cooldownTicks=void 0,O.events.dispatch(new B.ShipSubmergeChangeEvent(S)))}},S("SubmergibleTrait",F)}}}),System.register("game/gameobject/trait/SuperWeaponTrait",["engine/type/ObjectType","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyUnspawn"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class{constructor(S){this.name=S}getSuperWeapon(S){return S.owner.superWeaponsTrait?.get(this.name)}[j.NotifySpawn.onSpawn](S,O){this.addSuperWeaponToPlayerIfNeeded(S.owner,O)}[L.NotifyUnspawn.onUnspawn](S,O){this.removeSuperWeaponFromPlayerIfNeeded(S.owner)}[N.NotifyOwnerChange.onChange](S,O,B){this.removeSuperWeaponFromPlayerIfNeeded(O),this.addSuperWeaponToPlayerIfNeeded(S.owner,B)}addSuperWeaponToPlayerIfNeeded(S,O){if(S.superWeaponsTrait&&!S.superWeaponsTrait.has(this.name)){let B=O.createSuperWeapon(this.name,S);S.superWeaponsTrait.add(B),B.rules.isPowered&&S.powerTrait?.isLowPower()&&B.pauseTimer()}}removeSuperWeaponFromPlayerIfNeeded(S){let O=S.superWeaponsTrait;var N;O&&(S.getOwnedObjectsByType(B.ObjectType.Building).some(S=>S.superWeaponTrait?.name===this.name)||(N=O.get(this.name))&&!N.isGift&&O.remove(this.name))}},S("SuperWeaponTrait",D)}}}),System.register("game/gameobject/trait/SuppressionTrait",["game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class{constructor(){this.suppressionTicks=0,this.enabled=!0}disable(){this.enabled=!1}isSuppressed(){return this.enabled&&0<this.suppressionTicks}suppress(){this.enabled&&(this.suppressionTicks=30)}[B.NotifyTick.onTick](){0<this.suppressionTicks&&this.suppressionTicks--}},S("SuppressionTrait",N)}}}),System.register("game/gameobject/trait/TemporalTrait",["game/gameobject/common/DeathType","game/gameobject/task/AttackTask","game/gameobject/task/move/MoveTask","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class{constructor(S){this.gameObject=S,this.ticksWhenWarpedOut=!0,this.attackers=new Set}[D.NotifyTick.onTick](S,O){if(S.attackTrait&&(S.attackTrait.currentTarget&&!S.warpedOutTrait.isActive()||this.releaseCurrentTarget(O)),void 0!==this.eraseTicks)for(var N of this.attackers){var j=N.temporalTrait.currentWeapon;if(!j)throw new Error(`Attacker "${N.name}" is no longer targeting "${S.name}"`);var L=j.rules.damage;if(this.eraseTicks-=L,this.eraseTicks<=0){S.deathType=B.DeathType.Temporal,O.destroyObject(S,{player:N.owner,obj:N,weapon:j},!0),this.eraseTicks=void 0;break}}}getTarget(){return this.currentTarget}updateTarget(S,O,B){if(this.currentTarget!==S){this.releaseCurrentTarget(B),this.currentTarget=S,this.currentWeapon=O;var L=S.temporalTrait.attackers.size;if(S.temporalTrait.attackers.add(this.gameObject),!L){S.warpedOutTrait.setActive(!0,!0,B);let O=S.unitOrderTrait.getCurrentTask();(O&&O instanceof N.AttackTask||O instanceof j.MoveTask)&&O.cancel(),S.temporalTrait.eraseTicks=10*S.healthTrait.maxHitPoints}}}releaseCurrentTarget(S){if(this.currentTarget){if(!this.currentTarget.isDisposed){let O=this.currentTarget.temporalTrait.attackers;O.delete(this.gameObject),O.size||(this.currentTarget.warpedOutTrait.expire(S),this.currentTarget.temporalTrait.eraseTicks=void 0)}this.currentTarget=void 0,this.currentWeapon=void 0}}[L.NotifyDestroy.onDestroy](S,O){this.releaseCurrentTarget(O)}dispose(){this.gameObject=void 0,this.attackers.clear()}},S("TemporalTrait",F)}}}),System.register("game/gameobject/trait/TiberiumTrait",["game/map/OreOverlayTypes","engine/type/OverlayTibType","engine/type/TiberiumType","game/type/LandType"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("TiberiumTrait",D=class e{static canBePlacedOn(S,O){return[L.LandType.Clear,L.LandType.Road,L.LandType.Rough].includes(S.landType)&&!O.getGroundObjectsOnTile(S).find(S=>!S.isSmudge()&&!S.isUnit())}constructor(S){this.gameObject=S}getTiberiumType(){var S=B.OreOverlayTypes.getOverlayTibType(this.gameObject.overlayId);switch(S){case N.OverlayTibType.Ore:return j.TiberiumType.Ore;case N.OverlayTibType.Gems:return j.TiberiumType.Gems;case N.OverlayTibType.Vinifera:return j.TiberiumType.Ore;default:throw new Error("Unsupported tiberium type "+S)}}collectBail(){var S=this.getBailCount();if(S<=0)throw new Error("Attempted to collect an ore bail, but there are none left");return this.gameObject.value--,1<S?this.getTiberiumType():void 0}spawnBails(S){this.gameObject.value=Math.min(e.maxBails,this.gameObject.value+S)}removeBails(S){this.gameObject.value=Math.max(-1,this.gameObject.value-S)}getBailCount(){return this.gameObject.value+1}dispose(){this.gameObject=void 0}}),D.maxBails=11}}}),System.register("game/gameobject/trait/TiberiumTreeTrait",["game/gameobject/trait/interface/NotifyTick","game/map/tileFinder/RadialTileFinder","game/type/LandType","engine/type/ObjectType","game/map/OreSpread","engine/type/OverlayTibType","game/gameobject/trait/TiberiumTrait"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){var O;(O=U||S("SpawnStatus",U={}))[O.Idle=0]="Idle",O[O.Spawning=1]="Spawning",H=class{constructor(S){this.rules=S,this.ticksSinceLastSpawn=0,this.cooldownTicks=Math.floor(1/this.rules.animationProbability),this.status=U.Idle}[B.NotifyTick.onTick](S,O){this.status=U.Idle,this.ticksSinceLastSpawn++>this.cooldownTicks&&(this.ticksSinceLastSpawn=0,this.status=U.Spawning,this.spawnTiberium(S.tile,O))}spawnTiberium(S,O){for(let V=1;V<=2;V++){let W=new N.RadialTileFinder(O.map.tiles,O.map.mapBounds,S,{width:1,height:1},V,V,S=>_.TiberiumTrait.canBePlacedOn(S,O.map));var B=W.getNextTile();if(B){var U=D.OreSpread.calculateOverlayId(F.OverlayTibType.Ore,B);if(void 0===U)throw new Error("Expected an overlayId");let S=O.createObject(L.ObjectType.Overlay,O.rules.getOverlayName(U));return S.overlayId=U,S.value=3,void O.spawnObject(S,B)}let z;for(W=new N.RadialTileFinder(O.map.tiles,O.map.mapBounds,S,{width:1,height:1},V,V,S=>S.landType===j.LandType.Tiberium);!z;){var H=W.getNextTile();if(!H)break;z=O.map.getObjectsOnTile(H).find(S=>S.isOverlay()&&S.isTiberium()&&S.traits.get(_.TiberiumTrait).getBailCount()+1<=_.TiberiumTrait.maxBails)}if(z)return void z.traits.get(_.TiberiumTrait).spawnBails(1)}}},S("TiberiumTreeTrait",H)}}}),System.register("game/gameobject/trait/TilterTrait",["game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTileChange"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class{constructor(){this.tilt={pitch:0,yaw:0}}[B.NotifySpawn.onSpawn](S){this.tilt=this.computeTilt(S.tile.rampType)}[N.NotifyTileChange.onTileChange](S){this.tilt=this.computeTilt(S.tile.rampType)}computeTilt(S){let O,B;return 0===S||17<=S?O=B=0:B=S<=4?(O=25,-90*S):(O=25,225-(S-1)%4*90),{pitch:O,yaw:B}}},S("TilterTrait",j)}}}),System.register("game/gameobject/trait/TntChargeTrait",["game/Coords","game/Warhead","game/gameobject/common/DeathType","game/gameobject/unit/CollisionType","game/gameobject/unit/Timer","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyTick","game/SpecialWarheadType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){H=class{constructor(){this.timer=new D.Timer}hasCharge(){return this.timer.isActive()}setCharge(S,O,B){this.hasCharge()||(this.timer.setActiveFor(S,O),this.attackerInfo=B)}getChargeOwner(){return this.attackerInfo?.player}removeCharge(){this.timer.reset()}getTicksLeft(){return this.timer.getTicksLeft()}getInitialTicks(){return this.timer.getInitialTicks()}[_.NotifyTick.onTick](S,O){this.timer.isActive()&&!0===this.timer.tick(O.currentTick)&&(S.isBuilding()&&S.cabHutTrait&&S.cabHutTrait.demolishBridge(O,this.attackerInfo),this.detonateIvanWarhead(O,S))}[F.NotifyDestroy.onDestroy](S,O,B){!this.timer.isActive()||B?.weapon?.warhead.rules.ivanBomb||[j.DeathType.None,j.DeathType.Temporal,j.DeathType.Sink].includes(S.deathType)||(this.timer.reset(),this.detonateIvanWarhead(O,S))}detonateIvanWarhead(S,O){var j=S.rules.combatDamage.ivanDamage;let D=new N.Warhead(S.rules.getWarhead(S.rules.combatDamage.ivanWarhead));var F=O.tile,_=O.tileElevation,H=O.isUnit()?O.zone:S.map.getTileZone(F),V=!!O.isUnit()&&O.onBridge;D.detonate(S,j,F,_,O.isBuilding()?B.Coords.tile3dToWorld(F.rx+.5,F.ry+.5,F.z+_):O.position.worldPosition,H,V?L.CollisionType.OnBridge:L.CollisionType.None,S.createTarget(O,F),{...this.attackerInfo,weapon:void 0},U.SpecialWarheadType.TntCharge)}},S("TntChargeTrait",H)}}}),System.register("game/gameobject/trait/TransportTrait",["util/math","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/task/ScatterTask","game/event/LeaveTransportEvent","game/gameobject/trait/interface/NotifyTick","game/gameobject/unit/ZoneType","game/gameobject/common/DeathType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){U=class{constructor(S){this.obj=S,this.units=[],this.loadQueue=[]}unitFitsInside(S){return S.rules.size<=this.obj.rules.sizeLimit&&S.rules.size<=this.getAvailableCapacity()}getOccupiedCapacity(){return this.units.reduce((S,O)=>S+O.rules.size,0)}getMaxCapacity(){return this.obj.rules.passengers}getAvailableCapacity(){return this.getMaxCapacity()-this.getOccupiedCapacity()}addToLoadQueue(S){return this.loadQueue.push(S),this.loadQueue.length-1}unitIsFirstInLoadQueue(S){return this.loadQueue[0]===S}removeFromLoadQueue(S){var O=this.loadQueue.indexOf(S);-1!==O&&this.loadQueue.splice(O,1)}[D.NotifyTick.onTick](S,O){this.loadQueue=this.loadQueue.filter(S=>!S.isDestroyed&&!S.isCrashing)}[N.NotifyDestroy.onDestroy](S,O,B,N){var j=!!S.armedTrait?.deathWeapon,L=B?.weapon?.warhead.rules.parasite;if(N||j||S.zone===F.ZoneType.Air||L)for(var D of this.units)j&&D.armedTrait&&(D.armedTrait.deathWeapon=void 0),D.position.tileElevation=S.position.tileElevation,D.zone=S.zone,D.onBridge=S.onBridge,D.position.tile=S.tile,D.deathType=S.deathType,O.destroyObject(D,B,!0);else this.spawnSurvivors(O);this.units=[]}spawnSurvivors(S){var O=this.obj;if(this.units.length){for(var B of this.units)0<S.map.terrain.getPassableSpeed(O.tile,B.rules.speedType,B.isInfantry(),O.onBridge)?(B.owner.addOwnedObject(B),B.position.tileElevation=O.onBridge?S.map.tileOccupation.getBridgeOnTile(O.tile).tileElevation:0,B.onBridge=O.onBridge,B.zone=S.map.getTileZone(O.tile,!O.onBridge),S.unlimboObject(B,O.tile),B.unitOrderTrait.addTask(new j.ScatterTask(S))):(B.position.tileElevation=O.position.tileElevation,B.zone=O.zone,B.onBridge=O.onBridge,B.position.tile=O.tile,B.zone===F.ZoneType.Water&&(B.deathType=_.DeathType.Sink),B.armedTrait?.deathWeapon&&(B.armedTrait.deathWeapon=void 0),S.destroyObject(B,{player:B.owner}));S.events.dispatch(new L.LeaveTransportEvent(O))}}getHash(){return B.fnv32a(this.units.map(S=>S.getHash()))}debugGetState(){return this.units.map(S=>S.debugGetState())}dispose(){this.obj=void 0}},S("TransportTrait",U)}}}),System.register("game/gameobject/trait/TurretTrait",["game/gameobject/unit/FacingUtil","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifySpawn"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class{constructor(){this.facing=0,this.desiredFacing=0}isRotating(){return this.facing!==this.desiredFacing}[j.NotifySpawn.onSpawn](S){S.isUnit()&&(this.facing=this.desiredFacing=S.direction)}[N.NotifyTick.onTick](S){var O;this.desiredFacing!==this.facing&&(O=S.rules.rot,this.facing=B.FacingUtil.tick(this.facing,this.desiredFacing,O||Number.POSITIVE_INFINITY).facing)}},S("TurretTrait",L)}}}),System.register("game/gameobject/trait/UnitOrderTrait",["game/gameobject/task/system/TaskRunner","game/gameobject/task/system/TaskStatus","game/gameobject/trait/interface/NotifyTick","game/gameobject/task/system/WaitTicksTask","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/task/system/CallbackTask","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyOrder"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){H=class{constructor(S){this.gameObject=S,this.orders=[],this.queuedOrders=new Set,this.tasks=[],this.taskRunner=new B.TaskRunner}[j.NotifyTick.onTick](S,O){if(S.isSpawned){var B=this.hasTasks(),N=this.tasks.find(S=>!S.isCancelling());if(B&&this.taskRunner.tick(this.tasks,S),S.isSpawned){var j,D=this.orders.length;if(D&&(!B||!N)){let O,N=!1;for(;O=this.orders[0];){if(O.isValid()&&O.isAllowed()&&((j=O.process())&&(this.queuedOrders.has(O)&&(this.tasks.push(new L.WaitTicksTask(5)),this.tasks.push(new F.CallbackTask(()=>{S.resetGuardModeToIdle()}))),this.tasks.push(...j),B||this.taskRunner.tick(this.tasks,S)),N=!0),this.orders.shift(),this.queuedOrders.delete(O),!S.isSpawned)return;if(this.waypointPath&&(this.currentWaypoint?(this.cleanupWaypoint(this.currentWaypoint,this.waypointPath),this.currentWaypoint=this.currentWaypoint?.next):this.currentWaypoint=this.waypointPath.waypoints[0],this.currentWaypoint||this.cleanupWaypointPath()),N)break}}!D&&!B&&this.waypointPath&&this.currentWaypoint&&(this.cleanupWaypoint(this.currentWaypoint,this.waypointPath),this.cleanupWaypointPath());let O=N;for(;O?.useChildTargetLines;){var _=O.children.find(S=>!S.isCancelling());if(!_)break;O=_}this.targetLinesTask!==O&&(this.targetLinesTask=O,this.targetLinesConfig=O?.getTargetLinesConfig(this.gameObject))}}}[D.NotifyOwnerChange.onChange](){this.clearOrders(),this.cancelAllTasks()}[_.NotifyTeleport.onBeforeTeleport](S,O,B,N){B&&!N&&(this.clearOrders(),this.tasks.length=0)}addOrder(S,O=!1){!1!==S.onAdd(this.tasks,O)?(O||(this.clearOrders(),this.tasks=this.tasks.filter(S=>S.status!==N.TaskStatus.NotStarted),this.tasks.forEach(S=>S.cancel())),this.orders.push(S),O&&this.queuedOrders.add(S),this.gameObject.traits.filter(U.NotifyOrder).forEach(O=>{O[U.NotifyOrder.onPush](this.gameObject,S.orderType)})):this.targetLinesTask=void 0}clearOrders(){this.orders.length=0,this.queuedOrders.clear(),this.currentWaypoint&&this.waypointPath&&this.cleanupWaypoint(this.currentWaypoint,this.waypointPath),this.cleanupWaypointPath(),this.gameObject.resetGuardModeToIdle()}unmarkNextQueuedOrder(){this.orders.length&&this.queuedOrders.delete(this.orders[0])}hasTasks(){return!!this.tasks.length}isIdle(){return!this.orders.length&&!this.tasks.length}getCurrentTask(){return this.tasks[0]}cancelAllTasks(){this.tasks.forEach(S=>S.cancel())}addTask(S){this.tasks.push(S)}addTasks(...S){S.forEach(S=>this.addTask(S))}addTaskToFront(S){this.tasks.unshift(S)}addTaskNext(S){this.tasks.splice(1,0,S)}getTasks(){return[...this.tasks]}dispose(){this.clearOrders(),this.tasks.length=0,this.gameObject=void 0}cleanupWaypointPath(){this.waypointPath&&(this.waypointPath.units.splice(this.waypointPath.units.indexOf(this.gameObject),1),this.waypointPath.units.length||(this.waypointPath.waypoints.forEach(S=>S.next=void 0),this.waypointPath.waypoints.length=0),this.waypointPath=void 0),this.currentWaypoint=void 0}cleanupWaypoint(S,O){if(!O.units.find(O=>O!==this.gameObject&&(O.unitOrderTrait.currentWaypoint??O.unitOrderTrait.waypointPath?.waypoints[0])===S)&&!O.waypoints.find(O=>O.next===S)){var B=O.waypoints.indexOf(S);if(-1===B)throw new Error("Given waypoint not found in waypoint path");O.waypoints.splice(B,1)}}},S("UnitOrderTrait",H)}}}),System.register("game/gameobject/trait/UnitReloadTrait",["game/GameSpeed","game/gameobject/unit/ZoneType","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class{[j.NotifyTick.onTick](S,O){if(S.dockTrait&&S.dockTrait.hasDockedUnits()&&!S.dockTrait.getDockedUnits().every(S=>!this.canReloadUnit(S)))if(void 0===this.cooldownTicks&&(this.cooldownTicks=B.GameSpeed.BASE_TICKS_PER_SECOND*O.rules.general.repair.reloadRate*60),this.cooldownTicks<=0){this.cooldownTicks=B.GameSpeed.BASE_TICKS_PER_SECOND*O.rules.general.repair.reloadRate*60;let j=S.dockTrait.getDockedUnits();var N;for(N of 0===j[0].ammo?j.slice(0,1):j)this.canReloadUnit(N)&&N.ammoTrait.ammo++}else this.cooldownTicks--}canReloadUnit(S){return!(!S.ammoTrait||!S.rules.manualReload||S.ammoTrait.isFull()||S.zone===N.ZoneType.Air)}},S("UnitReloadTrait",L)}}}),System.register("game/gameobject/trait/UnitRepairTrait",["game/event/UnitRepairFinishEvent","game/event/UnitRepairStartEvent","game/GameSpeed","game/math/Vector2","game/gameobject/task/move/MoveTask","game/gameobject/unit/ZoneType","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){var O;(O=H||S("RepairStatus",H={}))[O.Idle=0]="Idle",O[O.Repairing=1]="Repairing",V=class{constructor(){this.status=H.Idle,this.cooldownTicks=0,this.lastRepairTickSuccessful=!1}[_.NotifySpawn.onSpawn](S,O){this.resetRallyPoint(S,O)}resetRallyPoint(S,O){var B;S.factoryTrait||(B=this.computeDefaultRallyPoint(S,O.map),S.rallyTrait.changeRallyPoint(B,S,O))}[U.NotifyTick.onTick](S,O){if(S.dockTrait&&(!S.rules.needsEngineer||!S.owner.isNeutral))if(!S.dockTrait.hasDockedUnits()||S.dockTrait.getDockedUnits().some(S=>S.zone===F.ZoneType.Air)||S.poweredTrait&&!S.poweredTrait.isPoweredOn())this.status=H.Idle;else if(this.cooldownTicks<=0){var L,_,U=O.rules.general.repair;U=S.rules.unitReload?U.reloadRate:U.uRepairRate,this.cooldownTicks+=j.GameSpeed.BASE_TICKS_PER_SECOND*U*60;let V=!1;for(L of S.dockTrait.getDockedUnits())L.zone!==F.ZoneType.Air&&(L.healthTrait.health<100&&O.areFriendly(L,S)?(this.tickRepair(L,O,S)&&(V=!0),!V||this.status!==H.Idle&&this.lastRepairTickSuccessful||S.helipadTrait||O.events.dispatch(new N.UnitRepairStartEvent(L))):((_=S.rallyTrait.findRallyNodeForUnit(L,O.map))&&(S.dockTrait.undockUnit(L),L.unitOrderTrait.addTask(new D.MoveTask(O,_.tile,!!_.onBridge,{closeEnoughTiles:O.rules.general.closeEnough}))),S.helipadTrait||O.events.dispatch(new B.UnitRepairFinishEvent(L,S))));this.lastRepairTickSuccessful=V,this.status=V?H.Repairing:H.Idle}else this.cooldownTicks--}tickRepair(S,O,B){var N=O.rules.general.repair,j=Math.floor(N.repairStep),L=N.repairPercent;let D;if(L){if(N=L*S.purchaseValue/S.healthTrait.maxHitPoints,L=Math.min(B.owner.credits,Math.max(1,Math.floor(N*j))),D=N&&L?Math.floor(L/N):j,!L)return!1;B.owner.credits-=L}else D=j;return D=Math.min(D,S.healthTrait.maxHitPoints-S.healthTrait.getHitPoints()),!!D&&(S.healthTrait.healBy(D,B,O),!0)}computeDefaultRallyPoint(S,O){var B=S.getFoundation();return B=new L.Vector2(S.tile.rx,S.tile.ry+B.height),O.tiles.getByMapCoords(B.x,B.y)??S.tile}},S("UnitRepairTrait",V)}}}),System.register("game/gameobject/trait/UnlandableTrait",["game/math/Vector2","util/bresenham","util/typeGuard","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){U=class{constructor(){this.enabled=!0}setEnabled(S){this.enabled=S}[_.NotifyTick.onTick](S,O){var B;this.enabled&&(S.owner.isNeutral||S.name===O.rules.general.paradrop.paradropPlane)&&S.unitOrderTrait.isIdle()&&(B=this.chooseExitTile(S.tile,O),S.unitOrderTrait.addTask(new F.TaskGroup(new L.MoveTask(O,B,!1,{allowOutOfBoundsTarget:!0}),new D.CallbackTask(S=>O.unspawnObject(S))).setCancellable(!1)))}chooseExitTile(S,O){var L=O.map.tiles.getMapSize(),D=.5<O.generateRandom()?new B.Vector2(Math.floor(L.width/2),0):new B.Vector2(0,Math.floor(L.height/2));if(L=new B.Vector2(S.rx,S.ry),D=N.bresenham(L.x,L.y,D.x,D.y).map(S=>O.map.tiles.getByMapCoords(S.x,S.y)).filter(j.isNotNullOrUndefined),!D.length)throw new Error("No valid exit tile found");return D[D.length-1]}},S("UnlandableTrait",U)}}}),System.register("game/gameobject/trait/VeteranTrait",["game/gameobject/unit/VeteranLevel","game/trait/interface/NotifyTargetDestroy","game/event/UnitPromoteEvent","game/gameobject/unit/VeteranAbility","game/gameobject/trait/SelfHealingTrait","game/gameobject/trait/CloakableTrait","game/gameobject/trait/ArmedTrait","game/gameobject/trait/SensorsTrait"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){H=class{constructor(S,O){this.gameObject=S,this.veteranRules=O,this.veteranLevel=B.VeteranLevel.None,this.xp=0,this.promotionThresh=S.rules.cost*O.veteranRatio+1}[N.NotifyTargetDestroy.onDestroy](S,O,B,N){S.isDestroyed&&!S.isCrashing||O.isTechno()&&(O.rules.dontScore||O.rules.insignificant||(B&&(B.warhead.rules.temporal||B.warhead.rules.parasite&&S.rules.organic)||!N.areFriendly(S,O))&&(this.veteranLevel>=this.veteranRules.veteranCap||this.gainXP(O.rules.cost*(O.veteranLevel+1))&&this.handlePromotion(S,N)))}setRelativeXP(S){this.gainXP(Math.floor(S*this.promotionThresh))}gainXP(S){if(this.xp+=S,this.xp>=this.promotionThresh){var O=Math.min(this.veteranLevel+Math.floor(this.xp/this.promotionThresh),this.veteranRules.veteranCap),B=O-this.veteranLevel;if(B)return this.xp-=B*this.promotionThresh,this.setVeteranLevel(O),!0}return!1}promote(S,O){var B=Math.min(this.veteranLevel+S,this.veteranRules.veteranCap);B-this.veteranLevel&&(this.setVeteranLevel(B),this.handlePromotion(this.gameObject,O))}isMaxLevel(){return this.veteranLevel===this.veteranRules.veteranCap}isElite(){return this.veteranLevel===B.VeteranLevel.Elite}setVeteranLevel(S){this.veteranLevel=S,this.veteranLevel===B.VeteranLevel.Elite&&this.gameObject.armedTrait?.toggleEliteWeapons(!0)}handlePromotion(S,O){this.hasVeteranAbility(L.VeteranAbility.SELF_HEAL)&&(S.traits.find(D.SelfHealingTrait)||O.addObjectTrait(S,new D.SelfHealingTrait)),this.hasVeteranAbility(L.VeteranAbility.CLOAK)&&(S.cloakableTrait||(S.cloakableTrait=new F.CloakableTrait(S,O.rules.general.cloakDelay),O.addObjectTrait(S,S.cloakableTrait))),this.hasVeteranAbility(L.VeteranAbility.EXPLODES)&&(S.explodes||(S.explodes=!0,S.armedTrait||(S.armedTrait=new _.ArmedTrait(S,O.rules),O.addObjectTrait(S,S.armedTrait)))),this.hasVeteranAbility(L.VeteranAbility.RADAR_INVISIBLE)&&(S.radarInvisible||(S.radarInvisible=!0)),this.hasVeteranAbility(L.VeteranAbility.SENSORS)&&(S.sensorsTrait||(S.sensorsTrait=new U.SensorsTrait,O.addObjectTrait(S,S.sensorsTrait))),S.isInfantry()&&this.hasVeteranAbility(L.VeteranAbility.FEARLESS)&&S.suppressionTrait?.disable(),this.hasVeteranAbility(L.VeteranAbility.C4)&&(S.c4||(S.c4=!0)),this.hasVeteranAbility(L.VeteranAbility.GUARD_AREA)&&(S.defaultToGuardArea||(S.defaultToGuardArea=!0,S.unitOrderTrait.isIdle()&&S.resetGuardModeToIdle())),this.hasVeteranAbility(L.VeteranAbility.CRUSHER)&&(S.crusher||(S.crusher=!0)),O.events.dispatch(new j.UnitPromoteEvent(S))}getVeteranSightMultiplier(){return this.getVeteranAbilityMultiplier(L.VeteranAbility.SIGHT)}getVeteranSpeedMultiplier(){return this.getVeteranAbilityMultiplier(L.VeteranAbility.FASTER)}getVeteranArmorMultiplier(){return this.getVeteranAbilityMultiplier(L.VeteranAbility.STRONGER)}getVeteranDamageMultiplier(){return this.getVeteranAbilityMultiplier(L.VeteranAbility.FIREPOWER)}getVeteranRofMultiplier(){return this.getVeteranAbilityMultiplier(L.VeteranAbility.ROF)}hasVeteranAbility(S){return this.veteranLevel===B.VeteranLevel.Veteran&&this.gameObject.rules.veteranAbilities.has(S)||this.veteranLevel>=B.VeteranLevel.Elite&&this.gameObject.rules.eliteAbilities.has(S)}getVeteranAbilityMultiplier(S){let O=1;return(this.veteranLevel===B.VeteranLevel.Veteran&&this.gameObject.rules.veteranAbilities.has(S)||this.veteranLevel>=B.VeteranLevel.Elite&&this.gameObject.rules.eliteAbilities.has(S))&&(O=this.getVeteranRulesMultiplier(S)),O}getVeteranRulesMultiplier(S){switch(S){case L.VeteranAbility.FASTER:return this.veteranRules.veteranSpeed;case L.VeteranAbility.STRONGER:return this.veteranRules.veteranArmor;case L.VeteranAbility.FIREPOWER:return this.veteranRules.veteranCombat;case L.VeteranAbility.ROF:return this.veteranRules.veteranROF;case L.VeteranAbility.SIGHT:return this.veteranRules.veteranSight;default:throw new Error("Unhandled VeteranAbility "+S)}}dispose(){this.gameObject=void 0}},S("VeteranTrait",H)}}}),System.register("game/gameobject/trait/WallTrait",["game/gameobject/trait/interface/NotifyDamage","game/type/LandType","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyUnspawn","game/map/tileFinder/CardinalTileFinder","game/map/wallTypes"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class{constructor(){this.linkedDamageHandled=!1,this.wallType=0}[j.NotifySpawn.onSpawn](S,O){S.isBuilding()?this.connectWall(S,O.map):this.wallType=S.value}[L.NotifyUnspawn.onUnspawn](S,O){this.updateAdjacentWalls(S,O.map)}[B.NotifyDamage.onDamage](S,O,B,j){if(!this.linkedDamageHandled){var L=Math.floor(B/2);if(L)for(var D of O.map.tiles.getAllNeighbourTiles(S.tile))if(D.landType===N.LandType.Wall){let S=O.map.getObjectsOnTile(D).find(S=>(S.isBuilding()||S.isOverlay())&&S.wallTrait);S.wallTrait.linkedDamageHandled=!0,S.healthTrait.inflictDamage(L,j,O),S.wallTrait.linkedDamageHandled=!1,S.healthTrait.health||O.destroyObject(S,j)}}}updateAdjacentWalls(S,O){let B=new D.CardinalTileFinder(O.tiles,O.mapBounds,S.tile,1,1);for(B.diagonal=!1;N=B.getNextTile();){var N=O.getObjectsOnTile(N).find(O=>(O.isBuilding()||O.isOverlay())&&O.name===S.rules.name);N&&this.connectWall(N,O)}}connectWall(S,O){let B=this.getAdjacentWallData(S.tile,S.name,O);this.updateWallType(S,B.map(S=>S.direction)),B.forEach(S=>{let B=this.getAdjacentWallData(S.tile,S.wall.name,O);this.updateWallType(S.wall,B.map(S=>S.direction))})}updateWallType(S,O){let B=[0,0,0,0];for(var N of O)0===N[0]&&-1===N[1]&&(B[0]=1),1===N[0]&&0===N[1]&&(B[1]=1),0===N[0]&&1===N[1]&&(B[2]=1),-1===N[0]&&0===N[1]&&(B[3]=1);var j=this.findWallType(B);S.wallTrait.wallType=j,S.isOverlay()&&(S.value=j)}findWallType(S){for(let B=0;B<F.wallTypes.length;++B){var O=F.wallTypes[B];if(O[0]===S[0]&&O[1]===S[1]&&O[2]===S[2]&&O[3]===S[3])return B}return console.warn("Invalid wall directions",S),0}getAdjacentWallData(S,O,B){var N;let j=[];for(N of[[0,1],[0,-1],[1,0],[-1,0]]){var L={x:S.rx+N[0],y:S.ry+N[1]},D=B.tiles.getByMapCoords(L.x,L.y);D&&(L=B.getObjectsOnTile(D).find(S=>(S.isBuilding()||S.isOverlay())&&S.name===O))&&j.push({direction:N,tile:D,wall:L})}return j}},S("WallTrait",_)}}}),System.register("game/gameobject/trait/WarpedOutTrait",["game/gameobject/trait/interface/NotifyWarpChange","game/trait/interface/NotifyWarpChange","game/gameobject/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class{constructor(S){this.gameObject=S,this.ticksWhenWarpedOut=!0,this.remainingTicks=0,this.invulnerable=!1}isActive(){return 0<this.remainingTicks}setActive(S,O,B){this.remainingTicks=S?Number.POSITIVE_INFINITY:0,this.invulnerable=O,this.notifyChange(S,B)}setTimed(S,O,B){this.remainingTicks=S,this.invulnerable=O,this.notifyChange(!0,B)}debugSetActive(S){this.remainingTicks=S?Number.POSITIVE_INFINITY:0}notifyChange(S,O){O.traits.filter(N.NotifyWarpChange).forEach(B=>{B[N.NotifyWarpChange.onChange](this.gameObject,O,S)}),this.gameObject.traits.filter(B.NotifyWarpChange).forEach(N=>{N[B.NotifyWarpChange.onChange](this.gameObject,O,S)})}expire(S){this.remainingTicks=0,this.notifyChange(!1,S)}isInvulnerable(){return this.isActive()&&this.invulnerable}[j.NotifyTick.onTick](S,O){0<this.remainingTicks&&(this.remainingTicks--,this.remainingTicks<=0&&this.notifyChange(!1,O))}dispose(){this.gameObject=void 0}},S("WarpedOutTrait",L)}}}),System.register("game/gameobject/trait/interface/NotifyAttack",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyAttack",B={})).onAttack=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyBuildStatus",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyBuildStatus",B={})).onStatusChange=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyCrash",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyCrash",B={})).onCrash=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyDamage",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyDamage",B={})).onDamage=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyDestroy",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyDestroy",B={})).onDestroy=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyHeal",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyHeal",B={})).onHeal=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyHealthChange",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyHealthChange",B={})).onChange=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyOrder",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyOrder",B={})).onPush=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyOwnerChange",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyOwnerChange",B={})).onChange=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifySell",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifySell",B={})).onSell=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifySpawn",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifySpawn",B={})).onSpawn=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyTeleport",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyTeleport",B={})).onBeforeTeleport=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyTick",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyTick",B={})).onTick=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyTileChange",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyTileChange",B={})).onTileChange=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyUnspawn",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyUnspawn",B={})).onUnspawn=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyWarpChange",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyWarpChange",B={})).onChange=Symbol()}}}),System.register("game/gameobject/unit/CollisionHelper",["engine/type/TerrainType","game/type/LandType","game/gameobject/unit/CollisionType","game/gameobject/unit/ZoneType"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("CollisionHelper",class{constructor(S){this.tileOccupation=S}checkCollisions(S,O,B){var D,F=S.tile;let _,U,H;for(D of this.tileOccupation.getObjectsOnTile(F))D.isOverlay()&&D.isBridge()&&(_=D),D.isOverlay()&&D.wallTrait&&(H=D),D.isTechno()&&!D.isDestroyed&&(U=D);if(B.walls){if(S.tileElevation<=2&&F.landType===N.LandType.Wall)return{type:j.CollisionType.Wall,target:H};if(B.units&&U?.tile===F&&(!U.isUnit()||U.zone===L.ZoneType.Ground)&&S.tileElevation<=1.1&&B.units(U.owner))return{type:j.CollisionType.Wall,target:U}}if(B.shore&&F.landType!==N.LandType.Water)return{type:j.CollisionType.Shore};if(B.ground&&S.tileElevation<0)return{type:j.CollisionType.Ground};var V=S.tileElevation+F.z,W=O.tileElevation+O.tile.z;if(_?.isHighBridge()){var z=_.tile.z+_.tileElevation;if(z<W&&V<=z||W<z&&z-1<=V)return W<z?{type:j.CollisionType.UnderBridge,target:_}:{type:j.CollisionType.OnBridge,target:_}}else if(_?.isLowBridge()&&B.shore)return{type:j.CollisionType.UnderBridge,target:_};return B.cliffs&&(F=F.z-O.tile.z,S.tileElevation<0&&4<=F)?{type:j.CollisionType.Cliff}:{type:j.CollisionType.None}}computeDetonationZone(S,O,N){let D=this.tileOccupation.getBridgeOnTile(S);return N===j.CollisionType.None&&O>1.5+(D?.tileElevation??0)?L.ZoneType.Air:D&&1.5<O||S.terrainType!==B.TerrainType.Water||D?.isLowBridge()?L.ZoneType.Ground:L.ZoneType.Water}})}}}),System.register("game/gameobject/unit/CollisionType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("CollisionType",B={}))[O.None=0]="None",O[O.Ground=1]="Ground",O[O.Wall=2]="Wall",O[O.Cliff=3]="Cliff",O[O.OnBridge=4]="OnBridge",O[O.UnderBridge=5]="UnderBridge",O[O.Shore=6]="Shore"}}}),System.register("game/gameobject/unit/CrateBonuses",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("CrateBonuses",class{constructor(){this.firepower=1,this.armor=1,this.speed=1}})}}}),System.register("game/gameobject/unit/FacingUtil",["game/math/Vector2","game/math/geometry"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("FacingUtil",class e{static tick(S,O,B){if(S===O)return{facing:S,delta:0};var N=(S-O+360)%360,j=(O-S+360)%360;return Math.min(N,j)<B?{facing:O,delta:0}:{facing:(S+(N=(j<=N?1:-1)*B)+360)%360,delta:N}}static fromMapCoords(S){return(-N.angleDegFromVec2(S)-90+720)%360}static toMapCoords(S){return N.rotateVec2(new B.Vector2(1e3,0),e.toWorldDeg(S)).round().normalize()}static toWorldDeg(S){return-(S+90)}})}}}),System.register("game/gameobject/unit/HealthLevel",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("HealthLevel",B={}))[O.Green=0]="Green",O[O.Yellow=1]="Yellow",O[O.Red=2]="Red"}}}),System.register("game/gameobject/unit/LosHelper",["util/bresenham","game/type/LandType"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=S=>void 0!==S.position,S("LosHelper",class{constructor(S,O){this.tiles=S,this.tileOccupation=O}hasLineOfSight(S,O,L){var D=L.warhead.rules.wall||!L.projectileRules.subjectToWalls,F=L.projectileRules.subjectToCliffs,_=L.rules.spawner;let U=0,H=!1;if(!D||F||_){var V,W,z=j(S)?S.tile:S,K=j(O)?O.isBuilding()?O.centerTile:O.tile:O;let L=z.z;for({x:V,y:W}of(F&&j(S)&&S.isUnit()&&S.onBridge&&(L+=this.tileOccupation.getBridgeOnTile(z)?.tileElevation??0),B.bresenham(z.rx,z.ry,K.rx,K.ry))){var $=this.tiles.getByMapCoords(V,W);if(!$)return!1;if(!D&&$.landType===N.LandType.Wall)return!1;if(F)if($.landType===N.LandType.Cliff){if($.z>L)return!1;H=!0}else{if($.z>L&&H)return!1;H=!1}if(_&&U<2&&this.tileOccupation.getBridgeOnTile($)?.isHighBridge())return!1;U++}}return!0}})}}}),System.register("game/gameobject/unit/MovePositionHelper",["game/map/tileFinder/RadialTileFinder","game/type/MovementZone","game/type/SpeedType"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("MovePositionHelper",class{constructor(S){this.map=S}findPositions(S,O,L,D){let F=new Map,_=this.clusterObjects(S);if(!_.length)throw new Error("We should have found at least one cluster");let U=_.reduce((S,O)=>O.objects.size>S.objects.size?O:S,_[0]);_.splice(_.indexOf(U),1);let H=[],V=this.findCenterTile([...U.objects]);U.objects.forEach(S=>{var B=this.map.tiles.getByMapCoords(O.rx+S.tile.rx-V.rx,O.ry+S.tile.ry-V.ry),_=B?.onBridgeLandType?this.map.tileOccupation.getBridgeOnTile(B):void 0;if(!B||!this.map.mapBounds.isWithinBounds(B)||F.has(B)&&!this.tileHasRoom(S,F.get(B))||S.rules.movementZone===N.MovementZone.Fly&&!(S.rules.airportBound||D&&S.rules.balloonHover&&!S.rules.hoverAttack)&&!this.map.terrain.getPassableSpeed(B,j.SpeedType.Amphibious,!1,!!_)||S.rules.movementZone!==N.MovementZone.Fly&&!this.isEligibleTile(B,_,L,O))H.push(S);else{let O=F.get(B);void 0===O&&(O=[],F.set(B,O)),O.push(S)}}),_.forEach(S=>H.push(...S.objects));let W,z=new B.RadialTileFinder(this.map.tiles,this.map.mapBounds,O,{width:1,height:1},1,5,()=>!0);for(;H.length&&(W=z.getNextTile());){var K=H[0],$=this.map.tileOccupation.getBridgeOnTile(W);if((!F.has(W)||this.tileHasRoom(K,F.get(W)))&&(K.rules.movementZone!==N.MovementZone.Fly||K.rules.airportBound||this.map.terrain.getPassableSpeed(W,j.SpeedType.Amphibious,!1,!!$))&&(K.rules.movementZone===N.MovementZone.Fly||this.isEligibleTile(W,$,L,O))){let S=F.get(W);void 0===S&&(S=[],F.set(W,S)),S.push(H.shift())}}let q=new Map;if(F.forEach((S,O)=>{S.forEach(S=>q.set(S,O))}),H.forEach(S=>q.set(S,O)),q.size!==S.length)throw new Error("We should have computed a number of positions equal to the number of input objects");return q}tileHasRoom(S,O){if(S.isInfantry()){if(O.find(S=>!S.isInfantry()))return!1;var B=S.rules.movementZone===N.MovementZone.Fly?1:3;return!(O.filter(S=>S.isInfantry()).length>=B)}return!O.length}isEligibleTile(S,O,B,N){return B?.isHighBridge()||O?.isHighBridge()?S.z+(O?.tileElevation??0)===N.z+(B?.tileElevation??0):!(!B&&!O)||Math.abs(S.z-N.z)<2}clusterObjects(S){let O=new Map;S.forEach(S=>{var B=S.tile.rx+"_"+S.tile.ry;O.set(B,[...O.get(B)||[],S])});let B=[],N=new Set(S);for(;N.size;){let S=new Set,D=[];var j=[...N][0].tile;for(O.get(j.rx+"_"+j.ry).forEach(S=>{D.push(S)});D.length;){var L=D.shift();S.add(L),N.delete(L);for(let S=-1;S<=1;S++)for(let B=-1;B<=1;B++)if(S||B){let j=O.get(L.tile.rx+S+"_"+(L.tile.ry+B));j&&j.length&&j.forEach(S=>{N.has(S)&&(N.delete(S),D.push(S))})}}B.push({objects:S})}return B}findCenterTile(S){let O=0,B=0;S.forEach(S=>{O+=S.tile.rx,B+=S.tile.ry}),O=Math.round(O/S.length),B=Math.round(B/S.length);let N=this.map.tiles.getByMapCoords(O,B);if(!N&&(N=S.find(S=>Math.abs(S.tile.rx-O)<=1&&Math.abs(S.tile.ry-B)<=1)?.tile,!N))throw new Error("At least one adjacent object should have been found");return N}})}}}),System.register("game/gameobject/unit/RangeHelper",["game/Coords","util/math","game/gameobject/unit/ZoneType","game/type/MovementZone","game/math/Vector2"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=S=>void 0!==S.position,_=S=>void 0!==S.addScalar,S("RangeHelper",class{constructor(S){this.tileOccupation=S}isInWeaponRange(S,O,B,N,j){var D=j??S;if(B.rules.limboLaunch&&2<Math.abs((F(D)?D.position.tileElevation+D.tile.z:D.z)-(F(O)?O.position.tileElevation+O.tile.z:O.z)))return!1;var{minRange:_,range:U}=this.computeWeaponRangeVsTarget(D,O,B,N);return B.rules.cellRangefinding?this.isInTileRange(D,O,_,U):S.isUnit()&&S.rules.movementZone===L.MovementZone.Fly?this.isInRange2(D,O,_,U):this.isInRange3(D,O,_,U)}computeWeaponRangeVsTarget(S,O,B,N){let L=0;var D,_;return!F(O)||!O.isBuilding()||B.projectileRules.arcing||B.projectileRules.vertical||B.warhead.rules.ivanBomb||1<(_=O.getFoundation()).width&&1<_.height&&(L+=Math.ceil(Math.min(_.width,_.height)/2)),!B.projectileRules.subjectToElevation||B.projectileRules.arcing&&!F(O)||(D=F(S)?S.tile.z+S.tileElevation:S.z,(_=F(O)?O.tile.z+O.tileElevation:O.z)<D&&(L+=N.elevationModel.getBonus(D,_))),B.projectileRules.isAntiAir&&F(S)&&S.isTechno()&&F(O)&&O.isUnit()&&O.zone===j.ZoneType.Air&&(L+=S.rules.airRangeBonus),{minRange:B.minRange,range:B.range+L}}isInRange(S,O,B,N,j=!1){return j?this.isInTileRange(S,O,B,N):S.isUnit()&&S.rules.movementZone===L.MovementZone.Fly?this.isInRange2(S,O,B,N):this.isInRange3(S,O,B,N)}isInRange3(S,O,j,L){return N.isBetween(this.distance3(S,O)/B.Coords.LEPTONS_PER_TILE,j,L)}isInRange2(S,O,j,L){return N.isBetween(this.distance2(S,O)/B.Coords.LEPTONS_PER_TILE,j,L)}distance3(S,O){let N=F(S)?S.position.worldPosition:_(S)?S:B.Coords.tile3dToWorld(S.rx+.5,S.ry+.5,S.z);var j=F(O)?O.position.worldPosition:_(O)?O:B.Coords.tile3dToWorld(O.rx+.5,O.ry+.5,O.z);return N.distanceTo(j)}distance2(S,O){let N=F(S)?new D.Vector2(S.position.worldPosition.x,S.position.worldPosition.z):_(S)?new D.Vector2(S.x,S.z):new D.Vector2(S.rx+.5,S.ry+.5).multiplyScalar(B.Coords.LEPTONS_PER_TILE);var j=F(O)?new D.Vector2(O.position.worldPosition.x,O.position.worldPosition.z):_(O)?new D.Vector2(O.x,O.z):new D.Vector2(O.rx+.5,O.ry+.5).multiplyScalar(B.Coords.LEPTONS_PER_TILE);return N.distanceTo(j)}isInTileRange(S,O,B,j){return N.isBetween(this.tileDistance(S,O),B,j)}tileDistance(S,O){var B,N=F(S)?this.tileOccupation.calculateTilesForGameObject(S.tile,S):Array.isArray(S)?S:[S],j=F(O)?this.tileOccupation.calculateTilesForGameObject(O.tile,O):Array.isArray(O)?O:[O];let L=new D.Vector2,_=new D.Vector2,U=Number.POSITIVE_INFINITY;for(B of N)for(var H of j)L.set(B.rx,B.ry),_.set(H.rx,H.ry),(H=L.distanceTo(_))<=U&&(U=H);return U}})}}}),System.register("game/gameobject/unit/ScatterPositionHelper",["game/gameobject/unit/MovePositionHelper","game/map/tileFinder/RandomTileFinder"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("ScatterPositionHelper",class{constructor(S){this.game=S,this.movePositionHelper=new B.MovePositionHelper(S.map)}findPositions(S,O){let B=new Set,N=new Map;for(var j of S){var L=this.findFreeMovePosition(j,B,O);L&&(N.set(j,L),B.add(L.tile))}return N}findFreeMovePosition(S,O,{ignoredBlockers:B,excludedTiles:j,noSlopes:L}={}){let D,F,_=this.game.map,U=S.onBridge?_.tileOccupation.getBridgeOnTile(S.tile):void 0,H=new N.RandomTileFinder(_.tiles,_.mapBounds,S.tile,1,this.game,O=>{if(j?.includes(O))return!1;var B=_.tileOccupation.getBridgeOnTile(O);return(B&&this.movePositionHelper.isEligibleTile(O,B,U,S.tile)||this.movePositionHelper.isEligibleTile(O,void 0,U,S.tile))&&(!L||0===O.rampType)});for(;;){var V=H.getNextTile();if(!V)break;if(D=V,F=_.tileOccupation.getBridgeOnTile(V),F&&!this.movePositionHelper.isEligibleTile(V,F,U,S.tile)&&(F=void 0),!O.has(V)){let O=_.terrain.findObstacles({tile:V,onBridge:F},S);if(B&&B.length&&(O=O.filter(S=>!B.includes(S.obj))),!O.length)break}}if(D)return{tile:D,onBridge:F}}})}}}),System.register("game/gameobject/unit/TargetUtil",["game/math/Vector3","game/math/geometry","game/math/GameMath"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("TargetUtil",class{static computeInterceptPoint(S,O,N,L){let D=S.clone().sub(N);var F,_=O*O-(F=L.length())*F,U=2*D.dot(L);return U*U-4*_*(F=-D.dot(D))<0?new B.Vector3:(_=(-U+j.GameMath.sqrt(U*U-4*_*F))/(2*_),L.clone().multiplyScalar(_).add(N))}static computeTurnCircle(S,O,B,j){var L=j/N.degToRad(Math.abs(B));let D=N.rotateVec2(O.clone(),90*-Math.sign(B));return{center:isFinite(L)?D.setLength(L).add(S):S.clone(),radius:L}}})}}}),System.register("game/gameobject/unit/Timer",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("Timer",class{constructor(){this.activeTicks=0}isActive(){return 0<this.activeTicks}setActiveFor(S,O){this.activeTicks=S,this.activeFor=S,this.activeSince=O}reset(){this.activeTicks=0,this.activeSince=void 0,this.activeFor=void 0}getTicksLeft(){return this.activeTicks}getInitialTicks(){return this.activeFor??0}tick(S){return 0<this.activeTicks&&(this.activeTicks--,this.activeTicks<=0||void 0!==this.activeSince&&S-this.activeSince>this.activeFor)&&(this.reset(),!0)}})}}}),System.register("game/gameobject/unit/VeteranAbility",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("VeteranAbility",B={}))[O.FASTER=0]="FASTER",O[O.STRONGER=1]="STRONGER",O[O.FIREPOWER=2]="FIREPOWER",O[O.SCATTER=3]="SCATTER",O[O.ROF=4]="ROF",O[O.SIGHT=5]="SIGHT",O[O.SELF_HEAL=6]="SELF_HEAL",O[O.CLOAK=7]="CLOAK",O[O.EXPLODES=8]="EXPLODES",O[O.RADAR_INVISIBLE=9]="RADAR_INVISIBLE",O[O.SENSORS=10]="SENSORS",O[O.FEARLESS=11]="FEARLESS",O[O.C4=12]="C4",O[O.GUARD_AREA=13]="GUARD_AREA",O[O.CRUSHER=14]="CRUSHER"}}}),System.register("game/gameobject/unit/VeteranLevel",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("VeteranLevel",B={}))[O.None=0]="None",O[O.Veteran=1]="Veteran",O[O.Elite=2]="Elite"}}}),System.register("game/gameobject/unit/ZoneType",["game/type/LandType"],function(S,O){"use strict";var B,N;return O&&O.id,S("getZoneType",function(S){return[B.LandType.Water,B.LandType.Beach].includes(S)?N.Water:N.Ground}),{setters:[function(S){B=S}],execute:function(){var O;(O=N||S("ZoneType",N={}))[O.Ground=0]="Ground",O[O.Air=1]="Air",O[O.Water=2]="Water"}}}),System.register("game/gameopts/GameOptRandomGen",["game/math/Vector2","game/Prng","game/rules/mpAllowedColors","util/typeGuard","game/gameopts/constants"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){S("GameOptRandomGen",class{static factory(S,O){return new this(N.Prng.factory(S,O))}constructor(S){this.prng=S}generateColors(S){let O=[...S.humanPlayers,...S.aiPlayers].filter(L.isNotNullOrUndefined),B=O.map(S=>S.colorId).filter(S=>S!==D.RANDOM_COLOR_ID);var N=j.mpAllowedColors.length;let F=new Array(N).fill(0).map((S,O)=>O).filter(S=>!B.includes(S)),_=new Map;return O.forEach(S=>{if(S.countryId!==D.OBS_COUNTRY_ID&&S.colorId===D.RANDOM_COLOR_ID){if(F.length<1)throw new Error("Out of available colors to choose from");var O=this.prng.generateRandomInt(0,F.length-1);_.set(S,F[O]),F.splice(O,1)}}),_}generateCountries(S,O){let B=O.getMultiplayerCountries().length,N=[...S.humanPlayers,...S.aiPlayers].filter(L.isNotNullOrUndefined),j=new Map;return N.forEach(S=>{S.countryId===D.RANDOM_COUNTRY_ID&&j.set(S,this.prng.generateRandomInt(0,B-1))}),j}generateStartLocations(S,O){let B=[...S.humanPlayers,...S.aiPlayers].filter(L.isNotNullOrUndefined),N=B.filter(S=>S.startPos!==D.RANDOM_START_POS).map(S=>S.startPos),j=[...O.keys()].filter(S=>!N.includes(S)),F=[];for(;j.length;){var _=j.length?this.prng.generateRandomInt(0,j.length-1):0;F.push(...j.splice(_,1))}if(F.unshift(...N),3<=F.length)for(var U of[1,2])if(!(N.length-1>=U)){let S=F.map(S=>O[S]),B=this.findFarthestPointFrom(S.slice(0,U),S.slice(U));var H=S.findIndex(S=>S.x===B.x&&S.y===B.y);F.splice(U,0,...F.splice(H,1))}if(4<=F.length&&N.length-1<3){let S=F.map(S=>O[S]),B=this.findFarthestPointFrom(S.slice(2,3),S.slice(3));var V=S.findIndex(S=>S.x===B.x&&S.y===B.y);F.splice(3,0,...F.splice(V,1))}F.splice(0,N.length);let W=new Map,z=-1;return B.forEach(S=>{if(S.countryId!==D.OBS_COUNTRY_ID&&S.startPos===D.RANDOM_START_POS){if(z>=F.length-1)throw new RangeError("Map has fewer starting locations than players");W.set(S,F[++z])}}),W}findFarthestPointFrom(S,O){let N,j=S.map(S=>new B.Vector2(S.x,S.y)),L=0;if(!O.length)throw new Error("Search array must have at least one element");for(var D of O){let S=new B.Vector2(D.x,D.y);var F=j.reduce((O,B)=>O+S.distanceTo(B),0);F>=L&&(N=D,L=F)}return N}})}}}),System.register("game/gameopts/GameOptSanitizer",["util/math"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("GameOptSanitizer",class{static sanitize(S,O){var N=O.mpDialogSettings;S.credits=Math.floor(B.clamp(S.credits,N.minMoney,N.maxMoney)),S.gameSpeed=Math.floor(B.clamp(S.gameSpeed,0,6)),S.unitCount=Math.floor(B.clamp(S.unitCount,N.minUnitCount,N.maxUnitCount))}})}}}),System.register("game/gameopts/GameOpts",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;S("isHumanPlayerInfo",S=>"name"in S),(O=B||S("AiDifficulty",B={}))[O.Brutal=0]="Brutal",O[O.Medium=1]="Medium",O[O.Easy=2]="Easy",S("CUSTOM_AI_ID_START",100),S("isCustomAiDifficulty",S=>S>=100)}}}),System.register("game/gameopts/constants",["game/gameopts/GameOpts"],function(S,O){"use strict";var B;let N=new Map;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("RANDOM_COUNTRY_ID",-2),S("RANDOM_COLOR_ID",-2),S("RANDOM_START_POS",-2),S("NO_TEAM_ID",-2),S("OBS_COUNTRY_ID",-3),S("OBS_COLOR_ID",-2),S("RANDOM_COUNTRY_NAME","Random"),S("OBS_COUNTRY_NAME","Observer"),S("aiUiNames",(new Map).set(B.AiDifficulty.Easy,"GUI:AIDummy").set(B.AiDifficulty.Medium,"GUI:AIEasyBeta")),S("aiUiTooltips",new Map),S("RANDOM_COUNTRY_UI_NAME","GUI:RandomEx"),S("RANDOM_COUNTRY_UI_TOOLTIP","STT:PlayerSideRandom"),S("OBS_COUNTRY_UI_NAME","GUI:Observer"),S("OBS_COUNTRY_UI_TOOLTIP","STT:PlayerSideObserver"),S("RANDOM_COLOR_NAME",""),S("setCustomBotsRegistry",function(S){N=S||new Map}),S("getCustomBotsRegistry",function(){return N}),S("buildAiUiNames",function(S){const O=new Map([[B.AiDifficulty.Easy,"GUI:AIDummy"],[B.AiDifficulty.Medium,"GUI:AIEasyBeta"]]);if(S)for(const[B,N]of S)O.set(B,": "+N.name);return O}),S("getAiDisplayName",function(S,O){return S===B.AiDifficulty.Easy?O?O.get("GUI:AIDummy"):"AI-":S===B.AiDifficulty.Medium?O?O.get("GUI:AIEasyBeta"):"AI-":N&&N.has(S)?": "+N.get(S).name:"AI"})}}}),System.register("game/ini/GameModeType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("GameModeType",B={}))[O.Battle=0]="Battle",O[O.ManBattle=1]="ManBattle",O[O.FreeForAll=2]="FreeForAll",O[O.Unholy=3]="Unholy",O[O.Cooperative=4]="Cooperative"}}}),System.register("game/ini/GameModes",["game/rules/MpDialogSettings","game/ini/GameModeType"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("GameModes",class{constructor(S,O){this.modeIniLoader=O,this.entries=new Map,this.loadIni(S)}loadIni(S){S.getOrderedSections().forEach(S=>{let O=N.GameModeType[S.name]??N.GameModeType.Battle;[...S.entries.keys()].forEach(N=>{let j=S.getArray(N);if(j.length<5)throw new Error(`Invalid format for mp mode entry "${N}".`);var L=Number(N),D=j[2].toLowerCase();D={id:L,type:O,label:j[0],description:j[1],rulesOverride:D,mapFilter:j[3],randomMapsAllowed:j[4],aiAllowed:L<3,mpDialogSettings:(new B.MpDialogSettings).readIni(this.modeIniLoader(D).getOrCreateSection("MultiplayerDialogSettings"))},this.entries.set(L,D)})})}getById(S){if(!this.entries.has(S))throw new Error("No game mode found with id "+S);return this.entries.get(S)}hasId(S){return this.entries.has(S)}getAll(){return[...this.entries.values()]}})}}}),System.register("game/ini/MixinRules",["game/ini/MixinRulesType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("MixinRules",class{static getTypes(S){let O=[];return S.noDogEngiKills&&O.push(B.MixinRulesType.NoDogEngiKills),O}})}}}),System.register("game/ini/MixinRulesType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("MixinRulesType",B={}))[O.NoDogEngiKills=0]="NoDogEngiKills"}}}),System.register("game/map/BridgeOverlayTypes",["util/math"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S}],execute:function(){var O;(O=N||S("OverlayBridgeType",N={}))[O.NotBridge=0]="NotBridge",O[O.Concrete=1]="Concrete",O[O.Wood=2]="Wood",S("BridgeOverlayTypes",j=class{static getOverlayBridgeType(S){return B.isBetween(S,this.minHighBridgeConcreteId,this.maxHighBridgeConcreteId)||B.isBetween(S,this.minLowBridgeConcreteId,this.maxLowBridgeConcreteId)?N.Concrete:B.isBetween(S,this.minHighBridgeWoodId,this.maxHighBridgeWoodId)||B.isBetween(S,this.minLowBridgeWoodId,this.maxLowBridgeWoodId)?N.Wood:N.NotBridge}static isBridge(S){return this.isHighBridge(S)||this.isLowBridge(S)}static isBridgePlaceholder(S){return this.bridgePlaceholderIds.includes(S)}static isHighBridge(S){return B.isBetween(S,this.minHighBridgeWoodId,this.maxHighBridgeWoodId)||B.isBetween(S,this.minHighBridgeConcreteId,this.maxHighBridgeConcreteId)}static isLowBridge(S){return B.isBetween(S,this.minLowBridgeWoodId,this.maxLowBridgeWoodId)||B.isBetween(S,this.minLowBridgeConcreteId,this.maxLowBridgeConcreteId)}static isXBridge(S){return S===this.minHighBridgeWoodId||S===this.minHighBridgeConcreteId||B.isBetween(S,this.minLowBridgeWoodId,this.minLowBridgeWoodId+8)||B.isBetween(S,this.minLowBridgeWoodId+18,this.minLowBridgeWoodId+21)||B.isBetween(S,this.minLowBridgeConcreteId,this.minLowBridgeConcreteId+8)||B.isBetween(S,this.minLowBridgeConcreteId+18,this.minLowBridgeConcreteId+21)}static isLowBridgeHead(S){return B.isBetween(S,this.minLowBridgeWoodId+18,this.minLowBridgeWoodId+25)||B.isBetween(S,this.minLowBridgeConcreteId+18,this.minLowBridgeConcreteId+25)}static isLowBridgeHeadStart(S){return B.isBetween(S,this.minLowBridgeWoodId+20,this.minLowBridgeWoodId+23)||B.isBetween(S,this.minLowBridgeConcreteId+20,this.minLowBridgeConcreteId+23)}static calculateLowBridgeOverlayId(S,O){let B;if(S===N.Concrete)B=this.minLowBridgeConcreteId;else{if(S!==N.Wood)throw new Error("Not implemented");B=this.minLowBridgeWoodId}return B+(O?0:9)}static calculateHighBridgeOverlayId(S,O){let B;if(S===N.Concrete)B=this.minHighBridgeConcreteId;else{if(S!==N.Wood)throw new Error("Not implemented");B=this.minHighBridgeWoodId}return B+(O?0:1)}}),j.minLowBridgeWoodId=74,j.maxLowBridgeWoodId=99,j.minLowBridgeConcreteId=205,j.maxLowBridgeConcreteId=230,j.minHighBridgeConcreteId=24,j.maxHighBridgeConcreteId=25,j.minHighBridgeWoodId=237,j.maxHighBridgeWoodId=238,j.bridgePlaceholderIds=[100,101,231,232]}}}),System.register("game/map/Bridges",["game/map/TileCollection","game/map/BridgeOverlayTypes","game/map/tileFinder/DirectionalTileFinder","game/map/tileFinder/RadialTileFinder","game/theater/TileSets","engine/type/TerrainType","game/math/Vector2","game/map/tileFinder/FloodTileFinder"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){var O;(O=H||S("BridgeHeadType",H={}))[O.None=0]="None",O[O.Start=1]="Start",O[O.End=2]="End",S("Bridges",class{constructor(S,O,B,N,j){this.tileSets=S,this.tiles=O,this.tileOccupation=B,this.mapBounds=N,this.rules=j,this.pieces=new Set,this.piecesByTile=new Map,this.handleTileOccupationUpdate=({object:S,type:O})=>{if(S.isOverlay()&&S.isBridge()){var B=S.tile;let L=this.piecesByTile.get(B);if("added"===O){if(L)throw new Error(`A bridge piece already exists at tile (${B.rx},${B.ry})`);var N=this.findBridgeAdjacentTiles(S);L={obj:S,prev:void 0,next:void 0,headType:this.computeHead(S,N.prev,N.next)},this.piecesByTile.set(B,L),this.pieces.add(L),this.connectPiece(L,N.prev,N.next),this.updateOverlayData(L),L.prev&&this.updateOverlayData(L.prev),L.next&&this.updateOverlayData(L.next)}else{if(!L)throw new Error(`Bridge piece was alredy removed at tile (${B.rx},${B.ry})`);var j=L.prev;N=L.next,this.disconnectPiece(L),this.piecesByTile.delete(B),this.pieces.delete(L),j&&this.updateOverlayData(j),N&&this.updateOverlayData(N)}}},B.onChange.subscribe(this.handleTileOccupationUpdate)}getPieceAtTile(S){return this.piecesByTile.get(S)}handlePieceHealthChange(S){this.updateOverlayData(S),S.prev&&this.updateOverlayData(S.prev),S.next&&this.updateOverlayData(S.next)}findDominoPieces(S){let O=[],B=!1,N=S.next;if(S.headType===H.None||N)for(;N;){if(O.push(N),N.headType!==H.None){B=!0;break}N=N.next}else B=!0;if(B){B=!1,O.length=0;let N=S.prev;if(S.headType===H.None||N)for(;N;){if(O.push(N),N.headType!==H.None){B=!0;break}N=N.prev}else B=!0;if(B)return[]}return O}findBridgeAdjacentTiles(S){var O=S.isXBridge(),B=new _.Vector2(Number(O),Number(!O));let N=new _.Vector2(S.tile.rx,S.tile.ry);return O=N.clone().sub(B),O=this.tiles.getByMapCoords(O.x,O.y),B=N.clone().add(B),{prev:O,next:this.tiles.getByMapCoords(B.x,B.y)}}connectPiece(S,O,B){O&&(S.prev=this.getPieceAtTile(O),S.prev&&(S.prev.next=S)),B&&(S.next=this.getPieceAtTile(B),S.next&&(S.next.prev=S))}disconnectPiece(S){S.next&&(S.next.prev=void 0,S.next=void 0),S.prev&&(S.prev.next=void 0,S.prev=void 0)}computeHead(S,O,B){var j=S.tile;return S.isHighBridge()?(j=j.z+S.tileElevation,O?.z===j?H.Start:B?.z===j?H.End:H.None):N.BridgeOverlayTypes.isLowBridgeHead(S.overlayId)?N.BridgeOverlayTypes.isLowBridgeHeadStart(S.overlayId)?H.Start:H.End:H.None}updateOverlayData(S){let O=S.obj,B=S.prev,j=S.next,L=!1;var D=O.isXBridge(),F=N.BridgeOverlayTypes.getOverlayBridgeType(O.overlayId);if(N.BridgeOverlayTypes.isLowBridgeHead(O.overlayId)){let S=0;N.BridgeOverlayTypes.isLowBridgeHeadStart(O.overlayId)?(S=D?20:22,j||S++):(S=D?18:24,B||S++),O.overlayId=(F===N.OverlayBridgeType.Wood?N.BridgeOverlayTypes.minLowBridgeWoodId:N.BridgeOverlayTypes.minLowBridgeConcreteId)+S,O.value=S,L=!0}else{let W;var _,U,V=(O.healthTrait?.health??100)<=50;W=S.headType!==H.None?S.headType===H.Start?j?V?6:(j.obj.healthTrait?.health??100)<=50?5:0:D?8:7:B?V?6:(B.obj.healthTrait?.health??100)<=50?4:0:D?7:8:(D||(U=B,B=j,j=U),B||j?B?j?(_=(B.obj.healthTrait?.health??100)<=50,U=(j.obj.healthTrait?.health??100)<=50,V||_&&U?6:_?4:U?5:0):8:7:0),D||(W+=9),O.isHighBridge()?O.value=W:(O.overlayId=(F===N.OverlayBridgeType.Wood?N.BridgeOverlayTypes.minLowBridgeWoodId:N.BridgeOverlayTypes.minLowBridgeConcreteId)+W,O.value=W,L=!0)}L&&(O.name=this.rules.getOverlayName(O.overlayId))}findClosestBridgeSpec(S){let O=new L.RadialTileFinder(this.tiles,this.mapBounds,S,{width:1,height:1},1,3,O=>{if(O.z!==S.z)return!1;let B=this.tileOccupation.getBridgeOnTile(O);return!(!B?.isLowBridge()||this.getPieceAtTile(B.tile)?.headType===H.None)||!!this.tileSets.isHighBridgeBoundaryTile(O.tileNum)},!1);var B=O.getNextTile();if(B){let S,O,L,q;var F=!this.tileOccupation.getBridgeOnTile(B);let Q;if(F){var _=this.findHighBridgeBoundary(B);if(!_)return;S=_.tile,O=N.OverlayBridgeType.Concrete,this.tileSets.getSetNum(B.tileNum)===this.tileSets.getGeneralValue("WoodBridgeSet")&&(O=N.OverlayBridgeType.Wood),L=_.headType===D.HighBridgeHeadType.TopLeft||_.headType===D.HighBridgeHeadType.BottomRight,q=_.headType===D.HighBridgeHeadType.TopLeft||_.headType===D.HighBridgeHeadType.TopRight,Q=_.headType}else{S=this.tileOccupation.getBridgeOnTile(B).tile;let j=this.getPieceAtTile(S);if(!j)throw new Error("Bridge head is not defined");var U=N.BridgeOverlayTypes.getOverlayBridgeType(j.obj.overlayId);if(U===N.OverlayBridgeType.NotBridge)throw new Error("Expected a bridge type");O=U,L=j.obj.isXBridge(),q=j.headType===H.Start}var V=Number(L)*(q?1:-1),W=Number(!L)*(q?1:-1);let Z;if(F){if(B=new j.DirectionalTileFinder(this.tiles,this.mapBounds,S,1,100,V,W,O=>O.z===S.z&&this.tileSets.isHighBridgeBoundaryTile(O.tileNum),!1).getNextTile(),U=this.tileSets.getSetNum(S.tileNum),!B||this.tileSets.getSetNum(B.tileNum)!==U)return;if(!(B=this.findHighBridgeBoundary(B)))return;if(Q!==this.tileSets.getOppositeHighBridgeHeadType(B.headType))return;Z=B.tile}else{let O,B=1;for(var z=S.rx,K=S.ry;!O;){var $=this.tiles.getByMapCoords(z+V*B,K+W*B);if(!$)return;let S=this.getPieceAtTile($);if(S&&S.obj.isXBridge()!==L)return;S?.headType===(q?H.End:H.Start)&&(O=S),B++}Z=O.obj.tile}return{start:q?S:Z,end:q?Z:S,type:O,isHigh:F}}}findHighBridgeBoundary(S){var O,B=this.tileSets.getTile(S.tileNum),N=this.tileSets.getHighBridgeHeadType(B.index);if(void 0!==N){let B=0,j=0;switch(N){case D.HighBridgeHeadType.TopLeft:B=1,j=0;break;case D.HighBridgeHeadType.BottomRight:B=-1,j=0;break;case D.HighBridgeHeadType.TopRight:B=0,j=1;break;case D.HighBridgeHeadType.BottomLeft:B=0,j=-1;break;case D.HighBridgeHeadType.MiddleTlBr:B=1,j=0;break;case D.HighBridgeHeadType.MiddleTrBl:B=0,j=1;break;default:throw new Error(`Unhandled head type "${N}"`)}let L=new U.FloodTileFinder(this.tiles,this.mapBounds,S,O=>O.tileNum===S.tileNum,O=>O.terrainType===F.TerrainType.Pavement&&O.z>=S.z,!1),_=[];for(;O=L.getNextTile();)_.push(O);if(_.sort((S,O)=>100*(B?B*(O.rx-S.rx):j*(O.ry-S.ry))+(B?S.ry-O.ry:S.rx-O.rx)),_.length)return{tile:_[0],headType:N}}else console.warn(`Couldn't find a valid bridge type for index "${B.index}" @ ${S.rx},`+S.ry)}canBeRepaired(S){let O,N=this.createBridgePieceTileFinder(S,O=>!(this.getPieceAtTile(O)||this.tileSets.isHighBridgeMiddleTile(O.tileNum)&&O.z===S.start.z)),j=!1;for(var L=S.start.rx!==S.end.rx?B.TileDirection.BottomLeft:B.TileDirection.BottomRight;O=N.getNextTile();){j=!0;let B=this.tiles.getNeighbourTile(O,L),N=this.tiles.getNeighbourTile(B,L);if(S.isHigh){if([O,B,N].find(S=>this.tileOccupation.getGroundObjectsOnTile(S).some(S=>S.isBuilding()&&!S.rules.invisibleInGame)))return!1}else if([O,B,N].find(S=>this.tileOccupation.getGroundObjectsOnTile(S).some(S=>!(S.isUnit()||S.isSmudge()||S.isOverlay()&&S.isBridgePlaceholder()))))return!1}return j}getPieceTiles(S){var O=S.obj.tile,N=S.obj.isXBridge()?B.TileDirection.BottomLeft:B.TileDirection.BottomRight,j=this.tiles.getNeighbourTile(O,N);return[O,j,this.tiles.getNeighbourTile(j,N)]}findMapHighBridgeHeadTiles(){var S,O=this.tiles.getAllBridgeSetTiles();let B=new Set;for(S of O){var N=this.findHighBridgeBoundary(S);N&&B.add(N.tile)}return B}findBridgeSpecsForHeadTiles(S){let O=new Map;for(var B of S)(B=this.findClosestBridgeSpec(B))&&O.set(B.start.id+":"+B.end.id,B);return[...O.values()]}findAllBridgeTiles(S){let O=[];var N,j=S.start.rx!==S.end.rx?B.TileDirection.BottomLeft:B.TileDirection.BottomRight;for(N of this.findNonBuildablePieceTiles(S)){var L=this.tiles.getNeighbourTile(N,j),D=this.tiles.getNeighbourTile(L,j);O.push(N,L,D)}return O}findBridgePieces(S){let O=this.createBridgePieceTileFinder(S,S=>!!this.getPieceAtTile(S)),B=[];for(var N;N=O.getNextTile();)B.push(this.getPieceAtTile(N));return B}findDestroyedPieceTiles(S){let O=this.createBridgePieceTileFinder(S,O=>!(this.getPieceAtTile(O)||this.tileSets.isHighBridgeMiddleTile(O.tileNum)&&O.z===S.start.z)),B=[];for(var N;N=O.getNextTile();)B.push(N);return B}findNonBuildablePieceTiles(S){let O=this.createBridgePieceTileFinder(S,O=>!(this.tileSets.isHighBridgeMiddleTile(O.tileNum)&&O.z===S.start.z)),B=[];for(var N;N=O.getNextTile();)B.push(N);return B}createBridgePieceTileFinder(S,O){var B=S.start.rx!==S.end.rx;return new j.DirectionalTileFinder(this.tiles,this.mapBounds,S.start,1,(B?S.end.rx-S.start.rx:S.end.ry-S.start.ry)-1,Number(B),Number(!B),O,!1)}dispose(){this.pieces.forEach(S=>{S.prev=void 0,S.next=void 0}),this.tileOccupation.onChange.unsubscribe(this.handleTileOccupationUpdate)}})}}}),System.register("game/map/MapBounds",["util/geometry","game/Coords","util/event"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("MapBounds",class{constructor(){this.mapCutoffHeight=0,this.mapBuildableSize={x:0,y:0,width:0,height:0},this.localSize={x:0,y:0,width:0,height:0},this.fullSize={width:0,height:0},this.clampedFullSize={x:0,y:0,width:0,height:0},this.rawLocalSize={x:0,y:0,width:0,height:0},this._onLocalResize=new j.EventDispatcher}get onLocalResize(){return this._onLocalResize.asEvent()}fromMapFile(S,O){this.fullSize={width:2*S.fullSize.width,height:2*S.fullSize.height},this.clampedFullSize={x:1,y:2,width:2*(S.fullSize.width-1)-1/N.Coords.ISO_TILE_SIZE,height:2*(S.fullSize.height-1)+1-1/N.Coords.ISO_TILE_SIZE},this.mapCutoffHeight=Math.max(9,O.getCutoffTileHeight());var B={x:B=Math.max(2,S.localSize.x),y:S.localSize.y,width:Math.min(S.fullSize.width-2-B,S.localSize.width),height:S.localSize.height};return this.updateRawLocalSize(B),this}updateRawLocalSize(S){this.rawLocalSize.width&&this.rawLocalSize.height&&!B.rectContainsRect(S,this.rawLocalSize)?console.warn("New map limits must be outside old limits. Skipping."):B.rectEquals(S,this.rawLocalSize)||(this.localSize=this.computeLocalSize(S,this.fullSize.height/2,this.mapCutoffHeight),this.rawLocalSize={...S},this.mapBuildableSize={x:this.localSize.x,y:this.localSize.y+4,width:this.localSize.width-2,height:this.localSize.height-8},this._onLocalResize.dispatch(this))}computeLocalSize(S,O,B){return{x:2*S.x,y:2*S.y-4,height:Math.min(2*(S.height+5)-1,2*O-2*(S.y-3)-B),width:2*S.width}}getLocalSize(){return this.localSize}getRawLocalSize(){return this.rawLocalSize}getFullSize(){return this.fullSize}getClampedFullSize(){return this.clampedFullSize}isWithinBounds(S){return B.rectContainsPoint(this.mapBuildableSize,{x:S.dx,y:S.dy-S.z})}clampWithinBounds(S){let{x:O,y:N}=B.rectClampPoint(this.mapBuildableSize,{x:S.dx,y:S.dy-S.z});return N+=O%2-N%2,N>this.mapBuildableSize.y+this.mapBuildableSize.height&&(N-=2),{dx:O,dy:N}}isWithinHardBounds(S){var O=S.x/N.Coords.LEPTONS_PER_TILE,j=O-(L=(S.z??S.y)/N.Coords.LEPTONS_PER_TILE)+this.fullSize.width/2-1,L=O+L-this.fullSize.width/2-1;return B.rectContainsPoint(this.clampedFullSize,{x:++j,y:++L})}})}}}),System.register("game/map/MapShroud",["util/event","game/GameSpeed","engine/type/TerrainType","util/math"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){var O;D=(1<<3)-1,(O=F||S("ShroudType",F={}))[O.Unexplored=0]="Unexplored",O[O.TemporaryReveal=1]="TemporaryReveal",O[O.Explored=2]="Explored",(O=_||S("ShroudFlag",_={}))[O.Darken=8]="Darken",S("MapShroud",class e{constructor(){this.invalidations=new Map,this.temporaryReveals=new Map,this.fullInvalidation=!1,this._onChange=new B.EventDispatcher}get onChange(){return this._onChange.asEvent()}fromTiles(S){var O,B=S.getMapSize(),N=S.getMaxTileHeight();for(O of(N=this.padding=(N+N%2)/2,this.size={width:B.width+N,height:B.height+N},this.tiles=new Uint8Array(this.size.width*this.size.height),this.tiles.fill(F.Unexplored),this.tileElevation=new Uint8Array(this.size.width*this.size.height),S.getAll())){var L=this.getTileIndex(O);this.tileElevation[L]=Math.max(this.tileElevation[L],O.terrainType===j.TerrainType.Cliff&&0<O.z?O.z-1:O.z)}return this}getSize(){return this.size}getTileIndex(S){var{sx:O,sy:B}=this.rxyzToSxy(S.rx,S.ry,S.z);return O+B*this.size.width}rxyzToSxy(S,O,B){var N=(B|=0)+B%2;return{sx:S-N/2+this.padding,sy:O-N/2+this.padding}}sxyzToRxy(S,O,B){return{rx:S+Math.ceil(B/2)-this.padding,ry:O+Math.ceil(B/2)-this.padding}}shroudCoordsToWorld({sx:S,sy:O}){return this.sxyzToRxy(S,O,0)}findTilesAtShroudCoords({sx:S,sy:O},B){var N=B.getMaxTileHeight(),j=N+N%2;let L=[];for(let N=0;N<=j;N+=2){var D=N+N%2,{rx:F,ry:D}=this.sxyzToRxy(S,O,D);D=B.getByMapCoords(F,D),D?.z===N&&L.push(D)}return L}clone(){let S=new e;return S.tiles=this.tiles.slice(),S.size=this.size,S.padding=this.padding,S.tileElevation=this.tileElevation,S}copy(S){this.tiles=S.tiles.slice(),this.size=S.size,this.padding=S.padding,this.tileElevation=S.tileElevation}merge(S){if(this.size.width!==S.size.width||this.size.height!==S.size.height)throw new Error("Size mismatch");var O=S.tiles;for(let S=0,B=this.tiles.length;S<B;S++)this.tiles[S]=Math.max(O[S]&D,this.tiles[S]&D)|(O[S]|this.tiles[S])>>3<<3}isShrouded(S,O=0){var B=this.rxyzToSxy(S.rx,S.ry,S.z+O);return this.getShroudTypeByShroudCoords(B)===F.Unexplored}getShroudType(S){return this.tiles[this.getTileIndex(S)]&D}isFlagged(S,O){return 0!=(this.tiles[this.getTileIndex(S)]&O)}getShroudTypeByTileCoords(S,O,B){return this.getShroudTypeByShroudCoords(this.rxyzToSxy(S,O,B))}getShroudTypeByShroudCoords({sx:S,sy:O}){return S<0||O<0||S>=this.size.width||O>=this.size.height?F.Unexplored:this.tiles[S+O*this.size.width]&D}invalidateFull(){this.fullInvalidation=!0}invalidate(S,O,B){var N=S.sx+S.sy*this.size.width;let j=this.invalidations.get(N);j||(j={center:S,elevation:0,radius:0},this.invalidations.set(N,j)),j.elevation=Math.max(j.elevation,O),j.radius=Math.max(j.radius,B)}revealFrom(S){var O,B,N;S.isBuilding()&&S.wallTrait||(O=S.sight)&&(B=S.tile.z+S.tileElevation,N=this.rxyzToSxy(S.tile.rx,S.tile.ry,B),this.invalidate(N,B,O))}revealAround(S,O){var B=this.rxyzToSxy(S.rx,S.ry,S.z);this.invalidate(B,Number.POSITIVE_INFINITY,O)}unrevealAround(S,O){var B=[],N=this.rxyzToSxy(S.rx,S.ry,S.z);this.setValueAround(N,O,Number.POSITIVE_INFINITY,B,F.Unexplored,F.Explored),this._onChange.dispatch(this,{type:"incremental",coords:B})}revealTemporarily(S){var O=this.rxyzToSxy(S.tile.rx,S.tile.ry,S.tile.z+S.tileElevation);this.temporaryReveals.set(O,5*N.GameSpeed.BASE_TICKS_PER_SECOND)}revealObject(S){var O=this.rxyzToSxy(S.tile.rx,S.tile.ry,S.tile.z+S.tileElevation);this.invalidate(O,Number.POSITIVE_INFINITY,4.25)}toggleFlagsAround(S,O,B,N){var j=[],L=this.rxyzToSxy(S.rx,S.ry,S.z);this.setValueAround(L,O,Number.POSITIVE_INFINITY,j,void 0,void 0,N?{setFlags:B}:{clearFlags:B}),this._onChange.dispatch(this,{type:"incremental",coords:j})}update(){let S=[];if(this.invalidations.size){for(var O of this.invalidations.values())this.setValueAround(O.center,O.radius,O.elevation,S,F.Explored,[F.Unexplored,F.TemporaryReveal]);this.invalidations.clear()}this.temporaryReveals.size&&this.temporaryReveals.forEach((O,B)=>{O<=0?(this.setValueAround(B,3,Number.POSITIVE_INFINITY,S,F.Unexplored,F.TemporaryReveal),this.temporaryReveals.delete(B)):(O===5*N.GameSpeed.BASE_TICKS_PER_SECOND&&this.setValueAround(B,3,Number.POSITIVE_INFINITY,S,F.TemporaryReveal,F.Unexplored),this.temporaryReveals.set(B,O-1))}),this.fullInvalidation?(this.fullInvalidation=!1,this._onChange.dispatch(this,{type:"full"})):S.length&&this._onChange.dispatch(this,{type:"incremental",coords:S})}setValueAround(S,O,B,N,j,F=void 0,{setFlags:_,clearFlags:U}={}){var H=Math.ceil(O),V=L.clamp(S.sx-H,0,this.size.width-1),W=L.clamp(S.sx+H,0,this.size.width-1),z=L.clamp(S.sy-H,0,this.size.height-1),K=L.clamp(S.sy+H,0,this.size.height-1),$=this.size.width;for(let L=V;L<=W;L++)for(let H=z;H<=K;H++){var q=L+H*$,Q=this.tiles[q]&D,Z=this.tiles[q]>>3<<3;let V=Z;void 0!==_&&(V|=_),void 0!==U&&(V&=~U),void 0!==F&&("number"!=typeof F?!F.includes(Q):F!==Q)||(L-S.sx)*(L-S.sx)+(H-S.sy)*(H-S.sy)>O*O+1||this.tileElevation[q]>=B+4||(this.tiles[q]=(j??Q)|V,Q===j&&Z===V||N.push({sx:L,sy:H}))}}revealAll(){this.tiles.fill(F.Explored),this._onChange.dispatch(this,{type:"clear"})}reset(){this.tiles.fill(F.Unexplored),this._onChange.dispatch(this,{type:"cover"})}})}}}),System.register("game/map/OreOverlayTypes",["engine/type/OverlayTibType"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("OreOverlayTypes",N=class{static getOverlayTibType(S){return this.isRiparius(S)?B.OverlayTibType.Riparius:this.isCruentus(S)?B.OverlayTibType.Cruentus:this.isVinifera(S)?B.OverlayTibType.Vinifera:this.isAboreus(S)?B.OverlayTibType.Aboreus:B.OverlayTibType.NotSpecial}static isRiparius(S){return S>=this.minIdRiparius&&S<=this.maxIdRiparius}static isCruentus(S){return S>=this.minIdCruentus&&S<=this.maxIdCruentus}static isVinifera(S){return S>=this.minIdVinifera&&S<=this.maxIdVinifera}static isAboreus(S){return S>=this.minIdAboreus&&S<=this.maxIdAboreus}}),N.minIdRiparius=102,N.maxIdRiparius=127,N.minIdCruentus=27,N.maxIdCruentus=38,N.minIdVinifera=127,N.maxIdVinifera=146,N.minIdAboreus=147,N.maxIdAboreus=166}}}),System.register("game/map/OreSpread",["game/map/OreOverlayTypes","engine/type/OverlayTibType"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("OreSpread",class{static calculateOverlayId(S,O){if(S!==N.OverlayTibType.NotSpecial){var j=O.dx,L=O.dy;return j=Math.floor((L-9)/2%12*((L-8)/2%12)%12-(j-13)/2%12*((j-12)/2%12)%12+12e4),j%=12,S===N.OverlayTibType.Ore?B.OreOverlayTypes.minIdRiparius+j:S===N.OverlayTibType.Gems?B.OreOverlayTypes.minIdCruentus+j:S===N.OverlayTibType.Vinifera?B.OreOverlayTypes.minIdVinifera+j:S===N.OverlayTibType.Aboreus?B.OreOverlayTypes.minIdAboreus+j:void 0}}})}}}),System.register("game/map/Terrain",["game/map/TileCollection","game/type/SpeedType","util/Graph","game/map/pathFinder/PathFinder","util/typeGuard","game/map/tileFinder/RadialTileFinder","util/geometry","game/type/LandType","game/rules/TerrainRules"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;function u(S,O){var B=Math.abs(S.data.tile.rx-O.data.tile.rx),N=Math.abs(S.data.tile.ry-O.data.tile.ry);return B+N+(Math.SQRT2-2)*Math.min(B,N)}function d(S,O,B){var N=Math.abs(S.data.tile.rx-O.data.tile.rx),j=Math.abs(S.data.tile.ry-O.data.tile.ry);let L=N+j+(Math.SQRT2-2)*Math.min(N,j);return B?.parent&&(j=(N=B.parent.node).data.tile.rx-S.data.tile.rx,N=N.data.tile.ry-S.data.tile.ry,B.dirX=j,B.dirY=N,j===B.parent.dirX&&N===B.parent.dirY||(L+=.2)),L}return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S}],execute:function(){S("Terrain",class{constructor(S,O,B,j,L){this.tiles=S,this.theaterType=O,this.mapBounds=B,this.tileOccupation=j,this.rules=L,this.passabilityGraphs=new Map,this.invalidatedTiles=new Map,this.handleTileOccupationUpdate=({tiles:S,object:O})=>{var B=S.filter(S=>{let B=N.SpeedType.Foot,j=!0;return O.isTerrain()&&O.rules.getOccupationBits(this.theaterType)!==H.OccupationBits.All&&(B=N.SpeedType.Wheel,j=!1),O.isOverlay()&&(O.isBridge()||O.isTiberium())||this.isBlockerObject(O,S,!1,B,j)||this.isBlockerObject(O,S,!0,B,j)||O.isBuilding()&&O.rules.leaveRubble});B.length&&this.invalidateTiles(B)},this.handleMapBoundsResize=()=>{this.passabilityGraphs.clear()},j.onChange.subscribe(this.handleTileOccupationUpdate),B.onLocalResize.subscribe(this.handleMapBoundsResize)}getGraphKey(S,O){return S+"_"+Number(O)}invalidateTiles(S){S.length&&[...this.passabilityGraphs.keys()].forEach(O=>{let B=this.invalidatedTiles.get(O);B?S.forEach(S=>B.add(S)):this.invalidatedTiles.set(O,new Set(S))})}computePath(S,O,B,N,j,D,{maxExpandedNodes:_=Number.POSITIVE_INFINITY,bestEffort:U=!0,excludeTiles:H,ignoredBlockers:V=[]}={}){let W=this.computePassabilityGraph(S,O);var z=V.map(S=>this.tileOccupation.calculateTilesForGameObject(S.tile,S)).reduce((S,O)=>S.concat(O),[]);z.length&&this.updatePassability(z,S,O,W,V);var K=this.getNodeId(B,N),$=!!W.hasNode(K);$||this.updatePassability([B],S,O,W,V,1);var q=this.getNodeId(j,D),Q=!!W.hasNode(q);let Z;var Y=$&&!z.length;if(Y){let j=this.getIslandIdMap(S,O),L=j.get(B,N);Z=(S,O)=>j.get(S,O)===L}else Z=(B,N)=>0<this.getPassableSpeed(B,S,O,N,V);if(!Q||!Z(j,D)){var X=U?new F.RadialTileFinder(this.tiles,this.mapBounds,j,{width:1,height:1},1,Y?15:5,S=>Z(S,!1)&&Math.abs(S.z-j.z)<2&&!H?.({tile:S,onBridge:void 0})).getNextTile():void 0;if(X)j=X,D=!1;else{if(Y)return z.length&&this.updatePassability(z,S,O,W),[];W.addNode(q,{tile:j,onBridge:void 0}),_=Math.min(_,500)}}let J=L.PathFinder(W,{bestEffort:U,maxExpandedNodes:_,excludedNodes:H,distance:u,heuristic:d}).find(this.getNodeId(B,N),this.getNodeId(j,D)).map(S=>({tile:S.data.tile,onBridge:S.data.onBridge}));return(J.length<2||H&&J.length&&(!U&&J[0].tile!==j||J[J.length-1].tile!==B))&&(J=[]),$||(W.removeNode(K),this.updatePassability([B],S,O,W)),Q||W.removeNode(q),z.length&&this.updatePassability(z,S,O,W),J}computeAllPassabilityGraphs(){Object.keys(N.SpeedType).forEach(S=>{var O=Number(S);isNaN(O)||O===N.SpeedType.Winged||(this.computePassabilityGraph(O,!1),this.computePassabilityGraph(O,!0))})}computePassabilityGraph(S,O){var B=this.getGraphKey(S,O);let N=this.passabilityGraphs.get(B);if(N){let j=this.invalidatedTiles.get(B);j?.size&&(this.updatePassability([...j],S,O,N),j.clear(),this.computeIslandIds(N))}else N=new j.Graph,this.passabilityGraphs.set(B,N),this.tiles.forEach(B=>{this.computePassability(B,S,O,N)}),this.computeIslandIds(N);return N}updatePassability(S,O,N,j,L=[],F){let _=new Set;S.forEach(S=>{[S,this.tiles.getNeighbourTile(S,B.TileDirection.Right),this.tiles.getNeighbourTile(S,B.TileDirection.BottomRight),this.tiles.getNeighbourTile(S,B.TileDirection.Bottom),this.tiles.getNeighbourTile(S,B.TileDirection.BottomLeft)].filter(D.isNotNullOrUndefined).forEach(S=>_.add(S))});let U=new Map;S.forEach(S=>{var O;for(O of[j.getNode(this.getNodeId(S,!1)),j.getNode(this.getNodeId(S,!0))])O&&(U.set(O.id,O.data.islandId),j.removeNode(O.id))}),_.forEach(B=>{this.computePassability(B,O,N,j,L,F&&S.includes(B)?F:void 0)}),U.forEach((S,O)=>{let B=j.getNode(O);B&&(B.data.islandId=S)})}computePassability(S,O,N,j,L=[],D){var F=[B.TileDirection.Left,B.TileDirection.TopLeft,B.TileDirection.Top,B.TileDirection.TopRight];if(D||this.getPassableSpeed(S,O,N,!1,L)){var _,U=this.getNodeId(S,!1);for(_ of(j.hasNode(U)||j.addNode(U,{tile:S,onBridge:void 0,forceLandSpeed:D}),F))this.connectTiles(S,void 0,_,O,N,j,L)}var H,V=this.tileOccupation.getBridgeOnTile(S);if(V&&(D||this.getPassableSpeed(S,O,N,!0,L)))for(H of(U=this.getNodeId(S,!0),j.hasNode(U)||j.addNode(U,{tile:S,onBridge:V,forceLandSpeed:D}),F))this.connectTiles(S,V,H,O,N,j,L)}connectTiles(S,O,B,N,j,L,D=[]){var F=this.tiles.getNeighbourTile(S,B);if(F){let B=this.tileOccupation.getBridgeOnTile(F);var _=O||B?0:1;if(Math.abs(S.z+(O?.tileElevation??0)-(F.z+(B?.tileElevation??0)))>_){if(!B?.isHighBridge()&&!O?.isHighBridge()||0!==Math.abs(S.z-F.z)||!L.hasNode(this.getNodeId(S,!1)))return;O=B=void 0}_=this.getNodeId(F,!!B);let U=L.getNode(_);this.getPassableSpeed(F,N,j,!!B,D,void 0,U?.data.forceLandSpeed)&&(U=U??L.addNode(_,{tile:F,onBridge:B}),F=this.getNodeId(S,!!O),L.getNode(F).addLink(U))}}getNodeId(S,O){return S.id+(O?"_bridge":"")}computeIslandIds(S){let O=1;S.forEachNode(S=>{S.data.islandId=void 0}),S.forEachNode(S=>{S.data.islandId||this.floodIslandId(S,O++)})}floodIslandId(S,O){let B=[S];for(;B.length;){let S=B.pop();for(var N of(S.data.islandId=O,S.neighbors))N.data.islandId||B.push(N)}}getIslandIdMap(S,O){let B=this.computePassabilityGraph(S,O);return{get:(S,O)=>{var N=this.getNodeId(S,O);return B.getNode(N)?.data.islandId}}}getPassableSpeed(S,O,B,j,L=[],D=!1,F){if(!this.mapBounds.isWithinBounds(S))return 0;let _=j?S.onBridgeLandType:S.landType;if(void 0===_)return 0;_===U.LandType.Wall&&O===N.SpeedType.Track&&(_=U.getLandType(S.terrainType));let H=this.rules.getLandRules(_);var V,W=F||H.getSpeedModifier(O);if(!W)return 0;if(!D)for(V of this.tileOccupation.getObjectsOnTile(S))if(this.isBlockerObject(V,S,j,O,B)&&!L.includes(V))return 0;return W}isBlockerObject(S,O,B,j,L){if(S.isTerrain()&&L&&S.rules.getOccupationBits(this.theaterType)!==H.OccupationBits.All)return!1;if(S.isBuilding()){if(S.rules.invisibleInGame)return!1;if(S.isDestroyed&&S.rules.leaveRubble)return!1;if(S.rules.gate)return!1;var D=S.art.foundation;let B=S.rules.numberImpassableRows;return L?B=D.width:S.rules.weaponsFactory&&!B&&(B=D.width-1),D={x:S.tile.rx,y:S.tile.ry,width:(B||D.width)-1,height:D.height-1},_.rectContainsPoint(D,{x:O.rx,y:O.ry})}return!(S.isAircraft()||S.isInfantry()||S.isVehicle()||S.isSmudge()||S.isOverlay()&&(B&&S.isBridge()||!B&&S.isHighBridge()||S.isTiberium()||S.rules.crate||S.isBridgePlaceholder())||[N.SpeedType.Track,N.SpeedType.Hover].includes(j)&&S.rules.crushable)}findObstacles(S,O){var B,j,L=O.rules.speedType,D=O.isInfantry();let F=[];for(B of this.tileOccupation.getGroundObjectsOnTile(S.tile))B!==O&&((j=this.isBlockerObject(B,S.tile,!!S.onBridge,L,D))||B.isUnit()&&(B.tile===S.tile&&B.onBridge===!!S.onBridge||B.moveTrait.reservedPathNodes.find(O=>O.tile===S.tile&&!!O.onBridge==!!S.onBridge))||[N.SpeedType.Track,N.SpeedType.Hover].includes(L)&&B.rules.crushable||D&&B.isTerrain()||B.isBuilding()&&B.rules.gate)&&(j={obj:B,static:j},B.isInfantry()&&D?B.position.desiredSubCell===O.position.desiredSubCell&&F.push(j):B.isTerrain()&&D&&!B.rules.getOccupiedSubCells(this.theaterType).includes(O.position.desiredSubCell)||F.push(j));return F}dispose(){this.tileOccupation.onChange.unsubscribe(this.handleTileOccupationUpdate),this.mapBounds.onLocalResize.unsubscribe(this.handleMapBoundsResize)}})}}}),System.register("game/map/Tile",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/map/TileCollection",["game/type/LandType","engine/type/TerrainType","util/typeGuard"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){var O;(O=L||S("TileDirection",L={}))[O.Top=0]="Top",O[O.TopLeft=1]="TopLeft",O[O.TopRight=2]="TopRight",O[O.Left=3]="Left",O[O.Right=4]="Right",O[O.BottomLeft=5]="BottomLeft",O[O.Bottom=6]="Bottom",O[O.BottomRight=7]="BottomRight",S("TileCollection",class{constructor(S,O,j,L){this.tileSets=O,this.generalRules=j;let D=this.rSize={width:0,height:0},F=this.dSize={width:0,height:0};for(let O=0,B=S.length;O<B;++O)D.width=Math.max(D.width,S[O].rx),D.height=Math.max(D.height,S[O].ry),F.width=Math.max(F.width,S[O].dx),F.height=Math.max(F.height,S[O].dy);D.width++,D.height++,F.width++,F.height++;let _=this.tilesByRxy=new Array(D.width*D.height);_.fill(void 0);let U=this.tilesByDxy=new Array(F.width*F.height);U.fill(void 0);let H=this.tiles=new Array(S.length),V=[],W=this.bridgeSetTiles=[],z=new Set(Object.values(N.TerrainType));this.minTileHeight=Number.POSITIVE_INFINITY;for(let j=this.maxTileHeight=0,J=S.length;j<J;++j){var K=S[j],$=O.getTileImage(K.tileNum,K.subTile,L),q=$.terrainType;if(!z.has(q))throw new Error(`Tile (${K.rx}, ${K.ry}) has unknown terrain type "${q}"`);var Q={...K,terrainType:q,landType:B.getLandType(q),onBridgeLandType:void 0,rampType:$.rampType,id:K.rx+"_"+K.ry,occluded:!1},Z=Q.rx,Y=Q.ry,X=Q.dx;q=Q.dy,H[j]=Q,_[Z+Y*D.width]=Q,U[X+q*F.width]=Q,this.minTileHeight=Math.min(this.minTileHeight,Q.z),this.maxTileHeight=Math.max(this.maxTileHeight,Q.z),4!==$.height||Q.terrainType!==N.TerrainType.Cliff&&!O.isCliffTile(Q.tileNum)||V.push(Q),O.isHighBridgeBoundaryTile(K.tileNum)&&W.push(Q)}this.computeLandBehindCliffTiles(V),this.cutoffTileHeight=this.computeCutoffTileHeight()}computeLandBehindCliffTiles(S){if(!(this.generalRules.cliffBackImpassability<2)){let O=[[-2,-2],[-1,-1],[-1,1],[1,-1],[0,1],[1,0]];S.forEach(S=>{for(var[j,L]of O){let O=this.getByMapCoords(S.rx+j,S.ry+L);O&&O.z<S.z&&O.terrainType!==N.TerrainType.Cliff&&O.terrainType!==N.TerrainType.Rough&&0===O.rampType&&(O.landType=B.LandType.Rock)}})}}getTileRadarColor(S){return this.tileSets.getTileImage(S.tileNum,S.subTile,()=>0).radarLeft.clone().multiplyScalar(.5)}getAll(){return[...this.tiles]}forEach(S){for(let O=0,B=this.tiles.length;O<B;++O)S(this.tiles[O],O)}reduce(S,O){let B=O;return this.forEach(O=>{B=S(B,O)}),B}getMinTileHeight(){return this.minTileHeight}getMaxTileHeight(){return this.maxTileHeight}getCutoffTileHeight(){return this.cutoffTileHeight}computeCutoffTileHeight(){var S=this.dSize.width-1;let O=this.dSize.height-1,B=0,N=!0;for(;N&&0<O;){for(let L=1;L<S-3;L++){var j=this.getByDisplayCoords(L,O);j&&(N=!1,j.z>B&&(B=j.z))}N&&O--}return B}getAllBridgeSetTiles(){return this.bridgeSetTiles}getAllNeighbourTiles(S){var O=S.rx,B=S.ry;return[this.getByMapCoords(O+1,B+1),this.getByMapCoords(O-1,B-1),this.getByMapCoords(O-1,B+1),this.getByMapCoords(O+1,B-1),this.getByMapCoords(O,B+1),this.getByMapCoords(O+1,B),this.getByMapCoords(O-1,B),this.getByMapCoords(O,B-1)].filter(j.isNotNullOrUndefined)}getNeighbourTile(S,O){var B=S.rx,N=S.ry;switch(O){case L.Bottom:return this.getByMapCoords(B+1,N+1);case L.Top:return this.getByMapCoords(B-1,N-1);case L.Left:return this.getByMapCoords(B-1,N+1);case L.Right:return this.getByMapCoords(B+1,N-1);case L.BottomLeft:return this.getByMapCoords(B,N+1);case L.BottomRight:return this.getByMapCoords(B+1,N);case L.TopLeft:return this.getByMapCoords(B-1,N);case L.TopRight:return this.getByMapCoords(B,N-1);default:throw new Error("Invalid direction")}}getByDisplayCoords(S,O){if(!(S>=this.dSize.width||O>=this.dSize.height))return this.tilesByDxy[S+O*this.dSize.width]}getByMapCoords(S,O){if(!(S>=this.rSize.width||O>=this.rSize.height))return this.tilesByRxy[S+O*this.rSize.width]}getMapSize(){return this.rSize}getDisplaySize(){return this.dSize}getInRectangle(S,O){let B,N,j,L;L=O?(B=S.rx,N=S.ry,j=O.width,O.height):(B=S.x,N=S.y,j=S.width,S.height);let D=[];for(let S=0;S<j;S++)for(let O=0;O<L;O++){var F=B+S,_=N+O;(_=this.getByMapCoords(F,_))&&D.push(_)}return D}getPlaceholderTile(S,O){var j;return{rx:S,ry:O,dx:S-O+(j=(j=this.tiles[0]).dx-j.rx+j.ry+1)-1,dy:S+O-j-1,z:0,id:S+"_"+O,landType:B.LandType.Rock,terrainType:N.TerrainType.Rock1,rampType:0,subTile:0,tileNum:0,occluded:!1,onBridgeLandType:void 0}}})}}}),System.register("game/map/TileOcclusion",["game/math/Vector2"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("TileOcclusion",class{constructor(S){this.tiles=S,this.tileOcclusion=[];let O=this.tileOcclusion;for(var B of S.getAll())O[B.rx]=O[B.rx]||[],O[B.rx][B.ry]=new Set}addOccluder(S){this.calculateTilesForGameObject(S).forEach(O=>this.occludeTile(O,S))}removeOccluder(S){this.calculateTilesForGameObject(S).forEach(O=>this.unoccludeTile(O,S))}calculateTilesForGameObject(S){var O=S.art.occupyHeight,N=Math.max(0,O-2);let j=[];var L=S.getFoundation();for(let S=1;S<=N;S++)for(let O=0;O<L.width;O++)j.push(new B.Vector2(O-S,-S));for(let S=1;S<=N;S++)for(let O=1;O<L.height;O++)j.push(new B.Vector2(-S,O-S));j.push(...S.art.addOccupy);for(let{x:O,y:B}of S.art.removeOccupy){var D=j.findIndex(S=>S.x===O&&S.y===B);-1!==D&&j.splice(D,1)}var F,_,U=S.tile;let H=[];for({x:F,y:_}of j){var V=this.tiles.getByMapCoords(U.rx+F,U.ry+_);V&&H.push(V)}return H}occludeTile(S,O){this.tileOcclusion[S.rx][S.ry].add(O),S.occluded=!0}unoccludeTile(S,O){let B=this.tileOcclusion[S.rx][S.ry];B.delete(O),S.occluded=0<B.size}isTileOccluded(S){return 0<this.tileOcclusion[S.rx][S.ry].size}})}}}),System.register("game/map/TileOccupation",["game/type/LandType","util/event","game/gameobject/unit/ZoneType"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){var O;(O=L||S("LayerType",L={}))[O.All=0]="All",O[O.Ground=1]="Ground",O[O.Air=2]="Air",S("TileOccupation",class{get onChange(){return this._onChange.asEvent()}constructor(S){this.tiles=S,this.tileOccupation=[],this.emptyTiles=new Set,this._onChange=new N.EventDispatcher;let O=this.tileOccupation;for(var B of S.getAll())O[B.rx]=O[B.rx]||[],O[B.rx][B.ry]=new Set,this.emptyTiles.add(B)}occupyTileRange(S,O){let B=this.calculateTilesForGameObject(S,O);B.forEach(S=>this.occupyTile(S,O)),this._onChange.dispatch(this,{tiles:B,object:O,type:"added"})}unoccupyTileRange(S,O){let B=this.calculateTilesForGameObject(S,O);B.forEach(S=>this.unoccupyTile(S,O)),this._onChange.dispatch(this,{tiles:B,object:O,type:"removed"})}occupySingleTile(S,O){this.occupyTile(S,O),this._onChange.dispatch(this,{tiles:[S],object:O,type:"added"})}unoccupySingleTile(S,O){this.unoccupyTile(S,O),this._onChange.dispatch(this,{tiles:[S],object:O,type:"removed"})}calculateTilesForGameObject(S,O){return this.tiles.getInRectangle(S,O.getFoundation())}occupyTile(S,O){let B=this.tileOccupation[S.rx]?.[S.ry];B&&(B.add(O),this.emptyTiles.delete(S),S.landType=this.computeTileLandType(S),S.onBridgeLandType=this.computeOnBridgeLandType(S))}unoccupyTile(S,O){let B=this.tileOccupation[S.rx]?.[S.ry];B&&(B.delete(O),B.size||this.emptyTiles.add(S),S.landType=this.computeTileLandType(S),S.onBridgeLandType=this.computeOnBridgeLandType(S))}isTileOccupiedBy(S,O){return!!this.tileOccupation[S.rx]?.[S.ry]?.has(O)}computeTileLandType(S){if(S.landType===B.LandType.Rock)return B.LandType.Rock;var O,N=B.getLandType(S.terrainType);for(O of this.tileOccupation[S.rx]?.[S.ry]??[]){if((O.isOverlay()||O.isBuilding())&&O.rules.wall)return B.LandType.Wall;if(O.isOverlay()&&O.isTiberium())return B.LandType.Tiberium;if(O.isOverlay()&&O.rules.land!==B.LandType.Clear&&!O.isBridge()&&!O.isBridgePlaceholder())return O.rules.land}return N}computeOnBridgeLandType(S){for(var O of this.tileOccupation[S.rx]?.[S.ry]??[])if(O.isOverlay()&&O.isBridge())return O.isHighBridge()?B.LandType.Road:O.rules.land}getTileZone(S,O=!1){return j.getZoneType(O?S.landType:S.onBridgeLandType??S.landType)}getBridgeOnTile(S){for(var O of this.tileOccupation[S.rx]?.[S.ry]??[])if(O.isOverlay()&&O.isBridge())return O}getObjectsOnTile(S){return[...this.tileOccupation[S.rx]?.[S.ry]??[]]}getGroundObjectsOnTile(S){let O=[];for(var B of this.tileOccupation[S.rx]?.[S.ry]??[])B.isTechno()&&!B.isBuilding()&&B.zone===j.ZoneType.Air||O.push(B);return O}getAirObjectsOnTile(S){let O=[];for(var B of this.tileOccupation[S.rx]?.[S.ry]??[])B.isUnit()&&B.zone===j.ZoneType.Air&&O.push(B);return O}getObjectsOnTileByLayer(S,O){if(O===L.Ground)return this.getGroundObjectsOnTile(S);if(O===L.Air)return this.getAirObjectsOnTile(S);if(O===L.All)return this.getObjectsOnTile(S);throw new Error(`Unhandled layer type "${O}"`)}getEmptyTiles(){return[...this.emptyTiles]}})}}}),System.register("game/map/pathFinder/NodeHeap",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("NodeHeap",class{constructor(S=[]){if(this.data=S,this.length=S.length,0<this.length)for(let S=this.length>>1;0<=S;S--)this.down(S);for(let S=0;S<this.length;++S)this.setNodeId(this.data[S],S)}compare(S,O){return S.fScore-O.fScore}setNodeId(S,O){S.heapIndex=O}push(S){this.data.push(S),this.setNodeId(S,this.length),this.length++,this.up(this.length-1)}pop(){if(0!==this.length){var S=this.data[0];return this.length--,0<this.length&&(this.data[0]=this.data[this.length],this.setNodeId(this.data[0],0),this.down(0)),this.data.pop(),S}}peek(){return this.data[0]}updateItem(S){this.down(S),this.up(S)}up(S){let O=this.data;for(var B=O[S];0<S;){var N=S-1>>1,j=O[N];if(0<=this.compare(B,j))break;O[S]=j,this.setNodeId(j,S),S=N}O[S]=B,this.setNodeId(B,S)}down(S){let O=this.data;for(var B=this.length>>1,N=O[S];S<B;){let B=1+(S<<1);var j=B+1;let L=O[B];if(j<this.length&&this.compare(O[j],L)<0&&(B=j,L=O[j]),0<=this.compare(L,N))break;O[S]=L,this.setNodeId(L,S),S=B}O[S]=N,this.setNodeId(N,S)}})}}}),System.register("game/map/pathFinder/PathFinder",["game/map/pathFinder/NodeHeap","game/map/pathFinder/SearchStatePool"],function(S,O){"use strict";var B,N;function s(){return 0}function a(){return 1}function n(S){let O=[S.node],B=S.parent;for(;B;)O.push(B.node),B=B.parent;return O}return O&&O.id,S("PathFinder",function(S,O={}){let j=O.bestEffort,L=O.maxExpandedNodes||Number.POSITIVE_INFINITY,D=O.heuristic??s,F=O.distance??a,_=O.excludedNodes,U=N.makeSearchStatePool();return{find:function(O,N){let H=S.getNode(O);if(!H)throw new Error("fromId is not defined in this graph: "+O);let V=S.getNode(N);if(!V)throw new Error("toId is not defined in this graph: "+N);if(H===V)return[];U.reset();let W=new Map,z=new B.NodeHeap,K=U.createNewState(H);if(W.set(O,K),K.fScore=_?.(V.data)?Number.POSITIVE_INFINITY:D(H,V),!Number.isFinite(K.fScore)&&H.neighbors.has(V))return[];K.distanceToSource=0,z.push(K),K.open=1;let $,q=K,Q=0;for(;0<z.length;){if($=z.pop(),$.node===V)return n($);if(Q++,Q>L)break;$.closed=!0,$.node.neighbors.forEach(v)}return j?n(q):[];function v(S){let O=W.get(S.id);var B;O||(O=U.createNewState(S),W.set(S.id,O)),O.closed||(0===O.open&&(z.push(O),O.open=1),(B=_?.(S.data)?Number.POSITIVE_INFINITY:$.distanceToSource+F($.node,S))>=O.distanceToSource||(O.parent=$,O.distanceToSource=B,_?.(V.data)?O.fScore=Number.POSITIVE_INFINITY:O.fScore=B+D(O.node,V,O),O.fScore-O.distanceToSource<q.fScore-q.distanceToSource&&(q=O),z.updateItem(O.heapIndex)))}}}}),{setters:[function(S){B=S},function(S){N=S}],execute:function(){}}}),System.register("game/map/pathFinder/SearchStatePool",[],function(S,O){"use strict";var B;return O&&O.id,S("makeSearchStatePool",function(){let S=0,O=[];return{createNewState(N){let j=O[S];return j?(j.node=N,j.parent=void 0,j.closed=!1,j.open=0,j.distanceToSource=Number.POSITIVE_INFINITY,j.fScore=Number.POSITIVE_INFINITY,j.heapIndex=-1):(j=new B(N),O[S]=j),S++,j},reset(){S=0}}}),{setters:[],execute:function(){S("NodeSearchState",B=class{constructor(S){this.node=S,this.closed=!1,this.open=0,this.distanceToSource=Number.POSITIVE_INFINITY,this.fScore=Number.POSITIVE_INFINITY,this.heapIndex=-1}})}}}),System.register("game/map/tileFinder/CardinalTileFinder",["game/math/Vector2"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("CardinalTileFinder",class{constructor(S,O,N,j,L,D=()=>!0){this.tiles=S,this.mapBounds=O,this.startTile=N,this.maxDistance=L,this.predicate=D,this.dirVec=new B.Vector2(10,0),this.finished=!1,this.diagonal=!0,this.distance=j}getNextTile(){if(!this.finished){let O;do{let N={x:this.startTile.rx,y:this.startTile.ry};N.x+=this.distance*Math.sign(this.dirVec.x),N.y+=this.distance*Math.sign(this.dirVec.y),this.dirVec.rotateAround(new B.Vector2,Math.PI/4*(this.diagonal?1:2)).round();var S=this.tiles.getByMapCoords(N.x,N.y);if(S&&this.mapBounds.isWithinBounds(S)&&this.predicate(S)&&(O=S),!this.dirVec.angle()){if(this.maxDistance&&this.distance>=this.maxDistance)return this.finished=!0,O;this.distance++}}while(!O);return O}}})}}}),System.register("game/map/tileFinder/DirectionalTileFinder",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("DirectionalTileFinder",class{constructor(S,O,B,N,j,L,D,F=()=>!0,_=!0){this.tiles=S,this.mapBounds=O,this.startTile=B,this.maxDistance=j,this.dirX=L,this.dirY=D,this.predicate=F,this.checkBounds=_,this.finished=!1,this.distance=N}getNextTile(){if(!this.finished){let O;do{let B={x:this.startTile.rx,y:this.startTile.ry};B.x+=this.distance*Math.sign(this.dirX),B.y+=this.distance*Math.sign(this.dirY);var S=this.tiles.getByMapCoords(B.x,B.y);if(S&&(!this.checkBounds||this.mapBounds.isWithinBounds(S))&&this.predicate(S)&&(O=S),this.maxDistance&&this.distance>=this.maxDistance)return this.finished=!0,O}while(this.distance++,!O);return O}}})}}}),System.register("game/map/tileFinder/FloodTileFinder",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("FloodTileFinder",class{constructor(S,O,B,N,j,L=!0){this.tiles=S,this.mapBounds=O,this.startTile=B,this.areConnected=N,this.predicate=j,this.checkBounds=L,this.generator=this.generate()}getNextTile(){return this.generator.next().value}*generate(){let S=[this.startTile],O=new Set;for(;S.length;){var B,N=S.pop();if(!O.has(N))for(B of(O.add(N),this.checkBounds&&!this.mapBounds.isWithinBounds(N)||!this.predicate(N)||(yield N),this.tiles.getAllNeighbourTiles(N)))this.areConnected(B,N)&&S.push(B)}}})}}}),System.register("game/map/tileFinder/RadialBackFirstTileFinder",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("RadialBackFirstTileFinder",class{constructor(S,O,B,N,j,L,D,F=!0){this.tiles=S,this.mapBounds=O,this.startTile=B,this.foundation=N,this.maxDistance=L,this.predicate=D,this.checkBounds=F,this.distance=j,this.generator=this.generate()}getNextTile(){return this.generator.next().value}*generate(){var e=(S,O)=>{var B=this.tiles.getByMapCoords(S,O);if(B&&(!this.checkBounds||this.mapBounds.isWithinBounds(B))&&this.predicate(B))return B};do{var S=this.startTile.rx-this.distance,O=this.startTile.ry-this.distance,B=this.startTile.rx+this.foundation.width-1+this.distance,N=this.startTile.ry+this.foundation.height-1+this.distance;let j,L,D;if(0<this.distance){for(L=1+O;L<N;L++)D=e(S,L),D&&(yield D);for(j=S;j<B;j++)D=e(j,O),D&&(yield D);for(L=N-1;L>=O;L--)D=e(B,L),D&&(yield D);for(j=B;j>=S;j--)D=e(j,N),D&&(yield D)}else this.predicate(this.startTile)&&(yield this.startTile)}while(this.distance++,this.distance<=this.maxDistance)}})}}}),System.register("game/map/tileFinder/RadialTileFinder",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("RadialTileFinder",class{constructor(S,O,B,N,j,L,D,F=!0){this.tiles=S,this.mapBounds=O,this.startTile=B,this.foundation=N,this.maxDistance=L,this.predicate=D,this.checkBounds=F,this.distance=j,this.generator=this.generate()}getNextTile(){return this.generator.next().value}*generate(){var e=(S,O)=>{var B=this.tiles.getByMapCoords(S,O);if(B&&(!this.checkBounds||this.mapBounds.isWithinBounds(B))&&this.predicate(B))return B};do{var S=this.startTile.rx-this.distance,O=this.startTile.ry-this.distance,B=this.startTile.rx+this.foundation.width-1+this.distance,N=this.startTile.ry+this.foundation.height-1+this.distance;let j,L,D;if(0<this.distance){for(j=B;j>=S;j--)D=e(j,N),D&&(yield D);for(L=N-1;L>=O;L--)D=e(B,L),D&&(yield D);for(j=S;j<B;j++)D=e(j,O),D&&(yield D);for(L=1+O;L<N;L++)D=e(S,L),D&&(yield D)}else this.predicate(this.startTile)&&(yield this.startTile)}while(this.distance++,this.distance<=this.maxDistance)}})}}}),System.register("game/map/tileFinder/RandomTileFinder",["game/math/GameMath"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("RandomTileFinder",class{constructor(S,O,N,j,L,D,F=!1,_=!0){this.tiles=S,this.mapBounds=O,this.startTile=N,this.maxDistance=j,this.rng=L,this.predicate=D,this.includeStartTile=F,this.checkBounds=_,this.pool=[],this.pool=new Array(B.GameMath.pow(2*this.maxDistance+1,2)).fill(0).map((S,O)=>O),this.generator=this.generate()}getNextTile(){return this.generator.next().value}*generate(){for(var e=(S,O)=>{var B=this.tiles.getByMapCoords(S,O);if(this.includeStartTile||B!==this.startTile)return B&&(!this.checkBounds||this.mapBounds.isWithinBounds(B))&&this.predicate(B)?B:void 0},S=2*this.maxDistance+1;this.pool.length;){var O=1<this.pool.length?this.rng.generateRandomInt(0,this.pool.length):0,B=(O=(B=this.pool.splice(O,1)[0])%S,Math.floor(B/S));(B=e(this.startTile.rx-this.maxDistance+O,this.startTile.ry-this.maxDistance+B))&&(yield B)}}})}}}),System.register("game/map/wallTypes",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("wallTypes",[[0,0,0,0],[1,0,0,0],[0,1,0,0],[1,1,0,0],[0,0,1,0],[1,0,1,0],[0,1,1,0],[1,1,1,0],[0,0,0,1],[1,0,0,1],[0,1,0,1],[1,1,0,1],[0,0,1,1],[1,0,1,1],[0,1,1,1],[1,1,1,1]])}}}),System.register("game/math/Box2",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends THREE.Box2{},S("Box2",B)}}}),System.register("game/math/CubicBezierCurve3",["game/math/Vector3"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends THREE.CubicBezierCurve3{constructor(S,O,N,j){super(S||new B.Vector3,O||new B.Vector3,N||new B.Vector3,j||new B.Vector3)}getPoint(S,O){return super.getPoint(S,O||new B.Vector3)}},S("CubicBezierCurve3",N)}}}),System.register("game/math/CurvePath",["game/math/LineCurve"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends THREE.CurvePath{closePath(){let S=this.curves[0].getPoint(0);var O=this.curves[this.curves.length-1].getPoint(1);S.equals(O)||this.curves.push(new B.LineCurve(O,S))}},S("CurvePath",N)}}}),System.register("game/math/Cylindrical",["game/math/GameMath"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends THREE.Cylindrical{setFromVector3(S){return this.radius=B.GameMath.sqrt(S.x*S.x+S.z*S.z),this.theta=B.GameMath.atan2(S.x,S.z),this.y=S.y,this}},S("Cylindrical",N)}}}),System.register("game/math/Euler",["util/math","game/math/GameMath","game/math/Quaternion","game/math/Vector3"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends THREE.Euler{constructor(){super(...arguments),this.isEuler=!0}setFromRotationMatrix(S,O,j){var L=(z=S.elements)[0],D=z[4],F=z[8],_=z[1],U=z[5],H=z[9],V=z[2],W=z[6],z=z[10];return"XYZ"===(O=O||this._order)?(this._y=N.GameMath.asin(B.clamp(F,-1,1)),Math.abs(F)<.99999?(this._x=N.GameMath.atan2(-H,z),this._z=N.GameMath.atan2(-D,L)):(this._x=N.GameMath.atan2(W,U),this._z=0)):"YXZ"===O?(this._x=N.GameMath.asin(-B.clamp(H,-1,1)),Math.abs(H)<.99999?(this._y=N.GameMath.atan2(F,z),this._z=N.GameMath.atan2(_,U)):(this._y=N.GameMath.atan2(-V,L),this._z=0)):"ZXY"===O?(this._x=N.GameMath.asin(B.clamp(W,-1,1)),Math.abs(W)<.99999?(this._y=N.GameMath.atan2(-V,z),this._z=N.GameMath.atan2(-D,U)):(this._y=0,this._z=N.GameMath.atan2(_,L))):"ZYX"===O?(this._y=N.GameMath.asin(-B.clamp(V,-1,1)),Math.abs(V)<.99999?(this._x=N.GameMath.atan2(W,z),this._z=N.GameMath.atan2(_,L)):(this._x=0,this._z=N.GameMath.atan2(-D,U))):"YZX"===O?(this._z=N.GameMath.asin(B.clamp(_,-1,1)),Math.abs(_)<.99999?(this._x=N.GameMath.atan2(-H,U),this._y=N.GameMath.atan2(-V,L)):(this._x=0,this._y=N.GameMath.atan2(F,z))):"XZY"===O?(this._z=N.GameMath.asin(-B.clamp(D,-1,1)),Math.abs(D)<.99999?(this._x=N.GameMath.atan2(W,U),this._y=N.GameMath.atan2(F,L)):(this._x=N.GameMath.atan2(-H,z),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+O),this._order=O,!1!==j&&this.onChangeCallback(),this}reorder(S){return F.setFromEuler(this),this.setFromQuaternion(F,S)}toVector3(S){return S?S.set(this._x,this._y,this._z):new L.Vector3(this._x,this._y,this._z)}},S("Euler",D),F=new j.Quaternion}}}),System.register("game/math/GameMath",["util/math"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("GameMath",N=class{static reverseSinTableLookup(S,O,B,N){for(;O<=B;){var j=Math.floor((O+B)/2),L=this.SIN_TABLE[j];if(L===S)return j;(N?S<L:L<S)?O=j+1:B=j-1}return Math.abs(S-this.SIN_TABLE[O])<Math.abs(S-this.SIN_TABLE[B])?O:B}static pow(S,O){if(!Number.isFinite(S)||!Number.isFinite(O)||Number.isSafeInteger(S)&&Number.isSafeInteger(O))return S**O;if(!Number.isSafeInteger(O))throw new Error("Exponent must be a safe integer");return Math.floor(S*this.EXP_10_PRECISION)**O/this.EXP_10_PRECISION**O}static sqrt(S){if(0===S)return 0;var O;let B=S/3;for(;O=B,B=(S/B+B)/2,5e-15<Math.abs(O-B););return B}static sin(S){if(!Number.isFinite(S))return NaN;if(!S)return S;var O=S/(2*Math.PI)-Math.floor(S/(2*Math.PI));return O=Math.floor(O*this.SIN_TABLE.length),this.SIN_TABLE[O]}static cos(S){return this.sin(S+Math.PI/2)}static asin(S){if(!B.isBetween(S,-1,1))return NaN;if(!S)return 0;let O;var N=this.SIN_TABLE.length;return O=0<S?2*Math.PI*this.reverseSinTableLookup(S,0,N/4,!1)/N:Math.PI-2*Math.PI*this.reverseSinTableLookup(S,N/2,.75*N,!0)/N,O}static acos(S){return Math.PI/2-this.asin(S)}static atan2(S,O){if(Number.isNaN(O)||Number.isNaN(S))return NaN;let B;return B=Number.isFinite(S)||Number.isFinite(O)?Number.isFinite(O)&&0!==S?Number.isFinite(S)&&0!==O?this.atan2FiniteNonZero(S,O):this.signIncZero(S)*Math.PI*.5:this.signIncZero(S)*(this.signIncZero(O)<0?Math.PI:0):Math.sign(S)*Math.PI*(0<Math.sign(O)?.25:.75),B}static atan2FiniteNonZero(S,O){var B=Math.abs(O),N=Math.abs(S),j=Math.min(B,N)/Math.max(B,N),L=j*j;let D=((-.0464964749*L+.15931422)*L-.327622764)*L*j+j;return B<N&&(D=Math.PI/2-D),O<0&&(D=Math.PI-D),S<0&&(D=-D),D}static signIncZero(S){return S===-1/0||1/S<0?-1:1}}),N.PRECISION=6,N.EXP_10_PRECISION=10**N.PRECISION,N.SIN_TABLE=[0,.004848117819001859,.009696121685978396,.014543897651582654,.01939133177182437,.024238310110748135,.0290847187431114,.03393044375706223,.03877537125681671,.043619387365336,.04846237822700296,.05330423001029823,.05814482891047582,.06298406115223795,.06782181299240934,.0726579707226106,.07749242067193093,.08232504920959989,.08715574274765817,.09198438774362744,.09681087070317909,.10163507818280187,.10645689679246824,.11127621319829964,.11609291412523022,.12090688635966935,.12571801675216268,.13052619222005157,.13533129975013108,.14013322640130627,.14493185930724672,.1497270856790396,.15451879280784048,.15930686806752256,.16409119891732396,.1688716729044928,.17364817766693033,.17842060093583212,.18318883053832663,.18795275440011186,.19271226054808968,.19746723711299752,.20221757233203794,.20696315455150538,.2117038722294107,.21643961393810288,.22117026836688775,.2258957243246448,.23061587074244014,.2353305966761376,.24003979130900588,.2447433439543238,.24944114405798126,.25413308120107847,.25881904510252074,.26349892562161076,.2681726127606373,.272839996667461,.27750096763809573,.28215541611928774,.2868032327110902,.29144430816943495,.2960785334086999,.3007057995042731,.3053259976951131,.30993901938630514,.31454475615161365,.31914309973603083,.323733942058321,.328317175213561,.33289269147567657,.3374603832999741,.3420201433256687,.34657186437840753,.3511154394727888,.3556507618148765,.3601777248047104,.36469622203881186,.3692061473126844,.3737073946233105,.3781998581716425,.3826834323650898,.3871580118200006,.3916234913641391,.3960797660391568,.4005267311030606,.4049642820326736,.4093923145260926,.4138107245051391,.4182194081178064,.42261826174069944,.4270071819814715,.4313860656812534,.4357548099170794,.4401133120043048,.44446146949902104,.4487991802004621,.4531263421534082,.4574428536505808,.4617486132350339,.46604351970253877,.4703274721039625,.4746003697476404,.4788621122017435,.4831125992966384,.48735173112724234,.49157940805537054,.49579553071207916,.49999999999999994,.5041927170956704,.5083735834518556,.5125425007998652,.5166993711518628,.5208440968031697,.5249765803345602,.5290967246145525,.5332044328016912,.5372996083468239,.5413821549953696,.5454519767895825,.549508978070806,.5535530634817223,.5575841379685927,.5616021067834929,.5656068754865385,.5695983499481065,.573576436351046,.5775410411928851,.5814920712880266,.5854294337699405,.5893530360933448,.593262786036382,.5971585917027862,.6010403615240428,.6049080042615417,.6087614290087207,.6126005451932028,.6164252625789254,.62023549126826,.6240311417041269,.6278121246720986,.6315783513024975,.6353297330724851,.6390661818081416,.6427876096865393,.6464939292378065,.6501850533471834,.6538608952570697,.6575213685690636,.6611663872459932,.6647958656139378,.6684097183642425,.6720078605555224,.6755902076156601,.6791566753437932,.6827071799122926,.6862416378687335,.6897599661378576,.6932620820235242,.696747903210655,.7002173477671685,.7036703341459059,.7071067811865475,.710526608117521,.713929734557899,.7173160805192894,.7206855664077146,.7240381130254825,.7273736415730487,.7306920736508674,.7339933312612352,.7372773368101241,.7405440131090046,.7437932833766612,.747025071240996,.7502393007408245,.7534358963276606,.7566147828674927,.7597758856425494,.7629191303530553,.766044443118978,.7691517504817651,.7722409794060692,.7753120572814658,.7783649119241599,.7813994715786823,.7844156649195757,.7874134210530723,.7903926695187593,.7933533402912352,.7962953637817558,.7992186708398696,.8021231927550437,.8050088612582783,.8078756085237111,.8107233671702122,.8135520702629676,.8163616513150519,.8191520442889918,.821923183598318,.8246750041091067,.8274074411415104,.8301204304712788,.8328139083312671,.8354878114129364,.8381420768678404,.8407766423091032,.8433914458128856,.845986425919841,.848561521636559,.8511166724369997,.8536518182639162,.8561668995302665,.8586618571206132,.8611366323925137,.8635911671778986,.8660254037844386,.8684392849969005,.870832754078492,.8732057547721958,.8755582313020908,.8778901283746645,.8802013911801111,.8824919653936212,.8847617971766577,.8870108331782216,.8892390205361062,.8914463068781385,.8936326403234122,.8957979694835052,.8979422434636881,.9000654118641211,.9021674247810376,.9042482328079179,.9063077870366499,.9083460390586793,.9103629409661466,.9123584453530141,.9143325053161794,.9162850744565779,.918216106880274,.9201255571995389,.9220133805339185,.9238795325112867,.9257239692688903,.9275466474543786,.9293475242268224,.9311265572577219,.9328837047320004,.9346189253489884,.9363321783233931,.9380234233862578,.9396926207859083,.9413397312888874,.942964716180876,.9445675372676047,.9461481568757504,.947706537853822,.9492426435730339,.9507564379281666,.9522478853384153,.9537169507482269,.955163599628123,.9565877979755122,.9579895123154889,.9593687097016201,.9607253577167205,.9620594244736131,.9633708786158803,.9646596893185995,.9659258262890683,.9671692597675166,.9683899605278059,.969587899878116,.97076304966162,.9719153822571454,.9730448705798238,.9741514880817275,.9752352087524931,.9762960071199334,.9773338582506355,.9783487377505475,.9793406217655515,.980309486982024,.9812553106273847,.9821780704706308,.98307774482286,.9839543125377807,.984807753012208,.9856380461865492,.9864451725452739,.987229113117374,.987989849476809,.9887273637429388,.9894416385809445,.9901326572022359,.9908004033648453,.9914448613738104,.9920660160815423,.9926638528881819,.993238357741943,.9937895171394426,.9943173181260184,.9948217482960331,.9953027957931658,.9957604493106914,.9961946980917455,.9966055319295779,.996992941167792,.9973569167005722,.9976974499728977,.9980145329807433,.9983081582712682,.9985783189429907,.9988250086459504,.9990482215818578,.99924795250423,.9994241967185149,.9995769500822006,.9997062090049132,.9998119704485015,.9998942319271075,.9999529915072262,.9999882478077495,1,.9999882478077495,.9999529915072262,.9998942319271075,.9998119704485015,.9997062090049132,.9995769500822006,.9994241967185149,.99924795250423,.9990482215818578,.9988250086459504,.9985783189429907,.9983081582712682,.9980145329807433,.9976974499728977,.9973569167005722,.996992941167792,.9966055319295779,.9961946980917455,.9957604493106914,.9953027957931658,.9948217482960331,.9943173181260184,.9937895171394426,.993238357741943,.9926638528881819,.9920660160815423,.9914448613738105,.9908004033648453,.9901326572022359,.9894416385809446,.9887273637429388,.987989849476809,.987229113117374,.9864451725452739,.9856380461865492,.984807753012208,.9839543125377807,.98307774482286,.9821780704706307,.9812553106273847,.9803094869820241,.9793406217655516,.9783487377505476,.9773338582506356,.9762960071199334,.9752352087524931,.9741514880817276,.9730448705798238,.9719153822571455,.9707630496616201,.969587899878116,.9683899605278059,.9671692597675166,.9659258262890683,.9646596893185995,.9633708786158803,.9620594244736133,.9607253577167205,.9593687097016202,.9579895123154889,.9565877979755123,.9551635996281231,.9537169507482269,.9522478853384153,.9507564379281666,.949242643573034,.9477065378538221,.9461481568757505,.9445675372676048,.942964716180876,.9413397312888873,.9396926207859084,.9380234233862579,.9363321783233931,.9346189253489885,.9328837047320006,.9311265572577219,.9293475242268225,.9275466474543786,.9257239692688904,.9238795325112867,.9220133805339185,.920125557199539,.918216106880274,.916285074456578,.9143325053161794,.9123584453530141,.9103629409661467,.9083460390586793,.90630778703665,.904248232807918,.9021674247810377,.9000654118641213,.8979422434636883,.8957979694835051,.8936326403234123,.8914463068781386,.8892390205361062,.8870108331782218,.8847617971766579,.8824919653936212,.8802013911801111,.8778901283746644,.8755582313020909,.8732057547721958,.8708327540784921,.8684392849969006,.8660254037844387,.8635911671778987,.8611366323925138,.858661857120613,.8561668995302665,.8536518182639163,.8511166724369997,.8485615216365591,.8459864259198412,.8433914458128856,.8407766423091031,.8381420768678404,.8354878114129364,.8328139083312672,.8301204304712789,.8274074411415107,.8246750041091069,.8219231835983182,.819152044288992,.8163616513150518,.8135520702629675,.8107233671702123,.8078756085237112,.8050088612582784,.802123192755044,.7992186708398695,.7962953637817556,.7933533402912352,.7903926695187593,.7874134210530723,.7844156649195758,.7813994715786824,.7783649119241601,.775312057281466,.7722409794060693,.769151750481765,.766044443118978,.7629191303530551,.7597758856425494,.756614782867493,.7534358963276608,.7502393007408243,.7470250712409959,.7437932833766611,.7405440131090045,.7372773368101241,.7339933312612353,.7306920736508675,.7273736415730488,.7240381130254827,.7206855664077148,.7173160805192896,.713929734557899,.710526608117521,.7071067811865476,.703670334145906,.7002173477671687,.6967479032106549,.6932620820235241,.6897599661378576,.6862416378687336,.6827071799122926,.6791566753437933,.6755902076156604,.6720078605555225,.6684097183642426,.6647958656139381,.6611663872459935,.6575213685690636,.6538608952570697,.6501850533471835,.6464939292378067,.6427876096865395,.6390661818081418,.635329733072485,.6315783513024975,.6278121246720986,.6240311417041269,.6202354912682602,.6164252625789255,.612600545193203,.6087614290087209,.6049080042615419,.6010403615240432,.5971585917027862,.593262786036382,.5893530360933449,.5854294337699406,.5814920712880268,.5775410411928852,.5735764363510459,.5695983499481064,.5656068754865385,.5616021067834929,.5575841379685929,.5535530634817224,.5495089780708062,.5454519767895827,.5413821549953699,.5372996083468241,.5332044328016912,.5290967246145525,.5249765803345602,.5208440968031698,.516699371151863,.5125425007998654,.5083735834518555,.5041927170956703,.49999999999999994,.49579553071207916,.49157940805537065,.48735173112724245,.48311259929663863,.4788621122017437,.47460036974764064,.47032747210396275,.46604351970253877,.4617486132350339,.45744285365058085,.4531263421534083,.44879918020046233,.4444614694990212,.4401133120043047,.43575480991707927,.43138606568125343,.4270071819814714,.4226182617406995,.4182194081178065,.4138107245051393,.40939231452609276,.4049642820326738,.40052673110306086,.3960797660391572,.39162349136413904,.38715801182000065,.3826834323650899,.37819985817164264,.3737073946233107,.3692061473126843,.36469622203881175,.3601777248047104,.3556507618148765,.35111543947278884,.34657186437840765,.3420201433256689,.3374603832999743,.33289269147567685,.32831717521356135,.3237339420583214,.31914309973603083,.3145447561516137,.30993901938630525,.30532599769511326,.30070579950427334,.29607853340870016,.2914443081694349,.2868032327110902,.28215541611928774,.2775009676380958,.2728399966674611,.26817261276063753,.263498925621611,.258819045102521,.2541330812010788,.24944114405798165,.24474334395432376,.24003979130900596,.2353305966761377,.23061587074244033,.225895724324645,.22117026836688802,.21643961393810274,.21170387222941067,.20696315455150538,.20221757233203796,.19746723711299763,.19271226054808982,.18795275440011205,.18318883053832688,.17842060093583242,.17364817766693072,.16887167290449276,.16409119891732402,.15930686806752267,.15451879280784062,.1497270856790398,.14493185930724697,.14013322640130613,.135331299750131,.13052619222005157,.12571801675216274,.12090688635966945,.11609291412523036,.11127621319829985,.1064568967924685,.10163507818280217,.09681087070317945,.09198438774362741,.0871557427476582,.08232504920959997,.07749242067193107,.07265797072261079,.0678218129924096,.06298406115223781,.05814482891047573,.0533042300102982,.04846237822700297,.04361938736533607,.038775371256816835,.03393044375706242,.029084718743111644,.02423831011074843,.01939133177182472,.014543897651583058,.009696121685978408,.004848117819001927,12246467991473532e-32,-.004848117819001238,-.009696121685978163,-.01454389765158237,-.019391331771824474,-.02423831011074774,-.029084718743111398,-.03393044375706173,-.03877537125681659,-.04361938736533583,-.048462378227003174,-.05330423001029795,-.05814482891047593,-.06298406115223758,-.06782181299240934,-.07265797072261056,-.07749242067193128,-.08232504920959974,-.08715574274765794,-.09198438774362716,-.09681087070317876,-.10163507818280193,-.10645689679246781,-.1112762131982996,-.11609291412523012,-.12090688635966965,-.1257180167521625,-.13052619222005177,-.13533129975013078,-.14013322640130632,-.14493185930724675,-.14972708567904,-.1545187928078404,-.15930686806752198,-.16409119891732377,-.16887167290449254,-.17364817766693047,-.17842060093583176,-.18318883053832663,-.1879527544001114,-.1927122605480896,-.19746723711299738,-.20221757233203816,-.20696315455150513,-.21170387222941087,-.21643961393810252,-.2211702683668878,-.22589572432464475,-.23061587074244053,-.23533059667613745,-.2400397913090053,-.2447433439543235,-.24944114405798098,-.2541330812010786,-.25881904510252035,-.2634989256216107,-.26817261276063686,-.2728399966674609,-.27750096763809556,-.2821554161192879,-.28680323271108993,-.29144430816943506,-.29607853340869994,-.30070579950427306,-.30532599769511304,-.3099390193863046,-.3145447561516135,-.3191430997360306,-.3237339420583211,-.3283171752135607,-.33289269147567657,-.3374603832999737,-.34202014332566866,-.3465718643784074,-.35111543947278906,-.35565076181487626,-.36017772480471055,-.3646962220388115,-.3692061473126845,-.3737073946233105,-.3781998581716428,-.38268343236508967,-.38715801182000004,-.3916234913641388,-.39607976603915657,-.40052673110306064,-.4049642820326732,-.40939231452609254,-.41381072450513867,-.4182194081178062,-.4226182617406993,-.4270071819814716,-.4313860656812532,-.43575480991707943,-.4401133120043045,-.444461469499021,-.4487991802004621,-.4531263421534085,-.4574428536505806,-.46174861323503374,-.46604351970253854,-.47032747210396214,-.4746003697476404,-.47886211220174313,-.4831125992966384,-.4873517311272422,-.4915794080553708,-.49579553071207894,-.5000000000000001,-.50419271709567,-.5083735834518556,-.5125425007998652,-.5166993711518633,-.5208440968031696,-.5249765803345596,-.5290967246145523,-.533204432801691,-.5372996083468239,-.5413821549953693,-.5454519767895825,-.5495089780708056,-.5535530634817222,-.5575841379685926,-.5616021067834931,-.5656068754865384,-.5695983499481065,-.5735764363510458,-.577541041192885,-.5814920712880266,-.5854294337699408,-.5893530360933448,-.5932627860363815,-.597158591702786,-.6010403615240426,-.6049080042615417,-.6087614290087203,-.6126005451932028,-.6164252625789249,-.6202354912682599,-.6240311417041268,-.6278121246720987,-.6315783513024973,-.6353297330724852,-.6390661818081416,-.6427876096865393,-.6464939292378065,-.6501850533471829,-.6538608952570695,-.6575213685690635,-.6611663872459933,-.6647958656139376,-.6684097183642425,-.6720078605555221,-.6755902076156601,-.6791566753437931,-.6827071799122927,-.6862416378687334,-.6897599661378577,-.693262082023524,-.696747903210655,-.7002173477671685,-.7036703341459061,-.7071067811865475,-.7105266081175206,-.7139297345578989,-.7173160805192892,-.7206855664077146,-.7240381130254823,-.7273736415730487,-.7306920736508671,-.7339933312612352,-.737277336810124,-.7405440131090048,-.743793283376661,-.747025071240996,-.7502393007408242,-.7534358963276607,-.7566147828674927,-.7597758856425493,-.7629191303530554,-.7660444431189779,-.7691517504817651,-.7722409794060688,-.7753120572814659,-.7783649119241597,-.7813994715786822,-.7844156649195754,-.7874134210530722,-.7903926695187589,-.7933533402912349,-.7962953637817558,-.79921867083987,-.8021231927550437,-.8050088612582785,-.8078756085237111,-.8107233671702119,-.8135520702629674,-.8163616513150515,-.8191520442889916,-.8219231835983181,-.8246750041091064,-.8274074411415104,-.830120430471279,-.8328139083312671,-.8354878114129365,-.8381420768678401,-.8407766423091032,-.8433914458128855,-.8459864259198411,-.8485615216365587,-.8511166724369996,-.8536518182639165,-.8561668995302664,-.8586618571206132,-.8611366323925135,-.8635911671778986,-.8660254037844385,-.8684392849969005,-.8708327540784918,-.8732057547721956,-.8755582313020905,-.8778901283746643,-.8802013911801112,-.8824919653936215,-.8847617971766578,-.8870108331782218,-.889239020536106,-.8914463068781383,-.8936326403234122,-.8957979694835049,-.897942243463688,-.9000654118641208,-.9021674247810375,-.9042482328079179,-.90630778703665,-.9083460390586792,-.9103629409661468,-.912358445353014,-.9143325053161795,-.9162850744565778,-.918216106880274,-.9201255571995388,-.9220133805339183,-.9238795325112865,-.9257239692688903,-.9275466474543786,-.9293475242268223,-.9311265572577219,-.9328837047320003,-.9346189253489884,-.9363321783233929,-.9380234233862578,-.9396926207859082,-.9413397312888873,-.9429647161808761,-.9445675372676049,-.9461481568757504,-.9477065378538222,-.9492426435730339,-.9507564379281666,-.9522478853384153,-.9537169507482267,-.9551635996281229,-.956587797975512,-.9579895123154888,-.9593687097016201,-.9607253577167205,-.9620594244736131,-.9633708786158804,-.9646596893185994,-.9659258262890683,-.9671692597675166,-.9683899605278059,-.9695878998781159,-.97076304966162,-.9719153822571452,-.9730448705798238,-.9741514880817276,-.975235208752493,-.9762960071199334,-.9773338582506355,-.9783487377505475,-.9793406217655514,-.980309486982024,-.9812553106273846,-.9821780704706307,-.98307774482286,-.9839543125377805,-.984807753012208,-.9856380461865493,-.9864451725452739,-.9872291131173742,-.9879898494768089,-.9887273637429387,-.9894416385809445,-.9901326572022358,-.9908004033648452,-.9914448613738104,-.9920660160815423,-.9926638528881818,-.993238357741943,-.9937895171394426,-.9943173181260184,-.994821748296033,-.9953027957931658,-.9957604493106913,-.9961946980917455,-.9966055319295779,-.996992941167792,-.9973569167005722,-.9976974499728977,-.9980145329807433,-.9983081582712682,-.9985783189429907,-.9988250086459504,-.9990482215818578,-.99924795250423,-.9994241967185149,-.9995769500822006,-.9997062090049132,-.9998119704485015,-.9998942319271076,-.9999529915072262,-.9999882478077495,-1,-.9999882478077495,-.9999529915072262,-.9998942319271076,-.9998119704485015,-.9997062090049132,-.9995769500822006,-.9994241967185149,-.99924795250423,-.9990482215818578,-.9988250086459504,-.9985783189429907,-.9983081582712682,-.9980145329807433,-.9976974499728977,-.9973569167005724,-.996992941167792,-.9966055319295779,-.9961946980917455,-.9957604493106914,-.9953027957931658,-.9948217482960331,-.9943173181260185,-.9937895171394426,-.993238357741943,-.9926638528881819,-.9920660160815424,-.9914448613738105,-.9908004033648453,-.9901326572022358,-.9894416385809446,-.9887273637429387,-.987989849476809,-.9872291131173742,-.986445172545274,-.9856380461865493,-.9848077530122081,-.9839543125377807,-.9830777448228601,-.9821780704706308,-.9812553106273846,-.9803094869820241,-.9793406217655515,-.9783487377505476,-.9773338582506355,-.9762960071199335,-.9752352087524931,-.9741514880817276,-.9730448705798239,-.9719153822571454,-.9707630496616201,-.969587899878116,-.968389960527806,-.9671692597675167,-.9659258262890684,-.9646596893185995,-.9633708786158806,-.9620594244736133,-.9607253577167206,-.9593687097016202,-.9579895123154889,-.9565877979755121,-.955163599628123,-.9537169507482268,-.9522478853384154,-.9507564379281668,-.949242643573034,-.9477065378538223,-.9461481568757506,-.944567537267605,-.9429647161808762,-.9413397312888874,-.9396926207859083,-.9380234233862579,-.936332178323393,-.9346189253489885,-.9328837047320004,-.9311265572577221,-.9293475242268224,-.9275466474543788,-.9257239692688904,-.9238795325112866,-.9220133805339186,-.9201255571995389,-.9182161068802742,-.9162850744565779,-.9143325053161796,-.9123584453530141,-.9103629409661469,-.9083460390586794,-.9063077870366503,-.9042482328079181,-.9021674247810376,-.9000654118641209,-.8979422434636882,-.895797969483505,-.8936326403234123,-.8914463068781384,-.8892390205361063,-.887010833178222,-.8847617971766579,-.8824919653936216,-.8802013911801113,-.8778901283746645,-.8755582313020907,-.8732057547721959,-.870832754078492,-.8684392849969007,-.8660254037844386,-.8635911671778989,-.8611366323925137,-.8586618571206134,-.8561668995302666,-.8536518182639167,-.8511166724369998,-.848561521636559,-.8459864259198413,-.8433914458128857,-.8407766423091034,-.8381420768678404,-.8354878114129367,-.8328139083312672,-.8301204304712791,-.8274074411415107,-.8246750041091067,-.8219231835983183,-.8191520442889918,-.8163616513150517,-.8135520702629676,-.8107233671702121,-.8078756085237113,-.8050088612582788,-.802123192755044,-.7992186708398701,-.796295363781756,-.7933533402912352,-.7903926695187591,-.7874134210530724,-.7844156649195756,-.7813994715786825,-.7783649119241599,-.7753120572814661,-.7722409794060691,-.7691517504817653,-.7660444431189781,-.7629191303530556,-.7597758856425495,-.7566147828674927,-.753435896327661,-.7502393007408246,-.7470250712409963,-.7437932833766612,-.740544013109005,-.7372773368101242,-.7339933312612357,-.7306920736508676,-.7273736415730492,-.7240381130254828,-.7206855664077145,-.7173160805192891,-.7139297345578991,-.7105266081175208,-.7071067811865477,-.7036703341459063,-.7002173477671687,-.6967479032106556,-.6932620820235246,-.6897599661378577,-.6862416378687334,-.6827071799122926,-.679156675343793,-.6755902076156605,-.6720078605555223,-.6684097183642427,-.6647958656139378,-.6611663872459935,-.6575213685690637,-.6538608952570701,-.6501850533471836,-.6464939292378064,-.6427876096865396,-.6390661818081416,-.6353297330724854,-.6315783513024976,-.627812124672099,-.624031141704127,-.6202354912682606,-.6164252625789255,-.6126005451932034,-.6087614290087209,-.6049080042615417,-.6010403615240425,-.5971585917027863,-.5932627860363818,-.589353036093345,-.585429433769941,-.5814920712880269,-.5775410411928856,-.5735764363510465,-.5695983499481065,-.5656068754865391,-.561602106783493,-.5575841379685926,-.5535530634817225,-.5495089780708059,-.5454519767895828,-.5413821549953696,-.5372996083468242,-.5332044328016913,-.5290967246145529,-.5249765803345603,-.5208440968031696,-.5166993711518632,-.5125425007998651,-.5083735834518559,-.5041927170956704,-.5000000000000004,-.49579553071207927,-.49157940805537115,-.48735173112724256,-.48311259929663913,-.4788621122017438,-.47460036974764036,-.4703274721039621,-.4660435197025389,-.46174861323503363,-.45744285365058096,-.4531263421534088,-.44879918020046244,-.4444614694990217,-.4401133120043052,-.43575480991708015,-.4313860656812539,-.42700718198147153,-.4226182617406992,-.4182194081178066,-.413810724505139,-.40939231452609287,-.40496428203267354,-.400526731103061,-.3960797660391569,-.39162349136413954,-.38715801182000076,-.3826834323650904,-.37819985817164276,-.3737073946233104,-.3692061473126848,-.36469622203881186,-.3601777248047109,-.3556507618148766,-.3511154394727894,-.34657186437840776,-.34202014332566943,-.3374603832999744,-.3328926914756765,-.32831717521356063,-.32373394205832107,-.31914309973603056,-.3145447561516138,-.3099390193863049,-.30532599769511337,-.30070579950427384,-.2960785334087003,-.29144430816943584,-.2868032327110907,-.28215541611928785,-.2775009676380955,-.2728399966674612,-.2681726127606372,-.2634989256216111,-.2588190451025207,-.2541330812010789,-.24944114405798135,-.24474334395432432,-.24003979130900607,-.23533059667613823,-.23061587074244044,-.2258957243246447,-.22117026836688813,-.21643961393810288,-.21170387222941123,-.2069631545515055,-.20221757233203852,-.19746723711299774,-.19271226054809037,-.1879527544001122,-.18318883053832655,-.17842060093583256,-.1736481776669304,-.16887167290449245,-.16409119891732413,-.15930686806752234,-.15451879280784075,-.14972708567904036,-.1449318593072471,-.14013322640130713,-.13533129975013158,-.13052619222005168,-.1257180167521624,-.12090688635966958,-.11609291412523004,-.11127621319829996,-.10645689679246818,-.10163507818280229,-.09681087070317913,-.09198438774362797,-.08715574274765832,-.08232504920960054,-.0774924206719312,-.07265797072261047,-.06782181299240972,-.06298406115223794,-.0581448289104763,-.05330423001029832,-.04846237822700354,-.043619387365336194,-.038775371256817404,-.03393044375706254,-.02908471874311221,-.02423831011074855,-.019391331771824397,-.014543897651582293,-.009696121685978531,-.004848117819001606]}}}),System.register("game/math/LineCurve",["game/math/Vector2"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends THREE.LineCurve{constructor(S,O){super(S||new B.Vector2,O||new B.Vector2)}getPoint(S,O){return super.getPoint(S,O||new B.Vector2)}},S("LineCurve",N)}}}),System.register("game/math/Matrix4",["game/math/GameMath","game/math/Vector3"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends THREE.Matrix4{extractRotation(S){let O=this.elements;var B=S.elements,N=1/L.setFromMatrixColumn(S,0).length(),j=1/L.setFromMatrixColumn(S,1).length(),D=1/L.setFromMatrixColumn(S,2).length();return O[0]=B[0]*N,O[1]=B[1]*N,O[2]=B[2]*N,O[3]=0,O[4]=B[4]*j,O[5]=B[5]*j,O[6]=B[6]*j,O[7]=0,O[8]=B[8]*D,O[9]=B[9]*D,O[10]=B[10]*D,O[11]=0,O[12]=0,O[13]=0,O[14]=0,O[15]=1,this}makeRotationFromEuler(S){S&&S.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");let O=this.elements;var N,j,L,D,F,_,U,H,V,W,z,K,$=S.x,q=S.y,Q=S.z,Z=B.GameMath.cos($),Y=B.GameMath.sin($),X=B.GameMath.cos(q);return $=B.GameMath.sin(q),q=B.GameMath.cos(Q),Q=B.GameMath.sin(Q),"XYZ"===S.order?(j=Z*q,D=Z*Q,L=Y*q,N=Y*Q,O[0]=X*q,O[4]=-X*Q,O[8]=$,O[1]=D+L*$,O[5]=j-N*$,O[9]=-Y*X,O[2]=N-j*$,O[6]=L+D*$,O[10]=Z*X):"YXZ"===S.order?(N=X*q,j=X*Q,L=$*q,D=$*Q,O[0]=N+D*Y,O[4]=L*Y-j,O[8]=Z*$,O[1]=Z*Q,O[5]=Z*q,O[9]=-Y,O[2]=j*Y-L,O[6]=D+N*Y,O[10]=Z*X):"ZXY"===S.order?(H=X*q,F=X*Q,_=$*q,U=$*Q,O[0]=H-U*Y,O[4]=-Z*Q,O[8]=_+F*Y,O[1]=F+_*Y,O[5]=Z*q,O[9]=U-H*Y,O[2]=-Z*$,O[6]=Y,O[10]=Z*X):"ZYX"===S.order?(F=Z*q,_=Z*Q,U=Y*q,H=Y*Q,O[0]=X*q,O[4]=U*$-_,O[8]=F*$+H,O[1]=X*Q,O[5]=H*$+F,O[9]=_*$-U,O[2]=-$,O[6]=Y*X,O[10]=Z*X):"YZX"===S.order?(z=Z*X,V=Z*$,W=Y*X,K=Y*$,O[0]=X*q,O[4]=K-z*Q,O[8]=W*Q+V,O[1]=Q,O[5]=Z*q,O[9]=-Y*q,O[2]=-$*q,O[6]=V*Q+W,O[10]=z-K*Q):"XZY"===S.order&&(V=Z*X,W=Z*$,z=Y*X,K=Y*$,O[0]=X*q,O[4]=-Q,O[8]=$*q,O[1]=V*Q+K,O[5]=Z*q,O[9]=W*Q-z,O[2]=z*Q-W,O[6]=Y*q,O[10]=K*Q+V),O[3]=0,O[7]=0,O[11]=0,O[12]=0,O[13]=0,O[14]=0,O[15]=1,this}lookAt(S,O,B){D.set(0,0,0),F.set(0,0,0),_.set(0,0,0);const N=this.elements;return _.subVectors(S,O),0===_.lengthSq()&&(_.z=1),_.normalize(),D.crossVectors(B,_),0===D.lengthSq()&&(1===Math.abs(B.z)?_.x+=1e-4:_.z+=1e-4,_.normalize(),D.crossVectors(B,_)),D.normalize(),F.crossVectors(_,D),N[0]=D.x,N[4]=F.x,N[8]=_.x,N[1]=D.y,N[5]=F.y,N[9]=_.y,N[2]=D.z,N[6]=F.z,N[10]=_.z,this}getMaxScaleOnAxis(){var S=(N=this.elements)[0]*N[0]+N[1]*N[1]+N[2]*N[2],O=N[4]*N[4]+N[5]*N[5]+N[6]*N[6],N=N[8]*N[8]+N[9]*N[9]+N[10]*N[10];return B.GameMath.sqrt(Math.max(S,O,N))}makeRotationX(S){var O=B.GameMath.cos(S),N=B.GameMath.sin(S);return this.set(1,0,0,0,0,O,-N,0,0,N,O,0,0,0,0,1),this}makeRotationY(S){var O=B.GameMath.cos(S),N=B.GameMath.sin(S);return this.set(O,0,N,0,0,1,0,0,-N,0,O,0,0,0,0,1),this}makeRotationZ(S){var O=B.GameMath.cos(S),N=B.GameMath.sin(S);return this.set(O,-N,0,0,N,O,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(S,O){var N=B.GameMath.cos(O),j=B.GameMath.sin(O),L=1-N,D=S.x,F=S.y,_=S.z,U=L*D,H=L*F;return this.set(U*D+N,U*F-j*_,U*_+j*F,0,U*F+j*_,H*F+N,H*_-j*D,0,U*_-j*F,H*_+j*D,L*_*_+N,0,0,0,0,1),this}decompose(S,O,B){var N=this.elements;let j=L.set(N[0],N[1],N[2]).length();var D=L.set(N[4],N[5],N[6]).length(),F=L.set(N[8],N[9],N[10]).length();this.determinant()<0&&(j=-j),S.x=N[12],S.y=N[13],S.z=N[14],U.copy(this);var _=1/j,H=1/D;return N=1/F,U.elements[0]*=_,U.elements[1]*=_,U.elements[2]*=_,U.elements[4]*=H,U.elements[5]*=H,U.elements[6]*=H,U.elements[8]*=N,U.elements[9]*=N,U.elements[10]*=N,O.setFromRotationMatrix(U),B.x=j,B.y=D,B.z=F,this}},S("Matrix4",j),L=new N.Vector3,D=new N.Vector3,F=new N.Vector3,_=new N.Vector3,U=new j}}}),System.register("game/math/QuadraticBezierCurve",["game/math/Vector2"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends THREE.QuadraticBezierCurve{constructor(S,O,N){super(S||new B.Vector2,O||new B.Vector2,N||new B.Vector2)}getPoint(S,O){return super.getPoint(S,O||new B.Vector2)}},S("QuadraticBezierCurve",N)}}}),System.register("game/math/Quaternion",["game/math/GameMath"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends THREE.Quaternion{setFromEuler(S,O){if(!S||!S.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var N=S.x,j=S.y,L=S.z,D=S.order,F=B.GameMath.cos(N/2),_=B.GameMath.cos(j/2),U=B.GameMath.cos(L/2);return N=B.GameMath.sin(N/2),j=B.GameMath.sin(j/2),L=B.GameMath.sin(L/2),"XYZ"===D?(this._x=N*_*U+F*j*L,this._y=F*j*U-N*_*L,this._z=F*_*L+N*j*U,this._w=F*_*U-N*j*L):"YXZ"===D?(this._x=N*_*U+F*j*L,this._y=F*j*U-N*_*L,this._z=F*_*L-N*j*U,this._w=F*_*U+N*j*L):"ZXY"===D?(this._x=N*_*U-F*j*L,this._y=F*j*U+N*_*L,this._z=F*_*L+N*j*U,this._w=F*_*U-N*j*L):"ZYX"===D?(this._x=N*_*U-F*j*L,this._y=F*j*U+N*_*L,this._z=F*_*L-N*j*U,this._w=F*_*U+N*j*L):"YZX"===D?(this._x=N*_*U+F*j*L,this._y=F*j*U+N*_*L,this._z=F*_*L-N*j*U,this._w=F*_*U-N*j*L):"XZY"===D&&(this._x=N*_*U-F*j*L,this._y=F*j*U-N*_*L,this._z=F*_*L+N*j*U,this._w=F*_*U+N*j*L),!1!==O&&this.onChangeCallback(),this}setFromAxisAngle(S,O){var N=O/2,j=B.GameMath.sin(N);return this._x=S.x*j,this._y=S.y*j,this._z=S.z*j,this._w=B.GameMath.cos(N),this.onChangeCallback(),this}setFromRotationMatrix(S){let O,N=S.elements,j=N[0],L=N[4],D=N[8],F=N[1],_=N[5],U=N[9],H=N[2],V=N[6],W=N[10],z=j+_+W;return 0<z?(O=.5/B.GameMath.sqrt(z+1),this._w=.25/O,this._x=(V-U)*O,this._y=(D-H)*O,this._z=(F-L)*O):_<j&&W<j?(O=2*B.GameMath.sqrt(1+j-_-W),this._w=(V-U)/O,this._x=.25*O,this._y=(L+F)/O,this._z=(D+H)/O):W<_?(O=2*B.GameMath.sqrt(1+_-j-W),this._w=(D-H)/O,this._x=(L+F)/O,this._y=.25*O,this._z=(U+V)/O):(O=2*B.GameMath.sqrt(1+W-j-_),this._w=(F-L)/O,this._x=(D+H)/O,this._y=(U+V)/O,this._z=.25*O),this.onChangeCallback(),this}length(){return B.GameMath.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}slerp(S,O){if(0===O)return this;if(1===O)return this.copy(S);var N=this._x,j=this._y,L=this._z,D=this._w;let F=D*S._w+N*S._x+j*S._y+L*S._z;if(F<0?(this._w=-S._w,this._x=-S._x,this._y=-S._y,this._z=-S._z,F=-F):this.copy(S),1<=F)return this._w=D,this._x=N,this._y=j,this._z=L,this;if((H=1-F*F)<=Number.EPSILON){var _=1-O;return this._w=_*D+O*this._w,this._x=_*N+O*this._x,this._y=_*j+O*this._y,this._z=_*L+O*this._z,this.normalize()}var U=B.GameMath.sqrt(H),H=(_=B.GameMath.atan2(U,F),B.GameMath.sin((1-O)*_)/U);return U=B.GameMath.sin(O*_)/U,this._w=D*H+this._w*U,this._x=N*H+this._x*U,this._y=j*H+this._y*U,this._z=L*H+this._z*U,this.onChangeCallback(),this}},S("Quaternion",N)}}}),System.register("game/math/Spherical",["util/math","game/math/GameMath"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends THREE.Spherical{setFromVector3(S){return this.radius=S.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=N.GameMath.atan2(S.x,S.z),this.phi=N.GameMath.acos(B.clamp(S.y/this.radius,-1,1))),this}},S("Spherical",j)}}}),System.register("game/math/Vector2",["game/math/GameMath"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends THREE.Vector2{length(){return B.GameMath.sqrt(this.x*this.x+this.y*this.y)}angle(){let S=B.GameMath.atan2(this.y,this.x);return S<0&&(S+=2*Math.PI),S}distanceTo(S){return B.GameMath.sqrt(this.distanceToSquared(S))}rotateAround(S,O){var N=B.GameMath.cos(O),j=B.GameMath.sin(O),L=this.x-S.x,D=this.y-S.y;return this.x=L*N-D*j+S.x,this.y=L*j+D*N+S.y,this}},S("Vector2",N)}}}),System.register("game/math/Vector3",["util/math","game/math/GameMath","game/math/Quaternion"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends THREE.Vector3{applyEuler(S){return S&&S.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(D.setFromEuler(S))}applyAxisAngle(S,O){return this.applyQuaternion(D.setFromAxisAngle(S,O))}length(){return N.GameMath.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}projectOnPlane(S){return F.copy(this).projectOnVector(S),this.sub(F)}reflect(S){return this.sub(F.copy(S).multiplyScalar(2*this.dot(S)))}angleTo(S){var O=this.dot(S)/N.GameMath.sqrt(this.lengthSq()*S.lengthSq());return N.GameMath.acos(B.clamp(O,-1,1))}distanceTo(S){return N.GameMath.sqrt(this.distanceToSquared(S))}setFromSpherical(S){var O=N.GameMath.sin(S.phi)*S.radius;return this.x=O*N.GameMath.sin(S.theta),this.y=N.GameMath.cos(S.phi)*S.radius,this.z=O*N.GameMath.cos(S.theta),this}setFromCylindrical(S){return this.x=S.radius*N.GameMath.sin(S.theta),this.y=S.y,this.z=S.radius*N.GameMath.cos(S.theta),this}},S("Vector3",L),D=new j.Quaternion,F=new L}}}),System.register("game/math/geometry",["util/math","game/math/GameMath","game/math/Matrix4","game/math/Quaternion","game/math/Vector2","game/math/Vector3"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z;function p(S){return S*THREE.Math.RAD2DEG}function m(S){return S*THREE.Math.DEG2RAD}function f(S){return Math.round(p(S.angle()))}function y(S,O){var j=p(2*N.GameMath.acos(Math.abs(B.clamp(S.dot(O),-1,1))));return Math.round(j)}function T(S,O=new L.Quaternion){return O.setFromRotationMatrix(U.lookAt(S,H,V))}return O&&O.id,S("radToDeg",p),S("degToRad",m),S("rotateVec2",function(S,O){var B=m(Math.floor(O));return S.rotateAround(_,B)}),S("angleDegFromVec2",f),S("angleDegBetweenVec2",function(S,O){var B=f(S),N=f(O);return Math.min((B-N+360)%360,(N-B+360)%360)}),S("angleDegBetweenVec3",function(S,O){return y(T(S,W),T(O,z))}),S("quaternionFromVec3",T),S("rotateVec3Towards",function(S,O,B){var N=S.length(),j=T(O,W),L=T(S,z);!function(S,O,B){var N=y(S,O);0!==N&&(N=Math.min(1,B/N),S.slerp(O,N))}(L,j,B),S.set(0,0,1).applyQuaternion(L).setLength(N)}),{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=new D.Vector2,U=new j.Matrix4,H=new F.Vector3(0,0,0),V=new F.Vector3(0,1,0),W=new L.Quaternion,z=new L.Quaternion}}}),System.register("game/order/AttackMoveOrder",["game/order/OrderType","engine/type/PointerType","game/gameobject/task/move/AttackMoveTask","game/order/OrderFeedbackType","game/type/MovementZone","game/order/AttackOrder","game/gameobject/task/PlantC4Task","game/gameobject/task/move/AttackMoveTargetTask","game/gameobject/task/move/MoveTask","game/gameobject/task/AttackTask","game/type/LocomotorType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S}],execute:function(){z=class extends F.AttackOrder{constructor(S,O){super(S),this.map=O,this.orderType=B.OrderType.AttackMove,this.targetOptional=!1,this.feedbackType=L.OrderFeedbackType.Move}getPointerType(S,O){if(this.isTargetted()){let B=super.getPointerType(S,O);return B!==N.PointerType.AttackRange&&B!==N.PointerType.AttackNoRange||(B=N.PointerType.AttackMove),B}let B=this.isAllowed();var j,L,F;return B&&(j=!!this.target.getBridge(),L=this.sourceObject.rules.speedType,F=this.sourceObject.isInfantry(),B=this.sourceObject.rules.movementZone===D.MovementZone.Fly||0<this.map.terrain.getPassableSpeed(this.target.tile,L,F,j)||!!this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)),S?B?N.PointerType.AttackMini:N.PointerType.NoActionMini:B?N.PointerType.AttackMove:N.PointerType.NoMove}isValid(){var S=this.sourceObject.isUnit()&&!!this.sourceObject.attackTrait&&!this.sourceObject.rules.preventAttackMove&&!(this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)&&!this.sourceObject.rules.moveToShroud)&&(!this.isTargetted()||super.isValid());return this.feedbackType=L.OrderFeedbackType.Move,S}isAllowed(){return!(!this.isTargetted()&&this.sourceObject.moveTrait.isDisabled())&&super.isAllowed()}process(){if(this.isTargetted()){if(this.isC4)return[new _.PlantC4Task(this.game,this.target.obj)];var S=this.sourceObject.attackTrait.selectWeaponVersus(this.sourceObject,this.target,this.game);return[new U.AttackMoveTargetTask(this.game,this.target,S)]}return[new j.AttackMoveTask(this.game,this.target.tile,!!this.target.getBridge(),{closeEnoughTiles:this.game.rules.general.closeEnough})]}isTargetted(){return this.target.obj?.isTechno()}onAdd(S,O){let B=this.sourceObject;if(!O&&B.isUnit()&&this.isValid()&&this.isAllowed())if(B.rules.movementZone===D.MovementZone.Fly){let O=S.find(S=>[H.MoveTask,V.AttackTask,j.AttackMoveTask,U.AttackMoveTargetTask].includes(S.constructor)&&!S.isCancelling());if(O)if(this.isTargetted())(B.moveTrait.currentWaypoint?.tile===this.target.tile||B.isAircraft()||O.constructor!==H.MoveTask)&&O.forceCancel(B)&&S.splice(S.indexOf(O));else{if(O.constructor===j.AttackMoveTask)return O.updateTarget(this.target.tile,!!this.target.getBridge()),S.splice(S.indexOf(O)+1),B.unitOrderTrait.clearOrders(),!1;O.forceCancel(B)&&S.splice(S.indexOf(O))}}else this.isTargetted()&&S.length&&B.isUnit()&&(B.rules.locomotor===W.LocomotorType.Vehicle||B.rules.locomotor===W.LocomotorType.Ship)&&(B.moveTrait.speedPenalty=.5);return!0}},S("AttackMoveOrder",z)}}}),System.register("game/order/AttackOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/AttackTask","game/gameobject/unit/RangeHelper","game/order/OrderFeedbackType","game/gameobject/unit/LosHelper","game/type/ArmorType","game/gameobject/task/PlantC4Task","game/gameobject/unit/ZoneType","game/gameobject/task/move/MoveTask","game/type/MovementZone","game/type/LocomotorType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S}],execute:function(){$=class extends B.Order{constructor(S,{forceAttack:O,noIvanBomb:B}={}){super(O?N.OrderType.ForceAttack:N.OrderType.Attack),this.game=S,this.isC4=!1,this.forceAttack=!!O,this.ivanBombAllowed=!B||!!O,this.targetOptional=!1,this.feedbackType=F.OrderFeedbackType.None,this.rangeHelper=new D.RangeHelper(this.game.map.tileOccupation),this.losHelper=new _.LosHelper(this.game.map.tiles,S.map.tileOccupation)}getPointerType(S,O){if(!this.isAllowed())return S?j.PointerType.NoActionMini:j.PointerType.NoAction;if(this.isC4)return j.PointerType.C4;var B=this.sourceObject.attackTrait?.selectWeaponVersus(this.sourceObject,this.target,this.game,this.forceAttack);return B?.rules.sabotageCursor?j.PointerType.C4:this.ivanBombAllowed&&this.sourceObject.rules.ivan&&B?.warhead.rules.ivanBomb?j.PointerType.Dynamite:B?.warhead.rules.bombDisarm?j.PointerType.DefuseBomb:B&&B.rules.damage<0?j.PointerType.RepairMove:(B=O.every(S=>{if(!S.attackTrait)return!0;var O=S.attackTrait.selectWeaponVersus(S,this.target,this.game,this.forceAttack);return!O||this.rangeHelper.isInWeaponRange(S,this.target.obj||this.target.tile,O,this.game.rules)&&this.losHelper.hasLineOfSight(S,this.target.obj||this.target.tile,O)}),S?j.PointerType.AttackMini:B?j.PointerType.AttackRange:j.PointerType.AttackNoRange)}isValid(){if(!this.sourceObject.attackTrait)return!1;if(this.forceAttack&&this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)&&!this.sourceObject.isBuilding())return!1;let S=this.target.obj;var O=this.game.map.getGroundObjectsOnTile(this.target.tile).find(S=>S.isTerrain());return this.terminal=!S&&!O,this.sourceObject.c4&&S?.isBuilding()&&S.c4ChargeTrait&&(this.forceAttack||!this.game.areFriendly(S,this.sourceObject)||S.cabHutTrait)?(this.isC4=!0,this.feedbackType=F.OrderFeedbackType.SpecialAttack,!0):(this.isC4=!1,this.feedbackType=F.OrderFeedbackType.Attack,!!this.game.isValidTarget(S)&&!(!S&&O?.rules.immune)&&!!(S||this.target.tile!==this.sourceObject.tile||this.sourceObject.isUnit()&&this.sourceObject.zone===V.ZoneType.Air)&&S!==this.sourceObject&&!!(O=this.sourceObject.attackTrait.selectWeaponVersus(this.sourceObject,this.target,this.game,this.forceAttack))&&!(!this.ivanBombAllowed&&O.warhead.rules.ivanBomb)&&!(S?.isBuilding()&&S.cabHutTrait&&!O.warhead.rules.ivanBomb&&!O.warhead.rules.bombDisarm)&&!!(this.sourceObject.isUnit()&&this.sourceObject.moveTrait&&!this.sourceObject.moveTrait.isDisabled()||this.rangeHelper.isInWeaponRange(this.sourceObject,S||this.target.tile,O,this.game.rules))&&!(this.sourceObject.airSpawnTrait&&O.rules.spawner&&!this.game.map.isWithinBounds(this.target.tile))&&(!!this.forceAttack||(!S?.isBuilding()||!S.hospitalTrait)&&!(!S||!S.healthTrait)&&!S.isDestroyed&&!S.isCrashing&&(!(!S.isOverlay()||!(O.warhead.rules.wall||O.warhead.rules.wood&&S.rules.armor===U.ArmorType.Wood))||S.isTechno())))}isAllowed(){return!this.sourceObject.attackTrait.isDisabled()}process(){if(this.isC4)return[new H.PlantC4Task(this.game,this.target.obj)];var S=this.sourceObject.attackTrait.selectWeaponVersus(this.sourceObject,this.target,this.game,this.forceAttack);return[new L.AttackTask(this.game,this.target,S,{force:this.forceAttack})]}onAdd(S,O){let B=this.sourceObject;if(!O&&B.isUnit()&&this.isValid()&&this.isAllowed())if(B.rules.movementZone===z.MovementZone.Fly){let O=S.find(S=>(S.constructor===W.MoveTask||S.constructor===L.AttackTask)&&!S.isCancelling());O&&(B.moveTrait.currentWaypoint?.tile===this.target.tile||B.isAircraft()||O.constructor===L.AttackTask)&&O.forceCancel(B)&&S.splice(S.indexOf(O))}else{S.length&&B.isUnit()&&(B.rules.locomotor===K.LocomotorType.Vehicle||B.rules.locomotor===K.LocomotorType.Ship)&&(B.moveTrait.speedPenalty=.5);let O=S.find(S=>S.constructor===L.AttackTask&&!S.isCancelling());if(O?.getWeapon().warhead.rules.temporal)return O.setForceAttack(this.forceAttack),O.requestTargetUpdate(this.target),!1}return!0}},S("AttackOrder",$)}}}),System.register("game/order/CaptureOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/unit/RangeHelper","game/gameobject/task/CaptureBuildingTask","game/order/OrderFeedbackType"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class extends B.Order{constructor(S){super(N.OrderType.Capture),this.game=S,this.targetOptional=!1,this.terminal=!0,this.feedbackType=F.OrderFeedbackType.Capture}getPointerType(S){if(!this.isAllowed())return S?j.PointerType.NoActionMini:j.PointerType.NoOccupy;if(S)return j.PointerType.OccupyMini;if(this.game.gameOpts.multiEngineer){var O=this.game.rules.general,B=this.target.obj;if((!B.owner.isNeutral||!O.engineerAlwaysCaptureTech)&&B.healthTrait.health>100*O.engineerCaptureLevel)return j.PointerType.EngineerDamage}return j.PointerType.Occupy}isValid(){return!(this.target.obj?.isDestroyed||!this.target.obj?.isBuilding()||!this.sourceObject.isInfantry())&&this.target.obj.rules.capturable&&this.sourceObject.rules.engineer&&!this.game.areFriendly(this.sourceObject,this.target.obj)}isAllowed(){return!0}process(){return[new D.CaptureBuildingTask(this.game,this.target.obj)]}onAdd(S,O){if(!O){let O=S.find(S=>S instanceof D.CaptureBuildingTask);if(this.isValid()&&this.isAllowed()&&O&&!O.isCancelling()&&O.target===this.target.obj&&new L.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},S("CaptureOrder",_)}}}),System.register("game/order/CheerOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/CheerTask","game/gameobject/infantry/StanceType"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends B.Order{constructor(){super(N.OrderType.Cheer),this.getPointerType=()=>j.PointerType.NoAction}isValid(){return this.sourceObject.isInfantry()&&[D.StanceType.None,D.StanceType.Guard].includes(this.sourceObject.stance)}isAllowed(){return!0}process(){return[new L.CheerTask]}},S("CheerOrder",F)}}}),System.register("game/order/DeployOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/morph/DeployIntoTask","game/gameobject/infantry/StanceType","game/gameobject/task/system/CallbackTask","game/event/UnitDeployUndeployEvent","game/event/PrimaryFactoryChangeEvent","game/gameobject/task/EvacuateTransportTask","game/type/SpeedType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){W=class extends B.Order{constructor(S,O){super(O?N.OrderType.Deploy:N.OrderType.DeploySelected),this.game=S,this.targeted=O,this.minimapAllowed=!1,this.getPointerType=()=>this.isAllowed()?j.PointerType.Deploy:j.PointerType.NoDeploy,this.targetOptional=!O,this.singleSelectionRequired=O}isValid(){if(this.targeted&&(!this.target.obj||this.target.obj!==this.sourceObject))return!1;let S=this.sourceObject;return!!(S.isInfantry()&&S.deployerTrait&&![D.StanceType.Cheer].includes(S.stance)||S.isVehicle()&&S.deployerTrait||S.isVehicle()&&S.rules.deploysInto||S.isVehicle()&&S.transportTrait||S.isBuilding()&&S.rules.factory&&!S.owner.production?.isPrimaryFactory(S)||S.isBuilding()&&S.garrisonTrait?.units.length)}isAllowed(){let S=this.sourceObject;if(S.isVehicle()&&S.transportTrait)return!!(S.transportTrait.units.length&&0<this.game.map.terrain.getPassableSpeed(S.tile,V.SpeedType.Foot,!1,S.onBridge));if((S.isInfantry()||S.isVehicle())&&S.deployerTrait)return!0;if(S.isVehicle()&&S.rules.deploysInto){if(S.parasiteableTrait?.isInfested()&&!S.parasiteableTrait.beingBoarded)return!1;let B=this.game.getConstructionWorker(S.owner);if(S.moveTrait.currentWaypoint?.onBridge)return!1;var O=S.moveTrait.currentWaypoint?.tile??S.tile;return B.canPlaceAt(S.rules.deploysInto,O,{ignoreObjects:[S],ignoreAdjacent:!0})}if(S.isBuilding()&&S.rules.factory)return!0;if(S.isBuilding()&&S.garrisonTrait?.units.length)return!0;throw new Error("Shouldn't reach this point. Missed a case.")}process(){const S=this.sourceObject;return S.isVehicle()&&S.transportTrait?[new H.EvacuateTransportTask(this.game,!0)]:S.isBuilding()&&S.rules.factory?void 0:S.isVehicle()&&S.rules.deploysInto?[new L.DeployIntoTask(this.game)]:(S.isInfantry()||S.isVehicle())&&S.deployerTrait?[new F.CallbackTask(()=>{S.deployerTrait.toggleDeployed(),this.game.events.dispatch(new _.UnitDeployUndeployEvent(S,S.deployerTrait.isDeployed()?"undeploy":"deploy"))})]:S.isBuilding()&&S.garrisonTrait?.units.length?[new F.CallbackTask(()=>{S.garrisonTrait.evacuate(this.game,!0)})]:void 0}onAdd(S,O){let B=this.sourceObject;if(B.isBuilding()&&B.rules.factory)return B.owner.production.setPrimaryFactory(B),this.game.events.dispatch(new U.PrimaryFactoryChangeEvent(B)),!1;if(B.isVehicle()&&B.transportTrait&&!O&&this.isValid()&&this.isAllowed()){let O=S.find(S=>S.constructor===H.EvacuateTransportTask&&!S.isCancelling());if(O)return O.forceEvac(),!1}return!0}},S("DeployOrder",W)}}}),System.register("game/order/DockOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/Building","game/gameobject/task/harvester/ReturnOreTask","game/order/OrderFeedbackType","game/gameobject/task/MoveToDockTask"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){U=class extends B.Order{constructor(S){super(N.OrderType.Dock),this.game=S,this.targetOptional=!1,this.feedbackType=F.OrderFeedbackType.Move}getPointerType(S){return S?this.isAllowed()?j.PointerType.OccupyMini:j.PointerType.NoActionMini:this.isAllowed()?j.PointerType.Occupy:j.PointerType.NoOccupy}isValid(){if(!this.target.obj?.isBuilding()||this.target.obj.isDestroyed||!this.target.obj.dockTrait||this.target.obj.buildStatus!==L.BuildStatus.Ready||!this.sourceObject.isUnit()||this.target.obj.warpedOutTrait.isActive())return!1;var S=!(this.target.obj.rules.refinery||this.target.obj.unitRepairTrait);return this.game.areFriendly(this.target.obj,this.sourceObject)&&this.target.obj.dockTrait.isValidUnitForDock(this.sourceObject)&&!this.target.obj.dockTrait.isDocked(this.sourceObject)&&!(this.target.obj.unitRepairTrait&&!this.sourceObject.rules.dock.includes(this.target.obj.name)&&100===this.sourceObject.healthTrait.health)&&(!S||0<(this.target.obj.dockTrait.getAvailableDockCount()??0)||this.target.obj.dockTrait.hasReservedDockForUnit(this.sourceObject))}isAllowed(){return!0}process(){var S=this.target.obj;return S.rules.refinery&&this.sourceObject.isVehicle()&&this.sourceObject.harvesterTrait?[new D.ReturnOreTask(this.game,S,!0,!0)]:S.unitRepairTrait||this.sourceObject.rules.dock.includes(S.name)?[new _.MoveToDockTask(this.game,S)]:[]}},S("DockOrder",U)}}}),System.register("game/order/EnterTransportOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/unit/RangeHelper","game/order/OrderFeedbackType","game/gameobject/task/EnterTransportTask","game/gameobject/unit/ZoneType","game/gameobject/trait/MoveTrait","game/gameobject/task/system/CallbackTask","game/gameobject/task/move/MoveTask"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){W=class extends B.Order{constructor(S){super(N.OrderType.EnterTransport),this.game=S,this.targetOptional=!1,this.terminal=!0,this.feedbackType=D.OrderFeedbackType.Enter}getPointerType(S){return S?this.isAllowed()?j.PointerType.OccupyMini:j.PointerType.NoActionMini:this.isAllowed()?j.PointerType.Occupy:j.PointerType.NoOccupy}isValid(){return!(!this.target.obj?.isVehicle()||!this.target.obj.transportTrait||this.target.obj.isDestroyed||this.target.obj===this.sourceObject||!this.game.areFriendly(this.target.obj,this.sourceObject)||!this.sourceObject.isVehicle()&&!this.sourceObject.isInfantry())}isAllowed(){let S=this.target.obj,O=this.sourceObject;return O.zone!==_.ZoneType.Air&&S.zone!==_.ZoneType.Air&&S.transportTrait.unitFitsInside(O)&&S.moveTrait.moveState===U.MoveState.Idle&&!S.warpedOutTrait.isActive()&&!O.mindControllableTrait?.isActive()&&!O.mindControllerTrait?.isActive()}process(){let S=this.sourceObject,O=this.target.obj;return this.game.map.terrain.getPassableSpeed(O.tile,S.rules.speedType,S.isInfantry(),S.onBridge)?[new F.EnterTransportTask(this.game,O)]:[new H.CallbackTask(()=>{O.unitOrderTrait.addTask(new V.MoveTask(this.game,S.tile,S.onBridge)),O.unitOrderTrait.addTask(new H.CallbackTask(()=>{this.game.map.terrain.getPassableSpeed(O.tile,S.rules.speedType,S.isInfantry(),S.onBridge)&&S.unitOrderTrait.addTask(new F.EnterTransportTask(this.game,O))}))})]}onAdd(S,O){if(!O){let O=S.find(S=>S instanceof F.EnterTransportTask);if(this.isValid()&&this.isAllowed()&&O&&!O.isCancelling()&&O.target===this.target.obj&&new L.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},S("EnterTransportOrder",W)}}}),System.register("game/order/GatherOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/harvester/GatherOreTask","game/order/OrderFeedbackType"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends B.Order{constructor(S){super(N.OrderType.Gather),this.game=S,this.targetOptional=!1,this.feedbackType=D.OrderFeedbackType.Move}getPointerType(S){return S?j.PointerType.AttackMini:j.PointerType.AttackNoRange}isValid(){return!(!this.sourceObject.isVehicle()||!this.sourceObject.harvesterTrait||this.sourceObject.moveTrait.isDisabled()||this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation))&&this.target.isOre}isAllowed(){return!0}process(){return[new L.GatherOreTask(this.game,this.target.tile,!0)]}},S("GatherOrder",F)}}}),System.register("game/order/GuardAreaOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/system/CallbackTask","game/gameobject/task/move/MoveTask","game/order/OrderFeedbackType","game/gameobject/trait/MoveTrait","game/gameobject/task/harvester/GatherOreTask"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){H=class extends B.Order{constructor(S,O){super(O?N.OrderType.GuardArea:N.OrderType.Guard),this.game=S,this.targeted=O,this.getPointerType=S=>S?this.isAllowed()?j.PointerType.GuardMini:j.PointerType.NoActionMini:this.isAllowed()?j.PointerType.Guard:j.PointerType.NoMove,this.terminal=!0,this.targetOptional=!O,this.minimapAllowed=O,this.feedbackType=O?F.OrderFeedbackType.Move:F.OrderFeedbackType.None}isValid(){return this.sourceObject.isUnit()&&(!!this.targetOptional||!this.sourceObject.moveTrait.isDisabled())&&!(this.target&&this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)&&!this.sourceObject.rules.moveToShroud)}isAllowed(){return!0}process(){let S=this.targeted?this.target.tile:void 0;const O=this.sourceObject;let B=[];return S&&B.push(new D.MoveTask(this.game,S,!!this.target.getBridge(),{closeEnoughTiles:this.game.rules.general.closeEnough})),O.isVehicle()&&O.harvesterTrait?B.push(new L.CallbackTask(()=>O.harvesterTrait.lastOreSite=void 0),new U.GatherOreTask(this.game,void 0,!0)):B.push(new L.CallbackTask(O=>{S&&![_.MoveResult.Success,_.MoveResult.CloseEnough].includes(this.sourceObject.moveTrait?.lastMoveResult)||(this.sourceObject.guardMode=!0)})),B}},S("GuardAreaOrder",H)}}}),System.register("game/order/MoveOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/morph/UndeployIntoTask","game/gameobject/task/move/MoveTask","game/order/OrderFeedbackType","game/event/RallyPointChangeEvent","game/type/MovementZone","game/type/SpeedType","game/gameobject/task/AttackTask","game/gameobject/Building","game/gameobject/task/WaitForBuildUpTask","game/gameobject/task/move/MoveToBlockTask","game/type/LandType","game/gameobject/task/move/AttackMoveTask","game/gameobject/task/move/AttackMoveTargetTask","game/gameobject/task/move/MoveTargetTask"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S}],execute:function(){Y=class extends B.Order{constructor(S,O,B,j=!1){super(j?N.OrderType.ForceMove:N.OrderType.Move),this.game=S,this.map=O,this.unitSelection=B,this.forceMove=j,this.targetOptional=!1,this.feedbackType=F.OrderFeedbackType.Move}getPointerType(S){let O=this.isAllowed();var B,N,L,D,F;return!O||this.forceMove||this.sourceObject.isBuilding()||this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)||(B=!!this.target.getBridge(),N=this.sourceObject.rules.speedType,L=this.sourceObject.isInfantry(),D=this.sourceObject.rules.movementZone===U.MovementZone.Fly,F=this.map.getObjectsOnTile(this.target.tile).some(S=>(S.isInfantry()||S.isVehicle())&&S.disguiseTrait?.hasTerrainDisguise()),O=D?this.sourceObject.rules.airportBound||this.target.tile.landType===$.LandType.Cliff||0<this.map.terrain.getPassableSpeed(this.target.tile,H.SpeedType.Amphibious,!1,B)&&!F:0<this.map.terrain.getPassableSpeed(this.target.tile,N,L,B)&&!F&&!(this.target.obj?.isTechno()&&!this.game.areFriendly(this.target.obj,this.sourceObject))),S?O?j.PointerType.MoveMini:j.PointerType.NoActionMini:O?j.PointerType.Move:j.PointerType.NoMove}isValid(){return!(this.sourceObject.isBuilding()&&(!this.sourceObject.rules.undeploysInto||this.sourceObject.rules.constructionYard&&!this.game.gameOpts.mcvRepacks)&&!this.sourceObject.rallyTrait?.getRallyPoint())&&(this.forceMove||!this.target.obj||(this.target.obj.isOverlay()||this.target.obj.isBuilding())&&this.target.obj.rules.wall||this.target.obj.isTechno()&&this.target.obj.owner===this.sourceObject.owner&&this.unitSelection.isSelected(this.target.obj)||(this.target.obj.isInfantry()||this.target.obj.isVehicle())&&!!this.target.obj.disguiseTrait?.hasTerrainDisguise()||this.target.obj.isTechno()&&!this.game.areFriendly(this.target.obj,this.sourceObject))}isAllowed(){return(!this.sourceObject.isUnit()||!this.sourceObject.moveTrait.isDisabled())&&(this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)?this.sourceObject.rules.moveToShroud:!(!this.forceMove&&this.target.obj?.isTechno()&&this.target.obj.owner===this.sourceObject.owner&&this.unitSelection.isSelected(this.target.obj)))}process(){const S=this.sourceObject;if(!S.isBuilding()||!S.rallyTrait?.getRallyPoint()){var O=this.game.rules.general.closeEnough;return S.isBuilding()&&S.rules.undeploysInto?[new L.UndeployIntoTask(this.game),new D.MoveTask(this.game,this.target.tile,!!this.target.getBridge(),{closeEnoughTiles:O,forceMove:this.forceMove})]:S.isUnit()?this.isEnemyBuildingBlock()?[new K.MoveToBlockTask(this.game,this.target.obj)]:this.isFollowMove()?[new Z.MoveTargetTask(this.game,this.target.obj)]:[new D.MoveTask(this.game,this.target.tile,!!this.target.getBridge(),{closeEnoughTiles:O,forceMove:this.forceMove})]:void 0}}isEnemyBuildingBlock(){return this.forceMove&&this.sourceObject.isVehicle()&&!this.sourceObject.rules.consideredAircraft&&this.target.obj?.isBuilding()&&!this.game.areFriendly(this.sourceObject,this.target.obj)}isFollowMove(){return this.forceMove&&this.target.obj?.isInfantry()&&this.sourceObject.isVehicle()&&!this.sourceObject.rules.consideredAircraft&&!this.target.obj.moveTrait.isIdle()}onAdd(S,O){var B=this.sourceObject.isBuilding()&&this.sourceObject.rules.undeploysInto;if(B&&this.sourceObject.buildStatus===W.BuildStatus.BuildUp)return this.sourceObject.unitOrderTrait.getTasks().find(S=>S instanceof z.WaitForBuildUpTask)?.setCancellable(!0),!0;if(!B&&this.sourceObject.isBuilding()&&this.sourceObject.rallyTrait?.getRallyPoint())return this.sourceObject.rallyTrait.changeRallyPoint(this.target.tile,this.sourceObject,this.game),this.game.events.dispatch(new _.RallyPointChangeEvent(this.sourceObject)),!1;if(!this.isEnemyBuildingBlock()&&!this.isFollowMove()&&!O&&this.isValid()&&this.isAllowed()){this.sourceObject.attackTrait?.cancelOpportunityFire();let O=S.find(S=>S.constructor===D.MoveTask&&!S.isCancelling());if(O)return O.setForceMove(this.forceMove),O.updateTarget(this.target.tile,!!this.target.getBridge()),O.children.length&&O.children[0]instanceof V.AttackTask&&O.children[0].cancel(),S.splice(S.indexOf(O)+1),this.sourceObject.unitOrderTrait.clearOrders(),!1;if(this.sourceObject.isUnit()&&this.sourceObject.rules.movementZone===U.MovementZone.Fly){let O=S.find(S=>[V.AttackTask,q.AttackMoveTask,Q.AttackMoveTargetTask].includes(S.constructor)&&!S.isCancelling());O&&O.forceCancel(this.sourceObject)&&S.splice(S.indexOf(O))}}return!0}},S("MoveOrder",Y)}}}),System.register("game/order/OccupyOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/GarrisonBuildingTask","game/gameobject/unit/RangeHelper","game/order/OrderFeedbackType","game/type/MovementZone","game/type/LocomotorType","game/gameobject/task/EnterRecyclerTask","game/gameobject/task/InfiltrateBuildingTask","game/gameobject/task/EnterHospitalTask"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S}],execute:function(){z=class extends B.Order{constructor(S){super(N.OrderType.Occupy),this.game=S,this.targetOptional=!1,this.terminal=!0,this.feedbackType=F.OrderFeedbackType.Capture}getPointerType(S){return S?this.isAllowed()?j.PointerType.OccupyMini:j.PointerType.NoActionMini:this.isAllowed()?j.PointerType.Occupy:j.PointerType.NoOccupy}isValid(){return!!(this.target.obj?.isSpawned&&this.target.obj?.isBuilding()&&this.sourceObject.isUnit())&&(!!this.isUnitRecycle(this.sourceObject,this.target.obj)||!!this.sourceObject.isInfantry()&&(this.target.obj.isBuilding()&&this.target.obj.hospitalTrait?this.game.areFriendly(this.sourceObject,this.target.obj)&&this.sourceObject.isInfantry():this.target.obj.garrisonTrait?this.target.obj.garrisonTrait.canBeOccupied()&&this.sourceObject.rules.occupier&&!(this.target.obj.garrisonTrait.units.length&&this.target.obj.garrisonTrait.units[0].owner!==this.sourceObject.owner)&&!this.sourceObject.mindControllableTrait?.isActive()&&!this.sourceObject.mindControllerTrait?.isActive():!(!this.target.obj.rules.spyable||!this.sourceObject.rules.infiltrate||this.game.areFriendly(this.sourceObject,this.target.obj))))}isUnitRecycle(S,O){return S.owner===O.owner&&(S.isInfantry()&&O.rules.cloning||O.rules.grinding)&&!S.rules.engineer}isAllowed(){var S=this.target.obj,O=this.sourceObject;return this.isUnitRecycle(O,S)?O.rules.movementZone!==_.MovementZone.Fly&&O.rules.locomotor!==U.LocomotorType.Chrono&&0<this.game.sellTrait.computeRefundValue(O):S.hospitalTrait?O.healthTrait.health<100&&O.rules.movementZone!==_.MovementZone.Fly:!S.garrisonTrait||S.garrisonTrait.units.length<S.rules.maxNumberOccupants}process(){var S=this.target.obj,O=this.sourceObject;return this.isUnitRecycle(O,S)?[new H.EnterRecyclerTask(this.game,S)]:S.hospitalTrait?[new W.EnterHospitalTask(this.game,S)]:S.garrisonTrait?[new L.GarrisonBuildingTask(this.game,S)]:[new V.InfiltrateBuildingTask(this.game,S)]}onAdd(S,O){if(!O){let O=S.find(S=>S instanceof L.GarrisonBuildingTask||S instanceof V.InfiltrateBuildingTask);if(this.isValid()&&this.isAllowed()&&O&&!O.isCancelling()&&O.target===this.target.obj&&new D.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},S("OccupyOrder",z)}}}),System.register("game/order/Order",["engine/type/PointerType","game/order/OrderFeedbackType"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("Order",class{constructor(S){this.orderType=S,this.targetOptional=!0,this.minimapAllowed=!0,this.singleSelectionRequired=!1,this.terminal=!1,this.feedbackType=N.OrderFeedbackType.None}getPointerType(S,O){return S?B.PointerType.Mini:B.PointerType.Default}set(S,O){return this.sourceObject=S,this.target=O,this}isValid(){return!0}isAllowed(){return!0}onAdd(S,O){return!0}})}}}),System.register("game/order/OrderFactory",["game/order/OrderType","game/order/DeployOrder","game/order/MoveOrder","game/order/OccupyOrder","game/order/AttackOrder","game/order/StopOrder","game/order/CheerOrder","game/order/DockOrder","game/order/GatherOrder","game/order/AttackMoveOrder","game/order/RepairOrder","game/order/GuardAreaOrder","game/order/ScatterOrder","game/order/EnterTransportOrder","game/order/CaptureOrder"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S}],execute:function(){S("OrderFactory",class{constructor(S,O){this.game=S,this.map=O}create(S,O){switch(S){case B.OrderType.Deploy:return new N.DeployOrder(this.game,!0);case B.OrderType.DeploySelected:return new N.DeployOrder(this.game,!1);case B.OrderType.ForceMove:return new j.MoveOrder(this.game,this.map,O,!0);case B.OrderType.Move:return new j.MoveOrder(this.game,this.map,O);case B.OrderType.ForceAttack:return new D.AttackOrder(this.game,{forceAttack:!0});case B.OrderType.Attack:return new D.AttackOrder(this.game,{noIvanBomb:!0});case B.OrderType.PlaceBomb:return new D.AttackOrder(this.game);case B.OrderType.AttackMove:return new V.AttackMoveOrder(this.game,this.map);case B.OrderType.Capture:return new q.CaptureOrder(this.game);case B.OrderType.Occupy:return new L.OccupyOrder(this.game);case B.OrderType.Stop:return new F.StopOrder(this.game);case B.OrderType.Cheer:return new _.CheerOrder;case B.OrderType.Dock:return new U.DockOrder(this.game);case B.OrderType.Gather:return new H.GatherOrder(this.game);case B.OrderType.Repair:return new W.RepairOrder(this.game);case B.OrderType.Guard:return new z.GuardAreaOrder(this.game,!1);case B.OrderType.GuardArea:return new z.GuardAreaOrder(this.game,!0);case B.OrderType.Scatter:return new K.ScatterOrder(this.game);case B.OrderType.EnterTransport:return new $.EnterTransportOrder(this.game);default:throw new Error("Unhandled order type "+B.OrderType[S])}}})}}}),System.register("game/order/OrderFeedbackType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("OrderFeedbackType",B={}))[O.None=0]="None",O[O.Move=1]="Move",O[O.Attack=2]="Attack",O[O.Enter=3]="Enter",O[O.Capture=4]="Capture",O[O.SpecialAttack=5]="SpecialAttack"}}}),System.register("game/order/OrderType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("OrderType",B={}))[O.Move=0]="Move",O[O.ForceMove=1]="ForceMove",O[O.Attack=2]="Attack",O[O.ForceAttack=3]="ForceAttack",O[O.AttackMove=4]="AttackMove",O[O.Guard=5]="Guard",O[O.GuardArea=6]="GuardArea",O[O.Capture=7]="Capture",O[O.Occupy=8]="Occupy",O[O.Deploy=9]="Deploy",O[O.DeploySelected=10]="DeploySelected",O[O.Stop=11]="Stop",O[O.Cheer=12]="Cheer",O[O.Dock=13]="Dock",O[O.Gather=14]="Gather",O[O.Repair=15]="Repair",O[O.Scatter=16]="Scatter",O[O.EnterTransport=17]="EnterTransport",O[O.PlaceBomb=18]="PlaceBomb"}}}),System.register("game/order/RepairOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/unit/RangeHelper","game/gameobject/task/RepairBuildingTask","game/order/OrderFeedbackType"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class extends B.Order{constructor(S){super(N.OrderType.Repair),this.game=S,this.targetOptional=!1,this.terminal=!0,this.feedbackType=F.OrderFeedbackType.Capture}getPointerType(S){return S?this.isAllowed()?j.PointerType.OccupyMini:j.PointerType.NoActionMini:this.isAllowed()?j.PointerType.RepairMove:j.PointerType.NoRepair}isValid(){return!!this.target.obj?.isBuilding()&&!this.target.obj.isDestroyed&&this.sourceObject.isInfantry()&&this.sourceObject.rules.engineer&&(!this.target.obj.owner.isCombatant()&&(!!this.target.obj.garrisonTrait||!!this.target.obj.cabHutTrait)||this.game.areFriendly(this.target.obj,this.sourceObject))}isAllowed(){let S=this.target.obj;return S.cabHutTrait?S.cabHutTrait.canRepairBridge():!!(S.rules.repairable&&S.healthTrait.health<100)}process(){var S=this.target.obj;return[new D.RepairBuildingTask(this.game,S)]}onAdd(S,O){if(!O){let O=S.find(S=>S instanceof D.RepairBuildingTask);if(this.isValid()&&this.isAllowed()&&O&&!O.isCancelling()&&O.target===this.target.obj&&new L.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},S("RepairOrder",_)}}}),System.register("game/order/ScatterOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/ScatterTask","game/type/MovementZone"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends B.Order{constructor(S){super(N.OrderType.Scatter),this.game=S,this.getPointerType=()=>j.PointerType.NoAction}isValid(){return(this.sourceObject.isInfantry()||this.sourceObject.isVehicle())&&this.sourceObject.rules.movementZone!==D.MovementZone.Fly&&!this.sourceObject.moveTrait.isDisabled()}isAllowed(){return!0}process(){if(!this.target)throw new Error("Target should be set for executing a scatter order. See OrderUnitsAction.");return[new L.ScatterTask(this.game,{tile:this.target.tile,toBridge:!!this.target.getBridge()})]}},S("ScatterOrder",F)}}}),System.register("game/order/StopOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/type/LocomotorType","game/gameobject/task/system/CallbackTask"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends B.Order{constructor(S){super(N.OrderType.Stop),this.game=S,this.getPointerType=()=>j.PointerType.NoAction}isValid(){return this.sourceObject.isTechno()}isAllowed(){return!0}process(){return[new D.CallbackTask(S=>{!S.isUnit()||S.rules.locomotor!==L.LocomotorType.Vehicle&&S.rules.locomotor!==L.LocomotorType.Ship||(S.moveTrait.speedPenalty=0)})]}onAdd(S,O){let B=this.sourceObject;return O||!S.length||!B.isUnit()||B.rules.locomotor!==L.LocomotorType.Vehicle&&B.rules.locomotor!==L.LocomotorType.Ship||(B.moveTrait.speedPenalty=.5),B.isBuilding()&&B.rallyTrait?.getRallyPoint()&&(B.unitRepairTrait?.resetRallyPoint(B,this.game),B.factoryTrait?.resetRallyPoint(B,this.game)),!0}},S("StopOrder",F)}}}),System.register("game/order/orderPriorities",["game/order/OrderType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("orderPriorities",[B.OrderType.Occupy,B.OrderType.Dock,B.OrderType.Attack,B.OrderType.Capture,B.OrderType.Repair,B.OrderType.EnterTransport,B.OrderType.PlaceBomb,B.OrderType.Deploy,B.OrderType.Gather])}}}),System.register("game/player/PlayerFactory",["game/Player","game/Country","game/player/trait/PowerTrait","game/player/trait/RadarTrait","game/player/production/Production","game/SideType","game/player/trait/SuperWeaponsTrait","game/player/trait/SharedDetectDisguiseTrait"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){S("PlayerFactory",class{constructor(S,O,B){this.rules=S,this.gameOpts=O,this.allAvailableObjects=B}createCombatant(S,O,N,F,H,V){let W=new B.Player(S,O,N,F);return W.isAi=H,W.aiDifficulty=V,W.powerTrait=new j.PowerTrait(W),W.traits.add(W.powerTrait),W.radarTrait=new L.RadarTrait,W.traits.add(W.radarTrait),W.superWeaponsTrait=new _.SuperWeaponsTrait,W.traits.add(W.superWeaponsTrait),W.production=D.Production.factory(W,this.rules,this.gameOpts,this.allAvailableObjects),W.sharedDetectDisguiseTrait=new U.SharedDetectDisguiseTrait,W}createObserver(S,O){let N=new B.Player(S,void 0,void 0,O.colors.get("LightGrey"));return N.radarTrait=new L.RadarTrait,N.traits.add(N.radarTrait),N.radarTrait.setDisabled(!1),N}createNeutral(S,O){var L=[...S.countryRules.values()].find(S=>S.side===F.SideType.Civilian);if(!L)throw new Error("Missing neutral country. No country found in rules with Civilian side");L=new N.Country(L);let D=new B.Player(O,L,void 0,S.colors.get("LightGrey"));return D.powerTrait=new j.PowerTrait(D),D.traits.add(D.powerTrait),D}})}}}),System.register("game/player/production/Production",["game/player/production/ProductionQueue","game/rules/TechnoRules","engine/type/ObjectType","util/event","game/rules/GeneralRules","game/SideType"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=(new Map).set("POWER",D.PrereqCategory.Power).set("FACTORY",D.PrereqCategory.Factory).set("BARRACKS",D.PrereqCategory.Barracks).set("RADAR",D.PrereqCategory.Radar).set("TECH",D.PrereqCategory.Tech).set("PROC",D.PrereqCategory.Proc),S("Production",class e{static factory(S,O,N,j){let L=new e(S,O.mpDialogSettings.techLevel,N,O,j);var D=O.general.maximumQueuedObjects+1;return L.addQueue(B.QueueType.Structures,new B.ProductionQueue(B.QueueType.Structures,1,1)),L.addQueue(B.QueueType.Armory,new B.ProductionQueue(B.QueueType.Armory,1,1)),L.addQueue(B.QueueType.Infantry,new B.ProductionQueue(B.QueueType.Infantry,D,D)),L.addQueue(B.QueueType.Vehicles,new B.ProductionQueue(B.QueueType.Vehicles,D,D)),L.addQueue(B.QueueType.Ships,new B.ProductionQueue(B.QueueType.Ships,D,D)),L.addQueue(B.QueueType.Aircrafts,new B.ProductionQueue(B.QueueType.Aircrafts,0,D)),L}constructor(S,O,B,N,j){this.player=S,this.maxTechLevel=O,this.gameOpts=B,this.rules=N,this.allAvailableObjects=j,this.buildSpeedModifier=1,this.queues=new Map,this._onQueueUpdate=new L.EventDispatcher,this.primaryFactories=new Map,this.factoryCounts=new Map,this.veteranTypes=new Set,this.stolenTech=new Set}get onQueueUpdate(){return this._onQueueUpdate.asEvent()}addQueue(S,O){this.queues.set(S,O),O.onUpdate.subscribe(()=>this._onQueueUpdate.dispatch(this,O))}getQueue(S){var O=this.queues.get(S);if(!O)throw new Error("No queue found with type "+B.QueueType[S]);return O}getAllQueues(){return[...this.queues.values()]}getQueueTypeForObject(S){if(S.type===j.ObjectType.Building)return S.buildCat===N.BuildCat.Combat?B.QueueType.Armory:B.QueueType.Structures;if(S.type===j.ObjectType.Infantry)return B.QueueType.Infantry;if(S.type===j.ObjectType.Vehicle)return S.naval?B.QueueType.Ships:B.QueueType.Vehicles;if(S.type===j.ObjectType.Aircraft)return B.QueueType.Aircrafts;throw new Error("Unsupported object type "+j.ObjectType[S.type])}getQueueForObject(S){return this.getQueue(this.getQueueTypeForObject(S))}getQueueTypeForFactory(S){if(S===N.FactoryType.InfantryType)return B.QueueType.Infantry;if(S===N.FactoryType.UnitType)return B.QueueType.Vehicles;if(S===N.FactoryType.AircraftType)return B.QueueType.Aircrafts;if(S===N.FactoryType.NavalUnitType)return B.QueueType.Ships;throw new Error("Unsupported factory type "+N.FactoryType[S])}getFactoryTypeForQueueType(S){if(S===B.QueueType.Structures||S===B.QueueType.Armory)return N.FactoryType.BuildingType;if(S===B.QueueType.Infantry)return N.FactoryType.InfantryType;if(S===B.QueueType.Vehicles)return N.FactoryType.UnitType;if(S===B.QueueType.Aircrafts)return N.FactoryType.AircraftType;if(S===B.QueueType.Ships)return N.FactoryType.NavalUnitType;throw new Error("Unsupported queue type "+B.QueueType[S])}getQueueForFactory(S){return this.getQueue(this.getQueueTypeForFactory(S))}isAvailableForProduction(S){return-1!==S.techLevel&&S.techLevel<=this.maxTechLevel&&!(0===S.buildLimit&&!this.player.isAi)&&!(S.superWeapon&&this.rules.getSuperWeapon(S.superWeapon).disableableFromShell&&!this.gameOpts.superWeapons)&&this.hasFactoryFor(S)&&this.meetsPrerequisites(S)}getAvailableObjects(){return this.allAvailableObjects.filter(S=>this.isAvailableForProduction(S))}hasFactoryFor(S){if(S.owner.length){let O=this.getFactoryTypeFor(S);return!![...this.player.buildings].find(B=>B.factoryTrait?.type===O&&(O!==N.FactoryType.UnitType||B.rules.naval===S.naval)&&!!B.rules.owner.find(O=>S.owner.includes(O)))}return!0}meetsStolenTech(S){return S.requiresStolenAlliedTech?this.stolenTech.has(F.SideType.GDI):!S.requiresStolenSovietTech||this.stolenTech.has(F.SideType.Nod)}getFactoryTypeFor(S){return S.type===j.ObjectType.Building?N.FactoryType.BuildingType:S.type===j.ObjectType.Infantry?N.FactoryType.InfantryType:S.type===j.ObjectType.Aircraft?N.FactoryType.AircraftType:S.naval?N.FactoryType.NavalUnitType:N.FactoryType.UnitType}meetsPrerequisites(S){let O=[...this.player.buildings].map(S=>S.name);for(var B of S.prerequisiteOverride)if(B=B.toUpperCase(),O.includes(B))return!0;if(!S.isAvailableTo(this.player.country))return!1;var N;for(N of S.prerequisite)if(N=N.toUpperCase(),_.has(N)){var j=_.get(N);if(void 0===j)throw new Error("Unknown prereqName "+N);var L,D=this.rules.general.prereqCategories.get(j);if(void 0===D)throw new Error(`Missing prerequisite category ${j} in rules`);let S=!1;for(L of D)if(-1!==O.indexOf(L)){S=!0;break}if(!S)return!1}else if(-1===O.indexOf(N))return!1;return!!this.meetsStolenTech(S)}getPrimaryFactory(S){return this.primaryFactories.get(S)}setPrimaryFactory(S){S.rules.factory&&this.primaryFactories.set(S.rules.factory,S)}isPrimaryFactory(S){return this.getPrimaryFactory(S.rules.factory)===S}incrementFactoryCount(S){this.factoryCounts.set(S,(this.factoryCounts.get(S)??0)+1)}decrementFactoryCount(S){if(!this.factoryCounts.get(S))throw new Error(`Can't decrement factory count ${N.FactoryType[S]}. Already 0`);this.factoryCounts.set(S,this.factoryCounts.get(S)-1)}getFactoryCount(S){return this.factoryCounts.get(S)??0}crownPrimaryFactoryHeir(S){var O=[...this.player.buildings].find(O=>O.rules.factory===S);O?this.primaryFactories.set(S,O):this.primaryFactories.delete(S)}hasAnyFactory(){return 0<this.primaryFactories.size}addVeteranType(S){this.veteranTypes.add(S)}hasVeteranType(S){return this.veteranTypes.has(S)}addStolenTech(S){this.stolenTech.add(S)}dispose(){this.queues.clear(),this.player=void 0}})}}}),System.register("game/player/production/ProductionQueue",["util/event"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S}],execute:function(){var O;(O=N||S("QueueType",N={}))[O.Structures=0]="Structures",O[O.Armory=1]="Armory",O[O.Infantry=2]="Infantry",O[O.Vehicles=3]="Vehicles",O[O.Aircrafts=4]="Aircrafts",O[O.Ships=5]="Ships",(O=j||S("QueueStatus",j={}))[O.Idle=0]="Idle",O[O.Active=1]="Active",O[O.OnHold=2]="OnHold",O[O.Ready=3]="Ready",S("ProductionQueue",class{get onUpdate(){return this._onUpdate.asEvent()}constructor(S,O,N){this.type=S,this._maxSize=O,this.maxItemQuantity=N,this.items=[],this.size=0,this._status=j.Idle,this._onUpdate=new B.EventDispatcher}get status(){return this._status}set status(S){var O=this._status;(this._status=S)!==O&&this._onUpdate.dispatch(this)}get maxSize(){return this._maxSize}set maxSize(S){var O=this.size;this.size=Math.min(S,this.size);let B=0,N=0;for(;B<=this.size&&N<this.items.length;){let S=this.items[N];B+=S.quantity,B>this.size&&(S.quantity-=B-this.size),0<S.quantity&&N++}this._maxSize=S,this.items[N]&&this.items.splice(N),O!==this.size&&(this.size||(this._status=j.Idle),this._onUpdate.dispatch(this))}get currentSize(){return this.size}find(S){return this.items.filter(O=>O.rules===S)}getFirst(){return this.items[0]}getAll(){return[...this.items]}push(S,O,B){O=Math.min(this.maxSize-this.size,O);var N=this.find(S).reduce((S,O)=>S+O.quantity,0);O=Math.min(this.maxItemQuantity-N,O),this.items[this.items.length-1]?.rules===S?this.items[this.items.length-1].quantity+=O:this.items.push({rules:S,quantity:O,creditsEach:B,creditsSpent:0,creditsSpentLeftover:0,progress:0}),this.size+=O,O&&(this._status===j.Idle&&(this._status=j.Active),this._onUpdate.dispatch(this))}pop(S,O){this.remove(S,O,!1)}shift(S,O){this.remove(S,O,!0)}remove(S,O,B){let L=this.find(S);if(!L.length)throw new Error(`Can't remove non-existent item ${S.name} from queue `+N[this.type]);var D;if(L.reduce((S,O)=>S+O.quantity,0)<O)throw new Error(`Attempted to remove a quantity larger than the one in queue (${S.name})`);let F=O;for(;0<F;){let S=B?L.shift():L.pop();S.quantity<=F?(D=this.getFirst()===S,this.items.splice(this.items.indexOf(S),1),D&&(this._status=j.Active),F-=S.quantity):(S.quantity-=F,F=0)}this.size-=O,O&&(this.size||(this._status=j.Idle),this._onUpdate.dispatch(this))}notifyUpdated(){this._onUpdate.dispatch(this)}})}}}),System.register("game/player/trait/PowerTrait",["game/event/PowerLowEvent","game/event/PowerRestoreEvent","game/event/PowerChangeEvent","game/trait/interface/NotifyPower","util/math"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){var O;(O=F||S("PowerLevel",F={}))[O.Low=0]="Low",O[O.Normal=1]="Normal",S("PowerTrait",class{constructor(S){this.player=S,this.power=0,this.drain=0,this.level=F.Normal,this.blackoutFrames=0,this.powerByObject=new Map}isLowPower(){return this.level===F.Low}setBlackoutFor(S,O){var B=0<this.blackoutFrames;this.blackoutFrames=S,B||this.updateLevel(O)}updateBlackout(S){0<this.blackoutFrames&&(this.blackoutFrames--,this.blackoutFrames<=0&&this.updateLevel(S))}getBlackoutDuration(){return this.blackoutFrames}updateFrom(S,O,B){var N=S.rules.power;if(N){if(N<0)"add"!==O&&"remove"!==O||(this.drain+="add"===O?-N:N);else{let B=0;if("add"===O){var D=Math.ceil(N*S.healthTrait.health/100);this.powerByObject.set(S,D),B=D}else if("update"===O||"remove"===O){if(void 0===(D=this.powerByObject.get(S)))throw new Error("Cannot update power before add.");B="update"===O?(N=Math.ceil(N*S.healthTrait.health/100),this.powerByObject.set(S,N),N-D):(this.powerByObject.delete(S),-D)}this.power+=B}this.updateLevel(B),B.traits.filter(L.NotifyPower).forEach(S=>{S[L.NotifyPower.onPowerChange](this.player,B)}),B.events.dispatch(new j.PowerChangeEvent(this.player,this.power,this.drain))}}updateLevel(S){var O=this.level;this.level=this.power>=this.drain&&!this.blackoutFrames?F.Normal:F.Low,this.level!==O&&(O===F.Normal&&this.level===F.Low&&(S.traits.filter(L.NotifyPower).forEach(O=>{O[L.NotifyPower.onPowerLow](this.player,S)}),S.events.dispatch(new B.PowerLowEvent(this.player))),O===F.Low&&this.level===F.Normal&&(S.traits.filter(L.NotifyPower).forEach(O=>{O[L.NotifyPower.onPowerRestore](this.player,S)}),S.events.dispatch(new N.PowerRestoreEvent(this.player))))}getHash(){return D.fnv32a([this.power,this.drain])}debugGetState(){return{power:this.power,drain:this.drain}}dispose(){this.player=void 0,this.powerByObject.clear()}})}}}),System.register("game/player/trait/RadarTrait",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("RadarTrait",class{constructor(){this.disabled=!0,this.activeEvents=[]}isDisabled(){return this.disabled}setDisabled(S){this.disabled=S}})}}}),System.register("game/player/trait/SharedDetectDisguiseTrait",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("SharedDetectDisguiseTrait",class{constructor(){this.objects=new Set}add(S){this.objects.add(S)}delete(S){this.objects.delete(S)}has(S){return this.objects.has(S)}dispose(){this.objects.clear()}})}}}),System.register("game/player/trait/SuperWeaponsTrait",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("SuperWeaponsTrait",class{constructor(){this.superWeapons=new Map}getAll(){return[...this.superWeapons.values()]}add(S){this.superWeapons.set(S.name,S)}has(S){return this.superWeapons.has(S)}get(S){return this.superWeapons.get(S)}remove(S){this.superWeapons.delete(S)}})}}}),System.register("game/rules/AiRules",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("AiRules",class{readIni(S){this.buildPower=S.getArray("BuildPower"),this.buildRefinery=S.getArray("BuildRefinery"),this.buildTech=S.getArray("BuildTech"),this.tiberiumFarScan=S.getNumber("TiberiumFarScan",50),this.tiberiumNearScan=S.getNumber("TiberiumNearScan",5)}})}}}),System.register("game/rules/AudioVisualRules",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("AudioVisualRules",class{readIni(S){this.ini=S,this.ambientChangeRate=S.getNumber("AmbientChangeRate"),this.ambientChangeStep=S.getNumber("AmbientChangeStep"),this.behind=S.getString("Behind"),this.bridgeExplosions=S.getArray("BridgeExplosions"),this.chronoBeamColor=S.getNumberArray("ChronoBeamColor"),this.chronoBlast=S.getString("ChronoBlast"),this.chronoBlastDest=S.getString("ChronoBlastDest"),this.chronoPlacement=S.getString("ChronoPlacement"),this.chronoSparkle1=S.getString("ChronoSparkle1"),this.conditionRed=S.getNumber("ConditionRed"),this.conditionYellow=S.getNumber("ConditionYellow"),this.creditTicks=S.getArray("CreditTicks"),this.extraAircraftLight=S.getNumber("ExtraAircraftLight"),this.extraInfantryLight=S.getNumber("ExtraInfantryLight"),this.extraUnitLight=S.getNumber("ExtraUnitLight");let O=S.getString("DamageFireTypes");O=O||"FIRE01,FIRE02,FIRE03",this.fireNames=O.split(/\.|,/).filter(S=>""!==S),this.flyerHelper=S.getString("FlyerHelper"),this.gravity=S.getNumber("Gravity"),this.idleActionFrequency=60*S.getNumber("IdleActionFrequency"),this.impactLandSound=S.getString("ImpactLandSound")||void 0,this.impactWaterSound=S.getString("ImpactWaterSound")||void 0,this.infantryExplode=S.getString("InfantryExplode"),this.flamingInfantry=S.getString("FlamingInfantry"),this.infantryHeadPop=S.getString("InfantryHeadPop"),this.infantryNuked=S.getString("InfantryNuked"),this.ironCurtainInvokeAnim=S.getString("IronCurtainInvokeAnim"),this.messageDuration=S.getNumber("MessageDuration",10),this.metallicDebris=S.getArray("MetallicDebris"),this.nukeTakeOff=S.getString("NukeTakeOff"),this.deadBodies=S.getArray("DeadBodies"),this.wake=S.getString("Wake"),this.parachute=S.getString("Parachute"),this.moveFlash=S.getString("MoveFlash"),this.warpOut=S.getString("WarpOut"),this.warpAway=S.getString("WarpAway"),this.weaponNullifyAnim=S.getString("WeaponNullifyAnim"),this.weatherConClouds=S.getArray("WeatherConClouds"),this.weatherConBoltExplosion=S.getString("WeatherConBoltExplosion"),this.weatherConBolts=S.getArray("WeatherConBolts")}})}}}),System.register("game/rules/CombatDamageRules",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("CombatDamageRules",class{readIni(S){this.ballisticScatter=S.getNumber("BallisticScatter"),this.bridgeStrength=S.getNumber("BridgeStrength"),this.c4Delay=S.getNumber("C4Delay"),this.c4Warhead=S.getString("C4Warhead"),this.deathWeapon=S.getString("DeathWeapon"),this.dMislEliteWarhead=S.getString("DMislEliteWarhead"),this.dMislWarhead=S.getString("DMislWarhead"),this.flameDamage=S.getString("FlameDamage"),this.ironCurtainDuration=S.getNumber("IronCurtainDuration"),this.ivanDamage=S.getNumber("IvanDamage"),this.ivanIconFlickerRate=S.getNumber("IvanIconFlickerRate"),this.ivanTimedDelay=S.getNumber("IvanTimedDelay"),this.ivanWarhead=S.getString("IvanWarhead"),this.splashList=S.getArray("SplashList"),this.v3EliteWarhead=S.getString("V3EliteWarhead"),this.v3Warhead=S.getString("V3Warhead")}})}}}),System.register("game/rules/CountryRules",["game/SideType"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=(new Map).set("GDI",B.SideType.GDI).set("Nod",B.SideType.Nod).set("Civilian",B.SideType.Civilian).set("Mutant",B.SideType.Mutant),j=new Map([["Americans","STT:PlayerSideAmerica"],["Alliance","STT:PlayerSideKorea"],["French","STT:PlayerSideFrance"],["Germans","STT:PlayerSideGermany"],["British","STT:PlayerSideBritain"],["Africans","STT:PlayerSideLibya"],["Arabs","STT:PlayerSideIraq"],["Confederation","STT:PlayerSideCuba"],["Russians","STT:PlayerSideRussia"]]),S("CountryRules",class{constructor(S){this.id=S}readIni(S){this.name=S.name,this.uiName=S.getString("UIName"),this.uiTooltip=S.getString("UITooltip")||j.get(this.name);var O=S.getString("Side");if(!O)throw new Error(`Missing Side for country "${this.name}"`);var B=N.get(O);if(void 0===B)throw new Error(`Unknown side "${O}" for country "${this.name}"`);this.side=B,this.multiplay=S.getBool("Multiplay"),this.multiplayPassive=S.getBool("MultiplayPassive"),this.veteranAircraft=S.getArray("VeteranAircraft"),this.veteranInfantry=S.getArray("VeteranInfantry"),this.veteranUnits=S.getArray("VeteranUnits")}})}}}),System.register("game/rules/CrateRules",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("CrateRules",class{readIni(S){this.crateMaximum=S.getNumber("CrateMaximum"),this.crateMinimum=S.getNumber("CrateMinimum"),this.crateRadius=S.getNumber("CrateRadius"),this.crateRegen=S.getNumber("CrateRegen");let O=S.getString("UnitCrateType");return this.unitCrateType="none"!==O.toLowerCase()?O:void 0,this.healCrateSound=S.getString("HealCrateSound"),this.crateImg=S.getString("CrateImg"),this.waterCrateImg=S.getString("WaterCrateImg"),this.freeMCV=S.getBool("FreeMCV"),this}})}}}),System.register("game/rules/DebrisRules",["util/math","game/rules/ObjectRules"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.ObjectRules{parse(){super.parse(),this.damage=this.ini.getNumber("Damage"),this.damageRadius=this.ini.getNumber("DamageRadius"),this.duration=this.ini.getNumber("Duration"),this.elasticity=B.clamp(this.ini.getNumber("Elasticity",.75),0,1),this.expireAnim=this.ini.getString("ExpireAnim")||void 0,this.minAngularVelocity=this.ini.getNumber("MinAngularVelocity"),this.maxAngularVelocity=this.ini.getNumber("MaxAngularVelocity"),this.maxXYVel=this.ini.getNumber("MaxXYVel"),this.minZVel=this.ini.getNumber("MinZVel"),this.maxZVel=this.ini.getNumber("MaxZVel"),this.shareTurretData=this.ini.getBool("ShareTurretData"),this.shareBodyData=this.ini.getBool("ShareBodyData"),this.shareBarrelData=this.ini.getBool("ShareBarrelData"),this.shareSource=this.ini.getString("ShareSource")||void 0,this.trailerAnim=this.ini.getString("TrailerAnim")||void 0,this.trailerSeparation=this.ini.getNumber("TrailerSeperation"),this.warhead=this.ini.getString("Warhead")||void 0}},S("DebrisRules",j)}}}),System.register("game/rules/ElevationModelRules",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("ElevationModelRules",class{readIni(S){return this.increment=S.getNumber("ElevationIncrement"),this.incrementBonus=S.getNumber("ElevationIncrementBonus",1),this.bonusCap=S.getNumber("ElevationBonusCap"),this}getBonus(S,O){return S<=O?0:Math.min(this.bonusCap,Math.floor((S-O)/this.increment))*this.incrementBonus}})}}}),System.register("game/rules/GeneralRules",["game/rules/general/RadarRules","game/rules/general/RepairRules","game/rules/general/VeteranRules","game/rules/general/CrewRules","game/rules/general/PrismRules","game/rules/general/ThreatRules","game/rules/general/ParadropRules","game/rules/general/LightningStormRules","game/rules/general/V3RocketRules","game/rules/general/DMislRules","game/rules/general/HoverRules","util/math"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S}],execute:function(){var O;(O=K||S("PrereqCategory",K={}))[O.Power=0]="Power",O[O.Factory=1]="Factory",O[O.Barracks=2]="Barracks",O[O.Radar=3]="Radar",O[O.Tech=4]="Tech",O[O.Proc=5]="Proc",$=(new Map).set(K.Power,"PrerequisitePower").set(K.Factory,"PrerequisiteFactory").set(K.Barracks,"PrerequisiteBarracks").set(K.Radar,"PrerequisiteRadar").set(K.Tech,"PrerequisiteTech").set(K.Proc,"PrerequisiteProc"),S("GeneralRules",class{constructor(){this.prereqCategories=new Map}readIni(S){this.aircraftFogReveal=S.getNumber("AircraftFogReveal"),this.alliedDisguise=S.getString("AlliedDisguise"),this.baseUnit=S.getArray("BaseUnit"),this.bridgeVoxelMax=S.getNumber("BridgeVoxelMax"),this.buildSpeed=S.getFixed("BuildSpeed"),this.buildupTime=S.getNumber("BuildupTime"),this.chronoDelay=S.getNumber("ChronoDelay"),this.chronoDistanceFactor=S.getNumber("ChronoDistanceFactor",32),this.chronoHarvTooFarDistance=S.getNumber("ChronoHarvTooFarDistance"),this.chronoMinimumDelay=S.getNumber("ChronoMinimumDelay"),this.chronoRangeMinimum=S.getNumber("ChronoRangeMinimum"),this.chronoTrigger=S.getBool("ChronoTrigger",!0),this.cliffBackImpassability=S.getNumber("CliffBackImpassability",2),this.cloakDelay=S.getNumber("CloakDelay"),this.closeEnough=S.getNumber("CloseEnough"),this.crew=(new L.CrewRules).readIni(S),this.defaultMirageDisguises=S.getArray("DefaultMirageDisguises"),this.dMisl=(new V.DMislRules).readIni(S),this.dropPodWeapon=S.getString("DropPodWeapon"),this.engineer=S.getString("Engineer"),this.engineerCaptureLevel=S.getFixed("EngineerCaptureLevel",.25),this.engineerDamage=S.getFixed("EngineerDamage",.437),this.engineerAlwaysCaptureTech=S.getBool("EngineerAlwaysCaptureTech",!0),this.flightLevel=S.getNumber("FlightLevel"),this.guardAreaTargetingDelay=S.getNumber("GuardAreaTargetingDelay"),this.harvesterTooFarDistance=S.getNumber("HarvesterTooFarDistance"),this.harvesterUnit=S.getArray("HarvesterUnit"),this.hover=(new W.HoverRules).readIni(S),this.infantryBlinkDisguiseTime=S.getNumber("InfantryBlinkDisguiseTime"),this.lightningStorm=(new U.LightningStormRules).readIni(S),this.lowPowerPenaltyModifier=S.getNumber("LowPowerPenaltyModifier",1),this.minLowPowerProductionSpeed=S.getFixed("MinLowPowerProductionSpeed",.5),this.maxLowPowerProductionSpeed=S.getFixed("MaxLowPowerProductionSpeed",1),this.maximumCheerRate=S.getNumber("MaximumCheerRate"),this.maximumQueuedObjects=S.getNumber("MaximumQueuedObjects"),this.maxWaypointPathLength=S.getNumber("MaxWaypointPathLength"),this.multipleFactory=S.getFixed("MultipleFactory",1),this.normalTargetingDelay=S.getNumber("NormalTargetingDelay"),this.padAircraft=S.getArray("PadAircraft"),this.parachuteMaxFallRate=S.getNumber("ParachuteMaxFallRate"),this.paradrop=(new _.ParadropRules).readIni(S),this.prism=(new D.PrismRules).readIni(S),this.purifierBonus=S.getNumber("PurifierBonus"),this.radar=(new B.RadarRules).readIni(S),this.refundPercent=z.clamp(S.getNumber("RefundPercent"),0,1),this.repair=(new N.RepairRules).readIni(S),this.returnStructures=S.getBool("ReturnStructures"),this.revealTriggerRadius=Math.min(10,S.getNumber("RevealTriggerRadius")),this.shipSinkingWeight=S.getNumber("ShipSinkingWeight"),this.sovietDisguise=S.getString("SovietDisguise"),this.spyMoneyStealPercent=S.getNumber("SpyMoneyStealPercent"),this.spyPowerBlackout=S.getNumber("SpyPowerBlackout"),this.technician=S.getString("Technician"),this.threat=(new F.ThreatRules).readIni(S),this.treeStrength=S.getNumber("TreeStrength"),this.unitsUnsellable=S.getBool("UnitsUnsellable"),this.v3Rocket=(new H.V3RocketRules).readIni(S),this.veteran=(new j.VeteranRules).readIni(S),this.wallBuildSpeedCoefficient=S.getFixed("WallBuildSpeedCoefficient"),this.readPrereqCategories(S)}readPrereqCategories(S){for(var[O,B]of $){if(!S.has(B))throw new Error(`Missing prerequisite category ${B} in [General] section`);this.prereqCategories.set(O,S.getArray(B))}}getMissileRules(S){switch(S){case this.v3Rocket.type:return this.v3Rocket;case this.dMisl.type:return this.dMisl;default:throw new Error(`Unsupported missile type "${S}"`)}}})}}}),System.register("game/rules/LandRules",["game/type/SpeedType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("LandRules",class{constructor(){this.speedModifiers=new Map}readIni(S){return this.buildable=S.getBool("Buildable",!1),[...S.entries.keys()].forEach(O=>{void 0!==B.SpeedType[O]&&this.speedModifiers.set(B.SpeedType[O],S.getNumber(O))}),this}getSpeedModifier(S){if(S===B.SpeedType.Foot&&0===this.speedModifiers.get(B.SpeedType.Track))return 0;let O=this.speedModifiers.get(S);return void 0===O&&(O=1),S!==B.SpeedType.Track&&S!==B.SpeedType.Wheel&&0<O&&(O=1),O}})}}}),System.register("game/rules/MpDialogSettings",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("MpDialogSettings",class{readIni(S){return this.minMoney=S.getNumber("MinMoney"),this.money=S.getNumber("Money"),this.maxMoney=S.getNumber("MaxMoney"),this.moneyIncrement=S.getNumber("MoneyIncrement"),this.minUnitCount=S.getNumber("MinUnitCount"),this.unitCount=S.getNumber("UnitCount"),this.maxUnitCount=S.getNumber("MaxUnitCount"),this.crates=S.getBool("Crates"),this.gameSpeed=S.getNumber("GameSpeed"),this.mcvRedeploys=S.getBool("MCVRedeploys"),this.shortGame=S.getBool("ShortGame"),this.superWeapons=S.getBool("SuperWeapons"),this.techLevel=S.getNumber("TechLevel"),this.alliesAllowed=S.getBool("AlliesAllowed",!0),this.allyChangeAllowed=S.getBool("AllyChangeAllowed",!0),this.mustAlly=S.getBool("MustAlly"),this.bridgeDestruction=S.getBool("BridgeDestruction",!0),this.multiEngineer=S.getBool("MultiEngineer"),this}})}}}),System.register("game/rules/ObjectRules",["engine/type/ObjectType"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ObjectRules",N=class{static iniSpeedToLeptonsPerTick(S,O){return Math.min(256,256*S/O)}static iniRotToDegsPerTick(S){return S/256*360}constructor(S,O,B=-1,N){this.type=S,this.ini=O,this.index=B,this.generalRules=N,this.parse()}parse(){this.alphaImage=this.ini.getString("AlphaImage")||void 0,this.alternateArcticArt=this.ini.getBool("AlternateArcticArt"),this.crushable=this.ini.getBool("Crushable",this.type===B.ObjectType.Infantry),this.crushSound=this.ini.getString("CrushSound")||void 0,this.dontScore=this.ini.getBool("DontScore"),this.insignificant=this.ini.getBool("Insignificant"),this.legalTarget=this.ini.getBool("LegalTarget",!0),this.noShadow=this.ini.getBool("NoShadow"),this.uiName=this.ini.getString("UIName")}get name(){return this.ini.name}get imageName(){let S=this.ini.getString("Image");return S&&"null"!==S||(S=this.name),S}}),N.IMAGE_NONE="none"}}}),System.register("game/rules/ObjectRulesFactory",["engine/type/ObjectType","game/rules/ObjectRules","game/rules/TechnoRules","game/rules/OverlayRules","game/rules/TerrainRules","game/rules/SmudgeRules","game/rules/DebrisRules"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){S("ObjectRulesFactory",class{create(S,O,U,H){switch(S){case B.ObjectType.Aircraft:case B.ObjectType.Building:case B.ObjectType.Infantry:case B.ObjectType.Vehicle:return new j.TechnoRules(S,O,H,U);case B.ObjectType.Overlay:return new L.OverlayRules(S,O,H);case B.ObjectType.Terrain:return new D.TerrainRules(S,O,H);case B.ObjectType.Smudge:return new F.SmudgeRules(S,O,H);case B.ObjectType.VoxelAnim:return new _.DebrisRules(S,O,H);default:return new N.ObjectRules(S,O,H)}}})}}}),System.register("game/rules/OverlayRules",["game/type/LandType","game/rules/ObjectRules","game/type/ArmorType"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends N.ObjectRules{parse(){super.parse(),this.armor=this.ini.getEnum("Armor",j.ArmorType,j.ArmorType.None,!0),this.crate=this.ini.getBool("Crate");var S=this.ini.getBool("IsARock");this.isARock=S,this.isRubble=this.ini.getBool("IsRubble"),this.isVeinholeMonster=this.ini.getBool("IsVeinholeMonster"),this.isVeins=this.ini.getBool("IsVeins"),this.land=this.ini.getEnum("Land",B.LandType,B.LandType.Clear),this.noUseTileLandType=!!this.ini.getString("NoUseTileLandType"),this.strength=this.ini.getNumber("Strength"),this.tiberium=this.ini.getBool("Tiberium");var O=this.ini.getBool("Wall");this.wall=O,this.radarInvisible=this.ini.getBool("RadarInvisible",!O&&!S)}},S("OverlayRules",L)}}}),System.register("game/rules/PowerupsRules",["game/trait/CrateGeneratorTrait","game/type/PowerupType"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("PowerupsRules",class{constructor(){this.powerups=[]}readIni(S){for(var[O,j]of S.entries){let[S,D,F,_]=j.split(",");var j,L=Number(S);void 0!==(j=N.PowerupType[O])?B.UNSUPPORTED_POWERUP_TYPES.includes(j)||this.powerups.push({type:j,probShares:L,animName:"<none>"!==D.toLowerCase()?D:void 0,waterAllowed:"yes"===F,data:_}):console.warn(`Unknown powerup "${O}". Skipping.`)}return this}})}}}),System.register("game/rules/ProjectileRules",["game/rules/ObjectRules"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.ObjectRules{parse(){super.parse();var S=this.ini.getNumber("ROT",0);let O=this.ini.getNumber("Acceleration");1!==S||O||(O=Number.POSITIVE_INFINITY),O=O||3,this.acceleration=O,this.arcing=this.ini.getBool("Arcing"),this.courseLockDuration=this.ini.getNumber("CourseLockDuration"),this.detonationAltitude=this.ini.getNumber("DetonationAltitude"),this.firersPalette=this.ini.getBool("FirersPalette"),this.flakScatter=this.ini.getBool("FlakScatter"),this.inaccurate=this.ini.getBool("Inaccurate"),this.inviso=this.ini.getBool("Inviso"),this.isAntiAir=this.ini.getBool("AA"),this.isAntiGround=this.ini.getBool("AG",!0),this.level=this.ini.getBool("Level"),this.rot=B.ObjectRules.iniRotToDegsPerTick(S),this.iniRot=S,this.shadow=this.ini.getBool("Shadow",!0),this.shrapnelWeapon=this.ini.getString("ShrapnelWeapon")||void 0,this.shrapnelCount=this.ini.getNumber("ShrapnelCount"),this.subjectToCliffs=this.ini.getBool("SubjectToCliffs"),this.subjectToElevation=this.ini.getBool("SubjectToElevation"),this.subjectToWalls=this.ini.getBool("SubjectToWalls"),this.vertical=this.ini.getBool("Vertical")}},S("ProjectileRules",N)}}}),System.register("game/rules/RadiationRules",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("RadiationRules",class{readIni(S){this.radDurationMultiple=S.getNumber("RadDurationMultiple"),this.radApplicationDelay=S.getNumber("RadApplicationDelay"),this.radLevelMax=S.getNumber("RadLevelMax"),this.radLevelDelay=S.getNumber("RadLevelDelay"),this.radLightDelay=S.getNumber("RadLightDelay"),this.radLevelFactor=S.getNumber("RadLevelFactor"),this.radLightFactor=S.getNumber("RadLightFactor"),this.radTintFactor=S.getNumber("RadTintFactor"),this.radColor=S.getNumberArray("RadColor"),this.radSiteWarhead=S.getString("RadSiteWarhead")}})}}}),System.register("game/rules/Rules",["util/Color","engine/type/ObjectType","game/rules/CountryRules","game/rules/WeaponRules","game/rules/AudioVisualRules","game/rules/GeneralRules","game/rules/MpDialogSettings","game/type/LandType","game/rules/LandRules","game/rules/WarheadRules","game/rules/ProjectileRules","game/rules/ObjectRulesFactory","game/rules/CombatDamageRules","game/rules/TiberiumRules","game/rules/AiRules","game/rules/ElevationModelRules","game/rules/RadiationRules","game/rules/SuperWeaponRules","game/rules/CrateRules","game/rules/PowerupsRules","game/rules/mpAllowedColors","util/typeGuard","game/Weapon"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S}],execute:function(){S("Rules",class{constructor(S,O){this.ini=S,this.logger=O,this.buildingTypes=new Map,this.vehicleTypes=new Map,this.infantryTypes=new Map,this.aircraftTypes=new Map,this.terrainTypes=new Map,this.overlayTypes=new Map,this.overlayIdsByType=new Map,this.animationTypes=new Map,this.animationNames=new Set,this.voxelAnimTypes=new Map,this.smudgeTypes=new Map,this.warheadTypes=new Map,this.tiberiumTypes=new Map,this.superWeaponTypes=new Map,this.countryTypes=new Map,this.weaponTypes=new Map,this.allObjectRules=new Map,this.buildingRules=new Map,this.infantryRules=new Map,this.vehicleRules=new Map,this.aircraftRules=new Map,this.terrainRules=new Map,this.overlayRules=new Map,this.smudgeRules=new Map,this.voxelAnimRules=new Map,this.countryRules=new Map,this.warheadRules=new Map,this.powerups=new J.PowerupsRules,this.colors=new Map,this.general=new F.GeneralRules,this.ai=new q.AiRules,this.crateRules=new X.CrateRules,this.elevationModel=new Q.ElevationModelRules,this.mpDialogSettings=new _.MpDialogSettings,this.audioVisual=new D.AudioVisualRules,this.combatDamage=new K.CombatDamageRules,this.radiation=new Z.RadiationRules,this.landRules=new Map,this.tiberiumRules=new Map,this.superWeaponRules=new Map,this.cachedWeaponRules=new Map,this.cachedProjectileRules=new Map,this.init()}hasObject(S,O){return this.allObjectRules.get(O)?.has(S)}getObject(S,O){var B=this.allObjectRules.get(O)?.get(S);if(!B)throw new Error(`Missing rules for object "${S}"`);return B}getTechnoByInternalId(S,O){let B;if(O===N.ObjectType.Building)B=this.buildingTypes.get(S);else if(O===N.ObjectType.Infantry)B=this.infantryTypes.get(S);else if(O===N.ObjectType.Vehicle)B=this.vehicleTypes.get(S);else{if(O!==N.ObjectType.Aircraft)throw new Error(`Type ${N.ObjectType[O]} is not a techno type`);B=this.aircraftTypes.get(S)}if(void 0===B)throw new Error(`Object type "${N.ObjectType[O]}" with ID "${S}" not found`);return this.getObject(B,O)}getBuilding(S){var O=this.buildingRules.get(S);if(!O)throw new Error(`Missing rules for building "${S}"`);return O}getWeapon(S){let O=this.cachedWeaponRules.get(S);if(!O){var B=this.ini.getSection(S);if(!B)throw new Error(`Weapon ${S} is missing ini section`);O=new L.WeaponRules(B),this.cachedWeaponRules.set(S,O)}return O}getWeaponByInternalId(S){var O=this.weaponTypes.get(S);if(!O)throw new RangeError(`Weapon with internal ID "${S}" not found`);return this.getWeapon(O)}getWarhead(S){let O=this.warheadRules.get(S.toLowerCase());var B;if(O||(B=this.ini.getSection(S))&&(O=new V.WarheadRules(B),this.warheadRules.set(S.toLowerCase(),O)),!O)throw new Error("Unknown warhead "+S);return O}getProjectile(S){let O=this.cachedProjectileRules.get(S);if(!O){var B=this.ini.getSection(S);if(!B)throw new Error(`Projectile ${S} is missing ini section`);O=new W.ProjectileRules(N.ObjectType.Projectile,B),this.cachedProjectileRules.set(S,O)}return O}getOverlayName(S){var O=this.overlayTypes.get(S);if(!O)throw new Error("Invalid overlay id "+S);return O}hasOverlayId(S){return this.overlayTypes.has(S)}getOverlayId(S){var O=this.overlayIdsByType.get(S);if(void 0===O)throw new Error("Invalid overlay name "+S);return O}getOverlay(S){var O=this.overlayRules.get(S);if(!O)throw new Error(`Missing rules for overlay "${S}"`);return O}getAnimationName(S){return this.animationTypes.get(S)}getCountry(S){if(!this.countryRules.has(S))throw new Error("Unknown country "+S);return this.countryRules.get(S)}getMultiplayerCountries(){return[...this.countryRules.values()].filter(S=>S.multiplay)}getMultiplayerColors(){let S=new Map;return ee.mpAllowedColors.forEach(O=>{if(!this.colors.has(O))throw new Error(`Multiplayer color "${O}" does not exist in the rules [Colors] section.`);S.set(O,this.colors.get(O))}),S}getLandRules(S){let O=this.landRules.get(S);var B;return O||(B=S===U.LandType.Cliff?"Rock":U.LandType[S],O=(new H.LandRules).readIni(this.ini.getOrCreateSection(B)),this.landRules.set(S,O)),O}getTiberium(S){var O=this.tiberiumTypes.get(S);if(!O)throw new Error("Unknown tiberium type "+S);return this.tiberiumRules.get(O)}getSuperWeapon(S){if(!this.superWeaponRules.has(S))throw new Error(`Unknown superweapon type "${S}"`);return this.superWeaponRules.get(S)}getIni(){return this.ini}applySpecialFlags(S){S.initialVeteran&&(this.general.veteran.initialVeteran=!0)}init(){this.readAudioVisual(),this.readCombatDamage(),this.readRadiation(),this.readGeneral(),this.readAi(),this.readCrateRules(),this.readElevationModel(),this.readMpDialogSettings(),this.readObjectTypes("BuildingTypes",this.buildingTypes),this.readObjectTypes("InfantryTypes",this.infantryTypes),this.readObjectTypes("VehicleTypes",this.vehicleTypes),this.readObjectTypes("AircraftTypes",this.aircraftTypes),this.readObjectTypes("TerrainTypes",this.terrainTypes),this.readObjectTypes("SmudgeTypes",this.smudgeTypes),this.readObjectTypes("Animations",this.animationTypes),this.animationNames=new Set(this.animationTypes.values()),this.readObjectTypes("VoxelAnims",this.voxelAnimTypes),this.readObjectTypes("OverlayTypes",this.overlayTypes),this.overlayTypes.forEach((S,O)=>this.overlayIdsByType.set(S,O)),this.readColors(),this.readObjectTypes("Countries",this.countryTypes),this.readObjectTypes("Warheads",this.warheadTypes),this.readObjectTypes("Tiberiums",this.tiberiumTypes),this.readObjectTypes("SuperWeaponTypes",this.superWeaponTypes),this.allObjectRules.set(N.ObjectType.Building,this.buildingRules).set(N.ObjectType.Infantry,this.infantryRules).set(N.ObjectType.Vehicle,this.vehicleRules).set(N.ObjectType.Aircraft,this.aircraftRules).set(N.ObjectType.Terrain,this.terrainRules).set(N.ObjectType.Overlay,this.overlayRules).set(N.ObjectType.Smudge,this.smudgeRules).set(N.ObjectType.VoxelAnim,this.voxelAnimRules),this.readObjects(N.ObjectType.Building,this.buildingTypes,this.buildingRules),this.readObjects(N.ObjectType.Infantry,this.infantryTypes,this.infantryRules),this.readObjects(N.ObjectType.Vehicle,this.vehicleTypes,this.vehicleRules),this.readObjects(N.ObjectType.Aircraft,this.aircraftTypes,this.aircraftRules),this.readObjects(N.ObjectType.Terrain,this.terrainTypes,this.terrainRules),this.readObjects(N.ObjectType.Overlay,this.overlayTypes,this.overlayRules),this.readObjects(N.ObjectType.Smudge,this.smudgeTypes,this.smudgeRules),this.readObjects(N.ObjectType.VoxelAnim,this.voxelAnimTypes,this.voxelAnimRules),this.readCountries(),this.readWarheads(),this.readPowerups(),this.readTiberiums(),this.readSuperWeapons(),this.buildWeaponsList()}readAudioVisual(){var S=this.ini.getSection("AudioVisual");if(!S)throw new Error("Missing [AudioVisual] section");this.audioVisual.readIni(S)}readCombatDamage(){var S=this.ini.getSection("CombatDamage");if(!S)throw new Error("Missing [CombatDamage] section");this.combatDamage.readIni(S)}readRadiation(){var S=this.ini.getSection("Radiation");if(!S)throw new Error("Missing [Radiation] section");this.radiation.readIni(S)}readGeneral(){var S=this.ini.getSection("General");if(!S)throw new Error("Missing [General] section");this.general.readIni(S)}readAi(){var S=this.ini.getSection("AI");if(!S)throw new Error("Missing [AI] section");this.ai.readIni(S)}readCrateRules(){var S=this.ini.getSection("CrateRules");if(!S)throw new Error("Missing [CrateRules] section");this.crateRules.readIni(S)}readElevationModel(){var S=this.ini.getSection("ElevationModel");if(!S)throw new Error("Missing [ElevationModel] section");this.elevationModel.readIni(S)}readMpDialogSettings(){var S=this.ini.getSection("MultiplayerDialogSettings");if(!S)throw new Error("Missing [MultiplayerDialogSettings] section");this.mpDialogSettings.readIni(S)}readObjectTypes(S,O){let B=this.ini.getSection(S);if(!B)throw new Error(`Missing [${S}] section`);let N=0,j=new Set;B.entries.forEach((B,L)=>{"string"==typeof B?Number.isNaN(Number(L))?this.logger?.debug(`Non-numeric id "${L}" found in rules section [${S}]. Skipping.`):j.has(B)?this.logger?.debug(`Duplicate type "${B}" in rules section [${S}]. Skipping.`):(O.set(N++,B),j.add(B)):this.logger?.debug(`Non-string type found in rules section [${S}]. Skipping.`)})}readColors(){let S=this.ini.getSection("Colors");if(!S)throw new Error("Missing [Colors] section");S.entries.forEach((S,O)=>{var[N,j,L]=S.split(","),L=B.Color.fromHsv(parseInt(N,10),parseInt(j,10),parseInt(L,10));this.colors.set(O,L)})}readObjects(S,O,B){O.forEach((O,j)=>{var L=this.ini.getSection(O);L?(L=(new z.ObjectRulesFactory).create(S,L,this.general,j),B.set(O,L)):this.logger?.debug(N.ObjectType[S]+` type "${O}" has no rules section`)})}readCountries(){this.countryTypes.forEach((S,O)=>{var B=this.ini.getSection(S);if(!B)throw new Error("Missing ini section for country "+S);let N=new j.CountryRules(O);N.readIni(B),this.countryRules.set(S,N)})}readWarheads(){this.warheadTypes.forEach(S=>{var O=this.ini.getSection(S);O?(O=new V.WarheadRules(O),this.warheadRules.set(S.toLowerCase(),O)):this.logger?.debug(`Warhead "${S}" has no rules section`)})}readPowerups(){var S=this.ini.getSection("Powerups");if(!S)throw new Error("Missing [Powerups] section");this.powerups.readIni(S)}readTiberiums(){this.tiberiumTypes.forEach(S=>{var O=this.ini.getSection(S);if(!O)throw new Error("Missing rules section for tiberium type "+S);this.tiberiumRules.set(S,(new $.TiberiumRules).readIni(O))})}readSuperWeapons(){this.superWeaponTypes.forEach((S,O)=>{var B=this.ini.getSection(S);if(!B)throw new Error("Missing rules section for superweapon type "+S);this.superWeaponRules.set(S,new Y.SuperWeaponRules(O).readIni(B))})}buildWeaponsList(){let S=new Set;for(var O of(S.add(this.general.dropPodWeapon),this.superWeaponRules.values()))O.weaponType&&S.add(O.weaponType);var B,N;S.add(ie.Weapon.NUKE_PAYLOAD_NAME);for(let O of[...this.buildingRules.values(),...this.aircraftRules.values(),...this.vehicleRules.values(),...this.infantryRules.values()])for(B of[O.deathWeapon,O.primary,O.secondary,O.elitePrimary,O.eliteSecondary,O.occupyWeapon,O.eliteOccupyWeapon,...O.weaponCount?new Array(O.weaponCount).fill(0).map((S,B)=>[O.getWeaponAtIndex(B),O.getEliteWeaponAtIndex(B)]).flat():[]].filter(te.isNotNullOrUndefined).filter(S=>""!==S))S.add(B);let j=0;for(N of S)this.weaponTypes.set(j++,N)}})}}}),System.register("game/rules/SmudgeRules",["game/rules/ObjectRules"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.ObjectRules{parse(){super.parse(),this.burn=this.ini.getBool("Burn"),this.crater=this.ini.getBool("Crater"),this.width=this.ini.getNumber("Width",1),this.height=this.ini.getNumber("Height",1)}},S("SmudgeRules",N)}}}),System.register("game/rules/SuperWeaponRules",["game/type/SuperWeaponType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("SuperWeaponRules",class{constructor(S){this.index=S}readIni(S){return this.disableableFromShell=S.getBool("DisableableFromShell"),this.isPowered=S.getBool("IsPowered",!0),this.name=S.name,this.preClick=S.getBool("PreClick"),this.preDependent=S.getEnum("PreDependent",B.SuperWeaponType,void 0),this.postClick=S.getBool("PostClick"),this.rechargeTime=S.getNumber("RechargeTime",5),this.showTimer=S.getBool("ShowTimer"),this.sidebarImage=S.getString("SidebarImage").toLowerCase(),this.type=S.getEnum("Type",B.SuperWeaponType,void 0),this.uiName=S.getString("UIName"),this.weaponType=S.getString("WeaponType")||void 0,this}})}}}),System.register("game/rules/TechnoRules",["engine/type/ObjectType","game/SideType","game/type/SpeedType","game/type/PipColor","game/type/LocomotorType","game/type/MovementZone","game/type/ArmorType","game/type/LandTargeting","game/type/NavalTargeting","game/rules/ObjectRules","game/WeaponType","game/gameobject/unit/VeteranAbility","game/type/VhpScan","game/math/Vector3"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S}],execute:function(){var O;(O=q||S("BuildCat",q={}))[O.Combat=0]="Combat",O[O.Tech=1]="Tech",O[O.Resource=2]="Resource",O[O.Power=3]="Power",(O=Q||S("FactoryType",Q={}))[O.None=0]="None",O[O.BuildingType=1]="BuildingType",O[O.InfantryType=2]="InfantryType",O[O.UnitType=3]="UnitType",O[O.NavalUnitType=4]="NavalUnitType",O[O.AircraftType=5]="AircraftType",Z=class e extends V.ObjectRules{constructor(S,O,B,N){super(S,O,B,N)}parse(){super.parse(),this.owner=this.ini.getArray("Owner");var S=this.ini.getNumber("AIBasePlanningSide");this.aiBasePlanningSide=-1!==S&&void 0!==N.SideType[S]?S:void 0,this.requiredHouses=this.ini.getArray("RequiredHouses"),this.forbiddenHouses=this.ini.getArray("ForbiddenHouses"),this.requiresStolenAlliedTech=this.ini.getBool("RequiresStolenAlliedTech"),this.requiresStolenSovietTech=this.ini.getBool("RequiresStolenSovietTech"),this.techLevel=this.ini.getNumber("TechLevel",-1),this.cost=this.ini.getNumber("Cost"),this.points=this.ini.getNumber("Points"),this.power=this.ini.getNumber("Power"),this.powered=this.ini.getBool("Powered"),this.prerequisite=this.ini.getArray("Prerequisite"),this.prerequisiteOverride=this.ini.getArray("PrerequisiteOverride"),this.soylent=this.ini.getNumber("Soylent"),this.crateGoodie=this.ini.getBool("CrateGoodie"),this.buildCat=this.ini.getEnum("BuildCat",q,q.Combat),this.adjacent=this.ini.getNumber("Adjacent",1),this.baseNormal=this.ini.getBool("BaseNormal",!0),this.buildLimit=this.ini.getNumber("BuildLimit",Number.POSITIVE_INFINITY),this.airRangeBonus=this.ini.getNumber("AirRangeBonus"),this.guardRange=this.ini.getNumber("GuardRange"),this.defaultToGuardArea=this.ini.getBool("DefaultToGuardArea"),this.eligibileForAllyBuilding=this.ini.getBool("EligibileForAllyBuilding"),this.numberImpassableRows=this.ini.getNumber("NumberImpassableRows"),this.bridgeRepairHut=this.ini.getBool("BridgeRepairHut"),this.constructionYard=this.ini.getBool("ConstructionYard"),this.refinery=this.ini.getBool("Refinery"),this.unitRepair=this.ini.getBool("UnitRepair"),this.unitReload=this.ini.getBool("UnitReload"),this.unitSell=this.ini.getBool("UnitSell"),this.isBaseDefense=this.ini.getBool("IsBaseDefense"),this.superWeapon=this.parseWeaponName(this.ini.getString("SuperWeapon")),this.chargedAnimTime=this.ini.getNumber("ChargedAnimTime");var O=this.ini.getBool("Naval");this.naval=O,this.underwater=this.ini.getBool("Underwater"),this.waterBound=this.ini.getBool("WaterBound"),this.orePurifier=this.ini.getBool("OrePurifier"),this.cloning=this.ini.getBool("Cloning"),this.grinding=this.ini.getBool("Grinding"),this.nukeSilo=this.ini.getBool("NukeSilo"),this.repairable=this.ini.getBool("Repairable",this.type===B.ObjectType.Building),this.clickRepairable=this.ini.getBool("ClickRepairable",this.type===B.ObjectType.Building),this.unsellable=this.ini.getBool("Unsellable",this.type!==B.ObjectType.Building&&this.generalRules.unitsUnsellable),this.returnable=this.ini.getBool("Returnable",this.generalRules.returnStructures),this.gdiBarracks=this.ini.getBool("GDIBarracks"),this.nodBarracks=this.ini.getBool("NODBarracks"),this.numberOfDocks=this.ini.getNumber("NumberOfDocks"),this.unitRepair&&!this.numberOfDocks&&(this.numberOfDocks=1),this.factory=this.ini.getEnum("Factory",Q,Q.None),this.factory===Q.UnitType&&O&&(this.factory=Q.NavalUnitType),this.weaponsFactory=this.ini.getBool("WeaponsFactory"),this.helipad=this.ini.getBool("Helipad"),this.hospital=this.ini.getBool("Hospital"),this.landTargeting=this.ini.getEnumNumeric("LandTargeting",U.LandTargeting,U.LandTargeting.LandOk),this.navalTargeting=this.ini.getEnumNumeric("NavalTargeting",H.NavalTargeting,H.NavalTargeting.UnderwaterNever),this.tooBigToFitUnderBridge=this.ini.getBool("TooBigToFitUnderBridge",this.type===B.ObjectType.Building),this.canBeOccupied=this.ini.getBool("CanBeOccupied"),this.maxNumberOccupants=this.ini.getNumber("MaxNumberOccupants"),this.leaveRubble=this.ini.getBool("LeaveRubble"),this.undeploysInto=this.ini.getString("UndeploysInto"),this.deploysInto=this.ini.getString("DeploysInto"),this.deployTime=this.ini.getNumber("DeployTime"),this.capturable=this.ini.getBool("Capturable"),this.spyable=this.ini.getBool("Spyable"),this.needsEngineer=this.ini.getBool("NeedsEngineer"),this.c4=this.ini.getBool("C4"),this.canC4=this.ini.getBool("CanC4",!0),this.eligibleForDelayKill=this.ini.getBool("EligibleForDelayKill"),this.produceCashStartup=this.ini.getNumber("ProduceCashStartup"),this.produceCashAmount=this.ini.getNumber("ProduceCashAmount"),this.produceCashDelay=this.ini.getNumber("ProduceCashDelay"),this.explosion=this.ini.getArray("Explosion"),this.explodes=this.ini.getBool("Explodes"),this.ifvMode=this.ini.getNumber("IFVMode"),this.turretIndexesByIfvMode=this.parseTurretIndexes(),this.turret=this.ini.getBool("Turret"),this.turretCount=this.ini.getNumber("TurretCount",this.turret?1:0),this.turretAnim=this.ini.getString("TurretAnim"),this.turretAnimIsVoxel=this.ini.getBool("TurretAnimIsVoxel"),this.turretAnimX=this.ini.getNumber("TurretAnimX"),this.turretAnimY=this.ini.getNumber("TurretAnimY"),this.turretAnimZAdjust=this.ini.getNumber("TurretAnimZAdjust"),this.isChargeTurret=this.ini.getBool("IsChargeTurret"),this.overpowerable=this.ini.getBool("Overpowerable"),this.freeUnit=this.ini.getString("FreeUnit"),this.primary=this.parseWeaponName(this.ini.getString("Primary")),this.secondary=this.parseWeaponName(this.ini.getString("Secondary")),this.elitePrimary=this.parseWeaponName(this.ini.getString("ElitePrimary")),this.eliteSecondary=this.parseWeaponName(this.ini.getString("EliteSecondary")),this.weaponCount=this.ini.getNumber("WeaponCount"),this.deathWeapon=this.parseWeaponName(this.ini.getString("DeathWeapon")),this.deathWeaponDamageModifier=this.ini.getNumber("DeathWeaponDamageModifier",1),this.occupyWeapon=this.parseWeaponName(this.ini.getString("OccupyWeapon")),this.eliteOccupyWeapon=this.parseWeaponName(this.ini.getString("EliteOccupyWeapon")),this.veteranAbilities=new Set(this.ini.getEnumArray("VeteranAbilities",z.VeteranAbility)),this.eliteAbilities=new Set([...this.veteranAbilities,...this.ini.getEnumArray("EliteAbilities",z.VeteranAbility)]),this.selfHealing=this.ini.getBool("SelfHealing"),this.wall=this.ini.getBool("Wall"),this.gate=this.ini.getBool("Gate"),this.armor=this.ini.getEnum("Armor",_.ArmorType,_.ArmorType.None,!0),this.strength=Math.floor(this.ini.getNumber("Strength")),this.immune=this.ini.getBool("Immune"),this.immuneToRadiation=this.ini.getBool("ImmuneToRadiation"),this.immuneToPsionics=this.ini.getBool("ImmuneToPsionics"),this.typeImmune=this.ini.getBool("TypeImmune"),this.warpable=this.ini.getBool("Warpable",!0),this.isTilter=this.ini.getBool("IsTilter",!0),this.walkRate=this.ini.getNumber("WalkRate",1),this.idleRate=this.ini.getNumber("IdleRate",0),this.noSpawnAlt=this.ini.getBool("NoSpawnAlt"),this.crusher=this.ini.getBool("Crusher"),this.consideredAircraft=this.ini.getBool("ConsideredAircraft"),this.crashable=this.ini.getBool("Crashable");var Z=this.ini.getBool("Landable");this.landable=Z,this.airportBound=this.ini.getBool("AirportBound"),this.balloonHover=this.ini.getBool("BalloonHover"),this.hoverAttack=this.ini.getBool("HoverAttack"),this.omniFire=this.ini.getBool("OmniFire"),this.fighter=this.ini.getBool("Fighter"),this.flightLevel=this.ini.getNumber("FlightLevel")||void 0;var Y=this.ini.getString("Locomotor");if(S=this.type===B.ObjectType.Building?D.LocomotorType.Statue:D.LocomotorType.Chrono,Y?(O=D.locomotorTypesByClsId.get(Y))?this.locomotor=O:(console.warn(`Object rules "${this.name}" has invalid Locomotor "${Y}"`),this.locomotor=S):this.locomotor=S,this.locomotor!==D.LocomotorType.Statue){let S=D.defaultSpeedsByLocomotor.get(this.locomotor);void 0===S&&(this.type===B.ObjectType.Aircraft||this.consideredAircraft?S=j.SpeedType.Winged:this.type===B.ObjectType.Vehicle?S=this.crusher?j.SpeedType.Track:j.SpeedType.Wheel:this.type===B.ObjectType.Infantry&&(S=j.SpeedType.Foot)),this.speedType=this.ini.getEnum("SpeedType",j.SpeedType,S,!0)}S=[D.LocomotorType.Ship,D.LocomotorType.Vehicle,D.LocomotorType.Chrono].includes(this.locomotor)?65:100,this.speed=V.ObjectRules.iniSpeedToLeptonsPerTick(this.ini.getNumber("Speed"),S),this.movementZone=this.ini.getEnum("MovementZone",F.MovementZone,F.MovementZone.Normal),this.fearless=this.ini.getBool("Fearless"),this.deployer=this.ini.getBool("Deployer"),this.deployFire=this.ini.getBool("DeployFire"),this.deployFireWeapon=this.ini.getNumber("DeployFireWeapon",W.WeaponType.Secondary),this.undeployDelay=this.ini.getNumber("UndeployDelay"),this.fraidycat=this.ini.getBool("Fraidycat",!1),this.isHuman=!this.ini.getBool("NotHuman"),this.organic=this.type===B.ObjectType.Infantry||this.ini.getBool("Organic"),this.occupier=this.ini.getBool("Occupier"),this.engineer=this.ini.getBool("Engineer"),this.ivan=this.ini.getBool("Ivan"),this.civilian=this.ini.getBool("Civilian"),this.agent=this.ini.getBool("Agent"),this.infiltrate=this.ini.getBool("Infiltrate"),this.threatPosed=this.ini.getNumber("ThreatPosed"),this.specialThreatValue=this.ini.getNumber("SpecialThreatValue"),this.canPassiveAquire=this.ini.getBool("CanPassiveAquire",!0),this.canRetaliate=this.ini.getBool("CanRetaliate",!0),this.preventAttackMove=this.ini.getBool("PreventAttackMove"),this.opportunityFire=this.ini.getBool("OpportunityFire"),this.distributedFire=this.ini.getBool("DistributedFire"),this.radialFireSegments=this.ini.getNumber("RadialFireSegments"),this.attackCursorOnFriendlies=this.ini.getBool("AttackCursorOnFriendlies"),this.bombable=this.ini.getBool("Bombable",!0),this.trainable=this.ini.getBool("Trainable",this.type!==B.ObjectType.Building),this.crewed=this.ini.getBool("Crewed"),this.parasiteable=this.ini.getBool("Parasiteable",this.type!==B.ObjectType.Building),this.suppressionThreshold=this.ini.getNumber("SuppressionThreshold"),this.reselectIfLimboed=this.ini.getBool("ReselectIfLimboed"),this.rejoinTeamIfLimboed=this.ini.getBool("RejoinTeamIfLimboed"),this.weight=this.ini.getNumber("Weight"),this.accelerates=this.ini.getBool("Accelerates",!0),this.accelerationFactor=this.ini.getNumber("AccelerationFactor",.03),this.teleporter=this.ini.getBool("Teleporter"),this.canDisguise=this.ini.getBool("CanDisguise"),this.disguiseWhenStill=this.ini.getBool("DisguiseWhenStill"),this.permaDisguise=this.ini.getBool("PermaDisguise"),this.detectDisguise=this.ini.getBool("DetectDisguise"),this.detectDisguiseRange=this.ini.getNumber("DetectDisguiseRange"),this.cloakable=this.ini.getBool("Cloakable"),this.sensors=this.ini.getBool("Sensors"),this.sensorArray=this.ini.getBool("SensorArray"),this.sensorsSight=this.ini.getNumber("SensorsSight"),this.burstDelay=this.parseBurstDelay(),this.vhpScan=this.ini.getEnum("VHPScan",K.VhpScan,K.VhpScan.None,!0),this.pip=this.ini.getEnum("Pip",L.PipColor,L.PipColor.Green,!0),this.passengers=this.ini.getNumber("Passengers"),this.gunner=this.ini.getBool("Gunner"),this.ammo=this.ini.getNumber("Ammo",-1),this.initialAmmo=this.ini.getNumber("InitialAmmo",-1),this.manualReload=this.ini.getBool("ManualReload",this.type===B.ObjectType.Aircraft),this.storage=this.ini.getNumber("Storage"),this.spawned=this.ini.getBool("Spawned"),this.spawns=this.ini.getString("Spawns"),this.spawnsNumber=this.ini.getNumber("SpawnsNumber"),this.spawnRegenRate=this.ini.getNumber("SpawnRegenRate"),this.spawnReloadRate=this.ini.getNumber("SpawnReloadRate"),this.missileSpawn=this.ini.getBool("MissileSpawn"),this.size=this.ini.getNumber("Size",1),this.sizeLimit=this.ini.getNumber("SizeLimit"),this.sight=Math.min(e.MAX_SIGHT,this.needsEngineer?6:this.ini.getNumber("Sight",1)),this.spySat=this.ini.getBool("SpySat"),this.gapGenerator=this.ini.getBool("GapGenerator"),this.gapRadiusInCells=this.ini.getNumber("GapRadiusInCells"),this.psychicDetectionRadius=this.ini.getNumber("PsychicDetectionRadius"),this.hasRadialIndicator=this.ini.getBool("HasRadialIndicator"),this.harvester=this.ini.getBool("Harvester"),this.unloadingClass=this.ini.getString("UnloadingClass"),this.dock=this.ini.getArray("Dock"),this.radar=this.ini.getBool("Radar"),this.radarInvisible=this.ini.getBool("RadarInvisible"),this.revealToAll=this.ini.getBool("RevealToAll"),this.selectable=!(this.type===B.ObjectType.Aircraft&&!Z)&&this.ini.getBool("Selectable",!0),this.isSelectableCombatant=this.ini.getBool("IsSelectableCombatant"),this.invisibleInGame=this.ini.getBool("InvisibleInGame"),this.moveToShroud=this.ini.getBool("MoveToShroud",this.type!==B.ObjectType.Aircraft),this.leadershipRating=this.ini.getNumber("LeadershipRating",5),this.unnatural=this.ini.getBool("Unnatural"),this.natural=this.ini.getBool("Natural"),this.buildTimeMultiplier=this.ini.getFixed("BuildTimeMultiplier",1),this.allowedToStartInMultiplayer=this.ini.getBool("AllowedToStartInMultiplayer",!0),this.rot=V.ObjectRules.iniRotToDegsPerTick(this.ini.getNumber("ROT",0)),this.jumpjetAccel=this.ini.getNumber("JumpJetAccel",2),this.jumpjetClimb=this.ini.getNumber("JumpjetClimb",5),this.jumpjetCrash=this.ini.getNumber("JumpjetCrash",5),this.jumpjetDeviation=this.ini.getNumber("JumpjetDeviation",40),this.jumpjetHeight=this.ini.getNumber("JumpjetHeight",500),this.jumpjetNoWobbles=this.ini.getBool("JumpjetNoWobbles"),this.jumpjetSpeed=this.ini.getNumber("JumpjetSpeed",14),this.jumpjetTurnRate=V.ObjectRules.iniRotToDegsPerTick(this.ini.getNumber("JumpJetTurnRate",4)),this.jumpjetWobbles=this.ini.getNumber("JumpjetWobbles",.15),this.pitchSpeed=this.ini.getNumber("PitchSpeed",.25),this.pitchAngle=1<=this.pitchSpeed?0:20,this.damageParticleSystems=this.ini.getArray("DamageParticleSystems"),Z=this.ini.getNumberArray("DamageSmokeOffset",void 0,[0,0,0]),this.damageSmokeOffset=new $.Vector3(Z[0],Z[2]/Math.SQRT2,Z[1]),this.minDebris=this.ini.getNumber("MinDebris"),this.maxDebris=this.ini.getNumber("MaxDebris"),this.debrisTypes=this.ini.getArray("DebrisTypes"),this.debrisAnims=this.ini.getArray("DebrisAnims"),this.isLightpost="GALITE"===this.imageName,this.lightVisibility=this.ini.getNumber("LightVisibility",5e3),this.lightIntensity=this.ini.getNumber("LightIntensity"),this.lightRedTint=this.ini.getNumber("LightRedTint",1),this.lightGreenTint=this.ini.getNumber("LightGreenTint",1),this.lightBlueTint=this.ini.getNumber("LightBlueTint",1),this.ambientSound=this.ini.getString("AmbientSound")||void 0,this.createSound=this.ini.getString("CreateSound")||void 0,this.deploySound=this.ini.getString("DeploySound")||void 0,this.undeploySound=this.ini.getString("UndeploySound")||void 0,this.voiceSelect=this.ini.getString("VoiceSelect")||void 0,this.voiceMove=this.ini.getString("VoiceMove")||void 0,this.voiceAttack=this.ini.getString("VoiceAttack")||void 0,this.voiceFeedback=this.ini.getString("VoiceFeedback")||void 0,this.voiceSpecialAttack=this.ini.getString("VoiceSpecialAttack")||void 0,this.voiceEnter=this.ini.getString("VoiceEnter")||void 0,this.voiceCapture=this.ini.getString("VoiceCapture")||void 0,this.voiceCrashing=this.ini.getString("VoiceCrashing")||void 0,this.crashingSound=this.ini.getString("CrashingSound")||void 0,this.impactLandSound=this.ini.getString("ImpactLandSound")||void 0,this.auxSound1=this.ini.getString("AuxSound1")||void 0,this.auxSound2=this.ini.getString("AuxSound2")||void 0,this.dieSound=this.ini.getString("DieSound")||void 0,this.moveSound=this.ini.getString("MoveSound")||void 0,this.enterWaterSound=this.ini.getString("EnterWaterSound")||void 0,this.leaveWaterSound=this.ini.getString("LeaveWaterSound")||void 0,this.turretRotateSound=this.ini.getString("TurretRotateSound")||void 0,this.workingSound=this.ini.getString("WorkingSound")||void 0,this.notWorkingSound=this.ini.getString("NotWorkingSound")||void 0,this.chronoInSound=this.ini.getString("ChronoInSound")||void 0,this.chronoOutSound=this.ini.getString("ChronoOutSound")||void 0,this.enterTransportSound=this.ini.getString("EnterTransportSound")||void 0,this.leaveTransportSound=this.ini.getString("LeaveTransportSound")||void 0}parseWeaponName(S){return S&&"none"!==S.toLowerCase()?S:void 0}parseTurretIndexes(){let S=new Map;return this.ini.getBool("Gunner")&&this.ini.entries.forEach((O,B)=>{var N=B.match(/^(.*)TurretWeapon$/i);N&&(N=N[1]+"TurretIndex",this.ini.has(N)&&S.set(Number(O),this.ini.getNumber(N)))}),S}parseBurstDelay(){let S=[];for(let O=0;O<4;++O)S.push(this.ini.has("BurstDelay"+O)?this.ini.getNumber("BurstDelay"+O):void 0);return S}hasOwner(S){return!!this.owner.length&&-1!==this.owner.indexOf(S.name)}isAvailableTo(S){return(!this.requiredHouses.length||-1!==this.requiredHouses.indexOf(S.name))&&-1===this.forbiddenHouses.indexOf(S.name)}getWeaponAtIndex(S){return this.parseWeaponName(this.ini.getString("Weapon"+(S+1)))}getEliteWeaponAtIndex(S){return this.parseWeaponName(this.ini.getString("EliteWeapon"+(S+1)))}},S("TechnoRules",Z),Z.MAX_SIGHT=11}}}),System.register("game/rules/TerrainRules",["game/rules/ObjectRules","engine/TheaterType"],function(S,O){"use strict";var B,N,j,L;function n(S,O){switch(S){case 0:case 1:return!0;case 2:return 0!=(O&j.Right);case 3:return 0!=(O&j.Left);case 4:return 0!=(O&j.Bottom);default:throw new Error('Invalid subCell "'+S)}}return O&&O.id,S("testOccupationBit",n),{setters:[function(S){B=S},function(S){N=S}],execute:function(){var O;(O=j||S("OccupationBits",j={}))[O.All=7]="All",O[O.Right=1]="Right",O[O.Left=2]="Left",O[O.Bottom=4]="Bottom",L=class extends B.ObjectRules{parse(){super.parse(),this.animationRate=this.ini.getNumber("AnimationRate"),this.animationProbability=this.ini.getNumber("AnimationProbability"),this.gate=this.ini.getBool("Gate"),this.immune=this.ini.getBool("Immune"),this.isAnimated=this.ini.getBool("IsAnimated"),this.snowOccupationBits=this.normalizeOccupationBits(this.ini.getNumber("SnowOccupationBits",j.All)),this.spawnsTiberium=this.ini.getBool("SpawnsTiberium"),this.strength=this.ini.getNumber("Strength"),this.radarInvisible=this.ini.getBool("RadarInvisible"),this.temperateOccupationBits=this.normalizeOccupationBits(this.ini.getNumber("TemperateOccupationBits",j.All))}normalizeOccupationBits(S){return(S+8*Math.abs(Math.floor(S/8)))%8}getOccupationBits(S){return S!==N.TheaterType.Snow?this.temperateOccupationBits:this.snowOccupationBits}getOccupiedSubCells(S){var O,B=this.getOccupationBits(S),N=[0,1,2,3,4];if(B===j.All)return N;let L=[];for(O of N)n(O,B)&&L.push(O);return L}},S("TerrainRules",L)}}}),System.register("game/rules/TiberiumRules",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("TiberiumRules",class{readIni(S){return this.value=S.getNumber("Value"),this}})}}}),System.register("game/rules/WarheadRules",["game/gameobject/infantry/InfDeathType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("WarheadRules",class{constructor(S){this.rules=S,this.verses=new Map,this.parse()}get name(){return this.rules.name}parse(){this.affectsAllies=this.rules.getBool("AffectsAllies",!0),this.animList=this.rules.getArray("AnimList"),this.bombDisarm=this.rules.getBool("BombDisarm"),this.bullets=this.rules.getBool("Bullets"),this.causesDelayKill=this.rules.getBool("CausesDelayKill"),this.cellSpread=this.rules.getNumber("CellSpread"),this.conventional=this.rules.getBool("Conventional"),this.culling=this.rules.getBool("Culling"),this.delayKillAtMax=this.rules.getNumber("DelayKillAtMax"),this.delayKillFrames=this.rules.getNumber("DelayKillFrames"),this.electricAssault=this.rules.getBool("ElectricAssault"),this.emEffect=this.rules.getBool("EMEffect"),this.infDeath=this.rules.getEnumNumeric("InfDeath",B.InfDeathType,B.InfDeathType.None),this.ivanBomb=this.rules.getBool("IvanBomb"),this.makesDisguise=this.rules.getBool("MakesDisguise"),this.mindControl=this.rules.getBool("MindControl"),this.nukeMaker=this.rules.getBool("NukeMaker"),this.paralyzes=this.rules.getNumber("Paralyzes"),this.parasite=this.rules.getBool("Parasite"),this.percentAtMax=this.rules.getNumber("PercentAtMax",1),this.proneDamage=this.rules.getFixed("ProneDamage",1),this.psychicDamage=this.rules.getBool("PsychicDamage"),this.radiation=this.rules.getBool("Radiation"),this.rocker=this.rules.getBool("Rocker"),this.sonic=this.rules.getBool("Sonic"),this.temporal=this.rules.getBool("Temporal"),this.rules.getFixedArray("Verses").forEach((S,O)=>this.verses.set(O,S)),this.wallAbsoluteDestroyer=this.rules.getBool("WallAbsoluteDestroyer"),this.wall=this.rules.getBool("Wall"),this.wood=this.rules.getBool("Wood")}})}}}),System.register("game/rules/WeaponRules",["game/rules/ObjectRules"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("WeaponRules",class{constructor(S){this.rules=S,this.parse()}parse(){this.ambientDamage=this.rules.getNumber("AmbientDamage"),this.anim=this.rules.getArray("Anim"),this.areaFire=this.rules.getBool("AreaFire"),this.burst=this.rules.getNumber("Burst",1),this.cellRangefinding=this.rules.getBool("CellRangefinding"),this.damage=this.rules.getNumber("Damage"),this.decloakToFire=this.rules.getBool("DecloakToFire",!0),this.fireOnce=this.rules.getBool("FireOnce"),this.isAlternateColor=this.rules.getBool("IsAlternateColor"),this.isElectricBolt=this.rules.getBool("IsElectricBolt"),this.isHouseColor=this.rules.getBool("IsHouseColor"),this.isLaser=this.rules.getBool("IsLaser"),this.isRadBeam=this.rules.getBool("IsRadBeam"),this.isSonic=this.rules.getBool("IsSonic"),this.laserDuration=this.rules.getNumber("LaserDuration"),this.limboLaunch=this.rules.getBool("LimboLaunch"),this.minimumRange=this.rules.getNumber("MinimumRange"),this.name=this.rules.name,this.neverUse=this.rules.getBool("NeverUse"),this.omniFire=this.rules.getBool("OmniFire"),this.projectile=this.rules.getString("Projectile"),this.radLevel=this.rules.getNumber("RadLevel"),this.range=this.rules.getNumber("Range"),-2===this.range&&(this.range=Number.POSITIVE_INFINITY),this.report=this.rules.getArray("Report"),this.revealOnFire=this.rules.getBool("RevealOnFire",!0),this.rof=this.rules.getNumber("ROF"),this.sabotageCursor=this.rules.getBool("SabotageCursor"),this.spawner=this.rules.getBool("Spawner");var S=this.rules.getNumber("Speed");this.iniSpeed=S,this.speed=B.ObjectRules.iniSpeedToLeptonsPerTick(S,100),this.suicide=this.rules.getBool("Suicide"),this.useSparkParticles=this.rules.getBool("UseSparkParticles"),this.warhead=this.rules.getString("Warhead")}})}}}),System.register("game/rules/general/CrewRules",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("CrewRules",class{readIni(S){return this.alliedCrew=S.getString("AlliedCrew"),this.alliedSurvivorDivisor=S.getNumber("AlliedSurvivorDivisor"),this.crewEscape=S.getNumber("CrewEscape"),this.sovietCrew=S.getString("SovietCrew"),this.sovietSurvivorDivisor=S.getNumber("SovietSurvivorDivisor"),this.survivorRate=S.getNumber("SurvivorRate"),this}})}}}),System.register("game/rules/general/DMislRules",["game/rules/general/MissileRules"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.MissileRules{readIni(S){return this.pauseFrames=S.getNumber("DMislPauseFrames"),this.tiltFrames=S.getNumber("DMislTiltFrames"),this.pitchInitial=S.getNumber("DMislPitchInitial"),this.pitchFinal=S.getNumber("DMislPitchFinal"),this.turnRate=S.getNumber("DMislTurnRate"),this.acceleration=S.getNumber("DMislAcceleration"),this.altitude=S.getNumber("DMislAltitude"),this.damage=S.getNumber("DMislDamage"),this.eliteDamage=S.getNumber("DMislEliteDamage"),this.bodyLength=S.getNumber("DMislBodyLength"),this.lazyCurve=S.getBool("DMislLazyCurve"),this.type=S.getString("DMislType"),this}},S("DMislRules",N)}}}),System.register("game/rules/general/HoverRules",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("HoverRules",class{readIni(S){return this.height=S.getNumber("HoverHeight"),this.dampen=S.getNumber("HoverDampen"),this.bob=S.getNumber("HoverBob"),this.boost=S.getNumber("HoverBoost"),this.acceleration=S.getNumber("HoverAcceleration"),this.brake=S.getNumber("HoverBrake"),this}})}}}),System.register("game/rules/general/LightningStormRules",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("LightningStormRules",class{readIni(S){return this.deferment=S.getNumber("LightningDeferment"),this.damage=S.getNumber("LightningDamage"),this.duration=S.getNumber("LightningStormDuration"),this.warhead=S.getString("LightningWarhead"),this.hitDelay=S.getNumber("LightningHitDelay"),this.scatterDelay=S.getNumber("LightningScatterDelay"),this.cellSpread=S.getNumber("LightningCellSpread"),this.separation=S.getNumber("LightningSeparation"),this}})}}}),System.register("game/rules/general/MissileRules",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("MissileRules",class{})}}}),System.register("game/rules/general/ParadropRules",["game/SideType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ParadropRules",class{readIni(S){if(this.allyParaDrop=this.readParadropSquad(S.getArray("AllyParaDropInf"),S.getNumberArray("AllyParaDropNum"),"Ally"),this.amerParaDrop=this.readParadropSquad(S.getArray("AmerParaDropInf"),S.getNumberArray("AmerParaDropNum"),"Amer"),this.sovParaDrop=this.readParadropSquad(S.getArray("SovParaDropInf"),S.getNumberArray("SovParaDropNum"),"Sov"),this.paradropPlane=S.getString("ParadropPlane"),!this.paradropPlane)throw new Error("Missing rules [General]->ParadropPlane");return this.paradropRadius=S.getNumber("ParadropRadius"),this}readParadropSquad(S,O,B){if(S.length!==O.length)throw new RangeError(`${B}ParaDropInf/Num size mismatch (${S.length}, ${O.length})`);let N=[];for(let B=0;B<S.length;++B)0<O[B]&&N.push({inf:S[B],num:O[B]});return N}getParadropSquads(S){switch(S){case B.SideType.GDI:return this.allyParaDrop;case B.SideType.Nod:return this.sovParaDrop;default:throw new Error(`Unhandled side type "${S}"`)}}})}}}),System.register("game/rules/general/PrismRules",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("PrismRules",class{readIni(S){return this.type=S.getString("PrismType"),this.supportHeight=S.getNumber("PrismSupportHeight"),this.supportMax=S.getNumber("PrismSupportMax"),this.supportModifier=S.getNumber("PrismSupportModifier",1),this}})}}}),System.register("game/rules/general/RadarRules",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("RadarEventType",B={}))[O.GenericCombat=0]="GenericCombat",O[O.GenericNonCombat=1]="GenericNonCombat",O[O.DropZone=2]="DropZone",O[O.BaseUnderAttack=3]="BaseUnderAttack",O[O.HarvesterUnderAttack=4]="HarvesterUnderAttack",O[O.EnemyObjectSensed=5]="EnemyObjectSensed",S("RadarRules",class{readIni(S){return this.eventSuppressionDistances=S.getNumberArray("RadarEventSuppressionDistances"),this.eventVisibilityDurations=S.getNumberArray("RadarEventVisibilityDurations"),this.eventDurations=S.getNumberArray("RadarEventDurations"),this.flashFrameTime=S.getNumber("FlashFrameTime"),this.combatFlashTime=S.getNumber("RadarCombatFlashTime"),this.eventMinRadius=S.getNumber("RadarEventMinRadius"),this.eventSpeed=S.getNumber("RadarEventSpeed"),this.eventRotationSpeed=S.getNumber("RadarEventRotationSpeed"),this.eventColorSpeed=S.getNumber("RadarEventColorSpeed"),this}getEventSuppresionDistance(S){if(S>this.eventSuppressionDistances.length-1)throw new RangeError("No event suppression distance is defined for type "+B[S]);return this.eventSuppressionDistances[S]}getEventVisibilityDuration(S){if(S>this.eventVisibilityDurations.length-1)throw new RangeError("No event visibility duration is defined for type "+B[S]);return this.eventVisibilityDurations[S]}getEventDuration(S){if(S>this.eventDurations.length-1)throw new RangeError("No event duration is defined for type "+B[S]);return this.eventDurations[S]}})}}}),System.register("game/rules/general/RepairRules",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("RepairRules",class{readIni(S){return this.reloadRate=S.getNumber("ReloadRate"),this.repairPercent=S.getNumber("RepairPercent"),this.repairRate=S.getNumber("RepairRate"),this.repairStep=S.getNumber("RepairStep"),this.uRepairRate=S.getNumber("URepairRate"),this.iRepairRate=S.getNumber("IRepairRate"),this.iRepairStep=S.getNumber("IRepairStep"),this}})}}}),System.register("game/rules/general/ThreatRules",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("ThreatRules",class{readIni(S){return this.myEffectivenessCoefficientDefault=S.getNumber("MyEffectivenessCoefficientDefault"),this.targetEffectivenessCoefficientDefault=S.getNumber("TargetEffectivenessCoefficientDefault"),this.targetSpecialThreatCoefficientDefault=S.getNumber("TargetSpecialThreatCoefficientDefault"),this.targetStrengthCoefficientDefault=S.getNumber("TargetStrengthCoefficientDefault"),this.targetDistanceCoefficientDefault=S.getNumber("TargetDistanceCoefficientDefault"),this}})}}}),System.register("game/rules/general/V3RocketRules",["game/rules/general/MissileRules"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.MissileRules{readIni(S){return this.pauseFrames=S.getNumber("V3RocketPauseFrames"),this.tiltFrames=S.getNumber("V3RocketTiltFrames"),this.pitchInitial=S.getNumber("V3RocketPitchInitial"),this.pitchFinal=S.getNumber("V3RocketPitchFinal"),this.turnRate=S.getNumber("V3RocketTurnRate"),this.acceleration=S.getNumber("V3RocketAcceleration"),this.altitude=S.getNumber("V3RocketAltitude"),this.damage=S.getNumber("V3RocketDamage"),this.eliteDamage=S.getNumber("V3RocketEliteDamage"),this.bodyLength=S.getNumber("V3RocketBodyLength"),this.lazyCurve=S.getBool("V3RocketLazyCurve"),this.type=S.getString("V3RocketType"),this}},S("V3RocketRules",N)}}}),System.register("game/rules/general/VeteranRules",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("VeteranRules",class{readIni(S){return this.veteranRatio=S.getNumber("VeteranRatio",3),this.veteranCombat=S.getNumber("VeteranCombat",1),this.veteranSpeed=S.getNumber("VeteranSpeed",1),this.veteranSight=Math.max(1,S.getNumber("VeteranSight",1)),this.veteranArmor=S.getNumber("VeteranArmor",1),this.veteranROF=S.getNumber("VeteranROF",1),this.veteranCap=S.getNumber("VeteranCap",2),this.initialVeteran=S.getBool("InitialVeteran"),this}})}}}),System.register("game/rules/mpAllowedColors",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("mpAllowedColors",["Gold","DarkRed","DarkBlue","DarkGreen","Orange","DarkSky","Purple","Magenta"])}}}),System.register("game/superweapon/ChronoSphereEffect",["game/gameobject/common/DeathType","game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/map/tileFinder/RadialTileFinder","game/type/MovementZone","game/type/SpeedType","game/superweapon/SuperWeaponEffect"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){U=class extends _.SuperWeaponEffect{constructor(S,O,B,N){super(S,O,B),this.tile2=N,this.objectsToTeleport=[]}onStart(S){this.delayTicks=S.rules.general.chronoDelay;let O=S.map.tiles;for(let F=-1;F<=1;F++)for(let _=-1;_<=1;_++){var B=O.getByMapCoords(this.tile.rx+F,this.tile.ry+_);if(B){var j,L=!!B.onBridgeLandType,D=O.getByMapCoords(this.tile2.rx+F,this.tile2.ry+_);for(j of S.map.getGroundObjectsOnTile(B))!j.isUnit()||j.tile!==B||j.onBridge!==L||j.isInfantry()&&j.stance===N.StanceType.Paradrop&&2<j.tileElevation||j.isDisposed||j.invulnerableTrait.isActive()||(j.rules.organic&&!j.rules.teleporter||!D?S.destroyObject(j,{player:this.owner}):j.warpedOutTrait.isActive()||(j.warpedOutTrait.setActive(!0,!0,S),this.objectsToTeleport.push({obj:j,destTile:D})))}}}onTick(S){if(0<this.delayTicks&&this.delayTicks--,this.delayTicks)return!1;for(let{obj:H,destTile:V}of this.objectsToTeleport)if(H.isSpawned){let W=!1,z=V?S.map.tileOccupation.getBridgeOnTile(V):void 0,K=S.map.getGroundObjectsOnTile(V),$=K.find(S=>S.isBuilding());var O=K.some(O=>S.rules.general.padAircraft.includes(O.name)),_=S.rules.general.padAircraft.includes(H.name)&&!!$?.helipadTrait&&!!$.dockTrait?.getAllDockTiles().includes(V)&&!$.dockTrait.hasReservedDockAt($.dockTrait.getDockNumberByTile(V))&&$.owner===H.owner;let q=!1,Q=H.rules.speedType,Z=H.isInfantry();H.rules.movementZone===D.MovementZone.Fly&&(Q=F.SpeedType.Wheel);var U=S.map.mapBounds.isWithinBounds(V);if(!(_||S.map.terrain.getPassableSpeed(V,Q,Z,!!z)&&U)){let N=!1;O||!(0<S.map.terrain.getPassableSpeed(V,Q,Z,!!z,void 0,!0))&&U||($&&(W=!0),(U=new L.RadialTileFinder(S.map.tiles,S.map.mapBounds,V,{width:1,height:1},1,15,O=>0<S.map.terrain.getPassableSpeed(O,Q,Z,!!O.onBridgeLandType)&&!S.map.terrain.findObstacles({tile:O,onBridge:!!O.onBridgeLandType},H).length).getNextTile())&&(V=U,z=S.map.tileOccupation.getBridgeOnTile(V),K=S.map.getGroundObjectsOnTile(V),N=!0)),N||(H.moveTrait.teleportUnitToTile(V,z,!0,!1,S),H.warpedOutTrait.setActive(!1,!0,S),S.map.getTileZone(V)===j.ZoneType.Water&&(H.deathType=B.DeathType.Sink),S.destroyObject(H,{player:this.owner}),q=!0)}for(let O of K)O.isDisposed||O.isUnit()&&(this.objectsToTeleport.some(({obj:S})=>S===O)||O.onBridge!==!!z&&O.tile===V||2<Math.abs(O.tileElevation-H.tileElevation)||(O.isInfantry()&&O.stance!==N.StanceType.Paradrop&&(O.deathType=B.DeathType.Crush),S.destroyObject(O,{player:this.owner,obj:H})));if(!q){if(H.moveTrait.teleportUnitToTile(V,z,!0,!1,S),_&&$?.dockTrait){if(_=$.dockTrait.getAllDockTiles().indexOf(V),$.dockTrait.undockUnitAt(_),$.dockTrait.hasReservedDockAt(_))throw new Error("Target building dock is already reserved by another unit");$.dockTrait.dockUnitAt(H,_)}W?H.warpedOutTrait.setTimed(S.rules.general.chronoDelay,!1,S):H.warpedOutTrait.setActive(!1,!0,S)}}return!0}},S("ChronoSphereEffect",U)}}}),System.register("game/superweapon/IronCurtainEffect",["game/map/tileFinder/RadialTileFinder","game/superweapon/SuperWeaponEffect"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.SuperWeaponEffect{onStart(S){var O,N,j=S.rules.combatDamage.ironCurtainDuration,L={player:this.owner};let D=new B.RadialTileFinder(S.map.tiles,S.map.mapBounds,this.tile,{width:1,height:1},0,1,()=>!0);for(;O=D.getNextTile();)for(N of S.map.getGroundObjectsOnTile(O))!N.isTechno()||N.isUnit()&&N.tile!==O||N.rules.missileSpawn||(N.rules.organic?N.isDestroyed||S.destroyObject(N,L):(N.invulnerableTrait.setActiveFor(j,S.currentTick),(N.isVehicle()||N.isAircraft())&&N.parasiteableTrait?.isInfested()&&N.parasiteableTrait.destroyParasite(L,S)))}onTick(S){return!0}},S("IronCurtainEffect",j)}}}),System.register("game/superweapon/LightningStormEffect",["game/Coords","game/event/LightningStormCloudEvent","game/event/LightningStormManifestEvent","game/gameobject/unit/CollisionType","game/gameobject/unit/RangeHelper","game/GameSpeed","game/map/tileFinder/RandomTileFinder","game/Warhead","game/superweapon/SuperWeaponEffect","game/SpecialWarheadType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){var O;(O=W=W||{})[O.Approaching=0]="Approaching",O[O.Manifesting=1]="Manifesting",z=class extends H.SuperWeaponEffect{constructor(){super(...arguments),this.state=W.Approaching,this.clouds=[]}onStart(S){var O=S.rules.general.lightningStorm;this.manifestStartTimer=O.deferment,this.manifestEndTimer=O.duration,this.nextDirectHitTimer=0,this.nextRandomHitTimer=0}onTick(S){if(this.state===W.Approaching&&(0<this.manifestStartTimer?this.manifestStartTimer--:(this.state=W.Manifesting,S.events.dispatch(new j.LightningStormManifestEvent(this.tile)))),this.state===W.Manifesting){var O,N=S.rules.general.lightningStorm;if(0<this.manifestEndTimer&&(this.manifestEndTimer--,0<this.nextDirectHitTimer&&this.nextDirectHitTimer--,this.nextDirectHitTimer<=0&&(this.nextDirectHitTimer=N.hitDelay,this.spawnCloudAt(this.tile,S)),0<this.nextRandomHitTimer&&this.nextRandomHitTimer--,this.nextRandomHitTimer<=0)){this.nextRandomHitTimer=N.scatterDelay;var F=Math.floor(N.cellSpread/2);let O=N.separation,B=new D.RangeHelper(S.map.tileOccupation),j=new _.RandomTileFinder(S.map.tiles,S.map.mapBounds,this.tile,F,S,S=>!this.clouds.some(N=>B.tileDistance(S,N.tile)<O),!1);(F=j.getNextTile())&&this.spawnCloudAt(F,S)}for(O of this.clouds.slice())if(0<O.ticksLeft){if(O.ticksLeft--,O.ticksLeft===Math.floor(O.durationTicks/2)){var H=N.warhead;let j=new U.Warhead(S.rules.getWarhead(H));var z=O.tile,K=S.map.tileOccupation.getBridgeOnTile(z),$=K?.tileElevation??0;H=S.map.getTileZone(z),j.detonate(S,N.damage,z,$,B.Coords.tile3dToWorld(z.rx+.5,z.ry+.5,z.z+$),H,K?L.CollisionType.OnBridge:L.CollisionType.None,S.createTarget(K,z),{player:this.owner,weapon:void 0},V.SpecialWarheadType.LightningStrike)}}else this.clouds.splice(this.clouds.indexOf(O),1);if(!this.clouds.length&&this.manifestEndTimer<=0)return!0}return!1}spawnCloudAt(S,O){var j=O.rules.audioVisual.weatherConClouds;j=O.generateRandomInt(0,j.length-1),j=O.art.getAnimation(O.rules.audioVisual.weatherConClouds[j]).art.getNumber("Rate",60*F.GameSpeed.BASE_TICKS_PER_SECOND)/60,j=Math.floor(F.GameSpeed.BASE_TICKS_PER_SECOND/j*60),this.clouds.push({tile:S,durationTicks:j,ticksLeft:j}),j=(O.map.tileOccupation.getBridgeOnTile(S)?.tileElevation??0)+B.Coords.worldToTileHeight(O.rules.general.flightLevel),j=B.Coords.tile3dToWorld(S.rx+.5,S.ry+.5,S.z+j),O.events.dispatch(new N.LightningStormCloudEvent(j))}},S("LightningStormEffect",z)}}}),System.register("game/superweapon/NukeEffect",["game/Coords","engine/type/ObjectType","game/math/Vector2","game/Weapon","game/WeaponType","game/superweapon/SuperWeaponEffect"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class extends F.SuperWeaponEffect{constructor(S,O,B,N){super(S,O,B),this.weaponType=N}onStart(S){var O=S.rules.getWeapon(this.weaponType),B=S.createTarget(void 0,this.tile),j=this.owner.getOwnedObjectsByType(N.ObjectType.Building).find(S=>S.rules.nukeSilo);j?L.Weapon.factory(O.name,D.WeaponType.Primary,j,S.rules).fire(B,S):this.fireLooseNuke(O,B,S)}fireLooseNuke(S,O,N){var L=new j.Vector2(this.tile.rx+.5,this.tile.ry+.5).multiplyScalar(B.Coords.LEPTONS_PER_TILE);if(N.map.isWithinHardBounds(L)){let j=N.createLooseProjectile(S.name,this.owner,O);j.position.moveToLeptons(L),j.position.tileElevation=B.Coords.worldToTileHeight(j.rules.detonationAltitude),N.spawnObject(j,j.position.tile)}}onTick(S){return!0}},S("NukeEffect",_)}}}),System.register("game/superweapon/ParadropEffect",["game/Coords","engine/type/ObjectType","game/gameobject/Infantry","game/gameobject/infantry/StanceType","game/gameobject/task/move/MoveTask","game/gameobject/task/ParadropTask","game/gameobject/trait/UnlandableTrait","game/gameobject/unit/FacingUtil","game/gameobject/unit/RangeHelper","game/gameobject/unit/VeteranLevel","game/gameobject/unit/ZoneType","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/math/Vector2","util/bresenham","game/superweapon/SuperWeaponEffect"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S}],execute:function(){var O;(O=Z=Z||{})[O.Spawning=0]="Spawning",O[O.EnRoute=1]="EnRoute",O[O.Dropping=2]="Dropping",O[O.TurningAround=3]="TurningAround",Y=5*z.GameSpeed.BASE_TICKS_PER_SECOND,X=class extends Q.SuperWeaponEffect{constructor(S,O,B,N,j){super(S,O,B),this.paradropSquad=N,this.state=Z.Spawning,this.failedAttempts=0,this.spawnDelay=j*Y}onStart(S){this.passengerRules=S.rules.getObject(this.paradropSquad.inf,N.ObjectType.Infantry),this.passengerCount=this.paradropSquad.num}computeFlightPath(S,O,N){if(O.equals(S))throw new Error("Source and destination must be different");let j=S.clone().sub(O);var L=N.rules.general.paradrop.paradropRadius/B.Coords.LEPTONS_PER_TILE;L=O.clone().add(j.clone().setLength(j.length()+2*L)).floor();let D=q.bresenham(O.x,O.y,L.x,L.y).map(S=>N.map.tiles.getByMapCoords(S.x,S.y)??N.map.tiles.getPlaceholderTile(S.x,S.y));for(;D.length;){var F=D[0];if(F=B.Coords.tileToWorld(F.rx+.5,F.ry+.5),N.map.isWithinHardBounds(new $.Vector2(F.x,F.y)))break;D.shift()}if(!D.length)throw new Error("No valid paradrop path found");return{fromTile:D[0],toTile:D[D.length-1]}}onTick(S){if(this.state===Z.Spawning){if(0<this.spawnDelay)return this.spawnDelay--,!1;var O=S.map.tiles.getMapSize(),j=[new $.Vector2(0,0),new $.Vector2(Math.floor(O.width/2),0),new $.Vector2(0,Math.floor(O.height/2))][S.generateRandomInt(0,2)];let L=this.passengerRules.speedType,F=new K.RadialTileFinder(S.map.tiles,S.map.mapBounds,this.tile,{width:1,height:1},0,50,O=>0<S.map.terrain.getPassableSpeed(O,L,!0,!!O.onBridgeLandType));if(!(q=this.targetTile=F.getNextTile()))return!0;let H=new $.Vector2(q.rx,q.ry);var{fromTile:z,toTile:O}=this.computeFlightPath(H,j,S),q=S.rules.general.paradrop.paradropPlane;j=S.rules.getObject(q,N.ObjectType.Aircraft);let V=this.pdPlane=S.createUnitForPlayer(j,this.owner);S.spawnObject(V,z),V.direction=U.FacingUtil.fromMapCoords(H.clone().sub(new $.Vector2(z.rx,z.ry))),V.position.tileElevation=B.Coords.worldToTileHeight(V.rules.flightLevel??S.rules.general.flightLevel),V.zone=W.ZoneType.Air,V.onBridge=!1,V.unitOrderTrait.addTask(new D.MoveTask(S,O,!1,{allowOutOfBoundsTarget:!0})),V.traits.get(_.UnlandableTrait).setEnabled(!1),this.state=Z.EnRoute}if(!this.pdPlane||this.pdPlane.isDestroyed||this.pdPlane.isCrashing)return!0;if(q=this.targetTile,!this.pdPlane.unitOrderTrait.hasTasks())return this.state=Z.TurningAround,this.pdPlane.unitOrderTrait.addTask(new D.MoveTask(S,q,!1,{allowOutOfBoundsTarget:!0})),!1;if(j=S.rules.general.paradrop.paradropRadius/B.Coords.LEPTONS_PER_TILE,z=new H.RangeHelper(S.map.tileOccupation).isInTileRange(this.pdPlane.tile,q,0,j),this.state===Z.EnRoute&&z&&(this.state=Z.Dropping),this.state===Z.Dropping)if(z&&0<this.passengerCount){let B=!!(O=this.pdPlane.tile).onBridgeLandType;if(5<this.failedAttempts&&S.map.mapBounds.isWithinBounds(O))return this.passengerCount=0,!1;if(!S.map.terrain.getPassableSpeed(O,this.passengerRules.speedType,!0,B))return!1;if(S.map.getGroundObjectsOnTile(O).some(S=>S.isVehicle()&&S.onBridge===B||S.isBuilding()&&!S.isDestroyed||S.isInfantry()&&S.stance===L.StanceType.Paradrop))return!1;if(!(j=this.findFreeSubCell(S,O)))return!1;this.passengerCount--;let N=S.createUnitForPlayer(this.passengerRules,this.owner);N.stance=L.StanceType.Paradrop,N.position.tileElevation=this.pdPlane.tileElevation,N.position.subCell=j,N.onBridge=B,N.rules.trainable&&this.owner.canProduceVeteran(N.rules)&&N.veteranTrait?.setVeteranLevel(V.VeteranLevel.Veteran),S.spawnObject(N,O),N.unitOrderTrait.addTask(new F.ParadropTask(S).setCancellable(!1))}else{if(!(0<this.passengerCount))return this.pdPlane.unitOrderTrait.getCurrentTask().forceCancel(this.pdPlane),this.pdPlane.traits.get(_.UnlandableTrait).setEnabled(!0),!0;this.failedAttempts++,this.state=Z.TurningAround,this.pdPlane.unitOrderTrait.getCurrentTask().updateTarget(q,!!q.onBridgeLandType)}return this.state===Z.TurningAround&&z&&(q=this.computeFlightPath(new $.Vector2(q.rx,q.ry),new $.Vector2(this.pdPlane.tile.rx,this.pdPlane.tile.ry),S).toTile,this.pdPlane.unitOrderTrait.getCurrentTask().updateTarget(q,!1),this.state=Z.EnRoute),!1}findFreeSubCell(S,O){let B=S.map.getGroundObjectsOnTile(O).filter(S=>S.isTerrain()).map(O=>O.rules.getOccupiedSubCells(S.map.getTheaterType())).flat();var N=j.Infantry.SUB_CELLS.filter(S=>-1===B.indexOf(S));if(N.length)return 1<N.length?N[S.generateRandomInt(0,N.length-1)]:N[0]}},S("ParadropEffect",X)}}}),System.register("game/superweapon/SuperWeaponEffect",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("EffectStatus",B={}))[O.NotStarted=0]="NotStarted",O[O.Running=1]="Running",O[O.Finished=2]="Finished",S("SuperWeaponEffect",class{constructor(S,O,N){this.type=S,this.owner=O,this.tile=N,this.status=B.NotStarted}onStart(S){}onTick(S){return!0}})}}}),System.register("game/theater/AutoLat",["game/map/TileCollection"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("AutoLat",class{static calculate(S,O){let N=new Map;S.forEach(S=>{var B=O.getSetNum(S.tileNum);N.set(S,B),O.isCLAT(B)&&(B=O.getLAT(B),N.set(S,B),S.tileNum=O.getTileNumFromSet(B))}),S.forEach(j=>{var L=N.get(j);if(O.isLAT(L)){let H=0;var D=S.getNeighbourTile(j,B.TileDirection.TopRight),F=S.getNeighbourTile(j,B.TileDirection.BottomRight),_=S.getNeighbourTile(j,B.TileDirection.BottomLeft),U=S.getNeighbourTile(j,B.TileDirection.TopLeft);D&&O.canConnectTiles(L,N.get(D))&&(H+=1),F&&O.canConnectTiles(L,N.get(F))&&(H+=2),_&&O.canConnectTiles(L,N.get(_))&&(H+=4),U&&O.canConnectTiles(L,N.get(U))&&(H+=8),0<H&&(U=O.getCLATSet(L),j.tileNum=O.getTileNumFromSet(U,H))}else if(L===O.getGeneralValue("RampBase")&&!(j.rampType<1||4<j.terrainType)){let N=-1;var H=S.getNeighbourTile(j,B.TileDirection.TopRight),V=S.getNeighbourTile(j,B.TileDirection.BottomRight),W=S.getNeighbourTile(j,B.TileDirection.BottomLeft),z=S.getNeighbourTile(j,B.TileDirection.TopLeft);switch(j.rampType){case 1:z&&0===z.rampType&&N++,V&&0===V.rampType&&(N+=2);break;case 2:H&&0===H.rampType&&N++,W&&0===W.rampType&&(N+=2);break;case 3:V&&0===V.rampType&&N++,z&&0===z.rampType&&(N+=2);break;case 4:W&&0===W.rampType&&N++,H&&0===H.rampType&&(N+=2)}-1!==N&&(j.tileNum=O.getTileNumFromSet(O.getGeneralValue("RampSmooth"),3*(j.rampType-1)+N))}})}})}}}),System.register("game/theater/TileSet",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("TileSet",class{constructor(S,O,B){this.fileName=S,this.setName=O,this.tilesInSet=B,this.entries=[]}})}}}),System.register("game/theater/TileSetAnim",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("TileSetAnim",class{constructor(S,O,B,N){this.name=S,this.subTile=O,this.offsetX=B,this.offsetY=N}})}}}),System.register("game/theater/TileSetEntry",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("TileSetEntry",class{constructor(S,O){this.owner=S,this.index=O,this.files=[]}addFile(S){this.files.push(S)}setAnimation(S){this.animation=S}getAnimation(){return this.animation}getTmpFile(S,O,B=!1){if(this.files.length){var N=this.files[O(0,this.files.length-1)];return N.images[Math.min(S,N.images.length-1)].hasDamagedData?this.files[Math.min(B?1:0,this.files.length-1)]:N}}})}}}),System.register("game/theater/TileSets",["util/string","game/theater/TileSetEntry","game/theater/TileSet","game/theater/TileSetAnim"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){var O;(O=D||S("HighBridgeHeadType",D={}))[O.TopLeft=0]="TopLeft",O[O.BottomRight=1]="BottomRight",O[O.TopRight=2]="TopRight",O[O.BottomLeft=3]="BottomLeft",O[O.MiddleTlBr=4]="MiddleTlBr",O[O.MiddleTrBl=5]="MiddleTrBl",F=new Map([[D.TopLeft,["BridgeTopLeft1","BridgeTopLeft2"]],[D.BottomRight,["BridgeBottomRight1","BridgeBottomRight2"]],[D.TopRight,["BridgeTopRight1","BridgeTopRight2"]],[D.BottomLeft,["BridgeBottomLeft1","BridgeBottomLeft2"]],[D.MiddleTlBr,["BridgeMiddle1"]],[D.MiddleTrBl,["BridgeMiddle2"]]]),S("TileSets",class{constructor(S){this.theaterIni=S,this.tileSets=[],this.orderedEntries=[],this.highBridgeSetNums=[this.getGeneralValue("BridgeSet"),this.getGeneralValue("WoodBridgeSet")],this.cliffSetNums=[this.getGeneralValue("CliffSet"),this.getGeneralValue("WaterCliffs"),this.getGeneralValue("DestroyableCliffs")]}getTile(S){return this.orderedEntries[S]}getTileImage(S,O,B){let N=this.getTile(S);if(!N)throw new Error(`TileNum ${S} not found`);var j=N.getTmpFile(O,B);if(!j||O>=j.images.length)throw new Error(`SubTile ${O} not found`);return j.images[O]}getSetNum(S){var O=this.orderedEntries[S];if(!O)throw new Error("Invalid tileNum "+S);return this.tileSets.indexOf(O.owner)}getTileNumFromSet(S,O=0){let B=0;return this.tileSets.some((N,j)=>j===S?(B+=O,!0):(B+=N.entries.length,!1)),B}getGeneralValue(S){let O=this.theaterIni.getSection("General");if(!O)throw new Error("Missing [General] section in theather ini");return O.getNumber(S)}loadTileData(S,O){this.tileSets.length=0,this.orderedEntries.length=0,this.initTileSets(S,O),this.initAnimations()}readMaxTileNum(){let S=0,O=0;for(;;){var N="TileSet"+B.pad(S,"0000");let j=this.theaterIni.getSection(N);if(!j)break;S++,O+=j.getNumber("TilesInSet")}return O}initTileSets(S,O){let L,D=0;for(var F;F="TileSet"+B.pad(D,"0000"),L=this.theaterIni.getSection(F),L;){D++;let F=new j.TileSet(L.getString("FileName"),L.getString("SetName"),L.getNumber("TilesInSet"));this.tileSets.push(F);for(let j=1;j<=F.tilesInSet;j++){let L=new N.TileSetEntry(F,j-1);var _="a".charCodeAt(0);for(let N=_-1;N<="z".charCodeAt(0);N++)if(!(N>=_&&"Bridges"===F.setName)){let D=F.fileName+B.pad(j,"00");N>=_&&(D+=String.fromCharCode(N)),D+=O;var U=S.get(D);if(!U)break;L.addFile(U)}F.entries.push(L),this.orderedEntries.push(L)}}}initAnimations(){var S=this.theaterIni.getOrderedSections();for(let D=this.tileSets.length;D<S.length;++D){let F=S[D],_=this.tileSets.find(S=>S.setName===F.name);if(_)for(let S=1;S<=_.tilesInSet;++S){var O="Tile"+B.pad(S,"00"),N=O+"Anim",j=F.getString(N);j?(O=new L.TileSetAnim(j,F.getNumber(O+"AttachesTo"),F.getNumber(O+"XOffset"),F.getNumber(O+"YOffset")),_.entries[S-1].setAnimation(O)):console.warn(`Missing anim "${N}" for tileset `+_.setName)}}}isLAT(S){return S===this.getGeneralValue("RoughTile")||S===this.getGeneralValue("SandTile")||S===this.getGeneralValue("GreenTile")||S===this.getGeneralValue("PaveTile")}isCLAT(S){return S===this.getGeneralValue("ClearToRoughLat")||S===this.getGeneralValue("ClearToSandLat")||S===this.getGeneralValue("ClearToGreenLat")||S===this.getGeneralValue("ClearToPaveLat")}getLAT(S){return S===this.getGeneralValue("ClearToRoughLat")?this.getGeneralValue("RoughTile"):S===this.getGeneralValue("ClearToSandLat")?this.getGeneralValue("SandTile"):S===this.getGeneralValue("ClearToGreenLat")?this.getGeneralValue("GreenTile"):S===this.getGeneralValue("ClearToPaveLat")?this.getGeneralValue("PaveTile"):-1}getCLATSet(S){return S===this.getGeneralValue("RoughTile")?this.getGeneralValue("ClearToRoughLat"):S===this.getGeneralValue("SandTile")?this.getGeneralValue("ClearToSandLat"):S===this.getGeneralValue("GreenTile")?this.getGeneralValue("ClearToGreenLat"):S===this.getGeneralValue("PaveTile")?this.getGeneralValue("ClearToPaveLat"):-1}canConnectTiles(S,O){if(S===O)return!1;var B=this.getGeneralValue("GreenTile"),N=this.getGeneralValue("PaveTile"),j=this.getGeneralValue("MiscPaveTile"),L=this.getGeneralValue("ShorePieces"),D=this.getGeneralValue("WaterBridge"),F=this.getGeneralValue("PavedRoads"),_=this.getGeneralValue("Medians");return!(S===B&&O===L||O===B&&S===L||S===B&&O===D||O===B&&S===D||S===N&&O===F||O===N&&S===F||S===N&&O===j||O===N&&S===j||S===N&&O===_||O===N&&S===_)}getHighBridgeHeadType(S){for(var[O,B]of F)for(var N of B)if(this.getGeneralValue(N)===S+1)return O}getOppositeHighBridgeHeadType(S){switch(S){case D.TopLeft:return D.BottomRight;case D.TopRight:return D.BottomLeft;case D.BottomLeft:return D.TopRight;case D.BottomRight:return D.TopLeft;case D.MiddleTlBr:case D.MiddleTrBl:throw new Error("Middle bridge heads can't have opposites");default:throw new Error("Unhandled headType "+S)}}isCliffTile(S){return this.cliffSetNums.includes(this.getSetNum(S))}isHighBridgeBoundaryTile(S){if(this.highBridgeSetNums.includes(this.getSetNum(S))){var O=this.getTile(S);return void 0!==(O=this.getHighBridgeHeadType(O.index))&&![D.MiddleTlBr,D.MiddleTrBl].includes(O)}return!1}isHighBridgeMiddleTile(S){if(this.highBridgeSetNums.includes(this.getSetNum(S))){var O=this.getTile(S);return void 0!==(O=this.getHighBridgeHeadType(O.index))&&[D.MiddleTlBr,D.MiddleTrBl].includes(O)}return!1}})}}}),System.register("game/theater/rampHeights",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("rampHeights",[[0,0,0,0],[0,0,1,1],[1,0,0,1],[1,1,0,0],[0,1,1,0],[0,0,0,1],[1,0,0,0],[0,1,0,0],[0,0,1,0],[1,0,1,1],[1,1,0,1],[1,1,1,0],[0,1,1,1],[1,0,1,2],[2,1,0,1],[1,2,1,0],[0,1,2,1],[1,0,1,0],[0,1,0,1],[1,0,1,0],[0,1,0,1]])}}}),System.register("game/trait/CrateGeneratorTrait",["engine/type/ObjectType","engine/type/TerrainType","game/event/CratePickupEvent","game/gameobject/unit/RangeHelper","game/gameobject/unit/ZoneType","game/gameopts/constants","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/type/PowerupType","game/type/SpeedType","game/trait/interface/NotifyTick","game/type/SuperWeaponType","game/trait/SuperWeaponsTrait","game/gameobject/trait/CloakableTrait","game/Warhead","game/gameobject/unit/CollisionType","game/map/tileFinder/RandomTileFinder","game/map/OreSpread","engine/type/OverlayTibType","game/gameobject/trait/TiberiumTrait","game/math/Vector2","game/math/Box2","game/SpecialWarheadType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S}],execute:function(){S("UNSUPPORTED_POWERUP_TYPES",[H.PowerupType.IonStorm,H.PowerupType.Gas,H.PowerupType.Pod,H.PowerupType.Squad]),re=class{constructor(S){this.randomCrateSpawn=S,this.crates=[],this.availEdgeTiles=[],this.allTiles=[]}init(S){var O=S.map.tiles.getMapSize();let B=S.map.tiles,N=[],j=0;for(let F=0;F<O.width;++F){let U,H,V=!1,W=!1;for(let N=0;N<O.height;++N){var L=B.getByMapCoords(F,N);if(L&&this.canPlaceCrateOnTile(S,L)){var _=S.map.getTileZone(L)===D.ZoneType.Water;U?(_||(H=L),W=_):_?V=W=!0:U=H=L}else if(U&&!L)break}U&&(N.push(U),H&&H!==U&&N.push(H),V||W||j++)}this.availEdgeTiles=N,this.allTiles=B.getAll(),this.mapEdgeIsWater=0===j,this.minCrates=S.rules.crateRules.crateMinimum*S.gameOpts.humanPlayers.filter(S=>S.countryId!==F.OBS_COUNTRY_ID).length}[W.NotifyTick.onTick](S){for(var O of this.crates)O.ticksLeft--,O.ticksLeft<=0&&(S.unspawnObject(O.obj),O.obj.dispose());if(this.crates=this.crates.filter(S=>0<S.ticksLeft),this.randomCrateSpawn)for(let O=0;O<this.minCrates-this.crates.length&&this.spawnCrateAtRandom(this.allTiles,S);O++);}spawnCrateAtRandom(S,O){var B=this.chooseSpawnTile(S,O);if(B)return this.spawnRandomCrateAt(B,O)}spawnRandomCrateAt(S,O){if(this.canPlaceCrateOnTile(O,S)){var B=O.map.getTileZone(S,!0)===D.ZoneType.Water;if(B=this.choosePowerup(B,O.rules.powerups.powerups,O))return this.spawnCrateAt(S,B,O)}}spawnCrateAt(S,O,N){if(this.canPlaceCrateOnTile(N,S)){var j=N.map.getTileZone(S,!0)===D.ZoneType.Water,L=N.rules.crateRules;j=j?L.waterCrateImg:L.crateImg;let F=N.createObject(B.ObjectType.Overlay,j);return F.overlayId=N.rules.getOverlayId(j),F.value=0,N.spawnObject(F,S),L=60*L.crateRegen*_.GameSpeed.BASE_TICKS_PER_SECOND*(.5+1.5*N.generateRandom()),this.crates.push({obj:F,powerup:O,ticksLeft:L}),F}}chooseSpawnTile(S,O){return O.generateRandom()<(this.mapEdgeIsWater?1/3:2/3)&&this.availEdgeTiles.length&&(S=this.availEdgeTiles),this.chooseRandomTile(S,O)}chooseRandomTile(S,O){let B,N=0;for(;B=S[O.generateRandomInt(0,S.length-1)],N++,N<100&&!this.canPlaceCrateOnTile(O,B););if(100<=N){var j=O.map.tileOccupation.getEmptyTiles();if(!j.length)return;B=j[O.generateRandomInt(0,j.length-1)]}return B}canPlaceCrateOnTile(S,O){return S.map.mapBounds.isWithinBounds(O)&&!S.map.getGroundObjectsOnTile(O).length&&0<S.map.terrain.getPassableSpeed(O,V.SpeedType.Amphibious,!1,!1)&&O.terrainType!==N.TerrainType.Shore&&0===O.rampType}choosePowerup(S,O,B){if((O=S?O.filter(S=>S.waterAllowed):O).length){var N,j=O.reduce((S,O)=>S+O.probShares,0),L=B.generateRandomInt(0,j);let S=0;for(N of O)if(S+=N.probShares,L<S)return N}}peekInsideCrate(S){return this.crates.find(O=>O.obj===S)?.powerup.type}pickupCrate(S,O,B){let N=this.crates.find(S=>S.obj===O);if(N){this.crates.splice(this.crates.indexOf(N),1),B.unspawnObject(N.obj),N.obj.dispose();let O=this.grantPowerup(S,N.powerup,N.obj.tile,B);var L;return void 0!==O&&(S.owner.cratesPickedUp++,L=B.rules.powerups.powerups.find(S=>S.type===O),B.events.dispatch(new j.CratePickupEvent(L,S.owner,S,N.obj.tile))),this.randomCrateSpawn&&this.spawnCrateAtRandom(this.allTiles,B),O}}grantPowerup(S,O,N,j){let L=S.owner,D=!1;if(L.isCombatant()){if(O.type===H.PowerupType.Unit){let S;if(![...L.buildings].some(S=>S.rules.constructionYard)&&j.rules.crateRules.freeMCV){let O=j.rules.general.baseUnit;if(!L.getOwnedObjects(!0).some(S=>O.includes(S.name))&&L.credits>=[...j.rules.ai.buildPower,...j.rules.ai.buildRefinery].map(S=>j.rules.getBuilding(S)).filter(S=>S.aiBasePlanningSide===L.country.side).reduce((S,O)=>S+O.cost,0)){var F=O.find(S=>{let O=j.rules.getObject(S,B.ObjectType.Vehicle);return O.isAvailableTo(L.country)&&O.hasOwner(L.country)});if(!F)throw new Error("No suitable MCV found for player country "+L.country?.name);S=j.rules.getObject(F,B.ObjectType.Vehicle)}}if(S||(F=(F=j.rules.crateRules.unitCrateType)?j.rules.hasObject(F,B.ObjectType.Vehicle)?[j.rules.getObject(F,B.ObjectType.Vehicle)]:[]:[...j.rules.vehicleRules.values()].filter(S=>S.crateGoodie&&0<j.map.terrain.getPassableSpeed(N,S.speedType,!1,!1))).length&&(S=F[j.generateRandomInt(0,F.length-1)]),S){let O=j.createUnitForPlayer(S,L);var _=new U.RadialTileFinder(j.map.tiles,j.map.mapBounds,N,{width:1,height:1},0,3,S=>0<j.map.terrain.getPassableSpeed(S,O.rules.speedType,O.isInfantry(),!1)&&!j.map.terrain.findObstacles({tile:S,onBridge:void 0},O).length).getNextTile();_?(j.spawnObject(O,_),D=!0):(L.removeOwnedObject(O),O.dispose())}}else if(O.type===H.PowerupType.Money){if(!O.data)throw new Error("Money powerup missing data field");L.credits=Math.max(0,L.credits+Math.floor(Number(O.data)*(.55+2*j.generateRandom()*.45))),D=!0}else if(O.type===H.PowerupType.HealBase){var V;for(V of L.getOwnedObjects(!0))V.isDestroyed||V.healthTrait.healToFull(void 0,j);D=!0}else if(O.type===H.PowerupType.Reveal)j.mapShroudTrait.revealMap(L,j),D=!0;else if(O.type===H.PowerupType.Darkness)j.mapShroudTrait.resetShroud(L,j),D=!0;else if(O.type===H.PowerupType.Veteran){if(S.veteranTrait&&!S.veteranTrait.isMaxLevel()){D=!0;var W,ee=Number(O.data);for(W of this.getUnitsInCrateRadius(j,N,L))W.veteranTrait?.promote(ee,j)}}else if(O.type===H.PowerupType.Armor){if(1===S.crateBonuses.armor){D=!0;var te,re=Number(O.data);for(te of this.getUnitsInCrateRadius(j,N,L))1===te.crateBonuses.armor&&(te.crateBonuses.armor=re)}}else if(O.type===H.PowerupType.Firepower){if(1===S.crateBonuses.firepower){D=!0;var se,ne=Number(O.data);for(se of this.getUnitsInCrateRadius(j,N,L))1===se.crateBonuses.firepower&&(se.crateBonuses.firepower=ne)}}else if(O.type===H.PowerupType.Speed){if(1===S.crateBonuses.speed){D=!0;var ae,oe=Number(O.data);for(ae of this.getUnitsInCrateRadius(j,N,L))1===ae.crateBonuses.speed&&(ae.crateBonuses.speed=oe)}}else if(O.type===H.PowerupType.Cloak){if(!S.cloakableTrait)for(var le of(D=!0,this.getUnitsInCrateRadius(j,N,L)))le.cloakableTrait||(le.cloakableTrait=new $.CloakableTrait(le,j.rules.general.cloakDelay),j.addObjectTrait(le,le.cloakableTrait))}else if(O.type===H.PowerupType.ICBM){if(_=[...j.rules.superWeaponRules.values()].find(S=>S.type===z.SuperWeaponType.MultiMissile),_&&L.superWeaponsTrait&&!L.superWeaponsTrait.has(_.name)){let S=j.createSuperWeapon(_.name,L,!0);S.isGift=!0,L.superWeaponsTrait.add(S),D=!0}}else if(O.type===H.PowerupType.Invulnerability){var ce=[...j.rules.superWeaponRules.values()].find(S=>S.type===z.SuperWeaponType.IronCurtain);ce&&(j.traits.get(K.SuperWeaponsTrait).activateEffect(ce,L,j,N,void 0,!0),D=!0)}else if(O.type===H.PowerupType.Explosion||O.type===H.PowerupType.Napalm){D=!0;var he=Number(O.data);ce=O.type===H.PowerupType.Napalm?j.rules.combatDamage.flameDamage:j.rules.combatDamage.c4Warhead,new q.Warhead(j.rules.getWarhead(ce)).detonate(j,he,S.tile,S.tileElevation,S.position.worldPosition,S.zone,Q.CollisionType.None,j.createTarget(S,S.tile),{player:S.owner,weapon:void 0},ie.SpecialWarheadType.None,void 0,0)}else{if(O.type!==H.PowerupType.Tiberium)return void console.warn(`Unhandled powerup type "${H.PowerupType[O.type]}"`);{let S,O=new Z.RandomTileFinder(j.map.tiles,j.map.mapBounds,N,2,j,S=>J.TiberiumTrait.canBePlacedOn(S,j.map)),L=0;for(;L++<6&&(S=O.getNextTile());){var ue=Y.OreSpread.calculateOverlayId(X.OverlayTibType.Ore,S);if(void 0===ue)throw new Error("Expected an overlayId");let O=j.createObject(B.ObjectType.Overlay,j.rules.getOverlayName(ue));O.overlayId=ue,O.value=3,j.spawnObject(O,S),D=!0}}}return D?O.type:(he=j.rules.powerups.powerups.find(S=>S.type===H.PowerupType.Money&&0<S.probShares),he?this.grantPowerup(S,he,N,j):void 0)}}getUnitsInCrateRadius(S,O,B){let N=S.rules.crateRules.crateRadius,j=new L.RangeHelper(S.map.tileOccupation);return S.map.technosByTile.queryRange((new te.Box2).setFromCenterAndSize(new ee.Vector2(O.rx,O.ry),new ee.Vector2(N,N))).filter(S=>S.owner===B&&S.isUnit()&&j.tileDistance(S,O)<=N)}},S("CrateGeneratorTrait",re)}}}),System.register("game/trait/MapLightingTrait",["data/map/MapLighting","game/GameSpeed","util/event","game/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class{get onChange(){return this._onChange.asEvent()}constructor(S,O){this.mapLighting=new B.MapLighting,this._onChange=new j.EventDispatcher,this.ambientChangeRate=S.ambientChangeRate,this.ambientChangeStep=S.ambientChangeStep,O&&this.mapLighting.copy(O)}setAmbientChangeRate(S){this.ambientChangeRate=S}setAmbientChangeStep(S){this.ambientChangeStep=S}setTargetAmbientIntensity(S){this.targetAmbient=S}getAmbient(){return this.mapLighting}[L.NotifyTick.onTick](){var S;void 0!==this.targetAmbient&&(this.ambientUpdateTicks??(this.ambientUpdateTicks=Math.floor(60*N.GameSpeed.BASE_TICKS_PER_SECOND*this.ambientChangeRate)),this.ambientUpdateTicks<=0?(this.ambientUpdateTicks=void 0,S=this.mapLighting.ambient,(S=this.targetAmbient-S)?(S=Math.sign(S)*Math.min(this.ambientChangeStep,Math.abs(S)),this.mapLighting.ambient+=S,this._onChange.dispatch(this,this.mapLighting)):this.targetAmbient=void 0):this.ambientUpdateTicks--)}},S("MapLightingTrait",D)}}}),System.register("game/trait/MapRadiationTrait",["game/gameobject/infantry/StanceType","game/gameobject/unit/RangeHelper","game/map/tileFinder/RadialTileFinder","game/Warhead","util/event","util/math","game/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){U=class{get onChange(){return this._onChange.asEvent()}constructor(S){this.map=S,this.radSites=new Map,this.radLevelByTile=new Map,this._onChange=new D.EventDispatcher}getRadLevel(S){return this.radLevelByTile.get(S)}[_.NotifyTick.onTick](S){var O;this.radLevelByTile.size&&(O=S.rules.radiation,void 0===this.nextDamage?this.nextDamage=Math.max(0,O.radApplicationDelay-1):this.nextDamage<=0?(this.applyDamage(S),this.nextDamage=Math.max(0,O.radApplicationDelay)):this.nextDamage--,void 0===this.nextDecay?this.nextDecay=Math.max(0,O.radLevelDelay-1):this.nextDecay<=0?(this.applyDecay(Math.ceil(O.radLevelDelay/O.radDurationMultiple)),this.radLevelByTile.size?this.nextDecay=Math.max(0,O.radLevelDelay):this.nextDecay=void 0):this.nextDecay--)}applyDamage(S){let O=S.rules.radiation,N=new L.Warhead(S.rules.getWarhead(O.radSiteWarhead));this.radLevelByTile.forEach((j,L)=>{var D,F,_=Math.min(O.radLevelMax,j)*O.radLevelFactor;for(D of S.map.getGroundObjectsOnTile(L).filter(S=>S.isUnit()&&!(S.isInfantry()&&S.stance===B.StanceType.Paradrop&&1<S.tileElevation)))N.canDamage(D,L,D.zone)&&0<(F=N.computeDamage(_,D,S))&&N.inflictDamage(F,D,void 0,S,!0)})}applyDecay(S){var O=new Set(this.radLevelByTile.keys());this.radLevelByTile.clear(),this.radSites.forEach(({radLevel:O,radius:B},N)=>{var j=O-S;j<=0?this.radSites.delete(N):(this.radSites.set(N,{radLevel:j,radius:B}),this.setRadLevelAround(N,B,j))}),this._onChange.dispatch(this,O)}createRadSite(S,O,B){var N;(O-=this.radSites.get(S)?.radLevel??0)<=0||(this.radSites.set(S,{radLevel:(this.radSites.get(S)?.radLevel??0)+O,radius:B}),(N=this.setRadLevelAround(S,B,O)).size&&this._onChange.dispatch(this,N))}setRadLevelAround(S,O,B){let L=new N.RangeHelper(this.map.tileOccupation),D=new j.RadialTileFinder(this.map.tiles,this.map.mapBounds,S,{width:1,height:1},0,O,S=>!!S,!1);var _;let U=new Set;for(;_=D.getNextTile();){var H=L.tileDistance(S,_);H<=O&&(H=Math.ceil(F.lerp(B,0*B,H/O)),this.radLevelByTile.set(_,Math.min(1e3,(this.radLevelByTile.get(_)??0)+H)),U.add(_))}return U}getRadSiteLevel(S){return this.radSites.get(S)?.radLevel}},S("MapRadiationTrait",U)}}}),System.register("game/trait/MapShroudTrait",["game/map/MapShroud","game/trait/interface/NotifyTick","game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifyAllianceChange","util/typeGuard","game/trait/interface/NotifySpawn","game/trait/interface/NotifyUnspawn","game/trait/RadarTrait","game/rules/general/RadarRules","engine/type/ObjectType","game/trait/interface/NotifyPower","game/trait/interface/NotifyElevationChange"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S}],execute:function(){K=class{constructor(S,O){this.map=S,this.alliances=O,this.shroudByPlayer=new Map,this.revealedToAll=new Set,this.gapGenerators=new Set,this.handleTileOccupationUpdate=({object:S,type:O})=>{if("removed"!==O&&S.isTechno()){var B,N=S.owner;for(B of[N,...this.alliances.getAllies(N)])this.shroudByPlayer.get(B)?.revealFrom(S)}}}getPlayerShroud(S){return this.shroudByPlayer.get(S)}init(S){S.map.tileOccupation.onChange.subscribe(this.handleTileOccupationUpdate);let O=(new B.MapShroud).fromTiles(this.map.tiles);for(var N of S.getCombatants()){let B=O.clone();this.shroudByPlayer.set(N,B),this.revealObjects(B,N,S),B.update()}}[z.NotifyElevationChange.onElevationChange](S,O,B){if(Math.floor(S.tileElevation)!==Math.floor(B)){var N,j=S.owner;for(N of[j,...this.alliances.getAllies(j)])this.shroudByPlayer.get(N)?.revealFrom(S)}}[N.NotifyTick.onTick](S){for(var[O,B]of this.shroudByPlayer)O.defeated&&!O.isObserver?this.shroudByPlayer.delete(O):B.update()}[j.NotifyOwnerChange.onChange](S,O,B){if(S.isBuilding()&&S.rules.spySat&&(this.revealMap(S.owner,B),O.getOwnedObjectsByType(V.ObjectType.Building).find(S=>S.rules.spySat)||this.resetShroud(O,B)),S.isSpawned)for(var N of[S.owner,...B.alliances.getAllies(S.owner)])this.shroudByPlayer.get(N)?.revealFrom(S)}[L.NotifyAllianceChange.onChange](S,O,B){if(O){let O=this.getPlayerShroud(S.players.first);var N,j,L=B.alliances.getAllies(S.players.first).map(S=>this.getPlayerShroud(S)).filter(D.isNotNullOrUndefined);for(N of L)O.merge(N);for(j of(O.invalidateFull(),L))j.copy(O),j.invalidateFull()}}[F.NotifySpawn.onSpawn](S,O){if(S.isBuilding()){if(S.rules.spySat&&this.revealMap(S.owner,O),S.rules.revealToAll)for(var B of(this.revealedToAll.add(S),O.getCombatants()))B===S.owner||O.alliances.areAllied(S.owner,B)||(this.shroudByPlayer.get(B)?.revealObject(S),O.traits.get(U.RadarTrait).addEventForPlayer(H.RadarEventType.EnemyObjectSensed,B,S.centerTile,O));S.gapGeneratorTrait&&this.gapGenerators.add(S)}}[_.NotifyUnspawn.onUnspawn](S,O){S.isBuilding()&&(S.rules.spySat&&(S.owner.getOwnedObjectsByType(V.ObjectType.Building).find(S=>S.rules.spySat)||this.resetShroud(S.owner,O)),S.rules.revealToAll&&this.revealedToAll.delete(S),S.gapGeneratorTrait&&this.gapGenerators.delete(S))}[W.NotifyPower.onPowerLow](S,O){this.updateGaps(O,S)}[W.NotifyPower.onPowerRestore](S,O){this.updateGaps(O,S)}[W.NotifyPower.onPowerChange](S,O){}revealMap(S,O){this.shroudByPlayer.get(S)?.revealAll(),this.markOwnGapTiles(O,S),this.updateGaps(O)}resetShroud(S,O){let B=this.shroudByPlayer.get(S);B&&(B.reset(),this.markOwnGapTiles(O,S),this.revealObjects(B,S,O))}revealObjects(S,O,B){var N;for(N of[...O.getOwnedObjects(),...B.alliances.getAllies(O).map(S=>S.getOwnedObjects()).flat()])S.revealFrom(N);this.revealedToAll.forEach(O=>S.revealObject(O))}updateGaps(S,O){for(var B of this.gapGenerators)O&&B.owner!==O||B.gapGeneratorTrait.update(B,S)}markOwnGapTiles(S,O){for(var N of this.gapGenerators)N.owner!==O&&!S.alliances.areAllied(N.owner,O)||this.getPlayerShroud(O)?.toggleFlagsAround(N.tile,N.gapGeneratorTrait.radiusTiles,B.ShroudFlag.Darken,!0)}dispose(){this.map.tileOccupation.onChange.unsubscribe(this.handleTileOccupationUpdate)}},S("MapShroudTrait",K)}}}),System.register("game/trait/PowerTrait",["game/trait/interface/NotifySpawn","game/trait/interface/NotifyHealthChange","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifyWarpChange","game/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class{[B.NotifySpawn.onSpawn](S,O){S.isTechno()&&S.rules.power&&!this.isCapturablePower(S,S.owner)&&S.owner.powerTrait?.updateFrom(S,"add",O)}[j.NotifyUnspawn.onUnspawn](S,O){S.isTechno()&&S.rules.power&&!S.warpedOutTrait.isActive()&&!this.isCapturablePower(S,S.owner)&&S.owner.powerTrait?.updateFrom(S,"remove",O)}[N.NotifyHealthChange.onChange](S,O){S.isTechno()&&S.rules.power&&!S.warpedOutTrait.isActive()&&!this.isCapturablePower(S,S.owner)&&S.owner.powerTrait?.updateFrom(S,"update",O)}[L.NotifyOwnerChange.onChange](S,O,B){S.rules.power&&!S.warpedOutTrait.isActive()&&(this.isCapturablePower(S,O)||O.powerTrait?.updateFrom(S,"remove",B),this.isCapturablePower(S,S.owner)||S.owner.powerTrait?.updateFrom(S,"add",B))}[D.NotifyWarpChange.onChange](S,O,B){S.rules.power&&!this.isCapturablePower(S,S.owner)&&S.owner.powerTrait?.updateFrom(S,B?"remove":"add",O)}[F.NotifyTick.onTick](S){for(var O of S.getCombatants())O.powerTrait.updateBlackout(S)}isCapturablePower(S,O){return 0<S.rules.power&&O.isNeutral&&S.rules.needsEngineer}},S("PowerTrait",_)}}}),System.register("game/trait/ProductionTrait",["game/trait/interface/NotifyTick","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyOwnerChange","game/player/production/ProductionQueue","game/event/InsufficientFundsEvent","game/rules/TechnoRules","game/trait/interface/NotifySpawn","game/trait/interface/NotifyPower","game/player/trait/PowerTrait","util/math","game/GameSpeed","engine/type/ObjectType","game/math/GameMath"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S}],execute:function(){$=class{constructor(S,O){this.rules=S,this.speedCheat=O,this.availableObjectRules=new Set;var B=60*S.general.buildSpeed*W.GameSpeed.BASE_TICKS_PER_SECOND;this.baseBuildSpeed=1/(B/1e3),[...S.buildingRules.values(),...S.infantryRules.values(),...S.vehicleRules.values(),...S.aircraftRules.values()].forEach(S=>{S.owner.length&&this.availableObjectRules.add(S)})}[B.NotifyTick.onTick](S){for(var O of S.getCombatants())for(var B of O.production.getAllQueues())this.tickQueue(B,O,S)}[_.NotifySpawn.onSpawn](S,O){var B;S.isBuilding()&&S.owner.production?(B=S.rules.factory)&&(S.owner.production.getPrimaryFactory(B)||S.owner.production.setPrimaryFactory(S),S.owner.production.incrementFactoryCount(B),B===F.FactoryType.AircraftType&&this.updateAircraftQueueMaxSize(S.owner,O)):S.isAircraft()&&S.owner.production&&this.rules.general.padAircraft.includes(S.name)&&this.updateAircraftQueueMaxSize(S.owner,O)}[N.NotifyUnspawn.onUnspawn](S,O){var B;S.isBuilding()&&S.owner.production?(this.ensurePrerequisites(S.owner),(B=S.rules.factory)&&(S.owner.production.getPrimaryFactory(B)===S&&S.owner.production.crownPrimaryFactoryHeir(B),S.owner.production.decrementFactoryCount(B),B===F.FactoryType.AircraftType&&this.updateAircraftQueueMaxSize(S.owner,O))):S.isAircraft()&&S.owner.production&&this.rules.general.padAircraft.includes(S.name)&&this.updateAircraftQueueMaxSize(S.owner,O)}[j.NotifyOwnerChange.onChange](S,O,B){var N;S.isBuilding()?(this.ensurePrerequisites(O),(N=S.rules.factory)&&(O.production?.getPrimaryFactory(N)===S&&O.production.crownPrimaryFactoryHeir(N),S.owner.production&&!S.owner.production.getPrimaryFactory(N)&&S.owner.production.setPrimaryFactory(S),O.production?.decrementFactoryCount(N),S.owner.production?.incrementFactoryCount(N),N===F.FactoryType.AircraftType&&(this.updateAircraftQueueMaxSize(S.owner,B),this.updateAircraftQueueMaxSize(O,B)))):S.isAircraft()&&this.rules.general.padAircraft.includes(S.name)&&(this.updateAircraftQueueMaxSize(S.owner,B),this.updateAircraftQueueMaxSize(O,B))}[U.NotifyPower.onPowerLow](S){S.production&&(S.production.buildSpeedModifier=this.computeLowPowerBuildSpeedModifier(S.powerTrait.power,S.powerTrait.drain))}[U.NotifyPower.onPowerRestore](S){S.production&&(S.production.buildSpeedModifier=1)}[U.NotifyPower.onPowerChange](S){S.powerTrait?.level===H.PowerLevel.Low&&S.production&&(S.production.buildSpeedModifier=this.computeLowPowerBuildSpeedModifier(S.powerTrait.power,S.powerTrait.drain))}computeLowPowerBuildSpeedModifier(S,O){var B=1-Math.min(1,S/O),N=this.rules.general;return B=.3*N.lowPowerPenaltyModifier*B/.15,V.clamp(1-B,N.minLowPowerProductionSpeed,N.maxLowPowerProductionSpeed)}updateAircraftQueueMaxSize(S,O){S.production&&O.afterTick(()=>{var B=[...S.buildings].filter(S=>S.helipadTrait).reduce((S,O)=>S+O.dockTrait.numberOfDocks,0),N=S.getOwnedObjectsByType(z.ObjectType.Aircraft,!0).filter(S=>O.rules.general.padAircraft.includes(S.name)).length;S.production.getQueueForFactory(F.FactoryType.AircraftType).maxSize=Math.max(0,B-N)})}tickQueue(S,O,B){if(S.status===L.QueueStatus.Active){let H=!1,W=S.getFirst();var N,j=O.production.getFactoryTypeForQueueType(S.type),F=O.production.getFactoryCount(j),_=O.production.buildSpeedModifier,U=1/K.GameMath.pow(this.rules.general.multipleFactory,F-1);j=W.rules.wall?1/this.rules.general.wallBuildSpeedCoefficient:1,F=this.baseBuildSpeed*_*U*j,U=(_=W.creditsEach)&&!this.speedCheat.value?V.floorTo(_/F*W.rules.buildTimeMultiplier,54):54,U=Math.max(54,U),j=O.credits,F=W.creditsEach-W.creditsSpent,0<(F=Math.min(O.credits,_/U+W.creditsSpentLeftover,F))?(N=Math.floor(F),W.creditsSpentLeftover=F-N,N&&(W.creditsSpent+=N,W.progress=W.creditsSpent/W.creditsEach,O.credits-=N,H=!0)):W.creditsEach||(N=W.progress*U,W.progress=Math.min(1,(1+N)/U),H=!0),H&&1===W.progress&&(S.status=L.QueueStatus.Ready),0<j&&!O.credits&&B.events.dispatch(new D.InsufficientFundsEvent(O)),H&&S.notifyUpdated()}}ensurePrerequisites(S){if(S.production)for(var O of S.production.getAllQueues()){var B;for(B of O.getAll().map(S=>({rules:S.rules,quantity:S.quantity,creditsSpent:S.creditsSpent})))S.production.isAvailableForProduction(B.rules)||(O.pop(B.rules,B.quantity),S.credits+=B.creditsSpent)}}getAvailableObjects(){return[...this.availableObjectRules]}},S("ProductionTrait",$)}}}),System.register("game/trait/RadarTrait",["game/trait/interface/NotifySpawn","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyPower","game/player/trait/PowerTrait","game/event/RadarOnOffEvent","game/trait/interface/NotifyOwnerChange","game/gameobject/unit/RangeHelper","game/rules/general/RadarRules","game/event/RadarEvent","game/trait/interface/NotifyAttack","game/trait/interface/NotifyWarpChange","game/trait/interface/NotifySuperWeaponActivate","game/type/SuperWeaponType","game/trait/interface/NotifySuperWeaponDeactivate"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S}],execute:function(){q=class{constructor(){this.activeLightningStrikes=new Map}[B.NotifySpawn.onSpawn](S,O){S.isBuilding()&&S.rules.radar&&this.updateRadarForPlayer(S.owner,O)}[N.NotifyUnspawn.onUnspawn](S,O){S.isBuilding()&&S.rules.radar&&this.updateRadarForPlayer(S.owner,O)}[j.NotifyPower.onPowerLow](S,O){this.updateRadarForPlayer(S,O)}[j.NotifyPower.onPowerRestore](S,O){this.updateRadarForPlayer(S,O)}[j.NotifyPower.onPowerChange](){}[F.NotifyOwnerChange.onChange](S,O,B){S.rules.radar&&(this.updateRadarForPlayer(O,B),this.updateRadarForPlayer(S.owner,B))}[W.NotifyWarpChange.onChange](S,O){S.rules.radar&&this.updateRadarForPlayer(S.owner,O)}[z.NotifySuperWeaponActivate.onActivate](S,O,B){if(S===K.SuperWeaponType.LightningStorm)for(var N of(this.activeLightningStrikes.set(O,(this.activeLightningStrikes.get(O)??0)+1),B.getCombatants()))N===O||B.alliances.areAllied(N,O)||this.updateRadarForPlayer(N,B)}[$.NotifySuperWeaponDeactivate.onDeactivate](S,O,B){if(S===K.SuperWeaponType.LightningStorm){var N=(this.activeLightningStrikes.get(O)??0)-1;if(0<N?this.activeLightningStrikes.set(O,N):this.activeLightningStrikes.delete(O),N<=0)for(var j of B.getCombatants())this.updateRadarForPlayer(j,B)}}updateRadarForPlayer(S,O){var B,N;S.radarTrait&&(B=S.radarTrait?.isDisabled(),N=![...S.buildings].find(S=>S.rules.radar&&!S.warpedOutTrait.isActive())||S.powerTrait.level===L.PowerLevel.Low||[...this.activeLightningStrikes.entries()].some(([B,N])=>N&&B!==S&&!O.alliances.areAllied(B,S)),S.radarTrait.setDisabled(N),B!==N&&O.events.dispatch(new D.RadarOnOffEvent(S,!N)))}[V.NotifyAttack.onAttack](S,O,B){S.isTechno()&&(!S.isBuilding()||S.rules.canBeOccupied||S.rules.needsEngineer?S.isVehicle()&&S.harvesterTrait&&this.addEventForPlayer(U.RadarEventType.HarvesterUnderAttack,S.owner,S.tile,B):this.addEventForPlayer(U.RadarEventType.BaseUnderAttack,S.owner,S.tile,B))}addEventForPlayer(S,O,B,N){let j=O.radarTrait;if(j){let L=N.rules.general.radar;j.activeEvents=j.activeEvents.filter(S=>N.currentTick-S.startTick<L.getEventDuration(S.type));let D=new _.RangeHelper(N.map.tileOccupation);j.activeEvents.find(O=>O.type===S&&D.isInTileRange(B,O.tile,0,L.getEventSuppresionDistance(O.type)))||(j.activeEvents.push({startTick:N.currentTick,tile:B,type:S}),N.events.dispatch(new H.RadarEvent(O,S,B)))}}},S("RadarTrait",q)}}}),System.register("game/trait/SellTrait",["game/event/ObjectSellEvent","game/gameobject/trait/interface/NotifySell"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("SellTrait",class{constructor(S,O){this.game=S,this.generalRules=O}sell(S){if(!S.isBuilding()||!S.rules.unsellable){let O=this.computeRefundValue(S);O&&(S.rules.wall&&(O=0),S.traits.filter(N.NotifySell).forEach(O=>{O[N.NotifySell.onSell](S,this.game)}),S.isBuilding()?this.game.getConstructionWorker(S.owner).unplace(S,()=>this.afterObjectUnspawned(S,O)):(this.game.unspawnObject(S),this.afterObjectUnspawned(S,O)))}}afterObjectUnspawned(S,O){S.owner.credits+=O,this.game.events.dispatch(new B.ObjectSellEvent(S)),S.dispose()}computeRefundValue(S){let O=0;return 0<S.rules.soylent?O=S.rules.soylent:S.rules.cost&&(O=S.purchaseValue,S.owner.isAi||(O=Math.floor(O*this.generalRules.refundPercent))),O}computePurchaseValue(S,O){return S.cost}dispose(){this.game=void 0}})}}}),System.register("game/trait/SharedDetectCloakTrait",["game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifySpawn","game/trait/interface/NotifyTileChange","game/trait/interface/NotifyUnspawn","game/gameobject/unit/RangeHelper","game/trait/interface/NotifyPower","game/trait/interface/NotifyTick","game/trait/RadarTrait","game/rules/general/RadarRules","game/trait/interface/NotifyObjectTraitAdd","game/gameobject/trait/CloakableTrait","game/gameobject/trait/SensorsTrait","game/math/Vector2","game/math/Box2"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S}],execute:function(){q=class{constructor(){this.detectors=new Set}[N.NotifySpawn.onSpawn](S,O){this.isGlobalDetector(S)&&(this.detectors.add(S),this.updateAroundDetector(S,O)),this.isCloakable(S)&&this.detect(S,O)}[L.NotifyUnspawn.onUnspawn](S,O){S.isTechno()&&this.isGlobalDetector(S)&&this.detectors.delete(S)}[B.NotifyOwnerChange.onChange](S,O,B){this.isGlobalDetector(S)&&this.updateAroundDetector(S,B),this.isCloakable(S)&&this.detect(S,B)}[j.NotifyTileChange.onTileChange](S,O,B){this.isGlobalDetector(S)&&this.updateAroundDetector(S,O),this.isCloakable(S)&&this.detect(S,O)}[V.NotifyObjectTraitAdd.onAdd](S,O,B){S.isTechno()&&(O instanceof W.CloakableTrait?this.isCloakable(S)&&this.detect(S,B):O instanceof z.SensorsTrait&&this.isGlobalDetector(S)&&this.updateAroundDetector(S,B))}[F.NotifyPower.onPowerLow](S,O){}[F.NotifyPower.onPowerRestore](S,O){var B=[...this.detectors].filter(O=>O.owner===S&&O.isBuilding()&&O.poweredTrait);this.updateAroundDetectors(B,O)}[F.NotifyPower.onPowerChange](S,O){}[_.NotifyTick.onTick](S){for(var O of S.getCombatants()){var B;for(B of O.getOwnedObjects())B.cloakableTrait&&!B.cloakableTrait.isCloaked()&&this.detect(B,S)}}updateAroundDetectors(S,O){let B=new Set;for(var N of S)for(var j of this.findTechnosAroundDetector(N,O))B.add(j);for(var L of B)this.isCloakable(L)&&this.detect(L,O)}updateAroundDetector(S,O){var B;for(B of this.findTechnosAroundDetector(S,O))this.isCloakable(B)&&this.detect(B,O)}findTechnosAroundDetector(S,O){var B=S.getFoundation(),N=Math.max(B.width,B.height);return B=S.rules.sensorsSight+N,N=new K.Vector2(S.tile.rx,S.tile.ry).addScalar(-B),B=new K.Vector2(S.tile.rx,S.tile.ry).addScalar(B),O.map.technosByTile.queryRange(new $.Box2(N,B))}detect(S,O){let B=new D.RangeHelper(O.map.tileOccupation);for(var N of this.detectors)if(!O.areFriendly(N,S)){var j=N.rules.sensorsSight;if((!N.isBuilding()||!N.poweredTrait||N.poweredTrait.isPoweredOn())&&B.tileDistance(S,N.tile)<=j){if(j=S.cloakableTrait?.isCloaked(),S.cloakableTrait.uncloak(O),j)for(var L of[N.owner,...O.alliances.getAllies(N.owner)])O.traits.get(U.RadarTrait).addEventForPlayer(H.RadarEventType.GenericNonCombat,L,S.tile,O);break}}}isGlobalDetector(S){return!(!S.isTechno()||!S.sensorsTrait&&!S.rules.sensorArray||!S.rules.sensorsSight)}isCloakable(S){return S.isTechno()&&!!S.cloakableTrait}},S("SharedDetectCloakTrait",q)}}}),System.register("game/trait/SharedDetectDisguiseTrait",["game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifySpawn","game/trait/interface/NotifyTileChange","game/trait/interface/NotifyUnspawn","game/gameobject/unit/RangeHelper","game/trait/interface/NotifyPower","game/math/Vector2","game/math/Box2"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){H=class{constructor(){this.detectors=new Set}[N.NotifySpawn.onSpawn](S,O){this.isGlobalDetector(S)&&(this.detectors.add(S),this.updateAroundDetector(S,O)),this.isDisguisable(S)&&this.detect(S,O)}[L.NotifyUnspawn.onUnspawn](S,O){S.isTechno()&&(this.isGlobalDetector(S)&&(this.detectors.delete(S),this.updateAroundDetector(S,O)),this.isDisguisable(S)&&this.undetect(S,O))}[B.NotifyOwnerChange.onChange](S,O,B){this.isGlobalDetector(S)&&this.updateAroundDetector(S,B),this.isDisguisable(S)&&(this.undetect(S,B),this.detect(S,B))}[j.NotifyTileChange.onTileChange](S,O,B){this.isGlobalDetector(S)&&(this.updateAroundDetector(S,O,B),this.updateAroundDetector(S,O)),this.isDisguisable(S)&&(this.undetect(S,O),this.detect(S,O))}[F.NotifyPower.onPowerLow](S,O){var B=[...this.detectors].filter(O=>O.owner===S&&O.isBuilding()&&O.poweredTrait&&!O.poweredTrait.isPoweredOn());this.updateAroundDetectors(B,O)}[F.NotifyPower.onPowerRestore](S,O){var B=[...this.detectors].filter(O=>O.owner===S&&O.isBuilding()&&O.poweredTrait);this.updateAroundDetectors(B,O)}[F.NotifyPower.onPowerChange](S,O){}updateAroundDetectors(S,O){let B=new Set;for(var N of S)for(var j of this.findTechnosAroundDetector(N,O,N.tile))B.add(j);for(var L of B)this.isDisguisable(L)&&(this.undetect(L,O),this.detect(L,O))}updateAroundDetector(S,O,B=S.tile){var N;for(N of this.findTechnosAroundDetector(S,O,B))this.isDisguisable(N)&&(this.undetect(N,O),this.detect(N,O))}findTechnosAroundDetector(S,O,B){var N=S.getFoundation(),j=Math.max(N.width,N.height);return N=S.rules.detectDisguiseRange+j,j=new _.Vector2(B.rx,B.ry).addScalar(-N),N=new _.Vector2(B.rx,B.ry).addScalar(N),O.map.technosByTile.queryRange(new U.Box2(j,N))}detect(S,O){let B=new Set,N=new D.RangeHelper(O.map.tileOccupation);for(var j of this.detectors)if(!O.areFriendly(j,S)){var L=j.owner,F=j.rules.detectDisguiseRange;if(!B.has(L)&&(!j.isBuilding()||!j.poweredTrait||j.poweredTrait.isPoweredOn())&&N.tileDistance(S,j.tile)<=F)for(var _ of[L,...O.alliances.getAllies(L)])B.add(_)}for(var U of B)U.sharedDetectDisguiseTrait?.add(S)}undetect(S,O){for(var B of O.getCombatants())B.sharedDetectDisguiseTrait?.delete(S)}isGlobalDetector(S){return!(!S.isTechno()||!S.rules.detectDisguiseRange)}isDisguisable(S){return!(!S.isInfantry()&&!S.isVehicle()||!S.disguiseTrait)}},S("SharedDetectDisguiseTrait",H)}}}),System.register("game/trait/StalemateDetectTrait",["game/event/StalemateDetectEvent","game/GameSpeed","game/trait/interface/NotifyDestroy","game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifyPlaceBuilding","game/trait/interface/NotifyProduceUnit","game/trait/interface/NotifyTick"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){U=class e{constructor(){this.stale=!1,this.allPlayersCredits=new Map,this.resetCountdown()}isStale(){return this.stale}getCountdownTicks(){return this.countdownTicks}resetCountdown(){this.countdownTicks=Math.floor(60*e.graceMinutes*N.GameSpeed.BASE_TICKS_PER_SECOND)}clearStale(){this.stale=!1,this.resetCountdown()}[_.NotifyTick.onTick](S){for(var O of(0<this.countdownTicks?this.countdownTicks--:this.stale||(this.stale=!0,this.resetCountdown(),S.events.dispatch(new B.StalemateDetectEvent)),S.getCombatants())){var N=this.allPlayersCredits.get(O);N!==O.credits&&(this.allPlayersCredits.set(O,O.credits),O.credits>(N??0)&&O.production.hasAnyFactory()&&this.clearStale())}}[F.NotifyProduceUnit.onProduce](){this.clearStale()}[D.NotifyPlaceBuilding.onPlace](S){S.wallTrait||this.clearStale()}[j.NotifyDestroy.onDestroy](S,O,B){!S.isBuilding()||S.owner.isNeutral||S.wallTrait||S.rules.insignificant||S.owner.defeated&&this.stale||B?.obj&&O.areFriendly(S,B.obj)||this.clearStale()}[L.NotifyOwnerChange.onChange](S,O,B){S.isBuilding()&&!O.isNeutral&&(B.alliances.areAllied(S.owner,O)||this.clearStale())}},S("StalemateDetectTrait",U),U.graceMinutes=10}}}),System.register("game/trait/SuperWeaponsTrait",["game/trait/interface/NotifyWarpChange","game/SuperWeapon","game/superweapon/SuperWeaponEffect","game/trait/interface/NotifyPower","game/trait/interface/NotifyTick","game/type/SuperWeaponType","game/trait/interface/NotifySuperWeaponActivate","game/event/SuperWeaponActivateEvent","game/superweapon/ParadropEffect","game/superweapon/NukeEffect","game/superweapon/LightningStormEffect","game/superweapon/IronCurtainEffect","game/superweapon/ChronoSphereEffect","game/trait/interface/NotifySuperWeaponDeactivate","engine/type/ObjectType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S}],execute:function(){Q=class{constructor(){this.effects=[]}[D.NotifyTick.onTick](S){for(var O of S.getCombatants()){var B;for(B of O.superWeaponsTrait.getAll())B.update(S)}for(let O of this.effects)O.status===j.EffectStatus.NotStarted&&(O.onStart(S),O.status=j.EffectStatus.Running),O.onTick(S)&&(O.status=j.EffectStatus.Finished,S.traits.filter($.NotifySuperWeaponDeactivate).forEach(B=>{B[$.NotifySuperWeaponDeactivate.onDeactivate](O.type,O.owner,S)}));this.effects=this.effects.filter(S=>S.status!==j.EffectStatus.Finished)}[L.NotifyPower.onPowerLow](S,O){S.superWeaponsTrait?.getAll()?.filter(S=>S.rules.isPowered).forEach(S=>{this.updateTimer(S,!1)})}[L.NotifyPower.onPowerRestore](S,O){S.superWeaponsTrait?.getAll()?.filter(S=>S.rules.isPowered).forEach(S=>{this.updateTimer(S,!0)})}[L.NotifyPower.onPowerChange](S,O){}[B.NotifyWarpChange.onChange](S,O){var B;S.owner.powerTrait&&S.isBuilding()&&S.superWeaponTrait&&(B=S.superWeaponTrait.getSuperWeapon(S))&&this.updateTimer(B,!S.owner.powerTrait.isLowPower())}updateTimer(S,O){var B=this.superWeaponHasValidBuilding(S);O&&B?S.resumeTimer():S.pauseTimer()}superWeaponHasValidBuilding(S){return[...S.owner.buildings].find(O=>!(O.superWeaponTrait?.getSuperWeapon(O)!==S||O.warpedOutTrait.isActive()&&S.rules.isPowered))}addEffect(S){this.effects.push(S)}activateSuperWeapon(S,O,B,j,L){let D=O.superWeaponsTrait?.getAll().find(O=>O.rules.type===S);if(D&&D.status===N.SuperWeaponStatus.Ready){if(D.oneTimeOnly)for(var F of(O.superWeaponsTrait.remove(D.name),O.buildings))F.rules.superWeapon===D.name&&F.superWeaponTrait&&F.superWeaponTrait.addSuperWeaponToPlayerIfNeeded(O,B);else D.resetTimer();this.activateEffect(D.rules,O,B,j,L)}}activateEffect(S,O,B,N,j,L=!1){const D=S.type;if(void 0!==D){let J=[];switch(D){case F.SuperWeaponType.AmerParaDrop:for(var[$,Q]of B.rules.general.paradrop.amerParaDrop.entries())B.rules.hasObject(Q.inf,q.ObjectType.Infantry)?J.push(new H.ParadropEffect(D,O,N,Q,$)):console.warn(`Can't paradrop unknown infantry type "${Q.inf}"`);break;case F.SuperWeaponType.ParaDrop:{let S=B.rules.general.paradrop.getParadropSquads(O.country.side);for(var[Z,Y]of S.entries())B.rules.hasObject(Y.inf,q.ObjectType.Infantry)?J.push(new H.ParadropEffect(D,O,N,Y,Z)):console.warn(`Can't paradrop unknown infantry type "${Y.inf}"`);break}case F.SuperWeaponType.MultiMissile:if(!S.weaponType)throw new Error("Missing WeaponType in super weapon rules");J.push(new V.NukeEffect(D,O,N,S.weaponType));break;case F.SuperWeaponType.LightningStorm:J.push(new W.LightningStormEffect(D,O,N));break;case F.SuperWeaponType.IronCurtain:J.push(new z.IronCurtainEffect(D,O,N));break;case F.SuperWeaponType.ChronoSphere:if(!j)throw new Error("Missing tile2 action param");J.push(new K.ChronoSphereEffect(D,O,N,j))}for(var X of J)this.addEffect(X);B.traits.filter(_.NotifySuperWeaponActivate).forEach(S=>{S[_.NotifySuperWeaponActivate.onActivate](D,O,B,N,j)}),B.events.dispatch(new U.SuperWeaponActivateEvent(D,O,N,j,L))}}},S("SuperWeaponsTrait",Q)}}}),System.register("game/trait/interface/NotifyAllianceChange",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyAllianceChange",B={})).onChange=Symbol()}}}),System.register("game/trait/interface/NotifyAttack",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyAttack",B={})).onAttack=Symbol()}}}),System.register("game/trait/interface/NotifyDestroy",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyDestroy",B={})).onDestroy=Symbol()}}}),System.register("game/trait/interface/NotifyElevationChange",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyElevationChange",B={})).onElevationChange=Symbol()}}}),System.register("game/trait/interface/NotifyHealthChange",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyHealthChange",B={})).onChange=Symbol()}}}),System.register("game/trait/interface/NotifyObjectTraitAdd",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyObjectTraitAdd",B={})).onAdd=Symbol()}}}),System.register("game/trait/interface/NotifyOwnerChange",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyOwnerChange",B={})).onChange=Symbol()}}}),System.register("game/trait/interface/NotifyPlaceBuilding",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyPlaceBuilding",B={})).onPlace=Symbol()}}}),System.register("game/trait/interface/NotifyPower",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("NotifyPower",B={})).onPowerLow=Symbol(),O.onPowerRestore=Symbol(),O.onPowerChange=Symbol()}}}),System.register("game/trait/interface/NotifyProduceUnit",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyProduceUnit",B={})).onProduce=Symbol()}}}),System.register("game/trait/interface/NotifySpawn",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifySpawn",B={})).onSpawn=Symbol()}}}),System.register("game/trait/interface/NotifySuperWeaponActivate",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifySuperWeaponActivate",B={})).onActivate=Symbol()}}}),System.register("game/trait/interface/NotifySuperWeaponDeactivate",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifySuperWeaponDeactivate",B={})).onDeactivate=Symbol()}}}),System.register("game/trait/interface/NotifyTargetDestroy",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyTargetDestroy",B={})).onDestroy=Symbol()}}}),System.register("game/trait/interface/NotifyTick",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyTick",B={})).onTick=Symbol()}}}),System.register("game/trait/interface/NotifyTileChange",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyTileChange",B={})).onTileChange=Symbol()}}}),System.register("game/trait/interface/NotifyUnspawn",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyUnspawn",B={})).onUnspawn=Symbol()}}}),System.register("game/trait/interface/NotifyWarpChange",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){(B||S("NotifyWarpChange",B={})).onChange=Symbol()}}}),System.register("game/trigger/TriggerCondition",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("TriggerCondition",class{constructor(S,O){this.event=S,this.trigger=O,this.blocking=!1,this.targets=[]}init(S){var O=S.getAllPlayers().find(S=>S.country?.name===this.trigger.houseName);O&&(this.player=O)}setTargets(S){this.targets=S}reset(){}getDebugName(){return`${this.event.triggerId}[${this.event.eventIndex}] (${this.trigger.name}).`}})}}}),System.register("game/trigger/TriggerConditionFactory",["data/map/trigger/TriggerEventType","engine/type/ObjectType","game/trigger/condition/AmbientLightCondition","game/trigger/condition/AnyEventCondition","game/trigger/condition/AttackedByAnyCondition","game/trigger/condition/AttackedByHouseCondition","game/trigger/condition/BuildingExistsCondition","game/trigger/condition/BuildObjectTypeCondition","game/trigger/condition/ComesNearWaypointCondition","game/trigger/condition/CreditsBelowCondition","game/trigger/condition/CreditsExceedCondition","game/trigger/condition/CrossHorizLineCondition","game/trigger/condition/CrossVertLineCondition","game/trigger/condition/DestroyedAllBuildingsCondition","game/trigger/condition/DestroyedAllCondition","game/trigger/condition/DestroyedAllUnitsCondition","game/trigger/condition/DestroyedAllUnitsLandCondition","game/trigger/condition/DestroyedAllUnitsNavalCondition","game/trigger/condition/DestroyedBridgeCondition","game/trigger/condition/DestroyedBuildingsCondition","game/trigger/condition/DestroyedByAnyCondition","game/trigger/condition/DestroyedOrCapturedCondition","game/trigger/condition/DestroyedOrCapturedOrInfiltratedCondition","game/trigger/condition/DestroyedUnitsCondition","game/trigger/condition/ElapsedScenarioTimeCondition","game/trigger/condition/ElapsedTimeCondition","game/trigger/condition/EnteredByCondition","game/trigger/condition/GlobalVariableCondition","game/trigger/condition/HealthBelowAnyCondition","game/trigger/condition/HealthBelowCombatCondition","game/trigger/condition/LocalVariableCondition","game/trigger/condition/LowPowerCondition","game/trigger/condition/NoEventCondition","game/trigger/condition/NoFactoriesLeftCondition","game/trigger/condition/PickupCrateAnyCondition","game/trigger/condition/PickupCrateCondition","game/trigger/condition/RandomDelayCondition","game/trigger/condition/SpiedByCondition","game/trigger/condition/SpyEnteringAsHouseCondition","game/trigger/condition/SpyEnteringAsInfantryCondition","game/trigger/condition/TimerExpiredCondition"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S},function(S){ge=S},function(S){pe=S},function(S){me=S},function(S){fe=S},function(S){ye=S},function(S){Te=S},function(S){ve=S},function(S){be=S}],execute:function(){S("TriggerConditionFactory",class{create(S,O){switch(S.type){case B.TriggerEventType.NoEvent:return new de.NoEventCondition(S,O);case B.TriggerEventType.EnteredBy:return new ae.EnteredByCondition(S,O);case B.TriggerEventType.SpiedBy:return new ye.SpiedByCondition(S,O);case B.TriggerEventType.AttackedByAny:return new D.AttackedByAnyCondition(S,O);case B.TriggerEventType.DestroyedByAny:return new ee.DestroyedByAnyCondition(S,O);case B.TriggerEventType.AnyEvent:return new L.AnyEventCondition(S,O);case B.TriggerEventType.DestroyedAllUnits:return new Q.DestroyedAllUnitsCondition(S,O);case B.TriggerEventType.DestroyedAllBuildings:return new $.DestroyedAllBuildingsCondition(S,O);case B.TriggerEventType.DestroyedAll:return new q.DestroyedAllCondition(S,O);case B.TriggerEventType.CreditsExceed:return new W.CreditsExceedCondition(S,O);case B.TriggerEventType.ElapsedTime:return new ne.ElapsedTimeCondition(S,O);case B.TriggerEventType.MissionTimerExpired:return new be.TimerExpiredCondition(S,O);case B.TriggerEventType.DestroyedBuildings:return new J.DestroyedBuildingsCondition(S,O);case B.TriggerEventType.DestroyedUnits:return new re.DestroyedUnitsCondition(S,O);case B.TriggerEventType.NoFactoriesLeft:return new ge.NoFactoriesLeftCondition(S,O);case B.TriggerEventType.BuildBuilding:return new U.BuildObjectTypeCondition(S,O,N.ObjectType.Building);case B.TriggerEventType.BuildUnit:return new U.BuildObjectTypeCondition(S,O,N.ObjectType.Vehicle);case B.TriggerEventType.BuildInfantry:return new U.BuildObjectTypeCondition(S,O,N.ObjectType.Infantry);case B.TriggerEventType.BuildAircraft:return new U.BuildObjectTypeCondition(S,O,N.ObjectType.Aircraft);case B.TriggerEventType.CrossesHorizontalLine:return new z.CrossHorizLineCondition(S,O);case B.TriggerEventType.CrossesVerticalLine:return new K.CrossVertLineCondition(S,O);case B.TriggerEventType.GlobalIsSet:return new oe.GlobalVariableCondition(S,O,!0);case B.TriggerEventType.GlobalIsCleared:return new oe.GlobalVariableCondition(S,O,!1);case B.TriggerEventType.DestroyedOrCaptured:return new te.DestroyedOrCapturedCondition(S,O);case B.TriggerEventType.LowPower:return new ue.LowPowerCondition(S,O);case B.TriggerEventType.DestroyedBridge:return new X.DestroyedBridgeCondition(S,O);case B.TriggerEventType.BuildingExists:return new _.BuildingExistsCondition(S,O);case B.TriggerEventType.ComesNearWaypoint:return new H.ComesNearWaypointCondition(S,O);case B.TriggerEventType.LocalIsSet:return new he.LocalVariableCondition(S,O,!0);case B.TriggerEventType.LocalIsCleared:return new he.LocalVariableCondition(S,O,!1);case B.TriggerEventType.FirstDamagedCombat:return new ce.HealthBelowCombatCondition(S,O,100);case B.TriggerEventType.HalfHealthCombat:return new ce.HealthBelowCombatCondition(S,O,50);case B.TriggerEventType.QuarterHealthCombat:return new ce.HealthBelowCombatCondition(S,O,25);case B.TriggerEventType.FirstDamagedAny:return new le.HealthBelowAnyCondition(S,O,100);case B.TriggerEventType.HalfHealthAny:return new le.HealthBelowAnyCondition(S,O,50);case B.TriggerEventType.QuarterHealthAny:return new le.HealthBelowAnyCondition(S,O,25);case B.TriggerEventType.AttackedByHouse:return new F.AttackedByHouseCondition(S,O);case B.TriggerEventType.AmbientLightBelow:return new j.AmbientLightCondition(S,O,"below");case B.TriggerEventType.AmbientLightAbove:return new j.AmbientLightCondition(S,O,"above");case B.TriggerEventType.ElapsedScenarioTime:return new se.ElapsedScenarioTimeCondition(S,O);case B.TriggerEventType.DestroyedOrCapturedOrInfiltrated:return new ie.DestroyedOrCapturedOrInfiltratedCondition(S,O);case B.TriggerEventType.PickupCrate:return new me.PickupCrateCondition(S,O);case B.TriggerEventType.PickupCrateAny:return new pe.PickupCrateAnyCondition(S,O);case B.TriggerEventType.RandomDelay:return new fe.RandomDelayCondition(S,O);case B.TriggerEventType.CreditsBelow:return new V.CreditsBelowCondition(S,O);case B.TriggerEventType.SpyEnteringAsHouse:return new Te.SpyEnteringAsHouseCondition(S,O);case B.TriggerEventType.SpyEnteringAsInfantry:return new ve.SpyEnteringAsInfantryCondition(S,O);case B.TriggerEventType.DestroyedAllUnitsNaval:return new Y.DestroyedAllUnitsNavalCondition(S,O);case B.TriggerEventType.DestroyedAllUnitsLand:return new Z.DestroyedAllUnitsLandCondition(S,O);case B.TriggerEventType.BuildingNotExists:return new _.BuildingExistsCondition(S,O,!0);default:throw new Error(`Unhandled trigger event type "${B.TriggerEventType[S.type]}"`)}}})}}}),System.register("game/trigger/TriggerExecutor",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("TriggerExecutor",class{constructor(S,O){this.action=S,this.trigger=O}getDebugName(){return`${this.action.triggerId}[${this.action.index}] (${this.trigger.name}).`}})}}}),System.register("game/trigger/TriggerExecutorFactory",["data/map/trigger/TriggerActionType","game/trigger/executor/AddSuperWeaponExecutor","game/trigger/executor/ApplyDamageExecutor","game/trigger/executor/ChangeHouseAllExecutor","game/trigger/executor/ChangeHouseExecutor","game/trigger/executor/CheerExecutor","game/trigger/executor/CreateCrateExecutor","game/trigger/executor/CreateRadarEventExecutor","game/trigger/executor/DestroyObjectExecutor","game/trigger/executor/DestroyTagExecutor","game/trigger/executor/DestroyTriggerExecutor","game/trigger/executor/DetonateWarheadExecutor","game/trigger/executor/EvictOccupiersExecutor","game/trigger/executor/FireSaleExecutor","game/trigger/executor/ForceEndExecutor","game/trigger/executor/ForceTriggerExecutor","game/trigger/executor/GlobalVariableExecutor","game/trigger/executor/IronCurtainExecutor","game/trigger/executor/LightningStrikeExecutor","game/trigger/executor/LocalVariableExecutor","game/trigger/executor/NoActionExecutor","game/trigger/executor/NukeStrikeExecutor","game/trigger/executor/PlayAnimAtExecutor","game/trigger/executor/PlaySoundFxAtExecutor","game/trigger/executor/PlaySoundFxExecutor","game/trigger/executor/PlaySpeechExecutor","game/trigger/executor/ReshroudMapExecutor","game/trigger/executor/ResizePlayerViewExecutor","game/trigger/executor/RevealAroundWaypointExecutor","game/trigger/executor/RevealMapExecutor","game/trigger/executor/SellBuildingExecutor","game/trigger/executor/SetAmbientLightExecutor","game/trigger/executor/SetAmbientRateExecutor","game/trigger/executor/SetAmbientStepExecutor","game/trigger/executor/StopSoundFxAtExecutor","game/trigger/executor/TextTriggerExecutor","game/trigger/executor/TimerExtendExecutor","game/trigger/executor/TimerSetExecutor","game/trigger/executor/TimerShortenExecutor","game/trigger/executor/TimerStartExecutor","game/trigger/executor/TimerStopExecutor","game/trigger/executor/TimerTextExecutor","game/trigger/executor/ToggleTriggerExecutor","game/trigger/executor/TurnOnOffBuildingExecutor","game/trigger/executor/UnrevealAroundWaypointExecutor"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,xe;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S},function(S){ge=S},function(S){pe=S},function(S){me=S},function(S){fe=S},function(S){ye=S},function(S){Te=S},function(S){ve=S},function(S){be=S},function(S){Se=S},function(S){we=S},function(S){Ee=S},function(S){xe=S}],execute:function(){S("TriggerExecutorFactory",class{create(S,O){switch(S.type){case B.TriggerActionType.NoAction:return new ee.NoActionExecutor(S,O);case B.TriggerActionType.FireSale:return new $.FireSaleExecutor(S,O);case B.TriggerActionType.TextTrigger:return new me.TextTriggerExecutor(S,O);case B.TriggerActionType.DestroyTrigger:return new W.DestroyTriggerExecutor(S,O);case B.TriggerActionType.ChangeHouse:return new D.ChangeHouseExecutor(S,O);case B.TriggerActionType.RevealMap:return new ce.RevealMapExecutor(S,O);case B.TriggerActionType.RevealAroundWaypoint:return new le.RevealAroundWaypointExecutor(S,O);case B.TriggerActionType.PlaySoundFx:return new se.PlaySoundFxExecutor(S,O);case B.TriggerActionType.PlaySpeech:return new ne.PlaySpeechExecutor(S,O);case B.TriggerActionType.ForceTrigger:return new Q.ForceTriggerExecutor(S,O);case B.TriggerActionType.TimerStart:return new ve.TimerStartExecutor(S,O);case B.TriggerActionType.TimerStop:return new be.TimerStopExecutor(S,O);case B.TriggerActionType.TimerExtend:return new fe.TimerExtendExecutor(S,O);case B.TriggerActionType.TimerShorten:return new Te.TimerShortenExecutor(S,O);case B.TriggerActionType.TimerSet:return new ye.TimerSetExecutor(S,O);case B.TriggerActionType.GlobalSet:return new Z.GlobalVariableExecutor(S,O,!0);case B.TriggerActionType.GlobalClear:return new Z.GlobalVariableExecutor(S,O,!1);case B.TriggerActionType.DestroyObject:return new H.DestroyObjectExecutor(S,O);case B.TriggerActionType.AddOneTimeSuperWeapon:return new N.AddSuperWeaponExecutor(S,O,!0);case B.TriggerActionType.AddRepeatingSuperWeapon:return new N.AddSuperWeaponExecutor(S,O,!1);case B.TriggerActionType.AllChangeHouse:return new L.ChangeHouseAllExecutor(S,O);case B.TriggerActionType.ResizePlayerView:return new oe.ResizePlayerViewExecutor(S,O);case B.TriggerActionType.PlayAnimAt:return new ie.PlayAnimAtExecutor(S,O);case B.TriggerActionType.DetonateWarhead:return new z.DetonateWarheadExecutor(S,O);case B.TriggerActionType.ReshroudMap:return new ae.ReshroudMapExecutor(S,O);case B.TriggerActionType.EnableTrigger:return new we.ToggleTriggerExecutor(S,O,!0);case B.TriggerActionType.DisableTrigger:return new we.ToggleTriggerExecutor(S,O,!1);case B.TriggerActionType.CreateRadarEvent:return new U.CreateRadarEventExecutor(S,O);case B.TriggerActionType.LocalSet:return new J.LocalVariableExecutor(S,O,!0);case B.TriggerActionType.LocalClear:return new J.LocalVariableExecutor(S,O,!1);case B.TriggerActionType.SellBuilding:return new he.SellBuildingExecutor(S,O);case B.TriggerActionType.TurnOffBuilding:return new Ee.TurnOnOffBuildingExecutor(S,O,!1);case B.TriggerActionType.TurnOnBuilding:return new Ee.TurnOnOffBuildingExecutor(S,O,!0);case B.TriggerActionType.ApplyOneHundredDamage:return new j.ApplyDamageExecutor(S,O,100);case B.TriggerActionType.ForceEnd:return new q.ForceEndExecutor(S,O);case B.TriggerActionType.DestroyTag:return new V.DestroyTagExecutor(S,O);case B.TriggerActionType.SetAmbientStep:return new ge.SetAmbientStepExecutor(S,O);case B.TriggerActionType.SetAmbientRate:return new de.SetAmbientRateExecutor(S,O);case B.TriggerActionType.SetAmbientLight:return new ue.SetAmbientLightExecutor(S,O);case B.TriggerActionType.NukeStrike:return new te.NukeStrikeExecutor(S,O);case B.TriggerActionType.PlaySoundFxAt:return new re.PlaySoundFxAtExecutor(S,O);case B.TriggerActionType.UnrevealAroundWaypoint:return new xe.UnrevealAroundWaypointExecutor(S,O);case B.TriggerActionType.LightningStrike:return new X.LightningStrikeExecutor(S,O);case B.TriggerActionType.TimerText:return new Se.TimerTextExecutor(S,O);case B.TriggerActionType.CreateCrate:return new _.CreateCrateExecutor(S,O);case B.TriggerActionType.IronCurtainAt:return new Y.IronCurtainExecutor(S,O);case B.TriggerActionType.EvictOccupiers:return new K.EvictOccupiersExecutor(S,O);case B.TriggerActionType.Cheer:return new F.CheerExecutor(S,O);case B.TriggerActionType.StopSoundsAt:return new pe.StopSoundFxAtExecutor(S,O);default:throw new Error(`Unhandled action type "${B.TriggerActionType[S.type]}"`)}}})}}}),System.register("game/trigger/TriggerInstance",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/trigger/TriggerManager",["data/map/tag/TagRepeatType","game/trigger/TriggerExecutorFactory","game/trigger/TriggerConditionFactory","util/disposable/CompositeDisposable","data/map/Variable"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){S("TriggerManager",class{constructor(){this.disposables=new L.CompositeDisposable,this.triggerInstances=new Map,this.targetsByTag=new Map,this.conditionFactory=new j.TriggerConditionFactory,this.executorFactory=new N.TriggerExecutorFactory,this.pendingGameEvents=[],this.globalVariables=new Map,this.localVariables=new Map}init(S){var O,B,N,j,L=S.map.getInitialMapObjects().technos;for(let O of L)if(O.tag){let B=this.targetsByTag.get(O.tag);B||(B=[],this.targetsByTag.set(O.tag,B));var D=S.map.tiles.getByMapCoords(O.rx,O.ry);!D||(D=S.map.getObjectsOnTile(D).find(S=>S.name===O.name&&S.type===O.type))&&B.push(D)}for(O of S.map.getCellTags()){var F=S.map.tiles.getByMapCoords(O.coords.x,O.coords.y);if(F){let S=this.targetsByTag.get(O.tagId);S||(S=[],this.targetsByTag.set(O.tagId,S)),S.push(F)}else console.warn(`CellTag out of bounds at (${O.coords.x}, ${O.coords.y}). Skipping.`)}for([B,N]of S.map.getVariables())this.localVariables.set(B,N.clone());for(j of S.map.getTriggers())this.triggerInstances.set(j.id,this.createTriggerInstance(j,S));this.disposables.add(S.events.subscribe(S=>this.pendingGameEvents.push(S)))}createTriggerInstance(S,O){let N=this.targetsByTag.get(S.tag.id)??[];return{trigger:S,conditions:S.events.map(B=>{let j=this.conditionFactory.create(B,S);return j.setTargets(N),j.init(O),j}).sort((S,O)=>Number(O.blocking)-Number(S.blocking)),targets:N,remainingTargets:new Set(S.tag.repeatType===B.TagRepeatType.OnceAll?N:[]),disabled:S.disabled,finished:!1}}update(S){var O,N=this.pendingGameEvents.splice(0,this.pendingGameEvents.length);for(O of this.triggerInstances.values())if(!O.finished&&!O.disabled){let _=!0,U=[];for(var j of O.conditions){var L=j.check(S,N);if("boolean"==typeof L?L||(_=!1):L.length?U.push(...L):_=!1,j.blocking&&!_)break}if(_){var D=O.trigger;O.conditions.forEach(S=>S.reset?.());let N=[];if(D.tag.repeatType===B.TagRepeatType.OnceAll){for(var F of U)O.remainingTargets.delete(F);if(O.remainingTargets.size)continue;N=U.length?[U[U.length-1]]:[]}else N=O.targets;this.executeActions(D,N,S),D.tag.repeatType!==B.TagRepeatType.Repeat&&(O.finished=!0)}}}executeActions(S,O,B){for(var N of S.actions)this.executorFactory.create(N,S).execute(B,O)}setTriggerEnabled(S,O){let B=this.triggerInstances.get(S);B&&(B.disabled=!O)}forceTrigger(S,O){var B=this.triggerInstances.get(S);B&&this.executeActions(B.trigger,B.targets,O)}destroyTrigger(S){this.triggerInstances.delete(S)}destroyTag(S){let O=[];for(var[B,N]of this.triggerInstances)N.trigger.tag.id===S&&O.push(B);for(var j of O)this.destroyTrigger(j)}getGlobalVariable(S){return!!this.globalVariables.get(S)?.value}toggleGlobalVariable(S,O){let B=this.globalVariables.get(S);void 0===B?this.globalVariables.set(S,new D.Variable("No name",O)):B.value=O}getLocalVariable(S){return!!this.localVariables.get(S)?.value}toggleLocalVariable(S,O){let B=this.localVariables.get(S);void 0===B?this.localVariables.set(S,new D.Variable("No name",O)):B.value=O}dispose(){this.disposables.dispose()}})}}}),System.register("game/trigger/TriggerTarget",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("game/trigger/condition/AmbientLightCondition",["game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerCondition{constructor(S,O,B){super(S,O),this.type=B,this.threshold=Number(S.params[1])/100}check(S){var O=this.previousAmbient,B=S.mapLightingTrait.getAmbient().ambient;return this.previousAmbient=B,void 0!==O&&O!==B&&("above"===this.type?B>=this.threshold&&O<this.threshold:B<=this.threshold&&O>this.threshold)}},S("AmbientLightCondition",N)}}}),System.register("game/trigger/condition/AnyEventCondition",["game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerCondition{check(S){return!0}},S("AnyEventCondition",N)}}}),System.register("game/trigger/condition/AttackedByAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{check(S,O){return O.filter(O=>{if(O.type!==B.EventType.ObjectAttacked)return!1;let N=O.target;if(!N.isTechno()||!this.targets.includes(N))return!1;var j=O.attacker?.player;return(!j||!S.alliances.areAllied(j,N.owner)&&j!==N.owner)&&!O.incidental}).map(S=>S.target)}},S("AttackedByAnyCondition",j)}}}),System.register("game/trigger/condition/AttackedByHouseCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{constructor(S,O){super(S,O),this.houseId=Number(S.params[1])}check(S,O){return O.filter(S=>{if(S.type!==B.EventType.ObjectAttacked)return!1;let O=S.target;if(!O.isTechno()||!this.targets.includes(O))return!1;var N=S.attacker?.player;return N&&(-1===this.houseId||N?.country?.id===this.houseId)}).map(S=>S.target)}},S("AttackedByHouseCondition",j)}}}),System.register("game/trigger/condition/BuildObjectTypeCondition",["game/trigger/TriggerCondition","game/event/EventType"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends B.TriggerCondition{constructor(S,O,B){super(S,O),this.objectType=B,this.objectIndex=Number(S.params[1])}check(S,O){return O.some(S=>S.type===N.EventType.ObjectSpawn&&S.gameObject.type===this.objectType&&S.gameObject.rules.index===this.objectIndex)}},S("BuildObjectTypeCondition",j)}}}),System.register("game/trigger/condition/BuildingExistsCondition",["game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerCondition{constructor(S,O,B=!1){super(S,O),this.negate=B,this.objectIndex=Number(S.params[1])}check(){if(!this.player)return!1;for(var S of this.player.buildings)if(S.rules.index===this.objectIndex)return!this.negate;return this.negate}},S("BuildingExistsCondition",N)}}}),System.register("game/trigger/condition/ComesNearWaypointCondition",["game/event/EventType","game/gameobject/unit/RangeHelper","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.TriggerCondition{constructor(S,O){super(S,O)}init(S){super.init(S);var O=Number(this.event.params[1]);this.waypointTile=S.map.getTileAtWaypoint(O),this.waypointTile||console.warn(`No valid location found for waypoint ${O}. Skipping event ${this.getDebugName()}.`)}check(S,O){if(!this.waypointTile||!this.player)return!1;for(var j of O)if(j.type===B.EventType.EnterTile&&j.source.owner===this.player&&new N.RangeHelper(S.map.tileOccupation).tileDistance(j.target,this.waypointTile)<2)return!0;return!1}},S("ComesNearWaypointCondition",L)}}}),System.register("game/trigger/condition/CreditsBelowCondition",["game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerCondition{constructor(S,O){super(S,O),this.threshold=Number(S.params[1])}check(S,O){return!!this.player&&this.player.credits<this.threshold}},S("CreditsBelowCondition",N)}}}),System.register("game/trigger/condition/CreditsExceedCondition",["game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerCondition{constructor(S,O){super(S,O),this.threshold=Number(S.params[1])}check(S,O){return!!this.player&&this.player.credits>this.threshold}},S("CreditsExceedCondition",N)}}}),System.register("game/trigger/condition/CrossHorizLineCondition",["game/event/EventType","game/gameobject/unit/ZoneType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.TriggerCondition{constructor(S,O){super(S,O),this.houseId=Number(this.event.params[1])}check(S,O){return O.filter(S=>S.type===B.EventType.EnterTile&&S.source.zone!==N.ZoneType.Air&&this.targets.some(O=>O.ry===S.target.ry)&&(-1===this.houseId||S.source.owner.country?.id===this.houseId)).map(S=>S.target)}},S("CrossHorizLineCondition",L)}}}),System.register("game/trigger/condition/CrossVertLineCondition",["game/event/EventType","game/gameobject/unit/ZoneType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.TriggerCondition{constructor(S,O){super(S,O),this.houseId=Number(this.event.params[1])}check(S,O){return O.filter(S=>S.type===B.EventType.EnterTile&&S.source.zone!==N.ZoneType.Air&&this.targets.some(O=>O.rx===S.target.rx)&&(-1===this.houseId||S.source.owner.country?.id===this.houseId)).map(S=>S.target)}},S("CrossVertLineCondition",L)}}}),System.register("game/trigger/condition/DestroyedAllBuildingsCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{constructor(S,O){super(S,O),this.allDestroyed=!1,this.houseId=Number(S.params[1])}check(S,O){return!!this.allDestroyed||!!O.some(S=>{if(S.type!==B.EventType.ObjectDestroy)return!1;let O=S.target;return!(!O.isBuilding()||O.owner.country?.id!==this.houseId||O.owner.buildings.size)})&&(this.allDestroyed=!0)}},S("DestroyedAllBuildingsCondition",j)}}}),System.register("game/trigger/condition/DestroyedAllCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{constructor(S,O){super(S,O),this.allDestroyed=!1,this.houseId=Number(S.params[1])}check(S,O){return!!this.allDestroyed||!!O.some(S=>{if(S.type!==B.EventType.ObjectDestroy)return!1;let O=S.target;return!(!O.isTechno()||O.owner.country?.id!==this.houseId||O.owner.getOwnedObjects(!0).length)})&&(this.allDestroyed=!0)}},S("DestroyedAllCondition",j)}}}),System.register("game/trigger/condition/DestroyedAllUnitsCondition",["engine/type/ObjectType","game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.TriggerCondition{constructor(S,O){super(S,O),this.allDestroyed=!1,this.houseId=Number(S.params[1])}check(S,O){return!!this.allDestroyed||!!O.some(S=>{if(S.type!==N.EventType.ObjectDestroy)return!1;let O=S.target;return!(!O.isUnit()||O.owner.country?.id!==this.houseId||this.hasUnitsLeft(O.owner))})&&(this.allDestroyed=!0)}hasUnitsLeft(S){var O;for(O of[B.ObjectType.Aircraft,B.ObjectType.Vehicle,B.ObjectType.Infantry])if(S.getOwnedObjectsByType(O,!0).length)return!0;return!1}},S("DestroyedAllUnitsCondition",L)}}}),System.register("game/trigger/condition/DestroyedAllUnitsLandCondition",["engine/type/ObjectType","game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.TriggerCondition{constructor(S,O){super(S,O),this.allDestroyed=!1,this.houseId=Number(S.params[1])}check(S,O){return!!this.allDestroyed||!!O.some(S=>{if(S.type!==N.EventType.ObjectDestroy)return!1;let O=S.target;return!(!O.isUnit()||O.owner.country?.id!==this.houseId||this.hasLandUnitsLeft(O.owner))})&&(this.allDestroyed=!0)}hasLandUnitsLeft(S){var O;for(O of[B.ObjectType.Vehicle,B.ObjectType.Infantry])if(S.getOwnedObjectsByType(O,!0).filter(S=>!S.rules.naval).length)return!0;return!1}},S("DestroyedAllUnitsLandCondition",L)}}}),System.register("game/trigger/condition/DestroyedAllUnitsNavalCondition",["engine/type/ObjectType","game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.TriggerCondition{constructor(S,O){super(S,O),this.allDestroyed=!1,this.houseId=Number(S.params[1])}check(S,O){return!!this.allDestroyed||!!O.some(S=>{if(S.type!==N.EventType.ObjectDestroy)return!1;let O=S.target;return!(!O.isVehicle()||O.owner.country?.id!==this.houseId||O.owner.getOwnedObjectsByType(B.ObjectType.Vehicle,!0).filter(S=>S.rules.naval).length)})&&(this.allDestroyed=!0)}},S("DestroyedAllUnitsNavalCondition",L)}}}),System.register("game/trigger/condition/DestroyedBridgeCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{check(S,O){return O.filter(O=>{if(O.type!==B.EventType.ObjectDestroy)return!1;let N=O.target;if(!N.isOverlay()||!N.isBridge())return!1;var j=N.bridgeTrait?.bridgeSpec;return!!j&&S.map.bridges.findAllBridgeTiles(j).find(S=>this.targets.includes(S))}).map(S=>S.target.tile)}},S("DestroyedBridgeCondition",j)}}}),System.register("game/trigger/condition/DestroyedBuildingsCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{constructor(S,O){super(S,O),this.count=0,this.threshold=Number(S.params[1])}check(S,O){if(!this.player)return!1;if(this.count>=this.threshold)return!0;for(var N of O)if(N.type===B.EventType.ObjectDestroy){let S=N.target;S.isBuilding()&&S.owner.country?.id===this.houseId&&this.count++}return this.count>=this.threshold}},S("DestroyedBuildingsCondition",j)}}}),System.register("game/trigger/condition/DestroyedByAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{check(S,O){return O.filter(O=>{if(O.type!==B.EventType.ObjectDestroy)return!1;let N=O.target;if(!N.isTechno()||!this.targets.includes(N))return!1;var j=O.attackerInfo?.player;return(!j||!S.alliances.areAllied(j,N.owner)&&j!==N.owner)&&!O.incidental}).map(S=>S.target)}},S("DestroyedByAnyCondition",j)}}}),System.register("game/trigger/condition/DestroyedOrCapturedCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{check(S,O){return O.filter(S=>{if(S.type!==B.EventType.ObjectDestroy&&S.type!==B.EventType.ObjectOwnerChange)return!1;let O=S.target;return!(!O.isTechno()||!this.targets.includes(O))}).map(S=>S.target)}},S("DestroyedOrCapturedCondition",j)}}}),System.register("game/trigger/condition/DestroyedOrCapturedOrInfiltratedCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{constructor(){super(...arguments),this.eventsFilter=[B.EventType.ObjectDestroy,B.EventType.ObjectOwnerChange,B.EventType.BuildingInfiltration]}check(S,O){return O.filter(S=>{if(!this.eventsFilter.includes(S.type))return!1;let O=S.target;return!(!O.isTechno()||!this.targets.includes(O))}).map(S=>S.target)}},S("DestroyedOrCapturedOrInfiltratedCondition",j)}}}),System.register("game/trigger/condition/DestroyedUnitsCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{constructor(S,O){super(S,O),this.count=0,this.threshold=Number(S.params[1])}check(S,O){if(!this.player)return!1;if(this.count>=this.threshold)return!0;for(var N of O)if(N.type===B.EventType.ObjectDestroy){let S=N.target;S.isUnit()&&S.owner.country?.id===this.houseId&&this.count++}return this.count>=this.threshold}},S("DestroyedUnitsCondition",j)}}}),System.register("game/trigger/condition/ElapsedScenarioTimeCondition",["game/GameSpeed","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{constructor(S,O){super(S,O),this.timerTicks=Number(this.event.params[1])*B.GameSpeed.BASE_TICKS_PER_SECOND}check(S){return S.currentTick>this.timerTicks}},S("ElapsedScenarioTimeCondition",j)}}}),System.register("game/trigger/condition/ElapsedTimeCondition",["game/GameSpeed","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{constructor(S,O){super(S,O),this.elapsedTicks=0,this.timerTicks=Number(this.event.params[1])*B.GameSpeed.BASE_TICKS_PER_SECOND}check(S){return this.elapsedTicks++>this.timerTicks}reset(){this.elapsedTicks=0}},S("ElapsedTimeCondition",j)}}}),System.register("game/trigger/condition/EnteredByCondition",["game/event/EventType","game/gameobject/unit/ZoneType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.TriggerCondition{constructor(S,O){super(S,O),this.houseId=Number(this.event.params[1])}check(S,O){return O.filter(S=>(S.type===B.EventType.EnterObject||S.type===B.EventType.EnterTile)&&this.targets.includes(S.target)&&(S.type!==B.EventType.EnterTile||S.source.zone!==N.ZoneType.Air)&&(-1===this.houseId||S.source.owner.country?.id===this.houseId)).map(S=>S.target)}},S("EnteredByCondition",L)}}}),System.register("game/trigger/condition/GlobalVariableCondition",["game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerCondition{constructor(S,O,B){super(S,O),this.value=B,this.blocking=!0,this.variableIdx=Number(S.params[1])}check(S){return S.triggers.getGlobalVariable(this.variableIdx)===this.value}},S("GlobalVariableCondition",N)}}}),System.register("game/trigger/condition/HealthBelowAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{constructor(S,O,B){super(S,O),this.threshold=B}check(S,O){return O.filter(S=>{if(S.type!==B.EventType.HealthChange)return!1;let O=S.target;return!(!O.isTechno()||!this.targets.includes(O))&&S.currentHealth<this.threshold&&S.prevHealth>this.threshold}).map(S=>S.target)}},S("HealthBelowAnyCondition",j)}}}),System.register("game/trigger/condition/HealthBelowCombatCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{constructor(S,O,B){super(S,O),this.threshold=B}check(S,O){return O.filter(S=>{if(S.type!==B.EventType.InflictDamage)return!1;let O=S.target;return!(!O.isTechno()||!this.targets.includes(O))&&S.currentHealth<this.threshold&&S.prevHealth>this.threshold}).map(S=>S.target)}},S("HealthBelowCombatCondition",j)}}}),System.register("game/trigger/condition/LocalVariableCondition",["game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerCondition{constructor(S,O,B){super(S,O),this.value=B,this.blocking=!0,this.variableIdx=Number(S.params[1])}check(S){return S.triggers.getLocalVariable(this.variableIdx)===this.value}},S("LocalVariableCondition",N)}}}),System.register("game/trigger/condition/LowPowerCondition",["game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerCondition{constructor(S,O){super(S,O),this.houseId=Number(this.event.params[1])}init(S){super.init(S),this.targetPlayer=S.getAllPlayers().find(S=>S.country?.id===this.houseId)}check(){return!!this.targetPlayer?.powerTrait?.isLowPower()}},S("LowPowerCondition",N)}}}),System.register("game/trigger/condition/NoEventCondition",["game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerCondition{check(S){return!1}},S("NoEventCondition",N)}}}),System.register("game/trigger/condition/NoFactoriesLeftCondition",["game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerCondition{check(){if(!this.player)return!1;for(var S of this.player.buildings)if(S.factoryTrait)return!1;return!0}},S("NoFactoriesLeftCondition",N)}}}),System.register("game/trigger/condition/PickupCrateAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{check(S,O){return O.some(S=>S.type===B.EventType.CratePickup)}},S("PickupCrateAnyCondition",j)}}}),System.register("game/trigger/condition/PickupCrateCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{check(S,O){return O.filter(S=>S.type===B.EventType.CratePickup&&this.targets.includes(S.source)).map(S=>S.source)}},S("PickupCrateCondition",j)}}}),System.register("game/trigger/condition/RandomDelayCondition",["game/GameSpeed","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{constructor(){super(...arguments),this.elapsedTicks=0}check(S){return this.timerTicks??(this.timerTicks=Math.floor(S.generateRandomInt(50,150)/100*Number(this.event.params[1]))*B.GameSpeed.BASE_TICKS_PER_SECOND),this.elapsedTicks++>this.timerTicks}reset(){this.timerTicks=void 0,this.elapsedTicks=0}},S("RandomDelayCondition",j)}}}),System.register("game/trigger/condition/SpiedByCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{constructor(S,O){super(S,O),this.houseId=Number(this.event.params[1])}check(S,O){return O.filter(S=>S.type===B.EventType.BuildingInfiltration&&this.targets.includes(S.target)&&(-1===this.houseId||S.source.owner.country?.id===this.houseId)).map(S=>S.target)}},S("SpiedByCondition",j)}}}),System.register("game/trigger/condition/SpyEnteringAsHouseCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{constructor(S,O){super(S,O),this.houseId=Number(S.params[1])}check(S,O){return O.filter(S=>{if(S.type!==B.EventType.BuildingInfiltration)return!1;var O=S.target;return!!this.targets.includes(O)&&(-1===this.houseId||S.source.disguiseTrait?.getDisguise()?.owner?.country?.id===this.houseId)}).map(S=>S.target)}},S("SpyEnteringAsHouseCondition",j)}}}),System.register("game/trigger/condition/SpyEnteringAsInfantryCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{constructor(S,O){super(S,O),this.infantryIdx=Number(S.params[1])}check(S,O){return O.filter(S=>{if(S.type!==B.EventType.BuildingInfiltration)return!1;var O=S.target;return!!this.targets.includes(O)&&S.source.disguiseTrait?.getDisguise()?.rules.index===this.infantryIdx}).map(S=>S.target)}},S("SpyEnteringAsInfantryCondition",j)}}}),System.register("game/trigger/condition/TimerExpiredCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerCondition{check(S,O){return O.some(S=>S.type===B.EventType.TimerExpire)}},S("TimerExpiredCondition",j)}}}),System.register("game/trigger/executor/AddSuperWeaponExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{constructor(S,O,B){super(S,O),this.oneTimeOnly=B,this.superWeaponIdx=Number(S.params[1])}execute(S){var O=[...S.rules.superWeaponRules.values()].find(S=>S.index===this.superWeaponIdx);if(O){let B=S.getAllPlayers().find(S=>S.country?.name===this.trigger.houseName);if(B&&B.superWeaponsTrait&&!B.superWeaponsTrait.has(O.name)){let N=S.createSuperWeapon(O.name,B,this.oneTimeOnly);N.isGift=!0,B.superWeaponsTrait.add(N)}}else console.warn(`No superweapon found with index "${this.superWeaponIdx}". Skipping action ${this.getDebugName()}.`)}},S("AddSuperWeaponExecutor",N)}}}),System.register("game/trigger/executor/ApplyDamageExecutor",["game/Coords","game/gameobject/unit/CollisionType","game/Warhead","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends L.TriggerExecutor{constructor(S,O,B){super(S,O),this.damage=B}execute(S){var O=Number(this.action.params[1]),L=S.map.getTileAtWaypoint(O);if(L){var D=S.rules.getWarhead(j.Warhead.HE_WARHEAD_NAME);let O=new j.Warhead(D);var F=S.map.tileOccupation.getBridgeOnTile(L),_=F?.tileElevation??0;D=S.map.getTileZone(L),O.detonate(S,this.damage,L,_,B.Coords.tile3dToWorld(L.rx+.5,L.ry+.5,L.z+_),D,F?N.CollisionType.OnBridge:N.CollisionType.None,S.createTarget(F,L),void 0)}else console.warn(`No valid location found for waypoint ${O}. Skipping action ${this.getDebugName()}.`)}},S("ApplyDamageExecutor",D)}}}),System.register("game/trigger/executor/ChangeHouseAllExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class e extends B.TriggerExecutor{execute(S){let O=S.getAllPlayers().find(S=>S.country?.name===this.trigger.houseName);if(O){let N,j=Number(this.action.params[1]);if(j>=e.locationHouseIdBegin&&j<e.locationHouseIdBegin+S.map.startingLocations.length){let O=j-e.locationHouseIdBegin;N=S.getAllPlayers().find(S=>S.startLocation===O)}else N=S.getAllPlayers().find(S=>S.country?.id===j);if(N)for(var B of O.getOwnedObjects(!0))S.changeObjectOwner(B,N)}}},S("ChangeHouseAllExecutor",N),N.locationHouseIdBegin=4475}}}),System.register("game/trigger/executor/ChangeHouseExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class e extends N.TriggerExecutor{constructor(S,O){super(S,O),this.houseId=Number(S.params[1])}execute(S,O){let N;if(this.houseId>=e.locationHouseIdBegin&&this.houseId<e.locationHouseIdBegin+S.map.startingLocations.length){let O=this.houseId-e.locationHouseIdBegin;N=S.getAllPlayers().find(S=>S.startLocation===O)}else N=S.getAllPlayers().find(S=>S.country?.id===this.houseId);if(N)for(var j of O)j instanceof B.GameObject&&j.isSpawned&&S.changeObjectOwner(j,N)}},S("ChangeHouseExecutor",j),j.locationHouseIdBegin=4475}}}),System.register("game/trigger/executor/CheerExecutor",["engine/type/ObjectType","game/gameobject/task/CheerTask","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.TriggerExecutor{constructor(S,O){super(S,O),this.houseId=Number(S.params[1])}execute(S){let O=S.getAllPlayers().filter(S=>S.country&&!S.defeated);if(-1!==this.houseId&&(O=O.filter(S=>S.country?.id===this.houseId)),O.length)for(var j of O[0].getOwnedObjectsByType(B.ObjectType.Infantry))j.unitOrderTrait.isIdle()&&j.unitOrderTrait.addTask(new N.CheerTask)}},S("CheerExecutor",L)}}});System.register("game/trigger/executor/CreateCrateExecutor",["game/type/PowerupType","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=new Map([[0,S=>{var O=S.rules.powerups.powerups.find(S=>S.type===B.PowerupType.Money);return O?{...O,data:"5000"}:void 0}],[1,B.PowerupType.Unit],[2,B.PowerupType.HealBase],[3,B.PowerupType.Cloak],[4,B.PowerupType.Explosion],[5,B.PowerupType.Napalm],[6,B.PowerupType.Money],[7,B.PowerupType.Darkness],[8,B.PowerupType.Reveal],[9,B.PowerupType.Armor],[10,B.PowerupType.Speed],[11,B.PowerupType.Firepower],[12,B.PowerupType.ICBM],[13,void 0],[14,B.PowerupType.Veteran],[15,void 0],[16,B.PowerupType.Gas],[17,B.PowerupType.Tiberium],[18,void 0]]),L=class extends N.TriggerExecutor{execute(S){var O=Number(this.action.params[1]),B=this.action.params[6],N=S.map.getTileAtWaypoint(B);if(N)if(j.has(O)){const B=j.get(O);(O="function"==typeof B?B(S):S.rules.powerups.powerups.find(S=>S.type===B))&&S.crateGeneratorTrait.spawnCrateAt(N,O,S)}else S.crateGeneratorTrait.spawnRandomCrateAt(N,S);else console.warn(`No valid location found for waypoint ${B}. Skipping action ${this.getDebugName()}.`)}},S("CreateCrateExecutor",L)}}}),System.register("game/trigger/executor/CreateRadarEventExecutor",["game/rules/general/RadarRules","game/trait/RadarTrait","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.TriggerExecutor{execute(S){var O=Number(this.action.params[1])-1;if(Object.values(B.RadarEventType).includes(O)){var j=this.action.params[6],L=S.map.getTileAtWaypoint(j);if(L)for(var D of S.getCombatants())S.traits.get(N.RadarTrait).addEventForPlayer(O,D,L,S);else console.warn(`No valid location found for waypoint ${j}. Skipping action ${this.getDebugName()}.`)}else console.warn(`Unknown radar event type "${1+O}". Skipping action ${this.getDebugName()}.`)}},S("CreateRadarEventExecutor",L)}}}),System.register("game/trigger/executor/DestroyObjectExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerExecutor{execute(S,O){for(var N of O)N instanceof B.GameObject&&N.isSpawned&&S.destroyObject(N)}},S("DestroyObjectExecutor",j)}}}),System.register("game/trigger/executor/DestroyTagExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){var O=this.action.params[1];S.triggers.destroyTag(O)}},S("DestroyTagExecutor",N)}}}),System.register("game/trigger/executor/DestroyTriggerExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){var O=this.action.params[1];S.triggers.destroyTrigger(O)}},S("DestroyTriggerExecutor",N)}}}),System.register("game/trigger/executor/DetonateWarheadExecutor",["game/Coords","game/gameobject/unit/CollisionType","game/Warhead","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends L.TriggerExecutor{execute(S){var O=Number(this.action.params[1]),L=this.action.params[6],D=S.map.getTileAtWaypoint(L);if(D){let U,H;try{U=S.rules.getWeaponByInternalId(O)}catch(L){if(L instanceof RangeError)return void console.warn(`Weapon with internal ID "${O}" not found. Skipping action ${this.getDebugName()}.`);throw L}try{H=S.rules.getWarhead(U.warhead)}catch(L){return void console.warn(`Warhead "${U.warhead}" not found. Skipping action ${this.getDebugName()}.`)}let V=new j.Warhead(H);var F=S.map.tileOccupation.getBridgeOnTile(D),_=F?.tileElevation??0;O=S.map.getTileZone(D),V.detonate(S,U.damage,D,_,B.Coords.tile3dToWorld(D.rx+.5,D.ry+.5,D.z+_),O,F?N.CollisionType.OnBridge:N.CollisionType.None,S.createTarget(F,D),void 0)}else console.warn(`No valid location found for waypoint ${L}. Skipping action ${this.getDebugName()}.`)}},S("DetonateWarheadExecutor",D)}}}),System.register("game/trigger/executor/EvictOccupiersExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerExecutor{execute(S,O){for(var N of O)N instanceof B.GameObject&&N.isBuilding()&&N.garrisonTrait&&!N.isDestroyed&&N.garrisonTrait.evacuate(S)}},S("EvictOccupiersExecutor",j)}}}),System.register("game/trigger/executor/FireSaleExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{constructor(S,O){super(S,O),this.houseId=Number(S.params[1])}execute(S){var O=S.getAllPlayers().find(S=>S.country?.id===this.houseId);if(O)for(var B of O.buildings)S.sellTrait.sell(B)}},S("FireSaleExecutor",N)}}}),System.register("game/trigger/executor/ForceEndExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){S.end()}},S("ForceEndExecutor",N)}}}),System.register("game/trigger/executor/ForceTriggerExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){var O=this.action.params[1];S.triggers.forceTrigger(O,S)}},S("ForceTriggerExecutor",N)}}}),System.register("game/trigger/executor/GlobalVariableExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{constructor(S,O,B){super(S,O),this.value=B,this.variableIdx=Number(S.params[1])}execute(S){S.triggers.toggleGlobalVariable(this.variableIdx,this.value)}},S("GlobalVariableExecutor",N)}}}),System.register("game/trigger/executor/IronCurtainExecutor",["game/trait/SuperWeaponsTrait","game/type/SuperWeaponType","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.TriggerExecutor{execute(S){var O,j,L=this.action.params[6],D=S.map.getTileAtWaypoint(L);D?!(O=S.getAllPlayers().find(S=>!S.defeated&&S.country?.name===this.trigger.houseName))||(j=[...S.rules.superWeaponRules.values()].find(S=>S.type===N.SuperWeaponType.IronCurtain))&&S.traits.get(B.SuperWeaponsTrait).activateEffect(j,O,S,D,void 0,!0):console.warn(`No valid location found for waypoint ${L}. Skipping action ${this.getDebugName()}.`)}},S("IronCurtainExecutor",L)}}}),System.register("game/trigger/executor/LightningStrikeExecutor",["game/trait/SuperWeaponsTrait","game/type/SuperWeaponType","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.TriggerExecutor{execute(S){var O,j,L=this.action.params[6],D=S.map.getTileAtWaypoint(L);D?!(O=S.getAllPlayers().find(S=>!S.defeated&&S.country?.name===this.trigger.houseName))||(j=[...S.rules.superWeaponRules.values()].find(S=>S.type===N.SuperWeaponType.LightningStorm))&&S.traits.get(B.SuperWeaponsTrait).activateEffect(j,O,S,D,void 0,!0):console.warn(`No valid location found for waypoint ${L}. Skipping action ${this.getDebugName()}.`)}},S("LightningStrikeExecutor",L)}}}),System.register("game/trigger/executor/LocalVariableExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{constructor(S,O,B){super(S,O),this.value=B,this.variableIdx=Number(S.params[1])}execute(S){S.triggers.toggleLocalVariable(this.variableIdx,this.value)}},S("LocalVariableExecutor",N)}}}),System.register("game/trigger/executor/NoActionExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(){}},S("NoActionExecutor",N)}}}),System.register("game/trigger/executor/NukeStrikeExecutor",["game/trait/SuperWeaponsTrait","game/type/SuperWeaponType","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.TriggerExecutor{execute(S){var O,j,L=this.action.params[6],D=S.map.getTileAtWaypoint(L);D?!(O=S.getAllPlayers().find(S=>!S.defeated&&S.country?.name===this.trigger.houseName))||(j=[...S.rules.superWeaponRules.values()].find(S=>S.type===N.SuperWeaponType.MultiMissile))&&S.traits.get(B.SuperWeaponsTrait).activateEffect(j,O,S,D,void 0,!0):console.warn(`No valid location found for waypoint ${L}. Skipping action ${this.getDebugName()}.`)}},S("NukeStrikeExecutor",L)}}}),System.register("game/trigger/executor/PlayAnimAtExecutor",["game/event/TriggerAnimEvent","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerExecutor{execute(S){var O,N=this.action,j=Number(N.params[1]),L=S.rules.getAnimationName(j);void 0!==L?(O=N.params[6],(N=S.map.getTileAtWaypoint(O))?S.events.dispatch(new B.TriggerAnimEvent(L,N)):console.warn(`No valid location found for waypoint ${O}. Skipping action ${this.getDebugName()}.`)):console.warn(`No animation found for index "${j}". Skipping action `+this.getDebugName())}},S("PlayAnimAtExecutor",j)}}}),System.register("game/trigger/executor/PlaySoundFxAtExecutor",["game/event/TriggerSoundFxEvent","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerExecutor{execute(S){var O,N=(O=this.action).params[1],j=O.params[6];(O=S.map.getTileAtWaypoint(j))?S.events.dispatch(new B.TriggerSoundFxEvent(N,O)):console.warn(`No valid location found for waypoint ${j}. Skipping action ${this.getDebugName()}.`)}},S("PlaySoundFxAtExecutor",j)}}}),System.register("game/trigger/executor/PlaySoundFxExecutor",["game/event/TriggerSoundFxEvent","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerExecutor{execute(S){S.events.dispatch(new B.TriggerSoundFxEvent(this.action.params[1]))}},S("PlaySoundFxExecutor",j)}}}),System.register("game/trigger/executor/PlaySpeechExecutor",["game/event/TriggerEvaEvent","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerExecutor{execute(S){S.events.dispatch(new B.TriggerEvaEvent(this.action.params[1]))}},S("PlaySpeechExecutor",j)}}}),System.register("game/trigger/executor/ReshroudMapExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){for(var O of S.getCombatants())S.mapShroudTrait.resetShroud(O,S)}},S("ReshroudMapExecutor",N)}}}),System.register("game/trigger/executor/ResizePlayerViewExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){var[O,B,N,j]=this.action.params.slice(2,6).map(Number);S.map.mapBounds.updateRawLocalSize({x:O,y:B,width:N,height:j})}},S("ResizePlayerViewExecutor",N)}}}),System.register("game/trigger/executor/RevealAroundWaypointExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){var O=Number(this.action.params[1]),B=S.map.getTileAtWaypoint(O);if(B)for(var N of S.getCombatants())S.mapShroudTrait.getPlayerShroud(N)?.revealAround(B,S.rules.general.revealTriggerRadius);else console.warn(`No valid location found for waypoint ${O}. Skipping action ${this.getDebugName()}.`)}},S("RevealAroundWaypointExecutor",N)}}}),System.register("game/trigger/executor/RevealMapExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){for(var O of S.getCombatants())S.mapShroudTrait.revealMap(O,S)}},S("RevealMapExecutor",N)}}}),System.register("game/trigger/executor/SellBuildingExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerExecutor{execute(S,O){for(var N of O)N instanceof B.GameObject&&N.isBuilding()&&!N.isDestroyed&&S.sellTrait.sell(N)}},S("SellBuildingExecutor",j)}}}),System.register("game/trigger/executor/SetAmbientLightExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){var O=Number(this.action.params[1])/100;S.mapLightingTrait.setTargetAmbientIntensity(O)}},S("SetAmbientLightExecutor",N)}}}),System.register("game/trigger/executor/SetAmbientRateExecutor",["util/number","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerExecutor{execute(S){var O=B.int32ToFloat32(Number(this.action.params[1]));S.mapLightingTrait.setAmbientChangeRate(O)}},S("SetAmbientRateExecutor",j)}}}),System.register("game/trigger/executor/SetAmbientStepExecutor",["util/number","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerExecutor{execute(S){var O=B.int32ToFloat32(Number(this.action.params[1]));S.mapLightingTrait.setAmbientChangeStep(O)}},S("SetAmbientStepExecutor",j)}}}),System.register("game/trigger/executor/StopSoundFxAtExecutor",["game/event/TriggerStopSoundFxEvent","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerExecutor{execute(S){var O=this.action.params[6],N=S.map.getTileAtWaypoint(O);N?S.events.dispatch(new B.TriggerStopSoundFxEvent(N)):console.warn(`No valid location found for waypoint ${O}. Skipping action ${this.getDebugName()}.`)}},S("StopSoundFxAtExecutor",j)}}}),System.register("game/trigger/executor/TextTriggerExecutor",["game/event/TriggerTextEvent","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerExecutor{execute(S){S.events.dispatch(new B.TriggerTextEvent(this.action.params[1]))}},S("TextTriggerExecutor",j)}}}),System.register("game/trigger/executor/TimerExtendExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){S.countdownTimer.addSeconds(Number(this.action.params[1]))}},S("TimerExtendExecutor",N)}}}),System.register("game/trigger/executor/TimerSetExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){S.countdownTimer.setSeconds(Number(this.action.params[1]))}},S("TimerSetExecutor",N)}}}),System.register("game/trigger/executor/TimerShortenExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){S.countdownTimer.addSeconds(-Number(this.action.params[1]))}},S("TimerShortenExecutor",N)}}}),System.register("game/trigger/executor/TimerStartExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){S.countdownTimer.start()}},S("TimerStartExecutor",N)}}}),System.register("game/trigger/executor/TimerStopExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){S.countdownTimer.stop()}},S("TimerStopExecutor",N)}}}),System.register("game/trigger/executor/TimerTextExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){S.countdownTimer.text=this.action.params[1]}},S("TimerTextExecutor",N)}}}),System.register("game/trigger/executor/ToggleTriggerExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{constructor(S,O,B){super(S,O),this.triggerEnable=B}execute(S){var O=this.action.params[1];S.triggers.setTriggerEnabled(O,this.triggerEnable)}},S("ToggleTriggerExecutor",N)}}}),System.register("game/trigger/executor/TurnOnOffBuildingExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.TriggerExecutor{constructor(S,O,B){super(S,O),this.turnOn=B}execute(S,O){for(var N of O)N instanceof B.GameObject&&N.isBuilding()&&N.poweredTrait?.setTurnedOn(this.turnOn)}},S("TurnOnOffBuildingExecutor",j)}}}),System.register("game/trigger/executor/UnrevealAroundWaypointExecutor",["game/trigger/TriggerExecutor"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.TriggerExecutor{execute(S){var O=Number(this.action.params[1]),B=S.map.getTileAtWaypoint(O);if(B)for(var N of S.getCombatants())S.mapShroudTrait.getPlayerShroud(N)?.unrevealAround(B,S.rules.general.revealTriggerRadius);else console.warn(`No valid location found for waypoint ${O}. Skipping action ${this.getDebugName()}.`)}},S("UnrevealAroundWaypointExecutor",N)}}}),System.register("game/type/ArmorType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("ArmorType",B={}))[O.None=0]="None",O[O.Flak=1]="Flak",O[O.Plate=2]="Plate",O[O.Light=3]="Light",O[O.Medium=4]="Medium",O[O.Heavy=5]="Heavy",O[O.Wood=6]="Wood",O[O.Steel=7]="Steel",O[O.Concrete=8]="Concrete",O[O.Special_1=9]="Special_1",O[O.Special_2=10]="Special_2"}}}),System.register("game/type/LandTargeting",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("LandTargeting",B={}))[O.LandOk=0]="LandOk",O[O.LandNotOk=1]="LandNotOk",O[O.LandSecondary=2]="LandSecondary"}}}),System.register("game/type/LandType",["engine/type/TerrainType"],function(S,O){"use strict";var B,N,j;return O&&O.id,S("getLandType",function(S){if(!j.has(S))throw new Error("Unknown terrain type "+S);return j.get(S)}),{setters:[function(S){B=S}],execute:function(){var O;(O=N||S("LandType",N={}))[O.Clear=0]="Clear",O[O.Road=1]="Road",O[O.Rock=2]="Rock",O[O.Beach=3]="Beach",O[O.Rough=4]="Rough",O[O.Railroad=5]="Railroad",O[O.Weeds=6]="Weeds",O[O.Water=7]="Water",O[O.Wall=8]="Wall",O[O.Tiberium=9]="Tiberium",O[O.Cliff=10]="Cliff",j=new Map([[B.TerrainType.Default,N.Clear],[B.TerrainType.Clear,N.Clear],[B.TerrainType.Tunnel,N.Cliff],[B.TerrainType.Railroad,N.Railroad],[B.TerrainType.Rock1,N.Rock],[B.TerrainType.Rock2,N.Rock],[B.TerrainType.Water,N.Water],[B.TerrainType.Shore,N.Beach],[B.TerrainType.Pavement,N.Road],[B.TerrainType.Dirt,N.Road],[B.TerrainType.Rough,N.Rough],[B.TerrainType.Cliff,N.Cliff]])}}}),System.register("game/type/LocomotorType",["game/type/SpeedType"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){var O;(O=N||S("LocomotorType",N={}))[O.Statue=0]="Statue",O[O.Aircraft=1]="Aircraft",O[O.Chrono=2]="Chrono",O[O.Hover=3]="Hover",O[O.Infantry=4]="Infantry",O[O.Jumpjet=5]="Jumpjet",O[O.Missile=6]="Missile",O[O.Ship=7]="Ship",O[O.Vehicle=8]="Vehicle",S("locomotorTypesByClsId",new Map([["{4A582746-9839-11d1-B709-00A024DDAFD1}",N.Aircraft],["{4A582747-9839-11d1-B709-00A024DDAFD1}",N.Chrono],["{4A582742-9839-11d1-B709-00A024DDAFD1}",N.Hover],["{4A582744-9839-11d1-B709-00A024DDAFD1}",N.Infantry],["{92612C46-F71F-11d1-AC9F-006008055BB5}",N.Jumpjet],["{B7B49766-E576-11d3-9BD9-00104B972FE8}",N.Missile],["{2BEA74E1-7CCA-11d3-BE14-00104B62A16C}",N.Ship],["{4A582741-9839-11d1-B709-00A024DDAFD1}",N.Vehicle]])),S("defaultSpeedsByLocomotor",new Map([[N.Infantry,B.SpeedType.Foot],[N.Ship,B.SpeedType.Float],[N.Hover,B.SpeedType.Hover],[N.Jumpjet,B.SpeedType.Winged],[N.Aircraft,B.SpeedType.Winged],[N.Missile,B.SpeedType.Winged]]))}}}),System.register("game/type/MovementZone",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("MovementZone",B={}))[O.Amphibious=0]="Amphibious",O[O.AmphibiousCrusher=1]="AmphibiousCrusher",O[O.AmphibiousDestroyer=2]="AmphibiousDestroyer",O[O.Crusher=3]="Crusher",O[O.CrusherAll=4]="CrusherAll",O[O.Destroyer=5]="Destroyer",O[O.Fly=6]="Fly",O[O.Infantry=7]="Infantry",O[O.InfantryDestroyer=8]="InfantryDestroyer",O[O.Normal=9]="Normal",O[O.Subterranean=10]="Subterranean",O[O.Water=11]="Water"}}}),System.register("game/type/NavalTargeting",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("NavalTargeting",B={}))[O.UnderwaterNever=0]="UnderwaterNever",O[O.UnderwaterSecondary=1]="UnderwaterSecondary",O[O.UnderwaterOnly=2]="UnderwaterOnly",O[O.OrganicSecondary=3]="OrganicSecondary",O[O.SealSpecial=4]="SealSpecial",O[O.NavalAll=5]="NavalAll",O[O.NavalNone=6]="NavalNone"}}}),System.register("game/type/PipColor",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("PipColor",B={}))[O.Green=0]="Green",O[O.Yellow=1]="Yellow",O[O.White=2]="White",O[O.Red=3]="Red",O[O.Blue=4]="Blue"}}}),System.register("game/type/PowerupType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("PowerupType",B={}))[O.Armor=0]="Armor",O[O.Firepower=1]="Firepower",O[O.HealBase=2]="HealBase",O[O.Money=3]="Money",O[O.Reveal=4]="Reveal",O[O.Speed=5]="Speed",O[O.Veteran=6]="Veteran",O[O.Unit=7]="Unit",O[O.Invulnerability=8]="Invulnerability",O[O.IonStorm=9]="IonStorm",O[O.Gas=10]="Gas",O[O.Tiberium=11]="Tiberium",O[O.Pod=12]="Pod",O[O.Cloak=13]="Cloak",O[O.Darkness=14]="Darkness",O[O.Explosion=15]="Explosion",O[O.ICBM=16]="ICBM",O[O.Napalm=17]="Napalm",O[O.Squad=18]="Squad"}}}),System.register("game/type/SpeedType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("SpeedType",B={}))[O.Foot=0]="Foot",O[O.Track=1]="Track",O[O.Wheel=2]="Wheel",O[O.Hover=3]="Hover",O[O.Float=4]="Float",O[O.FloatBeach=5]="FloatBeach",O[O.Amphibious=6]="Amphibious",O[O.Winged=7]="Winged"}}}),System.register("game/type/SuperWeaponType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("SuperWeaponType",B={}))[O.MultiMissile=0]="MultiMissile",O[O.IronCurtain=1]="IronCurtain",O[O.LightningStorm=2]="LightningStorm",O[O.ChronoSphere=3]="ChronoSphere",O[O.ChronoWarp=4]="ChronoWarp",O[O.ParaDrop=5]="ParaDrop",O[O.AmerParaDrop=6]="AmerParaDrop"}}}),System.register("game/type/VhpScan",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("VhpScan",B={}))[O.None=0]="None",O[O.Normal=1]="Normal",O[O.Strong=2]="Strong"}}}),System.register("gui/CanvasMetrics",["util/disposable/CompositeDisposable","util/dom"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S},function(S){0}],execute:function(){S("CanvasMetrics",class{constructor(S,O){this.canvas=S,this.window=O,this.x=0,this.y=0,this.width=0,this.height=0,this.cssWidth=0,this.cssHeight=0,this.scaleX=1,this.scaleY=1,this.disposables=new B.CompositeDisposable,this.updateCanvasBoxMetrics=()=>{var S=this.canvas.getBoundingClientRect();this.x=S.left+(this.window.scrollX||0),this.y=S.top+(this.window.scrollY||0),this.width=this.canvas.width,this.height=this.canvas.height,this.cssWidth=S.width,this.cssHeight=S.height,this.scaleX=this.cssWidth?this.width/this.cssWidth:1,this.scaleY=this.cssHeight?this.height/this.cssHeight:1}}init(){this.updateCanvasBoxMetrics(),this.window.addEventListener("resize",this.updateCanvasBoxMetrics),this.disposables.add(()=>this.window.removeEventListener("resize",this.updateCanvasBoxMetrics))}notifyViewportChange(){this.updateCanvasBoxMetrics()}dispose(){this.disposables.dispose()}})}}}),System.register("gui/FullScreen",["util/disposable/CompositeDisposable","util/fullScreen","util/event"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("FullScreen",L=class e{static isFullScreenHotKey(S){return S.keyCode===this.hotKey.keyCode&&S.altKey===this.hotKey.altKey&&S.shiftKey===this.hotKey.shiftKey&&S.ctrlKey===this.hotKey.ctrlKey&&S.metaKey===this.hotKey.metaKey}get onChange(){return this._onChange.asEvent()}constructor(S){this.document=S,this.disposables=new B.CompositeDisposable,this._onChange=new j.EventDispatcher,this.handleFullScreenChange=S=>{this._onChange.dispatch(this,S)}}init(){const t=S=>{e.isFullScreenHotKey(S)&&(S.preventDefault(),S.stopPropagation(),this.toggle())};this.document.addEventListener("keydown",t),this.disposables.add(()=>this.document.removeEventListener("keydown",t));var S=N.setupFullScreenChangeListener(this.document,this.handleFullScreenChange);S&&this.disposables.add(S)}toggle(){this.toggleAsync().catch(S=>console.error(S))}isFullScreen(){return!!this.document.fullscreenElement}isAvailable(){return this.document.fullscreenEnabled||this.document.webkitFullscreenEnabled}async toggleAsync(){if(this.document.fullscreenElement){try{screen?.orientation?.unlock?.()}catch{}await this.document.exitFullscreen()}else{await this.document.documentElement.requestFullscreen();try{await(screen?.orientation?.lock?.("landscape"))}catch(S){console.warn("Orientation lock failed",S)}}}dispose(){this.disposables.dispose()}}),L.hotKey={altKey:!0,shiftKey:!1,ctrlKey:!1,metaKey:!1,keyCode:"F".charCodeAt(0)}}}}),System.register("gui/HtmlContainer",["gui/LazyHtmlElement"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.LazyHtmlElement{constructor(){super(...arguments),this.visible=!0,this.left=0,this.top=0,this.width=0,this.height=0,this.relativeMode=!1,this.translateMode=!1}render(){var S;this.isRendered()||((S=this.getElement())||(S=document.createElement("div"),this.setElement(S)),this.updateMode(),this.updatePosition(),this.updateVisibility(),this.updateSize()),super.render()}setRelativeMode(S){this.relativeMode=S,this.updateMode()}setTranslateMode(S){this.translateMode=S,this.updatePosition()}setPosition(S,O){this.left=S,this.top=O,this.updatePosition()}setSize(S,O){this.width=S,this.height=O,this.updateSize()}getSize(){return{width:this.width,height:this.height}}setVisible(S){S!==this.visible&&(this.visible=S,this.updateVisibility())}updateMode(){let S=this.getElement();S&&(this.relativeMode?S.style.position="relative":(S.style.overflow="visible",S.style.position="absolute"))}updatePosition(){let S=this.getElement();S&&(this.translateMode?(S.style.top=S.style.left="0",S.style.transform=`translate(${this.left}px, ${this.top}px)`):(S.style.left=this.left+"px",S.style.top=this.top+"px",S.style.transform=""))}updateSize(){let S=this.getElement();S&&(S.style.width="number"==typeof this.width?this.width+"px":this.width,S.style.height="number"==typeof this.height?this.height+"px":this.height)}hide(){this.setVisible(!1)}show(){this.setVisible(!0)}updateVisibility(){let S=this.getElement();S&&(S.style.display=this.visible?"block":"none")}},S("HtmlContainer",N)}}}),System.register("gui/HtmlReactElement",["react","react-dom","gui/HtmlContainer"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.HtmlContainer{static factory(S,O){return new this(O,S)}constructor(S,O){super(),this.options=S,this.Component=O}render(){var S;this.isRendered()||(S=document.createElement("div"),this.setElement(S),this.renderReactElement()),super.render()}renderReactElement(){N.default.render(B.default.createElement(this.Component,this.options),this.getElement())}applyOptions(S){S(this.options),this.refresh()}refresh(){this.isRendered()&&this.renderReactElement()}unrender(){var S=this.getElement();S&&this.isRendered()&&N.default.unmountComponentAtNode(S),super.unrender()}},S("HtmlReactElement",L)}}}),System.register("gui/LazyHtmlElement",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("LazyHtmlElement",class{constructor(S){this.children=new Set,this.rendered=!1,S&&this.setElement(S)}setElement(S){this.element=S}getElement(){return this.element}getChildren(){return[...this.children]}isRendered(){return this.rendered}add(...S){for(var O of S)this.children.has(O)||(this.children.add(O),this.rendered&&this.renderChild(O))}remove(...S){for(var O of S)this.children.has(O)&&(this.children.delete(O),this.rendered&&this.unrenderChild(O))}removeAll(){this.remove(...this.children)}render(){if(!this.element)throw new Error("An HTML element must be passed in the constructor or using the setter.");this.children.forEach(S=>this.renderChild(S)),this.rendered=!0}renderChild(S){S.render();var O=S.getElement();O&&this.getElement().appendChild(O)}unrenderChild(S){var O=S.getElement();O&&(S.unrender(),O.parentElement===this.getElement()&&this.getElement().removeChild(O))}unrender(){this.isRendered()&&(this.children.forEach(S=>this.unrenderChild(S)),this.rendered=!1)}})}}}),System.register("gui/Pointer",["util/PointerLock","util/math","util/disposable/CompositeDisposable","gui/PointerSprite","gui/PointerEvents","engine/type/PointerType","engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","util/BoxedVar"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S}],execute:function(){S("Pointer",class e{static factory(S,O,N,j,F,_){let U=L.PointerSprite.fromShpFile(S,O);U.setVisible(!1);var H=N.getCanvas(),V=new B.PointerLock(H,j);let W=new e(V,U,j,H,F,_);return W.pointerEvents=new D.PointerEvents(N,W.getPosition(),j,F),W.disposables.add(W.pointerEvents),W}constructor(S,O,B,L,D,_){this.pointerLock=S,this.sprite=O,this.document=B,this.canvas=L,this.canvasMetrics=D,this.mouseAcceleration=_,this.userLockMode=!1,this.userPointerVisible=!0,this.userPermissionGranted=!1,this.position={x:0,y:0},this.disposables=new j.CompositeDisposable,this.pointerType=F.PointerType.Default,this.pointerSubFrame=0,this.onMouseMove=S=>{let O=this.position;this.pointerLock.isActive()?(O.x=O.x+S.movementX,O.y=O.y+S.movementY):(O.x=(S.pageX-this.canvasMetrics.x)*(this.canvasMetrics.scaleX??1),O.y=(S.pageY-this.canvasMetrics.y)*(this.canvasMetrics.scaleY??1)),O.x=N.clamp(O.x,0,this.canvasMetrics.width-1),O.y=N.clamp(O.y,0,this.canvasMetrics.height-1),this.updateSpritePosition()}}getPosition(){return this.position}getPointerLock(){return this.pointerLock}init(){this.listenForFirstCanvasClick(),this.pointerLock.onChange.subscribe(S=>{this.sprite.setVisible(this.userPointerVisible&&S);const t=()=>{this.userLockMode&&this.pointerLock.request({unadjustedMovement:!this.mouseAcceleration.value}).catch(S=>{console.warn("Couldn't acquire pointer lock.",S),this.canvas.addEventListener("click",t,{once:!0})})};S||(this.canvas.addEventListener("click",t,{once:!0}),this.disposables.add(()=>this.canvas.removeEventListener("click",t)))}),this.document.addEventListener("mousemove",this.onMouseMove,!0),this.disposables.add(()=>this.document.removeEventListener("mousemove",this.onMouseMove,!0))}listenForFirstCanvasClick(){const e=async()=>{if(!this.userPermissionGranted)try{await this.pointerLock.request(),this.userLockMode||await this.pointerLock.exit(),this.userPermissionGranted=!0}catch(S){console.warn("Couldn't acquire initial pointer lock",S),this.canvas.addEventListener("click",e,{once:!0})}};this.canvas.addEventListener("click",e,{once:!0}),this.disposables.add(()=>this.canvas.removeEventListener("click",e))}lock(){this.userLockMode=!0,this.userPermissionGranted&&this.pointerLock.request({unadjustedMovement:!this.mouseAcceleration.value}).catch(S=>{console.warn("Couldn't reacquire pointer lock. Will attempt to require lock on next click",S),this.userPermissionGranted=!1,this.listenForFirstCanvasClick()})}unlock(){this.userLockMode=!1,this.pointerLock.exit().catch(S=>console.error("Couldn't release pointer lock. This should never happen",S))}setVisible(S){this.userPointerVisible=S,this.sprite.setVisible(S&&this.pointerLock.isActive())}getUserLockMode(){return this.userLockMode}getSprite(){return this.sprite}setPointerType(S,O=0){if(this.pointerType!==S||this.pointerSubFrame!==O){if(this.pointerType=S,this.pointerSubFrame=O,this.sprite.setAnimationRunner(void 0),[F.PointerType.Scroll,F.PointerType.NoScroll,F.PointerType.Pan].includes(S))this.sprite.setFrame(S+O);else{var B=S,N=(Object.keys(F.PointerType).map(Number).find(O=>!Number.isNaN(O)&&S<O)??this.sprite.getFrameCount())-1;if(this.sprite.setFrame(B),B<N){let S=new _.SimpleRunner,O=new H.AnimProps(new V.IniSection("dummy"),this.sprite.getFrameCount());O.loopCount=-1,O.start=B,O.loopStart=B,O.loopEnd=N,N=new U.Animation(O,new W.BoxedVar(1.5)),S.animation=N,this.sprite.setAnimationRunner(S)}}this.updateSpritePosition()}}updateSpritePosition(){let S={...this.position};var O=this.sprite.getSize(),B=Math.floor(O.width/2),j=Math.floor(O.height/2);this.pointerType>F.PointerType.Mini&&(S.x-=B,S.y-=j),[F.PointerType.Scroll,F.PointerType.NoScroll,F.PointerType.Pan].includes(this.pointerType)&&(S.x=N.clamp(S.x,0,this.canvasMetrics.width-1-O.width),S.y=N.clamp(S.y,0,this.canvasMetrics.height-1-O.height)),this.sprite.setPosition(S.x,S.y)}dispose(){this.disposables.dispose()}})}}}),System.register("gui/PointerEvents",["util/disposable/CompositeDisposable","util/array","util/math"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=(S,O)=>!!S.visible&&(S===O||!!S.parent&&L(S.parent,O)),S("PointerEvents",class{constructor(S,O,j,L){this.renderer=S,this.lockModePointer=O,this.document=j,this.canvasMetrics=L,this.disposables=new B.CompositeDisposable,this.canvasContext={handlers:new Map},this.objectContexts=new Map,this.intersectionsEnabled=!0,this.clickPaths=new Map,this.touchFingers=0,this.onDblClick=S=>{0===S.button&&this.onMouseEvent("dblclick",S)},this.onMouseMove=S=>{let O=this.getPointerPosition(S);if(this.intersectionsEnabled){let F=this.currentHoverPath?[...this.currentHoverPath]:void 0;var B=F?.[0],j=this.findObjectUnderPointer(O);let _=j?.object;if(this.currentHoverPath=void 0,_&&(this.currentHoverPath=[_],_.traverseAncestors(S=>{this.currentHoverPath.push(S)})),!N.equals(this.currentHoverPath??[],F??[])){if(F)for(var L of F)this.currentHoverPath&&this.currentHoverPath.includes(L)||this.notify("mouseleave",L,O,S,void 0,!1);if(this.currentHoverPath)for(var D of this.currentHoverPath)F&&F.includes(D)||this.notify("mouseenter",D,O,S,j,!1);B&&this.notify("mouseout",B,O,S),_&&this.notify("mouseover",_,O,S,j)}_?this.notify("mousemove",_,O,S,j):this.renderer.getScenes().forEach(B=>this.notify("mousemove",B.get3DObject(),O,S))}this.notify("mousemove","canvas",O,S)},this.onMouseDown=S=>{this.onMouseEvent("mousedown",S)},this.onMouseUp=S=>{this.onMouseEvent("mouseup",S)},this.onMouseWheel=S=>{this.onMouseEvent("wheel",S)},this.onTouchMove=S=>{if(S.preventDefault(),this.initialTouchEvent?.touches){let B=this.initialTouchEvent.touches[0];var O=[...S.changedTouches].find(S=>B.identifier===S.identifier);O&&(this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer.cb(),this.touchStartBuffer=void 0),O=this.fakeMouseEventFromTouch(O,S),this.onMouseMove(O))}},this.onTouchStart=S=>{S.preventDefault();let O=S.touches;var B,N;1<O.length?0<this.touchFingers||O[0].target===this.renderer.getCanvas()&&2===O.length&&(this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer=void 0),this.touchFingers=2,this.initialTouchEvent||(this.initialTouchEvent=S),B=this.initialTouchEvent.touches[0],N=this.fakeMouseEventFromTouch(B,S,2),this.onMouseEvent("mousedown",N)):(B=()=>{this.touchFingers=1;var B=this.fakeMouseEventFromTouch(O[0],S);this.onMouseEvent("mousedown",B)},N=setTimeout(B,50),this.touchStartBuffer={cb:B,timeoutId:N},this.initialTouchEvent=S)},this.onTouchEnd=S=>{if(S.preventDefault(),this.initialTouchEvent?.touches){let N=this.initialTouchEvent.touches[0];var O=[...S.changedTouches].find(S=>N.identifier===S.identifier);if(O){this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer.cb(),this.touchStartBuffer=void 0);var B=2===this.touchFingers?2:0;let N=this.fakeMouseEventFromTouch(O,S,B);N.touchDuration=S.timeStamp-this.initialTouchEvent.timeStamp,this.touchFingers=0,this.initialTouchEvent=void 0,this.onMouseEvent("mouseup",N)}}},this.onTouchCancel=S=>{this.onTouchEnd(S)};let D=S.getCanvas();D.addEventListener("dblclick",this.onDblClick,!1),D.addEventListener("mousemove",this.onMouseMove,!1),D.addEventListener("mousedown",this.onMouseDown,!1),D.addEventListener("mouseup",this.onMouseUp,!1),D.addEventListener("touchmove",this.onTouchMove,!1),D.addEventListener("touchstart",this.onTouchStart,!1),D.addEventListener("touchend",this.onTouchEnd,!1),D.addEventListener("touchcancel",this.onTouchCancel,!1),D.addEventListener("wheel",this.onMouseWheel,{passive:!0}),this.disposables.add(()=>{D.removeEventListener("dblclick",this.onDblClick,!1),D.removeEventListener("mousemove",this.onMouseMove,!1),D.removeEventListener("mousedown",this.onMouseDown,!1),D.removeEventListener("mouseup",this.onMouseUp,!1),D.removeEventListener("touchmove",this.onTouchMove,!1),D.removeEventListener("touchstart",this.onTouchStart,!1),D.removeEventListener("touchend",this.onTouchEnd,!1),D.removeEventListener("touchcancel",this.onTouchCancel,!1),D.removeEventListener("wheel",this.onMouseWheel,!1)})}addEventListener(S,O,B,N=!1){let j="canvas"===S?this.canvasContext:this.getOrCreateObjectContext(S),L=j.handlers.get(O);return L||(L=[],j.handlers.set(O,L)),L.push({callback:B,useCapture:N}),()=>this.removeEventListener(S,O,B,N)}removeEventListener(S,O,B,N=!1){let j="canvas"===S?this.canvasContext:this.objectContexts.get(S);if(j&&j.handlers.has(O)){let L=j.handlers.get(O);L=L.filter(S=>!(S.callback===B&&S.useCapture===N)),L.length?j.handlers.set(O,L):j.handlers.delete(O),j.handlers.size||"canvas"===S||this.objectContexts.delete(S)}}getOrCreateObjectContext(S){if(!S)throw new Error("Undefined Object3D instance.");let O=this.objectContexts.get(S);return O||(O={handlers:new Map},this.objectContexts.set(S,O)),O}fakeMouseEventFromTouch(S,O,B=0){var N=this.computeTouchPosition(S);return{offsetX:N.x,offsetY:N.y,button:B,touchId:S.identifier,isTouch:!0,virtual:!1,detail:1,altKey:O.altKey,ctrlKey:O.ctrlKey,metaKey:O.metaKey,shiftKey:O.shiftKey,timeStamp:O.timeStamp}}computeTouchPosition(S){let O={x:(S.pageX-this.canvasMetrics.x)*(this.canvasMetrics.scaleX??1),y:(S.pageY-this.canvasMetrics.y)*(this.canvasMetrics.scaleY??1)};return O.x=j.clamp(O.x,0,this.canvasMetrics.width-1),O.y=j.clamp(O.y,0,this.canvasMetrics.height-1),O}onMouseEvent(S,O){let B=this.getPointerPosition(O);var N=this.findObjectUnderPointer(B);if(N?this.notify(S,N.object,B,O,N):this.renderer.getScenes().forEach(N=>this.notify(S,N.get3DObject(),B,O)),this.notify(S,"canvas",B,O),"mousedown"===S||"mouseup"===S){let L=N?.object,D=[];if(L&&(D=[L],L.traverseAncestors(S=>{D.push(S)})),"mousedown"===S)this.clickPaths.set(O.button,D);else{let S=this.clickPaths.get(O.button);this.clickPaths.delete(O.button);let L=!1;for(var j of D)if(S?.includes(j)){this.notify("click",j,B,O,N),L=!0;break}L||this.renderer.getScenes().forEach(S=>this.notify("click",S.get3DObject(),B,O)),this.notify("click","canvas",B,O)}}}getPointerPosition(S){return this.document.pointerLockElement?this.lockModePointer:{x:S.isTouch?S.offsetX:S.offsetX*(this.canvasMetrics.scaleX??1),y:S.isTouch?S.offsetY:S.offsetY*(this.canvasMetrics.scaleY??1)}}findObjectUnderPointer(S){let O=this.renderer.getScenes(),B=this.groupObjectsByScene();for(let j=O.length-1;0<=j;j--){let D=new THREE.Raycaster;var N=this.normalizePointer(S,O[j].viewport);D.setFromCamera(N,O[j].camera),N=B.get(O[j].scene).filter(S=>L(S,O[j].get3DObject()));let F=D.intersectObjects(N,!0);if(F.length){if(1===F.length)return F[0];let S=new Set(F.map(S=>S.object));return F.forEach(O=>{S.has(O.object)&&O.object.traverseAncestors(O=>{S.has(O)&&S.delete(O)})}),F.filter(O=>S.has(O.object))[0]}}}normalizePointer(S,O){return{x:(S.x-O.x)/O.width*2-1,y:-(S.y-O.y)/O.height*2+1}}groupObjectsByScene(){let S=new Map;return this.renderer.getScenes().forEach(O=>S.set(O.get3DObject(),[])),[...this.objectContexts.keys()].forEach(O=>{if("Scene"!==O.type){let B=O;for(;B.parent;)B=B.parent;"Scene"===B.type&&S.get(B).push(O)}}),S}notify(S,O,B,N,j,L=!0){let D="canvas"===O?this.canvasContext:this.objectContexts.get(O),F=D?.handlers.get(S);if(F&&F.length||"canvas"!==O&&O.parent&&L&&this.notify(S,O.parent,B,N,j),F&&F.length){let D=!0,_=!1,U=F.filter(S=>S.useCapture),H=F.filter(S=>!S.useCapture),V=[...U,...H];for(let F of V){let U=!0;if(F.callback({type:S,target:"canvas"!==O?O:void 0,pointer:{...B},intersection:j,button:N.button,isTouch:!!N.isTouch,virtual:!!N.virtual,touchDuration:N.touchDuration,clicks:N.detail,altKey:N.altKey,ctrlKey:N.ctrlKey,metaKey:N.metaKey,shiftKey:N.shiftKey,timeStamp:N.timeStamp,wheelDeltaY:N.deltaY??0,stopPropagation:()=>{D=!1,U=!1},stopImmediatePropagation:()=>{D=!1,U=!1,_=!0}}),U&&"canvas"!==O&&!F.useCapture&&O.parent&&L&&this.notify(S,O.parent,B,N,j),_&&(D=!1),_)break}}}virtualClick(S,{button:O=0,clicks:B=1,mods:N}={}){let j={offsetX:S.x,offsetY:S.y,button:O,isTouch:!0,virtual:!0,detail:B,altKey:!!N?.altKey,ctrlKey:!!N?.ctrlKey,metaKey:!!N?.metaKey,shiftKey:!!N?.shiftKey,timeStamp:Date.now()};this.onMouseEvent("mousedown",j),this.onMouseEvent("mouseup",j)}resetTouchState(){this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer=void 0),this.touchFingers=0,this.initialTouchEvent=void 0}dispose(){this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer=void 0),this.disposables.dispose()}})}}}),System.register("gui/PointerSprite",["gui/UiObject","engine/gfx/ImageUtils","gui/HtmlContainer"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class e extends B.UiObject{static fromShpFile(S,O){return new this(N.ImageUtils.convertShpToCanvas(S,O),{width:S.width,height:S.height},S.numImages)}constructor(S,O,B){super(new THREE.Object3D,new j.HtmlContainer),this.images=S,this.size=O,this.frameCount=B,this.currentFrame=0}setAnimationRunner(S){this.animationRunner=S}getAnimationRunner(){return this.animationRunner}update(S){super.update(S),this.animationRunner&&(this.animationRunner.tick(S),this.animationRunner.shouldUpdate()&&this.setFrame(this.animationRunner.getCurrentFrame()))}getSize(){return this.size}setFrame(S){if(S!==this.currentFrame){if(S<0||this.frameCount<=S)throw new RangeError(`Pointer frame index out of bounds (index=${S}, length=${this.frameCount})`);this.currentFrame=S,this.drawFrame(S)}}drawFrame(S){this.targetContext&&(this.targetContext.clearRect(0,0,this.size.width,this.size.height),this.targetContext.drawImage(this.images,S*this.size.width,0,this.size.width,this.size.height,0,0,this.size.width,this.size.height))}getFrame(){return this.currentFrame}getFrameCount(){return this.frameCount}create3DObject(){if(super.create3DObject(),!this.targetContext){let O=document.createElement("canvas"),B=this.getHtmlContainer();B.setTranslateMode(!0);let N=B.getElement();N.appendChild(O),N.style.zIndex=""+e.HTML_ZINDEX;var S=O.getContext("2d",{alpha:!0});if(!S)throw new Error("Couldn't create pointer canvas context");this.targetContext=S,this.drawFrame(this.currentFrame)}}destroy(){super.destroy()}},S("PointerSprite",L),L.HTML_ZINDEX=100}}}),System.register("gui/ReactFormat",["react"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=/(\[(?:[^\]]+)\]\((?:https?:\/\/[^\s]+|mailto:[^\s]+)\))|(https?:\/\/[^\s]+|mailto:[^\s]+)/g,j=/^\[([^\]]+)\]\((https?:\/\/[^\s]+|mailto:[^\s]+)\)$/,S("ReactFormat",class{static formatMultiline(S,O){return S.split(/\n/g).map((S,N)=>N?B.createElement(B.Fragment,{key:N},B.createElement("br",null),O(S)):S)}static formatUrls(S){return B.createElement(B.Fragment,null,S.split(N).filter(Boolean).map((S,O)=>{if(!N.test(S))return S;let L,D;var F=S.match(j);return F?[,L,D]=F:L=D=S,B.createElement("a",{key:O,href:D,rel:"noopener noreferrer",target:"_blank"},L)}))}})}}}),System.register("gui/ReplayManager",["network/gamestate/Replay","gui/replay/ReplayExistsError"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("ReplayManager",class{constructor(S){this.storage=S}async loadList(S=!1){return await this.storage.getManifest(S)}async loadSerializedReplay(S){return await this.storage.getReplayData(S)}async loadReplay(S){let O=await this.loadSerializedReplay(S),N=new B.Replay;return N.unserialize("string"==typeof O?O:await O.text(),S),N}async saveReplay(S,O=!1){var B=S.name;if(!B)throw new Error("Replay is not initialized");var N=THREE.Math.generateUUID(),j=S.serialize();let L={id:N,name:B,keep:O,timestamp:S.timestamp},D=1;for(;await this.storage.hasReplayData(L);)1<D&&(L.name=L.name.replace(/ \(\d+\)$/,"")),L.name+=` (${++D})`;let F=await this.loadList(),_=F.filter(S=>!S.keep);if(50<_.length)for(var U of _.slice(50))await this.storage.deleteReplayData(U),F.splice(F.indexOf(U),1);return F.unshift(L),await this.storage.saveReplayData(L,j),await this.storage.saveManifest(F),N}async keepReplay(S,O){let j=await this.loadList();var L=j.find(O=>O.id===S);if(L){var D={...L,name:B.Replay.sanitizeFileName(O),keep:!0};if(await this.storage.hasReplayData(D))throw new N.ReplayExistsError(`A replay with name "${D.name}" already exists`);let S=await this.storage.getReplayData(L);var F="string"==typeof S?S:await S.text();await this.storage.deleteReplayData(L),await this.storage.saveReplayData(D,F),Object.assign(L,D),await this.storage.saveManifest(j)}}async deleteReplay(S){await this.storage.deleteReplayData(S);let O=await this.loadList();var B=O.findIndex(O=>O.id===S.id);-1!==B&&(O.splice(B,1),await this.storage.saveManifest(O))}async importReplay(S){return new Promise((O,N)=>{let j=new FileReader;j.onload=async j=>{try{var L=S.name.replace(B.Replay.extension,"");let N=new B.Replay;N.unserialize(j.target.result,{name:L,timestamp:S.lastModified}),await this.saveReplay(N,!0),O(N)}catch(S){N(S)}},j.onerror=()=>{N(j.error)},j.readAsText(S,"utf-8")})}})}}}),System.register("gui/ShpSpriteBatch",["gui/UiObject","gui/HtmlContainer","data/ShpFile","engine/renderable/builder/BatchShpBuilder"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends B.UiObject{constructor(S,O,B,j){super(new THREE.Object3D,new N.HtmlContainer),this.spriteProps=S,this.getShpFile=O,this.getPalette=B,this.camera=j,this.textureCache=new Map,this.batchShpBuilders=[]}create3DObject(){super.create3DObject();var S=this.createAggregatedShpFile();this.createObjects(this.get3DObject(),S)}createAggregatedShpFile(){let S=new j.ShpFile;S.filename="agg_unnamed_spritebatch.shp";let O=new Map,B=0;for(var N of this.spriteProps)N=("string"==typeof N.image?this.getShpFile(N.image):N.image).getImage(N.frame??0),O.has(N)||(S.addImage(N),O.set(N,B),B++);return{file:S,imageIndexes:O}}createObjects(S,O){let N=new Map;for(var j of this.spriteProps){var D=("string"==typeof j.palette?this.getPalette(j.palette):j.palette).hash;N.set(D,(N.get(D)??[]).concat(j))}for(var F of N.values()){var _,U="string"==typeof F[0].palette?this.getPalette(F[0].palette):F[0].palette;let N=[];for(_ of F){let S="string"==typeof _.image?this.getShpFile(_.image):_.image;var H=O.imageIndexes.get(S.getImage(_.frame??0));if(void 0===H)throw new Error("Missing frame in aggregated sprite shp file");H={position:new THREE.Vector3(_.x??0,_.y??0,B.UiObject.zIndexToWorld(_.zIndex??0)),shpFile:S,depth:!1,flat:!1,frameNo:H,offset:{x:S.width/2,y:S.height/2}},N.push(H)}if(N.length){let B=new L.BatchShpBuilder(O.file,U,this.camera,this.textureCache,void 0,void 0,N.length);N.forEach(S=>B.add(S)),this.batchShpBuilders.push(B),S.add(B.build())}}}destroy(){super.destroy(),this.batchShpBuilders.forEach(S=>S.dispose()),[...this.textureCache.values()].forEach(S=>S.dispose()),this.textureCache.clear()}},S("ShpSpriteBatch",D)}}}),System.register("gui/UiObject",["engine/renderable/WithPosition","engine/gfx/RenderableContainer","util/event","engine/renderable/WithVisibility"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("UiObject",class e{get onFrame(){return this._onFrame.asEvent()}get onDispose(){return this._onDispose.asEvent()}static zIndexToWorld(S){return-S}constructor(S,O){this.rendered=!1,this.eventHandlers=[],this._onFrame=new j.EventDispatcher,this._onDispose=new j.EventDispatcher,S&&this.set3DObject(S),O&&this.setHtmlContainer(O),this.withPosition=new B.WithPosition,this.withVisibility=new L.WithVisibility,this.container=new N.RenderableContainer}get3DObject(){return this.target}set3DObject(S){(this.target=S).matrixAutoUpdate=!1}getRenderableContainer(){return this.container}getHtmlContainer(){return this.htmlContainer}setHtmlContainer(S){this.htmlContainer=S}setPosition(S,O){var B=this.withPosition.getPosition().z||0;this.withPosition.setPosition(S,O,B),this.htmlContainer?.setPosition(S,O)}getPosition(){var{x:S,y:O}=this.withPosition.getPosition();return{x:S,y:O}}setZIndex(S){var O=this.withPosition.getPosition();this.withPosition.setPosition(O.x,O.y,e.zIndexToWorld(S))}setVisible(S){this.withVisibility.setVisible(S),this.htmlContainer?.setVisible(S)}isVisible(){return this.withVisibility.isVisible()}setTooltip(S){this.tooltip=S,this.updateTooltip()}updateTooltip(){let S=this.get3DObject();S&&(S.userData.tooltip=this.tooltip)}setPointerEvents(S){if(this.pointerEvents)throw new Error("A PointerEvents instance is already set");this.pointerEvents=S}addEventListener(S,O){return this.eventHandlers.push({eventName:S,handler:O}),this.rendered&&this.setupEventListener(S,O),()=>this.removeEventListener(S,O)}removeEventListener(S,O){var B=this.eventHandlers.findIndex(B=>S===B.eventName&&O===B.handler);-1!==B&&(this.eventHandlers[B].disposer?.(),this.eventHandlers.splice(B,1))}setupEventListener(S,O){if(!this.pointerEvents)throw new Error("A PointerEvents object must be provided prior to setting up an event listener");var B=this.pointerEvents.addEventListener(this.get3DObject(),S,O);let N=this.eventHandlers.find(B=>S===B.eventName&&O===B.handler);N&&(N.disposer=B)}create3DObject(){if(!this.get3DObject())throw new Error("Expecting a THREE.Object3D to have been set by now");this.rendered||(this.rendered=!0,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.withVisibility.applyTo(this),this.htmlContainer?.render(),this.htmlContainer?.setPosition(this.withPosition.getPosition().x,this.withPosition.getPosition().y),this.htmlContainer?.setVisible(this.withVisibility.isVisible()),this.container.set3DObject(this.get3DObject()),this.container.create3DObject(),this.updateTooltip(),this.eventHandlers.forEach(S=>this.setupEventListener(S.eventName,S.handler)))}update(S){this.container.update(S),this._onFrame.dispatch(this,S)}add(...S){this.container.add(...S),S.map(S=>S.getHtmlContainer()).forEach(S=>{if(S){if(!this.htmlContainer)throw new Error("Can't add an UiObject that defines an HTMLContainer to a parent that doesn't provide an HTML container.");this.htmlContainer.add(S)}})}remove(...S){S.map(S=>S.getHtmlContainer()).forEach(S=>S&&this.htmlContainer?.remove(S)),this.container.remove(...S)}removeAll(){this.container.removeAll()}destroy(){this.container.getChildren().forEach(S=>S.destroy?.()),this.htmlContainer?.unrender(),this.eventHandlers.forEach(S=>S.disposer?.()),this.eventHandlers.length=0,this._onFrame=new j.EventDispatcher,this._onDispose.dispatch(),this._onDispose=new j.EventDispatcher}})}}}),System.register("gui/UiObjectSprite",["engine/renderable/builder/ShpBuilder","gui/UiObject"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends N.UiObject{static fromShpFile(S,O,N){let j=new B.ShpBuilder(S,O,N);return j.setBatched(!0),j.setBatchPalettes([O]),j.setOffset({x:Math.floor(S.width/2),y:Math.floor(S.height/2)}),new this(j)}constructor(S){super(),this.builder=S}setAnimationRunner(S){this.animationRunner=S}getAnimationRunner(){return this.animationRunner}update(S){super.update(S),this.animationRunner&&(this.animationRunner.tick(S),this.animationRunner.shouldUpdate()&&this.setFrame(this.animationRunner.getCurrentFrame()))}getSize(){return this.builder.getSize()}setFrame(S){this.builder.setFrame(S)}getFrame(){return this.builder.getFrame()}getFrameCount(){return this.builder.frameCount}setTransparent(S){this.get3DObject()?this.builder.setForceTransparent(S):this.initialTransparency=S}setOpacity(S){this.get3DObject()?this.builder.setOpacity(S):this.initialOpacity=S}setLightMult(S){this.get3DObject()?this.builder.setExtraLight((new THREE.Vector3).addScalar(-1+S)):this.initialLightMult=S}create3DObject(){this.set3DObject(this.builder.build()),super.create3DObject(),void 0!==this.initialTransparency&&this.builder.setForceTransparent(this.initialTransparency),void 0!==this.initialOpacity&&this.builder.setOpacity(this.initialOpacity),void 0!==this.initialLightMult&&this.builder.setExtraLight((new THREE.Vector3).addScalar(this.initialLightMult))}destroy(){super.destroy(),this.builder.dispose()}},S("UiObjectSprite",j)}}}),System.register("gui/UiScene",["gui/UiObject","gui/HtmlContainer","engine/gfx/batch/MeshBatchManager"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class e extends B.UiObject{static factory(S){let O=new THREE.Scene;O.matrixAutoUpdate=!1;var B=e.createCamera(S),j=new N.HtmlContainer;return new e(O,B,S,j)}static createCamera(S){var O=S.height/2,B=S.width/S.height;let N=new THREE.OrthographicCamera(-O*B,O*B,O,-O,-1e3,1e3);return N.rotation.x=Math.PI,N.position.x=-S.x+S.width/2,N.position.y=-S.y+S.height/2,N.position.z=-1e3,N}constructor(S,O,B,N){super(S,N),this.scene=S,this.camera=O,this.viewport=B}setCamera(S){this.camera=S}setViewport(S){this.viewport=S}create3DObject(){var S;super.create3DObject(),this.meshBatchManager||(S=this.meshBatchManager=new j.MeshBatchManager(this.getRenderableContainer()),this.getRenderableContainer().add(S),this.scene.autoUpdate=!1)}update(S){super.update(S),this.meshBatchManager&&(this.scene.updateMatrixWorld(!1),this.meshBatchManager.updateMeshes())}get menuViewport(){return{x:Math.max(0,(this.viewport.width-800)/2),y:Math.max(0,(this.viewport.height-600)/2),width:800,height:600}}destroy(){super.destroy(),this.meshBatchManager?.dispose()}},S("UiScene",L)}}}),System.register("gui/chat/ChatHistory",["network/chat/ChatMessage","network/gservConfig","util/BoxedVar","util/event"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("ChatHistory",class{constructor(){this.lastWhisperFrom=new j.BoxedVar(void 0),this.lastWhisperTo=new j.BoxedVar(void 0),this.lastComposeTarget=new j.BoxedVar({type:B.ChatRecipientType.Channel,name:N.RECIPIENT_ALL}),this.messages=[],this._onNewMessage=new L.EventDispatcher}get onNewMessage(){return this._onNewMessage.asEvent()}addChatMessage(S){this.messages.push(S),this._onNewMessage.dispatch(this,S)}getAll(){return this.messages}})}}}),System.register("gui/chat/ChatMessageFormat",["react","network/chat/ChatMessage","network/gservConfig","gui/ReactFormat"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("ChatMessageFormat",class{constructor(S,O,B){this.strings=S,this.localUsername=O,this.userColors=B}formatPrefixPlain(S){let O;if(S.to.type===N.ChatRecipientType.Channel)O=S.to.name===j.RECIPIENT_TEAM?this.strings.get("TS:ChatFromAllies",S.from):this.strings.get("TS:ChatFrom",S.from);else if(S.to.type===N.ChatRecipientType.Page)O=this.strings.get("TS:PageFrom",S.from);else{if(S.to.type!==N.ChatRecipientType.Whisper)throw new Error("Unknown message type "+S.to.type);O=S.from===this.localUsername?this.strings.get("TS:To",S.to.name):this.strings.get("TXT_FROM",S.from)}return O}formatPrefixHtml(S,O){let L,D=S.to.type===N.ChatRecipientType.Whisper&&S.from===this.localUsername?S.to.name:S.from,F=D;var _,U="{user}";let H;if(S.to.type!==N.ChatRecipientType.Page&&(void 0!==(_=this.userColors?.get(S.from))&&(F=B.default.createElement("span",{style:{color:_}},F)),O&&(V=this.strings.get("TS:ChatUserLink",U).split(U),F=B.default.createElement("span",{className:"user-link",onClick:()=>O(D)},V[0],F,V[1])),L=this.strings.get("TS:ChatTimestamp",S.time.toLocaleTimeString(void 0,{timeStyle:"short"}))+" "),S.to.type===N.ChatRecipientType.Channel)H=S.to.name===j.RECIPIENT_TEAM?this.strings.get("TS:ChatFromAllies",U):this.strings.get("TS:ChatFrom",U);else if(S.to.type===N.ChatRecipientType.Page)H=this.strings.get("TS:PageFrom",U);else{if(S.to.type!==N.ChatRecipientType.Whisper)throw new Error("Unknown message type "+S.to.type);H=S.from===this.localUsername?this.strings.get("TS:To",U):this.strings.get("TXT_FROM",U)}var[V,U]=H.split(U);return B.default.createElement(B.default.Fragment,null,L,V,F,U)}formatTextHtml(S,O){return O?L.ReactFormat.formatUrls(S):S}})}}}),System.register("gui/component/BasicErrorBoxApi",["gui/HtmlReactElement","util/disposable/CompositeDisposable","gui/component/Dialog","gui/ReactFormat"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("BasicErrorBoxApi",class{constructor(S,O,B){this.viewport=S,this.strings=O,this.rootEl=B,this.disposables=new N.CompositeDisposable}async show(S,O=!1){return new Promise(N=>{let D=this.component=B.HtmlReactElement.factory(j.Dialog,{children:L.ReactFormat.formatMultiline(S,S=>L.ReactFormat.formatUrls(S)),className:"basic-error-box",viewport:this.viewport.value,buttons:O?[]:[{label:this.strings.get("GUI:Ok"),onClick:()=>{this.destroy(),N()}}]}),o=S=>{this.component.setSize(S.width,S.height),this.component.applyOptions(O=>O.viewport=S)};this.viewport.onChange.subscribe(o),D.setSize(this.viewport.value.width,this.viewport.value.height),D.render(),this.rootEl.appendChild(D.getElement()),this.disposables.add(()=>this.viewport.onChange.unsubscribe(o),()=>this.component.getElement()&&this.rootEl.removeChild(this.component.getElement()),()=>this.component.unrender(),()=>this.component=void 0)})}destroy(){this.disposables.dispose()}})}}}),System.register("gui/component/ButtonSelect",["react","classnames"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("ButtonSelect",({initialValue:S,disabled:O,tooltip:j,className:L,onSelect:D,labelStyle:F,children:_})=>{let[U,H]=B.useState(()=>S),[V,W]=B.useState(()=>S);var z=B.useRef(null);return B.useEffect(()=>{U!==S&&(H(S),W(S))},[S]),B.useEffect(()=>{W(U)},[]),B.default.createElement("div",{className:N.default("button-select",{disabled:O},L),"data-r-tooltip":j,ref:z},B.default.Children.map(_,S=>{if(!S)return null;const N=S.props.value,j=S.props.disabled;return B.default.createElement("div",{onMouseEnter:()=>!j&&W(N),onMouseLeave:()=>V===N&&W(void 0)},B.default.cloneElement(S,{selected:N===U||N===V,disabled:j||O,labelStyle:F?.(N),onClick:()=>{var S;H(S=N),W(S),D(S)}}))}))})}}}),System.register("gui/component/ChannelOpIndicator",["react","gui/component/Image"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("ChannelOpIndicator",({operator:S})=>B.default.createElement("div",{className:"channel-op-indicator"},S?B.default.createElement(N.Image,{src:"woloper.pcx"}):null))}}}),System.register("gui/component/ChannelUser",["classnames","gui/screen/mainMenu/lobby/component/RankIndicator","react","gui/component/ChannelOpIndicator"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("ChannelUser",({user:S,playerProfile:O,strings:D,onClick:F})=>{let _=S.name;return S.operator&&(_+=" : "+D.get("TXT_OPER")),_+=void 0!==O?.rank?" : "+D.get(N.RANK_LABELS.get(O.rankType)):" : "+D.get("TXT_UNRANKED"),j.default.createElement("div",{className:B.default("player",{operator:S.operator}),"data-r-tooltip":_,onClick:F},j.default.createElement(L.ChannelOpIndicator,{operator:S.operator}),j.default.createElement(N.RankIndicator,{playerProfile:O,strings:D}),S.name)})}}}),System.register("gui/component/Chat",["react","classnames","network/chat/ChatMessage","gui/chat/ChatMessageFormat","gui/component/ChatInput"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=(new Map).set(j.ChatRecipientType.Channel,"type-channel").set(j.ChatRecipientType.Page,"type-page").set(j.ChatRecipientType.Whisper,"type-whisper"),_=class extends B.default.Component{constructor(){super(...arguments),this.prevMessageCount=0}render(){let{messages:S,tooltips:O,strings:N,chatHistory:j,channels:L}=this.props;return B.default.createElement("div",{className:"chat-wrapper"},B.default.createElement("div",{className:"messages",ref:S=>this.messageList=S,"data-r-tooltip":O?.output},S.map((S,O)=>this.renderMessage(S,O))),B.default.createElement("div",{className:"new-message-wrapper"},B.default.createElement(D.ChatInput,{ref:S=>this.textBox=S,chatHistory:j,channels:L,className:"new-message",tooltip:O?.input,strings:N,onSubmit:this.props.onSendMessage,onCancel:this.props.onCancelMessage}),B.default.createElement("button",{className:"icon-button send-message-button","data-r-tooltip":O?.button,onClick:()=>this.textBox.send()})))}componentDidUpdate(S,O){var B,N;this.props.messages[0]===this.prevOldestMessage&&this.props.messages.length===this.prevMessageCount||(this.prevMessageCount=this.props.messages.length,this.prevOldestMessage=this.props.messages[0],B=this.messageList.scrollHeight,N=this.messageList.clientHeight,B!==this.prevScrollHeight&&(!this.prevScrollHeight||Math.abs(this.messageList.scrollTop-(this.prevScrollHeight-N))<=1)&&(this.messageList.scrollTop=B-N),this.prevScrollHeight=B)}renderMessage(S,O){let D,_=new L.ChatMessageFormat(this.props.strings,this.props.localUsername,this.props.userColors),U=["message"];void 0!==S.from&&(D=_.formatPrefixHtml(S,O=>{this.props.chatHistory&&S.to&&S.to.type!==j.ChatRecipientType.Page&&(this.props.chatHistory.lastComposeTarget.value={type:j.ChatRecipientType.Whisper,name:O})}),U.push(F.get(S.to.type),{"operator-message":S.operator}));var H=void 0===S.from;return H=_.formatTextHtml(S.text,H),B.default.createElement("div",{key:O,className:N.default(U)},D?B.default.createElement(B.default.Fragment,null,B.default.createElement("span",null,D)," ",H):H)}},S("Chat",_)}}}),System.register("gui/component/ChatInput",["react","network/chat/ChatMessage","network/gservConfig"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("IMPLICIT_CHANNEL_NAME",""),L=({chatHistory:S,channels:O,strings:L,className:D,tooltip:F,forceColor:_,noCycleHint:U,submitEmpty:H,onKeyDown:V,onKeyUp:W,onBlur:z,onCancel:K,onSubmit:$},q)=>{const Q=B.useRef(null),[Z,Y]=B.useState(()=>P()),[X,J]=B.useState(()=>{var B=S?.lastComposeTarget.value;return I(B)?B:{type:N.ChatRecipientType.Channel,name:O[0]??""}}),[ee,te]=B.useState(),[ie,re]=B.useState(),[se,ne]=B.useState(!1),[ae,oe]=B.useState(!1);function P(){const B=(O.length?O:[""]).map(S=>({type:N.ChatRecipientType.Channel,name:S}));var j,L;return S&&(j=S.lastWhisperFrom.value,L=S.lastWhisperTo.value,j&&B.push({type:N.ChatRecipientType.Whisper,name:j}),L&&L!==j&&B.push({type:N.ChatRecipientType.Whisper,name:L})),B}function I(S){return S&&(S.type!==N.ChatRecipientType.Channel||O.includes(S.name))}function k(O){S&&(S.lastComposeTarget.value=O),J(O)}B.useEffect(()=>{Q.current?.focus()},[]),B.useEffect(()=>{I(X)||J({type:N.ChatRecipientType.Channel,name:O[0]??""})},[O]),B.useEffect(()=>{if(S){let t=S=>{X!==S&&I(S)&&(J(S),Q.current?.focus())},i=()=>{Y(P())};return S.lastComposeTarget.onChange.subscribe(t),S.lastWhisperFrom.onChange.subscribe(i),S.lastWhisperTo.onChange.subscribe(i),()=>{S.lastComposeTarget.onChange.unsubscribe(t),S.lastWhisperFrom.onChange.unsubscribe(i),S.lastWhisperTo.onChange.unsubscribe(i)}}},[X,S,O]),B.useImperativeHandle(q,()=>({send(){let S=Q.current;var O;!S||(O=S.value).length&&($({recipient:X,value:O}),S.value="",S.focus(),re(O))}}),[X]);var le=function(S){if(S.type===N.ChatRecipientType.Channel)return S.name===j.RECIPIENT_TEAM?L.get("TS:ToAllies"):S.name===j.RECIPIENT_ALL?L.get("TS:ToAll"):"";if(S.type===N.ChatRecipientType.Whisper)return L.get("TS:To",S.name);throw new Error(`Recipient type ${S.type} not implemented`)}(X);let ce=!U&&se&&!ae&&(1<Z.length||X.type===N.ChatRecipientType.Whisper)?L.get("TS:ChatCycleHint","Tab"):void 0;return B.default.createElement("div",{className:D},le&&B.default.createElement("label",{style:{color:_}},le),B.default.createElement("input",{type:"text",autoComplete:"off",spellCheck:!1,ref:Q,maxLength:128,"data-r-tooltip":F,placeholder:ce,style:{color:_},onKeyDown:S=>{"Tab"===S.key&&S.preventDefault(),S.repeat||te(S.key),V?.(S)},onKeyUp:S=>{let O=S.target;var B;"Enter"===S.key?"Enter"===ee&&(((B=O.value).length||H)&&$({recipient:X,value:B}),B.length&&(O.value="",re(B))):"Tab"===S.key?"Tab"===ee&&function(S){if(1!==Z.length||Z[0].name!==S.name){let B=Z.findIndex(O=>O.type===S.type&&O.name===S.name);B=-1===B?0:(B+1)%Z.length;var O=Z[B];oe(!0),k(O)}}(X):"ArrowUp"===S.key&&ie?O.value=ie:"Escape"===S.key&&"Process"!==ee&&(K?.(0===O.value.length),O.value=""),W?.(S)},onChange:O=>{let B=O.target.value;var j=B.match(/^\/(?:page|whisper|w|msg|m) ([A-Za-z0-9-_']+) /i);j&&(k({type:N.ChatRecipientType.Whisper,name:j[1]}),O.target.value="");var L=B.match(/^\/r(eply)? /i);L&&(void 0!==S?.lastWhisperFrom.value&&k({type:N.ChatRecipientType.Whisper,name:S.lastWhisperFrom.value}),O.target.value=""),j||L||void 0===ce||oe(!0)},onFocus:()=>{ne(!0)},onBlur:()=>{ne(!1),z?.()}}))},S("ChatInput",B.forwardRef(L))}}}),System.register("gui/component/ColorSelect",["react","classnames","gui/component/Select","gui/component/Option"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("ColorSelect",({color:S,disabled:O,availableColors:D,onSelect:F,strings:_})=>{let[U,H]=B.useState(()=>S);return B.useEffect(()=>{U!==S&&H(S)},[S]),B.default.createElement(j.Select,{className:N.default("player-color-select",{"bg-color":!!U}),tooltip:_.get("STT:HostComboColor"),initialValue:U||"random",disabled:O,labelStyle:S=>({backgroundColor:"random"!==S?S:"transparent"}),onSelect:S=>{"random"===S&&(S=""),H(S),F?.(S)}},(O?[U]:D).map(S=>B.default.createElement(L.Option,{key:S,value:S||"random",label:S?"":_.get("GUI:RandomAsSymbols"),className:N.default({"bg-color":!!S})})))})}}}),System.register("gui/component/CountryIcon",["react","game/gameopts/constants","gui/component/Image"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=(new Map).set("Americans","usai.pcx").set("French","frai.pcx").set("Germans","geri.pcx").set("British","gbri.pcx").set("Russians","rusi.pcx").set("Confederation","lati.pcx").set("Africans","djbi.pcx").set("Arabs","arbi.pcx").set("Alliance","japi.pcx").set(N.RANDOM_COUNTRY_NAME,"rani.pcx").set(N.OBS_COUNTRY_NAME,"obsi.pcx"),D=class extends B.default.Component{render(){var S=L.get(this.props.country);return B.default.createElement("div",{className:"player-country-icon"},S&&B.default.createElement(j.Image,{src:S}))}},S("CountryIcon",D)}}}),System.register("gui/component/CountrySelect",["react","gui/component/CountryIcon","gui/component/Select","gui/component/Option"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("CountrySelect",({country:S,availableCountries:O,onlyIcon:D,disabled:F,strings:_,countryUiNames:U,countryUiTooltips:H,onSelect:V})=>{let[W,z]=B.useState(()=>S);return B.useEffect(()=>{W!==S&&z(S)},[S]),B.default.createElement("div",{className:"country-select"},B.default.createElement("div",{className:"player-country-icon","data-r-tooltip":_.get("STT:HostPictureFlag")},B.default.createElement(N.CountryIcon,{country:W})),D?null:B.default.createElement(j.Select,{className:"player-country-select",tooltip:_.get("STT:HostComboCountry"),initialValue:W,disabled:F,onSelect:S=>{z(S),V(S)}},(F?[W]:O).map(S=>{var O=_.get(U.get(S)||S),N=H.has(S)?_.get(H.get(S)):void 0;return B.default.createElement(L.Option,{key:S,value:S,label:O,tooltip:N})})))})}}}),System.register("gui/component/Dialog",["react"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.default.Component{render(){return this.props.hidden?null:B.default.createElement("div",{style:this.getWrapperStyle()},B.default.createElement("div",{className:"message-box "+(this.props.className||"")},B.default.createElement("div",{className:"message-box-content"},this.props.children),B.default.createElement("div",{className:"message-box-footer"},this.props.buttons.map((S,O)=>this.renderButton(S,O)))))}renderButton(S,O){return B.default.createElement("button",{key:O,className:"dialog-button",onClick:S.onClick},S.label)}getWrapperStyle(){var S=this.props.viewport;return{position:"absolute",top:S.x,left:S.y,width:S.width,height:S.height,zIndex:this.props.zIndex}}},S("Dialog",N)}}}),System.register("gui/component/GameResBoxApi",["react","classnames","gui/HtmlReactElement","gui/component/Dialog","gui/component/GameResForm","engine/gameRes/FileSystemUtil"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){S("GameResBoxApi",class{constructor(S,O,B,N,j){this.viewport=S,this.strings=O,this.rootEl=B,this.fsAccessLib=N,this.appConfig=j}async promptForGameRes(S,O){const _=this.appConfig?.defaultFullyPackUrl;if(_&&!this._autoLoadAttempted){this._autoLoadAttempted=!0,console.info("[AutoLoad] Starting automatic download from:",_);try{return new URL(_,window.location.origin)}catch(S){console.error("[AutoLoad] Invalid URL:",_,S)}}return await this.fsAccessLib.polyfillDataTransferItem(),await new Promise(_=>{let U=j.HtmlReactElement.factory(L.Dialog,{className:N.default("game-res-box"),buttons:[],children:B.default.createElement(D.GameResForm,{defaultArchiveUrl:S,closable:O,strings:this.strings,onDrop:async S=>{if(S.items.length)try{var O=await S.items[0].getAsFileSystemHandle();if(!O)return;u(),_(O)}catch(S){console.error(S)}},onBrowseFolder:async()=>{try{var S=await this.fsAccessLib.showDirectoryPicker({_preferPolyfill:!0});u(),_(S)}catch(S){console.error(S)}},onBrowseArchive:async()=>{try{var S=await F.FileSystemUtil.showArchivePicker(this.fsAccessLib);u(),_(S)}catch(S){console.error(S)}},onDownloadArchive:async S=>{u(),_(S)},onClose:()=>{u(),_(void 0)}}),viewport:this.viewport.value}),h=S=>{U.setSize(S.width,S.height),U.applyOptions(O=>O.viewport=S)};this.viewport.onChange.subscribe(h);const u=()=>{this.viewport.onChange.unsubscribe(h),h=void 0;var S=U.getElement();S&&this.rootEl.removeChild(S),U.unrender(),U=void 0};U.setSize(this.viewport.value.width,this.viewport.value.height),U.render(),this.rootEl.appendChild(U.getElement())})}})}}}),System.register("gui/component/GameResForm",["react","classnames"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("GameResForm",({closable:S,strings:O,defaultArchiveUrl:j,onDownloadArchive:L,onBrowseFolder:D,onBrowseArchive:F,onDrop:_,onClose:U})=>{let[H,V]=B.default.useState(),[W,z]=B.default.useState(j),K=B.default.useRef(null);var $=B.default.useCallback(S=>{S.target===H&&V(void 0)},[H]);return B.default.useEffect(()=>{K.current?.focus()},[]),B.default.useEffect(()=>{let e=S=>S.preventDefault();return globalThis.addEventListener("drop",e),globalThis.addEventListener("dragover",e),()=>{globalThis.removeEventListener("drop",e),globalThis.removeEventListener("dragover",e)}},[]),B.default.createElement("div",null,S&&B.default.createElement("div",{className:"close-button",onClick:U}),B.default.createElement("div",{className:"title"},O.get("ts:gameres_locate_title")),B.default.createElement("div",{className:"browse-container"},B.default.createElement("p",null,O.get("ts:gameres_import_desc")),B.default.createElement("form",{className:"link-container",onSubmit:S=>{if(S.preventDefault(),W)try{var B=new URL(W.trim());"http:"!==B.protocol&&"https:"!==B.protocol?alert(O.get("ts:gameres_invalid_url")):"http:"===B.protocol&&"https:"===location.protocol?alert(O.get("ts:gameres_insecure_url")):L(B)}catch(S){alert(O.get("ts:gameres_invalid_url"))}}},B.default.createElement("p",{className:"link-field"},B.default.createElement("label",null,O.get("ts:gameres_download_url")),B.default.createElement("input",{type:"url",ref:K,value:W,onChange:S=>z(S.currentTarget.value),placeholder:"https://"})),B.default.createElement("p",{className:"download-button"},B.default.createElement("button",{type:"submit",className:"dialog-button",disabled:!W?.trim()},O.get("ts:gameres_download_button")))),B.default.createElement("div",{className:N.default("drop-container",{"dropzone-active":!!H}),onDragOver:S=>S.preventDefault(),onDragLeave:$,onDragEnter:S=>{[...S.dataTransfer.items].every(S=>"file"===S.kind)&&V(S.target)},onDrop:S=>{S.preventDefault(),[...S.dataTransfer.items].every(S=>"file"===S.kind)&&_(S.dataTransfer)}},B.default.createElement("p",{className:"drop-figures"},B.default.createElement("img",{src:"res/img/drag-archive.png",width:"98",height:"133",alt:"Red-Alert-2-Multiplayer.exe"}),O.get("ts:gameres_or"),B.default.createElement("img",{src:"res/img/drag-folder.png",width:"99",height:"153",alt:"Command and Conquer Red Alert II"})),B.default.createElement("p",{className:"desc"},O.get("ts:gameres_drop_desc"),B.default.createElement("br",null),O.get("ts:gameres_or")),B.default.createElement("p",{className:"browse-buttons"},B.default.createElement("button",{className:"dialog-button",onClick:D},O.get("ts:gameres_browse_folder")),B.default.createElement("button",{className:"dialog-button",onClick:F},O.get("ts:gameres_browse_archive"))),B.default.createElement("p",{className:"archive-formats"},B.default.createElement("em",null,O.get("ts:gameres_supported_archive_formats"))))))})}}}),System.register("gui/component/Image",["data/Palette","data/PcxFile","data/ShpFile","engine/gfx/ImageUtils","react","gui/component/ImageContext"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){S("Image",S=>{const O=F.ImageContext,[_,U]=D.useState("");return D.useEffect(()=>{let D,F;if(O.imageUrlCache.has(S.src))D=O.imageUrlCache.get(S.src);else if(O.vfs?.fileExists(S.src)){var _=S.src.split(".").pop();if("shp"===_){var H,V,W=S.palette;D=O.vfs.fileExists(W)?(H=new j.ShpFile(O.vfs.openFile(S.src)),V=new B.Palette(O.vfs.openFile(W)),L.ImageUtils.convertShpToCanvas(H,V).toDataURL()):(console.warn(`Palette "${W}" not found in VFS"`),"")}else if("pcx"===_){let B=new N.PcxFile(O.vfs.openFile(S.src));D=B.toDataUrl()}else"png"===_?(W=O.vfs.openFile(S.src).stream,W=new Blob([new Uint8Array(W.buffer,W.byteOffset,W.byteLength)],{type:"image/png"}),D=URL.createObjectURL(W),F=()=>{URL.revokeObjectURL(D),O.imageUrlCache.delete(S.src)}):(console.warn(`Unknown image format "${_}"`),D="");O.imageUrlCache.set(S.src,D)}else D=O.cdnBaseUrl?O.cdnBaseUrl+S.src.substring(0,S.src.lastIndexOf("."))+".png":(console.warn(`Image "${S.src}" not found in VFS`),"");return U(D),F},[S.src]),_?D.default.createElement("img",{src:_}):null})}}}),System.register("gui/component/ImageContext",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){S("ImageContext",B=class{}),B.imageUrlCache=new Map}}}),System.register("gui/component/List",["react","classnames"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("List",({children:S,className:O,title:j,innerRef:L,tooltip:D})=>B.default.createElement(B.default.Fragment,null,j&&B.default.createElement("div",{className:"list-title"},j),B.default.createElement("div",{ref:L,className:N.default("list",O),"data-r-tooltip":D},S))),S("ListItem",({children:S,selected:O,disabled:j,tooltip:L,className:D,innerRef:F,..._})=>B.default.createElement("div",{ref:F,className:N.default("list-item",{selected:O,disabled:j},D),"data-r-tooltip":L,..._},S)),S("ListHeader",({children:S,tooltip:O,className:j,innerRef:L,...D})=>B.default.createElement("div",{ref:L,className:N.default("list-header",j),"data-r-tooltip":O,...D},S))}}}),System.register("gui/component/MenuButton",["react"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.default.Component{render(){var S=this.props.buttonConfig;return S?B.default.createElement("div",{className:this.getClassName(S),style:this.getStyle(),onMouseDown:S=>this.onMouseDown(S),onMouseUp:S=>this.onMouseUp(S),onClick:S=>this.onClick(S),"data-r-tooltip":S.tooltip},S.label):null}getClassName(S){let O=["menu-button"];return S.disabled&&O.push("disabled"),O.join(" ")}getStyle(){var S=this.props.box;return{position:"absolute",left:S.x,top:S.y,width:S.width,height:S.height,lineHeight:S.height+1+"px"}}onMouseDown(S){!this.props.buttonConfig.disabled&&this.props.onMouseDown&&this.props.onMouseDown(S)}onMouseUp(S){!this.props.buttonConfig.disabled&&this.props.onMouseUp&&this.props.onMouseUp(S)}onClick(S){!this.props.buttonConfig.disabled&&this.props.onClick&&this.props.onClick(S)}},S("MenuButton",N)}}}),System.register("gui/component/MessageBoxApi",["react","gui/jsx/jsx","gui/jsx/HtmlView","util/disposable/CompositeDisposable","gui/component/Dialog","gui/component/PromptDialog"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){S("MessageBoxApi",class{constructor(S,O,B){this.viewport=S,this.uiScene=O,this.jsxRenderer=B,this.disposables=new L.CompositeDisposable}show(S,O,B){this.destroy();var L="function"!=typeof B?B:void 0;let[F]=this.jsxRenderer.render(N.jsx(j.HtmlView,{innerRef:S=>this.component=S,component:D.Dialog,props:{children:"string"!=typeof S?S:this.splitNewLines(S),className:L?.className,viewport:this.viewport,zIndex:101,buttons:"string"==typeof O?[{label:O,onClick:()=>{this.disposables.dispose(),"function"==typeof B&&B()}}]:(O??[]).map(S=>({label:S.label,onClick:()=>{this.disposables.dispose(),S.onClick?.()}}))}}));this.uiScene.add(F),this.disposables.add(F,()=>this.uiScene.remove(F),()=>this.component=void 0)}splitNewLines(S){return S.split(/\n/g).map((S,O)=>O?B.createElement(B.Fragment,{key:O},B.createElement("br",null),B.createElement("span",null,S)):B.createElement("span",{key:O},S))}async confirm(S,O,B){return await new Promise(N=>{this.show(S,[{label:O,onClick:()=>N(!0)},{label:B,onClick:()=>N(!1)}])})}async alert(S,O){await new Promise(B=>this.show(S,O,B))}async prompt(S,O,B,L){return this.destroy(),await new Promise(D=>{let[_]=this.jsxRenderer.render(N.jsx(j.HtmlView,{innerRef:S=>this.component=S,component:F.PromptDialog,props:{promptText:S,submitLabel:O,cancelLabel:B,inputProps:L,onSubmit:S=>{D(S),_.destroy()},onDismiss:()=>{D(void 0),_.destroy()},viewport:this.uiScene.viewport}}));this.uiScene.add(_),this.disposables.add(_,()=>this.uiScene.remove(_),()=>this.component=void 0)})}updateViewport(S){this.viewport=S,this.component&&this.component.applyOptions(O=>O.viewport=S)}updateText(S){this.component&&this.component.applyOptions(O=>{O.promptText?O.promptText=S:O.children="string"!=typeof S?S:this.splitNewLines(S)})}destroy(){this.disposables.dispose()}})}}}),System.register("gui/component/Option",["classnames","react"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("Option",({selected:S,disabled:O,label:j,style:L,labelStyle:D,className:F,tooltip:_,onClick:U})=>N.createElement("div",{className:B.default("option",{selected:S,disabled:O},F),style:L,onClick:O?void 0:U,"data-r-tooltip":_},N.createElement("div",{style:D},j)))}}}),System.register("gui/component/PingIndicator",["react","gui/component/Image"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){var O;(O=j=j||{})[O.Good=1]="Good",O[O.Average=2]="Average",O[O.Bad=3]="Bad",L=S=>S<=100?j.Good:S<=250?j.Average:j.Bad,D=(new Map).set(j.Bad,"pingr").set(j.Average,"pingy").set(j.Good,"pingg"),S("PingIndicator",({ping:S,strings:O})=>{var j=void 0!==S?O.get("Msg:PingInfo",S):void 0;return B.default.createElement("div",{className:"ping-indicator","data-r-tooltip":j,title:j},void 0!==S?B.default.createElement(N.Image,{src:D.get(L(S))+".pcx"}):null)})}}}),System.register("gui/component/PromptDialog",["react","gui/component/Dialog"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("PromptDialog",({viewport:S,promptText:O,submitLabel:j,cancelLabel:L,inputProps:D,onSubmit:F,onDismiss:_})=>{let U=B.useRef(null),[H,V]=B.useState(!1);B.useEffect(()=>{setTimeout(()=>{U.current?.focus()},50)},[]);var d=S=>{S&&S.preventDefault(),V(!0),F(U.current.value)};return B.default.createElement(N.Dialog,{className:"prompt-box",hidden:H,viewport:S,zIndex:100,buttons:[{label:j,onClick:d},{label:L,onClick:()=>{V(!0),_?.()}}]},B.default.createElement("form",{onSubmit:d,autoComplete:"off"},B.default.createElement("div",{className:"field"},B.default.createElement("label",null,O.split(/\r?\n/).map((S,O)=>B.default.createElement(B.default.Fragment,{key:O},O?B.default.createElement("br",null):null,S))),B.default.createElement("input",{name:"promptvalue",type:"text",autoComplete:"off","data-lpignore":"true",ref:U,...D})),B.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))})}}}),System.register("gui/component/Select",["react","classnames","util/dom"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("Select",({initialValue:S,disabled:O,tooltip:L,className:D,onSelect:F,labelStyle:_,children:U})=>{let[H,V]=B.useState(()=>S),[W,z]=B.useState(()=>S),[K,$]=B.useState(!1),q=B.useRef(null);var Q,Z;return B.useEffect(()=>{H!==S&&(V(S),z(H))},[S]),B.useEffect(()=>{if(K){z(H);const e=S=>{j.contains(q.current,S.target)||$(!1)};return document.addEventListener("click",e),()=>{document.removeEventListener("click",e)}}},[K]),B.default.createElement("div",{style:{display:"inline-block",verticalAlign:"middle"},className:D},B.default.createElement("div",{className:N.default("select",{disabled:O}),"data-r-tooltip":L,ref:q},B.default.createElement("div",{className:"select-value",onClick:()=>!O&&$(!K)},B.default.createElement("div",{style:_?.(H)},(Q=H,(Z=B.default.Children.toArray(U).find(S=>S.props.value===Q))?Z.props.label:""))),K&&B.default.createElement("div",{className:"select-layer"},B.default.Children.map(U,S=>{if(!S)return null;const O=S.props.value,N=S.props.disabled;return B.default.createElement("div",{onMouseEnter:()=>!N&&z(O)},B.default.cloneElement(S,{selected:O===W,labelStyle:_?.(O),onClick:()=>{var S;V(S=O),z(S),F?.(S),$(!1)}}))}))))})}}}),System.register("gui/component/Slider",["react"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("Slider",({getLabel:S,...O})=>{let[N,j]=B.useState(()=>O.value);return B.useEffect(()=>{N!==O.value&&j(O.value)},[O.value]),B.default.createElement("div",{style:{display:"inline-block",verticalAlign:"middle"}},B.default.createElement("input",{type:"range",...O,value:N,onChange:S=>{j(S.target.value),O.onChange?.(S)}}),B.default.createElement("input",{type:"text",disabled:!0,readOnly:!0,value:S?.(N)??N}))})}}}),System.register("gui/component/SplashScreen",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("SplashScreen",class{constructor(S,O){this.width=S,this.height=O,this.rendered=!1}render(S){if(!this.rendered){let B=this.el=document.createElement("div");B.style.backgroundColor="black",B.style.color="white",B.style.padding="10px",B.style.boxSizing="border-box",B.style.backgroundRepeat="no-repeat",B.style.backgroundPosition="50% 50%",B.style.textShadow="1px 1px black",this.updateSize();var O=this.loadingEl=document.createElement("div");B.appendChild(O);let N=this.copyrightEl=document.createElement("div");N.style.position="absolute",N.style.bottom="10px",N.style.right="10px",N.style.textAlign="right",B.appendChild(N);let j=this.disclaimerEl=document.createElement("div");j.style.position="absolute",j.style.bottom="10px",j.style.left="10px",B.appendChild(j),S.appendChild(B),this.rendered=!0}}setBackgroundImage(S){this.el.style.backgroundImage=`url(${S})`}setLoadingText(S){this.loadingEl.innerHTML=S}setCopyrightText(S){this.copyrightEl.innerHTML=S.replace(/\n/g,"<br />")}setDisclaimerText(S){this.disclaimerEl.innerHTML=S.replace(/\n/g,"<br />")}setSize(S,O){this.width=S,this.height=O,this.updateSize()}updateSize(){this.el&&(this.el.style.width=this.width+"px",this.el.style.height=this.height+"px")}destroy(){this.rendered&&(this.el.remove(),this.rendered=!1)}})}}}),System.register("gui/component/StartPosSelect",["react","gui/component/Select","game/gameopts/constants","gui/component/Option"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("StartPosSelect",({startPos:S,disabled:O,availableStartPositions:D,onSelect:F,strings:_})=>{let U=[...new Set([S,...D]).values()].sort();return B.default.createElement(N.Select,{className:"player-start-pos-select",initialValue:""+S,disabled:O,tooltip:_.get("STT:HostComboStart"),onSelect:S=>{F?.(Number(S))}},U.map(S=>B.default.createElement(L.Option,{key:S,value:""+S,label:S===j.RANDOM_START_POS?_.get("GUI:RandomAsSymbols"):""+(S+1)})))})}}}),System.register("gui/component/TeamSelect",["react","gui/component/Select","gui/component/Option","game/gameopts/constants"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("formatTeamId",D=S=>String.fromCharCode("A".charCodeAt(0)+S)),S("TeamSelect",({teamId:S,required:O,disabled:F,maxTeams:_,onSelect:U,strings:H})=>{let V=new Array(_).fill(0).map((S,O)=>O);return B.default.createElement(N.Select,{className:"player-team-select",initialValue:""+S,disabled:F,tooltip:H.get("STT:HostComboTeam"),onSelect:S=>{U?.(Number(S))}},!O&&B.default.createElement(j.Option,{value:""+L.NO_TEAM_ID,label:H.get("GUI:NoneAsSymbols")}),V.map(S=>B.default.createElement(j.Option,{key:S,value:""+S,label:D(S)})))})}}}),System.register("gui/component/ToastApi",["gui/jsx/jsx","gui/jsx/HtmlView","util/disposable/CompositeDisposable","gui/component/Toasts"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("ToastApi",class{constructor(S,O,B){this.viewport=S,this.uiScene=O,this.jsxRenderer=B,this.messages=[],this.disposables=new j.CompositeDisposable,this.handleViewportChange=S=>{this.innerComponent&&this.innerComponent.applyOptions(O=>O.viewport=S)}}push(S){var O=Date.now();this.messages.push({text:S,timestamp:O}),this.updateTimeoutId&&(clearTimeout(this.updateTimeoutId),this.updateTimeoutId=void 0),this.update()}update(){if(this.messages=this.messages.filter(S=>S.timestamp>Date.now()-5e3),this.messages=this.messages.slice(-5),this.messages.length){let S=this.messages.map(S=>S.text);if(this.uiToasts)this.innerComponent?.applyOptions(O=>O.messages=S);else{let[O]=this.jsxRenderer.render(B.jsx(N.HtmlView,{innerRef:S=>this.innerComponent=S,component:L.Toasts,props:{messages:S,viewport:this.viewport.value,zIndex:101}}));this.uiToasts=O,this.uiScene.add(O),this.viewport.onChange.subscribe(this.handleViewportChange),this.disposables.add(O,()=>this.uiScene.remove(O),()=>this.viewport.onChange.unsubscribe(this.handleViewportChange),()=>this.innerComponent=void 0,()=>this.uiToasts=void 0)}this.updateTimeoutId=setTimeout(()=>this.update(),5e3)}else this.destroy()}destroy(){this.updateTimeoutId&&(clearTimeout(this.updateTimeoutId),this.updateTimeoutId=void 0),this.disposables.dispose()}})}}}),System.register("gui/component/Toasts",["react"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("Toasts",({messages:S,viewport:O,zIndex:N})=>B.default.createElement("div",{style:{position:"absolute",top:O.x,left:O.y,width:O.width,zIndex:N}},B.default.createElement("div",{className:"toasts"},S.map((S,O)=>B.default.createElement("div",{key:O,className:"toast"},S)))))}}}),System.register("gui/component/UiText",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class extends j.UiComponent{constructor(){super(...arguments),this.value=this.props.value,this.textAlign=this.props.textAlign}createUiObject(){let S=new N.UiObject(new THREE.Object3D,new L.HtmlContainer);S.setPosition(this.props.x||0,this.props.y||0);var O=this.props.width,B=this.props.height;let j=document.createElement("canvas");return j.width=O,j.height=B,this.ctx=j.getContext("2d",{alpha:!0}),this.texture=this.createTexture(j),this.updateTexture(this.value,this.textAlign,this.props.textColor),this.mesh=this.createMesh(O,B),S}createTexture(S){let O=new THREE.Texture(S);return O.needsUpdate=!0,O.flipY=!1,O.minFilter=THREE.NearestFilter,O.magFilter=THREE.NearestFilter,O}createMesh(S,O){let B=D.SpriteUtils.createRectGeometry(S,O);D.SpriteUtils.addRectUvs(B,{x:0,y:0,width:S,height:O},{width:S,height:O}),B.translate(S/2,O/2,0);var N=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let j=new THREE.Mesh(B,N);return j.frustumCulled=!1,j}defineChildren(){return B.jsx("mesh",{zIndex:this.props.zIndex,onClick:this.props.onClick},this.mesh)}updateTexture(S,O,B){this.ctx.clearRect(0,0,this.props.width,this.props.height),F.CanvasUtils.drawText(this.ctx,S,0,0,{color:B,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:6,textAlign:O??"center",width:this.props.width,height:this.props.height}),this.texture.needsUpdate=!0}setValue(S){this.value!==S&&(this.value=S,this.updateTexture(S,this.textAlign,this.props.textColor))}setTextAlign(S){S!==this.textAlign&&(this.textAlign=S,this.updateTexture(this.value,S,this.props.textColor))}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},S("UiText",_)}}}),System.register("gui/jsx/HtmlView",["gui/jsx/UiComponent","gui/UiObject","gui/HtmlReactElement"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends B.UiComponent{createUiObject(S){let O=j.HtmlReactElement.factory(this.props.component,this.props.props);O.setSize(S.width||0,S.height||0);let B=new N.UiObject(new THREE.Object3D,O);return B.setPosition(S.x||0,S.y||0),S.hidden&&B.setVisible(!1),this.props.innerRef?.(O),B}getElement(){return this.getUiObject().getHtmlContainer()}},S("HtmlView",L)}}}),System.register("gui/jsx/JsxRenderer",["gui/jsx/jsx","gui/UiObjectSprite","gui/UiObject","gui/HtmlContainer","engine/renderable/builder/CanvasSpriteBuilder","gui/ShpSpriteBatch"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=S=>!!S.images,S("JsxRenderer",class{constructor(S,O,B,U){this.images=S,this.palettes=O,this.camera=B,this.jsxIntrinsicRenderers={sprite:S=>{let O;if(_(S)){let B=new D.CanvasSpriteBuilder(S.images,this.camera);B.setAlign(S.alignX??0,S.alignY??0),O=new N.UiObjectSprite(B)}else{var B="string"==typeof S.image?this.getImage(S.image):S.image,j="string"==typeof S.palette?this.getPalette(S.palette):S.palette;O=N.UiObjectSprite.fromShpFile(B,j,this.camera)}return U&&O.setPointerEvents(U),this.setupListeners(O,S),S.onFrame&&O.onFrame.subscribe(S.onFrame),O.setPosition(S.x||0,S.y||0),void 0!==S.frame&&O.setFrame(S.frame),S.animationRunner&&O.setAnimationRunner(S.animationRunner),S.hidden&&O.setVisible(!1),S.zIndex&&O.setZIndex(S.zIndex),void 0!==S.opacity&&O.setOpacity(S.opacity),void 0!==S.transparent&&O.setTransparent(S.transparent),void 0!==S.tooltip&&O.setTooltip(S.tooltip),{obj:O}},"sprite-batch":S=>{let O=[];O=S.children?Array.isArray(S.children)?S.children.flat():[S.children]:[];let B=[],N=[];for(var j of O)"sprite"===j.type&&j.props.static&&!_(j.props)?N.push(j.props):B.push(j);return{obj:new F.ShpSpriteBatch(N,S=>this.getImage(S),S=>this.getPalette(S),this.camera),children:[...B]}},container:S=>{let O=new j.UiObject(new THREE.Object3D,new L.HtmlContainer);return U&&O.setPointerEvents(U),this.setupListeners(O,S),S.onFrame&&O.onFrame.subscribe(S.onFrame),S.hidden&&O.setVisible(!1),S.zIndex&&O.setZIndex(S.zIndex),O.setPosition(S.x||0,S.y||0),O.getHtmlContainer()?.setSize(S.width||0,S.height||0),{obj:O}},mesh:S=>{let O=new j.UiObject(S.children);return U&&O.setPointerEvents(U),this.setupListeners(O,S),O.setPosition(S.x||0,S.y||0),S.zIndex&&O.setZIndex(S.zIndex),S.hidden&&O.setVisible(!1),{obj:O}}}}setupListeners(S,O){const B={click:"onClick",dblclick:"onDoubleClick",mousedown:"onMouseDown",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave",mouseout:"onMouseOut",mouseover:"onMouseOver",mouseup:"onMouseUp",mousemove:"onMouseMove",wheel:"onWheel"};Object.keys(B).forEach(N=>{var j=O[B[N]];j&&S.addEventListener(N,j)})}setCamera(S){this.camera=S}getImage(S){var O=this.images.get(S);if(!O)throw new Error(`Missing image "${S}"`);return O}getPalette(S){var O=this.palettes.get(S);if(!O)throw new Error(`Missing palette "${S}"`);return O}render(S){return B.renderJsx(S,this.jsxIntrinsicRenderers)}})}}}),System.register("gui/jsx/UiComponent",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("UiComponent",class{constructor(S){this.props=S,this.uiObject=this.createUiObject(S)}getUiObject(){return this.uiObject}})}}}),System.register("gui/jsx/jsx",[],function(S,O){"use strict";return O&&O.id,S("createRef",function(){return{current:void 0}}),S("jsx",function(S,O,...B){let{ref:N,...j}=O=O||{};return{isJsxElement:!0,type:S,props:{...j,children:1<B.length?B:B[0]},ref:N}}),S("renderJsx",function e(S,O){let B,N,j;return(S=Array.isArray(S)?S:[S]).map(S=>{if(null==S||!S.isJsxElement)return[];if("string"==typeof S.type)if(N=S.props.children,"fragment"===S.type)B=void 0;else{let D=O[S.type];if(!D)throw new Error(`No renderer defined for intrinsic JSX element "${S.type}"`);var L=D({ref:S.ref,...S.props});B=L.obj,B&&(j=B),L.children&&(N=L.children)}else{let O=new S.type(S.props);B=O.getUiObject(),N=O.defineChildren?.()||S.props.children,O.onRender&&B.onFrame.subscribeOnce(S=>O.onRender(S)),O.onFrame&&B.onFrame.subscribe(S=>O.onFrame(S)),O.onDispose&&B.onDispose.subscribe(()=>O.onDispose()),j=O}return L=N?(Array.isArray(N)?N:[N]).map(S=>e(S,O)).reduce((S,O)=>[...S,...O],[]):[],B&&B.add(...L),j&&S.ref&&("function"==typeof S.ref?S.ref?.(j):S.ref.current=j),B?[B]:null!==B?L:[]}).reduce((S,O)=>[...S,...O],[])}),{setters:[],execute:function(){}}}),System.register("gui/replay/ReplayExistsError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends Error{},S("ReplayExistsError",B)}}}),System.register("gui/replay/ReplayMeta",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("gui/replay/ReplayStorage",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("gui/replay/ReplayStorageError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends Error{},S("ReplayStorageError",B)}}}),System.register("gui/replay/ReplayStorageFileSystem",["data/vfs/VirtualFile","data/DataStream","data/vfs/StorageQuotaError","network/gamestate/Replay","gui/replay/ReplayStorageError"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){S("ReplayStorageFileSystem",F=class e{constructor(S,O){this.dir=S,this.sentry=O}async getManifest(S=!1){if(S)return await this.rebuildManifest();if(!await this.dir.containsEntry(e.manifestFileName))return[];let O=(await this.dir.openFile(e.manifestFileName)).readAsString("utf-8");if(!O.length)return[];try{return JSON.parse(O)}catch(S){return console.error("Replay manifest is corrupt",S),this.sentry?.captureException(S,S=>(S.addAttachment({filename:e.manifestFileName,data:O}),S)),await this.deleteManifest(),await this.rebuildManifest()}}async saveManifest(S){let O=new N.DataStream;O.writeString(JSON.stringify(S),"utf-8");var L=new B.VirtualFile(O,e.manifestFileName);try{await this.dir.writeFile(L)}catch(S){if(S instanceof j.StorageQuotaError)throw S;throw new D.ReplayStorageError(`Failed to save manifest (${S.message})`,{cause:S})}}async deleteManifest(){await this.dir.deleteFile(e.manifestFileName)}async rebuildManifest(){var S,O,B,N=await this.getManifest();let D=0;for await(S of this.dir.getEntries())S.endsWith(L.Replay.extension)&&D++;if(D===N.length)return N;console.info("Rebuilding replay index...");let F=new Map;for await(O of this.dir.getRawFiles())O.name.endsWith(L.Replay.extension)&&F.set(O.name,O);let _=[];for(B of N){var U=this.getReplayFileName(B);F.has(U)&&(_.push(B),F.delete(U))}if(0<N.length-_.length&&console.info(`Removed ${N.length-_.length} orphaned entries from index`),F.size){for(var H of F.values()){var V=H.lastModified;_.unshift({id:THREE.Math.generateUUID(),name:H.name.replace(e.unsavedReplayPrefix,"").replace(L.Replay.extension,""),keep:!H.name.startsWith(e.unsavedReplayPrefix),timestamp:V})}_.sort((S,O)=>S.timestamp===O.timestamp?S.name.localeCompare(O.name):O.timestamp-S.timestamp),console.info(`Added ${F.size} new entries to replay index`)}try{await this.saveManifest(_)}catch(S){if(!(S instanceof j.StorageQuotaError))throw S;console.error("Failed to save rebuilt manifest because storage is full",S)}return console.info("Rebuild finished."),_}async deleteAllReplays(){for await(var S of this.dir.getEntries())S.endsWith(L.Replay.extension)&&await this.dir.deleteFile(S);await this.deleteManifest()}async getReplayData(S){var O=this.getReplayFileName(S);if(!await this.dir.containsEntry(O))throw new Error(`Replay file "${O}" not found.`);return await this.dir.getRawFile(O)}async hasReplayData(S){var O=this.getReplayFileName(S);return await this.dir.containsEntry(O)}async saveReplayData(S,O){let L=new N.DataStream;L.writeString(O,"utf-8");var F=this.getReplayFileName(S),_=new B.VirtualFile(L,F);try{await this.dir.writeFile(_)}catch(S){if(S instanceof j.StorageQuotaError)throw S;if(S instanceof TypeError)throw new D.ReplayStorageError(`Failed to save replay file "${F}" (${S.message})`,{cause:S});throw new D.ReplayStorageError(`Failed to save replay file (${S.message})`,{cause:S})}}async deleteReplayData(S){await this.dir.deleteFile(this.getReplayFileName(S))}getReplayFileName(S){return(S.keep?"":e.unsavedReplayPrefix)+S.name+L.Replay.extension}}),F.manifestFileName="_index.json",F.unsavedReplayPrefix="Unsaved_"}}}),System.register("gui/replay/ReplayStorageMemStorage",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("ReplayStorageMemStorage",class{constructor(){this.replays=new Map}async getManifest(){return this.manifest?JSON.parse(this.manifest):[]}async saveManifest(S){this.manifest=JSON.stringify(S)}async getReplayData(S){var O=this.replays.get(S.id);if(!O)throw new Error(`Replay "${S.id}" not found in memory`);return O}async hasReplayData(S){return this.replays.has(S.id)}async saveReplayData(S,O){this.replays.set(S.id,O)}async deleteReplayData(S){this.replays.delete(S.id)}})}}}),System.register("gui/replay/ReplayStorageMigration",["network/gamestate/Replay","gui/replay/ReplayStorageFileSystem"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("ReplayStorageMigration",j=class e{constructor(S,O,B,N,j){this.splashScreen=S,this.strings=O,this.replayDir=B,this.localPrefs=N,this.storageFileSystem=j}async migrate(){4!==Number(this.localPrefs.getItem(e.migratedMarker)||0)&&(console.info("Running replay storage migrations..."),await this.runMigrationTo4(),this.localPrefs.setItem(e.migratedMarker,"4"),console.info("Migrations finished."))}async runMigrationTo4(){for(var S of(this.localPrefs.removeItem("_r_replayList"),this.localPrefs.listItems()))S.startsWith("_r_replay_")&&this.localPrefs.removeItem(S);let O=this.replayDir;var j="replays.json";if(await O.containsEntry(j))if(await O.containsEntry(N.ReplayStorageFileSystem.manifestFileName))await O.deleteFile(j);else{var L=(await O.openFile(j)).readAsString("utf-8");let N=[];try{N=JSON.parse(L)}catch(S){}if(N.length){this.splashScreen.setLoadingText(this.strings.get("ts:replay_storage_migrating",0));let L=[],W=new Set;for await(var D of O.getEntries())D.endsWith(B.Replay.extension)&&W.add(D);let z=new Map,K=new Set;for(var F of N){var _="replay_"+F.id+B.Replay.extension;if(W.has(_)){let S={id:THREE.Math.generateUUID(),name:B.Replay.sanitizeFileName(F.name),keep:F.keep,timestamp:F.timestamp};L.push(S);let O=this.storageFileSystem.getReplayFileName(S),N=1;for(;K.has(O.toLowerCase());)O=O.replace(B.Replay.extension,""),1<N&&(O=O.replace(/ \(\d+\)$/,"")),O+=` (${++N})`+B.Replay.extension;1<N&&(S.name+=` (${N})`),z.set(_,O),K.add(O.toLowerCase())}}await O.deleteFile(j);try{let S=0;var U,H,V=z.size;for([U,H]of z){let B=await O.openFile(U);B.filename=H,await O.writeFile(B),await O.deleteFile(U),this.splashScreen.setLoadingText(this.strings.get("ts:replay_storage_migrating",Math.floor(++S/V*100)))}await this.storageFileSystem.saveManifest(L)}catch(S){console.error(S)}}else await O.deleteFile(j)}}}),j.migratedMarker="_r_replays_migrated"}}}),System.register("gui/screen/Controller",["util/event"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("Controller",class{constructor(){this.screens=new Map,this.screenStack=[],this._onScreenChange=new B.EventDispatcher}get onScreenChange(){return this._onScreenChange.asEvent()}addScreen(S,O){this.screens.set(S,O),O.setController(this)}hasScreen(S){return this.screens.has(S)}async leaveCurrentScreen(){await this.popScreen()}async goToScreenBlocking(S,O){for(;this.screenStack.length;)await this.leaveCurrentScreen();await this.pushScreen(S,O)}goToScreen(S,O){this.goToScreenBlocking(S,O)}async pushScreen(S,O){let B=this.screens.get(S);if(!B)throw new Error("Invalid screen type "+S);this.screenStack.length&&await(this.screenStack[this.screenStack.length-1].onStack?.()),this.screenStack.push(B),this._onScreenChange.dispatch(this,S),B.onEnter(O)}async popScreen(S){this.screenStack.length&&(await this.screenStack.pop().onLeave(),this._onScreenChange.dispatch(this,void 0)),this.screenStack.length&&this.screenStack[this.screenStack.length-1].onUnstack?.(S)}rerenderCurrentScreen(){this.screenStack.length&&this.screenStack[this.screenStack.length-1].onViewportChange?.()}getCurrentScreen(){return this.screenStack.length?this.screenStack[this.screenStack.length-1]:void 0}destroy(){for(var S of this.screens.values())S.setController(void 0);this.screens.clear(),this.screenStack.length=0}})}}}),System.register("gui/screen/RootController",["gui/screen/Controller","gui/screen/ScreenType"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends B.Controller{constructor(S){super(),this.serverRegions=S}async goToScreenBlocking(...S){var[O,B]=S;return super.goToScreenBlocking(O,B)}goToScreen(...S){var[O,B]=S;return super.goToScreen(O,B)}async pushScreen(...S){var[O,B]=S;return super.pushScreen(O,B)}createGame(S,O,B,j,L,D,F,_=!1,U=!1,H){if(!this.serverRegions)throw new Error("Server regions must be loaded first");let V="";if(!D){if(!B)throw new Error("Game server must be set for a multiplayer game");V=B}this.goToScreen(N.ScreenType.Game,{create:!0,gameId:S,timestamp:O,playerName:j,gameOpts:L,singlePlayer:D,tournament:F,mapTransfer:_,createPrivateGame:U,gservUrl:V,returnTo:H})}joinGame(S,O,B,j,L,D=!1,F){if(!this.serverRegions)throw new Error("Server regions must be loaded first");this.goToScreen(N.ScreenType.Game,{create:!1,gameId:S,timestamp:O,playerName:j,tournament:L,mapTransfer:D,gservUrl:B,returnTo:F})}},S("RootController",j)}}}),System.register("gui/screen/RootRoute",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("RootRoute",class{constructor(...S){var[O,B]=S;this.screenType=O,this.params=B}})}}}),System.register("gui/screen/RootScreen",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("RootScreen",class{constructor(){this.preventUnload=!1}setController(S){this.controller=S}})}}}),System.register("gui/screen/Screen",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("gui/screen/ScreenParamsMap",["gui/screen/ScreenType"],function(S,O){"use strict";return O&&O.id,{setters:[function(S){}],execute:function(){}}}),System.register("gui/screen/ScreenType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("ScreenType",B={}))[O.MainMenuRoot=0]="MainMenuRoot",O[O.Game=1]="Game",O[O.Replay=2]="Replay"}}}),System.register("gui/screen/game/ChatNetHandler",["util/disposable/CompositeDisposable","network/chat/ChatMessage","network/gservConfig"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("ChatNetHandler",class{constructor(S,O,L,D,F,_,U,H,V){this.gservCon=S,this.wolCon=O,this.messageList=L,this.chatHistory=D,this.chatMessageFormat=F,this.localPlayer=_,this.game=U,this.replayRecorder=H,this.mutedPlayers=V,this.disposables=new B.CompositeDisposable,this.handleMessage=S=>{if(S.from===this.localPlayer.name&&S.to.type===N.ChatRecipientType.Whisper)return this.messageList.addChatMessage(this.chatMessageFormat.formatPrefixPlain(S)+" "+S.text,"mediumpurple"),void this.chatHistory.addChatMessage(S);var O=this.chatMessageFormat.formatPrefixPlain(S);let B;if(S.to.type!==N.ChatRecipientType.Page||S.from!==this.gservCon.getServerName()&&S.from!==this.wolCon.getServerName()){let O;if(S.to.type===N.ChatRecipientType.Whisper)O=S.from,B="mediumpurple";else{let N=this.game.getPlayerByName(S.from);O=N.name,B=N.color.asHexString()}if(this.mutedPlayers.has(O))return}else B="yellow";S.to.type===N.ChatRecipientType.Channel&&S.to.name===j.RECIPIENT_ALL&&this.replayRecorder.recordChatMessage(this.game.currentTick,S.from,S.text),this.messageList.addChatMessage(O+" "+S.text,B),this.chatHistory.addChatMessage(S),S.to.type===N.ChatRecipientType.Whisper&&S.to.name!==this.wolCon.getServerName()&&S.to.name!==this.gservCon.getServerName()&&(this.chatHistory.lastWhisperFrom.value=S.from)}}init(){this.wolCon.onChatMessage.subscribe(this.handleMessage),this.disposables.add(()=>this.wolCon.onChatMessage.unsubscribe(this.handleMessage)),this.gservCon.onChatMessage.subscribe(this.handleMessage),this.disposables.add(()=>this.gservCon.onChatMessage.unsubscribe(this.handleMessage))}submitMessage(S,O){var B;this.gservCon.isOpen()?O.type===N.ChatRecipientType.Channel&&O.name===j.RECIPIENT_ALL?S.startsWith("/")?(B=this.wolCon.getCurrentUser(),this.wolCon.isOpen()&&B&&this.wolCon.privmsg([B],S)):this.gservCon.sayChannel(S):O.type===N.ChatRecipientType.Channel&&O.name===j.RECIPIENT_TEAM?(B=this.game.alliances.getAllies(this.localPlayer).filter(S=>!S.isAi).map(S=>S.name),this.gservCon.privmsg([...B,this.localPlayer.name],S)):O.type===N.ChatRecipientType.Whisper&&this.wolCon.isOpen()&&(this.wolCon.privmsg([O.name],S),this.chatHistory.lastWhisperTo.value=O.name):console.warn("Can't send chat message. Network connection is already closed.")}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/ChatTypingHandler",["network/chat/ChatMessage","network/gservConfig"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("ChatTypingHandler",class{constructor(S,O,B,N){this.keyboardHandler=S,this.arrowScrollHandler=O,this.messageList=B,this.chatHistory=N,this.isTyping=!1}startTyping(){this.isTyping||(this.keyboardHandler.pause(),this.arrowScrollHandler.pause(),this.messageList.isComposing=!0,this.isTyping=!0)}endTyping(){this.isTyping&&(this.keyboardHandler.unpause(),this.arrowScrollHandler.unpause(),this.messageList.isComposing=!1,this.isTyping=!1)}handleKeyDown(S){this.isTyping||("Enter"===S.key?this.startTyping():"Backspace"===S.key&&(this.chatHistory.lastComposeTarget.value={type:B.ChatRecipientType.Channel,name:N.RECIPIENT_TEAM},this.startTyping()))}handleKeyUp(S){}dispose(){this.keyboardHandler.unpause(),this.arrowScrollHandler.unpause(),this.messageList.isComposing=!1}})}}}),System.register("gui/screen/game/CombatantUi",["react","gui/screen/game/worldInteraction/PlacementMode","game/action/ActionType","util/disposable/CompositeDisposable","engine/sound/SoundKey","engine/sound/ChannelType","game/order/OrderType","game/action/OrderUnitsAction","gui/screen/game/worldInteraction/keyboard/KeyCommandType","engine/util/MapPanningHelper","gui/screen/game/worldInteraction/keyboard/command/SelectGroupCmd","gui/screen/game/worldInteraction/keyboard/command/CenterGroupCmd","gui/screen/game/component/hud/viewmodel/SidebarModel","game/event/EventType","gui/screen/game/worldInteraction/SellMode","gui/screen/game/worldInteraction/keyboard/command/LastRadarEventCmd","game/player/production/ProductionQueue","engine/type/ObjectType","game/action/UpdateQueueAction","gui/screen/game/worldInteraction/RepairMode","gui/screen/game/worldInteraction/keyboard/KeyCommand","gui/screen/game/worldInteraction/PlanningMode","game/order/OrderFeedbackType","gui/screen/game/worldInteraction/keyboard/command/SelectNextUnitCmd","gui/screen/game/worldInteraction/keyboard/command/SetCameraLocationCmd","gui/screen/game/worldInteraction/keyboard/command/GoToCameraLocationCmd","gui/screen/game/worldInteraction/SpecialActionMode","game/SuperWeapon","gui/screen/game/worldInteraction/keyboard/command/CenterViewCmd","gui/screen/game/worldInteraction/keyboard/command/FollowUnitCmd","gui/screen/game/worldInteraction/PendingPlacementHandler","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/screen/game/worldInteraction/BeaconMode","gui/screen/mainMenu/main/ReportBug","gui/screen/game/worldInteraction/keyboard/command/CenterBaseCmd","gui/screen/game/worldInteraction/keyboard/command/SelectTypeByCmd"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S},function(S){ge=S},function(S){pe=S},function(S){me=S}],execute:function(){S("CombatantUi",class{constructor(S,O,B,N,j,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie){this.game=S,this.player=O,this.isSinglePlayer=B,this.actionQueue=N,this.actionFactory=j,this.sidebarModel=D,this.renderer=F,this.worldScene=_,this.soundHandler=U,this.messageList=H,this.sound=V,this.eva=W,this.worldInteractionFactory=z,this.gameMenu=K,this.pointer=$,this.runtimeVars=q,this.speedCheat=Q,this.strings=Z,this.tauntHandler=Y,this.renderableManager=X,this.superWeaponFxHandler=J,this.beaconFxHandler=ee,this.messageBoxApi=te,this.discordUrl=ie,this.disposables=new L.CompositeDisposable}init(S){let O=this.game.getUnitSelection(),B=N.PlacementMode.factory(this.game,this.player,this.renderer,this.worldScene,this.eva);this.placementMode=B,this.disposables.add(B);let L=he.PendingPlacementHandler.factory(this.game,this.player,this.renderer,this.worldScene);L.init(),this.disposables.add(L),B.onBuildingPlaceRequest.subscribe(({rules:S,tile:O})=>{L.pushPlacementInfo({rules:S,tile:O}),this.pushAction(j.ActionType.PlaceBuilding,B=>{B.buildingRules=S,B.tile={x:O.rx,y:O.ry}})});let _=q.SellMode.factory(this.game,this.player,this.sidebarModel,this.pointer,this.renderer);this.sellMode=_,this.disposables.add(_),_.onExecute.subscribe(S=>{this.pushAction(j.ActionType.SellObject,O=>{O.objectId=S.id})});let U=J.RepairMode.factory(this.game,this.player,this.sidebarModel,this.pointer,this.renderer);this.repairMode=U,this.disposables.add(U);let H=de.BeaconMode.factory(this.pointer,this.renderer);this.beaconMode=H,this.disposables.add(H),U.onExecute.subscribe(S=>{this.pushAction(j.ActionType.ToggleRepair,O=>{O.buildingId=S.id}),this.sound.play(D.SoundKey.GenericClick,F.ChannelType.Ui)}),H.onExecute.subscribe(S=>this.handleBeacon(S));let V=this.worldInteractionFactory.create();this.worldInteraction=V,V.init(),this.disposables.add(V);let W=new te.PlanningMode(this.player,this.messageList,this.sound,this.strings,this.worldScene,O,V.unitSelectionHandler,this.renderer,V.targetLines,this.game.rules.general.maxWaypointPathLength);this.planningMode=W,this.disposables.add(W),this.disposables.add(()=>this.specialMode?.dispose()),B.init(),this.initKeyboardCommands(V),this.initGameEventListeners(),this.initGameMenuListeners(),this.initHudEventListeners(S,_,U,H,V),this.lastSelectionHash=O.getHash(),V.unitSelectionHandler.onUserSelectionChange.subscribe(S=>{if(W.isActive()){var B=W.updateSelection(S.selection);if(B)for(var N of B)O.addToSelection(N)}this.lastSelectionHash=O.getHash(),this.pushAction(j.ActionType.SelectUnits,S=>{S.unitIds=O.getSelectedUnits().map(S=>S.id)})}),V.unitSelectionHandler.onUserSelectionUpdate.subscribe(S=>this.soundHandler.handleSelectionChangeEvent(S)),V.defaultActionHandler.onOrder.subscribe(({orderType:S,terminal:O,feedbackType:B,feedbackUnit:N,target:j})=>{W.isActive()?W.pushOrder(S,j,O):this.pushOrder(S,j,B,N)})}handleHudChange(S){this.worldInteraction&&this.initHudEventListeners(S,this.sellMode,this.repairMode,this.beaconMode,this.worldInteraction)}dispose(){this.disposables.dispose()}initGameEventListeners(){let e=S=>{S.isTechno()&&S.owner===this.player&&(S.isBuilding()||Number.isFinite(S.rules.buildLimit)||S.isVehicle()&&S.transportTrait||this.game.rules.general.padAircraft.includes(S.name))&&(this.sidebarModel.updateAvailableObjects(this.game.art),this.soundHandler.handleAvailableObjectsUpdate(this.player.production.getAvailableObjects()))},S=this.game.getWorld();this.sidebarModel.updateAvailableObjects(this.game.art),S.onObjectSpawned.subscribe(e),S.onObjectRemoved.subscribe(e),this.disposables.add(()=>S.onObjectSpawned.unsubscribe(e),()=>S.onObjectRemoved.unsubscribe(e)),this.disposables.add(this.game.events.subscribe($.EventType.BuildingInfiltration,S=>{S.source.owner===this.player&&this.sidebarModel.updateAvailableObjects(this.game.art)})),this.disposables.add(this.game.events.subscribe($.EventType.ObjectOwnerChange,S=>{!S.target.isBuilding()||S.prevOwner!==this.player&&S.target.owner!==this.player||(this.sidebarModel.updateAvailableObjects(this.game.art),this.soundHandler.handleAvailableObjectsUpdate(this.player.production.getAvailableObjects()))})),this.player.production.onQueueUpdate.subscribe(S=>{this.sidebarModel.updateFromQueue(S);var O=this.placementMode.getBuilding();O&&!this.player.production.getQueueForObject(O).find(O).length&&this.worldInteraction.setMode(void 0),this.soundHandler.handleProductionQueueUpdate(S)});let i=()=>{this.sidebarModel.updateSuperWeapons(),this.specialMode&&this.worldInteraction.getMode()===this.specialMode&&!this.player.superWeaponsTrait.getAll().find(S=>S.rules.type===this.specialMode.superWeaponType)&&(this.worldInteraction.setMode(void 0),this.specialMode.dispose(),this.specialMode=void 0)};this.renderer.onFrame.subscribe(i),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(i)),this.disposables.add(this.game.events.subscribe(S=>{S.type===$.EventType.PowerChange&&S.target===this.player&&(this.sidebarModel.powerGenerated=S.power,this.sidebarModel.powerDrained=S.drain)}))}initGameMenuListeners(){const e=(S,O)=>{this.pushAction(j.ActionType.ToggleAlliance,B=>{B.toPlayer=O,B.toggle=S})};this.gameMenu.onToggleAlliance.subscribe(e),this.disposables.add(()=>this.gameMenu.onToggleAlliance.unsubscribe(e))}initHudEventListeners(S,O,N,j,L){S.onSidebarSlotClick.subscribe(S=>this.handleSidebarSlotClick(S)),S.onSidebarTabClick.subscribe(()=>{this.sound.play(D.SoundKey.GUITabSound,F.ChannelType.Ui)}),S.onRepairButtonClick.subscribe(()=>{L.isEnabled()&&(this.sidebarModel.repairMode?L.setMode(void 0):L.setMode(N),this.sound.play(D.SoundKey.GenericClick,F.ChannelType.Ui))}),S.onSellButtonClick.subscribe(()=>{L.isEnabled()&&(this.sidebarModel.sellMode?L.setMode(void 0):L.setMode(O),this.sound.play(D.SoundKey.GenericClick,F.ChannelType.Ui))});let U=this.game.rules.audioVisual.creditTicks;S.onCreditsTick.subscribe(S=>{this.sound.play("up"===S?U[0]:U[1],F.ChannelType.CreditTicks)}),S.onMessagesTick.subscribe(()=>{this.sound.play(D.SoundKey.MessageCharTyped,F.ChannelType.Ui)}),S.onScrollButtonClick.subscribe(S=>{this.sound.play(S?D.SoundKey.GenericClick:D.SoundKey.ScoldSound,F.ChannelType.Ui)});let H=!1,V=L.unitSelectionHandler;S.onCommandBarButtonClick.subscribe(S=>{switch(S){case ue.CommandBarButtonType.BugReport:if(!this.discordUrl)break;this.gameMenu.open(),this.messageBoxApi.show(B.createElement(ge.ReportBug,{discordUrl:this.discordUrl,strings:this.strings}),this.strings.get("GUI:OK"));break;case ue.CommandBarButtonType.Beacon:L.getMode()!==j&&L.setMode(j);break;case ue.CommandBarButtonType.Cheer:this.pushOrder(_.OrderType.Cheer,void 0);break;case ue.CommandBarButtonType.Deploy:this.handleDeploy();break;case ue.CommandBarButtonType.Guard:this.handleGuard();break;case ue.CommandBarButtonType.PlanningMode:var O;this.planningMode.isActive()?(O=this.planningMode.exit(),this.sound.play(D.SoundKey.EndPlanningModeSound,F.ChannelType.Ui),this.queueOrders(O),H||(this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro3")),H=!0)):(this.planningMode.enter(),this.planningMode.updateSelection(L.unitSelectionHandler.getSelectedUnits()),this.sound.play(D.SoundKey.StartPlanningModeSound,F.ChannelType.Ui),H||this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro1Button")));break;case ue.CommandBarButtonType.Stop:this.handleStop();break;case ue.CommandBarButtonType.Team01:this.handleCommandBarTeam(1,V);break;case ue.CommandBarButtonType.Team02:this.handleCommandBarTeam(2,V);break;case ue.CommandBarButtonType.Team03:this.handleCommandBarTeam(3,V);break;case ue.CommandBarButtonType.TypeSelect:V.selectByType();break;default:console.warn("Unhandled command type "+S)}})}handleSidebarSlotClick(S){if(this.worldInteraction.isEnabled())if((S=S.isTouch&&0===S.button&&S.touchDuration&&650<S.touchDuration?{...S,shiftKey:!0,button:2}:S).target.type!==K.SidebarItemTargetType.Special){const N=S.target.rules;let L=this.player.production.getQueueForObject(N),_=L.find(N);var O=_.reduce((S,O)=>S+O.quantity,0);let U=!1;if(0===S.button)if(L.status===Z.QueueStatus.Ready&&N.type===Y.ObjectType.Building)_[0]===L.getFirst()?(this.placementMode.setBuilding(N),this.worldInteraction.setMode(this.placementMode)):this.eva.play("EVA_UnableToComply");else if(L.status===Z.QueueStatus.OnHold&&_[0]===L.getFirst())this.pushAction(j.ActionType.UpdateQueue,S=>{S.queueType=L.type,S.updateType=X.UpdateType.Resume});else{var B=Math.min(L.maxSize-L.currentSize,L.maxItemQuantity-O);let _=Math.min(S.shiftKey?5:1,B);_<=0?N.type===Y.ObjectType.Building?this.eva.play("EVA_UnableToComply"):(U=!0,this.sound.play(D.SoundKey.ScoldSound,F.ChannelType.Ui)):this.pushAction(j.ActionType.UpdateQueue,S=>{S.queueType=L.type,S.updateType=X.UpdateType.Add,S.item=N,S.quantity=_})}else{if(2!==S.button)return;if(L.status===Z.QueueStatus.Active&&_[0]===L.getFirst())this.pushAction(j.ActionType.UpdateQueue,S=>{S.queueType=L.type,S.updateType=X.UpdateType.Pause});else if(_.length&&[Z.QueueStatus.Ready,Z.QueueStatus.OnHold,Z.QueueStatus.Active].includes(L.status)){let B=Math.min(O,S.shiftKey?Number.POSITIVE_INFINITY:1);0<B&&(this.pushAction(j.ActionType.UpdateQueue,S=>{S.queueType=L.type,S.updateType=X.UpdateType.Cancel,S.item=N,S.quantity=B}),this.eva.play("EVA_Canceled"))}else U=!0}U||this.sound.play(D.SoundKey.GenericClick,F.ChannelType.Ui)}else if(0===S.button){if(this.sound.play(D.SoundKey.GenericClick,F.ChannelType.Ui),this.player.superWeaponsTrait?.getAll().find(O=>O.rules===S.target.rules)?.status!==oe.SuperWeaponStatus.Ready)return;void 0!==S.target.rules.type&&this.activateSpecialMode(S.target.rules)}}pushOrder(S,O,B=ie.OrderFeedbackType.None,N=void 0){let L=this.game.getUnitSelection();var D=L.getHash();let F=L.getSelectedUnits(),_=this.actionQueue.getLast();if(_&&_ instanceof U.OrderUnitsAction&&_.orderType===S&&!_.queue&&D===this.lastSelectionHash){if(!_.target||!O||_.target.equals(O))return;this.actionQueue.dequeueLast()}D!==this.lastSelectionHash&&(this.lastSelectionHash=D,this.pushAction(j.ActionType.SelectUnits,S=>{S.unitIds=F.map(S=>S.id)})),this.pushAction(j.ActionType.OrderUnits,B=>{B.orderType=S,B.target=O}),this.soundHandler.handleOrderPushed(N||F[0],S,B)}queueOrders(S){if(S.length){for(let O of S){this.pushAction(j.ActionType.SelectUnits,S=>{S.unitIds=[...O.units].map(S=>S.id)});for(let S of O.waypoints)this.pushAction(j.ActionType.OrderUnits,O=>{O.orderType=S.orderType,O.target=S.target,O.queue=!0})}this.pushAction(j.ActionType.SelectUnits,S=>{S.unitIds=this.worldInteraction.unitSelectionHandler.getSelectedUnits().map(S=>S.id)})}}pushAction(S,O){var B=this.actionFactory.create(S);O?.(B),this.actionQueue.push(B)}activateSpecialMode(S){this.specialMode?.dispose();let O=this.specialMode=ae.SpecialActionMode.factory(this.game.rules.superWeaponRules,S,this.superWeaponFxHandler,this.pointer,this.eva);O.onExecute.subscribe(({tile:O,tile2:B})=>{this.pushAction(j.ActionType.ActivateSuperWeapon,N=>{N.superWeaponType=S.type,N.tile={x:O.rx,y:O.ry},B&&(N.tile2={x:B.rx,y:B.ry})})}),this.worldInteraction.setMode(O)}initKeyboardCommands(S){let O=S.unitSelectionHandler,B=new me.SelectByTypeCmd(O);B.init(),this.disposables.add(B),S.registerKeyCommand(H.KeyCommandType.Options,()=>this.gameMenu.open()).registerKeyCommand(H.KeyCommandType.Scoreboard,()=>this.gameMenu.openDiplo()).registerKeyCommand(H.KeyCommandType.DeployObject,()=>this.handleDeploy()).registerKeyCommand(H.KeyCommandType.StopObject,()=>this.handleStop()).registerKeyCommand(H.KeyCommandType.GuardObject,()=>this.handleGuard()).registerKeyCommand(H.KeyCommandType.AllToCheer,()=>this.pushOrder(_.OrderType.Cheer,void 0)).registerKeyCommand(H.KeyCommandType.TypeSelect,B).registerKeyCommand(H.KeyCommandType.CombatantSelect,()=>O.selectCombatants()).registerKeyCommand(H.KeyCommandType.VeterancyNav,()=>O.selectByVeterancy()).registerKeyCommand(H.KeyCommandType.HealthNav,()=>O.selectByHealth()),[H.KeyCommandType.TeamCreate_1,H.KeyCommandType.TeamCreate_2,H.KeyCommandType.TeamCreate_3,H.KeyCommandType.TeamCreate_4,H.KeyCommandType.TeamCreate_5,H.KeyCommandType.TeamCreate_6,H.KeyCommandType.TeamCreate_7,H.KeyCommandType.TeamCreate_8,H.KeyCommandType.TeamCreate_9,H.KeyCommandType.TeamCreate_10].forEach((B,N)=>S.registerKeyCommand(B,()=>O.createGroup((N+1)%10))),[H.KeyCommandType.TeamAddSelect_1,H.KeyCommandType.TeamAddSelect_2,H.KeyCommandType.TeamAddSelect_3,H.KeyCommandType.TeamAddSelect_4,H.KeyCommandType.TeamAddSelect_5,H.KeyCommandType.TeamAddSelect_6,H.KeyCommandType.TeamAddSelect_7,H.KeyCommandType.TeamAddSelect_8,H.KeyCommandType.TeamAddSelect_9,H.KeyCommandType.TeamAddSelect_10].forEach((B,N)=>S.registerKeyCommand(B,()=>O.addGroupToSelection((N+1)%10)));let N=new V.MapPanningHelper(this.game.map);[H.KeyCommandType.TeamSelect_1,H.KeyCommandType.TeamSelect_2,H.KeyCommandType.TeamSelect_3,H.KeyCommandType.TeamSelect_4,H.KeyCommandType.TeamSelect_5,H.KeyCommandType.TeamSelect_6,H.KeyCommandType.TeamSelect_7,H.KeyCommandType.TeamSelect_8,H.KeyCommandType.TeamSelect_9,H.KeyCommandType.TeamSelect_10].forEach((B,j)=>S.registerKeyCommand(B,new W.SelectGroupCmd((j+1)%10,O,S.targetLines,N,this.worldScene.cameraPan))),[H.KeyCommandType.TeamCenter_1,H.KeyCommandType.TeamCenter_2,H.KeyCommandType.TeamCenter_3,H.KeyCommandType.TeamCenter_4,H.KeyCommandType.TeamCenter_5,H.KeyCommandType.TeamCenter_6,H.KeyCommandType.TeamCenter_7,H.KeyCommandType.TeamCenter_8,H.KeyCommandType.TeamCenter_9,H.KeyCommandType.TeamCenter_10].forEach((B,j)=>S.registerKeyCommand(B,new z.CenterGroupCmd((j+1)%10,O,N,this.worldScene.cameraPan))),new Map([[H.KeyCommandType.StructureTab,K.SidebarCategory.Structures],[H.KeyCommandType.DefenseTab,K.SidebarCategory.Armory],[H.KeyCommandType.InfantryTab,K.SidebarCategory.Infantry],[H.KeyCommandType.UnitTab,K.SidebarCategory.Vehicles]]).forEach((O,B)=>{S.registerKeyCommand(B,()=>{var B;for(B of(this.sidebarModel.selectTab(O),this.player.production.getAllQueues().filter(S=>S.status===Z.QueueStatus.Ready))){var N=this.sidebarModel.getTabForQueueType(B.type);if(O===N.id&&B.getFirst().rules.type===Y.ObjectType.Building){this.placementMode.setBuilding(B.getFirst().rules),S.setMode(this.placementMode);break}}})}),S.registerKeyCommand(H.KeyCommandType.CenterBase,new pe.CenterBaseCmd(this.player,this.game.rules,N,this.worldScene.cameraPan)),S.registerKeyCommand(H.KeyCommandType.ToggleSell,()=>{this.sidebarModel.sellMode?S.setMode(void 0):S.setMode(this.sellMode)}),S.registerKeyCommand(H.KeyCommandType.ToggleRepair,()=>{this.sidebarModel.repairMode?S.setMode(void 0):S.setMode(this.repairMode)});let L=new Q.LastRadarEventCmd(this.player,N,this.worldScene.cameraPan);S.registerKeyCommand(H.KeyCommandType.CenterOnRadarEvent,L),this.disposables.add(this.game.events.subscribe(S=>L.handleGameEvent(S)));let c=()=>{this.runtimeVars.cheatsEnabled.value?S.registerKeyCommand(H.KeyCommandType.BuildCheat,()=>this.speedCheat.value=!this.speedCheat.value).registerKeyCommand(H.KeyCommandType.FreeMoney,()=>this.player.credits+=1e4).registerKeyCommand(H.KeyCommandType.ToggleShroud,()=>this.game.mapShroudTrait.revealMap(this.player,this.game)):(S.unregisterKeyCommand(H.KeyCommandType.BuildCheat).unregisterKeyCommand(H.KeyCommandType.FreeMoney).unregisterKeyCommand(H.KeyCommandType.ToggleShroud),this.speedCheat.value=!1)};c(),this.runtimeVars.cheatsEnabled.onChange.subscribe(c),this.disposables.add(()=>this.runtimeVars.cheatsEnabled.onChange.unsubscribe(c)),S.registerKeyCommand(H.KeyCommandType.ToggleFps,()=>this.runtimeVars.fps.value=!this.runtimeVars.fps.value),S.registerKeyCommand(H.KeyCommandType.ToggleAlliance,()=>{var S=this.game.rules.mpDialogSettings;if(S.alliesAllowed&&S.allyChangeAllowed){let S=O.getSelectedUnits()[0]?.owner;S&&S!==this.player&&this.game.alliances.canRequestAlliance(S)&&this.pushAction(j.ActionType.ToggleAlliance,O=>{O.toPlayer=S,O.toggle=!this.game.alliances.areAllied(this.player,S)})}});let U=!1;S.registerKeyCommand(H.KeyCommandType.PlanningMode,{triggerMode:ee.TriggerMode.KeyDownUp,execute:O=>{var B;O?(B=this.planningMode.exit(),this.sound.play(D.SoundKey.EndPlanningModeSound,F.ChannelType.Ui),this.queueOrders(B),U||(this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro3")),U=!0)):(this.planningMode.enter(),this.planningMode.updateSelection(S.unitSelectionHandler.getSelectedUnits()),this.sound.play(D.SoundKey.StartPlanningModeSound,F.ChannelType.Ui),U||this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro1Key")))}}),S.registerKeyCommand(H.KeyCommandType.ScatterObject,()=>{this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoScatter")):this.pushOrder(_.OrderType.Scatter,void 0)});let $=new re.SelectNextUnitCmd(O,N,this.worldScene.cameraPan,this.player,this.game.getWorld());S.registerKeyCommand(H.KeyCommandType.NextObject,()=>{$.setReverse(!1),$.execute()}),S.registerKeyCommand(H.KeyCommandType.PreviousObject,()=>{$.setReverse(!0),$.execute()}),this.disposables.add($);var q=this.game.map.startingLocations[this.player.startLocation];q=this.game.map.tiles.getByMapCoords(q.x,q.y);let X=N.computeCameraPanFromTile(q.rx,q.ry),J=new Map;[H.KeyCommandType.SetView1,H.KeyCommandType.SetView2,H.KeyCommandType.SetView3,H.KeyCommandType.SetView4].forEach((O,B)=>{S.registerKeyCommand(O,new se.SetCameraLocationCmd(this.worldScene.cameraPan,J,B-1))}),[H.KeyCommandType.View1,H.KeyCommandType.View2,H.KeyCommandType.View3,H.KeyCommandType.View4].forEach((O,B)=>{S.registerKeyCommand(O,new ne.GoToCameraLocationCmd(this.worldScene.cameraPan,J,B-1,X))}),[H.KeyCommandType.Taunt_1,H.KeyCommandType.Taunt_2,H.KeyCommandType.Taunt_3,H.KeyCommandType.Taunt_4,H.KeyCommandType.Taunt_5,H.KeyCommandType.Taunt_6,H.KeyCommandType.Taunt_7,H.KeyCommandType.Taunt_8].forEach((O,B)=>{S.registerKeyCommand(O,()=>this.tauntHandler?.sendTaunt(B+1))}),S.registerKeyCommand(H.KeyCommandType.PlaceBeacon,()=>{S.getMode()!==this.beaconMode&&S.setMode(this.beaconMode)}),q=new le.CenterViewCmd(O,N,this.worldScene.cameraPan),S.registerKeyCommand(H.KeyCommandType.CenterView,q);let te=new ce.FollowUnitCmd(O,this.renderableManager,S,N,this.worldScene.cameraPan,this.worldScene);te.init(),this.disposables.add(te),S.registerKeyCommand(H.KeyCommandType.Follow,te);let M=()=>this.sound.play(D.SoundKey.SystemError,F.ChannelType.Ui);[H.KeyCommandType.PageUser,H.KeyCommandType.ScreenCapture].forEach(O=>S.registerKeyCommand(O,M))}handleDeploy(){this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoDeploy")):this.pushOrder(_.OrderType.DeploySelected,void 0)}handleStop(){this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoStop")):this.pushOrder(_.OrderType.Stop,void 0)}handleGuard(){this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoGuardArea")):this.pushOrder(_.OrderType.Guard,void 0)}handleBeacon(S){this.isSinglePlayer||this.beaconFxHandler.canPingLocation(this.player,S)&&this.pushAction(j.ActionType.PingLocation,O=>{O.tile={x:S.rx,y:S.ry}})}handleCommandBarTeam(S,O){let B=O.getGroupUnits(S);B.length?O.getSelectedUnits().some(S=>B.includes(S))?new z.CenterGroupCmd(S,O,new V.MapPanningHelper(this.game.map),this.worldScene.cameraPan).execute():O.selectGroup(S):O.createGroup(S)}handleInvalidCommand(S){this.sound.play(D.SoundKey.ScoldSound,F.ChannelType.Ui),this.messageList.addUiFeedbackMessage(S)}})}}}),System.register("gui/screen/game/GameLoader",["data/DataStream","@puzzl/core/lib/async/cancellation","engine/ResourceLoader","engine/resourceConfigs","engine/Engine","engine/TheaterType","util/time","game/SideType","game/Coords","engine/IsoCoords","engine/type/ObjectType","engine/ImageFinder","engine/renderable/builder/ShpBuilder","engine/renderable/entity/PipOverlay","engine/renderable/builder/CanvasSpriteBuilder","game/theater/TileSets","game/GameFactory","engine/renderable/fx/TrailerSmokeFx","engine/renderable/builder/ShpAggregator","engine/renderable/entity/building/BuildingShpHelper","engine/renderable/entity/building/BuildingAnimArtProps","util/math","data/MixFile","util/userAgent","game/gameopts/GameOptRandomGen","engine/renderable/DebugRenderable","game/ini/MixinRules","util/typeGuard"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S}],execute:function(){S("GameLoader",class{constructor(S,O,B,N,j,L,D,F,_,U,H,V,W,z,K){this.appVersion=S,this.workerHostApi=O,this.cdnResourceLoader=B,this.appResourceLoader=N,this.rules=j,this.gameModes=L,this.sound=D,this.iniLogger=F,this.actionLogger=_,this.speedCheat=U,this.gameResConfig=H,this.vxlGeometryPool=V,this.buildingImageDataCache=W,this.debugBotIndex=z,this.devMode=K}async load(S,O,B,N,j,L,D,F){var _=this.resolveLoadingPlayerInfos(S,O,B);D.start(_,B.mapTitle,j);try{return this.workerHostApi.warmUpPool(),await this.doLoad(S,O,B,N,j,L,D,F)}finally{this.workerHostApi.dispose()}}resolveLoadingPlayerInfos(S,O,B){let N=se.GameOptRandomGen.factory(S,O),j=N.generateColors(B),L=N.generateCountries(B,this.rules);return B.humanPlayers.map(S=>({...S,colorId:j.get(S)??S.colorId,countryId:L.get(S)??S.countryId}))}async doLoad(S,O,F,W,K,$,q,Q){if(!D.Engine.vfs)throw new Error("Virtual File System not initialized");this.clearStaticCaches(),this.buildingImageDataCache.clear();try{D.Engine.getActiveMod()||await this.loadFestiveAssets(Q)}catch(S){if(S instanceof N.OperationCanceledError)throw S;console.error("Couldn't load festive assets",S)}await this.loadTheater(W.theaterType,Q,S=>q.onLoadProgress(S/100*30)),await _.sleep(1);var Z=await this.loadBotsLib();if(!this.devMode&&Z.version!==this.appVersion)throw new j.DownloadError(`Bot library version mismatch. Expected ${this.appVersion}, but got `+Z.version);let Y,{game:X,theater:J}=await this.createGame(S,O,F,W,$,Z),ee=U.SideType.GDI;K&&(Y=X.getPlayerByName(K),Y.isObserver||(ee=Y.country.side));let te=this.gameResConfig.isCdn()?await this.cdnResourceLoader.loadResources([L.ResourceType.Sounds,...ee===U.SideType.GDI?[L.ResourceType.EvaAlly,L.ResourceType.UiAlly]:[L.ResourceType.EvaSov,L.ResourceType.UiSov],L.ResourceType.Cameo],Q,S=>q.onLoadProgress(30+S/100*15)):void 0;te&&(D.Engine.vfs.addArchive(new ie.MixFile(new B.DataStream(te.pop(L.ResourceType.Cameo))),this.cdnResourceLoader.getResourceFileName(L.ResourceType.Cameo)),await D.Engine.vfs.addMixFile("cameocd.mix"));var se,ne=this.collectCameoFileNames(X);if(await this.loadHudSideImages(te,ee),q.onLoadProgress(40),await _.sleep(1),te){for(se of[L.ResourceType.Sounds,ee===U.SideType.GDI?L.ResourceType.EvaAlly:L.ResourceType.EvaSov])D.Engine.vfs.addArchive(new ie.MixFile(new B.DataStream(te.pop(se))),this.cdnResourceLoader.getResourceFileName(se));await D.Engine.vfs.addBagFile("audio.bag")}return q.onLoadProgress(45),await _.sleep(1),(Z=/iPhone|Android|CrOS|Windows Phone|webOS/i.test(navigator.userAgent)||re.isIpad())||(console.time("Load sounds"),await this.prepareSounds(Q,S=>q.onLoadProgress(45+S/100*15)),console.timeEnd("Load sounds")),q.onLoadProgress(60),await _.sleep(1),Z||(Z=D.Engine.getImages(),Z=new z.ImageFinder(Z,J),console.time("Load textures"),await this.prepareTextures(X.rules,X.art,W,Z,Q,S=>q.onLoadProgress(60+S/100*10)),console.timeEnd("Load textures")),q.onLoadProgress(70),await _.sleep(1),console.time("Load voxels"),await this.prepareVxlGeometries(X.rules,X.art,X.map,D.Engine.getVoxels(),Q,S=>q.onLoadProgress(70+S/100*20)),console.timeEnd("Load voxels"),await _.sleep(1),Q?.throwIfCancelled(),V.IsoCoords.init({x:0,y:X.map.mapBounds.getFullSize().width*H.Coords.getWorldTileSize()/2}),X.init(Y),Q?.throwIfCancelled(),q.onLoadProgress(95),await _.sleep(1),{game:X,theater:J,hudSide:ee,cameoFilenames:ne}}collectCameoFileNames(S){let O=[],B=[...S.rules.buildingRules.values(),...S.rules.infantryRules.values(),...S.rules.vehicleRules.values(),...S.rules.aircraftRules.values()];for(var N of B.values())S.art.hasObject(N.name,N.type)&&(N=S.art.getObject(N.name,N.type),O.push(N.cameo+".shp"),O.push(N.altCameo+".shp"));for(var j of S.rules.superWeaponRules.values())j.sidebarImage.length&&O.push(j.sidebarImage+".shp");return O=O.filter(S=>D.Engine.getImages().has(S)),[...new Set(O)]}async prepareSounds(S,O){let B=new Set;for(var j of this.sound.soundSpecs.getAll())for(var L of j.sounds){const S=this.sound.getWavFile(L);S&&S.isRawImaAdpcm()&&B.add(S)}let D=0,F=B.size;if(F){let j=[...B].sort((S,O)=>S.getRawData().length-O.getRawData().length);var _=this.workerHostApi.concurrency;try{for(let B=0;B<_;B++)this.workerHostApi.queueTask(async B=>{for(;j.length&&!S?.isCancelled();){let S=j.pop();var N=S.getRawData();N=await B.decodeWav(N),S.setData(N),D++,N=D/F*100,Math.floor(N)%10==0&&O(D/F*100)}}),await Promise.resolve();await this.workerHostApi.waitForTasks(),S?.throwIfCancelled()}catch(B){if(B instanceof N.OperationCanceledError)throw B;console.error(B)}}}async loadTheater(S,O,N){if(this.gameResConfig.isCdn()){if(!(_=L.theaterSpecificResources.get(S)))throw new Error("Unhandled theater type "+F.TheaterType[S]);var j,_=[L.ResourceType.BuildGen,L.ResourceType.Anims,L.ResourceType.Vxl,..._];let U=await this.cdnResourceLoader.loadResources(_,O,S=>N(S/100*60));for(j of _)D.Engine.vfs.addArchive(new ie.MixFile(new B.DataStream(U.pop(j))),this.cdnResourceLoader.getResourceFileName(j))}else N(100)}async createGame(S,O,B,N,j,L){var F=D.Engine.getIni(this.gameModes.getById(B.gameMode).rulesOverride),_=ae.MixinRules.getTypes(B).map(S=>D.Engine.mixinRulesFileNames.get(S)).filter(oe.isNotNullOrUndefined).map(S=>D.Engine.getIni(S)),U=await D.Engine.loadTheater(N.theaterType),H=D.Engine.getActiveEngine(),V=D.Engine.getTheaterSettings(H,N.theaterType);H=D.Engine.getTheaterIni(H,N.theaterType);let W=new Q.TileSets(H);return W.loadTileData(D.Engine.getTileData(),V.extension),{game:Z.GameFactory.create(N,W,D.Engine.getRules(),D.Engine.getArt(),D.Engine.getAi(),F,_,S,O,B,this.gameModes,j,L,this.iniLogger,this.speedCheat,this.debugBotIndex,this.actionLogger),theater:U}}async loadBotsLib(){let S;try{S=await SystemJS.import("@chronodivide/sp-bots")}catch(S){throw new j.DownloadError("Failed to download bot lib",{cause:S})}const O=Object.assign({},S);try{const{CustomAiLoader:S}=await SystemJS.import("game/bot/CustomAiLoader"),B=new S(console);O.customBots=await B.loadAll(),console.log(`Loaded ${O.customBots.size} custom AI bots`);const{setCustomBotsRegistry:N}=await SystemJS.import("game/gameopts/constants");N(O.customBots)}catch(S){console.warn("Failed to load custom AI bots:",S),O.customBots=new Map}return O}async loadHudSideImages(S,O){if(!D.Engine.vfs)throw new Error("VFS is not initialized");if(D.Engine.vfs.removeArchive("sidec01.mix"),D.Engine.vfs.removeArchive("sidec02.mix"),D.Engine.vfs.removeArchive("sidec01cd.mix"),D.Engine.vfs.removeArchive("sidec02cd.mix"),D.Engine.unloadSideMixData(),S){var N=O===U.SideType.GDI?L.ResourceType.UiAlly:L.ResourceType.UiSov,j=this.cdnResourceLoader.getResourceFileName(N);if(!["sidec01.mix","sidec02.mix"].includes(j))throw new Error(`Side mix file name "${j}" mismatch`);D.Engine.vfs.addArchive(new ie.MixFile(new B.DataStream(S.pop(N))),j)}else await D.Engine.vfs.addMixFile(O===U.SideType.GDI?"sidec01.mix":"sidec02.mix");await D.Engine.vfs.addMixFile(O===U.SideType.GDI?"sidec01cd.mix":"sidec02cd.mix")}async loadFestiveAssets(S){let O=new Date;var N=O.getMonth()+1,j=O.getDate();let F;10===N&&te.isBetween(j,24,31)||11===N&&te.isBetween(j,1,6)?F=L.ResourceType.HalloweenMix:12===N&&te.isBetween(j,16,31)&&(F=L.ResourceType.XmasMix),void 0===F||(N=this.appResourceLoader.getResourceFileName(F),D.Engine.vfs.hasArchive(N))||(j=(await this.appResourceLoader.loadResources([F],S)).pop(F),j=new ie.MixFile(new B.DataStream(j)),D.Engine.vfs.addArchive(j,N))}async prepareTextures(S,O,B,N,j,L){let D=new J.BuildingShpHelper(N),F=new X.ShpAggregator,U=new Set,H=performance.now(),V=new Set;for(var $ of B.structures)V.add($.name);let q=[];for(var[Q,Z]of S.buildingRules)!V.has(Q)&&-1===Z.techLevel||q.push(Q);let Y=0;var te,ie,re=q.length+S.animationNames.size;for(te of q){j?.throwIfCancelled();var se=performance.now();if(1e3<se-H&&(H=se,L(Y/re*100),await _.sleep(0)),Y++,!this.buildingImageDataCache.has(te)&&O.hasObject(te,W.ObjectType.Building)&&!(se=O.getObject(te,W.ObjectType.Building)).demandLoad){let B=new ee.BuildingAnimArtProps;for(var ne of(B.read(se.art,O),B.getAll().values()))for(var ae of ne)U.add(ae.name);try{var oe=N.findByObjectArt(se),le=se.bibShape?N.find(se.bibShape,se.useTheaterExtension):void 0,ce=D.collectAnimShpFiles(B,se);let S=D.getShpFrameInfos(se,oe,le,ce);var he=F.aggregate(S.values(),`agg_${te}.shp`);this.buildingImageDataCache.set(te,he),K.ShpBuilder.prepareTexture(he.file)}catch(S){if(S instanceof z.ImageFinder.MissingImageError)continue;throw S}}}for(ie of S.animationNames){j?.throwIfCancelled();var ue=performance.now();if(1e3<ue-H&&(H=ue,L(Y/re*100),await _.sleep(0)),Y++,!U.has(ie)&&O.hasObject(ie,W.ObjectType.Animation)){ue=O.getAnimation(ie);try{var de=N.findByObjectArt(ue);K.ShpBuilder.prepareTexture(de)}catch(S){if(S instanceof z.ImageFinder.MissingImageError)continue;throw S}}}}async prepareVxlGeometries(S,O,B,j,L,D){let F=new Set([...S.vehicleRules.values(),...S.aircraftRules.values(),...S.buildingRules.values()].filter(S=>(-1!==S.techLevel||S.spawned)&&O.hasObject(S.name,S.type)));for(var _ of S.buildingRules.values()){if(_.freeUnit){let O;S.hasObject(_.freeUnit,W.ObjectType.Vehicle)&&(O=S.getObject(_.freeUnit,W.ObjectType.Vehicle)),O&&F.add(O)}_.undeploysInto&&S.hasObject(_.undeploysInto,W.ObjectType.Vehicle)&&F.add(S.getObject(_.undeploysInto,W.ObjectType.Vehicle))}for(var U of B.getInitialMapObjects().technos)(U.isVehicle()||U.isAircraft())&&S.hasObject(U.name,U.type)&&F.add(S.getObject(U.name,U.type));let H=new Map;for(var V of F){let B=O.getObject(V.name,V.type);if(B.isVoxel||V.type===W.ObjectType.Building&&V.turretAnimIsVoxel){var z,K=B.imageName.toLowerCase();let O=[];if(V.type!==W.ObjectType.Building){if(O.push(K+".vxl"),V.spawns&&V.noSpawnAlt&&O.push(K+"wo.vxl"),V.harvester&&V.unloadingClass&&S.hasObject(V.unloadingClass,W.ObjectType.Vehicle)&&O.push(S.getObject(V.unloadingClass,W.ObjectType.Vehicle).imageName.toLowerCase()+".vxl"),V.turret){for(let S=0;S<V.turretCount;++S)O.push(K+`tur${S||""}.vxl`);var $=K+"barl.vxl";j.has($)&&O.push($)}}else if(V.turretAnimIsVoxel){let S=V.turretAnim.toLowerCase()+".vxl";O.push(S),$=S.replace("tur","barl"),j.has($)&&O.push($)}for(z of O){var q=j.get(z);q&&H.set(z,q)}}}let Q=0,Z=[];for(var[Y,X]of H)L?.throwIfCancelled(),await this.vxlGeometryPool.loadFromStorage(X,Y)?(Q++,D(Q/H.size*100)):Z.push([Y,X]);if(Z.length){Z.sort((S,O)=>O[1].voxelCount-S[1].voxelCount);var J=this.workerHostApi.concurrency;let S=this.vxlGeometryPool.getModelQuality(),O=[()=>this.vxlGeometryPool.clearOtherModStorage()];try{for(let B=0;B<J;B++)this.workerHostApi.queueTask(async B=>{for(;Z.length&&!L?.isCancelled();){let[N,j]=Z.pop(),L=await B.generateVxlGeometry(j,S);O.push(()=>this.vxlGeometryPool.persistToStorage(j,N,L)),Q++,D(Q/H.size*100)}});await this.workerHostApi.waitForTasks(),L?.throwIfCancelled()}catch(B){if(B instanceof N.OperationCanceledError)throw B;console.error(B),console.warn("Failed to pre-load VXL geometries. Skipping.")}await Promise.all(O.map(S=>S())).catch(S=>console.warn("Failed to persist VXL geometry cache",[S]))}}clearStaticCaches(){$.PipOverlay.clearCaches(),K.ShpBuilder.clearCaches(),ne.DebugRenderable.clearCaches(),q.CanvasSpriteBuilder.clearCaches(),Y.TrailerSmokeFx.clearTextureCache()}})}}}),System.register("gui/screen/game/GameMenu",["util/disposable/CompositeDisposable","gui/screen/game/gameMenu/GameMenuController","gui/screen/game/gameMenu/ScreenType","util/event"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("GameMenu",class{get onOpen(){return this._onOpen.asEvent()}get onQuit(){return this._onQuit.asEvent()}get onObserve(){return this._onObserve.asEvent()}get onCancel(){return this._onCancel.asEvent()}get onToggleAlliance(){return this._onToggleAlliance.asEvent()}get onSendMessage(){return this._onSendMessage.asEvent()}constructor(S,O,N,j,D,F,_=!1){this.subScreens=S,this.game=O,this.localPlayer=N,this.chatHistory=j,this.gservCon=D,this.isSinglePlayer=F,this.isTournament=_,this.disposables=new B.CompositeDisposable,this._onOpen=new L.EventDispatcher,this._onQuit=new L.EventDispatcher,this._onObserve=new L.EventDispatcher,this._onCancel=new L.EventDispatcher,this._onToggleAlliance=new L.EventDispatcher,this._onSendMessage=new L.EventDispatcher}init(S){let O=new N.GameMenuController(S);for(var[B,j]of this.subScreens)O.addScreen(B,j);this.controller=O,this.disposables.add(O,()=>this.controller=void 0),this.bindHudEvents(S)}handleHudChange(S){this.controller&&(this.controller.setHud(S),this.bindHudEvents(S),this.controller.rerenderCurrentScreen())}bindHudEvents(S){S.onOptButtonClick.subscribe(()=>this.open()),S.onDiploButtonClick.subscribe(()=>this.openDiplo())}open(){this.controller?(this._onOpen.dispatch(this),this.controller.goToScreen(j.ScreenType.Home,{observeAllowed:!(this.isTournament||this.isSinglePlayer||void 0===this.localPlayer||this.localPlayer.isObserver||this.localPlayer.defeated),onQuit:async()=>{this.controller.close(),this._onQuit.dispatch(this)},onObserve:()=>{this.controller.close(),this._onObserve.dispatch(this)},onCancel:()=>{this.controller.close(),this._onCancel.dispatch(this)}})):console.warn("Menu not initialized")}openDiplo(){this.controller?(this._onOpen.dispatch(this),this.controller.goToScreen(j.ScreenType.Diplo,{game:this.game,localPlayer:this.localPlayer,isSinglePlayer:this.isSinglePlayer,chatHistory:this.chatHistory,gservCon:this.gservCon,onToggleAlliance:(S,O)=>{this._onToggleAlliance.dispatch(S,O)},onSendMessage:S=>this._onSendMessage.dispatch(this,S),onCancel:()=>{this.controller.close(),this._onCancel.dispatch(this)}})):console.warn("Menu not initialized")}openConnectionInfo(S,O,B){this.controller?(this._onOpen.dispatch(this),this.controller.goToScreen(j.ScreenType.ConnectionInfo,{players:S,localPlayer:this.localPlayer,chatHistory:this.chatHistory,chatNetHandler:B,gservCon:O,onQuit:async()=>{this.controller.close(),this._onQuit.dispatch(this)}})):console.warn("Menu not initialized")}close(){this.controller?this.controller.getCurrentScreen()&&(this.controller.close(),this._onCancel.dispatch(this)):console.warn("Menu not initialized")}getCurrentScreen(){return this.controller?.getCurrentScreen()}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/GameMenuScreen",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("GameMenuScreen",class{setController(S){this.controller=S}})}}}),System.register("gui/screen/game/GameScreen",["data/DataStream","network/GservError","gui/screen/ScreenType","gui/screen/mainMenu/ScreenType","@puzzl/core/lib/async/sleep","game/Game","engine/Engine","gui/screen/game/component/hud/viewmodel/SidebarModel","network/gamestate/LockstepManager","network/gamestate/ActionSerializer","game/action/ActionFactory","game/action/ActionQueue","tools/DevToolsApi","engine/GameAnimationLoop","gui/screen/game/component/GameResultPopup","gui/jsx/jsx","util/disposable/CompositeDisposable","network/gamestate/SoloPlayTurnManager","gui/screen/game/SoundHandler","LocalPrefs","gui/screen/game/worldInteraction/WorldInteractionFactory","gui/screen/game/CombatantUi","gui/screen/game/ObserverUi","gui/screen/game/GameMenu","gui/screen/game/WorldView","engine/sound/Eva","engine/sound/EvaSpecs","gui/screen/game/NetStats","gui/screen/game/HudFactory","gui/screen/game/component/Minimap","game/SideType","network/gamestate/Replay","network/gamestate/ReplayRecorder","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","game/action/ActionFactoryReg","gui/screen/game/component/hud/viewmodel/MessageList","engine/sound/SoundKey","engine/sound/ChannelType","gui/screen/game/ChatNetHandler","gui/screen/game/ChatTypingHandler","@puzzl/core/lib/async/Task","network/IrcConnection","@puzzl/core/lib/async/cancellation","network/gservConfig","engine/sound/Music","gui/screen/game/TauntHandler","gui/screen/game/TauntPlayback","game/action/ActionType","game/event/EventType","gui/screen/game/gameMenu/ConnectionInfoScreen","gui/screen/game/component/hud/commandBar/CommandBarButtonList","gui/screen/game/component/hud/commandBar/CommandBarButtonType","engine/ResourceLoader","data/vfs/StorageQuotaError","data/vfs/FileNotFoundError","util/userAgent","data/vfs/IOError","gui/screen/RootScreen","gui/screen/game/loadingScreen/LoadingScreenApiFactory","gui/replay/ReplayStorageError","data/MapFile","data/vfs/VirtualFile","util/string","engine/MapDigest","engine/MapSupport","network/gameres/GameRes","game/gameopts/constants","gui/screen/mainMenu/MainMenuRoute","gui/screen/RootRoute","gui/chat/ChatHistory","gui/chat/ChatMessageFormat","gui/screen/game/MedianPing","gui/screen/game/PingMonitor","gui/screen/game/component/hud/VirtualJoystick"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,xe,Oe,Ae,Me,Re,Pe,Ie,ke,Be,Ne,je,Le,De,Fe,_e,Ue,He,Ge,Ve,We,ze,Ke,$e,qe,Qe,Ze,Ye,Xe,Je,et,it;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S},function(S){ge=S},function(S){pe=S},function(S){me=S},function(S){fe=S},function(S){ye=S},function(S){Te=S},function(S){ve=S},function(S){be=S},function(S){Se=S},function(S){we=S},function(S){Ee=S},function(S){xe=S},function(S){Oe=S},function(S){Ae=S},function(S){Me=S},function(S){Re=S},function(S){Pe=S},function(S){Ie=S},function(S){ke=S},function(S){Be=S},function(S){Ne=S},function(S){je=S},function(S){Le=S},function(S){De=S},function(S){Fe=S},function(S){_e=S},function(S){Ue=S},function(S){He=S},function(S){Ge=S},function(S){Ve=S},function(S){We=S},function(S){ze=S},function(S){Ke=S},function(S){$e=S},function(S){qe=S},function(S){Qe=S},function(S){Ze=S},function(S){Ye=S},function(S){Xe=S},function(S){Je=S},function(S){it=S}],execute:function(){et=class extends Fe.RootScreen{constructor(S,O,B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we){super(),this.workerHostApi=S,this.gservCon=O,this.wgameresService=B,this.wolService=N,this.mapTransferService=j,this.engineVersion=L,this.engineModHash=D,this.errorHandler=F,this.gameMenuSubScreens=_,this.loadingScreenApiFactory=U,this.gameOptsParser=H,this.gameOptsSerializer=V,this.config=W,this.strings=z,this.renderer=K,this.uiScene=$,this.runtimeVars=q,this.messageBoxApi=Q,this.toastApi=Y,this.uiAnimationLoop=X,this.viewport=J,this.jsxRenderer=ee,this.pointer=te,this.sound=ie,this.music=re,this.mixer=se,this.keyBinds=ne,this.generalOptions=ae,this.localPrefs=oe,this.actionLogger=le,this.lockstepLogger=ce,this.replayManager=he,this.fullScreen=ue,this.mapFileLoader=de,this.mapDir=ge,this.mapList=pe,this.gameLoader=me,this.vxlGeometryPool=fe,this.buildingImageDataCache=ye,this.mutedPlayers=Te,this.tauntsEnabled=ve,this.speedCheat=be,this.sentry=Se,this.battleControlApi=we,this.preventUnload=!0,this.avgPing=new Xe.MedianPing,this.disposables=new Z.CompositeDisposable,this.onGservClose=S=>{this.replay&&(this.replay.finish(this.game.currentTick),this.saveReplay(this.replay)),this.handleError(S,this.strings.get("TXT_YOURE_DISCON")),this.game&&this.sendGameRes(this.game,{disconnect:!0,desync:!1,quit:!1,finished:!1})}}async onEnter(S){try{window.dispatchEvent(new CustomEvent("ra2web:viewportClampMode",{detail:{mode:"menu"}}))}catch{}this.pointer.lock(),this.pointer.setVisible(!1),await(this.music?.play(xe.MusicType.Loading));let O=new we.CancellationTokenSource;this.disposables.add(()=>O.cancel());let B,N=O.token;this.returnTo=S.returnTo,this.isTournament=S.tournament;var D=this.playerName=S.playerName,U=this.isSinglePlayer=S.create&&S.singlePlayer;if(U)B=S.gameOpts;else{var H=this.wolService.getCredentials();if(!H||H.user!==D)return this.localPrefs.removeItem(J.StorageKey.LastConnection),void this.controller?.goToScreen(j.ScreenType.MainMenuRoot,{route:new qe.MainMenuRoute(L.ScreenType.Login,{forceUser:D,afterLogin:O=>new Qe.RootRoute(j.ScreenType.Game,S)})});this.wolService.setAutoReconnect(!0),this.gservCon.onClose.subscribe(this.onGservClose);try{B=await this.connectToServerInstance(S,H,N)}catch(O){return void this.handleGservConError(O)}let{returnTo:F,..._}=S;this.localPrefs.setItem(J.StorageKey.LastConnection,JSON.stringify(_))}let $;this.config.devMode?this.runtimeVars.cheatsEnabled.value=this.isSinglePlayer:this.isSinglePlayer||(this.runtimeVars.cheatsEnabled.value=!1);try{var q=await this.transferAndLoadMapFile(S,B.mapName,B.mapDigest,N);B.mapOfficial||(this.debugMapFile=q,this.disposables.add(()=>this.debugMapFile=void 0)),$=new He.MapFile(q);var Q=ze.MapSupport.check($,this.strings);if(Q)return void this.handleError(Q,Q)}catch(O){return void this.handleMapLoadError(O,B.mapName)}if(Q=this.loadingScreenApiFactory.create(U?_e.LoadingScreenType.SinglePlayer:_e.LoadingScreenType.MultiPlayer),this.loadingScreenApi=Q,this.disposables.add(Q,()=>this.loadingScreenApi=void 0),this.disposables.add(()=>this.gameLoader.clearStaticCaches()),!N.isCancelled()){let j;try{j=await this.gameLoader.load(S.gameId,S.timestamp,B,$,D,this.isSinglePlayer,Q,N)}catch(O){return void this.handleGameLoadError(O,S,B)}if(!N.isCancelled()){let{game:N,theater:L,hudSide:H,cameoFilenames:$}=j;this.game=N,this.disposables.add(N,()=>this.game=void 0,()=>_.Engine.unloadTheater(L.type));let q,Z=N.getPlayerByName(D);try{q=this.loadUi(N,L,Z,H,$)}catch(O){return Q=O.message?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):this.strings.get("TS:GameInitError")+(N.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash")),void this.handleGameError(O,Q,N)}let X=new W.ActionFactory;(new pe.ActionFactoryReg).register(X,N,D);let J=new z.ActionQueue,ee=this.replay=new ue.Replay;this.disposables.add(()=>this.replay=void 0),ee.init(N.id,N.startTimestamp,B,this.engineVersion,this.engineModHash);let te=new de.ReplayRecorder(ee,N.getPlayerNumber(Z),N.gameOpts.humanPlayers,new V.ActionSerializer);if(this.isSinglePlayer)this.gameTurnMgr=new Y.SoloPlayTurnManager(N,Z,J,this.actionLogger,te);else{this.lagState=!1;let S=this.initLockstep(N,Z,X,J,te);if(Z.isObserver)try{S.setPassiveMode(!0)}catch(O){if(O instanceof Se.IrcConnection.SocketError)return;throw O}else this.disposables.add(N.events.subscribe(Re.EventType.PlayerDefeated,S=>{S.target===Z&&Z.isObserver&&this.gameTurnMgr.setPassiveMode?.(!0)}));this.gameTurnMgr=S}this.gameTurnMgr.init();let E=()=>{if(N.status!==F.GameStatus.Started)try{this.onGameStart(Z,N,q,J,X,ee,te)}catch(O){var S=O.message?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):this.strings.get("TS:GameInitError")+(N.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash"));this.handleGameError(O,S,N)}};if(U)E(),K.DevToolsApi.registerCommand("reset",async()=>{await this.onLeave(),await this.onEnter(S)}),K.DevToolsApi.registerVar("speed",N.desiredSpeed),this.disposables.add(()=>K.DevToolsApi.unregisterCommand("reset"),()=>K.DevToolsApi.unregisterVar("speed")),K.DevToolsApi.registerVar("cheats",this.runtimeVars.cheatsEnabled),this.disposables.add(()=>K.DevToolsApi.unregisterVar("cheats")),K.DevToolsApi.registerCommand("ctx",()=>({game:N,localPlayer:Z,actionFactory:X,actionQueue:J,worldView:this.worldView,minimap:this.minimap,battleControl:this.battleControlApi,strings:this.strings,isSinglePlayer:this.isSinglePlayer})),this.disposables.add(()=>K.DevToolsApi.unregisterCommand("ctx")),SystemJS.import("tools/ConsoleController").catch(S=>console.warn("ConsoleController load failed:",S));else if(this.gservCon.isOpen()){let e=S=>this.gameTurnMgr.setRate(S);this.gservCon.onRateChange.subscribe(e),this.disposables.add(()=>this.gservCon.onRateChange.unsubscribe(e)),this.gservCon.onGameStart.subscribe(E),this.disposables.add(()=>this.gservCon.onGameStart.unsubscribe(E)),this.gservCon.sendLoadedPercent(100)}}}}async connectToServerInstance(S,O,B){let N=!1,j=new be.Task(async S=>{await D.sleep(1e3),S.isCancelled()||(this.messageBoxApi.show(this.strings.get("TXT_CONNECTING")),N=!0)});j.start();try{var L,F,_;await this.gservCon.connect(S.gservUrl),await this.gservCon.cvers(this.engineVersion),await this.gservCon.login(O.user,O.pass),B.throwIfCancelled(),S.create?(L=this.gameOptsSerializer.serializeOptions(S.gameOpts),({gameId:F,timestamp:_}=S),await this.gservCon.createGame(F,_,L,this.engineVersion,this.engineModHash,S.createPrivateGame),console.log(`Created game instance with id ${S.gameId}.`),this.localPrefs.removeItem(J.StorageKey.LastConnection)):(await this.joinGame(S.gameId,5,B),console.log("Joined game instance with id "+S.gameId));var U=await this.gservCon.gameOpts();return this.gameOptsParser.parseOptions(U)}catch(S){throw this.gservCon.isOpen()||(N=!1),S}finally{j.cancel(),N&&this.messageBoxApi.destroy()}}async joinGame(S,O,B){if(O){let j;for(;O--;)try{return console.log(`Attempting to join game with id ${S}...`,O+" retries left"),B.throwIfCancelled(),void await this.gservCon.joinGame(S,this.engineVersion,this.engineModHash)}catch(S){if(!(S instanceof N.GservError&&S.code===N.GservError.Code.InstanceNonExistent))throw S;j=S,await D.sleep(3e3)}throw this.localPrefs.removeItem(J.StorageKey.LastConnection),j}await this.gservCon.joinGame(S,this.engineVersion,this.engineModHash)}async transferAndLoadMapFile(S,O,B,N){let j;if(S.create&&S.singlePlayer||!S.mapTransfer)j=await this.mapFileLoader.load(O,N);else{if(this.messageBoxApi.show(this.strings.get("GUI:MapTransfer")),S.create)j=await this.mapFileLoader.load(O,N),this.mapTransferService.getUrl()?await this.mapTransferService.putMap(j.getBytes(),S.gameId,N):this.gservCon.sendMap(j.readAsString());else{let L;if(L=this.mapTransferService.getUrl()?await this.mapTransferService.getMap(S.gameId,N):Ve.binaryStringToUint8Array(await this.gservCon.getMap()),j=Ge.VirtualFile.fromBytes(L,O),We.MapDigest.compute(j)!==B)throw new Be.DownloadError("Transferred map is corrupt");if(this.mapDir&&!await this.mapDir.containsEntry(O))try{await this.mapDir.writeFile(j),this.mapList.addFromMapFile(j)}catch(S){console.error("Map couldn't be saved",[S])}}this.messageBoxApi.destroy()}return j}loadUi(S,O,B,N,j){var L=B.isObserver?new U.SidebarModel(S):new ge.CombatantSidebarModel(B,S),D=new me.MessageList(S.rules.audioVisual.messageDuration,6,B),F=new Ze.ChatHistory;this.sidebarModel=L,this.disposables.add(()=>this.sidebarModel=void 0);let H=_.Engine.getUiIni(),V=new Ie.CommandBarButtonList;B.isObserver||V.fromIni(H.getOrCreateSection(this.isSinglePlayer?"AdvancedCommandBar":"MultiplayerAdvancedCommandBar")),this.config.discordUrl&&V.buttons.push(ke.CommandBarButtonType.BugReport),this.hudFactory=new le.HudFactory(N,this.uiScene,L,D,F,S.debugText,this.runtimeVars.debugText,B,S.getCombatants(),S.stalemateDetectTrait,S.countdownTimer,j,this.jsxRenderer,this.strings,V.buttons),this.disposables.add(()=>this.hudFactory=void 0);let W=this.hudFactory.create();this.hud=W;let z=this.minimap=new ce.Minimap(S,B,W.getTextColor(),S.rules.general.radar);W.setMinimap(z),this.disposables.add(z,()=>this.minimap=void 0),z.setPointerEvents(this.pointer.pointerEvents),L={width:W.sidebarWidth,height:W.actionBarHeight};let K=new se.WorldView(L,S,this.sound,this.renderer,this.runtimeVars,z,this.strings,this.generalOptions,this.vxlGeometryPool,this.buildingImageDataCache),$=K.init(B,this.viewport.value,O);return this.worldView=K,this.disposables.add(K,()=>this.worldView=void 0),$.worldScene.create3DObject(),{worldViewInitResult:$,messageList:D,chatHistory:F,minimap:z}}initLockstep(S,O,N,j,L){const F=this.runtimeVars.debugGameState.value;let _,U=new B.DataStream;F&&(_=S=>{U.byteLength<10485760&&U.writeString(S+"\n")});let W,z=new H.LockstepManager(S,this.gservCon,this.gameOptsParser,this.gameOptsSerializer,new V.ActionSerializer,N,j,()=>{this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close(),this.handleGameError("desync_error",this.strings.get("TS:DesyncDetected"),S,F?async()=>{let S,O;try{let B=JSON.stringify(z.debugGameStateHistory,void 0,2);console.log("Game state dump:",B),this.workerHostApi.queueTask(async O=>{S=await O.compressFile(B,"statedump.json")}),this.workerHostApi.queueTask(async S=>{O=await S.compressFile(new Uint8Array(U.buffer,0,U.byteLength),"lockstep.log")}),await this.workerHostApi.waitForTasks()}catch(S){console.error("Failed to export debug data",S)}finally{this.workerHostApi.dispose()}return{stateDump:S,debugLog:O}}:void 0)},this.actionLogger,this.lockstepLogger,_,L,F);return z.onLagStateChange.subscribe(O=>{this.lagState=O,W?.cancel(),W=void 0,O?(W=new be.Task(async O=>{await D.sleep(Ee.CON_INFO_THRESH_MILLIS,O),O.isCancelled()||this.menu?.openConnectionInfo(S.getCombatants(),this.gservCon,this.chatNetHandler)}),W.start().catch(S=>{if(!(S instanceof we.OperationCanceledError))throw S}),this.disposables.add(()=>W?.cancel())):this.menu?.getCurrentScreen()instanceof Pe.ConnectionInfoScreen&&this.menu.close()}),z}onViewportChange(){this.loadingScreenApi?.updateViewport(),this.rerenderHud(),this.virtualJoystick?.onViewportChange?.(this.viewport.value)}rerenderHud(){if(this.hud){this.uiScene.remove(this.hud),this.hud.destroy(),this.hudFactory.setSidebarModel(this.sidebarModel);let S=this.hudFactory.create();this.hud=S,S.setMinimap(this.minimap),this.playerUi&&(this.uiScene.add(S),this.menu?.handleHudChange(S),this.worldView.handleViewportChange(this.viewport.value),this.playerUi.handleHudChange(S),this.chatTypingHandler&&this.initHudChatTypingEvents(this.chatTypingHandler,this.chatNetHandler,S))}}onGameStart(S,O,B,N,j,L,D){try{window.dispatchEvent(new CustomEvent("ra2web:viewportClampMode",{detail:{mode:"dynamic"}}))}catch{}this.localPrefs.removeItem(J.StorageKey.LastConnection),this.loadingScreenApi?.dispose(),this.music?.play(xe.MusicType.Normal);var F=new ae.EvaSpecs(S.country?.side??he.SideType.GDI).readIni(_.Engine.getIni("eva.ini"));let U=new ne.Eva(F,this.sound,this.renderer);U.init(),this.disposables.add(U),this.initUi(S,O,D,N,j,this.hud,U,B),this.renderer.removeScene(this.uiScene),this.renderer.addScene(B.worldViewInitResult.worldScene),this.renderer.addScene(this.uiScene),this.pointer.setVisible(!0),O.onEnd.subscribe(()=>this.onGameEnd(O,S,U,L)),O.start(),this.isSinglePlayer||this.initNetStats(S),this.gameAnimationLoop=new $.GameAnimationLoop(S,this.renderer,this.sound,this.gameTurnMgr,{skipFrames:!this.isSinglePlayer,onError:this.config.devMode?void 0:(S,B)=>{var N;S instanceof Se.IrcConnection.SocketError||(N=S.message?.match(/memory|allocation/i)?this.strings.get("TS:GameCrashOom"):this.strings.get("TS:GameCrashed")+(B||O.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash")),this.handleGameError(S,N,O,void 0,B))}}),this.uiAnimationLoop.stop(),this.gameAnimationLoop.start()}initNetStats(S){let O,B=new Je.PingMonitor(this.gameTurnMgr,this.gservCon,this.avgPing);this.disposables.add(B);let r=N=>{O?.dispose(),B.setPingInterval(N?1e3:1e4),N&&(O=new oe.NetStats(this.gameTurnMgr,S,this.renderer,B),O.init(),this.disposables.add(O))};r(this.runtimeVars.fps.value),B.monitor(),this.runtimeVars.fps.onChange.subscribe(r),this.disposables.add(()=>{this.runtimeVars.fps.onChange.unsubscribe(r)})}initUi(S,O,B,N,j,L,D,F){let{worldViewInitResult:U,messageList:H,chatHistory:V,minimap:W}=F;var{worldScene:z,worldSound:K,superWeaponFxHandler:$,beaconFxHandler:q,renderableManager:Q}=U;let Z=new X.SoundHandler(O,K,D,this.sound,O.events,H,this.strings,S);if(Z.init(),this.disposables.add(Z),H.onNewMessage.subscribe(S=>{S.animate&&this.sound.play(fe.SoundKey.IncomingMessage,ye.ChannelType.Ui)}),Le.isIpad()){let e=S=>{this.sidebarModel.topTextLeftAlign=S};this.fullScreen.onChange.subscribe(e),this.disposables.add(()=>this.fullScreen.onChange.unsubscribe(e))}this.uiScene.add(L);let Y=this.menu=new re.GameMenu(this.gameMenuSubScreens,O,S,V,this.isSinglePlayer?void 0:this.gservCon,this.isSinglePlayer,this.isTournament);Y.init(L),this.initGameMenuEvents(Y,D,O,S,N,j),this.disposables.add(Y,()=>this.menu=void 0);var J=O.getUnitSelection(),se=this.runtimeVars.freeCamera,ne=this.runtimeVars.debugPaths,ae=this.runtimeVars.debugText,K=this.config.devMode;let oe;ae=new ee.WorldInteractionFactory(S,O,J,Q,this.uiScene,z,this.pointer,this.renderer,this.keyBinds,this.generalOptions,se,ne,K,document,W,this.strings,L.getTextColor(),ae,this.battleControlApi),this.isSinglePlayer||(le=new Ae.TauntPlayback(this.sound.audioSystem,_.Engine.getTaunts()),oe=new Oe.TauntHandler(this.gservCon,S,O,B,this.tauntsEnabled,le,this.mutedPlayers),oe.init(),this.disposables.add(oe));var le=this.config.discordUrl;S.isObserver?(this.playerUi=new ie.ObserverUi(O,void 0,this.sidebarModel,void 0,this.renderer,z,this.sound,ae,Y,this.runtimeVars,this.strings,Q,this.messageBoxApi,le)).onPlayerChange.subscribe(({player:S,sidebarModel:O})=>{this.sidebarModel=O,this.rerenderHud(),this.worldView?.changeLocalPlayer(S),this.minimap.changeLocalPlayer(S)}):this.playerUi=new te.CombatantUi(O,S,this.isSinglePlayer,N,j,this.sidebarModel,this.renderer,z,Z,H,this.sound,D,ae,Y,this.pointer,this.runtimeVars,this.speedCheat,this.strings,oe,Q,$,q,this.messageBoxApi,le);try{let O=new it.VirtualJoystick(this.uiScene,this.pointer.pointerEvents,this.battleControlApi,this.localPrefs,S.isObserver);O.onViewportChange(this.viewport.value),this.uiScene.add(O),this.virtualJoystick=O,window.__ra2webVirtualJoystick=O,this.runtimeVars.mobileJoystickEnabled.value=!!O.enabled;let c=S=>{O.setEnabled(!!S);try{this.localPrefs.setItem("ra2web.mobileJoystick.enabled",S?"1":"0")}catch{}};this.runtimeVars.mobileJoystickEnabled.onChange.subscribe(c),this.disposables.add(()=>this.runtimeVars.mobileJoystickEnabled.onChange.unsubscribe(c)),this.disposables.add(()=>{this.uiScene.remove(O),O.dispose(),this.virtualJoystick=void 0,window.__ra2webVirtualJoystick=void 0})}catch(S){console.warn("Failed to init VirtualJoystick",S)}if(this.playerUi.init(L),this.disposables.add(this.playerUi,()=>this.playerUi=void 0),!this.isSinglePlayer){q=this.wolService.getConnection(),le=new Map(O.getNonNeutralPlayers().map(S=>[S.name,S.color.asHexString()])),le=new Ye.ChatMessageFormat(this.strings,S.name,le);let N=new Te.ChatNetHandler(this.gservCon,q,H,V,le,S,O,B,this.mutedPlayers);N.init(),this.disposables.add(N);let j=this.playerUi.worldInteraction;le=new ve.ChatTypingHandler(j.keyboardHandler,j.arrowScrollHandler,H,V),j.chatTypingHandler=le,this.chatTypingHandler=le,this.chatNetHandler=N,this.disposables.add(()=>this.chatTypingHandler=this.chatNetHandler=void 0),this.initHudChatTypingEvents(le,N,L),Y.onSendMessage.subscribe(S=>{S.value.length&&N.submitMessage(S.value,S.recipient)});const n=S=>{O.getPlayerByName(S).isObserver&&H.addSystemMessage(this.strings.get("TXT_LEFT_GAME",S),"grey")};this.gservCon.onPlayerDisconnect.subscribe(n),this.disposables.add(()=>this.gservCon.onPlayerDisconnect.unsubscribe(n));const o=()=>{H.addSystemMessage(this.strings.get("TS:ChatRestricted"),"white")};this.gservCon.onPrivMsgNotAllowed.subscribe(o),this.disposables.add(()=>this.gservCon.onPrivMsgNotAllowed.unsubscribe(o))}}initHudChatTypingEvents(S,O,B){B.onMessageCancel.subscribe(()=>{S.endTyping()}),B.onMessageSubmit.subscribe(B=>{S.endTyping(),B.value.length&&O.submitMessage(B.value,B.recipient)})}initGameMenuEvents(S,O,B,N,F,_){S.onOpen.subscribe(()=>{this.pointer.unlock(),this.playerUi.worldInteraction.setEnabled(!1),this.virtualJoystick?.setMenuOpen(!0),this.isSinglePlayer&&(this.pausedAtSpeed=B.speed.value,B.desiredSpeed.value=Number.EPSILON,this.mixer.setMuted(ye.ChannelType.Effect,!0),this.mixer.setMuted(ye.ChannelType.Ambient,!0))}),S.onQuit.subscribe(async()=>{this.controller&&(this.isSinglePlayer&&this.pausedAtSpeed&&(this.mixer.setMuted(ye.ChannelType.Effect,!1),this.mixer.setMuted(ye.ChannelType.Ambient,!1)),N.isObserver||O.play("EVA_BattleControlTerminated"),this.pointer.lock(),this.pointer.setVisible(!1),this.playerUi.dispose(),N.isObserver||this.isSinglePlayer||this.lagState||(F.push(_.create(Me.ActionType.ResignGame)),await new Promise(S=>{this.gameTurnMgr.onActionsSent.subscribeOnce(()=>S())})),this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close(),this.gameTurnMgr.dispose(),this.replay&&(this.replay.finish(this.game.currentTick),this.saveReplay(this.replay)),this.isSinglePlayer||this.sendGameRes(B,{disconnect:!1,desync:!1,quit:!0,finished:!1}),N.isObserver||this.logGame(B,!1),await D.sleep(2e3),this.controller?.goToScreen(j.ScreenType.MainMenuRoot,{route:new qe.MainMenuRoute(L.ScreenType.Score,{game:B,localPlayer:N,singlePlayer:this.isSinglePlayer,tournament:this.isTournament,returnTo:this.returnTo??new qe.MainMenuRoute(L.ScreenType.Home)})}))}),S.onObserve.subscribe(()=>{this.pointer.lock(),this.playerUi.worldInteraction.setEnabled(!0),F.push(_.create(Me.ActionType.ObserveGame)),this.logGame(B,!1)}),S.onCancel.subscribe(()=>{this.pointer.lock(),this.playerUi.worldInteraction.setEnabled(!0),this.virtualJoystick?.setMenuOpen(!1),this.isSinglePlayer&&this.pausedAtSpeed&&(B.desiredSpeed.value=this.pausedAtSpeed,this.gameTurnMgr.doGameTurn(performance.now()),this.pausedAtSpeed=void 0,this.mixer.setMuted(ye.ChannelType.Effect,!1),this.mixer.setMuted(ye.ChannelType.Ambient,!1))})}async onGameEnd(S,O,B,N){var F=!O.defeated||S.alliances.getAllies(O).some(S=>!S.defeated);let[_]=this.jsxRenderer.render(Q.jsx(q.GameResultPopup,{type:F&&!O.isObserver?q.GameResultType.MpVictory:q.GameResultType.MpDefeat,viewport:this.viewport.value}));this.pointer.setVisible(!1),this.playerUi.dispose(),this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close(),this.uiScene.add(_),O.isObserver||B.play(F?"EVA_YouAreVictorious":"EVA_YouHaveLost",!0),N.finish(S.currentTick),this.saveReplay(N),this.isSinglePlayer||this.sendGameRes(S,{disconnect:!1,desync:!1,quit:!1,finished:!S.alliances.getHostilePlayers().length}),O.isObserver||this.logGame(S,F),await D.sleep(5e3),this.uiScene.remove(_),_.destroy(),this.controller?.goToScreen(j.ScreenType.MainMenuRoot,{route:new qe.MainMenuRoute(L.ScreenType.Score,{game:S,localPlayer:O,singlePlayer:this.isSinglePlayer,tournament:this.isTournament,returnTo:this.returnTo??new qe.MainMenuRoute(L.ScreenType.Home)})})}logGame(S,O){window.gtag?.("event","game_finish",{singlePlayer:Number(this.isSinglePlayer),numPlayers:S.gameOpts.humanPlayers.filter(S=>S.countryId!==$e.OBS_COUNTRY_ID).length+S.gameOpts.aiPlayers.filter(S=>!!S).length,won:Number(O),tournament:Number(this.isTournament),duration:S.currentTime})}async onLeave(){this.pointer.unlock(),this.gameAnimationLoop&&(this.gameAnimationLoop.destroy(),this.gameAnimationLoop=void 0,this.uiAnimationLoop.start()),this.hud&&(this.uiScene.remove(this.hud),this.hud.destroy(),this.hud=void 0),this.gameTurnMgr?.dispose(),this.gameTurnMgr=void 0,this.disposables.dispose(),this.isSinglePlayer||(this.wolService.setAutoReconnect(!1),this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close())}handleGservConError(S){if(!(S instanceof we.OperationCanceledError)){let O;if(S instanceof N.GservError&&S.code===N.GservError.Code.InstanceNonExistent)O=this.strings.get("WOL:InstanceNotFound");else if(S instanceof N.GservError&&S.code===N.GservError.Code.BadLogin)O=this.strings.get("TXT_BADPASS");else if(S instanceof N.GservError&&S.code===N.GservError.Code.AlreadyLoggedIn)O=this.strings.get("WOL:AlreadyLoggedIn");else if(S instanceof N.GservError&&S.code===N.GservError.Code.OutdatedClient)O=this.strings.get("TXT_YOURGAME_OUTDATED");else if(S instanceof N.GservError&&S.code===N.GservError.Code.TooManyLoginAttempts)O=this.strings.get("WOL:TooManyLoginAttempts");else if(S instanceof N.GservError&&S.code===N.GservError.Code.CreatedTooManyInstances)O=this.strings.get("WOL:CreatedTooManyInstances");else if(S instanceof N.GservError&&S.code===N.GservError.Code.InstanceNotAllowed)O=this.strings.get("WOL:InstanceNotAllowed");else if(S instanceof N.GservError&&S.code===N.GservError.Code.InstanceAlreadyStarted)O=this.strings.get("WOL:GameAlreadyStarted");else if(S instanceof N.GservError&&S.code===N.GservError.Code.InstanceVersMismatch)O=this.strings.get("TXT_MISMATCH");else{if(S instanceof Se.IrcConnection.SocketError)return;S instanceof Se.IrcConnection.ConnectError?O=this.strings.get("TS:ConnectFailed"):(O=this.strings.get("WOL:MatchBadParameters"),S instanceof N.GservError?this.sendDebugInfo(new Error("Gserv error "+S.code,{cause:S})):S instanceof Se.IrcConnection.NoReplyError||this.sendDebugInfo(new Error(`Failed to connect to game instance (${S.message??S.name})`,{cause:S})))}this.handleError(S,O)}}handleMapLoadError(S,O){if(!(S instanceof we.OperationCanceledError||S instanceof Se.IrcConnection.SocketError)){let B;B=S instanceof Be.DownloadError?404===S.statusCode?this.strings.get("TS:MapNotFound",O):this.strings.get("TS:MapDownloadFailed",O):("string"==typeof S?S:S.message)?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):S instanceof Se.IrcConnection.NoReplyError?this.strings.get("TS:MapDownloadFailed",O):this.strings.get("TXT_MAP_ERROR"),this.handleError(S,B)}}handleGameLoadError(S,O,B){if(!(S instanceof we.OperationCanceledError||S instanceof Se.IrcConnection.SocketError)){let N;if(S instanceof Be.DownloadError)N=this.strings.get("TS:AssetLoadError");else if(S instanceof De.IOError)N=this.strings.get("ts:storage_io_error");else{let j="string"==typeof S?S:S.message;if(j?.match(/memory|allocation/i))N=this.strings.get("TS:GameInitOom");else{N=this.strings.get("TS:GameInitError"),B.mapOfficial||(N+="\n\n"+this.strings.get("TS:CustomMapCrash"));let j=new ue.Replay;j.init(O.gameId,O.timestamp,B,this.engineVersion,this.engineModHash),j.debugInfo=S instanceof Error?S.stack:S,j.finish(0),this.sendDebugInfo(new Error(`Game init failed (${"string"==typeof S?S:S.message??S.name})`,{cause:S}),{gameId:O.gameId,replay:j,map:this.debugMapFile,official:B.mapOfficial})}}this.handleError(S,N)}}handleGameError(S,O,B,N,j){const L=this.replay;L&&(L.name+=" (crashdump)",L.debugInfo=S instanceof Error?S.stack:S,"desync_error"===S&&(L.debugInfo+="\nConstants: "+[Math.E,Math.LN10,Math.LN2,Math.LOG10E,Math.LOG2E,Math.PI,Math.SQRT1_2,Math.SQRT2].join(",")),L.finish(B.currentTick),this.saveReplay(L)),this.handleError(S,O,j),this.sendDebugInfo(S,{gameId:B.id,replay:L,map:this.debugMapFile,official:B.gameOpts.mapOfficial},N),"desync_error"===S&&this.sendGameRes(B,{disconnect:!1,desync:!0,quit:!1,finished:!1})}sendDebugInfo(S,{gameId:O,replay:B,map:N,official:j}={},L){this.sentry&&!S.message?.match(/out of memory|buffer allocation|WebGLRenderingContext/i)&&(async()=>{let D=L?await L():void 0;this.sentry.captureException(S,S=>{if(O&&S.setTag("gameId",O),S.setTag("nick",this.playerName),S.setTag("tournament",this.isTournament),D?.stateDump&&S.addAttachment({filename:"statedump.7z",data:D.stateDump}),D?.debugLog&&S.addAttachment({filename:"lockstep_log.7z",data:D.debugLog}),B)try{S.addAttachment({filename:B.name+ue.Replay.extension,data:B.serialize()})}catch(O){S.setExtra("replayError",O)}return N&&(S.addAttachment({filename:N.filename,data:N.getBytes()}),S.setTag("mapName",N.filename)),void 0!==j&&S.setTag("officialMap",j),S})})().catch(S=>console.error("Failed sending error to sentry",S))}handleError(S,O,B){this.gameTurnMgr&&this.gameTurnMgr.setErrorState(),this.pointer.unlock();let r=()=>{this.wolService.closeWolConnection(),!this.isSinglePlayer&&this.gservCon.isOpen()&&(this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close())};this.errorHandler.handle(S,O,B?void 0:()=>{r(),this.controller?.goToScreen(j.ScreenType.MainMenuRoot)}),B&&(r(),this.playerUi?.dispose())}saveReplay(S){(async()=>{try{if(window.r?.replayDisabled)return console.warn(`[GameScreen] Replay save skipped: ${window.r._replayDisableReason||"Console API used"}`),void this.toastApi?.push("Replay not saved (Console API was used)");await this.replayManager.saveReplay(S)}catch(O){O instanceof Ne.StorageQuotaError||O instanceof De.IOError||O instanceof je.FileNotFoundError||O instanceof Ue.ReplayStorageError||this.sendDebugInfo(O,{replay:S,gameId:this.game?.id}),console.error(O),this.toastApi.push(this.strings.get("GUI:SaveReplayError"))}})()}sendGameRes(S,O){(async()=>{if(this.wgameresService.getUrl())try{var B=(new Ke.GameRes).fromGame(S,this.isTournament,this.getGameResClientInfo(O)).toBinary();await this.wgameresService.sendGameResPacket(B)}catch(S){console.error(S)}})()}getGameResClientInfo(S){return{clientVers:this.engineVersion,avgFps:0,avgRtt:this.avgPing.calculate()??0,outOfSync:S.desync,gameSku:this.wolService.getConfig().getClientSku(),accountName:this.playerName,suddenDisconnect:S.disconnect,quit:S.quit,finished:S.finished,pingsRecv:0,pingsSent:0}}},S("GameScreen",et)}}}),System.register("gui/screen/game/HudFactory",["gui/screen/game/component/Hud","engine/Engine"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("HudFactory",class{constructor(S,O,B,N,j,L,D,F,_,U,H,V,W,z,K){this.sideType=S,this.uiScene=O,this.sidebarModel=B,this.messageList=N,this.chatHistory=j,this.debugText=L,this.debugTextEnabled=D,this.localPlayer=F,this.players=_,this.stalemateDetectTrait=U,this.countdownTimer=H,this.cameoFilenames=V,this.jsxRenderer=W,this.strings=z,this.commandBarButtons=K}setSidebarModel(S){this.sidebarModel=S}create(){return new B.Hud(this.sideType,this.uiScene.viewport,N.Engine.getImages(),N.Engine.getPalettes(),this.cameoFilenames,this.sidebarModel,this.messageList,this.chatHistory,this.debugText,this.debugTextEnabled,this.localPlayer,this.players,this.stalemateDetectTrait,this.countdownTimer,this.jsxRenderer,this.strings,this.commandBarButtons)}})}}}),System.register("gui/screen/game/MapFileLoader",["data/vfs/FileNotFoundError","data/vfs/VirtualFile"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("MapFileLoader",class{constructor(S,O){this.resourceLoader=S,this.vfs=O}async load(S,O){let j;if(this.vfs)try{j=await this.vfs.openFileWithRfs(S)}catch(S){S instanceof B.FileNotFoundError||console.error(S)}return j=j||N.VirtualFile.fromBytes(await this.resourceLoader.loadBinary(S,O),S),j}})}}}),System.register("gui/screen/game/MedianPing",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("MedianPing",class{constructor(S=100){this.reservoirSize=S,this.reservoir=[],this.totalSamples=0}pushSample(S){var O;this.totalSamples++,this.reservoir.length<this.reservoirSize?this.reservoir.push(S):(O=Math.floor(Math.random()*this.totalSamples))<this.reservoirSize&&(this.reservoir[O]=S)}calculate(){if(0!==this.reservoir.length){var S=[...this.reservoir].sort((S,O)=>S-O),O=Math.floor(S.length/2);return S.length%2==1?S[O]:(S[O-1]+S[O])/2}}})}}}),System.register("gui/screen/game/NetStats",["stats.js","util/disposable/CompositeDisposable"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("NetStats",class{constructor(S,O,B,j){this.lockstep=S,this.player=O,this.renderer=B,this.pingMonitor=j,this.disposables=new N.CompositeDisposable}init(){let S=this.renderer.getStats(),O=new B.default.Panel("ms RTT","#ff8","#221"),r=S=>{requestAnimationFrame(()=>O.update(S,250))};if(this.pingMonitor.onNewSample.subscribe(r),this.disposables.add(()=>{this.pingMonitor.onNewSample.unsubscribe(r);let S=this.renderer.getStats();S&&O.dom&&S.dom.removeChild(O.dom)}),S.addPanel(O),!this.player.isObserver){let O=new B.default.Panel("ms LAT","#f8f","#212"),N=new Map;this.lockstep.onActionsSent.subscribe(S=>{N.set(S,performance.now())}),this.lockstep.onActionsReceived.subscribe(S=>{if(N.has(S)){let B=performance.now()-N.get(S);N.delete(S),requestAnimationFrame(()=>O.update(B,1e3))}}),S.addPanel(O),this.disposables.add(()=>{let S=this.renderer.getStats();S&&O.dom&&S.dom.removeChild(O.dom)})}}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/ObserverUi",["react","util/disposable/CompositeDisposable","engine/sound/SoundKey","engine/sound/ChannelType","gui/screen/game/worldInteraction/keyboard/KeyCommandType","engine/util/MapPanningHelper","gui/screen/game/component/hud/viewmodel/SidebarModel","game/event/EventType","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","gui/screen/game/worldInteraction/keyboard/command/CenterViewCmd","gui/screen/game/worldInteraction/keyboard/command/FollowUnitCmd","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/screen/mainMenu/main/ReportBug","util/event","gui/screen/game/worldInteraction/keyboard/command/SetCameraLocationCmd","gui/screen/game/worldInteraction/keyboard/command/GoToCameraLocationCmd","gui/screen/game/worldInteraction/keyboard/command/CenterBaseCmd","gui/screen/game/worldInteraction/keyboard/command/SelectPlayerCmd","util/BoxedVar"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S}],execute:function(){S("ObserverUi",class{get onPlayerChange(){return this._onPlayerChange.asEvent()}constructor(S,O,B,j,L,D,F,_,U,V,W,z,K,q){this.game=S,this.player=O,this.sidebarModel=B,this.replay=j,this.renderer=L,this.worldScene=D,this.sound=F,this.worldInteractionFactory=_,this.gameMenu=U,this.runtimeVars=V,this.strings=W,this.renderableManager=z,this.messageBoxApi=K,this.discordUrl=q,this.disposables=new N.CompositeDisposable,this._onPlayerChange=new $.EventDispatcher,this.handleProductionQueueUpdate=S=>{this.sidebarModel instanceof H.CombatantSidebarModel&&this.sidebarModel.updateFromQueue(S)}}init(S){let O=this.worldInteractionFactory.create();this.worldInteraction=O,O.init(),this.disposables.add(O),this.initKeyboardCommands(O),this.initGameEventListeners(),this.initHudEventListeners(S)}handleHudChange(S){this.initHudEventListeners(S)}dispose(){this.disposables.dispose()}initGameEventListeners(){let e=S=>{this.sidebarModel instanceof H.CombatantSidebarModel&&S.isTechno()&&S.owner===this.player&&(S.isBuilding()||Number.isFinite(S.rules.buildLimit)||S.isVehicle()&&S.transportTrait||this.game.rules.general.padAircraft.includes(S.name))&&this.sidebarModel.updateAvailableObjects(this.game.art)},S=this.game.getWorld();this.sidebarModel instanceof H.CombatantSidebarModel&&this.sidebarModel.updateAvailableObjects(this.game.art),S.onObjectSpawned.subscribe(e),S.onObjectRemoved.subscribe(e),this.disposables.add(()=>S.onObjectSpawned.unsubscribe(e),()=>S.onObjectRemoved.unsubscribe(e)),this.disposables.add(this.game.events.subscribe(U.EventType.BuildingInfiltration,S=>{S.source.owner===this.player&&this.sidebarModel instanceof H.CombatantSidebarModel&&this.sidebarModel.updateAvailableObjects(this.game.art)})),this.disposables.add(this.game.events.subscribe(U.EventType.ObjectOwnerChange,S=>{S.target.isBuilding()&&(S.prevOwner===this.player||S.target.owner===this.player)&&this.sidebarModel instanceof H.CombatantSidebarModel&&this.sidebarModel.updateAvailableObjects(this.game.art)})),this.player?.production.onQueueUpdate.subscribe(this.handleProductionQueueUpdate),this.disposables.add(()=>this.player?.production.onQueueUpdate.unsubscribe(this.handleProductionQueueUpdate));let i=()=>{this.sidebarModel instanceof H.CombatantSidebarModel&&this.sidebarModel.updateSuperWeapons()};this.renderer.onFrame.subscribe(i),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(i)),this.disposables.add(this.game.events.subscribe(S=>{S.type===U.EventType.PowerChange&&S.target===this.player&&(this.sidebarModel.powerGenerated=S.power,this.sidebarModel.powerDrained=S.drain)}))}changePlayer(S){var O;S!==this.player&&(this.player?.production.onQueueUpdate.unsubscribe(this.handleProductionQueueUpdate),this.player=S,this.player?.production.onQueueUpdate.subscribe(this.handleProductionQueueUpdate),O=this.sidebarModel,this.sidebarModel=S?new H.CombatantSidebarModel(S,this.game):new _.SidebarModel(this.game,this.replay),this.sidebarModel instanceof H.CombatantSidebarModel&&this.sidebarModel.updateAvailableObjects(this.game.art),this.sidebarModel.selectTab(O.activeTab.id),this.sidebarModel.topTextLeftAlign=O.topTextLeftAlign,O=S?this.game.mapShroudTrait.getPlayerShroud(S):void 0,this.worldInteraction?.setShroud(O),this._onPlayerChange.dispatch(this,{player:S,sidebarModel:this.sidebarModel}))}initHudEventListeners(S){S.onSidebarTabClick.subscribe(()=>{this.sound.play(j.SoundKey.GUITabSound,L.ChannelType.Ui)});let O=this.game.rules.audioVisual.creditTicks;S.onCreditsTick.subscribe(S=>{this.sound.play("up"===S?O[0]:O[1],L.ChannelType.CreditTicks)}),S.onMessagesTick.subscribe(()=>{this.sound.play(j.SoundKey.MessageCharTyped,L.ChannelType.Ui)}),S.onScrollButtonClick.subscribe(S=>{this.sound.play(S?j.SoundKey.GenericClick:j.SoundKey.ScoldSound,L.ChannelType.Ui)}),S.onCommandBarButtonClick.subscribe(S=>{switch(S){case z.CommandBarButtonType.BugReport:if(!this.discordUrl)break;this.gameMenu.open(),this.messageBoxApi.show(B.createElement(K.ReportBug,{discordUrl:this.discordUrl,strings:this.strings}),this.strings.get("GUI:OK"))}})}initKeyboardCommands(S){let O=S.unitSelectionHandler;S.registerKeyCommand(D.KeyCommandType.Options,()=>this.gameMenu.open()).registerKeyCommand(D.KeyCommandType.Scoreboard,()=>this.gameMenu.openDiplo()).registerKeyCommand(D.KeyCommandType.VeterancyNav,()=>O.selectByVeterancy()).registerKeyCommand(D.KeyCommandType.HealthNav,()=>O.selectByHealth()).registerKeyCommand(D.KeyCommandType.ToggleFps,()=>this.runtimeVars.fps.value=!this.runtimeVars.fps.value);let B=new F.MapPanningHelper(this.game.map),N=new X.BoxedVar(this.player);[D.KeyCommandType.TeamSelect_1,D.KeyCommandType.TeamSelect_2,D.KeyCommandType.TeamSelect_3,D.KeyCommandType.TeamSelect_4,D.KeyCommandType.TeamSelect_5,D.KeyCommandType.TeamSelect_6,D.KeyCommandType.TeamSelect_7,D.KeyCommandType.TeamSelect_8,D.KeyCommandType.TeamSelect_9,D.KeyCommandType.TeamSelect_10].forEach((O,j)=>S.registerKeyCommand(O,new Y.SelectPlayerCmd(j,N,B,this.worldScene.cameraPan,this.game))),N.onChange.subscribe(S=>this.changePlayer(S)),new Map([[D.KeyCommandType.StructureTab,_.SidebarCategory.Structures],[D.KeyCommandType.DefenseTab,_.SidebarCategory.Armory],[D.KeyCommandType.InfantryTab,_.SidebarCategory.Infantry],[D.KeyCommandType.UnitTab,_.SidebarCategory.Vehicles]]).forEach((O,B)=>{S.registerKeyCommand(B,()=>{this.sidebarModel.selectTab(O)})});let j=new Map;[D.KeyCommandType.SetView1,D.KeyCommandType.SetView2,D.KeyCommandType.SetView3,D.KeyCommandType.SetView4].forEach((O,B)=>{S.registerKeyCommand(O,new q.SetCameraLocationCmd(this.worldScene.cameraPan,j,B-1))}),[D.KeyCommandType.View1,D.KeyCommandType.View2,D.KeyCommandType.View3,D.KeyCommandType.View4].forEach((O,B)=>{S.registerKeyCommand(O,new Q.GoToCameraLocationCmd(this.worldScene.cameraPan,j,B-1))}),S.registerKeyCommand(D.KeyCommandType.CenterBase,()=>{this.player&&new Z.CenterBaseCmd(this.player,this.game.rules,B,this.worldScene.cameraPan).execute()});var L=new V.CenterViewCmd(O,B,this.worldScene.cameraPan);S.registerKeyCommand(D.KeyCommandType.CenterView,L);let U=new W.FollowUnitCmd(O,this.renderableManager,S,B,this.worldScene.cameraPan,this.worldScene);U.init(),this.disposables.add(U),S.registerKeyCommand(D.KeyCommandType.Follow,U)}})}}}),System.register("gui/screen/game/PingMonitor",["network/IrcConnection","util/event"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("PingMonitor",class{get onNewSample(){return this._onNewSample.asEvent()}constructor(S,O,B,j=1e3,L=5){this.gameTurnMgr=S,this.gservCon=O,this.avgPing=B,this.pingIntervalMillis=j,this.pingTimeoutSeconds=L,this.isDisposed=!1,this._onNewSample=new N.EventDispatcher}monitor(){this.isDisposed=!1,this.pingTimeoutId??(this.pingTimeoutId=setTimeout(()=>this.updatePing(),this.pingIntervalMillis))}setPingInterval(S){S!==this.pingIntervalMillis&&(this.pingIntervalMillis=S,this.pingTimeoutId&&(clearTimeout(this.pingTimeoutId),this.updatePing()))}async updatePing(){if(this.pingTimeoutId=void 0,!this.gameTurnMgr.getErrorState()&&this.gservCon.isOpen()){let S;try{if(S=await this.gservCon.ping(this.pingTimeoutSeconds),this.isDisposed||this.pingTimeoutId)return}catch(O){O instanceof B.IrcConnection.NoReplyError||console.error(O),S=1e3*this.pingTimeoutSeconds}this.avgPing.pushSample(S),this._onNewSample.dispatch(this,S),this.pingTimeoutId=setTimeout(()=>this.updatePing(),this.pingIntervalMillis)}}dispose(){this.pingTimeoutId&&clearTimeout(this.pingTimeoutId),this.isDisposed=!0,this._onNewSample=new N.EventDispatcher}})}}}),System.register("gui/screen/game/PlayerUi",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("gui/screen/game/SoundHandler",["game/order/OrderType","engine/sound/SoundKey","engine/sound/ChannelType","util/disposable/CompositeDisposable","game/event/EventType","util/math","gui/screen/game/worldInteraction/UnitSelectionHandler","util/typeGuard","game/gameobject/Building","game/rules/TechnoRules","util/array","game/rules/general/RadarRules","game/player/production/ProductionQueue","engine/type/ObjectType","game/Coords","game/event/AllianceChangeEvent","game/gameobject/unit/VeteranLevel","game/order/OrderFeedbackType","game/gameopts/constants","game/gameobject/common/DeathType","game/WeaponType","game/gameobject/unit/ZoneType","game/type/SuperWeaponType","game/gameobject/infantry/StanceType","game/type/PowerupType","game/gameobject/unit/HealthLevel","game/trait/StalemateDetectTrait"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S}],execute:function(){oe=(new Map).set(ie.SuperWeaponType.MultiMissile,"EVA_NuclearSiloDetected").set(ie.SuperWeaponType.IronCurtain,"EVA_IronCurtainDetected").set(ie.SuperWeaponType.ChronoSphere,"EVA_ChronosphereDetected").set(ie.SuperWeaponType.LightningStorm,"EVA_WeatherDeviceReady"),le=(new Map).set(ie.SuperWeaponType.MultiMissile,"EVA_NuclearMissileReady").set(ie.SuperWeaponType.IronCurtain,"EVA_IronCurtainReady").set(ie.SuperWeaponType.ChronoSphere,"EVA_ChronosphereReady").set(ie.SuperWeaponType.LightningStorm,"EVA_LightningStormReady").set(ie.SuperWeaponType.ParaDrop,"EVA_ReinforcementsReady").set(ie.SuperWeaponType.AmerParaDrop,"EVA_ReinforcementsReady"),ce=(new Map).set(ie.SuperWeaponType.MultiMissile,"EVA_NuclearMissileLaunched").set(ie.SuperWeaponType.IronCurtain,"EVA_IronCurtainActivated").set(ie.SuperWeaponType.ChronoSphere,"EVA_ChronosphereActivated").set(ie.SuperWeaponType.LightningStorm,"EVA_LightningStormCreated"),he=(new Map).set(ie.SuperWeaponType.MultiMissile,N.SoundKey.DigSound),ue=(new Map).set(ie.SuperWeaponType.LightningStorm,"TXT_LIGHTNING_STORM_APPROACHING"),de=new Map([[se.PowerupType.Veteran,N.SoundKey.CratePromoteSound],[se.PowerupType.Money,N.SoundKey.CrateMoneySound],[se.PowerupType.Reveal,N.SoundKey.CrateRevealSound],[se.PowerupType.Firepower,N.SoundKey.CrateFireSound],[se.PowerupType.Armor,N.SoundKey.CrateArmourSound],[se.PowerupType.Speed,N.SoundKey.CrateSpeedSound],[se.PowerupType.Unit,N.SoundKey.CrateUnitSound]]),ge=new Map([[se.PowerupType.Armor,"EVA_UnitArmorUpgraded"],[se.PowerupType.Firepower,"EVA_UnitFirePowerUpgraded"],[se.PowerupType.Speed,"EVA_UnitSpeedUpgraded"]]),S("SoundHandler",class{constructor(S,O,B,N,j,D,F,_){this.game=S,this.worldSound=O,this.eva=B,this.sound=N,this.gameEvents=j,this.messageList=D,this.strings=F,this.player=_,this.lastAvailableObjectNames=[],this.lastQueueStatuses=new Map,this.triggerSoundHandles=new Map,this.disposables=new L.CompositeDisposable}init(){this.disposables.add(this.gameEvents.subscribe(S=>this.handleGameEvent(S)))}dispose(){this.disposables.dispose()}handleGameEvent(S){switch(S.type){case D.EventType.Cheer:this.sound.play(N.SoundKey.CheerSound,j.ChannelType.Effect);break;case D.EventType.UnitDeployUndeploy:var O="undeploy"===S.deployType,B=S.unit;(O=O?B.rules.undeploySound:B.rules.deploySound)&&this.worldSound.playEffect(O,B,B.owner);break;case D.EventType.ObjectTeleport:(O=S).isChronoshift&&(O.target.rules.chronoInSound&&this.worldSound.playEffect(O.target.rules.chronoInSound,O.target,O.target.owner),O.target.rules.chronoOutSound&&(B=q.Coords.tile3dToWorld(O.prevTile.rx+.5,O.prevTile.ry+.5,O.prevTile.z),this.worldSound.playEffect(O.target.rules.chronoOutSound,B,O.target.owner)));break;case D.EventType.WeaponFire:var L=S.weapon,_=S.gameObject;if(L.type===ee.WeaponType.DeathWeapon&&_.isCrashing)break;(U=L.rules.report).length&&(W=S.weapon.warhead.rules.electricAssault?.25:1,this.worldSound.playEffect(U[F.getRandomInt(0,U.length-1)],_.position.worldPosition,_.owner,W));break;case D.EventType.InflictDamage:{let O=S;if((L=O.target.healthTrait.health)&&O.target.isTechno())if(O.target.isBuilding()){if(O.target.wallTrait)break;var U=O.damageHitPoints/O.target.healthTrait.maxHitPoints*100,W=100*(_=this.game.rules.audioVisual).conditionRed;(L<=(_=100*_.conditionYellow)&&_<L+U||L<=W&&W<L+U)&&this.worldSound.playEffect(N.SoundKey.BuildingDamageSound,O.target,O.target.owner)}else{var K=O.target.rules.voiceFeedback;O.target.owner===this.player&&K&&.9<Math.random()&&this.worldSound.playEffect(K,O.target,O.target.owner)}}break;case D.EventType.RadarEvent:if((K=S).radarEventType===z.RadarEventType.BaseUnderAttack)K.target===this.player?(this.eva.play("EVA_OurBaseIsUnderAttack"),this.sound.play(N.SoundKey.BaseUnderAttackSound,j.ChannelType.Effect)):this.player&&this.game.alliances.areAllied(this.player,K.target)&&(this.eva.play("EVA_OurAllyIsUnderAttack"),this.sound.play(N.SoundKey.BaseUnderAttackSound,j.ChannelType.Effect));else if(K.radarEventType===z.RadarEventType.HarvesterUnderAttack)K.target===this.player&&this.eva.play("EVA_OreMinerUnderAttack");else if(K.radarEventType===z.RadarEventType.EnemyObjectSensed&&K.target===this.player){let S=this.game.map.getGroundObjectsOnTile(K.tile).find(S=>S.isBuilding()&&S.superWeaponTrait);S&&(void 0===(ie=S.superWeaponTrait?.getSuperWeapon(S)?.rules.type)||(ne=oe.get(ie))&&this.eva.play(ne))}break;case D.EventType.SuperWeaponReady:var $=S.target;$.owner!==this.player||(Y=void 0!==$.rules.type?le.get($.rules.type):void 0)&&this.eva.play(Y);break;case D.EventType.SuperWeaponActivate:var Y,ie=S.target,ne=S.owner;S.noSfxWarning||(($=ce.get(ie))&&this.eva.play($,!0),(Y=he.get(ie))&&($=S.atTile,this.worldSound.playEffect(Y,q.Coords.tile3dToWorld($.rx,$.ry,$.z),ne))),(ie=ue.get(ie))&&this.messageList.addSystemMessage(this.strings.get(ie),this.player??"grey");break;case D.EventType.LightningStormManifest:this.messageList.addSystemMessage(this.strings.get("TXT_LIGHTNING_STORM"),this.player??"grey");var pe=S.target;this.worldSound.playEffect(N.SoundKey.StormSound,q.Coords.tile3dToWorld(pe.rx,pe.ry,pe.z));break;case D.EventType.WarheadDetonate:S.isLightningStrike&&this.worldSound.playEffect(N.SoundKey.LightningSounds,S.position);break;case D.EventType.ObjectLiftOff:(pe=(me=S.gameObject).rules.auxSound1)&&this.worldSound.playEffect(pe,me,me.owner);break;case D.EventType.ObjectLand:var me;(me=(fe=S.gameObject).rules.auxSound2)&&this.worldSound.playEffect(me,fe,fe.owner);break;case D.EventType.ObjectCrashing:var fe,ye=S.gameObject;(fe=ye.rules.crashingSound)&&this.worldSound.playEffect(fe,ye.position.worldPosition,ye.owner),ye.owner!==this.player||(Te=ye.rules.voiceCrashing)&&this.worldSound.playEffect(Te,ye.position.worldPosition,ye.owner);break;case D.EventType.ObjectDestroy:{let O,B=S.target;if(B.isUnit()&&!B.isInfantry()&&B.isCrashing?O=B.zone===te.ZoneType.Water?this.game.rules.audioVisual.impactWaterSound:B.rules.impactLandSound??this.game.rules.audioVisual.impactLandSound:B.deathType===J.DeathType.Temporal||B.deathType===J.DeathType.None?O=void 0:B.deathType===J.DeathType.Crush?O=B.rules.crushSound:B.isVehicle()&&B.zone===te.ZoneType.Water&&B.isSinker?O=N.SoundKey.SinkingSound:B.isTechno()?(O=B.rules.dieSound,!O&&B.isBuilding()&&(O=N.SoundKey.BuildingDieSound)):B.isProjectile()&&(B.fromWeapon.warhead.rules.ivanBomb?O=N.SoundKey.BombAttachSound:B.fromWeapon.warhead.rules.mindControl&&(O=N.SoundKey.YuriMindControlSound)),O){let S;B.isTechno()?S=B.owner:B.isProjectile()&&(S=B.fromPlayer),this.worldSound.playEffect(O,B.position.worldPosition,S)}B.isUnit()&&!B.rules.spawned&&B.owner===this.player&&this.eva.play("EVA_UnitLost")}break;case D.EventType.ObjectSpawn:{let O=S.gameObject;O.isTechno()&&O.rules.createSound&&this.worldSound.playEffect(O.rules.createSound,O,O.owner),O.isInfantry()&&O.stance===re.StanceType.Paradrop&&this.worldSound.playEffect(N.SoundKey.ChuteSound,O,O.owner)}break;case D.EventType.ObjectUnspawn:{let O=S.gameObject;O.isBuilding()&&O.rules.spySat&&this.worldSound.playEffect(N.SoundKey.SpySatDeactivationSound,O,O.owner)}break;case D.EventType.ObjectMorph:{let O=S.to;O.isBuilding()&&this.worldSound.playEffect(N.SoundKey.BuildingDrop,O,O.owner);break}case D.EventType.ShipSubmergeChange:this.worldSound.playEffect(N.SoundKey.CloakSound,S.target,S.target.owner);break;case D.EventType.BridgeRepair:S.source===this.player&&this.eva.play("EVA_BridgeRepaired");break;case D.EventType.BuildStatusChange:var Te=S.target;S.status===H.BuildStatus.BuildDown&&(this.worldSound.playEffect(N.SoundKey.SellSound,Te.position.worldPosition,Te.owner),!Te.poweredTrait||(ye=Te.rules.notWorkingSound)&&this.worldSound.playEffect(ye,Te,Te.owner));break;case D.EventType.BuildingPlace:var ve=S.target;this.worldSound.playEffect(N.SoundKey.BuildingSlam,ve,ve.owner),ve.rules.spySat&&this.worldSound.playEffect(N.SoundKey.SpySatActivationSound,ve,ve.owner);break;case D.EventType.BuildingFailedPlace:this.player===S.player&&this.eva.play("EVA_CannotDeployHere");break;case D.EventType.ObjectSell:{let O=S.target;O.rules.wall&&this.worldSound.playEffect(N.SoundKey.SellSound,O.position.worldPosition,O.owner),this.player===O.owner&&this.eva.play(O.isBuilding()?"EVA_StructureSold":"EVA_UnitSold",!0);break}case D.EventType.BuildingRepairFull:ve=S.target;var be=S.source;be===this.player&&this.worldSound.playEffect(N.SoundKey.BuildingRepairedSound,ve,be);break;case D.EventType.BuildingCapture:var Se=S.target;Se.owner===this.player&&this.eva.play(Se.rules.needsEngineer?"EVA_TechBuildingCaptured":"EVA_BuildingCaptured");break;case D.EventType.BuildingInfiltration:if(be=S.source,Se=S.target,!this.player||this.player.isObserver||Se.owner===this.player||be.owner===this.player){let S;be=Se.owner===this.player,Se.rules.radar||be||this.eva.play("EVA_BuildingInfiltrated"),Se.rules.radar&&(S=be?"EVA_RadarSabotaged":"EVA_BuildingInfRadarSabotaged"),0<Se.rules.power&&(S=be?"EVA_PowerSabotaged":"EVA_EnemyBasePoweredDown"),Se.rules.storage&&(S=be?"EVA_CashStolen":"EVA_BuildingInfCashStolen"),(this.game.rules.ai.buildTech.includes(Se.name)||[V.FactoryType.InfantryType,V.FactoryType.UnitType].includes(Se.factoryTrait?.type))&&(S=be?"EVA_TechnologyStolen":"EVA_NewTechnologyAcquired"),S&&this.eva.play(S)}break;case D.EventType.BuildingGarrison:var we=S.target;this.worldSound.playEffect(N.SoundKey.BuildingGarrisonedSound,we,we.owner),we.owner===this.player&&this.eva.play("EVA_StructureGarrisoned");break;case D.EventType.BuildingEvacuate:S.player===this.player&&this.eva.play("EVA_StructureAbandoned");break;case D.EventType.BuildingRepairStart:case D.EventType.UnitRepairStart:S.target.owner===this.player&&this.eva.play("EVA_Repairing");break;case D.EventType.UnitRepairFinish:(we=S.target).owner===this.player&&(this.eva.play("EVA_UnitRepaired"),S.from.rules.hospital&&this.worldSound.playEffect(this.game.rules.crateRules.healCrateSound,we,we.owner));break;case D.EventType.PlayerDefeated:(xe=S.target)===this.player&&!this.player.isObserver||xe.resigned||(Ee=xe.isAi?X.getAiDisplayName(xe.aiDifficulty,this.strings):xe.name,this.eva.play(xe!==this.player?"EVA_PlayerDefeated":"EVA_YouHaveLost"),this.messageList.addSystemMessage(this.strings.get("TXT_PLAYER_DEFEATED",Ee),xe));break;case D.EventType.PlayerResigned:this.eva.play("EVA_PlayerResigned");var Ee=S.target,xe=Ee.isAi?X.getAiDisplayName(Ee.aiDifficulty,this.strings):Ee.name;this.messageList.addSystemMessage(Ee.isObserver?this.strings.get("TXT_PLAYER_DEFEATED",xe):this.strings.get("TXT_LEFT_GAME",xe),Ee),S.assetsRedistributed&&this.messageList.addSystemMessage(this.strings.get("TS:PlayerAssetsSplit",Ee.name),Ee);break;case D.EventType.PlayerDropped:var Oe=S.target;this.messageList.addSystemMessage(this.strings.get("TXT_CONNECTION_LOST",Oe.name),"grey"),S.assetsRedistributed&&this.messageList.addSystemMessage(this.strings.get("TS:PlayerAssetsSplit",Oe.name),Oe);break;case D.EventType.DeployNotAllowed:S.target.owner===this.player&&this.eva.play("EVA_CannotDeployHere");break;case D.EventType.PowerLow:S.target===this.player&&(this.eva.play("EVA_LowPower"),this.messageList.addSystemMessage(this.strings.get("TXT_LOW_POWER"),this.player));break;case D.EventType.RadarOnOff:S.target===this.player&&(Ae=S.radarEnabled,this.sound.play(Ae?N.SoundKey.RadarOn:N.SoundKey.RadarOff,j.ChannelType.Effect));break;case D.EventType.InsufficientFunds:S.target===this.player&&this.eva.play("EVA_InsufficientFunds");break;case D.EventType.RallyPointChange:S.target.owner===this.player&&this.eva.play("EVA_NewRallyPointEstablished");break;case D.EventType.PrimaryFactoryChange:S.target.owner===this.player&&this.eva.play("EVA_PrimaryBuildingSelected");break;case D.EventType.AllianceChange:{let O=S.alliance;Oe=S.changeType;var Ae=S.from;Oe===Q.AllianceEventType.Formed?(!this.player||this.player.isObserver||O.players.has(this.player)||this.game.alliances.areAllied(this.player,O.players.first)&&this.game.alliances.areAllied(this.player,O.players.second)?this.eva.play("EVA_AllianceFormed"):this.eva.play("EVA_EnemyAllianceFormed"),this.messageList.addSystemMessage(this.strings.get("TXT_HAS_ALLIED",O.players.second.name,O.players.first.name),"white")):Oe===Q.AllianceEventType.Requested?(this.player===O.players.first?this.eva.play("EVA_RequestingAlliance"):this.player===O.players.second&&this.eva.play("EVA_AllianceRequested"),this.messageList.addSystemMessage(this.strings.get("TXT_HAS_ALLIED",O.players.first.name,O.players.second.name),"lightgrey")):Oe===Q.AllianceEventType.Broken&&(this.eva.play("EVA_AllianceBroken"),this.messageList.addSystemMessage(this.strings.get("TXT_AT_WAR",Ae.name,(Ae===O.players.first?O.players.second:O.players.first).name),"white"))}break;case D.EventType.UnitPromote:S.target.owner===this.player&&(this.sound.play(S.target.veteranLevel===Z.VeteranLevel.Elite?N.SoundKey.UpgradeEliteSound:N.SoundKey.UpgradeVeteranSound,j.ChannelType.Effect),this.eva.play("EVA_UnitPromoted",!0));break;case D.EventType.EnterTransport:var Me=S.target,Re=Me.rules.enterTransportSound;Re&&this.worldSound.playEffect(Re,Me,Me.owner);break;case D.EventType.LeaveTransport:(Me=(Re=S.target).rules.leaveTransportSound)&&this.worldSound.playEffect(Me,Re,Re.owner);break;case D.EventType.UnitRecycle:var Pe=S.target,Ie=Pe.rules.dieSound;Ie&&this.worldSound.playEffect(Ie,Pe.position.worldPosition,Pe.owner);break;case D.EventType.CratePickup:{Ie=S;let O=de.get(Ie.target.type);O||Ie.target.type!==se.PowerupType.HealBase||(O=this.game.rules.crateRules.healCrateSound);var ke=ge.get(Ie.target.type);this.player&&!this.player.isObserver&&Ie.player!==this.player&&!this.game.alliances.areAllied(Ie.player,this.player)||(O&&(Pe=q.Coords.tile3dToWorld(Ie.tile.rx,Ie.tile.ry,Ie.tile.z),this.worldSound.playEffect(O,Pe,Ie.player)),ke&&this.eva.play(ke))}break;case D.EventType.StalemateDetect:var Be=Math.floor(ae.StalemateDetectTrait.graceMinutes);this.messageList.addSystemMessage(this.strings.get("TS:StalemateWarning",Be),"white",20),this.eva.play(1<Be?`EVA_${Be}MinutesRemaining`:"EVA_1MinuteRemaining");break;case D.EventType.TriggerSoundFx:if(ke=(Ne=S).tile){if(Be=this.worldSound.playEffect(Ne.soundId,q.Coords.tile3dToWorld(ke.rx,ke.ry,ke.z))){let S=this.triggerSoundHandles.get(ke);S||(S=[],this.triggerSoundHandles.set(ke,S)),S.push(Be)}}else this.sound.play(Ne.soundId,j.ChannelType.Effect);break;case D.EventType.TriggerStopSoundFx:var Ne,je=S.tile;if(Ne=this.triggerSoundHandles.get(je)){for(var Le of Ne)Le.isPlaying()&&Le.stop();this.triggerSoundHandles.delete(je)}break;case D.EventType.TriggerEva:this.eva.play(S.soundId);break;case D.EventType.TriggerText:je=S.label,this.messageList.addSystemMessage(this.strings.get(je),this.player??"grey")}}handleOrderPushed(S,O,L){var D=Date.now();if(!this.lastFeedbackTime||250<=D-this.lastFeedbackTime){let F;if(O===B.OrderType.Stop)F=N.SoundKey.StopSound;else if(O===B.OrderType.Guard)F=N.SoundKey.GuardSound;else if(O===B.OrderType.Scatter)F=N.SoundKey.ScatterSound;else switch(L){case Y.OrderFeedbackType.Attack:F=S.rules.voiceAttack;break;case Y.OrderFeedbackType.Move:F=S.rules.voiceMove;break;case Y.OrderFeedbackType.Capture:F=S.rules.voiceCapture||S.rules.voiceSpecialAttack;break;case Y.OrderFeedbackType.SpecialAttack:F=S.rules.voiceSpecialAttack;break;case Y.OrderFeedbackType.Enter:F=S.rules.voiceEnter??S.rules.voiceMove;case Y.OrderFeedbackType.None:}F&&(this.sound.play(F,j.ChannelType.Effect),this.lastFeedbackTime=D)}}handleSelectionChangeEvent({selection:S,queryType:O,veteranLevel:B,healthLevel:N}){if(!S.length||S[0].owner===this.player){var L,D=Date.now(),F=!this.lastFeedbackTime||250<=D-this.lastFeedbackTime;if(F&&(this.lastFeedbackTime=D),O){if(F){let O=S.map(S=>S.rules.voiceSelect).filter(U.isNotNullOrUndefined),B=new Map;O.forEach(S=>B.set(S,(B.get(S)??0)+1)),B.forEach((S,O)=>{var B=this.sound.getSoundSpec(O);if(B){var N=Math.min(B.limit,S);for(let S=0;S<N;S++)this.sound.play(O,j.ChannelType.Effect)}})}if(S.length||[_.QueryType.Veteran,_.QueryType.Health].includes(O)){let j;switch(O){case _.QueryType.OnScreen:j=this.strings.get("Msg:SelAcrossScreen");break;case _.QueryType.OnMap:j=this.strings.get("Msg:SelAcrossMap");break;case _.QueryType.Veteran:case _.QueryType.Health:{if(!S.length&&(O===_.QueryType.Veteran&&void 0===B||O===_.QueryType.Health&&void 0===N)){j=this.strings.get("Msg:NavEmpty");break}let D;if(O===_.QueryType.Veteran)switch(B){case Z.VeteranLevel.Elite:D=this.strings.get("Msg:Elite");break;case Z.VeteranLevel.Veteran:D=this.strings.get("Msg:Veteran");break;case Z.VeteranLevel.None:D=this.strings.get("Msg:LittleExperience")}else if(O===_.QueryType.Health)switch(N){case ne.HealthLevel.Green:D=this.strings.get("Msg:Healthy");break;case ne.HealthLevel.Yellow:D=this.strings.get("Msg:HeavilyDamaged");break;case ne.HealthLevel.Red:D=this.strings.get("Msg:Critical")}void 0!==D&&(D=D.toUpperCase(),j=S.length?(L=S.reduce((S,O)=>S+O.rules.cost,0),this.strings.get("Msg:UnitsWorth",S.length,D,L)):this.strings.get("Msg:NoUnitsSel",D));break}}j&&this.messageList.addUiFeedbackMessage(j)}else this.messageList.addUiFeedbackMessage(this.strings.get("Msg:NothingSelected"))}else!F||(F=S.find(S=>S.rules.voiceSelect)?.rules.voiceSelect)&&this.sound.play(F,j.ChannelType.Effect)}}handleAvailableObjectsUpdate(S){var O=S.map(S=>S.name);!W.equals(this.lastAvailableObjectNames,O)&&O.length>this.lastAvailableObjectNames.length&&(this.lastAvailableObjectNames=O,this.eva.play("EVA_NewConstructionOptions"))}handleProductionQueueUpdate(S){var O=this.lastQueueStatuses.get(S.type);if(void 0===O||S.status!==O)switch(this.lastQueueStatuses.set(S.type,S.status),S.status){case K.QueueStatus.Ready:S.getFirst().rules.type===$.ObjectType.Building?this.eva.play("EVA_ConstructionComplete"):this.eva.play("EVA_UnitReady");break;case K.QueueStatus.Active:S.getFirst().rules.type===$.ObjectType.Building?this.eva.play("EVA_Building"):O===K.QueueStatus.Idle&&this.eva.play("EVA_Training");break;case K.QueueStatus.OnHold:this.eva.play("EVA_OnHold")}}})}}}),System.register("gui/screen/game/TauntHandler",["util/disposable/CompositeDisposable"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("TauntHandler",class{constructor(S,O,N,j,L,D,F){this.gservCon=S,this.localPlayer=O,this.game=N,this.replayRecorder=j,this.tauntsEnabled=L,this.tauntPlayback=D,this.mutedPlayers=F,this.lastTauntTimeByPlayer=new Map,this.disposables=new B.CompositeDisposable,this.handleMessage=S=>{var O;!this.tauntsEnabled.value||(O=this.game.getPlayerByName(S.from)).country&&(this.mutedPlayers.has(O.name)||this.checkAndUpdateLastTauntTime(O.name)&&(this.recordReplayEvent(O,S.tauntNo),this.tauntPlayback.playTaunt(O,S.tauntNo).catch(S=>console.error(S))))}}init(){this.gservCon.onTaunt.subscribe(this.handleMessage),this.disposables.add(()=>this.gservCon.onTaunt.unsubscribe(this.handleMessage))}sendTaunt(S){this.checkAndUpdateLastTauntTime(this.localPlayer.name)&&this.gservCon.isOpen()&&(this.gservCon.sendTaunt(S),this.recordReplayEvent(this.localPlayer,S),this.tauntPlayback.playTaunt(this.localPlayer,S).catch(S=>console.error(S)))}checkAndUpdateLastTauntTime(S){var O=Date.now(),B=this.lastTauntTimeByPlayer.get(S);return!(B&&O-B<=5e3||(this.lastTauntTimeByPlayer.set(S,O),0))}recordReplayEvent(S,O){this.replayRecorder.recordTaunt(this.game.currentTick,S.name,O)}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/TauntPlayback",["engine/sound/ChannelType","util/string"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=(new Map).set("Americans","am").set("French","fr").set("Germans","ge").set("British","br").set("Russians","ru").set("Confederation","cu").set("Africans","li").set("Arabs","ir").set("Alliance","ko"),S("TauntPlayback",class{constructor(S,O){this.audioSystem=S,this.taunts=O}async playTaunt(S,O){var N=this.getTauntFileName(S.country.name,O),j=await this.taunts.get(N);j?this.audioSystem.playWavFile(j,B.ChannelType.Voice):console.warn(`Taunt file "${N}" not found.`)}getTauntFileName(S,O){return`tau${j.get(S)}${N.pad(O,"00")}.wav`}})}}}),System.register("gui/screen/game/WorldView",["util/disposable/CompositeDisposable","engine/renderable/WorldScene","engine/util/WorldViewportHelper","engine/util/MapTileIntersectHelper","engine/sound/WorldSound","engine/Engine","engine/util/MapPanningHelper","engine/IsoCoords","engine/ImageFinder","engine/renderable/entity/map/MapRenderable","engine/renderable/entity/RenderableFactory","engine/RenderableManager","engine/renderable/fx/handler/ChronoFxHandler","engine/Lighting","engine/gfx/lighting/LightingDirector","engine/renderable/fx/handler/WarheadDetonateFxHandler","engine/renderable/fx/handler/SuperWeaponFxHandler","engine/renderable/fx/handler/CrateFxHandler","engine/renderable/fx/handler/BeaconFxHandler","engine/renderable/builder/VxlBuilderFactory","engine/renderable/fx/handler/TriggerActionFxHandler","util/BoxedVar","engine/renderable/fx/handler/ParasiteSparkFxHandler"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S}],execute:function(){S("WorldView",class{constructor(S,O,N,j,L,D,F,_,U,H){this.hudGutterSize=S,this.game=O,this.sound=N,this.renderer=j,this.runtimeVars=L,this.minimap=D,this.strings=F,this.generalOptions=_,this.vxlGeometryPool=U,this.buildingImageDataCache=H,this.disposables=new B.CompositeDisposable,this.localPlayer=new te.BoxedVar(void 0)}init(S,O,B){this.localPlayer.value=S,this.disposables.add(()=>this.localPlayer.value=void 0);let N=this.game,F=N.map;var _=this.computeMapScreenBounds(F.mapBounds.getLocalSize()),U=this.computeWorldViewport(O,_);let H=this.initWorldView(S,U,N,F);this.worldScene=H,this.disposables.add(()=>this.worldScene=void 0);var V=new j.WorldViewportHelper(H),W=new L.MapTileIntersectHelper(F,H);_=N.getWorld(),U=S?this.game.mapShroudTrait.getPlayerShroud(S):void 0;let z=new D.WorldSound(this.sound,S,U,V,W,_,H,this.renderer);z.init(),this.worldSound=z,this.disposables.add(z,()=>this.worldSound=void 0);let K=new $.Lighting(N.mapLightingTrait);this.disposables.add(K),H.applyLighting(K);let Q=new q.LightingDirector(K,this.renderer,N.speed);Q.init(),this.disposables.add(Q),_=N.getUnitSelection();let{renderableManager:Z,mapRenderable:Y,superWeaponFxHandler:X,beaconFxHandler:J}=this.initRenderables(N,this.localPlayer,H,B,_,z,K,Q);this.mapRenderable=Y,this.disposables.add(()=>this.mapRenderable=void 0);let w=S=>{H.applyLighting(K),Z.updateLighting(),Y.updateLighting(S)};K.onChange.subscribe(w),this.disposables.add(()=>K.onChange.unsubscribe(w)),this.minimap.initWorld(H);let C=()=>{this.handleMapBoundsOrViewportChange(O),this.minimap.forceRerender()};return F.mapBounds.onLocalResize.subscribe(C),this.disposables.add(()=>F.mapBounds.onLocalResize.unsubscribe(C)),{worldScene:H,worldSound:z,renderableManager:Z,superWeaponFxHandler:X,beaconFxHandler:J}}changeLocalPlayer(S){var O=(this.localPlayer.value=S)?this.game.mapShroudTrait.getPlayerShroud(S):void 0;this.worldSound?.changeLocalPlayer(S,O),this.mapRenderable?.setShroud(O)}handleViewportChange(S){this.handleMapBoundsOrViewportChange(S)}handleMapBoundsOrViewportChange(S){var O;this.worldScene&&(O=this.computeMapScreenBounds(this.game.map.mapBounds.getLocalSize()),O=this.computeWorldViewport(S,O),this.worldScene.updateViewport(O),this.updatePanLimits(this.game.map,this.worldScene.cameraPan,O))}initWorldView(S,O,B,j){let L=N.WorldScene.factory(O,this.runtimeVars.freeCamera,this.generalOptions.graphics.shadows);this.disposables.add(L),this.updatePanLimits(j,L.cameraPan,O);var D=(!S||S.isObserver?B.getCombatants()[0]:S).startLocation;D=j.startingLocations[D];let F=new _.MapPanningHelper(j);return L.cameraPan.setPan(F.computeCameraPanFromTile(D.x,D.y)),D=j.mapBounds.getFullSize(),D=U.IsoCoords.screenTileToWorld(D.width/2,D.height/2),L.setLightFocusPoint(D.x,D.y),L}initRenderables(S,O,B,N,j,L,D,_){var U=F.Engine.getImages(),$=F.Engine.getVoxels(),q=F.Engine.getVoxelAnims(),te=new H.ImageFinder(U,N),re=F.Engine.getPalettes(),se=O.value?S.mapShroudTrait.getPlayerShroud(O.value):void 0;U=new V.MapRenderable(S.map,se,S.mapRadiationTrait,D,N,S.rules,S.art,te,B.camera,this.runtimeVars.debugWireframes,S.speed,L,!0),B.add(U),this.disposables.add(U),se=this.renderer.supportsInstancing(),se=new W.RenderableFactory(O,j,S.alliances,S.rules,S.art,U,te,re,$,q,N,B.camera,D,_,this.runtimeVars.debugWireframes,this.runtimeVars.debugText,S.speed,L,this.strings,this.generalOptions.flyerHelper,this.generalOptions.hiddenObjects,new J.VxlBuilderFactory(this.vxlGeometryPool,se,B.camera),this.buildingImageDataCache,!0,se);let ne=new z.RenderableManager(S.getWorld(),B,B.camera,se);ne.init(),this.disposables.add(ne);let ae=new K.ChronoFxHandler(S,ne);ae.init(),this.disposables.add(ae);let oe=new Q.WarheadDetonateFxHandler(S,ne);oe.init(),this.disposables.add(oe);let le=new Z.SuperWeaponFxHandler(S,ne,_);le.init(),this.disposables.add(le);let ce=new Y.CrateFxHandler(S,ne);ce.init(),this.disposables.add(ce);let he=new X.BeaconFxHandler(S,O,ne,this.renderer,L);he.init(),this.disposables.add(he);let ue=new ie.ParasiteSparkFxHandler(S,ne);ue.init(),this.disposables.add(ue);let de=new ee.TriggerActionFxHandler(S,ne);return de.init(),this.disposables.add(de),{renderableManager:ne,mapRenderable:U,superWeaponFxHandler:le,beaconFxHandler:he}}computeWorldViewport(S,O){let B=Math.max(0,S.width-this.hudGutterSize.width),N=Math.max(0,S.height-this.hudGutterSize.height);return{x:S.x,y:S.y,width:B,height:N}}updatePanLimits(S,O,B){let N=new _.MapPanningHelper(S);var j=this.computeMapScreenBounds(S.mapBounds.getLocalSize());O.setPanLimits(N.computeCameraPanLimits(B,j))}computeMapScreenBounds(S){var O=U.IsoCoords.screenTileToScreen(S.x,S.y),B=U.IsoCoords.screenTileToScreen(S.x+S.width,S.y+S.height-1);return{x:O.x,y:O.y,width:B.x-O.x,height:B.y-O.y}}dispose(){this.worldScene&&this.renderer.removeScene(this.worldScene),this.disposables.dispose()}})}}}),System.register("gui/screen/game/component/GameResultPopup",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){var O;(O=D||S("GameResultType",D={}))[O.SpVictory=0]="SpVictory",O[O.SpDefeat=1]="SpDefeat",O[O.MpVictory=2]="MpVictory",O[O.MpDefeat=3]="MpDefeat",F=class extends j.UiComponent{createUiObject({viewport:S}){let O=new N.UiObject(new THREE.Object3D,new L.HtmlContainer);return O.setPosition(S.x,S.y),O.getHtmlContainer().setSize(S.width,S.height),O}defineChildren(){let{viewport:S,type:O}=this.props;return B.jsx("sprite",{image:"grfxtxt.shp",palette:"grfxtxt.pal",ref:O=>{var B=O.getSize();O.setPosition((S.width-B.width)/2,(S.height-B.height)/2)},frame:O})}},S("GameResultPopup",F)}}}),System.register("gui/screen/game/component/Hud",["gui/jsx/jsx","data/ShpFile","game/SideType","gui/screen/game/component/hud/SidebarCard","gui/screen/game/component/hud/SidebarTabs","gui/screen/game/component/hud/SidebarIconButton","gui/screen/game/component/hud/SidebarMenu","gui/UiObject","gui/HtmlContainer","util/event","gui/screen/game/component/hud/GameMenuContentArea","gui/screen/game/component/hud/SidebarPower","gui/screen/game/component/hud/SidebarCredits","gui/screen/game/component/hud/SidebarRadar","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","gui/screen/game/component/hud/SidebarGameTime","gui/screen/game/component/hud/Messages","gui/screen/game/component/hud/SuperWeaponTimers","engine/renderable/builder/ShpAggregator","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/screen/game/component/hud/commandBar/commandButtonConfigs","util/typeGuard","gui/screen/game/component/hud/DebugText"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S}],execute:function(){re=class extends U.UiObject{constructor(S,O,B,N,j,L,D,F,_,U,W,z,K,$,q,Q,Z){super(new THREE.Object3D,new H.HtmlContainer),this.sideType=S,this.viewport=O,this.images=B,this.palettes=N,this.cameoFilenames=j,this.sidebarModel=L,this.messageList=D,this.chatHistory=F,this.debugTextValue=_,this.debugTextEnabled=U,this.localPlayer=W,this.players=z,this.stalemateDetectTrait=K,this.countdownTimer=$,this.jsxRenderer=q,this.strings=Q,this.commandBarButtonTypes=Z,this._onDiploButtonClick=new V.EventDispatcher,this._onOptButtonClick=new V.EventDispatcher,this._onRepairButtonClick=new V.EventDispatcher,this._onSellButtonClick=new V.EventDispatcher,this._onSidebarSlotClick=new V.EventDispatcher,this._onSidebarTabClick=new V.EventDispatcher,this._onCreditsTick=new V.EventDispatcher,this._onMessagesTick=new V.EventDispatcher,this._onMessageSubmit=new V.EventDispatcher,this._onMessageCancel=new V.EventDispatcher,this._onScrollButtonClick=new V.EventDispatcher,this._onCommandBarButtonClick=new V.EventDispatcher,this.commandBarButtons=[],this.init()}get onDiploButtonClick(){return this._onDiploButtonClick.asEvent()}get onOptButtonClick(){return this._onOptButtonClick.asEvent()}get onRepairButtonClick(){return this._onRepairButtonClick.asEvent()}get onSellButtonClick(){return this._onSellButtonClick.asEvent()}get onSidebarSlotClick(){return this._onSidebarSlotClick.asEvent()}get onSidebarTabClick(){return this._onSidebarTabClick.asEvent()}get onCreditsTick(){return this._onCreditsTick.asEvent()}get onMessagesTick(){return this._onMessagesTick.asEvent()}get onMessageSubmit(){return this._onMessageSubmit.asEvent()}get onMessageCancel(){return this._onMessageCancel.asEvent()}get onScrollButtonClick(){return this._onScrollButtonClick.asEvent()}get onCommandBarButtonClick(){return this._onCommandBarButtonClick.asEvent()}getImage(S){var O=this.images.get(S);if(!O)throw new Error(`Missing image "${S}"`);return O}init(){const S=this.palettes.get("sidebar.pal");if(!S)throw new Error('Missing palette "sidebar.pal"');var O=this.getImage("credits.shp"),N=this.getImage("top.shp"),_=this.getImage("radar.shp"),U=this.getImage("side1.shp");let H=this.getImage("side2.shp"),V=this.getImage("side2b.shp");var J=this.getImage("side3.shp"),re=this.getImage("addon.shp");let se=this.getImage("tab00.shp"),ne=this.getImage("tab01.shp"),ae=this.getImage("tab02.shp"),oe=this.getImage("tab03.shp"),le=this.getImage("diplobtn.shp"),ce=this.getImage("optbtn.shp"),he=this.getImage("repair.shp"),ue=this.getImage("sell.shp"),de=this.getImage("r-up.shp"),ge=this.getImage("r-dn.shp");var pe=[...new Set(this.commandBarButtonTypes.map(S=>ee.commandButtonConfigs.find(O=>O.type===S)?.icon))].map(S=>S?this.images.get(S):void 0).filter(te.isNotNullOrUndefined);let me=(new X.ShpAggregator).aggregate([le,ce,he,ue,se,ne,ae,oe,ge,de,...pe].map(S=>X.ShpAggregator.getShpFrameInfo(S,!1)),"agg_hud.shp");var fe=this.sidebarWidth=O.width,ye={x:this.viewport.width-fe,y:0,width:fe,height:this.viewport.height},Te=O.height+N.height,ve=Te+_.height;let be=Te+_.height+U.height;var Se=this.repeaterCount=Math.floor((ye.height-be-J.height)/H.height);let we=this.repeaterHeight=H.height;var Ee=Te+_.height+U.height+we*Se;let xe=this.getImage("lendcap.shp");var Oe=this.actionBarHeight=xe.height,Ae=this.viewport.y+this.viewport.height-Oe;let Me=this.getImage("bttnbkgd.shp");var Re=this.getImage("rendcap.shp"),Pe=ye.x-xe.width-Re.width,Ie=Math.floor(Pe/Me.width),ke=Pe%Me.width;let Be;ke&&(Be=Me.clip(ke,Me.height));let Ne={x:12,y:4};this.sideType===j.SideType.Nod&&(Ne={x:14,y:5});let je={x:20,y:8};this.sideType===j.SideType.Nod&&(je={x:34,y:7});let Le=1,De={x:26,y:-3};this.sideType===j.SideType.Nod&&(Le=0,De={x:20,y:-2});var Fe=this.palettes.get("cameo.pal");if(!Fe)throw new Error('Missing palette "cameo.pal"');pe=this.buildCameoFile(),fe=this.createCameoNameToIdMap(),Oe=this.sideType===j.SideType.GDI?{x:5,y:2}:{x:0,y:0},Pe=this.getImage("powerp.shp"),ke=this.getTextColor(),this.add(...this.jsxRenderer.render(B.jsx("fragment",null,B.jsx("container",{x:ye.x,y:ye.y},B.jsx("sprite-batch",null,B.jsx("sprite",{static:!0,image:O,palette:S}),B.jsx("container",{ref:S=>this.sidebarTop=S,zIndex:1},this.sidebarModel instanceof q.CombatantSidebarModel?B.jsx(K.SidebarCredits,{sidebarModel:this.sidebarModel,height:O.height,width:O.width,textColor:ke,onTick:S=>this._onCreditsTick.dispatch(this,S)}):B.jsx(Q.SidebarGameTime,{sidebarModel:this.sidebarModel,height:O.height,width:O.width,textColor:ke})),B.jsx("sprite",{static:!0,image:N,palette:S,y:O.height}),B.jsx("sprite",{static:!0,image:_,palette:S,y:Te}),B.jsx($.SidebarRadar,{image:_,palette:S,y:Te,sidebarModel:this.sidebarModel instanceof q.CombatantSidebarModel?this.sidebarModel:void 0,zIndex:1,ref:S=>this.sidebarRadar=S}),B.jsx("sprite",{static:!0,image:U,palette:S,y:ve}),new Array(Se).fill(0).map((O,N)=>B.jsx("sprite",{static:!0,image:V,palette:S,y:be+we*N})),B.jsx("sprite-batch",{ref:S=>this.sideCameoRepeaters=S},new Array(Se).fill(0).map((O,N)=>B.jsx("sprite",{static:!0,image:H,palette:S,y:be+we*N,zIndex:1}))),B.jsx(z.SidebarPower,{sidebarModel:this.sidebarModel,powerImg:Pe,palette:S,x:Oe.x,y:be,height:we*Se+Oe.y,ref:S=>this.sidebarPower=S,zIndex:2,strings:this.strings}),B.jsx(L.SidebarCard,{cameoImages:pe,cameoPalette:Fe,cameoNameToIdMap:fe,sidebarModel:this.sidebarModel,slots:2*Se,onSlotClick:S=>this._onSidebarSlotClick.dispatch(this,S),x:22,y:be+1,strings:this.strings,textColor:ke,ref:S=>this.sidebarCard=S,zIndex:2}),B.jsx("container",{ref:S=>this.sidebarMenuContainer=S,x:21,y:be+1,zIndex:2}),B.jsx("sprite",{static:!0,image:J,palette:S,y:Ee}),B.jsx("sprite",{static:!0,image:re,palette:S,y:Ee+J.height}))),B.jsx("container",{x:ye.x,y:ye.y,ref:S=>this.sidebarButtonsContainer=S,zIndex:2},B.jsx(F.SidebarIconButton,{image:me.file,palette:S,imageFrameOffset:me.imageIndexes.get(le),x:Ne.x,y:O.height+Ne.y,onClick:()=>this._onDiploButtonClick.dispatch(this,void 0),tooltip:this.strings.get("Tip:DiplomacyButton")}),B.jsx(F.SidebarIconButton,{image:me.file,palette:S,imageFrameOffset:me.imageIndexes.get(ce),x:Ne.x+le.width,y:O.height+Ne.y,onClick:()=>this._onOptButtonClick.dispatch(this,void 0),tooltip:this.strings.get("Tip:OptionsButton")}),B.jsx(F.SidebarIconButton,{image:me.file,palette:S,imageFrameOffset:me.imageIndexes.get(he),x:je.x,y:ve+je.y,toggle:this.sidebarModel.repairMode,ref:S=>this.repairButton=S,onClick:()=>this._onRepairButtonClick.dispatch(this,void 0),tooltip:this.strings.get("TXT_REPAIR_MODE")}),B.jsx(F.SidebarIconButton,{image:me.file,palette:S,imageFrameOffset:me.imageIndexes.get(ue),x:je.x+he.width,y:ve+je.y,toggle:this.sidebarModel.sellMode,ref:S=>this.sellButton=S,onClick:()=>this._onSellButtonClick.dispatch(this,void 0),tooltip:this.strings.get("TXT_SELL_MODE")}),B.jsx(D.SidebarTabs,{aggregatedImageData:me,images:[se,ne,ae,oe],palette:S,sidebarModel:this.sidebarModel,tabSpacing:Le,onTabClick:S=>{this.sidebarModel.selectTab(S.id),this._onSidebarTabClick.dispatch(this,S.id)},strings:this.strings,x:De.x,y:be-se.height+De.y}),B.jsx(F.SidebarIconButton,{image:me.file,palette:S,disabled:!0,imageFrameOffset:me.imageIndexes.get(ge),x:38,y:Ee+7,ref:S=>this.pgDnButton=S,onClick:()=>this._onScrollButtonClick.dispatch(this,this.sidebarCard.pageDown())}),B.jsx(F.SidebarIconButton,{image:me.file,palette:S,disabled:!0,imageFrameOffset:me.imageIndexes.get(de),x:38+ge.width,y:Ee+7,ref:S=>this.pgUpButton=S,onClick:()=>this._onScrollButtonClick.dispatch(this,this.sidebarCard.pageUp())})),B.jsx("container",{x:this.viewport.x,y:Ae},B.jsx("container",{x:xe.width,zIndex:1},this.renderCommandBarButtons(me,this.commandBarButtonTypes,Me.width,Ie)),B.jsx("sprite-batch",null,B.jsx("sprite",{static:!0,image:xe,palette:S}),new Array(Ie).fill(0).map((O,N)=>B.jsx("sprite",{static:!0,image:Me,palette:S,x:xe.width+Me.width*N})),Be?B.jsx("sprite",{static:!0,image:Be,palette:S,x:xe.width+Ie*Me.width}):[],B.jsx("sprite",{static:!0,image:Re,palette:S,x:ye.x-Re.width}))),B.jsx(Z.Messages,{messages:this.messageList,chatHistory:this.chatHistory,width:ye.x-10,height:200,ref:S=>this.messages=S,strings:this.strings,onMessageTick:()=>this._onMessagesTick.dispatch(this),onMessageSubmit:S=>this._onMessageSubmit.dispatch(this,S),onMessageCancel:()=>this._onMessageCancel.dispatch(this)}),B.jsx(ie.DebugText,{text:this.debugTextValue,visible:this.debugTextEnabled,color:new THREE.Color(16777215),x:20,y:200,width:Math.floor(ye.x/2),height:200,ref:S=>this.debugText=S}),B.jsx(Y.SuperWeaponTimers,{localPlayer:this.localPlayer,players:this.players,stalemateDetectTrait:this.stalemateDetectTrait,countdownTimer:this.countdownTimer,strings:this.strings,width:200,height:500,x:ye.x-200,y:Ae-500,ref:S=>this.superWeaponTimers=S}),B.jsx(W.GameMenuContentArea,{hidden:!0,screenSize:this.viewport,viewport:{x:this.viewport.x,y:this.viewport.y,width:ye.x,height:Ae},images:this.images,ref:S=>this.menuContentContainer=S.getUiObject(),innerRef:S=>this.menuContentContainerInner=S}))))}getTextColor(){return this.sideType===j.SideType.GDI?"rgb(165,211,255)":"yellow"}createSidebarMenu(S){return this.jsxRenderer.render(B.jsx(_.SidebarMenu,{buttonImg:this.getImage("sidebttn.shp"),buttonPal:"sidebar.pal",menuHeight:this.repeaterHeight*this.repeaterCount-2,buttons:S}))[0]}showSidebarMenu(S){this.destroySidebarMenu(),this.sidebarMenu=this.createSidebarMenu(S),this.sidebarMenuContainer.add(this.sidebarMenu),this.sideCameoRepeaters.setVisible(!1),this.remove(this.sidebarButtonsContainer),this.sidebarCard.hide(),this.sidebarPower.hide(),this.sidebarTop?.setVisible(!1),this.sidebarRadar?.hide(),this.commandBarButtons?.forEach(S=>S.getUiObject().setVisible(!1)),this.messages.getUiObject().setVisible(!1),this.debugText.getUiObject().setVisible(!1),this.superWeaponTimers.getUiObject().setVisible(!1)}hideSidebarMenu(){this.sideCameoRepeaters.setVisible(!0),this.destroySidebarMenu(),this.add(this.sidebarButtonsContainer),this.sidebarCard.show(),this.sidebarPower.show(),this.sidebarTop?.setVisible(!0),this.sidebarRadar?.show(),this.commandBarButtons?.forEach(S=>S.getUiObject().setVisible(!0)),this.messages.getUiObject().setVisible(!0),this.debugText.getUiObject().setVisible(!0),this.superWeaponTimers.getUiObject().setVisible(!0)}setMenuContentComponent(S){let O=this.menuContentContainerInner;this.menuContent&&(O.remove(this.menuContent),this.menuContent.destroy(),this.menuContent=void 0),S&&(O.add(S),this.menuContent=S)}setMinimap(S){this.sidebarRadar.setMinimap(S)}toggleMenuContentVisibility(S){this.menuContentContainer.setVisible(S)}renderCommandBarButtons(S,O,N,j){let L=0,D=[];for(let H of O.slice(0,j))if(H!==J.CommandBarButtonType.Separator){let O=ee.commandButtonConfigs.find(S=>S.type===H);var _,U;O?(_=this.images.get(O.icon))?(U=S.imageIndexes.get(_),D.push(B.jsx(F.SidebarIconButton,{image:void 0!==U?S.file:_,imageFrameOffset:U,palette:"sidebar.pal",tooltip:O.tooltip(this.strings),x:L,onClick:()=>{this._onCommandBarButtonClick.dispatch(this,H)},ref:S=>this.commandBarButtons.push(S)})),L+=_.width):console.warn(`Missing image for command bar button "${J.CommandBarButtonType[H]}"`):console.warn(`Unknown command bar button type "${H}"`)}else L+=N;return D}buildCameoFile(){let S=new N.ShpFile;return S.filename="agg_cameos.shp",this.cameoFilenames.forEach(O=>{let B=this.getImage(O);S.width||(S.width=B.width),S.height||(S.height=B.height),S.addImage(B.getImage(0))}),S}createCameoNameToIdMap(){let S=new Map;for(let O=0;O<this.cameoFilenames.length;++O)S.set(this.cameoFilenames[O],O);return S}destroySidebarMenu(){this.sidebarMenu&&(this.sidebarMenuContainer.remove(this.sidebarMenu),this.sidebarMenu.destroy())}update(S){super.update(S),this.repairButton?.setToggleState(this.sidebarModel.repairMode),this.sellButton?.setToggleState(this.sidebarModel.sellMode);var O=0<this.sidebarModel.activeTab.items.length-2*this.repeaterCount;this.pgUpButton?.setDisabled(!O),this.pgDnButton?.setDisabled(!O)}destroy(){this.sidebarButtonsContainer.destroy(),this.destroySidebarMenu(),this.sidebarRadar.setMinimap(void 0),super.destroy()}},S("Hud",re)}}}),System.register("gui/screen/game/component/Minimap",["gui/UiObject","engine/gfx/SpriteUtils","util/geometry","engine/renderable/entity/map/MinimapRenderer","engine/util/MapTileIntersectHelper","engine/IsoCoords","util/disposable/CompositeDisposable","util/event","game/event/EventType","gui/screen/game/component/MinimapPing","game/rules/general/RadarRules","engine/renderable/entity/map/MinimapModel","game/GameSpeed"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S}],execute:function(){$=new Map([[W.RadarEventType.EnemyObjectSensed,{high:16776960,low:8684544}],[W.RadarEventType.GenericNonCombat,{high:65535,low:33924}]]),q=class extends B.UiObject{get onClick(){return this._onClick.asEvent()}get onRightClick(){return this._onRightClick.asEvent()}get onMouseOver(){return this._onMouseOver.asEvent()}get onMouseMove(){return this._onMouseMove.asEvent()}get onMouseOut(){return this._onMouseOut.asEvent()}constructor(S,O,B,N){super(new THREE.Object3D),this.game=S,this.localPlayer=O,this.borderColor=B,this.radarRules=N,this.disposables=new _.CompositeDisposable,this.tilesForRecalc=new Set,this.tilesForRedraw=new Set,this.needsFullRedraw=!1,this.pings=[],this._onClick=new U.EventDispatcher,this._onRightClick=new U.EventDispatcher,this._onMouseOver=new U.EventDispatcher,this._onMouseMove=new U.EventDispatcher,this._onMouseOut=new U.EventDispatcher,this.handleTileUpdate=({tiles:S})=>{S.forEach(S=>{this.tilesForRecalc.add(S),this.tilesForRedraw.add(S)})},this.handleShroudUpdate=(S,O)=>{"incremental"===S.type?S.coords.forEach(S=>{var B;for(B of O.findTilesAtShroudCoords(S,this.map.tiles))this.tilesForRedraw.add(B)}):this.needsFullRedraw=!0},this.handleObjectChange=S=>{S.target.isSpawned&&this.map.tileOccupation.calculateTilesForGameObject(S.target.tile,S.target).forEach(S=>{this.tilesForRecalc.add(S),this.tilesForRedraw.add(S)})},this.handleRadarEvent=S=>{if(S.target===this.localPlayer){var O=this.minimapRenderer.dxyToCanvas(S.tile.dx,S.tile.dy),B=$.get(S.radarEventType);let N=new V.MinimapPing(this.radarRules,B?.high??16711935,B?.low??8650884);N.setPosition(this.wrapperObj.position.x+O.x,this.wrapperObj.position.y+O.y),this.pings.push({obj:N,startTime:void 0,duration:this.radarRules.getEventVisibilityDuration(S.radarEventType)})}},this.shroud=this.localPlayer&&S.mapShroudTrait.getPlayerShroud(this.localPlayer),this.minimapModel=new z.MinimapModel(S.map.tiles,S.map.tileOccupation,this.shroud,this.localPlayer,this.game.alliances,this.game.rules.general.paradrop)}get map(){return this.game.map}setFitSize(S){var O=this.fitSize;(this.fitSize=S).width===O?.width&&S.height===O?.height||this.forceRerender()}forceRerender(){var S,O,B,N;this.wrapperObj&&this.fitSize&&(this.get3DObject().remove(this.wrapperObj),this.destroyMesh(),({mesh:S,texture:O,wrapperObj:B,canvasLayoutSize:N}=this.renderMinimap(this.fitSize)),this.mesh=S,this.texture=O,this.wrapperObj=B,this.size=N,this.get3DObject().add(B),this.setupListeners(this.mesh),this.lastViewport=void 0)}initWorld(S){this.worldScene=S,this.mapTileIntersectHelper=new D.MapTileIntersectHelper(this.map,S)}changeLocalPlayer(S){this.localPlayer=S,this.shroud?.onChange.unsubscribe(this.handleShroudUpdate),this.shroud=this.localPlayer&&this.game.mapShroudTrait.getPlayerShroud(this.localPlayer),this.shroud?.onChange.subscribe(this.handleShroudUpdate),this.minimapModel=new z.MinimapModel(this.game.map.tiles,this.game.map.tileOccupation,this.shroud,this.localPlayer,this.game.alliances,this.game.rules.general.paradrop),this.forceRerender()}create3DObject(){if(super.create3DObject(),!this.mesh){var S;if(!(S=this.fitSize))throw new Error("setFitSize must be called before first render");var{mesh:O,texture:B,wrapperObj:N,canvasLayoutSize:S}=this.renderMinimap(S);this.mesh=O,this.texture=B,this.wrapperObj=N,this.size=S,this.get3DObject().add(N),this.setupListeners(this.mesh),this.map.tileOccupation.onChange.subscribe(this.handleTileUpdate),this.disposables.add(()=>this.map.tileOccupation.onChange.unsubscribe(this.handleTileUpdate)),this.shroud?.onChange.subscribe(this.handleShroudUpdate),this.disposables.add(this.game.events.subscribe(H.EventType.ObjectOwnerChange,this.handleObjectChange),this.game.events.subscribe(H.EventType.ObjectDisguiseChange,this.handleObjectChange),this.game.events.subscribe(H.EventType.ObjectDestroy,S=>{var O;!S.target.isBuilding()||(O=S.target).rules.leaveRubble&&this.map.tileOccupation.calculateTilesForGameObject(O.tile,O).forEach(S=>{this.tilesForRecalc.add(S),this.tilesForRedraw.add(S)})}),this.game.events.subscribe(H.EventType.RadarEvent,this.handleRadarEvent))}}renderMinimap(S){this.minimapRenderer=new L.MinimapRenderer(this.map,this.minimapModel,S,this.borderColor,2),this.minimapModel.computeAllColors();var O={width:.5*(j=this.minimapRenderer.renderFull()).width,height:.5*j.height},B=this.computeMinimapPosition(S,O),N=this.createTexture(j),j=this.createMesh(N,O.width,O.height);let D=new THREE.Object3D;return D.matrixAutoUpdate=!1,D.position.x=B.x,D.position.y=B.y,D.updateMatrix(),D.add(j),{mesh:j,texture:N,wrapperObj:D,canvasLayoutSize:O}}computeMinimapPosition(S,O){return{x:Math.floor((S.width-O.width)/2),y:Math.floor((S.height-O.height)/2)}}createTexture(S){let O=new THREE.Texture(S);return O.needsUpdate=!0,O.flipY=!1,O.minFilter=THREE.NearestFilter,O.magFilter=THREE.NearestFilter,O}createMesh(S,O,B){let j=N.SpriteUtils.createRectGeometry(O,B);N.SpriteUtils.addRectUvs(j,{x:0,y:0,width:O,height:B},{width:O,height:B}),j.translate(O/2,B/2,0);var L=new THREE.MeshBasicMaterial({map:S,side:THREE.DoubleSide});let D=new THREE.Mesh(j,L);return D.matrixAutoUpdate=!1,D.frustumCulled=!1,D}setupListeners(S){if(!this.pointerEvents)throw new Error("Must call setPointerEvents before rendering");this.disposables.add(this.pointerEvents.addEventListener(S,"click",S=>{var O=this.computeIntersectionTile(S.intersection.uv);O&&(2===S.button||S.isTouch?this._onRightClick.dispatch(this,O):0===S.button&&this._onClick.dispatch(this,O))}),this.pointerEvents.addEventListener(S,"mouseover",()=>this._onMouseOver.dispatch(this)),this.pointerEvents.addEventListener(S,"mousemove",S=>this.queuedHoverUv=S.intersection.uv),this.pointerEvents.addEventListener(S,"mouseout",()=>this._onMouseOut.dispatch(this)))}computeIntersectionTile(S){return this.canvasCoordsToTile(S.x*this.size.width,S.y*this.size.height)}canvasCoordsToTile(S,O){let B=this.minimapRenderer.canvasToDxy(S,O);return B.x=Math.round(B.x),B.y=Math.round(B.y),this.map.tiles.getByDisplayCoords(B.x,B.y+(B.x%2-B.y%2))}update(S){if(super.update(S),!this.lastCanvasUpdate||S-this.lastCanvasUpdate>=1e3/30){if(this.tilesForRecalc.size&&(this.minimapModel.updateColors(this.tilesForRecalc),this.tilesForRecalc.clear()),this.needsFullRedraw&&(this.minimapRenderer.renderFull(),this.texture.needsUpdate=!0,this.needsFullRedraw=!1,this.tilesForRedraw.clear()),this.tilesForRedraw.size&&(this.lastCanvasUpdate=S,this.minimapRenderer.renderIncremental(this.tilesForRedraw),this.texture.needsUpdate=!0,this.tilesForRedraw.clear()),this.worldScene){var O=this.worldScene.cameraPan.getPan(),B=this.worldScene.viewport,N=!this.lastViewport||!j.rectEquals(B,this.lastViewport);if(!j.pointEquals(O,this.lastPan)||N){this.lastPan=O,this.lastViewport=B;var L=this.mapTileIntersectHelper.getTileAtScreenPoint({x:B.x+B.width/2,y:B.y+B.height/2});if(!L)return void console.warn("Current pan intersects no map tile");B=F.IsoCoords.screenToScreenTile(B.width/2,B.height/2),L={x:L.dx-B.x,y:L.dy-B.y,width:2*B.x,height:2*B.y},this.viewportOutline&&!N||(B=this.minimapRenderer.dxyToCanvas(L.x,L.y),B={width:(N=this.minimapRenderer.dxyToCanvas(L.x+L.width,L.y+L.height)).x-B.x,height:N.y-B.y},this.viewportOutline?this.updateOutlineSize(this.viewportOutline,B.width,B.height):(this.viewportOutline=this.createViewportOutline(B.width,B.height),this.viewportOutline.matrixAutoUpdate=!1,this.wrapperObj.add(this.viewportOutline))),L=this.minimapRenderer.dxyToCanvas(L.x,L.y),this.viewportOutline.position.x=Math.max(2,Math.floor(L.x)),this.viewportOutline.position.y=Math.max(1,Math.floor(L.y)),this.viewportOutline.updateMatrix()}}this.queuedHoverUv&&((L=this.computeIntersectionTile(this.queuedHoverUv))&&this._onMouseMove.dispatch(this,L),this.queuedHoverUv=void 0),this.pings.forEach(O=>{O.startTime?S-O.startTime>O.duration/(K.GameSpeed.BASE_TICKS_PER_SECOND/1e3*this.game.speed.value)&&(this.remove(O.obj),O.obj.destroy(),this.pings.splice(this.pings.indexOf(O),1)):(O.startTime=S,this.add(O.obj))})}}createViewportOutline(S,O){let B=new THREE.Geometry;B.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,O,0),new THREE.Vector3(S,O,0),new THREE.Vector3(S,0,0),new THREE.Vector3(0,0,0));var N=new THREE.LineBasicMaterial({color:this.borderColor,transparent:!0,side:THREE.DoubleSide});return new THREE.Line(B,N)}updateOutlineSize(S,O,B){let N=S.geometry;N.vertices[1].set(0,B,0),N.vertices[2].set(O,B,0),N.vertices[3].set(O,0,0),N.verticesNeedUpdate=!0}destroy(){super.destroy(),this.destroyMesh(),this.shroud?.onChange.unsubscribe(this.handleShroudUpdate),this.disposables.dispose()}destroyMesh(){this.mesh&&(this.mesh.geometry.dispose(),this.mesh.material.dispose()),this.texture?.dispose(),this.destroyViewportOutline()}destroyViewportOutline(){this.viewportOutline&&(this.wrapperObj?.remove(this.viewportOutline),this.viewportOutline.geometry.dispose(),this.viewportOutline.material.dispose(),this.viewportOutline=void 0)}},S("Minimap",q)}}}),System.register("gui/screen/game/component/MinimapPing",["gui/UiObject"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.UiObject{constructor(S,O,B){super(),this.radarRules=S,this.colorLerpFactor=0,this.hiColor=new THREE.Color(O),this.lowColor=new THREE.Color(B),this.matHiColor=this.hiColor.clone(),this.matLowColor=this.lowColor.clone();var N=S.eventMinRadius;let j=this.createPingRectLine(N,N,this.matHiColor,this.matLowColor);j.name="minimap_ping",j.scale.x=15,j.scale.y=15,this.set3DObject(j),this.get3DObject().matrixAutoUpdate=!0}createPingRectLine(S,O,B,N){let j=new THREE.Geometry,L=[new THREE.Vector3(-.5*S,-.5*O,0),new THREE.Vector3(-.5*S,.5*O,0),new THREE.Vector3(.5*S,.5*O,0),new THREE.Vector3(.5*S,-.5*O,0)],D=[B,N];L.forEach((S,O)=>{j.vertices.push(S,L[(O+1)%L.length]),j.colors.push(D[O%2],D[(O+1)%2])});var F=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,side:THREE.DoubleSide});return new THREE.LineSegments(j,F)}get3DObject(){return super.get3DObject()}update(S){super.update(S),this.lastUpdate||(this.lastUpdate=S);var O=(S-this.lastUpdate)/1e3*60;this.lastUpdate=S;let B=this.get3DObject();var N=this.radarRules.eventSpeed/this.radarRules.eventMinRadius;B.scale.x=Math.max(1,B.scale.x-N*O),B.scale.y=Math.max(1,B.scale.y-N*O),B.rotation.z=B.rotation.z+this.radarRules.eventRotationSpeed*O,1===B.scale.x&&(B.rotation.z=Math.min(B.rotation.z,Math.floor(B.rotation.z/(Math.PI/2))*Math.PI/2)),this.colorLerpFactor=(this.colorLerpFactor+this.radarRules.eventColorSpeed*O)%2,O=Math.min(1,this.colorLerpFactor)-Math.max(0,this.colorLerpFactor-1),this.matHiColor.copy(this.hiColor).lerp(this.lowColor,O),this.matLowColor.copy(this.lowColor).lerp(this.hiColor,O),B.geometry.colorsNeedUpdate=!0}destroy(){super.destroy(),this.get3DObject().material.dispose(),this.get3DObject().geometry.dispose()}},S("MinimapPing",N)}}}),System.register("gui/screen/game/component/hud/DebugText",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class extends j.UiComponent{createUiObject(){let S=new N.UiObject(new THREE.Object3D,new L.HtmlContainer);S.setPosition(this.props.x||0,this.props.y||0);var O=this.props.width,B=this.props.height;let j=document.createElement("canvas");return j.width=O,j.height=B,this.ctx=j.getContext("2d",{alpha:!0}),this.texture=this.createTexture(j),this.mesh=this.createMesh(O,B),S}createTexture(S){let O=new THREE.Texture(S);return O.needsUpdate=!0,O.flipY=!1,O.minFilter=THREE.NearestFilter,O.magFilter=THREE.NearestFilter,O}createMesh(S,O){let B=D.SpriteUtils.createRectGeometry(S,O);D.SpriteUtils.addRectUvs(B,{x:0,y:0,width:S,height:O},{width:S,height:O}),B.translate(S/2,O/2,0);var N=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let j=new THREE.Mesh(B,N);return j.frustumCulled=!1,j}defineChildren(){return B.jsx("mesh",{zIndex:this.props.zIndex},this.mesh)}onFrame(S){if(!this.lastUpdate||S-this.lastUpdate>=1e3/30){this.lastUpdate=S;let B=this.props.text.value;var O;this.props.visible.value!==this.getUiObject().isVisible()&&this.getUiObject().setVisible(this.props.visible.value),this.lastText!==B&&(this.lastText=B,O=B.split(/\r?\n/g),this.drawLines(O))}}drawLines(S){this.ctx.clearRect(0,0,this.props.width,this.props.height);var O,B,N=Math.floor(110*this.props.width/600);let j=0;for(O of S)for(B of this.wrapText(O,N))j+=this.drawLine(B,this.props.color,j);this.texture.needsUpdate=!0}drawLine(S,O,B){var N=.5<.299*O.r+.587*O.g+.114*O.b?"black":"white";return F.CanvasUtils.drawText(this.ctx,S,0,B,{color:"#"+O.getHexString(),outlineColor:N,outlineWidth:2,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"400",paddingTop:6,height:20,paddingLeft:4,paddingRight:4}).height}wrapText(S,O){let B=[];for(;S.length>O;){let N=S.slice(0,O).search(/\s[^\s]*$/);-1!==N&&0!==N||(N=Math.min(S.length,O)),B.push(S.substr(0,N)),S=S.slice(N)}return S.length&&B.push(S),B}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},S("DebugText",_)}}}),System.register("gui/screen/game/component/hud/GameMenuContentArea",["gui/jsx/jsx","gui/jsx/UiComponent","gui/UiObject","gui/HtmlContainer","engine/gfx/SpriteUtils"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends N.UiComponent{createUiObject({viewport:S,hidden:O}){let B=new j.UiObject(new THREE.Object3D,new L.HtmlContainer);return B.setPosition(S.x,S.y),B.getHtmlContainer().setSize(S.width,S.height),B.setVisible(!O),B}defineChildren(){let{viewport:S,screenSize:O,images:N,innerRef:j}=this.props,L="lg";(O.width<1024||O.height<768)&&(L="md"),(O.width<800||O.height<600)&&(L="sm");var D=N.get(`bkgd${L}.shp`),F=D?(S.width-D.width)/2:0,_=D?(S.height-D.height)/2:0,U=(D||S).width,H=(D||S).height;return B.jsx("fragment",null,B.jsx("mesh",null,this.createMask(S)),B.jsx("container",{zIndex:1,x:F,y:_,width:U,height:H,ref:j},D&&B.jsx("sprite",{image:D,palette:"uibkgd.pal"})))}createMask(S){let O=D.SpriteUtils.createRectGeometry(S.width,S.height);O.translate(S.width/2,S.height/2,0);var B=new THREE.MeshBasicMaterial({color:0,opacity:.75,transparent:!0,side:THREE.DoubleSide});let N=new THREE.Mesh(O,B);return N.frustumCulled=!1,N}},S("GameMenuContentArea",F)}}}),System.register("gui/screen/game/component/hud/HudChat",["gui/component/ChatInput","network/gservConfig","react"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("HudChat",({messageList:S,chatHistory:O,strings:L,onSubmit:D,onCancel:F})=>{if(!S.isComposing)return null;var _=S.localPlayer?.color.asHexString()??"white";return j.default.createElement(B.ChatInput,{chatHistory:O,channels:[N.RECIPIENT_ALL,N.RECIPIENT_TEAM],className:"game-chat-input",forceColor:_,noCycleHint:!0,submitEmpty:!0,strings:L,onKeyDown:S=>{"Escape"===S.key&&S.preventDefault(),S.stopPropagation(),S.nativeEvent.stopImmediatePropagation()},onKeyUp:S=>{S.stopPropagation(),S.nativeEvent.stopImmediatePropagation()},onSubmit:S=>{S.value.length?D(S):F()},onCancel:F,onBlur:F})})}}}),System.register("gui/screen/game/component/hud/Messages",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils","gui/jsx/HtmlView","gui/screen/game/component/hud/HudChat","network/chat/ChatMessage","network/gservConfig"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){W=class extends j.UiComponent{createUiObject(){let S=new N.UiObject(new THREE.Object3D,new L.HtmlContainer);S.setPosition(this.props.x||0,this.props.y||0);var O=this.props.width,B=this.props.height;let j=document.createElement("canvas");return j.width=O,j.height=B,this.ctx=j.getContext("2d",{alpha:!0}),this.texture=this.createTexture(j),this.mesh=this.createMesh(O,B),S}createTexture(S){let O=new THREE.Texture(S);return O.needsUpdate=!0,O.flipY=!1,O.minFilter=THREE.NearestFilter,O.magFilter=THREE.NearestFilter,O}createMesh(S,O){let B=D.SpriteUtils.createRectGeometry(S,O);D.SpriteUtils.addRectUvs(B,{x:0,y:0,width:S,height:O},{width:S,height:O}),B.translate(S/2,O/2,0);var N=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let j=new THREE.Mesh(B,N);return j.frustumCulled=!1,j}defineChildren(){return B.jsx("fragment",null,B.jsx("container",{hidden:!0,ref:S=>this.inputContainer=S},B.jsx(_.HtmlView,{component:U.HudChat,props:{strings:this.props.strings,messageList:this.props.messages,chatHistory:this.props.chatHistory,onSubmit:this.props.onMessageSubmit,onCancel:this.props.onMessageCancel},innerRef:S=>this.inputComponent=S})),B.jsx("mesh",{zIndex:this.props.zIndex},this.mesh))}onFrame(S){var O,B,N,j,L;(!this.lastUpdate||S-this.lastUpdate>=1e3/30)&&(this.lastUpdate=S,this.props.messages.prune(),O=this.props.messages.getAll(),B=Date.now(),N=O[O.length-1]?.time,j=O.length,L=this.props.messages.isComposing,(this.lastComposing!==L||this.lastMessageTime!==N||j!==this.lastMessageCount||N&&B-N<=2e3)&&(this.lastMessageTime=N,this.lastMessageCount=j,this.lastComposing=L,this.drawMessages(L,O,B),this.inputContainer.setVisible(L),this.inputComponent.refresh()))}drawMessages(S,O,B){this.ctx.clearRect(0,0,this.props.width,this.props.height);var N=Math.floor(110*this.props.width/600);let j=!1;var L,D;let F=0;for(D of(S&&(F=20,(L=this.props.chatHistory.lastComposeTarget.value).type===H.ChatRecipientType.Channel&&L.name===V.RECIPIENT_ALL||(O=[{color:"gray",text:this.props.strings.get("TS:ChatCycleHint","Tab"),animate:!1,time:Date.now()},...O])),O)){var _,U=Math.min(1e3,10*D.text.length);U=D.animate?Math.min(1,(B-D.time)/U):1;let S=Math.round(U*D.text.length);for(_ of(U<1&&(j=!0),this.wrapText(D.text,N)))_.length>S?(_=_.slice(0,S),S=0):S-=_.length,F+=this.drawLine(_,D.color,F)}this.texture.needsUpdate=!0,j&&this.props.onMessageTick?.()}drawLine(S,O,B){return F.CanvasUtils.drawText(this.ctx,S,0,B,{color:O,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:13,fontWeight:"500",paddingTop:5,height:20,backgroundColor:"rgba(0, 0, 0, .75)",paddingLeft:4,paddingRight:4}).height}wrapText(S,O){let B=[];for(;S.length>O;){let N=S.slice(0,O).search(/\s[^\s]*$/);-1!==N&&0!==N||(N=Math.min(S.length,O)),B.push(S.substr(0,N)),S=S.slice(N)}return S.length&&B.push(S),B}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},S("Messages",W)}}}),System.register("gui/screen/game/component/hud/SidebarCard",["gui/jsx/jsx","gui/screen/game/component/hud/viewmodel/SidebarModel","gui/UiObject","gui/jsx/UiComponent","engine/gfx/OverlayUtils","gui/HtmlContainer","util/math","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","game/art/ObjectArt"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S}],execute:function(){var O;(O=V=V||{})[O.Ready=0]="Ready",O[O.OnHold=1]="OnHold",W=class e extends L.UiComponent{constructor(){super(...arguments),this.slotContainers=[],this.slotObjects=[],this.progressOverlays=[],this.visible=!0,this.labelObjects=[],this.quantityObjects=[],this.justCreated=!0,this.lastItemCount=0,this.pagingOffset=0,this.handleWheel=S=>{this.scrollToOffset(this.pagingOffset+(0<S.wheelDeltaY?2:-2))}}createUiObject(){let S=new j.UiObject(new THREE.Object3D,new F.HtmlContainer);S.setPosition(this.props.x||0,this.props.y||0),S.onFrame.subscribe(()=>this.handleFrame()),this.slotOutline=new j.UiObject(this.createSlotOutline()),this.slotOutline.setVisible(!1),this.slotOutline.setZIndex((this.props.zIndex??0)+1),S.add(this.slotOutline);let O=e.labelImageCache.get(this.props.textColor);O||(O=this.createLabelImages(this.props.textColor),e.labelImageCache.set(this.props.textColor,O)),this.labelImages=O;let B=e.quantityImageCache.get(this.props.textColor);return B||(B=this.createQuantityImages(this.props.textColor),e.quantityImageCache.set(this.props.textColor,B)),this.quantityImages=B,S}defineChildren(){let{slots:S,cameoImages:O,cameoPalette:N,sidebarModel:j,onSlotClick:L,zIndex:D}=this.props;var F=this.getCameoSize();let _=[];for(let U=0;U<S;U++){let S={x:(3+F.width)*(U%2),y:(2+F.height)*Math.floor(U/2)};_.push(B.jsx("container",{x:S.x,y:S.y,zIndex:D,ref:S=>this.slotContainers.push(S),onWheel:this.handleWheel,onClick:S=>{var O=j.activeTab.items[this.getItemIndexAtSlot(U)];O&&!O.disabled&&L?.(this.createSlotClickEvent(O,S))},onMouseEnter:()=>{var O=j.activeTab.items[this.getItemIndexAtSlot(U)];O&&(O.disabled||this.slotOutline.setPosition(S.x,S.y),this.slotOutline.setVisible(!O.disabled),this.hoverSlotIndex=U)},onMouseLeave:()=>{this.hoverSlotIndex===U&&(this.slotOutline.setVisible(!1),this.hoverSlotIndex=void 0)}},B.jsx("sprite",{image:"gclock2.shp",palette:"sidebar.pal",zIndex:1,frame:0,opacity:.5,transparent:!0,ref:S=>this.progressOverlays.push(S)}),B.jsx("sprite",{images:this.labelImages,zIndex:2,x:F.width/2,transparent:!0,ref:S=>this.labelObjects.push(S)}),B.jsx("sprite",{images:this.quantityImages,zIndex:2,x:F.width,alignX:1,alignY:-1,transparent:!0,ref:S=>this.quantityObjects.push(S)}),B.jsx("sprite",{image:O,palette:N,ref:S=>this.slotObjects.push(S)})))}return _}createSlotClickEvent(S,O){return{target:S.target,button:O.button,altKey:O.altKey,ctrlKey:O.ctrlKey,metaKey:O.metaKey,shiftKey:O.shiftKey,isTouch:O.isTouch,touchDuration:O.touchDuration}}handleFrame(){let{sidebarModel:S,slots:O}=this.props;var B;this.getUiObject().get3DObject().visible=this.visible,(this.justCreated||S.activeTab.needsUpdate||this.lastActiveTab!==S.activeTab)&&(this.justCreated=!1,B=S.activeTab.items.length,this.lastActiveTab===S.activeTab&&this.lastItemCount===B||(this.lastItemCount>B&&(this.pagingOffset=0),this.lastItemCount=B),this.lastActiveTab=S.activeTab,S.activeTab.needsUpdate=!1,this.updateSlots(S.activeTab.items,O))}updateSlots(S,O){for(let N=0;N<O;N++){var B=S[this.getItemIndexAtSlot(N)];let O=this.slotObjects[N],j=this.progressOverlays[N],L=this.labelObjects[N],D=this.quantityObjects[N];S.length-this.pagingOffset<=N?(O.get3DObject().visible=!1,j.get3DObject().visible=!1,L.get3DObject().visible=!1,D.get3DObject().visible=!1):(this.updateCameo(B,O),this.updateProgressOverlay(B,j),this.updateStatusText(B,L),this.updateQuantities(B,D),this.updateTooltip(B,this.slotContainers[N]))}}updateCameo(S,O){let B=this.props.cameoNameToIdMap;var N;let j=S.cameo+".shp";if(void 0===B.get(j)&&(j=H.ObjectArt.MISSING_CAMEO+".shp"),void 0===(N=B.get(j)))throw new Error(`Missing cameo placeholder image "${H.ObjectArt.MISSING_CAMEO}.shp"`);O.setFrame(N),O.get3DObject().visible=!0,O.setLightMult(S.disabled?.5:1)}updateProgressOverlay(S,O){let B=0;var j;[N.SidebarItemStatus.Started,N.SidebarItemStatus.OnHold].includes(S.status)&&(j=O.getFrameCount(),B=Math.max(1,Math.ceil(S.progress*(j-1)))%j),O.setFrame(B),O.get3DObject().visible=0<B}updateStatusText(S,O){O.get3DObject().visible=[N.SidebarItemStatus.Ready,N.SidebarItemStatus.OnHold].includes(S.status),S.status===N.SidebarItemStatus.Ready?(O.setFrame(V.Ready),O.setPosition(this.getCameoSize().width/2,O.getPosition().y),O.builder.setAlign(0,-1)):S.status===N.SidebarItemStatus.OnHold&&(O.setFrame(V.OnHold),O.setPosition(1<S.quantity?0:this.getCameoSize().width/2,O.getPosition().y),O.builder.setAlign(1<S.quantity?-1:0,-1))}updateQuantities(S,O){S.quantity>(S.status===N.SidebarItemStatus.InQueue?0:1)?(O.setFrame(S.quantity>e.MAX_QUANTITY?e.MAX_QUANTITY:S.quantity-1),O.setVisible(!0)):O.setVisible(!1)}updateTooltip(S,O){let B;if(S.target.type===N.SidebarItemTargetType.Techno){let O=S.target.rules.cost;this.props.sidebarModel instanceof U.CombatantSidebarModel&&(O=this.props.sidebarModel.computePurchaseCost(S.target.rules)),B=this.props.strings.get(S.target.rules.uiName)+"\n$"+O}else{if(S.target.type!==N.SidebarItemTargetType.Special)throw new Error(`Type "${S.target.type}" not implemented`);B=this.props.strings.get(S.target.rules.uiName)}O.setTooltip(B)}getItemIndexAtSlot(S){return S+this.pagingOffset}getCameoSize(){return{width:this.props.cameoImages.width,height:this.props.cameoImages.height}}createSlotOutline(){var S=(O=this.getCameoSize()).width,O=O.height;let B=new THREE.Geometry;return B.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,O,0),new THREE.Vector3(S,O,0),new THREE.Vector3(S,0,0),new THREE.Vector3(0,0,0)),S=new THREE.LineBasicMaterial({color:this.props.textColor,transparent:!0,side:THREE.DoubleSide}),new THREE.Line(B,S)}hide(){this.visible=!1}show(){this.visible=!0}scrollToOffset(S){var O=this.pagingOffset,B=Math.max(0,this.props.sidebarModel.activeTab.items.length-this.props.slots);return this.pagingOffset=_.clamp(S,0,B),this.pagingOffset%2&&this.pagingOffset++,this.updateSlots(this.props.sidebarModel.activeTab.items,this.props.slots),O!==this.pagingOffset}pageDown(){return this.scrollToOffset(this.pagingOffset+this.props.slots)}pageUp(){return this.scrollToOffset(this.pagingOffset-this.props.slots)}createLabelImages(S){return[{text:this.props.strings.get("TXT_READY"),type:V.Ready},{text:this.props.strings.get("TXT_HOLD"),type:V.OnHold}].map(O=>this.createTextBox(O.text,S))}createQuantityImages(S){let O={paddingRight:2},B=new Array(e.MAX_QUANTITY).fill(0).map((B,N)=>this.createTextBox(""+(N+1),S,O));return B.push(this.createTextBox("",S,O)),B}createTextBox(S,O,B){return D.OverlayUtils.createTextBox(S,{color:O,backgroundColor:"rgba(0, 0, 0, .5)",fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:5,paddingBottom:5,paddingLeft:2,paddingRight:4,...B})}},S("SidebarCard",W),W.MAX_QUANTITY=99,W.labelImageCache=new Map,W.quantityImageCache=new Map}}}),System.register("gui/screen/game/component/hud/SidebarCredits",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","gui/component/UiText"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends j.UiComponent{createUiObject(){return new N.UiObject(new THREE.Object3D,new L.HtmlContainer)}defineChildren(){var{textColor:S,width:O,height:N,zIndex:j}=this.props;return B.jsx(D.UiText,{ref:S=>this.text=S,value:"",textColor:S,width:O,height:N,zIndex:j})}onFrame(S){var{sidebarModel:{credits:O,topTextLeftAlign:B}}=this.props;this.targetCredits!==O&&(this.targetCredits=O,j=Math.abs(O-(this.renderedCredits??0)),N=THREE.Math.lerp(300,2e3,Math.min(1,j/5e3)),this.tickSpeed=j/N);var N,j=this.tickSpeed;(!this.lastUpdate||50<=S-this.lastUpdate)&&(N=this.lastUpdate?S-this.lastUpdate:0,this.lastUpdate=S,this.renderedCredits!==O&&(void 0===this.renderedCredits?this.renderedCredits=0:(O-=this.renderedCredits,N*=j,this.renderedCredits+=Math.abs(O)>=N?Math.sign(O)*N:O,this.props.onTick(1===Math.sign(O)?"up":"down")),this.text.setValue(""+Math.floor(this.renderedCredits))),B!==this.lastLeftAligned&&(B?(this.text.setTextAlign("left"),this.text.getUiObject().setPosition(15,0)):(this.text.setTextAlign("center"),this.text.getUiObject().setPosition(0,0)),this.lastLeftAligned=B))}},S("SidebarCredits",F)}}}),System.register("gui/screen/game/component/hud/SidebarGameTime",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","gui/component/UiText","util/format"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class extends j.UiComponent{createUiObject(){return new N.UiObject(new THREE.Object3D,new L.HtmlContainer)}defineChildren(){var{textColor:S,width:O,height:N,zIndex:j}=this.props;return B.jsx(D.UiText,{ref:S=>this.text=S,value:"",textColor:S,width:O,height:N,zIndex:j})}onFrame(S){var{sidebarModel:{currentGameTime:O,replayTime:B,topTextLeftAlign:N}}=this.props;(!this.lastUpdate||50<=S-this.lastUpdate)&&(this.lastUpdate=S,this.lastGameTime!==O&&(this.text.setValue(F.formatTimeDuration(O)+(B?" / "+F.formatTimeDuration(B):"")),this.lastGameTime=O),N!==this.lastLeftAligned&&(N?(this.text.setTextAlign("left"),this.text.getUiObject().setPosition(15,0)):(this.text.setTextAlign("center"),this.text.getUiObject().setPosition(0,0)),this.lastLeftAligned=N))}},S("SidebarGameTime",_)}}}),System.register("gui/screen/game/component/hud/SidebarIconButton",["gui/jsx/jsx","gui/jsx/UiComponent","gui/UiObject"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends N.UiComponent{constructor(){super(...arguments),this.toggle=this.props.toggle,this.disabled=!!this.props.disabled,this.handleMouseDown=()=>{this.disabled||(void 0===this.toggle&&this.sprite.setFrame((this.props.imageFrameOffset??0)+1),document.addEventListener("mouseup",this.onDocumentMouseUp),document.addEventListener("touchend",this.onDocumentMouseUp),document.addEventListener("touchcancel",this.onDocumentMouseUp))},this.onDocumentMouseUp=()=>{void 0===this.toggle&&this.sprite.setFrame((this.props.imageFrameOffset??0)+0),document.removeEventListener("mouseup",this.onDocumentMouseUp),document.removeEventListener("touchend",this.onDocumentMouseUp),document.removeEventListener("touchcancel",this.onDocumentMouseUp)}}createUiObject(){return new j.UiObject(new THREE.Object3D)}defineChildren(){let{image:S,imageFrameOffset:O,palette:N,x:j,y:L,onClick:D,tooltip:F}=this.props;return B.jsx("sprite",{image:S,palette:N,x:j,y:L,frame:this.getBaseFrameNo(O??0),onClick:S=>0===S.button&&!this.disabled&&D?.(),onMouseDown:this.handleMouseDown,tooltip:F,ref:S=>this.sprite=S})}getBaseFrameNo(S){return S+(this.disabled?2:this.toggle?1:0)}setToggleState(S){this.toggle!==S&&(this.toggle=S,this.sprite.setFrame(this.getBaseFrameNo(this.props.imageFrameOffset??0)))}setDisabled(S){S!==this.disabled&&(this.disabled=S,this.sprite.setFrame(this.getBaseFrameNo(this.props.imageFrameOffset??0)))}onDispose(){document.removeEventListener("mouseup",this.onDocumentMouseUp),document.removeEventListener("touchend",this.onDocumentMouseUp),document.removeEventListener("touchcancel",this.onDocumentMouseUp)}},S("SidebarIconButton",L)}}}),System.register("gui/screen/game/component/hud/SidebarMenu",["gui/jsx/jsx","gui/component/MenuButton","gui/UiObject","gui/HtmlContainer","gui/jsx/HtmlView","gui/jsx/UiComponent"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class extends F.UiComponent{createUiObject(){return new j.UiObject(new THREE.Object3D,new L.HtmlContainer)}defineChildren(){return this.props.buttons.map((S,O)=>this.createButton(S,O))}createButton(S,O){var j=this.props.buttonImg;let L={x:0,y:O*j.height};S.isBottom&&(L.y=this.props.menuHeight-j.height);var F={x:L.x,y:L.y,width:j.width,height:j.height};let _=B.createRef();return B.jsx("fragment",null,B.jsx("sprite",{image:j,palette:this.props.buttonPal,x:L.x,y:L.y,ref:_}),B.jsx(D.HtmlView,{component:N.MenuButton,props:{buttonConfig:{label:S.label,disabled:!!S.disabled},box:{x:F.x,y:F.y,width:F.width,height:F.height},onMouseDown:S=>{_.current.setFrame(1);let t=()=>{_.current.setFrame(0),document.removeEventListener("mouseup",t)};document.addEventListener("mouseup",t)},onClick:O=>{S.onClick&&S.onClick()}}}))}},S("SidebarMenu",_)}}}),System.register("gui/screen/game/component/hud/SidebarPower",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","data/Bitmap","engine/gfx/SpriteUtils","util/math","engine/gfx/TextureUtils","engine/renderable/entity/HighlightAnimRunner","util/BoxedVar","util/array","engine/gfx/material/PaletteBasicMaterial"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S}],execute:function(){var O;K=(S,O)=>S.green===O.green&&S.yellow===O.yellow&&S.red===O.red,(O=$=$||{})[O.None=0]="None",O[O.Green=1]="Green",O[O.Yellow=2]="Yellow",O[O.Red=3]="Red",O[O.Highlight=4]="Highlight",q=class extends j.UiComponent{constructor(){super(...arguments),this.visible=!0,this.pipHighlightAnimRunner=new H.HighlightAnimRunner(new V.BoxedVar(1),1,2,15)}createUiObject(){let S=new N.UiObject(new THREE.Object3D,new L.HtmlContainer);S.setPosition(this.props.x||0,this.props.y||0),this.pips=this.createPips(this.props.powerImg);var O=this.props.powerImg.width,B=this.props.height;return this.textureBitmap=new D.IndexedBitmap(O,B),this.texture=this.createDataTexture(this.textureBitmap.data,O,B),this.mesh=this.createMesh(O,B),S}createPips(S){let O=[];for(let N=0;N<S.numImages;N++){var B=S.getImage(N);O.push(new D.IndexedBitmap(B.width,B.height,B.imageData))}return O}createDataTexture(S,O,B){let N=new THREE.DataTexture(S,O,B,THREE.AlphaFormat);return N.needsUpdate=!0,N.minFilter=THREE.NearestFilter,N.magFilter=THREE.NearestFilter,N}createMesh(S,O){let B=F.SpriteUtils.createRectGeometry(S,O);F.SpriteUtils.addRectUvs(B,{x:0,y:0,width:S,height:O},{width:S,height:O}),B.translate(S/2,O/2,0);var N=new z.PaletteBasicMaterial({map:this.texture,palette:U.TextureUtils.textureFromPalette(this.props.palette),side:THREE.DoubleSide});let j=new THREE.Mesh(B,N);return j.frustumCulled=!1,j}defineChildren(){return B.jsx("mesh",{zIndex:this.props.zIndex,ref:S=>this.meshEvtTarget=S,onClick:()=>{}},this.mesh)}onFrame(S){this.getUiObject().get3DObject().visible=this.visible;var O=(B=this.props.sidebarModel).powerDrained,B=B.powerGenerated;let N=!1;this.lastPowerDrained===O&&this.lastPowerGenerated===B||(this.lastPowerDrained=O,this.lastPowerGenerated=B,this.meshEvtTarget.setTooltip(this.props.strings.get("TXT_POWER_DRAIN",B,O)),j=(U=Math.max(B,O))?Math.min(1,O/U):1,F=U?Math.min(1,_.clamp(B-O,0,100)/U):0,D=this.pips[0].height+1,L=U?this.computeHeightFromPowerLevel(Math.max(100,U)):1,this.targetPipCount={green:Math.floor((1-j-F)*L/D),yellow:Math.floor(F*L/D),red:U?Math.floor(j*L/D):1},this.pipHighlightAnimRunner.animation.stop(),N=!0);var j,L,D,F=this.targetPipCount,U=this.pipCount&&K(this.pipCount,F);this.lastPipUpdate&&!(50<=S-this.lastPipUpdate)||U||(this.lastPipUpdate=S,this.pipCount?(j=Math.sign(F.red-this.pipCount.red),L=Math.sign(F.yellow-this.pipCount.yellow),D=Math.sign(F.green-this.pipCount.green),j?0<j&&(this.pipCount.yellow>j?this.pipCount.yellow=Math.max(0,this.pipCount.yellow-j):this.pipCount.green=Math.max(0,this.pipCount.green-j)):(L?0<L&&(this.pipCount.green=Math.max(0,this.pipCount.green-L)):this.pipCount.green+=D,this.pipCount.yellow+=L),this.pipCount.red+=j):this.pipCount={red:1,yellow:0,green:0},this.updateTexture(this.pipCount,!0),K(this.pipCount,F)&&this.pipHighlightAnimRunner.animate(10)),U&&(N&&this.pipHighlightAnimRunner.animate(10),this.pipHighlightAnimRunner.shouldUpdate()&&(F=!!this.pipHighlightAnimRunner.getValue(),this.pipHighlightAnimRunner.tick(S),(U=!!this.pipHighlightAnimRunner.getValue())!=F&&this.updateTexture(this.pipCount,U)))}computeHeightFromPowerLevel(S){return _.clamp((Math.log10((S/100+5)/5e7)/(S/100+3)+2)/2,0,1)*this.props.height}updateTexture(S,O){var B,N=this.pips[0].height,j=this.props.height,L=N+1;let D=[[[$.None,Math.floor(j/N),N]],[[$.Red,S.red,L],[$.Yellow,S.yellow,L],[$.Green,S.green,L]]];if(O){let S=W.findReverse(D[1],([,S])=>0<S);S&&S[1]--,D[1].push([$.Highlight,1,L])}for(B of D){let S=j-N;for(var[F,_,U]of B){var H=this.pips[F];for(let O=0;O<_;O++)this.textureBitmap.drawIndexedImage(H,0,S),S-=U}}this.texture.needsUpdate=!0}hide(){this.visible=!1}show(){this.visible=!0}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},S("SidebarPower",q)}}}),System.register("gui/screen/game/component/hud/SidebarRadar",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","gui/screen/game/component/hud/SidebarRadarAnimRunner"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends j.UiComponent{constructor(){super(...arguments),this.visible=!0}createUiObject(){let S=new N.UiObject(new THREE.Object3D,new L.HtmlContainer);return S.setPosition(this.props.x||0,this.props.y||0),S}defineChildren(){return B.jsx("fragment",null,B.jsx("sprite",{image:this.props.image,palette:this.props.palette,zIndex:this.props.zIndex,ref:S=>this.cover=S,animationRunner:new D.SidebarRadarAnimationRunner(this.props.image)}),B.jsx("container",{ref:S=>this.minimapContainer=S,hidden:!0,x:13}))}onFrame(S){this.getUiObject().get3DObject().visible=this.visible;var O=this.props.sidebarModel;(O=O?.radarEnabled??!0)!==this.coverOpen&&(this.toggleCover(O,void 0===this.coverOpen),this.coverOpen=O),this.cover.getAnimationRunner().isStopped()&&this.minimapContainer.setVisible(this.coverOpen)}toggleCover(S,O=!1){let B=this.cover.getAnimationRunner();S?B.radarOn(O):B.radarOff(O),this.minimapContainer.setVisible(!!O&&S)}setMinimap(S){this.minimap&&this.minimapContainer.remove(this.minimap),(this.minimap=S)&&(S.setFitSize(this.getMinimapAvailSpace()),this.minimapContainer.add(S),S.setZIndex(this.props.zIndex+1))}getMinimapAvailSpace(){return{width:this.props.image.width-13-15,height:this.props.image.height}}hide(){this.visible=!1}show(){this.visible=!0}},S("SidebarRadar",F)}}}),System.register("gui/screen/game/component/hud/SidebarRadarAnimRunner",["data/IniSection","engine/Animation","engine/AnimProps","engine/Engine","util/BoxedVar"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){var O;(O=F||S("AnimationType",F={}))[O.None=0]="None",O[O.RadarOff=1]="RadarOff",O[O.RadarOn=2]="RadarOn",S("SidebarRadarAnimationRunner",class{constructor(S){this.shpFile=S,this.closed=!0,this.currentAnimationType=F.None}radarOff(S=!1){this.currentAnimationType=F.RadarOff,S||this.initAnimation()}radarOn(S=!1){this.currentAnimationType=F.RadarOn,S||this.initAnimation()}initAnimation(){var S=new B.IniSection("");S=new j.AnimProps(S,this.shpFile),S=new N.Animation(S,new D.BoxedVar(L.Engine.UI_ANIM_SPEED)),this.animation=S}tick(S){let O=this.animation;var B=this.currentAnimationType;if(O&&B!==F.None){switch(O.getState()){case N.AnimationState.STOPPED:break;case N.AnimationState.NOT_STARTED:O.start(S);case N.AnimationState.RUNNING:default:O.update(S)}O.getState()===N.AnimationState.STOPPED&&(this.closed=B===F.RadarOff,this.currentAnimationType=F.None)}}shouldUpdate(){return!0}isStopped(){return this.currentAnimationType===F.None}getCurrentFrame(){if(!this.animation)return this.currentAnimationType===F.RadarOn?this.shpFile.numImages-1:0;let S=this.currentAnimationType===F.RadarOff?-1:1;this.currentAnimationType===F.None&&this.closed&&(S*=-1);let O=0;return-1===S&&(O=this.animation.props.end),O+S*this.animation.getCurrentFrame()}})}}}),System.register("gui/screen/game/component/hud/SidebarTabs",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends j.UiComponent{constructor(){super(...arguments),this.tabObjects=[],this.flashing=!1}createUiObject(){let S=new N.UiObject(new THREE.Object3D);return S.setPosition(this.props.x||0,this.props.y||0),S}defineChildren(){let{aggregatedImageData:S,images:O,palette:N,tabSpacing:j,onTabClick:L,sidebarModel:D,strings:F}=this.props,_=[];for(let H=0;H<4;H++){var U=O[H];const V=this.props.aggregatedImageData.imageIndexes.get(U);if(void 0===V)throw new Error(`Tab ${H} image not found in aggregated file`);_.push(B.jsx("sprite",{image:S.file,palette:N,x:(j+U.width)*H,tooltip:F.get("Tip:Tab"+(H+1)),onClick:S=>{var O;0===S.button&&((O=D.tabs[H]).disabled||L?.(O))},onFrame:(S,O)=>this.handleFrame(S,O,D.tabs[H],V)}))}return _}handleFrame(S,O,B,N){let j;(!this.lastFlashUpdate||250<=S-this.lastFlashUpdate)&&(this.lastFlashUpdate=S,this.flashing=!this.flashing),j=B.disabled?2:this.props.sidebarModel.activeTab===B?1:0,B.flashing&&this.flashing&&(j=3),O.setFrame(N+j)}},S("SidebarTabs",L)}}}),System.register("gui/screen/game/component/hud/SuperWeaponTimers",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils","game/GameSpeed","util/format"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){H=class extends j.UiComponent{createUiObject(){let S=new N.UiObject(new THREE.Object3D,new L.HtmlContainer);S.setPosition(this.props.x||0,this.props.y||0);var O=this.props.width,B=this.props.height;let j=document.createElement("canvas");return j.width=O,j.height=B,this.ctx=j.getContext("2d",{alpha:!0}),this.texture=this.createTexture(j),this.mesh=this.createMesh(O,B),S}createTexture(S){let O=new THREE.Texture(S);return O.needsUpdate=!0,O.flipY=!1,O.minFilter=THREE.NearestFilter,O.magFilter=THREE.NearestFilter,O}createMesh(S,O){let B=D.SpriteUtils.createRectGeometry(S,O);D.SpriteUtils.addRectUvs(B,{x:0,y:0,width:S,height:O},{width:S,height:O}),B.translate(S/2,O/2,0);var N=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let j=new THREE.Mesh(B,N);return j.frustumCulled=!1,j}defineChildren(){return B.jsx("mesh",{zIndex:this.props.zIndex},this.mesh)}onFrame(S){if(!this.lastUpdate||100<=S-this.lastUpdate){this.lastUpdate=S;let Q=[];var O,B;this.props.stalemateDetectTrait?.isStale()&&(O=Math.floor(this.props.stalemateDetectTrait.getCountdownTicks()/_.GameSpeed.BASE_TICKS_PER_SECOND),O=this.props.strings.get("TS:StalemateTimer")+"   "+U.formatTimeDuration(O,!0),Q.push({text:O,color:"red",flash:!0}));let Z=this.props.countdownTimer;for(B of(Z.isRunning()&&(z=Z.getSeconds(),z=(void 0!==Z.text?this.props.strings.get(Z.text)+"   ":"")+U.formatTimeDuration(z,!0),Q.push({text:z,color:this.props.localPlayer?.color.asHexString()??"white",flash:!1})),this.props.players))if(!B.defeated){var N=B.superWeaponsTrait?.getAll(),j=(B.powerTrait?.getBlackoutDuration()??0)/_.GameSpeed.BASE_TICKS_PER_SECOND;if(N?.length||j){var L,D,F=B.color.asHexString();let S=[];if(N)for(var H of N)H.rules.showTimer&&S.push({seconds:H.getTimerSeconds(),label:this.props.strings.get(H.rules.uiName)});for({seconds:L,label:D}of(j&&S.push({seconds:j,label:this.props.strings.get("MSG:BlackoutTimer")}),S)){var V=Math.floor(L),W=D+"   "+U.formatTimeDuration(V,!0);Q.push({text:W,color:F,flash:0===V})}}}var z=!!Q.length;if(z!==this.lastHasTimers||z){this.lastHasTimers=z,this.ctx.clearRect(0,0,this.props.width,this.props.height);let O=this.props.height-20;for(var{text:K,color:$,flash:q}of Q)q&&($=Math.floor(S/1e3)%2?$:"orange"),O-=this.drawLine(K,$,O);this.texture.needsUpdate=!0}}}drawLine(S,O,B){return F.CanvasUtils.drawText(this.ctx,S,0,B,{color:O,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:6,height:20,backgroundColor:"rgba(0, 0, 0, .75)",textAlign:"right",paddingLeft:4,paddingRight:4}).height}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},S("SuperWeaponTimers",H)}}}),System.register("gui/screen/game/component/hud/VirtualJoystick",["gui/UiObject","gui/HtmlContainer","util/disposable/CompositeDisposable","gui/screen/game/worldInteraction/keyboard/KeyCommandType"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){const O="ra2web.mobileJoystick.enabled",D="ra2web.mobileJoystick.pos",F="ra2web.mobileJoystick.shortcutsVisible";function clamp(S,O,B){return Math.max(O,Math.min(B,S))}function dist2(S,O,B,N){let j=S-B,L=O-N;return j*j+L*L}function normMods(S){return{keyCode:0,altKey:!!S?.altKey,ctrlKey:!!S?.ctrlKey,shiftKey:!!S?.shiftKey,metaKey:!!S?.metaKey}}function makeDiv(S){let O=document.createElement("div");return S&&(O.className=S),O}function setStyle(S,O){for(let[B,N]of Object.entries(O))S.style[B]=N}function makeSvg(S){return document.createElementNS("http://www.w3.org/2000/svg",S)}function setAttrs(S,O){for(let[B,N]of Object.entries(O))S.setAttribute(B,String(N))}function polar(S,O){return{x:Math.cos(O)*S,y:Math.sin(O)*S}}function getRootScene(S){let O=S;for(;O?.parent;)O=O.parent;return"Scene"===O?.type?O:void 0}function wedgePath(S,O,B,N){let j=polar(S,B),L=polar(O,B),D=polar(O,N),F=polar(S,N),_=Math.abs(N-B)>Math.PI?1:0;return[`M ${j.x.toFixed(3)} ${j.y.toFixed(3)}`,`L ${L.x.toFixed(3)} ${L.y.toFixed(3)}`,`A ${O} ${O} 0 ${_} 1 ${D.x.toFixed(3)} ${D.y.toFixed(3)}`,`L ${F.x.toFixed(3)} ${F.y.toFixed(3)}`,`A ${S} ${S} 0 ${_} 0 ${j.x.toFixed(3)} ${j.y.toFixed(3)}`,"Z"].join(" ")}S("VirtualJoystick",class extends B.UiObject{constructor(S,O,B,L,D=!1){super(new THREE.Object3D,new N.HtmlContainer),this.uiScene=S,this.pointerEvents=O,this.battleControlApi=B,this.localPrefs=L,this.isObserver=D,this.menuOpen=!1,this.disposables=new j.CompositeDisposable,this.enabled=!1,this.shortcutsVisible=!0,this.lastShortcutToggleTap=void 0,this.centerTapSeq=void 0,this.centerTapDoubleTimer=void 0,this.centerTapResetTimer=void 0,this.repositionArmedTimer=void 0,this.repositionArmed=!1,this.panHintActive=!1,this.toastTimer=void 0,this.capture=!1,this.captureKind=void 0,this.holdTouchId=void 0,this.dragTouchId=void 0,this.dragMode=!1,this.dragTimer=void 0,this.dragStart=void 0,this.lastPointer=void 0,this.pressedButton=void 0,this.activeHold=void 0,this.secondaryTap=new Map,this.knobR=10,this.baseR=32,this.deadzone=.12,this.longPressMs=2e3,this.dragMoveThresh=12,this.fanGap=0,this.fanThickness=54,this.fanThickness2=54,this.fanAngle=42*Math.PI/180,this.fanAngle2=42*Math.PI/180,this.sideHoldAngle=38*Math.PI/180,this.wedgeHitAngleEps=2*Math.PI/180,this.wedgeHitRadiusEps=1.5,this.wedgeRenderAngleEps=.9*Math.PI/180,this.wedgeRenderRadiusEps=.8,this.dragHandleEl=void 0,this.dragHandleTouchId=void 0,this.dragHandleStart=void 0,this.longPressRepositionEnabled=!1,this.setZIndex(500),this.setVisible(!0),this.buttonDefs=this.isObserver?[]:this.buildButtonDefs(),this.initHtml(),this.loadPrefs(),this.bindInput(),this.create3DObject()}isFullScreenUnavailable(){try{return!(document.fullscreenEnabled||document.webkitFullscreenEnabled)}catch{return!0}}isTouchDevice(){try{return"ontouchstart"in window||(navigator.maxTouchPoints??0)>0}catch{return!1}}initHtml(){this.getHtmlContainer().setTranslateMode(!0);let S=makeDiv("ra2web-joystick");setStyle(S,{position:"absolute",left:"0",top:"0",width:"0",height:"0",pointerEvents:"none",zIndex:"9999"});let O=makeDiv("ra2web-joystick-inner");setStyle(O,{position:"absolute",left:"0",top:"0",transform:"translate(-50%, -50%)",width:"0",height:"0"}),S.appendChild(O);let B=makeDiv("ra2web-joystick-base");setStyle(B,{position:"absolute",left:-this.baseR+"px",top:-this.baseR+"px",width:2*this.baseR+"px",height:2*this.baseR+"px",borderRadius:"999px",border:"3px solid rgba(255,80,80,0.70)",background:"rgba(255,60,60,0.25)"});let N=makeDiv("ra2web-joystick-knob");setStyle(N,{position:"absolute",left:-this.knobR+"px",top:-this.knobR+"px",width:2*this.knobR+"px",height:2*this.knobR+"px",borderRadius:"999px",background:"rgba(255,224,102,0.80)",boxShadow:"0 0 0 1px rgba(0,0,0,0.30)"}),O.appendChild(B),O.appendChild(N),this.htmlRoot=S,this.htmlInner=O,this.htmlBase=B,this.htmlKnob=N;const j=this.baseR+this.fanThickness+this.fanThickness2+(this.wedgeRenderRadiusEps??0)+12;let L=makeSvg("svg");setAttrs(L,{width:2*j,height:2*j,viewBox:`${-j} ${-j} ${2*j} ${2*j}`}),setStyle(L,{position:"absolute",left:-j+"px",top:-j+"px",overflow:"visible"}),this.svgRoot=L,this.svgWedges=new Map;for(let S of this.buttonDefs){let O=S.center+S.a0-(this.wedgeRenderAngleEps??0),B=S.center+S.a1+(this.wedgeRenderAngleEps??0),N=Math.max(0,S.r0-(this.wedgeRenderRadiusEps??0)),j=S.r1+(this.wedgeRenderRadiusEps??0),D=makeSvg("path");setAttrs(D,{d:wedgePath(N,j,O,B),fill:"hold"===S.kind?"rgba(255,60,60,0.35)":"rgba(255,60,60,0.25)",stroke:"rgba(255,80,80,0.50)","stroke-width":1,"stroke-linejoin":"round","stroke-linecap":"round"}),L.appendChild(D),this.svgWedges.set(S.id,D);let F=polar((S.r0+S.r1)/2,S.center),_=makeSvg("text");_.textContent=this.getButtonLabel(S),setAttrs(_,{x:F.x.toFixed(3),y:F.y.toFixed(3),"text-anchor":"middle","dominant-baseline":"middle",fill:"rgba(255,224,102,0.85)","font-size":16,"font-family":"sans-serif","font-weight":"bold"}),L.appendChild(_)}this.htmlInner.appendChild(L);let D=makeDiv("ra2web-joystick-hint");setStyle(D,{position:"fixed",left:"50%",top:"12px",transform:"translateX(-50%)",padding:"8px 18px",borderRadius:"8px",background:"rgba(0,0,0,0.65)",color:"#ffe066",fontSize:"16px",fontFamily:"sans-serif",pointerEvents:"none",zIndex:"10000",display:"none",whiteSpace:"nowrap",textAlign:"center"}),document.body.appendChild(D),this.hintEl=D,this.getHtmlContainer().setElement(S)}bindDragHandle(){let S=this.dragHandleEl;if(!S)return;const onStart=S=>this.handleDragHandleStart(S),onMove=S=>this.handleDragHandleMove(S),onEnd=S=>this.handleDragHandleEnd(S);S.addEventListener("touchstart",onStart,{passive:!1}),S.addEventListener("touchmove",onMove,{passive:!1}),S.addEventListener("touchend",onEnd,{passive:!1}),S.addEventListener("touchcancel",onEnd,{passive:!1}),this.disposables.add(()=>{try{S.removeEventListener("touchstart",onStart),S.removeEventListener("touchmove",onMove),S.removeEventListener("touchend",onEnd),S.removeEventListener("touchcancel",onEnd)}catch{}})}handleDragHandleStart(S){if(!this.enabled)return;if(!(this.viewport??this.uiScene.viewport))return;let O=S.changedTouches?.[0];if(!O)return;this.dragHandleTouchId=O.identifier;let B=this.pointerEvents?.computeTouchPosition?.(O)??{x:O.pageX,y:O.pageY};this.dragHandleStart={x:B.x,y:B.y,cx:this.getPosition().x,cy:this.getPosition().y},this.showHint(""),S.preventDefault?.(),S.stopImmediatePropagation?.(),S.stopPropagation?.()}handleDragHandleMove(S){if(void 0===this.dragHandleTouchId||!this.dragHandleStart)return;let O,B=this.viewport??this.uiScene.viewport;if(!B)return;for(let B of[...S.changedTouches??[]])if(B.identifier===this.dragHandleTouchId){O=B;break}if(!O)return;let N=this.pointerEvents?.computeTouchPosition?.(O)??{x:O.pageX,y:O.pageY},j=this.dragHandleStart.cx+(N.x-this.dragHandleStart.x),L=this.dragHandleStart.cy+(N.y-this.dragHandleStart.y);j=clamp(j,this.baseR+10,B.width-(this.baseR+10)),L=clamp(L,this.baseR+10,B.height-(this.baseR+10)),this.setPosition(j,L),S.preventDefault?.(),S.stopImmediatePropagation?.(),S.stopPropagation?.()}handleDragHandleEnd(S){if(void 0===this.dragHandleTouchId)return;let O=!1;for(let B of[...S.changedTouches??[]])if(B.identifier===this.dragHandleTouchId){O=!0;break}O&&(this.dragHandleTouchId=void 0,this.dragHandleStart=void 0,this.savePos(),this.hideHint(),S.preventDefault?.(),S.stopImmediatePropagation?.(),S.stopPropagation?.())}getButtonLabel(S){switch(S.id){case"home":return"";case"type":return"";case"combat":return"";case"event":return"";case"scatter":return"";case"deploy":return"";case"next":return"";case"stop":return"";case"force_attack":return"";case"attack_move":return"";case"cancel":return"";default:return""}}updateHtmlLayout(){}showHint(S){this.hintEl&&(this.hintEl.textContent=S,this.hintEl.style.display="block")}toast(S){this.toastTimer&&(clearTimeout(this.toastTimer),this.toastTimer=void 0),this.showHint(S),this.toastTimer=setTimeout(()=>{this.activeHold||this.dragMode||this.hideHint()},1200)}hideHint(){this.hintEl&&(this.hintEl.style.display="none")}updateShortcutsUi(){this.svgRoot&&(this.svgRoot.style.display=this.shortcutsVisible?"block":"none")}setShortcutsVisible(S,O=!0){if(this.shortcutsVisible=!!S,this.updateShortcutsUi(),O)try{this.localPrefs?.setItem?.(F,this.shortcutsVisible?"1":"0")}catch{}}clearCenterTapTimers(){this.centerTapDoubleTimer&&(clearTimeout(this.centerTapDoubleTimer),this.centerTapDoubleTimer=void 0),this.centerTapResetTimer&&(clearTimeout(this.centerTapResetTimer),this.centerTapResetTimer=void 0)}clearRepositionArmedTimer(){this.repositionArmedTimer&&(clearTimeout(this.repositionArmedTimer),this.repositionArmedTimer=void 0)}setRepositionArmed(S){const O=!!S;this.repositionArmed!==O&&(this.repositionArmed=O,this.clearRepositionArmedTimer(),this.repositionArmed&&(this.repositionArmedTimer=setTimeout(()=>{this.repositionArmedTimer=void 0,this.repositionArmed&&!this.dragMode&&(this.repositionArmed=!1,this.hideHint?.(),this.resetCenterTapSeq?.())},2e3)))}resetCenterTapSeq(){this.clearCenterTapTimers(),this.centerTapSeq=void 0}onCenterTap(S,O){const B=Number.isFinite(O)&&0<O?O:Date.now();let N=this.centerTapSeq;if(N=N&&B-N.time<=500&&dist2(S.x,S.y,N.x,N.y)<=144?{x:S.x,y:S.y,time:B,count:(N.count??1)+1}:{x:S.x,y:S.y,time:B,count:1},this.centerTapSeq=N,this.centerTapResetTimer&&clearTimeout(this.centerTapResetTimer),this.centerTapResetTimer=setTimeout(()=>this.resetCenterTapSeq(),550),2===N.count)return this.centerTapDoubleTimer&&clearTimeout(this.centerTapDoubleTimer),void(this.centerTapDoubleTimer=setTimeout(()=>{2===this.centerTapSeq?.count&&(this.setShortcutsVisible(!this.shortcutsVisible,!0),this.toast(this.shortcutsVisible?"":""),this.resetCenterTapSeq())},220));3===N.count&&(this.clearCenterTapTimers(),this.centerTapSeq=void 0,this.setRepositionArmed(!this.repositionArmed),this.repositionArmed?this.showHint(""):this.hideHint())}getHintForHold(S){switch(S){case"force_attack":return"";case"attack_move":return"";case"cancel":return"";default:return""}}buildButtonDefs(){const S=this.baseR,O=S+this.fanThickness,B=O+this.fanThickness2,N=Math.PI/180,j=22.5*N,D=11.25*N;let F=[];return F.push({id:"home",kind:"click",command:L.KeyCommandType.CenterBase,r0:S,r1:O,center:67.5*N,a0:-j,a1:j}),F.push({id:"type",kind:"click",command:L.KeyCommandType.TypeSelect,r0:S,r1:O,center:112.5*N,a0:-j,a1:j}),F.push({id:"combat",kind:"click",command:L.KeyCommandType.CombatantSelect,r0:O,r1:B,center:67.5*N,a0:-D,a1:D}),F.push({id:"event",kind:"click",command:L.KeyCommandType.CenterOnRadarEvent,r0:O,r1:B,center:112.5*N,a0:-D,a1:D}),F.push({id:"scatter",kind:"click",command:L.KeyCommandType.ScatterObject,r0:S,r1:O,center:-112.5*N,a0:-j,a1:j}),F.push({id:"deploy",kind:"click",command:L.KeyCommandType.DeployObject,r0:S,r1:O,center:-67.5*N,a0:-j,a1:j}),F.push({id:"next",kind:"click",command:L.KeyCommandType.NextObject,r0:O,r1:B,center:-112.5*N,a0:-D,a1:D}),F.push({id:"stop",kind:"click",command:L.KeyCommandType.StopObject,r0:O,r1:B,center:-67.5*N,a0:-D,a1:D}),F.push({id:"attack_move",kind:"hold",mods:{ctrlKey:!0,shiftKey:!0},r0:S,r1:O,center:157.5*N,a0:-j,a1:j}),F.push({id:"force_attack",kind:"hold",mods:{ctrlKey:!0},r0:S,r1:O,center:202.5*N,a0:-j,a1:j}),F.push({id:"cancel",kind:"hold",mods:{},r0:S,r1:O,center:0,a0:-45*N,a1:45*N}),F}bindInput(){this.disposables.add(this.pointerEvents.addEventListener("canvas","mousedown",S=>this.handleDown(S),!0)),this.disposables.add(this.pointerEvents.addEventListener("canvas","mousemove",S=>this.handleMove(S),!0)),this.disposables.add(this.pointerEvents.addEventListener("canvas","mouseup",S=>this.handleUp(S),!0));let S=this.pointerEvents?.renderer?.getCanvas?.();if(S){const t=S=>this.handleNativeTouchStart(S),i=S=>this.handleNativeTouchMove(S),r=S=>this.handleNativeTouchEnd(S);S.addEventListener("touchstart",t,{capture:!0,passive:!1}),S.addEventListener("touchmove",i,{capture:!0,passive:!1}),S.addEventListener("touchend",r,{capture:!0,passive:!1}),S.addEventListener("touchcancel",r,{capture:!0,passive:!1}),this.disposables.add(()=>{S.removeEventListener("touchstart",t,!0),S.removeEventListener("touchmove",i,!0),S.removeEventListener("touchend",r,!0),S.removeEventListener("touchcancel",r,!0)})}}setEnabled(S){this.enabled!==S&&(this.enabled=S,this.updateVisibility(),S||(this.cancelPan(),this.clearHoldMods(),this.resetKnob(),this.capture=!1,this.dragMode=!1,this.pressedButton=void 0,this.hideHint()))}setMenuOpen(S){this.menuOpen=S,this.updateVisibility(),S&&(this.cancelPan(),this.clearHoldMods(),this.resetKnob(),this.capture=!1,this.dragMode=!1,this.pressedButton=void 0,this.hideHint())}updateVisibility(){this.setVisible(this.enabled&&!this.menuOpen)}onViewportChange(S){this.viewport=S,this.applyPositionFromPrefs(),this.updateHtmlLayout()}loadPrefs(){try{let S=this.localPrefs?.getItem?.(O);null==S&&(S="ontouchstart"in window||(navigator.maxTouchPoints??0)>0?"1":"0",this.localPrefs?.setItem?.(O,S)),this.enabled="1"===S||"true"===S,this.updateVisibility()}catch{this.enabled=!1,this.updateVisibility()}try{let S=this.localPrefs?.getItem?.(F);null==S&&(S="1",this.localPrefs?.setItem?.(F,S)),this.shortcutsVisible="1"===S||"true"===S}catch{this.shortcutsVisible=!0}this.updateShortcutsUi(),this.applyPositionFromPrefs()}applyPositionFromPrefs(){let S=this.uiScene.viewport;if(!S)return;this.viewport=S;let O=Math.max(this.baseR+20,80),B=Math.max(this.baseR+20,S.height-180);try{let N=this.localPrefs?.getItem?.(D);N&&(N=JSON.parse(N),Number.isFinite(N?.xFrac)&&Number.isFinite(N?.yFrac)&&(O=N.xFrac*S.width,B=N.yFrac*S.height))}catch{}O=clamp(O,this.baseR+10,S.width-(this.baseR+10)),B=clamp(B,this.baseR+10,S.height-(this.baseR+10)),this.setPosition(O,B)}savePos(){if(this.viewport)try{let S=this.getPosition();this.localPrefs?.setItem?.(D,JSON.stringify({xFrac:S.x/this.viewport.width,yFrac:S.y/this.viewport.height}))}catch{}}isWithinMain(S){let O=this.getPosition(),B=this.isObserver||!this.shortcutsVisible?this.baseR+10:this.baseR+this.fanThickness+this.fanThickness2+10;return dist2(S.x,S.y,O.x,O.y)<=Math.pow(B,2)}getRegion(S){let O=this.getPosition(),B=S.x-O.x,N=S.y-O.y;const j=Math.sqrt(B*B+N*N),L=Math.atan2(N,B);if(j<=this.baseR)return{kind:"center",dx:B,dy:N,dist:j};if(!this.shortcutsVisible)return;const D=this.wedgeHitRadiusEps??0,F=this.wedgeHitAngleEps??0,l=S=>{if(j>=S.r0-D&&j<=S.r1+D){let O=L-S.center;for(;O>Math.PI;)O-=2*Math.PI;for(;O<-Math.PI;)O+=2*Math.PI;if(O>=S.a0-F&&O<=S.a1+F)return!0}return!1};for(let S of this.buttonDefs)if("hold"===S.kind&&l(S))return S;for(let S of this.buttonDefs)if("click"===S.kind&&l(S))return S}handleDown(S){if(S.virtual)return;if(!this.enabled)return;if(!this.isWithinMain(S.pointer))return;let O=this.getRegion(S.pointer);if(O)if(this.capture=!0,this.lastPointer=S.pointer,S.stopImmediatePropagation?.(),S.stopPropagation?.(),"center"===O.kind){this.captureKind="center";const B=this.knobR+6,N=(O.dist??0)<=B;if(this.dragMode=!1,this.dragStart={x:S.pointer.x,y:S.pointer.y,cx:this.getPosition().x,cy:this.getPosition().y,time:S.timeStamp,touchId:S.isTouch?S.touchId:void 0,intent:N?"pan":"reposition"},this.repositionArmed)return this.clearRepositionArmedTimer?.(),this.dragMode=!0,this.cancelPan(),this.resetKnob(),this.dragTouchId=this.dragStart.touchId,void this.showHint("");this.longPressRepositionEnabled&&!N&&this.armLongPress()}else if("hold"===O.kind){this.captureKind="hold",this.activeHold=O,this.holdTouchId=S.isTouch?S.touchId:void 0,this.applyHoldMods(O.mods);let B=this.getHintForHold(O.id);B&&this.showHint(B)}else"click"===O.kind&&(this.captureKind="click",this.pressedButton=O)}armLongPress(){this.longPressRepositionEnabled&&this.dragStart&&"reposition"===this.dragStart.intent&&(this.clearLongPress(),this.dragTimer=setTimeout(()=>{if(!this.capture||!this.dragStart||!this.lastPointer)return;let S=this.lastPointer.x-this.dragStart.x,O=this.lastPointer.y-this.dragStart.y;S*S+O*O<=this.dragMoveThresh*this.dragMoveThresh&&(this.dragMode=!0,this.cancelPan(),this.resetKnob(),this.dragTouchId=this.dragStart.touchId,this.showHint(""))},this.longPressMs))}clearLongPress(){this.dragTimer&&(clearTimeout(this.dragTimer),this.dragTimer=void 0)}handleMove(S){if(!S.virtual&&this.enabled&&this.capture&&(this.lastPointer=S.pointer,S.stopImmediatePropagation?.(),S.stopPropagation?.(),!this.activeHold)){if(this.dragMode){if(!this.dragStart)return;const O=this.viewport??this.uiScene.viewport;if(!O)return;let B=this.dragStart.cx+(S.pointer.x-this.dragStart.x),N=this.dragStart.cy+(S.pointer.y-this.dragStart.y);return B=clamp(B,this.baseR+10,O.width-(this.baseR+10)),N=clamp(N,this.baseR+10,O.height-(this.baseR+10)),void this.setPosition(B,N)}if("center"===this.captureKind){if(this.dragStart&&"reposition"===this.dragStart.intent){let O=S.pointer.x-this.dragStart.x,B=S.pointer.y-this.dragStart.y;if(!(O*O+B*B>=196))return;this.dragStart.intent="pan",this.clearLongPress()}let O=this.getPosition();this.updateKnobAndPan(S.pointer.x-O.x,S.pointer.y-O.y)}}}handleUp(S){if(!S.virtual&&this.enabled&&this.capture){if(S.stopImmediatePropagation?.(),S.stopPropagation?.(),this.clearLongPress(),this.dragMode&&(this.dragMode=!1,this.dragTouchId=void 0,this.savePos(),this.hideHint(),this.repositionArmed&&this.setRepositionArmed?.(!1),this.resetCenterTapSeq()),this.activeHold)this.clearHoldMods(),this.activeHold=void 0,this.holdTouchId=void 0,this.secondaryTap.clear(),this.hideHint();else if(this.pressedButton){let O=this.getRegion(S.pointer);O?.id===this.pressedButton.id&&this.execCommand(this.pressedButton.command),this.pressedButton=void 0}else{if("center"===this.captureKind&&this.dragStart&&!this.dragMode){const O=Number.isFinite(S.timeStamp)&&0<S.timeStamp?S.timeStamp:Date.now(),B=O-(Number.isFinite(this.dragStart.time)&&0<this.dragStart.time?this.dragStart.time:O),N=S.pointer.x-this.dragStart.x,j=S.pointer.y-this.dragStart.y;B<=350&&N*N+j*j<=100&&this.onCenterTap(S.pointer,O)}this.cancelPan(),this.resetKnob()}this.capture=!1,this.captureKind=void 0,this.dragStart=void 0}}handleNativeTouchStart(S){if(this.enabled)for(let O of[...S.changedTouches]){const B=O.identifier;let N=this.pointerEvents.computeTouchPosition(O);if(this.dragMode&&void 0!==this.dragTouchId&&B===this.dragTouchId)S.preventDefault?.(),S.stopImmediatePropagation?.(),S.stopPropagation?.();else{if(!this.activeHold){if(!this.isWithinMain(N))continue;let O=this.getRegion(N);if(!O||"hold"!==O.kind)continue;this.activeHold=O,this.holdTouchId=B,this.applyHoldMods(O.mods);let j=this.getHintForHold(O.id);j&&this.showHint(j),S.preventDefault?.(),S.stopImmediatePropagation?.(),S.stopPropagation?.();continue}void 0!==this.holdTouchId&&(B!==this.holdTouchId?(this.secondaryTap.set(B,{start:N,time:S.timeStamp}),S.preventDefault?.(),S.stopImmediatePropagation?.(),S.stopPropagation?.()):(S.preventDefault?.(),S.stopImmediatePropagation?.(),S.stopPropagation?.()))}}}handleNativeTouchMove(S){if(this.enabled){if(this.dragMode&&this.dragStart&&void 0!==this.dragTouchId){const O=this.viewport??this.uiScene.viewport;if(!O)return;for(let B of[...S.changedTouches]){if(B.identifier!==this.dragTouchId)continue;let N=this.pointerEvents.computeTouchPosition(B),j=this.dragStart.cx+(N.x-this.dragStart.x),L=this.dragStart.cy+(N.y-this.dragStart.y);return j=clamp(j,this.baseR+10,O.width-(this.baseR+10)),L=clamp(L,this.baseR+10,O.height-(this.baseR+10)),this.setPosition(j,L),S.preventDefault?.(),S.stopImmediatePropagation?.(),void S.stopPropagation?.()}}if(this.activeHold&&void 0!==this.holdTouchId)for(let O of[...S.changedTouches]){const B=O.identifier;B!==this.holdTouchId?this.secondaryTap.has(B)&&(S.preventDefault?.(),S.stopImmediatePropagation?.(),S.stopPropagation?.()):(S.preventDefault?.(),S.stopImmediatePropagation?.(),S.stopPropagation?.())}}}handleNativeTouchEnd(S){if(this.enabled){if(this.dragMode&&this.dragStart&&void 0!==this.dragTouchId)for(let O of[...S.changedTouches])if(O.identifier===this.dragTouchId)return S.preventDefault?.(),S.stopImmediatePropagation?.(),S.stopPropagation?.(),this.clearLongPress(),this.dragMode=!1,this.dragTouchId=void 0,this.savePos(),this.hideHint(),this.capture=!1,this.captureKind=void 0,this.dragStart=void 0,void this.pointerEvents?.resetTouchState?.();if(this.activeHold&&void 0!==this.holdTouchId)for(let O of[...S.changedTouches]){const B=O.identifier;if(B===this.holdTouchId){S.preventDefault?.(),S.stopImmediatePropagation?.(),S.stopPropagation?.(),this.clearHoldMods(),this.activeHold=void 0,this.holdTouchId=void 0,this.secondaryTap.clear(),this.pointerEvents?.resetTouchState?.(),this.capture=!1,this.captureKind=void 0,this.dragStart=void 0,this.dragMode=!1,this.hideHint();continue}let N=this.secondaryTap.get(B);if(!N)continue;this.secondaryTap.delete(B);let j=this.pointerEvents.computeTouchPosition(O),L=j.x-N.start.x,D=j.y-N.start.y;if(S.timeStamp-N.time<=350&&L*L+D*D<=144&&this.activeHold)if("cancel"===this.activeHold.id){let S=this.pointerEvents?.findObjectUnderPointer?.(j);(S?.object?getRootScene(S.object):void 0)===this.uiScene?.get3DObject?.()?this.pointerEvents?.virtualClick?.(j,{button:2,clicks:1,mods:normMods({})}):this.battleControlApi?.cancelSelection?.()}else{let S=normMods(this.activeHold.mods);globalThis.__ra2webDebugMobileJoystick&&console.log("[VirtualJoystick] secondaryTap virtualTap",{x:j.x,y:j.y},S),this.battleControlApi?.virtualTap?.(j,S,!1)}S.preventDefault?.(),S.stopImmediatePropagation?.(),S.stopPropagation?.()}}}updateKnobAndPan(S,O){let B=Math.sqrt(S*S+O*O);if(0===B)return this.cancelPan(),this.resetKnob();let N=S/B,j=O/B,L=Math.min(B,this.baseR);this.setKnobOffset(N*L,j*L);let D=L/this.baseR;if(D<this.deadzone)return this.cancelPan(),void(D=0);this.dragMode||this.activeHold||this.repositionArmed||this.panHintActive||(this.showHint(""),this.panHintActive=!0),this.battleControlApi?.requestPan?.(N*D,j*D)}setKnobOffset(S,O){this.htmlKnob&&(this.htmlKnob.style.left=S-this.knobR+"px",this.htmlKnob.style.top=O-this.knobR+"px")}resetKnob(){this.setKnobOffset(0,0)}cancelPan(){this.battleControlApi?.cancelPan?.(),this.panHintActive&&(this.dragMode||this.activeHold||this.repositionArmed||this.hideHint(),this.panHintActive=!1)}execCommand(S){S&&this.battleControlApi?.executeKeyCommand?.(S)}applyHoldMods(S){this.battleControlApi?.applyKeyModifiers?.(normMods(S))}clearHoldMods(){this.battleControlApi?.applyKeyModifiers?.(normMods({}))}dispose(){this.clearCenterTapTimers?.(),this.clearRepositionArmedTimer?.(),this.toastTimer&&(clearTimeout(this.toastTimer),this.toastTimer=void 0),this.clearLongPress(),this.cancelPan(),this.clearHoldMods(),this.disposables.dispose(),this.hintEl&&(this.hintEl.remove(),this.hintEl=void 0),this.destroy()}})}}}),System.register("gui/screen/game/component/hud/commandBar/CommandBarButtonList",["gui/screen/game/component/hud/commandBar/CommandBarButtonType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("CommandBarButtonList",class{constructor(){this.buttons=[]}fromIni(S){var O,N=(S.getString("ButtonList")||void 0)?.split(",")??[];let j=[],L=new Set(Object.keys(B.CommandBarButtonType).filter(S=>"string"==typeof S));for(O of N)"x"===O?j.push(B.CommandBarButtonType.Separator):L.has(O)?j.push(B.CommandBarButtonType[O]):console.warn(`Unknown command bar button type "${O}"`);return this.buttons=j,this}})}}}),System.register("gui/screen/game/component/hud/commandBar/CommandBarButtonType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("CommandBarButtonType",B={}))[O.Separator=0]="Separator",O[O.BugReport=1]="BugReport",O[O.Beacon=2]="Beacon",O[O.Cheer=3]="Cheer",O[O.Deploy=4]="Deploy",O[O.Guard=5]="Guard",O[O.PlanningMode=6]="PlanningMode",O[O.Stop=7]="Stop",O[O.Team01=8]="Team01",O[O.Team02=9]="Team02",O[O.Team03=10]="Team03",O[O.TypeSelect=11]="TypeSelect",O[O.ReplayRewind=12]="ReplayRewind",O[O.ReplayPlay=13]="ReplayPlay",O[O.ReplayPause=14]="ReplayPause",O[O.ReplaySpeed=15]="ReplaySpeed"}}}),System.register("gui/screen/game/component/hud/commandBar/CommandButtonConfig",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("gui/screen/game/component/hud/commandBar/commandButtonConfigs",["gui/screen/game/component/hud/commandBar/CommandBarButtonType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("commandButtonConfigs",[{type:B.CommandBarButtonType.BugReport,icon:"reportbug.shp",tooltip:S=>S.get("ts:reportbug")},{type:B.CommandBarButtonType.Team01,icon:"button00.shp",tooltip:S=>S.get("tip:team01")},{type:B.CommandBarButtonType.Team02,icon:"button01.shp",tooltip:S=>S.get("tip:team02")},{type:B.CommandBarButtonType.Team03,icon:"button02.shp",tooltip:S=>S.get("tip:team03")},{type:B.CommandBarButtonType.TypeSelect,icon:"button03.shp",tooltip:S=>S.get("tip:typeselect")},{type:B.CommandBarButtonType.Deploy,icon:"button04.shp",tooltip:S=>S.get("tip:deploy")},{type:B.CommandBarButtonType.Guard,icon:"button06.shp",tooltip:S=>S.get("tip:guard")},{type:B.CommandBarButtonType.Beacon,icon:"button07.shp",tooltip:S=>S.get("tip:beacon")},{type:B.CommandBarButtonType.Stop,icon:"button08.shp",tooltip:S=>S.get("tip:stop")},{type:B.CommandBarButtonType.PlanningMode,icon:"button09.shp",tooltip:S=>S.get("tip:planningmode")},{type:B.CommandBarButtonType.Cheer,icon:"button10.shp",tooltip:S=>S.get("tip:cheer")},{type:B.CommandBarButtonType.ReplayRewind,icon:"rewind.shp",tooltip:S=>S.get("tip:replayrewind")},{type:B.CommandBarButtonType.ReplayPlay,icon:"play.shp",tooltip:S=>S.get("tip:play")},{type:B.CommandBarButtonType.ReplayPause,icon:"pause.shp",tooltip:S=>S.get("tip:pause")},{type:B.CommandBarButtonType.ReplaySpeed,icon:"ffwd.shp",tooltip:S=>S.get("tip:replayspeed")}])}}}),System.register("gui/screen/game/component/hud/viewmodel/CombatantSidebarModel",["game/rules/TechnoRules","game/player/production/ProductionQueue","engine/type/ObjectType","game/gameobject/trait/DockTrait","gui/screen/game/component/hud/viewmodel/SidebarModel","game/SuperWeapon"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=(new Map).set(F.SuperWeaponStatus.Charging,D.SidebarItemStatus.Started).set(F.SuperWeaponStatus.Paused,D.SidebarItemStatus.OnHold).set(F.SuperWeaponStatus.Ready,D.SidebarItemStatus.Ready),U=class extends D.SidebarModel{get credits(){return Math.floor(this.player.credits)}get radarEnabled(){return!(!this.player.radarTrait||this.player.radarTrait.isDisabled())}constructor(S,O){super(O),this.player=S,this.rules=O.rules}computePurchaseCost(S){return this.game.sellTrait.computePurchaseValue(S,this.player)}updateAvailableObjects(S){if(!this.player.production)throw new Error("Player is not a combatant");var O,B,N,j=this.sortAvailableObjects(this.player.production.getAvailableObjects());for(O of this.tabs)O.items.length=0,O.needsUpdate=!0;for(B of(this.updateSuperWeaponItems(),j)){var L=S.getObject(B.name,B.type);let O=this.tabs[this.getSidebarCategoryForQueueType(this.player.production.getQueueTypeForObject(B))];var F=this.player.production.getQueueForObject(B),_=this.player.production.getFactoryTypeForQueueType(F.type);L={target:{type:D.SidebarItemTargetType.Techno,rules:B},cameo:this.player.production.hasVeteranType(_)&&B.trainable?L.altCameo:L.cameo,disabled:!1,progress:0,quantity:0,status:D.SidebarItemStatus.Idle},O.items.push(L),this.updateSidebarTechnoItem(L,F,this.player.production)}for(N of this.tabs)this.updateTabFlashing(N);this.updateActiveTab()}updateActiveTab(){var S;0!==this.activeTab.items.length||void 0!==(S=this.tabs.find(S=>0<S.items.length)?.id)&&this.selectTab(S)}updateFromQueue(S){if(!this.player.production)throw new Error("Player is not a combatant");let O=this.tabs[this.getSidebarCategoryForQueueType(S.type)];for(var B of(O.needsUpdate=!0,O.items))B.target.type===D.SidebarItemTargetType.Techno&&this.player.production.getQueueForObject(B.target.rules)===S&&this.updateSidebarTechnoItem(B,S,this.player.production);this.updateTabFlashing(O)}updateSuperWeapons(){this.updateSuperWeaponItems(),this.updateActiveTab()}updateSuperWeaponItems(){let S=this.player.superWeaponsTrait?.getAll().slice().sort((S,O)=>1e3*(S.rules.rechargeTime-O.rules.rechargeTime)+S.name.charCodeAt(0)-O.name.charCodeAt(0)),O=this.tabs[D.SidebarCategory.Armory];O.needsUpdate=!0;var B=O.items.findIndex(S=>S.target.type===D.SidebarItemTargetType.Techno);-1!==B?O.items.splice(0,B):O.items.length=0,B=S?.map(S=>{var O=_.get(S.status);if(void 0===O)throw new Error(`Unhandled super weapon status "${S.status}"`);return{target:{type:D.SidebarItemTargetType.Special,rules:S.rules},cameo:S.rules.sidebarImage,disabled:!1,progress:S.getChargeProgress(),quantity:1,status:O}}),B&&O.items.unshift(...B),this.updateTabFlashing(O)}updateTabFlashing(S){S.flashing=S.items.some(S=>S.status===D.SidebarItemStatus.Ready)}updateSidebarTechnoItem(S,O,N){if(S.target.type===D.SidebarItemTargetType.Special)throw new Error("Sidebar item must be of type Techno");let F=S.target.rules,_=[...this.player.buildings],U=!1;if(Number.isFinite(F.buildLimit)){let S;S=0<=F.buildLimit?(F.type===j.ObjectType.Building?_:this.player.getOwnedObjectsByType(F.type,!0)).filter(S=>S.name===F.name).length:this.player.getLimitedUnitsBuilt(F.name),U=S>=Math.abs(F.buildLimit)}this.rules.general.padAircraft.includes(F.name)&&(V=_.filter(S=>S.factoryTrait?.type===B.FactoryType.AircraftType&&S.helipadTrait).reduce((S,O)=>S+(O.traits.find(L.DockTrait)?.numberOfDocks??0),0),U=U||[...this.player.getOwnedObjectsByType(j.ObjectType.Aircraft,!0)].filter(S=>this.rules.general.padAircraft.includes(S.name)).length>=V);let H=N.getFactoryTypeForQueueType(O.type);var V=_.filter(S=>S.factoryTrait?.type===H&&!S.warpedOutTrait.isActive());let W=O.find(F);S.progress=W.length?W[0].progress:0,S.quantity=W.reduce((S,O)=>S+O.quantity,0),S.status=this.computeStatus(O,W[0]),S.disabled=1===O.maxSize&&W[0]!==O.getFirst()||U||!V.length&&(!O.currentSize||W[0]!==O.getFirst())}getTabForQueueType(S){return this.tabs[this.getSidebarCategoryForQueueType(S)]}getSidebarCategoryForQueueType(S){switch(S){case N.QueueType.Structures:return D.SidebarCategory.Structures;case N.QueueType.Armory:return D.SidebarCategory.Armory;case N.QueueType.Infantry:return D.SidebarCategory.Infantry;case N.QueueType.Vehicles:case N.QueueType.Ships:case N.QueueType.Aircrafts:return D.SidebarCategory.Vehicles;default:throw new Error("Unhandled queueType "+N.QueueType[S])}}computeStatus(S,O){return O?S.getFirst()===O?S.status===N.QueueStatus.Ready?D.SidebarItemStatus.Ready:S.status===N.QueueStatus.OnHold?D.SidebarItemStatus.OnHold:D.SidebarItemStatus.Started:D.SidebarItemStatus.InQueue:D.SidebarItemStatus.Idle}sortAvailableObjects(S){return[...S].sort((S,O)=>{var B=this.getObjectTypeSortValue(S),N=this.getObjectTypeSortValue(O);return B===N?S.aiBasePlanningSide===O.aiBasePlanningSide?S.techLevel===O.techLevel?S.prerequisite.length<O.prerequisite.length?-1:1:S.techLevel<O.techLevel?-1:1:(S.aiBasePlanningSide??-1)<(O.aiBasePlanningSide??-1)?-1:1:B-N})}getObjectTypeSortValue(S){return S.type===j.ObjectType.Aircraft?1:S.type===j.ObjectType.Vehicle?S.naval?2:S.consideredAircraft?1:0:0}},S("CombatantSidebarModel",U)}}}),System.register("gui/screen/game/component/hud/viewmodel/MessageList",["util/event"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("MessageList",class{get onNewMessage(){return this._onNewMessage.asEvent()}constructor(S,O,N){this.messageDurationSeconds=S,this.maxMessages=O,this.localPlayer=N,this.isComposing=!1,this.messages=[],this._onNewMessage=new B.EventDispatcher}addUiFeedbackMessage(S){var O={text:S,color:this.localPlayer?.color.asHexString()??"grey",time:Date.now(),animate:!1};this.messages.push(O),this._onNewMessage.dispatch(this,O)}addSystemMessage(S,O,B){var N={text:S,color:"string"==typeof O?O:O.color.asHexString(),time:Date.now(),animate:!0,durationSeconds:B};this.messages.push(N),this._onNewMessage.dispatch(this,N)}addChatMessage(S,O){var B={text:S,color:O,time:Date.now(),animate:!0};this.messages.push(B),this._onNewMessage.dispatch(this,B)}prune(){let S=Date.now();this.messages=this.messages.filter(O=>O.time>=S-1e3*(O.durationSeconds??this.messageDurationSeconds)),this.messages.splice(0,this.messages.length-this.maxMessages)}getAll(){return this.messages}})}}}),System.register("gui/screen/game/component/hud/viewmodel/SidebarModel",["gui/screen/game/component/hud/viewmodel/SidebarTab","game/GameSpeed"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){var O;(O=j||S("SidebarItemTargetType",j={}))[O.Techno=0]="Techno",O[O.Special=1]="Special",(O=L||S("SidebarItemStatus",L={}))[O.Idle=0]="Idle",O[O.InQueue=1]="InQueue",O[O.Started=2]="Started",O[O.OnHold=3]="OnHold",O[O.Ready=4]="Ready",(O=D||S("SidebarCategory",D={}))[O.Structures=0]="Structures",O[O.Armory=1]="Armory",O[O.Infantry=2]="Infantry",O[O.Vehicles=3]="Vehicles",S("SidebarModel",class{constructor(S,O){this.game=S,this.replay=O,this.powerDrained=0,this.powerGenerated=0,this.sellMode=!1,this.repairMode=!1,this.topTextLeftAlign=!1,this.tabs=[new B.SidebarTab(D.Structures),new B.SidebarTab(D.Armory),new B.SidebarTab(D.Infantry),new B.SidebarTab(D.Vehicles)],this.activeTabId=D.Structures}get activeTab(){return this.tabs[this.activeTabId]}get currentGameTime(){return Math.floor(this.game.currentTime/1e3)}get replayTime(){return this.replay?Math.floor(this.replay.endTick/N.GameSpeed.BASE_TICKS_PER_SECOND):void 0}selectTab(S){this.tabs[S].disabled||(this.activeTabId=S)}})}}}),System.register("gui/screen/game/component/hud/viewmodel/SidebarTab",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("SidebarTab",class{constructor(S){this.items=[],this.needsUpdate=!0,this.flashing=!1,this.id=S}get disabled(){return!this.items.length}})}}}),System.register("gui/screen/game/gameMenu/ConInfoForm",["react","gui/component/CountryIcon","game/gameopts/constants","network/gamestate/PlayerConnectionStatus","network/gservConfig","gui/component/Chat"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){S("ConInfoForm",({strings:S,conInfos:O,players:_,localPlayer:U,messages:H,chatHistory:V,onSendMessage:W})=>{let[z,K]=B.useState(()=>Math.floor((D.TURN_TIMEOUT_MILLIS-D.LAG_STATE_THRESH_MILLIS-D.CON_INFO_THRESH_MILLIS)/1e3));return B.useEffect(()=>{let S=setInterval(()=>K(Math.max(0,z-1)),1e3);return()=>clearInterval(S)},[z]),B.default.createElement("div",{className:"con-info-form"},B.default.createElement("div",{className:"con-info-form-content"},B.default.createElement("table",null,B.default.createElement("thead",null,B.default.createElement("tr",null,B.default.createElement("th",null),B.default.createElement("th",{className:"player-name"},S.get("GUI:Player")),B.default.createElement("th",{className:"player-ping"},S.get("GUI:Ping")),B.default.createElement("th",{className:"player-time"},S.get("GUI:Time")))),B.default.createElement("tbody",null,_.filter(S=>!S.isAi).map(S=>{var D=O?.find(O=>O.name===S.name);return B.default.createElement("tr",{key:S.name,style:{color:S.color.asHexString(),opacity:D&&D.status!==L.PlayerConnectionStatus.Connected?.5:1}},B.default.createElement("td",null,B.default.createElement(N.CountryIcon,{country:S.country?S.country.name:j.OBS_COUNTRY_NAME})),B.default.createElement("td",{className:"player-name"},S.name),B.default.createElement("td",{className:"player-ping"},B.default.createElement("meter",{value:D?.ping??1e3,max:1e3,low:150,high:500,optimum:0})),B.default.createElement("td",{className:"player-time"},D?Math.floor(D?.lagAllowanceMillis/1e3):void 0))})))),B.default.createElement("div",{className:"con-info-form-footer"},B.default.createElement("div",{className:"time-allowed"},S.get("TXT_TIME_ALLOWED",z)),B.default.createElement("div",{className:"chat"},B.default.createElement(F.Chat,{strings:S,messages:H,channels:[D.RECIPIENT_ALL,D.RECIPIENT_TEAM],chatHistory:V,userColors:new Map(_.map(S=>[S.name,S.color.asHexString()])),localUsername:U.name,onSendMessage:W}))))})}}}),System.register("gui/screen/game/gameMenu/ConnectionInfoScreen",["gui/jsx/jsx","gui/screen/game/gameMenu/ScreenType","gui/jsx/HtmlView","util/disposable/CompositeDisposable","gui/screen/game/gameMenu/ConInfoForm","gui/screen/game/GameMenuScreen","network/gameopt/LoadInfoParser"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){U=class extends F.GameMenuScreen{constructor(S,O){super(),this.strings=S,this.jsxRenderer=O,this.messages=[],this.disposables=new L.CompositeDisposable,this.handleChatMessage=S=>{this.messages.push(S),this.form.refresh()},this.handleConInfoUpdate=S=>{this.form.applyOptions(O=>{O.conInfos=(new _.LoadInfoParser).parse(S)})}}onEnter(S){if(this.params=S,this.controller.toggleContentAreaVisibility(!0),this.initView(S),S.gservCon.isOpen()){S.gservCon.onLoadInfo.subscribe(this.handleConInfoUpdate),this.disposables.add(()=>S.gservCon.onLoadInfo.unsubscribe(this.handleConInfoUpdate)),S.gservCon.requestLoadInfo();let O=setInterval(()=>{S.gservCon.isOpen()?S.gservCon.requestLoadInfo():this.disposables.dispose()},1e3);this.disposables.add(()=>clearInterval(O)),S.chatHistory.onNewMessage.subscribe(this.handleChatMessage),this.disposables.add(()=>{this.messages.length=0,S.chatHistory.onNewMessage.unsubscribe(this.handleChatMessage)})}this.messages.push({text:this.strings.get("GUI:ConnectingToPlayers")+"...\n"+this.strings.get("TXT_RECONNECT_HELP2")+" "+this.strings.get("TXT_RECONNECT_HELP2B")})}initView(S){var O=[{label:this.strings.get("GUI:AbortMission"),onClick:()=>{this.controller?.pushScreen(N.ScreenType.QuitConfirm,{onQuit:S.onQuit,onCancel:()=>{this.controller?.popScreen()}})}}];this.controller.setSidebarButtons(O),this.controller.showSidebarButtons();var[O]=this.jsxRenderer.render(B.jsx(j.HtmlView,{width:"100%",height:"100%",component:D.ConInfoForm,innerRef:S=>this.form=S,props:{players:S.players,localPlayer:S.localPlayer,strings:this.strings,messages:this.messages,chatHistory:S.chatHistory,onSendMessage:O=>{S.chatNetHandler.submitMessage(O.value,O.recipient)}}}));this.controller.setMainComponent(O),this.disposables.add(()=>this.form=void 0)}async onLeave(){this.params=void 0,this.controller.hideSidebarButtons(),this.controller.toggleContentAreaVisibility(!1),this.disposables.dispose()}async onStack(){this.controller.hideSidebarButtons()}onUnstack(){this.initView(this.params)}},S("ConnectionInfoScreen",U)}}}),System.register("gui/screen/game/gameMenu/DiploForm",["react","game/Alliances","game/gameopts/constants","gui/component/CountryIcon","gui/component/Chat","network/gservConfig","gui/component/PingIndicator","network/gamestate/PlayerConnectionStatus"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){S("DiploForm",({strings:S,playerInfos:O,localPlayer:H,taunts:V,singlePlayer:W,alliancesAllowed:z,gameModes:K,gameOpts:$,mapName:q,messages:Q,chatHistory:Z,conInfos:Y,onToggleTaunts:X,onToggleAlliance:J,onToggleChat:ee,onSendMessage:te,onCancelMessage:ie})=>{var re,se=S.get(K.getById($.gameMode).label),A=O=>O?S.get("TXT_ON"):S.get("TXT_OFF");return B.default.createElement("div",{className:"diplo-form"},B.default.createElement("div",{className:"players"},B.default.createElement("table",null,B.default.createElement("thead",null,B.default.createElement("tr",null,B.default.createElement("th",{className:"player-country"}),B.default.createElement("th",{className:"player-ping"}),B.default.createElement("th",{className:"player-name"},S.get("GUI:Player")),B.default.createElement("th",null,S.get("GUI:Allies")),!W&&B.default.createElement("th",null,S.get("GUI:Chat")),B.default.createElement("th",null,S.get("GUI:Kills")))),B.default.createElement("tbody",null,H&&B.default.createElement("tr",{style:{color:H.defeated?"grey":H.color.asHexString()}},B.default.createElement("td",{className:"player-country"},B.default.createElement(L.CountryIcon,{country:H.country?H.country.name:j.OBS_COUNTRY_NAME})),B.default.createElement("td",{className:"player-ping"},void 0!==(re=Y?.find(S=>S.name===H.name)?.ping)&&B.default.createElement(_.PingIndicator,{ping:re,strings:S})),B.default.createElement("td",{className:"player-name"},H.name),B.default.createElement("td",null),!W&&B.default.createElement("td",null),B.default.createElement("td",null,!H.isObserver||H.defeated?H.getUnitsKilled():void 0)),O.map((O,D)=>B.default.createElement("tr",{key:D,style:{color:O.player.defeated?"grey":O.player.color.asHexString()}},B.default.createElement("td",{className:"player-country"},B.default.createElement(L.CountryIcon,{country:O.player.country?O.player.country.name:j.OBS_COUNTRY_NAME})),B.default.createElement("td",{className:"player-ping"},(()=>{var N=Y?.find(S=>S.name===O.player.name);return void 0!==(N=N?.status===U.PlayerConnectionStatus.Connected?N?.ping:void 0)&&B.default.createElement(_.PingIndicator,{ping:N,strings:S})})()),B.default.createElement("td",{className:"player-name"},O.player.isAi?j.getAiDisplayName(O.player.aiDifficulty,S):O.player.name),B.default.createElement("td",null,(!H?.isObserver||H.defeated)&&B.default.createElement("input",{type:"checkbox",name:"alliance",className:O.alliance?.status===N.AllianceStatus.Requested?O.alliance.players.first===H?"semi-checked-left":"semi-checked-right":void 0,disabled:!z||!O.allianceToggleable||!O.player.isCombatant(),checked:O.alliance?.status===N.AllianceStatus.Formed,onChange:()=>J(O.player,!(O.alliance?.status===N.AllianceStatus.Formed||O.alliance?.status===N.AllianceStatus.Requested&&O.alliance.players.first===H))})),!W&&B.default.createElement("td",null,!O.player.isAi&&B.default.createElement("input",{type:"checkbox",name:"mute",checked:!O.muted,onChange:S=>ee(O.player,S.target.checked)})),B.default.createElement("td",null,!O.player.isObserver||O.player.defeated?O.player.getUnitsKilled():void 0)))))),B.default.createElement("div",{className:"diplo-form-footer"},B.default.createElement("div",{className:"game-settings"},B.default.createElement("div",null,S.get("TXT_MAP",q)),B.default.createElement("div",null,[S.get("GUI:GameType")+": "+se,S.get("GUI:ShortGame")+": "+A($.shortGame),S.get("GUI:CratesAppear")+": "+A($.cratesAppear),S.get("GUI:SuperWeaponsAllowed")+": "+A($.superWeapons),S.get("GUI:DestroyableBridges")+": "+A($.destroyableBridges),S.get("GUI:MultiEngineer")+": "+A($.multiEngineer),S.get("GUI:NoDogEngiKills")+": "+A($.noDogEngiKills)].join(", "))),!W&&B.default.createElement("div",{"data-r-tooltip":S.get("STT:TauntsOn")},B.default.createElement("label",null,B.default.createElement("input",{type:"checkbox",name:"taunts",checked:!!V,disabled:void 0===V,onChange:S=>X(S.target.checked)})," ",B.default.createElement("span",null,S.get("GUI:TauntsOn")))),!W&&Q&&Z&&H&&B.default.createElement("div",{className:"chat"},B.default.createElement(D.Chat,{localUsername:H.name,messages:Q,chatHistory:Z,channels:[F.RECIPIENT_ALL,F.RECIPIENT_TEAM],strings:S,userColors:new Map([H,...O.map(S=>S.player)].map(S=>[S.name,S.color.asHexString()])),onSendMessage:te,onCancelMessage:ie}))))})}}}),System.register("gui/screen/game/gameMenu/DiploScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/game/gameMenu/DiploForm","util/disposable/CompositeDisposable","gui/screen/game/GameMenuScreen","network/gameopt/LoadInfoParser"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class extends D.GameMenuScreen{constructor(S,O,B,N,j,D){super(),this.strings=S,this.jsxRenderer=O,this.renderer=B,this.gameModes=N,this.taunts=j,this.mutedPlayers=D,this.disposables=new L.CompositeDisposable,this.onFrame=S=>{(!this.lastUpdate||500<S-this.lastUpdate)&&(this.lastUpdate=S,this.updateForm())},this.handleConInfoUpdate=S=>{this.form.applyOptions(O=>{O.conInfos=(new F.LoadInfoParser).parse(S)})},this.updateForm=()=>{this.form.applyOptions(S=>{this.params&&(S.playerInfos=this.buildPlayerInfos(this.params.game,this.params.localPlayer),S.taunts=this.taunts.value,S.messages=this.params.chatHistory?.getAll())})}}onEnter(S){this.controller.toggleContentAreaVisibility(!0),this.initView(S),this.params=S,this.renderer.onFrame.subscribe(this.onFrame),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(this.onFrame));const O=S.chatHistory;O&&(O.onNewMessage.subscribe(this.updateForm),this.disposables.add(()=>O.onNewMessage.unsubscribe(this.updateForm)));const B=S.gservCon;if(B?.isOpen()){B.onLoadInfo.subscribe(this.handleConInfoUpdate),this.disposables.add(()=>B.onLoadInfo.unsubscribe(this.handleConInfoUpdate)),B.requestLoadInfo();let S=setInterval(()=>{B.isOpen()?B.requestLoadInfo():this.disposables.dispose()},1e4);this.disposables.add(()=>clearInterval(S))}}initView(S){var O=[{label:this.strings.get("GUI:ResumeMission"),isBottom:!0,onClick:S.onCancel}];this.controller.setSidebarButtons(O),this.controller.showSidebarButtons();var{localPlayer:L,isSinglePlayer:D,game:O}=S,[O]=this.jsxRenderer.render(B.jsx(N.HtmlView,{width:"100%",height:"100%",component:j.DiploForm,innerRef:S=>this.form=S,props:{playerInfos:this.buildPlayerInfos(O,L),localPlayer:L,gameOpts:O.gameOpts,gameModes:this.gameModes,taunts:D?void 0:this.taunts.value,singlePlayer:D,alliancesAllowed:!D&&O.rules.mpDialogSettings.alliesAllowed&&O.rules.mpDialogSettings.allyChangeAllowed,mapName:O.gameOpts.mapTitle,messages:S.chatHistory?.getAll(),chatHistory:S.chatHistory,onToggleTaunts:S=>this.taunts.value=S,onToggleAlliance:S.onToggleAlliance,onToggleChat:(S,O)=>{O?this.mutedPlayers.delete(S.name):this.mutedPlayers.add(S.name)},onSendMessage:S.onSendMessage,onCancelMessage:O=>O&&S.onCancel(),strings:this.strings}}));this.controller.setMainComponent(O),this.disposables.add(()=>this.form=void 0)}buildPlayerInfos(S,O){let B=O?S.alliances.filterByPlayer(O):void 0;return S.getNonNeutralPlayers().filter(S=>S!==O).map(N=>({player:N,muted:this.mutedPlayers.has(N.name),allianceToggleable:!!O&&S.alliances.canRequestAlliance(N)&&S.alliances.canFormAlliance(O,N),alliance:B?.find(S=>S.players.first===N||S.players.second===N)}))}async onLeave(){this.params=void 0,this.controller.hideSidebarButtons(),this.controller.toggleContentAreaVisibility(!1),this.disposables.dispose()}},S("DiploScreen",_)}}}),System.register("gui/screen/game/gameMenu/GameMenuController",["gui/screen/Controller"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.Controller{constructor(S){super(),this.hud=S,this.contentAreaVisible=!1}async goToScreenBlocking(...S){var[O,B]=S;return super.goToScreenBlocking(O,B)}goToScreen(...S){var[O,B]=S;return super.goToScreen(O,B)}async pushScreen(...S){var[O,B]=S;this.setMainComponent(),await super.pushScreen(O,B)}async popScreen(S){this.setMainComponent(),await super.popScreen(S)}async close(){for(;this.screenStack.length;)await this.popScreen()}setHud(S){this.hud=S}setSidebarButtons(S){this.sidebarButtons=S}showSidebarButtons(){if(void 0===this.sidebarButtons)throw new Error("Sidebar buttons should be set first");this.hud.showSidebarMenu(this.sidebarButtons)}hideSidebarButtons(){this.sidebarButtons=void 0,this.hud.hideSidebarMenu()}setMainComponent(S){this.mainContentComponent=S,this.hud.setMenuContentComponent(this.mainContentComponent)}toggleContentAreaVisibility(S){this.contentAreaVisible=S,this.hud.toggleMenuContentVisibility(S)}rerenderCurrentScreen(){super.rerenderCurrentScreen(),this.sidebarButtons&&this.hud.showSidebarMenu(this.sidebarButtons),this.hud.setMenuContentComponent(this.mainContentComponent),this.hud.toggleMenuContentVisibility(this.contentAreaVisible)}destroy(){super.destroy(),this.setMainComponent(void 0)}},S("GameMenuController",N)}}}),System.register("gui/screen/game/gameMenu/GameMenuHomeScreen",["gui/screen/game/gameMenu/ScreenType","gui/FullScreen","gui/screen/options/component/getHumanReadableKey","gui/screen/game/GameMenuScreen"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends L.GameMenuScreen{constructor(S,O){super(),this.strings=S,this.fullScreen=O}onEnter(S){this.params=S,this.controller.toggleContentAreaVisibility(!0),this.initView(S)}initView(S){let O=this.strings;var L=[{label:O.get("GUI:Options"),onClick:()=>{this.controller?.pushScreen(B.ScreenType.Options)}},{label:O.get("GUI:Fullscreen",j.getHumanReadableKey(N.FullScreen.hotKey)),tooltip:O.get("STT:Fullscreen"),disabled:!this.fullScreen.isAvailable(),onClick:()=>this.fullScreen.toggle()},{label:O.get("GUI:AbortMission"),onClick:()=>{this.controller?.pushScreen(B.ScreenType.QuitConfirm,this.params)}},{label:O.get("GUI:ResumeMission"),isBottom:!0,onClick:S.onCancel}];this.controller.setSidebarButtons(L),this.controller.showSidebarButtons()}async onLeave(){this.controller.hideSidebarButtons(),this.controller.toggleContentAreaVisibility(!1)}async onStack(){this.controller.hideSidebarButtons()}onUnstack(){this.initView(this.params)}},S("GameMenuHomeScreen",D)}}}),System.register("gui/screen/game/gameMenu/QuitConfirmScreen",["gui/screen/game/GameMenuScreen"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=class extends B.GameMenuScreen{constructor(S){super(),this.strings=S}onEnter(S){this.initView(S)}initView(S){let O=this.strings;var B=[{label:O.get("GUI:Quit"),onClick:S.onQuit},...S.observeAllowed?[{label:O.get("GUI:Observe"),onClick:S.onObserve}]:[],{label:O.get("GUI:ResumeMission"),isBottom:!0,onClick:S.onCancel}];this.controller.setSidebarButtons(B),this.controller.showSidebarButtons()}async onLeave(){this.controller.hideSidebarButtons()}},S("QuitConfirmScreen",N)}}}),System.register("gui/screen/game/gameMenu/ScreenParamsMap",["gui/screen/game/gameMenu/ScreenType"],function(S,O){"use strict";return O&&O.id,{setters:[function(S){}],execute:function(){}}}),System.register("gui/screen/game/gameMenu/ScreenType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("ScreenType",B={}))[O.Home=0]="Home",O[O.Diplo=1]="Diplo",O[O.ConnectionInfo=2]="ConnectionInfo",O[O.QuitConfirm=3]="QuitConfirm",O[O.Options=4]="Options",O[O.OptionsSound=5]="OptionsSound",O[O.OptionsKeyboard=6]="OptionsKeyboard"}}}),System.register("gui/screen/game/loadingScreen/LoadingScreen",["react","network/gamestate/PlayerConnectionStatus","gui/component/CountryIcon","game/gameopts/constants","gui/component/TeamSelect"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=(new Map).set("Americans","Name:Para").set("French","Name:GTGCAN").set("Germans","Name:TNKD").set("British","Name:SNIPE").set("Russians","Name:TTNK").set("Confederation","Name:TERROR").set("Africans","Name:DTRUCK").set("Arabs","Name:DESO").set("Alliance","Name:BEAGLE"),_=(new Map).set("Americans","LoadBrief:USA").set("French","LoadBrief:French").set("Germans","LoadBrief:Germans").set("British","LoadBrief:British").set("Russians","LoadBrief:Russia").set("Confederation","LoadBrief:Cuba").set("Africans","LoadBrief:Lybia").set("Arabs","LoadBrief:Iraq").set("Alliance","LoadBrief:Korea"),U=class extends B.default.Component{render(){let S=this.props.playerInfos;var O=this.props.countryName,N=this.props.color;let j=1<S.length&&S.every(S=>!S.country||S.team!==L.NO_TEAM_ID);var D=_.get(O),U=F.get(O);let H=this.props.strings;return B.default.createElement("div",{className:"loading-screen",style:this.getStyle(this.props.bgImageSrc)},U?B.default.createElement("div",{className:"special-unit-name"},H.get(U)):null,D?B.default.createElement("div",{className:"briefing-text",style:{color:N}},H.get(D)):null,B.default.createElement("div",{className:"loading-text",style:{color:N}},H.get("GUI:LoadingEx")),B.default.createElement("div",{className:"player-status-container"},S?S.map(S=>this.renderStatus(S,j)):null),B.default.createElement("div",{style:{color:N},className:"country-name"},this.props.strings.get(this.props.countryUiNames.get(O)||O)),B.default.createElement("div",{style:{color:N},className:"map-name"},this.props.mapName))}renderStatus(S,O){var F=S.status===N.PlayerConnectionStatus.Connected?1:.5;return B.default.createElement("div",{key:S.name,className:"player-status",style:{opacity:F,color:S.color}},O&&B.default.createElement("span",{className:"player-team"},void 0!==S.country&&this.props.strings.get("GUI:TeamNo",D.formatTeamId(S.team))),B.default.createElement("progress",{value:""+S.loadPercent,max:100}),B.default.createElement(j.CountryIcon,{country:S.country?S.country.name:L.OBS_COUNTRY_NAME}),B.default.createElement("span",{className:"player-name"},S.name))}getStyle(S){var O=this.props.viewport;return{backgroundImage:S?`url(${S})`:void 0,backgroundSize:"cover",width:O.width+"px",height:O.height+"px",position:"absolute",left:O.x,top:O.y}}},S("LoadingScreen",U)}}}),System.register("gui/screen/game/loadingScreen/LoadingScreenApi",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("gui/screen/game/loadingScreen/LoadingScreenApiFactory",["network/gameopt/LoadInfoParser","gui/screen/game/loadingScreen/MpLoadingScreenApi","gui/screen/game/loadingScreen/ReplayLoadingScreenApi","gui/screen/game/loadingScreen/SpLoadingScreenApi"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){var O;(O=D||S("LoadingScreenType",D={}))[O.SinglePlayer=0]="SinglePlayer",O[O.MultiPlayer=1]="MultiPlayer",O[O.Replay=2]="Replay",S("LoadingScreenApiFactory",class{constructor(S,O,B,N,j,L){this.rules=S,this.strings=O,this.uiScene=B,this.jsxRenderer=N,this.gameResConfig=j,this.gservCon=L}create(S){var{rules:O,strings:F,uiScene:_,jsxRenderer:U,gameResConfig:H,gservCon:V}=this;switch(S){case D.SinglePlayer:return new L.SpLoadingScreenApi(O,F,_,U,H);case D.MultiPlayer:var W=new B.LoadInfoParser;return new N.MpLoadingScreenApi(V,W,O,F,_,U,H);case D.Replay:return new j.ReplayLoadingScreenApi(O,F,_,U,H);default:throw new Error(`Unsupported loading screen type "${S}"`)}}})}}}),System.register("gui/screen/game/loadingScreen/LoadingScreenWrapper",["gui/jsx/jsx","gui/HtmlContainer","gui/jsx/UiComponent","gui/UiObject","gui/jsx/HtmlView","gui/screen/game/loadingScreen/LoadingScreen","game/gameopts/constants","game/SideType"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){H=(new Map).set("Americans","ls800ustates.png").set("French","ls800france.png").set("Germans","ls800germany.png").set("British","ls800ukingdom.png").set("Russians","ls800russia.png").set("Confederation","ls800cuba.png").set("Africans","ls800libya.png").set("Arabs","ls800iraq.png").set("Alliance","ls800korea.png").set(_.OBS_COUNTRY_NAME,"ls800obs.png"),V=class extends j.UiComponent{createUiObject({playerName:S,gameResConfig:O}){var B,j=new L.UiObject(new THREE.Object3D,new N.HtmlContainer),D=S?this.props.playerInfos.find(O=>O.name===S):void 0,F=D?.country?D.country.name:_.OBS_COUNTRY_NAME;this.countryName=F;let V=D?.color??"#fff";D?.country&&(B=D.country.side===U.SideType.GDI?"AlliedLoad":"SovietLoad",V=this.props.rules.colors.get(B)?.asHexString()??"#fff"),this.color=V;let W=H.get(F);return W?O.isCdn()?this.bgHtmlImg=O.getCdnBaseUrl()+"ls/"+W:(this.bgSpriteImg=W?.replace("png","shp"),this.bgSpritePal=D?.country?"mpls.pal":"mplsobs.pal"):console.warn("Missing loading image for country "+F),j}defineChildren(){let S=this.props.rules.getMultiplayerCountries();var O=this.props.viewport;return B.jsx("fragment",null,this.props.gameResConfig.isCdn()?[]:B.jsx("sprite",{image:this.bgSpriteImg,palette:this.bgSpritePal,x:O.x,y:O.y,ref:S=>this.sprite=S}),B.jsx(D.HtmlView,{innerRef:S=>this.htmlEl=S,component:F.LoadingScreen,props:{viewport:this.props.viewport,countryUiNames:new Map([[_.OBS_COUNTRY_NAME,_.OBS_COUNTRY_UI_NAME]].concat(S.map(S=>[S.name,S.uiName]))),strings:this.props.strings,countryName:this.countryName,mapName:this.props.mapName,color:this.color,playerInfos:this.props.playerInfos,bgImageSrc:this.bgHtmlImg}}))}updateViewport(S){this.htmlEl?.applyOptions(O=>O.viewport=S),this.sprite?.setPosition(S.x,S.y)}applyOptions(S){this.htmlEl?.applyOptions(S)}},S("LoadingScreenWrapper",V)}}}),System.register("gui/screen/game/loadingScreen/MpLoadingScreenApi",["gui/jsx/jsx","game/gameopts/constants","util/disposable/CompositeDisposable","gui/screen/game/loadingScreen/LoadingScreenWrapper"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("MpLoadingScreenApi",class{constructor(S,O,B,N,L,D,F){this.gservCon=S,this.loadInfoParser=O,this.rules=B,this.strings=N,this.uiScene=L,this.jsxRenderer=D,this.gameResConfig=F,this.lastLoadPercent=0,this.disposables=new j.CompositeDisposable,this.handleLoadInfoUpdate=S=>{let O=this.loadInfoParser.parse(S);this.loadingScreen?this.loadingScreen.applyOptions(S=>{S.playerInfos=this.createExtendedLoadingInfos(O)}):this.createLoadingScreen(O)}}async start(S,O,B){if(this.gservCon.isOpen()){this.players=S,this.localPlayerName=B,this.mapName=O,this.gservCon.onLoadInfo.subscribe(this.handleLoadInfoUpdate),this.disposables.add(()=>this.gservCon.onLoadInfo.unsubscribe(this.handleLoadInfoUpdate)),this.gservCon.requestLoadInfo();let N=setInterval(()=>{this.gservCon.isOpen()?this.gservCon.requestLoadInfo():this.disposables.dispose()},1e4);this.disposables.add(()=>clearInterval(N))}}onLoadProgress(S){(S=Math.floor(S))>this.lastLoadPercent&&(this.lastLoadPercent=S,this.gservCon.isOpen()&&this.gservCon.sendLoadedPercent(S))}createExtendedLoadingInfos(S){let O=[...this.rules.getMultiplayerColors().values()],B=this.rules.getMultiplayerCountries(),j=this.players?.every(S=>S.countryId===N.OBS_COUNTRY_ID||S.teamId!==N.NO_TEAM_ID);return S.map(S=>{var j=this.players.find(O=>O.name===S.name);return{name:S.name,status:S.status,loadPercent:S.loadPercent,country:B[j.countryId],color:j.countryId===N.OBS_COUNTRY_ID?"#fff":O[j.colorId].asHexString(),team:j.teamId}}).sort((S,O)=>j?Boolean(S.country)===Boolean(O.country)?S.team-O.team:Number(void 0!==O.country)-Number(void 0!==S.country):0)}createLoadingScreen(S){let[O]=this.jsxRenderer.render(B.jsx(L.LoadingScreenWrapper,{ref:S=>this.loadingScreen=S,strings:this.strings,rules:this.rules,viewport:this.uiScene.menuViewport,playerName:this.localPlayerName,mapName:this.mapName,playerInfos:this.createExtendedLoadingInfos(S),gameResConfig:this.gameResConfig}));this.uiScene.add(O),this.disposables.add(O,()=>this.uiScene.remove(O),()=>this.loadingScreen=void 0)}dispose(){this.disposables.dispose()}updateViewport(){this.loadingScreen?.updateViewport(this.uiScene.menuViewport)}})}}}),System.register("gui/screen/game/loadingScreen/ReplayLoadingScreenApi",["gui/jsx/jsx","game/gameopts/constants","util/disposable/CompositeDisposable","network/gamestate/PlayerConnectionStatus","gui/screen/game/loadingScreen/LoadingScreenWrapper"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){S("ReplayLoadingScreenApi",class{constructor(S,O,B,N,L){this.rules=S,this.strings=O,this.uiScene=B,this.jsxRenderer=N,this.gameResConfig=L,this.lastLoadPercent=0,this.disposables=new j.CompositeDisposable,this.handleLoadInfoUpdate=S=>{var O;this.loadingScreen?(O=performance.now(),(!this.lastRenderTime||O-this.lastRenderTime>1e3/15)&&(this.lastRenderTime=O,this.loadingScreen.applyOptions(O=>{O.playerInfos=this.createExtendedLoadingInfos(S)}))):this.createLoadingScreen(S)}}async start(S,O){this.players=S,this.mapName=O,this.handleLoadInfoUpdate(0)}onLoadProgress(S){(S=Math.floor(S))>this.lastLoadPercent&&(this.lastLoadPercent=S,this.handleLoadInfoUpdate(S))}createExtendedLoadingInfos(S){let O=[...this.rules.getMultiplayerColors().values()],B=this.rules.getMultiplayerCountries(),j=this.players?.every(S=>S.countryId===N.OBS_COUNTRY_ID||S.teamId!==N.NO_TEAM_ID);return this.players.filter(S=>S.countryId!==N.OBS_COUNTRY_ID).map(N=>({name:N.name,status:L.PlayerConnectionStatus.Connected,loadPercent:S,country:B[N.countryId],color:O[N.colorId].asHexString(),team:N.teamId})).sort((S,O)=>j?Boolean(S.country)===Boolean(O.country)?S.team-O.team:Number(void 0!==O.country)-Number(void 0!==S.country):0)}createLoadingScreen(S){let[O]=this.jsxRenderer.render(B.jsx(D.LoadingScreenWrapper,{ref:S=>this.loadingScreen=S,strings:this.strings,rules:this.rules,viewport:this.uiScene.menuViewport,playerName:void 0,mapName:this.mapName,playerInfos:this.createExtendedLoadingInfos(S),gameResConfig:this.gameResConfig}));this.uiScene.add(O),this.disposables.add(O,()=>this.uiScene.remove(O),()=>this.loadingScreen=void 0)}dispose(){this.disposables.dispose()}updateViewport(){this.loadingScreen?.updateViewport(this.uiScene.menuViewport)}})}}}),System.register("gui/screen/game/loadingScreen/SpLoadingScreenApi",["gui/jsx/jsx","game/gameopts/constants","util/disposable/CompositeDisposable","network/gamestate/PlayerConnectionStatus","gui/screen/game/loadingScreen/LoadingScreenWrapper"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){S("SpLoadingScreenApi",class{constructor(S,O,B,N,L){this.rules=S,this.strings=O,this.uiScene=B,this.jsxRenderer=N,this.gameResConfig=L,this.lastLoadPercent=0,this.disposables=new j.CompositeDisposable,this.handleLoadInfoUpdate=S=>{var O;this.loadingScreen?(O=performance.now(),(!this.lastRenderTime||O-this.lastRenderTime>1e3/15)&&(this.lastRenderTime=O,this.loadingScreen.applyOptions(O=>{O.playerInfos=this.createExtendedLoadingInfos(S)}))):this.createLoadingScreen()}}async start(S,O,B){this.players=S,this.localPlayerName=B,this.mapName=O,this.handleLoadInfoUpdate(0)}onLoadProgress(S){(S=Math.floor(S))>this.lastLoadPercent&&(this.lastLoadPercent=S,this.handleLoadInfoUpdate(S))}createExtendedLoadingInfos(S){let O=[...this.rules.getMultiplayerColors().values()];var B=this.rules.getMultiplayerCountries(),j=this.players.find(S=>S.name===this.localPlayerName);return[{name:this.localPlayerName,status:L.PlayerConnectionStatus.Connected,loadPercent:S,country:B[j.countryId],color:j.countryId===N.OBS_COUNTRY_ID?"#fff":O[j.colorId].asHexString(),team:j.teamId}]}createLoadingScreen(){let[S]=this.jsxRenderer.render(B.jsx(D.LoadingScreenWrapper,{ref:S=>this.loadingScreen=S,strings:this.strings,rules:this.rules,viewport:this.uiScene.menuViewport,playerName:this.localPlayerName,mapName:this.mapName,playerInfos:this.createExtendedLoadingInfos(0),gameResConfig:this.gameResConfig}));this.uiScene.add(S),this.disposables.add(S,()=>this.uiScene.remove(S))}dispose(){this.disposables.dispose()}updateViewport(){this.loadingScreen?.updateViewport(this.uiScene.menuViewport)}})}}}),System.register("gui/screen/game/worldInteraction/ArrowScrollHandler",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("ArrowScrollHandler",class{constructor(S){this.mapScrollHandler=S,this.isPaused=!1,this.scrollDir=new THREE.Vector2,this.pressedKeys=new Set}handleKeyDown(S){!this.isPaused&&["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(S.key)&&(S.preventDefault(),S.stopPropagation(),S.repeat||(this.pressedKeys.add(S.key),this.updateScrollDir(),this.mapScrollHandler.requestForceScroll(this.scrollDir)))}handleKeyUp(S){["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(S.key)&&(S.preventDefault(),S.stopPropagation(),this.pressedKeys.delete(S.key),this.updateScrollDir(),this.scrollDir.length()||this.mapScrollHandler.cancelForceScroll())}cancel(){this.pressedKeys.clear(),this.updateScrollDir(),this.scrollDir.length()||this.mapScrollHandler.cancelForceScroll()}updateScrollDir(){for(var S of(this.scrollDir.set(0,0),this.pressedKeys))switch(S){case"ArrowUp":--this.scrollDir.y;break;case"ArrowDown":this.scrollDir.y+=1;break;case"ArrowLeft":--this.scrollDir.x;break;case"ArrowRight":this.scrollDir.x+=1;break;default:throw new Error("Should never reach this line")}}pause(){this.isPaused=!0}unpause(){this.isPaused=!1}})}}}),System.register("gui/screen/game/worldInteraction/BeaconMode",["engine/type/PointerType","util/event"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("BeaconMode",class{get onExecute(){return this._onExecute.asEvent()}static factory(S,O){return new this(S,O)}constructor(S,O){this.pointer=S,this.renderer=O,this._onExecute=new N.EventDispatcher,this.onFrame=S=>{var O;(this.lastTile!==this.currentTile||!this.lastUpdate||S-this.lastUpdate>=1e3/15)&&(this.lastTile=this.currentTile,this.lastUpdate=S,O=this.currentTile,this.pointer.setPointerType(O?B.PointerType.Beacon:B.PointerType.Default))}}enter(){this.currentTile=void 0,this.lastTile=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}hover(S,O){O||(this.currentTile=S?.tile)}execute(S,O){if(O)return!1;var B=S?.tile;if(!B)return!1;this._onExecute.dispatch(this,B),this.end()}cancel(){this.end()}end(){this.renderer.onFrame.unsubscribe(this.onFrame)}dispose(){this.end()}})}}}),System.register("gui/screen/game/worldInteraction/CameraPanHandler",["util/geometry","engine/type/PointerType","util/math"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("CameraPanHandler",class{constructor(S,O,L,D,F){this.cameraPan=S,this.pointer=O,this.panRate=L,this.freeCamera=D,this.worldScene=F,this.isPanning=!1,this.paused=!1,this.stickyMode=!1,this.onFrame=S=>{if(!this.paused&&this.isPanning&&(!this.lastUpdate||S-this.lastUpdate>=1e3/60))if(this.lastUpdate=S,this.panVector.x||this.panVector.y){var O=this.stickyMode?this.initialPan:this.cameraPan.getPan(),L=this.cameraPan.getPanLimits();let S={x:j.clamp(O.x+this.panVector.x,L.x,L.x+L.width),y:j.clamp(O.y+this.panVector.y,L.y,L.y+L.height)};this.freeCamera.value&&(S={x:O.x+this.panVector.x,y:O.y+this.panVector.y});var D=!B.pointEquals(S,O);L=this.panVector.x&&S.x===O.x,O=this.panVector.y&&S.y===O.y;let F=0;if(L||O){let S=new THREE.Vector2(L?Math.sign(this.panVector.x):0,O?Math.sign(this.panVector.y):0);F=1+(THREE.Math.radToDeg(S.angle())+90)%360/45}this.pointer.setPointerType(N.PointerType.Pan,F),D&&this.cameraPan.setPan({x:S.x,y:S.y}),this.isPanning=D}else this.pointer.setPointerType(N.PointerType.Pan)}}start(S){this.startPos=S,this.isPanning=!1,this.panVector=new THREE.Vector2(0,0),this.worldScene.onBeforeCameraUpdate.subscribe(this.onFrame)}update(S,O){var B;O?(this.initialPan||(this.initialPan=this.cameraPan.getPan()),this.panVector.x=this.startPos.x-S.x,this.panVector.y=this.startPos.y-S.y):(B=this.panRate.value/5*100,this.panVector.x=Math.floor(B*j.clamp(S.x-this.startPos.x,-600,600)/600),this.panVector.y=Math.floor(B*j.clamp(S.y-this.startPos.y,-600,600)/600)),this.isPanning=!0,this.stickyMode=O}finish(){this.worldScene.onBeforeCameraUpdate.unsubscribe(this.onFrame),this.pointer.setPointerType(N.PointerType.Default),this.initialPan=void 0}setPaused(S){this.paused=S}dispose(){this.finish()}})}}}),System.register("gui/screen/game/worldInteraction/CustomScrollHandler",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("CustomScrollHandler",class{constructor(S){this.mapScrollHandler=S,this.isPaused=!1}requestScroll(S){this.isPaused||this.mapScrollHandler.requestForceScroll(S)}cancel(){this.mapScrollHandler.cancelForceScroll()}pause(){this.isPaused=!0}unpause(){this.isPaused=!1}})}}}),System.register("gui/screen/game/worldInteraction/DefaultActionHandler",["engine/type/PointerType","game/Coords","util/typeGuard","util/event","game/order/MoveOrder","game/order/orderPriorities","game/order/OrderFactory","game/order/AttackOrder","game/Target","game/order/AttackMoveOrder","game/order/OrderFeedbackType","game/order/GuardAreaOrder"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S}],execute:function(){var O;K=class{constructor(S,O,N,j=!1){this.game=S,this.unitSelectionHandler=O,this.currentPlayer=N,this.toggleSelect=j,this.force=!1,this.allowTypeSelect=!1,this.getPointerType=()=>B.PointerType.Select,this.isAllowed=()=>!0}setForce(S){return this.force=S,this}setTypeSelect(S){return this.allowTypeSelect=S,this}isValidTarget(S){if(!S?.isTechno())return!1;if(this.currentPlayer&&(S.isInfantry()||S.isVehicle())&&S.disguiseTrait?.hasTerrainDisguise()&&!this.game.alliances.haveSharedIntel(this.currentPlayer,S.owner))return!1;let O=this.unitSelectionHandler.getSelectedUnits();return!(!this.toggleSelect&&O.some(S=>S.isUnit())&&this.currentPlayer&&!this.currentPlayer.isObserver&&S.isTechno()&&!this.game.areFriendly(S,O[0])&&O[0].owner===this.currentPlayer)&&S.rules.selectable&&(this.toggleSelect||this.force||this.allowTypeSelect&&1===O.length&&O[0]===S||!O.includes(S))}execute(S){if(this.allowTypeSelect){var O=this.unitSelectionHandler.getSelectedUnits();if(1===O.length&&O[0]===S)return void this.unitSelectionHandler.selectByType()}this.toggleSelect?this.unitSelectionHandler.toggleSelection(S):this.unitSelectionHandler.selectSingleUnit(S)}},(O=$||S("ActionFilter",$={}))[O.All=0]="All",O[O.SelectOnly=1]="SelectOnly",O[O.NoSelect=2]="NoSelect",S("DefaultActionHandler",class{get onOrder(){return this._onOrder.asEvent()}static factory(S,O,B,N,j,L,H){let W=new this(S,N,H,j.tileOccupation);var $=new K(L,B,N);return W.selectAction=$,N&&!N.isObserver?(W.defaultActions=[...F.orderPriorities.map(S=>new _.OrderFactory(L,j).create(S,O)),$,new D.MoveOrder(L,j,O)],W.selectToggleAction=new K(L,B,N,!0),W.forceMoveAction=new D.MoveOrder(L,j,O,!0),W.forceAttackAction=new U.AttackOrder(L,{forceAttack:!0}),W.attackMoveAction=new V.AttackMoveOrder(L,j),W.guardAreaAction=new z.GuardAreaOrder(L,!0),W.specialActions=[W.selectToggleAction,W.forceMoveAction,W.forceAttackAction,W.attackMoveAction,W.guardAreaAction]):(W.defaultActions=[$],W.specialActions=[]),W}constructor(S,O,B,N){this.renderableManager=S,this.currentPlayer=O,this.audioVisualRules=B,this.tileOccupation=N,this._onOrder=new L.EventDispatcher}createOrderTarget(S){return new H.Target(S.gameObject,S.tile,this.tileOccupation)}getDefaultAction(S,O,B,N,j,L,D,F,_){var U=B.gameObject;let H=this.selectAction;if(H.setForce(L).setTypeSelect(!1),!S||S.owner!==this.currentPlayer||S.rules.spawned)return!_&&j!==$.NoSelect&&H.isValidTarget(U)?H:void 0;if(j!==$.NoSelect&&!_&&F?.shiftKey&&!F?.ctrlKey&&this.selectToggleAction?.isValidTarget(U))return this.selectToggleAction;if(j===$.SelectOnly)return!_&&H.setTypeSelect(D).isValidTarget(U)?H:void 0;var V,W=O.every(S=>S.warpedOutTrait.isActive());if(F?.ctrlKey&&!W)if(F.shiftKey){if(this.attackMoveAction?.set(S,N).isValid())return this.attackMoveAction}else if(F.altKey){if(this.guardAreaAction?.set(S,N).isValid())return this.guardAreaAction}else if(this.forceAttackAction?.set(S,N).isValid())return this.forceAttackAction;if(F?.altKey&&!W&&this.forceMoveAction?.set(S,N).isValid())return this.forceMoveAction;for(V of this.defaultActions.values())if(V instanceof K){if(j!==$.NoSelect&&!_&&V.setForce(L).setTypeSelect(!1).isValidTarget(U))return V}else if(!W&&(!_||V.minimapAllowed)&&!(V.singleSelectionRequired&&1<O.length)&&V.set(S,N).isValid())return V;return _&&!W&&this.forceMoveAction?.set(S,N).isValid()?this.forceMoveAction:void 0}updateMostSignificantAction(S,O,B,N,L,D,F,_){if(!S.length)return this.getDefaultAction(void 0,S,O,B,N,L,D,F,_);let U=S.map(j=>{var U=this.getDefaultAction(j,S,O,B,N,L,D,F,_);if(U)return{unit:j,action:U}}).filter(j.isNotNullOrUndefined),H=[...this.specialActions.values()];return U.length?U.reduce((S,O)=>!S||H.includes(O.action)||this.defaultActions.indexOf(O.action)<this.defaultActions.indexOf(S)||!(S instanceof K)&&S.sourceObject.rules.leadershipRating<O.unit.rules.leadershipRating&&this.defaultActions.indexOf(O.action)===this.defaultActions.indexOf(S)?O.action instanceof K?O.action:O.action.set(O.unit,B):S,void 0):void 0}getPointerType(S){if(this.mostSignificantAction instanceof K)return this.mostSignificantAction.getPointerType();if(!this.currentSelected||!this.mostSignificantAction)return S?B.PointerType.Mini:B.PointerType.Default;if(!this.mostSignificantAction.isAllowed()){var O,N=this.mostSignificantAction.sourceObject;for(O of this.currentSelected)if(this.mostSignificantAction.set(O,this.currentTarget),this.mostSignificantAction.isValid()&&this.mostSignificantAction.isAllowed())return this.mostSignificantAction.getPointerType(S,this.currentSelected);this.mostSignificantAction.set(N,this.currentTarget)}return this.mostSignificantAction.getPointerType(S,this.currentSelected)}update(S,O,B,N,j=!1){var L=this.currentTarget=this.createOrderTarget(S);this.currentSelected=O,this.mostSignificantAction=this.updateMostSignificantAction(O,S,L,$.All,B,!1,N,j)}execute(S,O,B,j,L,F,_=!1){let U=this.currentTarget=this.createOrderTarget(S);if(this.currentSelected=O,this.mostSignificantAction=this.updateMostSignificantAction(O,S,U,B,j,L,F,_),this.mostSignificantAction){var H=this.mostSignificantAction.isAllowed();return H&&(this.mostSignificantAction instanceof D.MoveOrder||this.mostSignificantAction instanceof V.AttackMoveOrder&&!U.obj?.isTechno()||this.mostSignificantAction instanceof z.GuardAreaOrder?this.renderableManager.createTransientAnim(this.audioVisualRules.moveFlash,S=>{S.setPosition(N.Coords.tile3dToWorld(U.tile.rx+.5,U.tile.ry+.5,U.tile.z+(U.getBridge()?.tileElevation??0)))}):this.mostSignificantAction instanceof K||O.includes(S.gameObject)||S.entity?.highlight?.()),this.mostSignificantAction instanceof K?this.mostSignificantAction.execute(S.gameObject):this._onOrder.dispatch(this,{orderType:this.mostSignificantAction.orderType,terminal:this.mostSignificantAction.terminal,feedbackType:H?this.mostSignificantAction.feedbackType:W.OrderFeedbackType.None,feedbackUnit:H?this.mostSignificantAction.sourceObject:void 0,target:U}),!0}return!1}})}}}),System.register("gui/screen/game/worldInteraction/InteractionMode",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("gui/screen/game/worldInteraction/MapHoverHandler",["util/event","game/Coords"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("MapHoverHandler",class{get onHoverChange(){return this._onHoverChange.asEvent()}constructor(S,O,N,j,L){this.entityIntersectHelper=S,this.mapTileIntersectHelper=O,this.map=N,this.shroud=j,this.renderer=L,this._onHoverChange=new B.EventDispatcher,this.isActive=!1,this.needsUpdate=!1,this.onFrame=S=>{this.isActive&&(this.needsUpdate||!this.lastUpdate||S-this.lastUpdate>=1e3/15)&&(this.needsUpdate=!1,this.lastUpdate=S,this.doUpdate())}}getCurrentHover(){if(this.currentHoverTile)return this.currentHoverEntity?.gameObject.isDestroyed||this.currentHoverEntity?.gameObject.isCrashing?{entity:void 0,gameObject:void 0,tile:this.currentHoverTile}:{entity:this.currentHoverEntity,gameObject:this.currentHoverEntity?.gameObject,tile:this.currentHoverTile}}setShroud(S){this.shroud=S}update(S,O=!1){this.lastPointerPos=S,O?this.doUpdate():this.isActive||(this.isActive=!0,this.needsUpdate=!0,this.renderer.onFrame.subscribe(this.onFrame))}doUpdate(){let S=this.currentHoverEntity;var O=this.currentHoverTile,B=this.entityIntersectHelper.getEntityAtScreenPoint(this.lastPointerPos);if(B){this.currentHoverEntity=B.renderable;let S,O=B.renderable.gameObject;var j=O.getFoundation();O.isBuilding()&&(1<j.width||1<j.height)?S=this.mapTileIntersectHelper.getTileAtScreenPoint(this.lastPointerPos):O.isTechno()&&!O.art.isVoxel?S=O.tile:(L=new THREE.Vector2(B.point.x,B.point.z).multiplyScalar(1/N.Coords.LEPTONS_PER_TILE).floor(),S=this.map.tiles.getByMapCoords(L.x,L.y),S||console.warn(`No tile exists at rx,ry="${JSON.stringify(L)}". Falling back to obj location.`)),S=S||O.tile;var L=this.map.tileOccupation.getBridgeOnTile(S);this.currentHoverEntity.gameObject.isOverlay()&&this.currentHoverEntity.gameObject.isBridge()&&!L&&(this.currentHoverEntity=void 0),this.currentHoverTile=S}else this.currentHoverEntity=void 0,L=this.mapTileIntersectHelper.getTileAtScreenPoint(this.lastPointerPos),this.currentHoverTile=L;!(this.shroud&&this.currentHoverTile&&this.shroud.isShrouded(this.currentHoverTile,this.currentHoverEntity?.gameObject.tileElevation))||this.currentHoverEntity?.gameObject.isOverlay()&&this.currentHoverEntity.gameObject.isBridge()||(this.currentHoverEntity=void 0),this.currentHoverEntity===S&&this.currentHoverTile===O||(S?.selectionModel?.setHover(!1),this.currentHoverEntity?.selectionModel?.setHover(!0),this.currentHoverTile&&this._onHoverChange.dispatch(this,{entity:this.currentHoverEntity,gameObject:this.currentHoverEntity?.gameObject,tile:this.currentHoverTile}))}finish(){this.currentHoverEntity?.selectionModel?.setHover(!1),this.currentHoverEntity=void 0,this.currentHoverTile=void 0,this.isActive&&(this.renderer.onFrame.unsubscribe(this.onFrame),this.isActive=!1,this.needsUpdate=!1)}dispose(){this.finish()}})}}}),System.register("gui/screen/game/worldInteraction/MapScrollHandler",["util/geometry","util/math","engine/type/PointerType"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("MapScrollHandler",class{constructor(S,O,L,D,F){this.canvas=S,this.cameraPan=O,this.pointer=L,this.scrollRate=D,this.worldScene=F,this.isActive=!1,this.paused=!1,this.forceScrollCancelRequested=!1,this.onFrame=S=>{if(!this.paused&&this.isActive&&(!this.lastUpdate||S-this.lastUpdate>=1e3/60)){this.lastUpdate=S;var O=this.cameraPan.getPan(),L=this.cameraPan.getPanLimits();let F,_=!1;(this.panDirection?.x||this.panDirection?.y)&&(D=this.scrollRate.value/5*10,F={x:N.clamp(O.x+this.panDirection.x*D,L.x,L.x+L.width),y:N.clamp(O.y+this.panDirection.y*D,L.y,L.y+L.height)},D=!B.pointEquals(F,O),this.pointer.setPointerType(D?j.PointerType.Scroll:j.PointerType.NoScroll,this.pointerFrameNo),D&&(_=!0));var D=this.forceScrollDirection;let U=!1;D&&(F={x:N.clamp(O.x+30*D.x,L.x,L.x+L.width),y:N.clamp(O.y+30*D.y,L.y,L.y+L.height)},B.pointEquals(F,O)||(U=!0)),this.isActive=_||U,F&&this.cameraPan.setPan({x:F.x,y:F.y}),this.isActive||this.worldScene.onBeforeCameraUpdate.unsubscribe(this.onFrame),this.forceScrollCancelRequested&&(this.forceScrollCancelRequested=!1,this.forceScrollDirection=void 0)}}}isScrolling(){return!(!this.panDirection||!this.panDirection.x&&!this.panDirection.y)}requestForceScroll(S){this.forceScrollDirection=S,this.forceScrollCancelRequested=!1,this.isActive||(this.isActive=!0,this.worldScene.onBeforeCameraUpdate.subscribe(this.onFrame))}cancelForceScroll(){this.forceScrollCancelRequested=!0}update(S){var O=this.canvas.height,B=this.canvas.width;let N=S.x<3?-1:S.x>B-1-3?1:0,j=S.y<3?-1:S.y>O-1-3?1:0;N?S.y<Math.min(300,O/3)?j=-1:S.y>Math.max(O-300,2*O/3)&&(j=1):j&&(S.x<Math.min(300,B/3)?N=-1:S.x>Math.max(B-300,2*B/3)&&(N=1)),this.panDirection=new THREE.Vector2(N,j),this.pointerFrameNo=(THREE.Math.radToDeg(this.panDirection.angle())+90)%360/45,this.isActive||(this.isActive=!0,this.worldScene.onBeforeCameraUpdate.subscribe(this.onFrame))}cancel(){this.cancelForceScroll(),this.isActive&&(this.worldScene.onBeforeCameraUpdate.unsubscribe(this.onFrame),this.isActive=!1)}setPaused(S){this.paused=S}dispose(){this.cancel()}})}}}),System.register("gui/screen/game/worldInteraction/MinimapHandler",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("MinimapHandler",class{constructor(S,O,B,N,j){this.minimap=S,this.map=O,this.shroud=B,this.worldScene=N,this.mapPanningHelper=j}setShroud(S){this.shroud=S}panToTile(S){this.worldScene.cameraPan.setPan(this.mapPanningHelper.computeCameraPanFromTile(S.rx,S.ry))}getHover(S){return{entity:void 0,gameObject:this.shroud?.isShrouded(S)?void 0:this.map.getObjectsOnTile(S).sort((S,O)=>Number(S.isTechno())-Number(O.isTechno())).shift(),tile:S}}})}}}),System.register("gui/screen/game/worldInteraction/PendingPlacementHandler",["game/event/EventType","util/disposable/CompositeDisposable","gui/screen/game/worldInteraction/placementMode/PlacementGrid"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("PendingPlacementHandler",class{static factory(S,O,B,N){var j=S.getConstructionWorker(O);return new this(S,j,B,N)}constructor(S,O,B,j){this.game=S,this.constructionWorker=O,this.renderer=B,this.worldScene=j,this.placements=[],this.gridModels=new Map,this.grids=new Map,this.disposables=new N.CompositeDisposable,this.onFrame=()=>{for(var S of this.placements){let B=this.gridModels.get(S);var O;B&&(O=S.rules.name,B.tiles=this.constructionWorker.getPlacementPreview(O,S.tile,{normalizedTile:!0}))}}}pushPlacementInfo(S){this.placements.push(S),this.addGrid(S)}init(){this.renderer.onFrame.subscribe(this.onFrame),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(this.onFrame)),this.disposables.add(this.game.events.subscribe(B.EventType.BuildingPlace,S=>{this.removePendingPlacement(S.target.tile)}),this.game.events.subscribe(B.EventType.BuildingFailedPlace,S=>{this.removePendingPlacement(S.tile)}))}removePendingPlacement(S){var O=this.placements.findIndex(O=>O.tile===S),B=this.placements[O];-1!==O&&(this.placements.splice(O,1),this.removeGrid(B))}addGrid(S){var O={tiles:this.constructionWorker.getPlacementPreview(S.rules.name,S.tile,{normalizedTile:!0}),visible:!0,rangeIndicator:void 0,rangeIndicatorColor:void 0,showBusy:!0},B=new j.PlacementGrid(O,this.worldScene.camera,this.game.map.tiles);this.worldScene.add(B),this.gridModels.set(S,O),this.grids.set(S,B)}removeGrid(S){let O=this.grids.get(S);O&&(this.worldScene.remove(O),O.dispose(),this.gridModels.delete(S))}dispose(){for(var S of this.placements)this.removeGrid(S);this.disposables.dispose()}})}}}),System.register("gui/screen/game/worldInteraction/PlacementMode",["gui/screen/game/worldInteraction/placementMode/PlacementGrid","util/geometry","util/event","engine/type/ObjectType"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("PlacementMode",class{get onBuildingPlaceRequest(){return this._onBuildingPlaceRequest}static factory(S,O,N,j,L){var D=S.getConstructionWorker(O),F={tiles:[],visible:!1,rangeIndicator:void 0,rangeIndicatorColor:void 0};let _=new this(S,O,D,N,L,new B.PlacementGrid(F,j.camera,S.map.tiles),j);return _.placementGridModel=F,_}constructor(S,O,B,N,L,D,F){this.game=S,this.player=O,this.constrWorker=B,this.renderer=N,this.eva=L,this.placementGrid=D,this.worldScene=F,this.defenseMode=!1,this.buildingRanges=new Map,this._onBuildingPlaceRequest=new j.EventDispatcher,this.onFrame=S=>{(this.lastTile!==this.currentTile||!this.lastUpdate||S-this.lastUpdate>=1e3/15)&&(this.lastTile=this.currentTile,this.lastUpdate=S,this.currentBuilding&&this.updateGridModel(this.currentBuilding.name))}}init(){this.worldScene.add(this.placementGrid)}dispose(){this.worldScene.remove(this.placementGrid),this.placementGrid.dispose(),this.endConstrMode()}enter(){this.currentTile=void 0,this.lastTile=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}setBuilding(S){(this.currentBuilding=S).primary||S.hasRadialIndicator?(this.defenseMode=!0,this.prepareBuildingRanges(S)):this.defenseMode=!1}getBuilding(){return this.currentBuilding}hover(S,O){var B;O||(B=S?.tile)!==this.currentTile&&(this.currentTile=B)}updateGridModel(S){var O,B=this.currentTile;B?(O=this.constrWorker.getPlacementPreview(S,B),this.placementGridModel.tiles=O,this.placementGridModel.visible=!0,this.defenseMode?(this.showBuildingRangeOverlays(B,S),this.placementGridModel.rangeIndicator=this.getBuildingRangeCircle(B,S),this.placementGridModel.rangeIndicatorColor=this.player.color.asHex()):this.placementGridModel.rangeIndicator=void 0):this.placementGridModel.visible=!1}execute(S,O){if(!this.currentBuilding||O)return!1;var B=S?.tile;if(!B)return!1;if(this.player.production.isAvailableForProduction(this.currentBuilding)){if(!this.constrWorker.canPlaceAt(this.currentBuilding.name,B))return this.eva.play("EVA_CannotDeployHere"),!1;this._onBuildingPlaceRequest.dispatch(this,{rules:this.currentBuilding,tile:this.constrWorker.normalizePlacementTile(this.currentBuilding.name,B)}),this.endConstrMode()}else this.endConstrMode()}cancel(){this.endConstrMode()}endConstrMode(){this.defenseMode=!1,this.placementGridModel.visible=!1,this.hideBuildingRangeOverlays(),this.buildingRanges.clear(),this.currentBuilding=void 0,this.renderer.onFrame.unsubscribe(this.onFrame)}hideBuildingRangeOverlays(){this.buildingRanges.forEach((S,O)=>{O.showWeaponRange=!1})}showBuildingRangeOverlays(S,O){let B=this.getBuildingRangeCircle(S,O);this.buildingRanges.forEach((S,O)=>{O.showWeaponRange=N.circleIntersect(B,S)})}getBuildingRangeCircle(S,O){var B=this.game.art.getObject(O,L.ObjectType.Building).foundation;return{center:{x:S.rx+(B.width%2!=0?.5:0),y:S.ry+(B.height%2!=0?.5:0)},radius:this.currentRangeCircleRadius}}prepareBuildingRanges(S){let O=[...this.player.buildings].filter(O=>O.name===S.name);var B;S.psychicDetectionRadius?this.currentRangeCircleRadius=S.psychicDetectionRadius:S.gapGenerator?this.currentRangeCircleRadius=S.gapRadiusInCells:(B=S.primary)&&(this.currentRangeCircleRadius=this.game.rules.getWeapon(B).range),this.buildingRanges.clear(),O.forEach(S=>{var O=S.tile,B=this.game.art.getObject(S.name,L.ObjectType.Building).foundation;O={x:O.rx+B.width/2,y:O.ry+B.height/2},(B=S.psychicDetectorTrait?.radiusTiles??S.gapGeneratorTrait?.radiusTiles??S.primaryWeapon?.range)&&this.buildingRanges.set(S,{center:O,radius:B})})}})}}}),System.register("gui/screen/game/worldInteraction/PlanningMode",["game/order/OrderType","engine/sound/SoundKey","engine/sound/ChannelType","engine/type/ObjectType","util/typeGuard","engine/renderable/entity/WaypointLines","game/action/OrderUnitsAction"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){S("PlanningMode",class{constructor(S,O,B,N,j,L,D,F,_,U){this.player=S,this.messageList=O,this.sound=B,this.strings=N,this.worldScene=j,this.unitSelection=L,this.unitSelectionHandler=D,this.renderer=F,this.targetLines=_,this.maxWaypointPathLength=U,this.active=!1,this.paths=[],this.selectedPaths=[],this.selectedUnits=new Set,this.onFrame=S=>{(!this.lastUpdate||S-this.lastUpdate>1e3/15)&&(this.lastUpdate=S,this.updatePaths())}}isActive(){return this.active}enter(){var S;this.active||(this.active=!0,this.targetLines.get3DObject()&&(this.targetLines.get3DObject().visible=!1),this.renderer.onFrame.subscribe(this.onFrame),S=new Set([...this.player.getOwnedObjectsByType(L.ObjectType.Infantry),...this.player.getOwnedObjectsByType(L.ObjectType.Vehicle)].map(S=>S.unitOrderTrait.waypointPath).filter(D.isNotNullOrUndefined)),this.paths=[...S].map(S=>{let O={original:S,units:new Set(S.units),waypoints:[]};return S.waypoints.forEach(S=>{var B={orderType:S.orderType,target:S.target,next:void 0,draft:!1,terminal:S.terminal,original:S};O.waypoints.length&&(O.waypoints[O.waypoints.length-1].next=B),O.waypoints.push(B)}),O}),S=this.waypointLines=new F.WaypointLines(this.unitSelection,this.player,this.selectedPaths,this.paths,this.worldScene.camera),this.worldScene.add(S))}pushOrder(S,O,L){if(S!==B.OrderType.Deploy)if(1<this.selectedPaths.length)this.handleInvalidCommand(this.strings.get("MSG:PlanningModeHeteroSel"));else if(this.selectedUnits.size>_.ORDER_UNIT_LIMIT)this.handleInvalidCommand(this.strings.get("MSG:PlannerMaximum"));else{for(var D of this.selectedUnits){if(D.isBuilding())return void this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoBuildings"));if(D.isAircraft())return void this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoAircraft"))}let B=this.selectedPaths[0];var F;!B&&this.selectedUnits.size&&(B={original:void 0,units:new Set(this.selectedUnits),waypoints:[]},this.paths.push(B),this.selectedPaths.push(B)),B&&(B.waypoints.length!==this.maxWaypointPathLength?B.waypoints.find(S=>S.target.equals(O))?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeInvalidNodeX")):B.waypoints.length&&B.waypoints.slice(B.waypoints[0].draft?0:1).find(S=>S.terminal)?this.handleInvalidCommand(this.strings.get("MSG:PostTerminatingCommand")):(F={orderType:S,target:O,terminal:L,next:void 0,draft:!0,original:void 0},B.waypoints.length&&(B.waypoints[B.waypoints.length-1].next=F),B.waypoints.push(F),L?(this.handleInvalidCommand(this.strings.get("MSG:PostTerminatingCommand")),this.unitSelectionHandler.deselectAll()):this.sound.play(N.SoundKey.AddPlanningModeCommandSound,j.ChannelType.Ui)):this.handleInvalidCommand(this.strings.get("MSG:NodeMaximum")))}else this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoDeploy"))}exit(){let S=this.paths;for(var O of(this.active&&(this.targetLines.get3DObject()&&(this.targetLines.get3DObject().visible=!0),this.renderer.onFrame.unsubscribe(this.onFrame),this.active=!1,this.paths=[],this.selectedPaths=[],this.selectedUnits.clear(),this.waypointLines&&(this.worldScene.remove(this.waypointLines),this.waypointLines.dispose(),this.waypointLines=void 0)),S))O.waypoints=O.waypoints.filter(S=>S.draft);return S.filter(S=>S.waypoints.length)}updatePaths(){for(let O of this.paths){var S;O.original&&(O.original.units.length===O.units.size||O.waypoints.find(S=>S.draft)||(O.units=new Set(O.original.units)),0===O.original.units.length?O.waypoints=O.waypoints.filter(S=>S.draft):O.waypoints=O.waypoints.filter(S=>S.draft||O.original.waypoints.includes(S.original)),O.waypoints.length||(this.paths.splice(this.paths.indexOf(O),1),-1!==(S=this.selectedPaths.indexOf(O))&&this.selectedPaths.splice(S,1)))}}updateSelection(S){this.updatePaths();let O=[...S],B=new Set;for(var N of S)for(var j of this.paths)j.units.has(N)&&(B.add(j),O.push(...j.units));this.selectedPaths.length=0,this.selectedPaths.push(...B);var L=new Set(O);if((this.selectedUnits=L).size!==S.length)return[...this.selectedUnits]}handleInvalidCommand(S){this.sound.play(N.SoundKey.ScoldSound,j.ChannelType.Ui),this.messageList.addUiFeedbackMessage(S)}dispose(){this.exit()}})}}}),System.register("gui/screen/game/worldInteraction/RepairMode",["engine/type/PointerType","util/event"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("RepairMode",class{get onExecute(){return this._onExecute.asEvent()}static factory(S,O,B,N,j){return new this(S,O,B,N,j)}constructor(S,O,j,L,D){this.game=S,this.player=O,this.sidebarModel=j,this.pointer=L,this.renderer=D,this._onExecute=new N.EventDispatcher,this.onFrame=S=>{var O,N;(this.lastTile!==this.currentTile||!this.lastUpdate||S-this.lastUpdate>=1e3/15)&&(this.lastTile=this.currentTile,this.lastUpdate=S,N=!(!(O=this.currentTile)||!this.findRepairableBuilding(O)),this.pointer.setPointerType(O?N?B.PointerType.SideRepair:B.PointerType.NoRepair:B.PointerType.Default))}}enter(){this.sidebarModel.repairMode=!0,this.currentTile=void 0,this.lastTile=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}hover(S,O){O||(this.currentTile=S?.tile)}findRepairableBuilding(S){return this.game.map.getObjectsOnTile(S).find(S=>S.isBuilding()&&S.owner===this.player&&S.healthTrait.health<100&&S.rules.repairable&&S.rules.clickRepairable)}execute(S,O){if(O)return!1;var B=S?.tile;return!!B&&((B=this.findRepairableBuilding(B))&&this._onExecute.dispatch(this,B),!1)}cancel(){this.end()}end(){this.sidebarModel.repairMode=!1,this.renderer.onFrame.unsubscribe(this.onFrame)}dispose(){this.end()}})}}}),System.register("gui/screen/game/worldInteraction/SellMode",["engine/type/PointerType","util/event","game/gameobject/Building","game/gameobject/trait/DockableTrait"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("SellMode",class{get onExecute(){return this._onExecute.asEvent()}static factory(S,O,B,N,j){return new this(S,O,B,N,j)}constructor(S,O,j,L,D){this.game=S,this.player=O,this.sidebarModel=j,this.pointer=L,this.renderer=D,this._onExecute=new N.EventDispatcher,this.onFrame=S=>{if(this.lastHover?.tile!==this.currentHover?.tile||this.lastHover?.gameObject!==this.currentHover?.gameObject||!this.lastUpdate||S-this.lastUpdate>=1e3/15){this.lastHover=this.currentHover,this.lastUpdate=S;let O=B.PointerType.Default;if(this.currentHover?.tile){let S=this.currentHover.gameObject;O=S&&this.isRefundableObject(S)?S.isBuilding()?B.PointerType.Sell:B.PointerType.SellMini:B.PointerType.NoSell}this.pointer.setPointerType(O)}}}enter(){this.sidebarModel.sellMode=!0,this.currentHover=void 0,this.lastHover=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}hover(S,O){O||(this.currentHover=S)}isRefundableObject(S){return!!(S.isTechno()&&S.owner===this.player&&!S.rules.unsellable&&0<this.game.sellTrait.computeRefundValue(S)&&(S.isBuilding()?S.buildStatus===j.BuildStatus.Ready&&!S.warpedOutTrait.isActive():S.traits.find(L.DockableTrait)?.dock?.rules.unitSell))}execute(S,O){if(O)return!1;var B=S?.gameObject;return B&&this.isRefundableObject(B)&&this._onExecute.dispatch(this,B),!1}cancel(){this.end()}end(){this.sidebarModel.sellMode=!1,this.renderer.onFrame.unsubscribe(this.onFrame)}dispose(){this.end()}})}}}),System.register("gui/screen/game/worldInteraction/SpecialActionMode",["engine/type/PointerType","util/event","game/type/SuperWeaponType"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=(new Map).set(j.SuperWeaponType.MultiMissile,B.PointerType.Nuke).set(j.SuperWeaponType.LightningStorm,B.PointerType.Storm).set(j.SuperWeaponType.IronCurtain,B.PointerType.Iron).set(j.SuperWeaponType.ChronoSphere,B.PointerType.Chrono).set(j.SuperWeaponType.ChronoWarp,B.PointerType.Chrono).set(j.SuperWeaponType.AmerParaDrop,B.PointerType.Para).set(j.SuperWeaponType.ParaDrop,B.PointerType.Para),S("SpecialActionMode",class{get onExecute(){return this._onExecute.asEvent()}get superWeaponType(){return this.superWeaponRules.type}static factory(S,O,B,N,j){return new this(S,O,B,N,j)}constructor(S,O,B,j,L){this.allSuperWeaponRules=S,this.superWeaponRules=O,this.superWeaponFxHandler=B,this.pointer=j,this.eva=L,this._onExecute=new N.EventDispatcher,this.isPostClick=!1,this.pointerSwType=this.superWeaponRules.type}enter(){this.eva.play("EVA_SelectTarget")}hover(S){var O=S?.tile,N=L.get(this.pointerSwType);this.pointer.setPointerType(O&&void 0!==N?N:B.PointerType.Default)}execute(S){var O=S?.tile;if(!O)return!1;if(this.superWeaponRules.type!==j.SuperWeaponType.ChronoSphere||this.isPostClick||this.superWeaponFxHandler.createChronoSphereAnim(O),this.superWeaponRules.preClick&&!this.isPostClick){this.isPostClick=!0,this.preTile=O;var B=[...this.allSuperWeaponRules.values()].find(S=>S.postClick&&S.preDependent===this.superWeaponRules.type)?.type;if(void 0===B)throw new Error('No super weapon section found with PostClick=yes and PreDependent="'+j.SuperWeaponType[this.superWeaponRules.type]);return this.pointerSwType=B,!1}this._onExecute.dispatch(this,this.isPostClick?{tile:this.preTile,tile2:O}:{tile:O,tile2:void 0})}cancel(){this.end()}end(){this.superWeaponRules.type===j.SuperWeaponType.ChronoSphere&&this.isPostClick&&this.superWeaponFxHandler.disposeChronoSphereAnim()}dispose(){this.end()}})}}}),System.register("gui/screen/game/worldInteraction/Tooltip",["gui/UiObject","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends B.UiObject{constructor(S,O,B,N){super(new THREE.Object3D),this.text=S,this.color=O,this.pointer=B,this.viewport=N}create3DObject(){if(!this.mesh){let B=this.get3DObject();var S=this.texture=this.createTexture(this.text,this.color),O={width:S.image.width,height:S.image.height};let N=this.mesh=this.createMesh(S,O.width,O.height);O=this.computePosition(this.pointer,this.viewport,O),N.position.x=O.x,N.position.y=O.y,B.add(N),N.updateMatrix()}super.create3DObject()}createMesh(S,O,B){let j=N.SpriteUtils.createRectGeometry(O,B);N.SpriteUtils.addRectUvs(j,{x:0,y:0,width:O,height:B},{width:O,height:B}),j.translate(O/2,B/2,0);var L=new THREE.MeshBasicMaterial({map:S,side:THREE.DoubleSide});let D=new THREE.Mesh(j,L);return D.matrixAutoUpdate=!1,D.frustumCulled=!1,D}createTexture(S,O){let B=document.createElement("canvas");B.width=B.height=0;let N=B.getContext("2d",{willReadFrequently:!0}),L=0;for(var D of S.split("\n"))L+=(D=j.CanvasUtils.drawText(N,D,0,L,{color:O,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:5,paddingBottom:5,paddingLeft:2,paddingRight:4,autoEnlargeCanvas:!0})).height;var F=B.width,_=B.height;_=N.getImageData(0,0,F,_),B.width+=1,B.height+=1,N.putImageData(_,1,1),N.globalCompositeOperation="destination-over",N.fillStyle="black",N.fillRect(0,0,B.width,B.height),N.globalCompositeOperation="source-over",N.strokeStyle=O,N.strokeRect(.5,.5,B.width-1,B.height-1);let U=new THREE.Texture(B);return U.minFilter=THREE.NearestFilter,U.magFilter=THREE.NearestFilter,U.needsUpdate=!0,U.flipY=!1,U}computePosition(S,O,B){let N={...S.getPosition()};return N.x+20+B.width>O.x+O.width?N.x-=20+B.width:N.x+=20,N.y+20+B.height>O.x+O.height?N.y-=20+B.height:N.y+=20,N}destroy(){super.destroy(),this.texture?.dispose(),this.mesh&&(this.mesh.material.dispose(),this.mesh.geometry.dispose())}},S("Tooltip",L)}}}),System.register("gui/screen/game/worldInteraction/TooltipHandler",["util/disposable/CompositeDisposable","gui/screen/game/worldInteraction/Tooltip"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class{equals(S){return(this.entity??this.uiObject)===(S.entity??S.uiObject)}copy(S){this.entity=S.entity,this.uiObject=S.uiObject}},S("TooltipHandler",L=class e{constructor(S,O,L,D,F,_,U){this.mapHoverHandler=S,this.textColor=O,this.pointer=L,this.uiScene=D,this.renderer=F,this.strings=_,this.debugText=U,this.disposables=new B.CompositeDisposable,this.currentHover=new j,this.lastHover=new j,this.isTouch=!1,this.needsHoverTimeReset=!1,this.paused=!1,this.handleUiMouseMove=S=>{var O=S.intersection?.object;let B=O;for(;void 0===B?.userData.tooltip&&(B=B?.parent,B););this.currentHover.uiObject=B??O,this.hoverStartTime&&(this.needsHoverTimeReset=!0),this.isTouch=S.isTouch},this.handleMouseDown=()=>{this.paused=!0,this.reset()},this.handleMouseUp=S=>{this.paused=!1,this.isTouch=S.isTouch},this.handleMouseWheel=()=>{this.reset()},this.onFrame=S=>{var O;(!this.lastUpdate||S-this.lastUpdate>=1e3/15)&&(this.lastUpdate=S,O=this.mapHoverHandler.getCurrentHover()?.entity,this.currentHover.entity=O,this.paused||(this.currentHover.equals(this.lastHover)?(this.needsHoverTimeReset&&(this.needsHoverTimeReset=!1,this.hoverStartTime=S),O=this.currentHover.entity?800:400,this.hoverStartTime&&S-this.hoverStartTime>O&&(!(O=this.getTooltipText(this.currentHover))||this.tooltip||this.isTouch||(this.tooltip=new N.Tooltip(O,this.textColor,this.pointer,this.uiScene.viewport),this.tooltip.setZIndex(e.ZINDEX),this.uiScene.add(this.tooltip)))):(this.lastHover.copy(this.currentHover),this.hoverStartTime=void 0,this.destroyTooltip(),void 0!==this.getTooltipText(this.currentHover)&&(this.hoverStartTime=S))))}}init(){this.disposables.add(this.pointer.pointerEvents.addEventListener(this.uiScene.get3DObject(),"mousemove",this.handleUiMouseMove)),this.disposables.add(this.pointer.pointerEvents.addEventListener("canvas","mousedown",this.handleMouseDown),this.pointer.pointerEvents.addEventListener("canvas","wheel",this.handleMouseWheel),this.pointer.pointerEvents.addEventListener("canvas","mouseup",this.handleMouseUp)),this.renderer.onFrame.subscribe(this.onFrame),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(this.onFrame))}reset(){this.destroyTooltip(),this.hoverStartTime&&(this.needsHoverTimeReset=!0)}getTooltipText(S){let O;if(S.entity){let B=S.entity.getUiName?.();void 0!==B&&""!==B&&(-1!==B.indexOf("{")?O=B.replace(/\{([^}]+)\}/g,(S,O)=>this.strings.get(O)):(this.strings.has(B)||B.match(/^NOSTR:/i))&&(O=this.strings.get(B))),this.debugText.value&&(O+=` (ID: ${S.entity.gameObject.id})`)}else S.uiObject&&(O=S.uiObject.userData.tooltip);return O}destroyTooltip(){this.tooltip&&(this.uiScene.remove(this.tooltip),this.tooltip?.destroy(),this.tooltip=void 0)}dispose(){this.disposables.dispose(),this.destroyTooltip()}}),L.ZINDEX=100}}}),System.register("gui/screen/game/worldInteraction/UnitSelectionHandler",["util/geometry","util/math","util/event","util/array","game/gameobject/unit/HealthLevel"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){var O;(O=F||S("QueryType",F={}))[O.None=0]="None",O[O.OnScreen=1]="OnScreen",O[O.OnMap=2]="OnMap",O[O.Veteran=3]="Veteran",O[O.Health=4]="Health",S("UnitSelectionHandler",class{get onUserSelectionChange(){return this._onUserSelectionChange.asEvent()}get onUserSelectionUpdate(){return this._onUserSelectionUpdate.asEvent()}constructor(S,O,B,N,L,D){this.worldScene=S,this.uiScene=O,this.player=B,this.unitSelection=N,this.entityIntersectHelper=L,this.veteranCap=D,this.shouldSelectByTypeOnMap=!1,this.shouldSelectCombatantsOnMap=!1,this._onUserSelectionChange=new j.EventDispatcher,this._onUserSelectionUpdate=new j.EventDispatcher,this._onUserSelectionChange.subscribe(()=>{this.shouldSelectByTypeOnMap=!1,this.shouldSelectCombatantsOnMap=!1}),this._onUserSelectionUpdate.subscribe(()=>{this.selectVeteranState=void 0,this.selectHealthState=void 0})}addToSelection(S){if(S.rules.selectable){let O=this.unitSelection.getSelectedUnits();O.length&&(S.owner===this.player&&!O.find(O=>O.owner!==S.owner)||this.unitSelection.deselectAll()),this.unitSelection.addToSelection(S)}}selectSingleUnit(S){var O,B,N;S.rules.selectable&&((O=this.unitSelection.getSelectedUnits()).length&&this.unitSelection.deselectAll(),this.unitSelection.addToSelection(S),N={selection:B=this.unitSelection.getSelectedUnits()},B.length===O.length&&B[0]===O[0]||this._onUserSelectionChange.dispatch(this,N),this._onUserSelectionUpdate.dispatch(this,N))}toggleSelection(S){var O;S.rules.selectable&&(this.unitSelection.isSelected(S)?this.unitSelection.removeFromSelection([S]):this.addToSelection(S),O={selection:this.unitSelection.getSelectedUnits()},this._onUserSelectionChange.dispatch(this,O),this._onUserSelectionUpdate.dispatch(this,O))}deselectAll(){var S={selection:[]};this.unitSelection.getSelectedUnits().length&&(this.unitSelection.deselectAll(),this._onUserSelectionChange.dispatch(this,S)),this._onUserSelectionUpdate.dispatch(this,S)}selectMultipleUnits(S,{queryType:O,veteranLevel:B,healthLevel:N},j=!0){var D=this.unitSelection.getSelectedUnits();j&&this.unitSelection.deselectAll(),S.forEach(S=>this.addToSelection(S));var F=this.unitSelection.getSelectedUnits(),_={selection:F,queryType:O,veteranLevel:B,healthLevel:N};L.equals(D,F)||this._onUserSelectionChange.dispatch(this,_),this._onUserSelectionUpdate.dispatch(this,_)}getSelectedUnits(){return this.unitSelection.getSelectedUnits()}startBoxSelect(S){this.boxSelectOrigin=S,this.disposeBoxSelect(),this.selectBox=this.createSelectBox(new THREE.Box2),this.uiScene.get3DObject().add(this.selectBox)}updateBoxSelect(S){var O;this.boxSelectOrigin&&(S=this.clampPointerToWorldViewport(S),O=(new THREE.Box2).setFromPoints([new THREE.Vector2(this.boxSelectOrigin.x,this.boxSelectOrigin.y),new THREE.Vector2(S.x,S.y)]),this.selectBox.geometry.dispose(),this.selectBox.geometry=this.createBoxGeometry(O))}finishBoxSelect(S,O){if(!this.boxSelectOrigin)return!1;var N=this.boxSelectOrigin;if(this.boxSelectOrigin=void 0,this.disposeBoxSelect(),B.pointEquals(S,N))return!1;S=this.clampPointerToWorldViewport(S),N=(new THREE.Box2).setFromPoints([new THREE.Vector2(N.x,N.y),new THREE.Vector2(S.x,S.y)]);let j,L=this.entityIntersectHelper.getEntitiesAtScreenBox(N)?.map(S=>S.gameObject).filter(S=>S.isTechno()&&S.rules.selectable&&S.owner===this.player);return!!L.length&&(j=1===L.length?[L[0]]:L.filter(S=>!S.isBuilding()),!!j.length&&(this.selectMultipleUnits(j,{queryType:F.None},O),!0))}cancelBoxSelect(){this.boxSelectOrigin=void 0,this.disposeBoxSelect()}createGroup(S){var O=this.unitSelection.getSelectedUnits();1===O.length&&O[0].owner!==this.player||this.unitSelection.createGroup(S)}getGroupUnits(S){return this.unitSelection.getGroupUnits(S)}addGroupToSelection(S){var O=this.getSelectedUnits();this.unitSelection.addGroupToSelection(S);var B=this.getSelectedUnits(),N={selection:B};L.equals(B,O)||this._onUserSelectionChange.dispatch(this,N),this._onUserSelectionUpdate.dispatch(this,N)}selectGroup(S){var O=this.getSelectedUnits();this.unitSelection.selectGroup(S);var B=this.getSelectedUnits(),N={selection:B};L.equals(B,O)||this._onUserSelectionChange.dispatch(this,N),this._onUserSelectionUpdate.dispatch(this,N)}selectByType(){let S=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(S){let B=this.getSelectedUnits().reduce((S,O)=>S.add(O.name),new Set),N=[],j=[];this.shouldSelectByTypeOnMap||(N=this.getOwnedObjectsOnScreen(S),j=N.filter(S=>B.has(S.name)),j.every(S=>this.unitSelection.isSelected(S))&&(this.shouldSelectByTypeOnMap=!0)),this.shouldSelectByTypeOnMap&&(N=S.getOwnedObjects(),j=N.filter(S=>B.has(S.name)));var O=this.shouldSelectByTypeOnMap?F.OnMap:F.OnScreen;j.length?this.selectMultipleUnits(j,{queryType:O},!1):B.size||this.selectMultipleUnits([],{queryType:O}),this.shouldSelectByTypeOnMap=!0}}selectCombatants(){let S=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(S){let N=[];N=this.shouldSelectCombatantsOnMap?S.getOwnedObjects():this.getOwnedObjectsOnScreen(S);var O,B=N.filter(S=>S.isUnit()&&S.rules.selectable&&S.rules.isSelectableCombatant&&S.attackTrait&&!S.rules.harvester);B.length?(O=this.shouldSelectCombatantsOnMap?F.OnMap:F.OnScreen,this.selectMultipleUnits(B,{queryType:O})):this.shouldSelectCombatantsOnMap?this.selectMultipleUnits([],{queryType:F.OnMap}):(this.shouldSelectCombatantsOnMap=!0,this.selectCombatants()),this.shouldSelectCombatantsOnMap=!0}}selectByVeterancy(){let S=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(S){let B;void 0===this.selectVeteranState?(B=this.veteranCap,this.vetNavSelectionSet=this.unitSelection.getSelectedUnits(),this.vetNavSelectionSet.length||(this.vetNavSelectionSet=this.getOwnedObjectsOnScreen(S).filter(S=>S.isUnit()))):(O=this.veteranCap+1,B=(this.selectVeteranState-1+O)%O);let N=this.vetNavSelectionSet.filter(O=>O.rules.selectable&&!O.isDestroyed&&!O.isCrashing&&!O.limboData&&O.owner===S);var O=N.filter(S=>S.veteranLevel===B);this.selectMultipleUnits(O,{queryType:F.Veteran,veteranLevel:N.length?B:void 0}),this.selectVeteranState=B}}selectByHealth(){let S=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(S){let B;var O=Object.keys(D.HealthLevel).filter(S=>!isNaN(Number(S))).length;void 0===this.selectHealthState?(B=O-1,this.healthNavSelectionSet=this.unitSelection.getSelectedUnits(),this.healthNavSelectionSet.length||(this.healthNavSelectionSet=this.getOwnedObjectsOnScreen(S).filter(S=>S.isUnit()))):B=(this.selectHealthState-1+O)%O;let N=this.healthNavSelectionSet.filter(O=>O.rules.selectable&&!O.isDestroyed&&!O.isCrashing&&!O.limboData&&O.owner===S);O=N.filter(S=>S.healthTrait.level===B),this.selectMultipleUnits(O,{queryType:F.Health,healthLevel:N.length?B:void 0}),this.selectHealthState=B}}getOwnedObjectsOnScreen(S){var O=this.worldScene.viewport;return O=new THREE.Box2(new THREE.Vector2(O.x,O.y),new THREE.Vector2(O.x+O.width-1,O.x+O.height-1)),this.entityIntersectHelper.getEntitiesAtScreenBox(O)?.map(S=>S.gameObject).filter(O=>O.isTechno()&&O.owner===S)}disposeBoxSelect(){this.selectBox&&(this.uiScene.get3DObject().remove(this.selectBox),this.selectBox.geometry.dispose(),this.selectBox.material.dispose(),this.selectBox=void 0)}clampPointerToWorldViewport(S){var O=this.worldScene.viewport;return{x:N.clamp(S.x,O.x,O.x+O.width-1),y:N.clamp(S.y,O.y,O.y+O.height-1)}}getHash(){return this.unitSelection.getHash()}dispose(){this.cancelBoxSelect(),this._onUserSelectionChange=new j.EventDispatcher,this._onUserSelectionUpdate=new j.EventDispatcher}createSelectBox(S){var O=new THREE.LineBasicMaterial({color:16777215,transparent:!0,depthTest:!1,depthWrite:!1}),B=this.createBoxGeometry(S);return new THREE.Line(B,O)}createBoxGeometry(S){var O={x:S.min.x,y:S.min.y},B={x:S.max.x,y:S.max.y},N={x:S.max.x,y:S.min.y},j={x:S.min.x,y:S.max.y};let L=new THREE.Geometry;return L.vertices.push(new THREE.Vector3(O.x,O.y,0),new THREE.Vector3(j.x,j.y,0),new THREE.Vector3(B.x,B.y,0),new THREE.Vector3(N.x,N.y,0),new THREE.Vector3(O.x,O.y,0)),L}})}}}),System.register("gui/screen/game/worldInteraction/WorldInteraction",["util/geometry","engine/type/PointerType","gui/screen/game/worldInteraction/DefaultActionHandler","util/userAgent"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("WorldInteraction",class{constructor(S,O,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee){this.worldScene=S,this.pointer=O,this.pointerEvents=L,this.cameraPanHandler=D,this.mapScrollHandler=F,this.mapHoverHandler=_,this.tooltipHandler=U,this.unitSelectionHandler=H,this.defaultActionHandler=V,this.keyboardHandler=W,this.arrowScrollHandler=z,this.customScrollHandler=K,this.minimapHandler=$,this.cameraZoom=q,this.document=Q,this.renderer=Z,this.targetLines=Y,this.rightClickMove=X,this.rightClickScroll=J,this.battleControlApi=ee,this.initialized=!1,this.enabled=!0,this.clickOrigin={x:0,y:0},this.maybePan=!1,this.hasDragged=!1,this.isMinimapHover=!1,this.clearModeOnSelectionChange=!1,this.handleSelectionChange=()=>{this.clearModeOnSelectionChange&&this.setMode(void 0)},this.handleKeyDown=S=>{this.handleKeyModifierChange(S),this.keyboardHandler.handleKeyDown(S),this.arrowScrollHandler.handleKeyDown(S),this.chatTypingHandler?.handleKeyDown(S)},this.handleKeyUp=S=>{this.handleKeyModifierChange(S),this.keyboardHandler.handleKeyUp(S),this.arrowScrollHandler.handleKeyUp(S),this.chatTypingHandler?.handleKeyUp(S),this.tooltipHandler.reset()},this.handleKeyModifierChange=S=>{var O=this.lastKeyMods;this.lastKeyMods=S,this.lastKeyboardEvent=S,this.currentMode||this.maybePan&&this.hasDragged||this.mapScrollHandler.isScrolling()||S.repeat||S.shiftKey===O?.shiftKey&&S.ctrlKey===O?.ctrlKey&&S.altKey===O?.altKey||this.updateDefaultAction(this.getCurrentHover(),this.unitSelectionHandler.getSelectedUnits(),S)},this.handleMapHoverChange=S=>{this.currentMode?.hover(S,this.isMinimapHover),this.isMinimapHover||this.currentMode||this.updateDefaultAction(S,this.unitSelectionHandler.getSelectedUnits(),this.lastKeyMods)},this.handleMouseMove=S=>{this.queuedMouseMoveEvent=S},this.handleFrame=S=>{this.lastFrameTime=S;let O=!1;var B=this.unitSelectionHandler.getHash();B===this.lastSelectionHash||this.currentMode||(this.lastSelectionHash=B,O=!0),(B=this.queuedMouseMoveEvent)&&(this.queuedMouseMoveEvent=void 0,this.processMouseMove(B)),(!this.lastDefaultActionUpdate||S-this.lastDefaultActionUpdate>=1e3/15)&&(this.lastDefaultActionUpdate=S,this.currentMode||this.mapScrollHandler.isScrolling()||this.hasDragged&&this.maybePan||(O=!0)),O&&this.updateDefaultAction(this.getCurrentHover(),this.unitSelectionHandler.getSelectedUnits(),this.lastKeyMods)},this.handleMouseDown=S=>{B.rectContainsPoint(this.worldScene.viewport,S.pointer)&&void 0===this.mousePressed&&(this.hasFaultyCtrlLeftClick&&S.ctrlKey&&2===S.button&&(S.button=0),this.mapScrollHandler.cancel(),this.pointerEvents.intersectionsEnabled=!1,this.clickOrigin=S.pointer,this.mousePressed=S.button,this.lastMouseDownEvent=S,this.hasDragged=!1,(2===S.button&&this.isRightClickPanAllowed()||1===S.button)&&(this.maybePan=!0,this.cameraPanHandler.start(S.pointer)),2===S.button&&(this.isRightClickPanAllowed()||this.isRightClickMove()||this.unitSelectionHandler.deselectAll(),this.chatTypingHandler?.endTyping()))},this.handleMouseUp=S=>{if(this.hasFaultyCtrlLeftClick&&S.ctrlKey&&2===S.button&&(S.button=0),this.mousePressed===S.button){S.isTouch&&this.lastKeyMods&&this.lastKeyMods!==this.lastKeyboardEvent&&(S.ctrlKey=this.lastKeyMods.ctrlKey,S.shiftKey=this.lastKeyMods.shiftKey,S.altKey=this.lastKeyMods.altKey),this.pointerEvents.intersectionsEnabled=!0,this.mousePressed=void 0;var O=this.maybePan;if(this.maybePan=!1,O&&this.cameraPanHandler.finish(),O&&this.hasDragged)return this.mapHoverHandler.update(S.pointer,!0),void this.currentMode?.hover(this.getCurrentHover(),this.isMinimapHover);if(this.currentMode)0===S.button?(this.mapHoverHandler.update(S.pointer,!0),!1!==this.currentMode.execute(this.getCurrentHover(),this.isMinimapHover)&&(this.currentMode=void 0)):2===S.button&&this.isClickRange(S.pointer)&&(this.currentMode.cancel?.(),this.currentMode=void 0,this.pointer.setPointerType(N.PointerType.Default));else{let N=!1;if(0===S.button&&this.hasDragged&&(N=this.unitSelectionHandler.finishBoxSelect(S.pointer,!S.shiftKey),N||this.mapHoverHandler.update(S.pointer,!0)),0===S.button||2===S.button){var B=this.isRightClickMove(),j=S.button===(B?2:0),L=this.isClickRange(S.pointer);let _=!1;S.isTouch&&this.mapHoverHandler.update(S.pointer,!0);var D,F=this.mapHoverHandler.getCurrentHover();if(L&&(D=this.lastDefaultModeClickDetails,O={mouseUpEvent:S,hoverObject:F?.gameObject,selectionHash:this.unitSelectionHandler.getHash(),time:Date.now()},D&&(_=O.mouseUpEvent.button===D.mouseUpEvent.button&&O.hoverObject===D.hoverObject&&O.selectionHash===D.selectionHash&&O.time-D.time<500),this.lastDefaultModeClickDetails=_?void 0:O),!j&&(!B||!S.shiftKey||S.ctrlKey)&&(!B||!_)){if(!L)return;this.unitSelectionHandler.deselectAll()}N||!B&&!j||this.handleDefaultClickAction(B,j,_,!1,S,F),this.lastDefaultModeClickDetails&&(this.lastDefaultModeClickDetails.selectionHash=this.unitSelectionHandler.getHash())}}}},this.handleWheel=S=>{this.cameraZoom.applyStep(0<S.wheelDeltaY?-.1:.1)},this.handleMinimapClick=S=>{let O=!1;var B,N=this.minimapHandler.getHover(S);this.currentMode?!1!==this.currentMode.execute(N,!0)&&(this.currentMode=void 0,O=!0):(B=this.unitSelectionHandler.getSelectedUnits(),O=this.defaultActionHandler.execute(N,B,j.ActionFilter.All,!1,!1,this.lastKeyMods,!0)),O||this.minimapHandler.panToTile(S)},this.handleMinimapRightClick=S=>{this.minimapHandler.panToTile(S)},this.handleMinimapMouseOver=()=>{this.isMinimapHover=!0},this.handleMinimapMouseMove=S=>{this.minimapHoverTile=S;var O=this.minimapHandler.getHover(S);this.currentMode?this.currentMode.hover(O,!0):this.updateDefaultAction(O,this.unitSelectionHandler.getSelectedUnits(),this.lastKeyMods)},this.handleMinimapMouseOut=()=>{this.pointer.setPointerType(N.PointerType.Default),this.isMinimapHover=!1,this.minimapHoverTile=void 0}}init(){this.initialized||(this.setupHandlers(),this.worldScene.add(this.targetLines),this.initialized=!0,this.hasFaultyCtrlLeftClick=L.isMacFirefox(),this.battleControlApi._setWorldInteraction(this),this.battleControlApi._notifyToggle(!0))}setShroud(S){this.mapHoverHandler.setShroud(S),this.minimapHandler.setShroud(S)}setupHandlers(){this.pointerEvents.addEventListener("canvas","mousemove",this.handleMouseMove),this.pointerEvents.addEventListener("canvas","mousedown",this.handleMouseDown),this.pointerEvents.addEventListener("canvas","mouseup",this.handleMouseUp),this.pointerEvents.addEventListener("canvas","wheel",this.handleWheel),this.document.addEventListener("keydown",this.handleKeyDown),this.document.addEventListener("keyup",this.handleKeyUp),this.mapHoverHandler.onHoverChange.subscribe(this.handleMapHoverChange),this.renderer.onFrame.subscribe(this.handleFrame),this.unitSelectionHandler.onUserSelectionChange.subscribe(this.handleSelectionChange),this.minimapHandler.minimap.onClick.subscribe(this.handleMinimapClick),this.minimapHandler.minimap.onRightClick.subscribe(this.handleMinimapRightClick),this.minimapHandler.minimap.onMouseOver.subscribe(this.handleMinimapMouseOver),this.minimapHandler.minimap.onMouseMove.subscribe(this.handleMinimapMouseMove),this.minimapHandler.minimap.onMouseOut.subscribe(this.handleMinimapMouseOut),this.tooltipHandler.init()}teardownHandlers(){this.pointerEvents.removeEventListener("canvas","mousemove",this.handleMouseMove),this.pointerEvents.removeEventListener("canvas","mousedown",this.handleMouseDown),this.pointerEvents.removeEventListener("canvas","mouseup",this.handleMouseUp),this.pointerEvents.removeEventListener("canvas","wheel",this.handleWheel),this.document.removeEventListener("keydown",this.handleKeyDown),this.document.removeEventListener("keyup",this.handleKeyUp),this.mapHoverHandler.onHoverChange.unsubscribe(this.handleMapHoverChange),this.renderer.onFrame.unsubscribe(this.handleFrame),this.unitSelectionHandler.onUserSelectionChange.unsubscribe(this.handleSelectionChange),this.unitSelectionHandler.cancelBoxSelect(),this.minimapHandler.minimap.onClick.unsubscribe(this.handleMinimapClick),this.minimapHandler.minimap.onRightClick.unsubscribe(this.handleMinimapRightClick),this.minimapHandler.minimap.onMouseOver.unsubscribe(this.handleMinimapMouseOver),this.minimapHandler.minimap.onMouseMove.unsubscribe(this.handleMinimapMouseMove),this.minimapHandler.minimap.onMouseOut.unsubscribe(this.handleMinimapMouseOut),this.tooltipHandler.dispose(),this.mapScrollHandler.cancel(),this.arrowScrollHandler.cancel(),this.customScrollHandler.cancel()}dispose(){this.initialized&&this.enabled&&(this.teardownHandlers(),this.pointer.setPointerType(N.PointerType.Default),this.battleControlApi._setWorldInteraction(void 0),this.battleControlApi._notifyToggle(!1)),this.currentMode?.dispose(),this.mapScrollHandler.dispose(),this.cameraPanHandler.dispose(),this.mapHoverHandler.dispose(),this.unitSelectionHandler.dispose(),this.chatTypingHandler?.dispose(),this.keyboardHandler.dispose(),this.worldScene.remove(this.targetLines),this.targetLines.dispose(),this.tooltipHandler.dispose()}setEnabled(S){this.enabled!==S&&((this.enabled=S)?this.setupHandlers():(this.teardownHandlers(),this.cancelMouseUp(),this.cancelKeyUp(),this.pointer.setPointerType(N.PointerType.Default),this.chatTypingHandler?.endTyping()),this.battleControlApi._setWorldInteraction(S?this:void 0),this.battleControlApi._notifyToggle(S))}isEnabled(){return this.enabled}pausePanning(){this.cameraPanHandler.setPaused(!0),this.mapScrollHandler.setPaused(!0)}unpausePanning(){this.cameraPanHandler.setPaused(!1),this.mapScrollHandler.setPaused(!1)}setMode(S){var O;this.currentMode!==S&&(this.currentMode?.cancel?.(),this.pointer.setPointerType(N.PointerType.Default)),this.currentMode=S,this.clearModeOnSelectionChange=!1,S&&(this.unitSelectionHandler.cancelBoxSelect(),this.unitSelectionHandler.deselectAll(),this.clearModeOnSelectionChange=!0,S.enter(),this.mapHoverHandler.update(this.pointer.getPosition(),!0),(O=this.getCurrentHover())&&S.hover(O,this.isMinimapHover))}getMode(){return this.currentMode}registerKeyCommand(S,O){return this.keyboardHandler.registerCommand(S,O),this}unregisterKeyCommand(S){return this.keyboardHandler.unregisterCommand(S),this}applyKeyModifiers(S){this.lastKeyMods=S,this.currentMode||this.maybePan&&this.hasDragged||this.mapScrollHandler.isScrolling()||this.updateDefaultAction(this.getCurrentHover(),this.unitSelectionHandler.getSelectedUnits(),S)}cancelSelection(){this.pointerEvents.intersectionsEnabled=!0,this.mousePressed=void 0,this.maybePan=!1,this.hasDragged=!1,this.unitSelectionHandler.cancelBoxSelect(),this.pointer.setPointerType(N.PointerType.Default),this.unitSelectionHandler.deselectAll(),this.pointerEvents.resetTouchState?.()}virtualTap(S,O,N=!1){if(!B.rectContainsPoint(this.worldScene.viewport,S))return!1;this.mapHoverHandler.update(S,!0);let L=this.mapHoverHandler.getCurrentHover();if(!L)return!1;let D=this.unitSelectionHandler.getSelectedUnits(),F=this.defaultActionHandler.execute(L,D,j.ActionFilter.All,!1,N,O??this.lastKeyMods);if(globalThis.__ra2webDebugMobileJoystick){let S=O?`ctrl=${!!O.ctrlKey} shift=${!!O.shiftKey} alt=${!!O.altKey} meta=${!!O.metaKey}`:"mods=<null>",B=L.tile?`tile=${L.tile.rx},${L.tile.ry}`:"tile=<null>";console.log(`[WorldInteraction] virtualTap ok=${F} selected=${D?.length??0} hoverHasObj=${!!L.gameObject} dbl=${N} ${S} ${B}`)}return globalThis.__ra2webLastVirtualTap={ok:F,pointer:S,mods:O,selected:D?.length??0,hoverHasObj:!!L.gameObject,tile:L.tile?{rx:L.tile.rx,ry:L.tile.ry}:void 0},F}updateDefaultAction(S,O,B){var j=this.mapScrollHandler.isScrolling();S?(this.defaultActionHandler.update(S,O,this.isRightClickMove(),B,this.isMinimapHover),j||this.pointer.setPointerType(this.defaultActionHandler.getPointerType(this.isMinimapHover))):j||this.pointer.setPointerType(this.isMinimapHover?N.PointerType.Mini:N.PointerType.Default),this.lastDefaultActionUpdate=this.lastFrameTime}processMouseMove(S){var O=this.mapScrollHandler.isScrolling();void 0===this.mousePressed?S.isTouch||this.mapScrollHandler.update(S.pointer):this.hasDragged||this.isClickRange(S.pointer)||(this.hasDragged=!0,this.currentMode||0!==this.mousePressed||this.unitSelectionHandler.startBoxSelect(this.clickOrigin)),!this.currentMode||this.mapScrollHandler.isScrolling()||this.maybePan&&this.hasDragged||(!this.isMinimapHover&&O&&this.pointer.setPointerType(N.PointerType.Default),this.mapHoverHandler.update(S.pointer),this.currentMode.hover(this.getCurrentHover(),this.isMinimapHover)),void 0===this.mousePressed?this.mapScrollHandler.isScrolling()||(this.mapHoverHandler.update(S.pointer),this.currentMode||this.updateDefaultAction(this.getCurrentHover(),this.unitSelectionHandler.getSelectedUnits(),S)):(!this.hasDragged||(this.currentMode||this.isRightClickMove()&&2===this.mousePressed)&&!this.maybePan?this.mapHoverHandler.update(S.pointer):this.mapHoverHandler.finish(),this.hasDragged&&(this.maybePan?this.cameraPanHandler.update(S.pointer,S.isTouch):this.currentMode||this.isRightClickMove()&&2===this.mousePressed||(this.pointer.setPointerType(N.PointerType.Default),this.unitSelectionHandler.updateBoxSelect(S.pointer))))}handleDefaultClickAction(S,O,B,N,L,D){var F,_;D&&(F=this.unitSelectionHandler.getSelectedUnits(),_=S?O?j.ActionFilter.NoSelect:j.ActionFilter.SelectOnly:j.ActionFilter.All,this.defaultActionHandler.execute(D,F,_,S&&!O,B,N?{...L,ctrlKey:!0}:L))}cancelMouseUp(){void 0!==this.mousePressed&&(this.pointerEvents.intersectionsEnabled=!0,this.mousePressed=void 0,this.maybePan&&(this.maybePan=!1,this.cameraPanHandler.finish()),this.currentMode&&(this.currentMode.cancel?.(),this.currentMode=void 0),this.unitSelectionHandler.cancelBoxSelect())}cancelKeyUp(){var S;"keydown"===this.lastKeyboardEvent?.type&&(S=new KeyboardEvent("keyup",{key:this.lastKeyboardEvent.key,keyCode:this.lastKeyboardEvent.keyCode,ctrlKey:this.lastKeyboardEvent.ctrlKey,altKey:this.lastKeyboardEvent.altKey,shiftKey:this.lastKeyboardEvent.shiftKey,metaKey:this.lastKeyboardEvent.metaKey}),this.handleKeyUp(S))}isClickRange(S){return Math.abs(S.x-this.clickOrigin.x)<=7&&Math.abs(S.y-this.clickOrigin.y)<=7}isRightClickPanAllowed(){return this.rightClickScroll.value}isRightClickMove(){return this.rightClickMove.value}getCurrentHover(){return this.isMinimapHover?this.minimapHoverTile?this.minimapHandler.getHover(this.minimapHoverTile):void 0:this.mapHoverHandler.getCurrentHover()}})}}}),System.register("gui/screen/game/worldInteraction/WorldInteractionFactory",["engine/util/MapTileIntersectHelper","engine/util/EntityIntersectHelper","gui/screen/game/worldInteraction/UnitSelectionHandler","gui/screen/game/worldInteraction/DefaultActionHandler","gui/screen/game/worldInteraction/WorldInteraction","gui/screen/game/worldInteraction/CameraPanHandler","gui/screen/game/worldInteraction/MapScrollHandler","gui/screen/game/worldInteraction/MapHoverHandler","gui/screen/game/worldInteraction/keyboard/KeyboardHandler","engine/util/RaycastHelper","engine/util/WorldViewportHelper","engine/renderable/entity/TargetLines","gui/screen/game/worldInteraction/MinimapHandler","engine/util/MapPanningHelper","gui/screen/game/worldInteraction/TooltipHandler","gui/screen/game/worldInteraction/ArrowScrollHandler","gui/screen/game/worldInteraction/CustomScrollHandler"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S}],execute:function(){S("WorldInteractionFactory",class{constructor(S,O,B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z){this.player=S,this.game=O,this.unitSelection=B,this.renderableManager=N,this.uiScene=j,this.worldScene=L,this.pointer=D,this.renderer=F,this.keyBinds=_,this.generalOptions=U,this.freeCamera=H,this.debugPaths=V,this.devMode=W,this.document=z,this.minimap=K,this.strings=$,this.tooltipTextColor=q,this.tooltipDebugText=Q,this.battleControlApi=Z}create(){var S=this.game.map,O=this.worldScene,Y=this.pointer;let X=this.renderer;var J=new B.MapTileIntersectHelper(S,O),ee=new V.RaycastHelper(O),te=new W.WorldViewportHelper(O),ie=new N.EntityIntersectHelper(S,this.renderableManager,J,ee,O,te),re=new j.UnitSelectionHandler(O,this.uiScene,this.player,this.unitSelection,ie,this.game.rules.general.veteran.veteranCap),se=L.DefaultActionHandler.factory(this.renderableManager,this.unitSelection,re,this.player,S,this.game,this.game.rules.audioVisual);return ee=this.player?this.game.mapShroudTrait.getPlayerShroud(this.player):void 0,te=new H.KeyboardHandler(this.keyBinds,this.devMode),ie=new U.MapHoverHandler(ie,J,S,ee,X),J=new _.MapScrollHandler(X.getCanvas(),O.cameraPan,Y,this.generalOptions.scrollRate,O),new D.WorldInteraction(O,Y,Y.pointerEvents,new F.CameraPanHandler(O.cameraPan,Y,this.generalOptions.scrollRate,this.freeCamera,O),J,ie,new q.TooltipHandler(ie,this.tooltipTextColor,Y,this.uiScene,this.renderer,this.strings,this.tooltipDebugText),re,se,te,new Q.ArrowScrollHandler(J),new Z.CustomScrollHandler(J),new K.MinimapHandler(this.minimap,S,ee,O,new $.MapPanningHelper(S)),O.cameraZoom,this.document,X,new z.TargetLines(this.player,this.unitSelection,O.camera,this.debugPaths,this.generalOptions.targetLines),this.generalOptions.rightClickMove,this.generalOptions.rightClickScroll,this.battleControlApi)}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/KeyBinds",["data/DataStream","data/IniFile","data/vfs/VirtualFile","gui/screen/game/worldInteraction/keyboard/KeyCommandType"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=new Map([[98,40],[100,37],[102,39],[104,38]]),S("KeyBinds",F=class e{constructor(S,O,B){this.configDir=S,this.persistFileName=O,this.defaultIni=B,this.hotKeys=new Map}async load(){this.hotKeys.clear();let S,O=!0;try{this.configDir&&await this.configDir.containsEntry(this.persistFileName)&&(S=new N.IniFile(await this.configDir.openFile(this.persistFileName)),this.loadHotKeys(S),O=!1)}catch(O){console.log(`Failed to load hotkeys from local file "${this.persistFileName}"`,O)}if(O){var B,j;for([B,j]of(S=this.defaultIni,new Map([[L.KeyCommandType.PreviousObject,"M".charCodeAt(0)],[L.KeyCommandType.VeterancyNav,"Y".charCodeAt(0)],[L.KeyCommandType.HealthNav,"U".charCodeAt(0)],[L.KeyCommandType.FreeMoney,582],[L.KeyCommandType.BuildCheat,593],[L.KeyCommandType.ToggleFps,512+"R".charCodeAt(0)],[L.KeyCommandType.ToggleShroud,1024+"S".charCodeAt(0)]])))this.addHotKey(B,j);this.loadHotKeys(S)}this.addHotKey(L.KeyCommandType.Scoreboard,9)}async saveIni(S){await(this.configDir?.writeFile(new j.VirtualFile((new B.DataStream).writeString(S.toString()),this.persistFileName)))}async resetAndReload(){this.configDir&&await this.configDir.containsEntry(this.persistFileName)&&await this.configDir.deleteFile(this.persistFileName),await this.load()}loadHotKeys(S){let O=S.getSection(e.iniSection);if(!O)throw new Error(`Missing [${e.iniSection}] ini section`);let B=Object.keys(L.KeyCommandType);for(var N of O.entries.keys()){var j;B.includes(N)?(j=O.getNumber(N),this.changeHotKey(N,j)):console.warn("Unknown keyboard command "+N)}return this}async save(){let S=new N.IniFile,O=S.getOrCreateSection(e.iniSection);for(var[B,j]of this.hotKeys)O.set(j,""+B);await this.saveIni(S)}addHotKey(S,O){this.hotKeys.set("number"==typeof O?O:this.getHotKeyCode(O),S)}changeHotKey(S,O){var B;for(B of[...this.hotKeys.entries()].filter(([,O])=>O===S).map(([S])=>S))this.hotKeys.delete(B);O&&this.addHotKey(S,O)}getCommandType(S){if(!(255<S.keyCode)){var O=this.getHotKeyCode(S);return this.hotKeys.get(O)}}getHotKeyCode(S){let O=(Number(S.metaKey)<<12)+(Number(S.altKey)<<10)+(Number(S.ctrlKey)<<9)+(Number(S.shiftKey)<<8)+S.keyCode;var B=D.get(S.keyCode);return B&&(O+=2048-S.keyCode+B),O}getHotKey(S){var O,B=[...this.hotKeys.entries()].find(([,O])=>O===S)?.[0];if(void 0!==B){let S=255&B;return 2048&B&&((O=[...D].find(([,O])=>O===S)?.[0])?S=O:console.error(`Expected an numpad arrow key code but got ${S} (${B}) instead`)),{keyCode:S,shiftKey:Boolean(256&B),ctrlKey:Boolean(512&B),altKey:Boolean(1024&B),metaKey:Boolean(4096&B)}}}}),F.iniSection="Hotkey"}}}),System.register("gui/screen/game/worldInteraction/keyboard/KeyCommand",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("TriggerMode",B={}))[O.KeyDown=0]="KeyDown",O[O.KeyUp=1]="KeyUp",O[O.KeyDownUp=2]="KeyDownUp"}}}),System.register("gui/screen/game/worldInteraction/keyboard/KeyCommandType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("KeyCommandType",B={})).CenterView="CenterView",O.Options="Options",O.CenterOnRadarEvent="CenterOnRadarEvent",O.RightSidebarUp="RightSidebarUp",O.RightSidebarDown="RightSidebarDown",O.LeftSidebarDown="LeftSidebarDown",O.LeftSidebarUp="LeftSidebarUp",O.Delete="Delete",O.TeamSelect_10="TeamSelect_10",O.TeamSelect_1="TeamSelect_1",O.TeamSelect_2="TeamSelect_2",O.TeamSelect_3="TeamSelect_3",O.TeamSelect_4="TeamSelect_4",O.TeamSelect_5="TeamSelect_5",O.TeamSelect_6="TeamSelect_6",O.TeamSelect_7="TeamSelect_7",O.TeamSelect_8="TeamSelect_8",O.TeamSelect_9="TeamSelect_9",O.ToggleAlliance="ToggleAlliance",O.PlaceBeacon="PlaceBeacon",O.AllToCheer="AllToCheer",O.DeployObject="DeployObject",O.InfantryTab="InfantryTab",O.Follow="Follow",O.GuardObject="GuardObject",O.CenterBase="CenterBase",O.ToggleRepair="ToggleRepair",O.ToggleSell="ToggleSell",O.PreviousObject="PreviousObject",O.NextObject="NextObject",O.CombatantSelect="CombatantSelect",O.StructureTab="StructureTab",O.UnitTab="UnitTab",O.StopObject="StopObject",O.TypeSelect="TypeSelect",O.PageUser="PageUser",O.DefenseTab="DefenseTab",O.ScatterObject="ScatterObject",O.HealthNav="HealthNav",O.VeterancyNav="VeterancyNav",O.PlanningMode="PlanningMode",O.View1="View1",O.View2="View2",O.View3="View3",O.View4="View4",O.Taunt_1="Taunt_1",O.Taunt_2="Taunt_2",O.Taunt_3="Taunt_3",O.Taunt_4="Taunt_4",O.Taunt_5="Taunt_5",O.Taunt_6="Taunt_6",O.Taunt_7="Taunt_7",O.Taunt_8="Taunt_8",O.RaiseCell="RaiseCell",O.LowerCell="LowerCell",O.DeleteObject="DeleteObject",O.TeamAddSelect_10="TeamAddSelect_10",O.TeamAddSelect_1="TeamAddSelect_1",O.TeamAddSelect_2="TeamAddSelect_2",O.TeamAddSelect_3="TeamAddSelect_3",O.TeamAddSelect_4="TeamAddSelect_4",O.TeamAddSelect_5="TeamAddSelect_5",O.TeamAddSelect_6="TeamAddSelect_6",O.TeamAddSelect_7="TeamAddSelect_7",O.TeamAddSelect_8="TeamAddSelect_8",O.TeamAddSelect_9="TeamAddSelect_9",O.IonStorm="IonStorm",O.TeamCreate_10="TeamCreate_10",O.TeamCreate_1="TeamCreate_1",O.TeamCreate_2="TeamCreate_2",O.TeamCreate_3="TeamCreate_3",O.TeamCreate_4="TeamCreate_4",O.TeamCreate_5="TeamCreate_5",O.TeamCreate_6="TeamCreate_6",O.TeamCreate_7="TeamCreate_7",O.TeamCreate_8="TeamCreate_8",O.TeamCreate_9="TeamCreate_9",O.ScreenCapture="ScreenCapture",O.ToggleElite="ToggleElite",O.FreeMoney="FreeMoney",O.IonBlast="IonBlast",O.LightningBolt="LightningBolt",O.ToggleMono="ToggleMono",O.NukeExplosion="NukeExplosion",O.BuildCheat="BuildCheat",O.ToggleShroud="ToggleShroud",O.ToggleThreatPrint="ToggleThreatPrint",O.SpecialWeapons="SpecialWeapons",O.ToggleAttackFriendlies="ToggleAttackFriendlies",O.SetView1="SetView1",O.SetView2="SetView2",O.SetView3="SetView3",O.SetView4="SetView4",O.Explosion="Explosion",O.PrevMonoPage="PrevMonoPage",O.NextMonoPage="NextMonoPage",O.TeamCenter_10="TeamCenter_10",O.TeamCenter_1="TeamCenter_1",O.TeamCenter_2="TeamCenter_2",O.TeamCenter_3="TeamCenter_3",O.TeamCenter_4="TeamCenter_4",O.TeamCenter_5="TeamCenter_5",O.TeamCenter_6="TeamCenter_6",O.TeamCenter_7="TeamCenter_7",O.TeamCenter_8="TeamCenter_8",O.TeamCenter_9="TeamCenter_9",O.ToggleMarbleMadness="ToggleMarbleMadness",O.ForceWin="ForceWin",O.BailOut="BailOut",O.SuperExplosion="SuperExplosion",O.SidebarPageUp="SidebarPageUp",O.SidebarUp="SidebarUp",O.SidebarPageDown="SidebarPageDown",O.SidebarDown="SidebarDown",O.ToggleFps="ToggleFps",O.Scoreboard="Scoreboard"}}}),System.register("gui/screen/game/worldInteraction/keyboard/KeyboardHandler",["gui/screen/game/worldInteraction/keyboard/KeyCommandType","gui/screen/game/worldInteraction/keyboard/KeyCommand"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("KeyboardHandler",j=class e{constructor(S,O){this.keyBinds=S,this.devMode=O,this.commands=new Map,this.isPaused=!1}registerCommand(S,O){if(this.commands.has(S))throw new Error("Duplicate command "+S);this.commands.set(S,O)}unregisterCommand(S){this.commands.delete(S)}executeCommand(S){let O=this.commands.get(S);O&&!this.isPaused&&("function"==typeof O?O():O.triggerMode!==N.TriggerMode.KeyDownUp?O.execute(O.triggerMode===N.TriggerMode.KeyUp):(O.execute(!1),O.execute(!0)))}handleKeyDown(S){if("Backspace"===S.key&&(S.preventDefault(),S.stopPropagation()),!(S.repeat||["F5","F12"].includes(S.key)&&this.devMode)){let O=this.keyBinds.getCommandType(S);if(void 0===O&&(O=this.getNoModCmdType(S.keyCode)),void 0!==O){S.preventDefault(),S.stopPropagation();let B=this.commands.get(O);B&&!this.isPaused&&("function"==typeof B?B():B.triggerMode!==N.TriggerMode.KeyUp&&B.execute(!1))}}}handleKeyUp(S){if("Alt"===S.key)S.preventDefault(),S.stopPropagation();else if(!this.isPaused){let O=this.keyBinds.getCommandType(S);if(void 0===O&&(O=this.getNoModCmdType(S.keyCode)),void 0!==O){let S=this.commands.get(O);!S||"function"==typeof S||S.triggerMode!==N.TriggerMode.KeyUp&&S.triggerMode!==N.TriggerMode.KeyDownUp||S.execute(!0)}}}getNoModCmdType(S){var O=this.keyBinds.getCommandType({keyCode:S,altKey:!1,ctrlKey:!1,shiftKey:!1,metaKey:!1});if(O){var B=this.commands.get(O);if(B&&"function"!=typeof B&&e.anyModifierCommands.includes(O))return O}}pause(){this.isPaused=!0}unpause(){this.isPaused=!1}dispose(){this.commands.clear()}}),j.anyModifierCommands=[B.KeyCommandType.PlanningMode]}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/CenterBaseCmd",["engine/type/ObjectType","game/rules/TechnoRules"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("CenterBaseCmd",class{constructor(S,O,B,N){this.player=S,this.rules=O,this.mapPanningHelper=B,this.cameraPan=N}execute(){let S;var O=this.player.production.getPrimaryFactory(N.FactoryType.BuildingType);O?S=O.centerTile:(O=this.player.getOwnedObjectsByType(B.ObjectType.Vehicle).find(S=>this.rules.general.baseUnit.includes(S.name)))&&(S=O.tile),S&&this.cameraPan.setPan(this.mapPanningHelper.computeCameraPanFromTile(S.rx,S.ry))}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/CenterGroupCmd",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("CenterGroupCmd",class{constructor(S,O,B,N){this.groupNum=S,this.unitSelectionHandler=O,this.mapPanningHelper=B,this.cameraPan=N}execute(){this.unitSelectionHandler.selectGroup(this.groupNum);var S=this.unitSelectionHandler.getGroupUnits(this.groupNum);S.length&&(S=this.computePanTile(S),S=this.mapPanningHelper.computeCameraPanFromTile(S.rx,S.ry),this.cameraPan.setPan(S))}computePanTile(S){return{rx:Math.floor(S.reduce((S,O)=>S+O.tile.rx,0)/S.length),ry:Math.floor(S.reduce((S,O)=>S+O.tile.ry,0)/S.length)}}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/CenterViewCmd",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("CenterViewCmd",class{constructor(S,O,B){this.unitSelectionHandler=S,this.mapPanningHelper=O,this.cameraPan=B}execute(){var S=this.unitSelectionHandler.getSelectedUnits();S.length&&(S=this.computePanTile(S),S=this.mapPanningHelper.computeCameraPanFromTile(S.rx,S.ry),this.cameraPan.setPan(S))}computePanTile(S){return{rx:Math.floor(S.reduce((S,O)=>S+O.tile.rx,0)/S.length),ry:Math.floor(S.reduce((S,O)=>S+O.tile.ry,0)/S.length)}}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/FollowUnitCmd",["util/disposable/CompositeDisposable"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("FollowUnitCmd",class{constructor(S,O,N,j,L,D){this.unitSelectionHandler=S,this.renderableManager=O,this.worldInteraction=N,this.mapPanningHelper=j,this.cameraPan=L,this.worldScene=D,this.disposables=new B.CompositeDisposable,this.handleUserSelectionChange=()=>{this.updateUnit(void 0)},this.handleFrame=()=>{let S=this.unitSelectionHandler.getSelectedUnits();this.unit&&!S.includes(this.unit)&&this.updateUnit(void 0),this.unit&&this.updatePan(this.unit)}}init(){this.unitSelectionHandler.onUserSelectionUpdate.subscribe(this.handleUserSelectionChange),this.disposables.add(()=>this.unitSelectionHandler.onUserSelectionUpdate.unsubscribe(this.handleUserSelectionChange)),this.worldScene.onBeforeCameraUpdate.subscribe(this.handleFrame),this.disposables.add(()=>this.worldScene.onBeforeCameraUpdate.unsubscribe(this.handleFrame))}execute(){let S=this.unitSelectionHandler.getSelectedUnits();this.unit&&!S.includes(this.unit)&&this.updateUnit(void 0),this.updateUnit(this.unit?void 0:S[0]),this.unit&&this.updatePan(this.unit)}updateUnit(S){(this.unit=S)?this.worldInteraction.pausePanning():this.worldInteraction.unpausePanning()}updatePan(S){let O=this.renderableManager.getRenderableByGameObject(S);var B;O&&(B=this.mapPanningHelper.computeCameraPanFromWorld(O.getPosition()),this.cameraPan.setPan(B))}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/GoToCameraLocationCmd",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("GoToCameraLocationCmd",class{constructor(S,O,B,N){this.cameraPan=S,this.cameraLocations=O,this.idx=B,this.defaultLocation=N}execute(){var S=this.cameraLocations.get(this.idx)||this.defaultLocation;S&&this.cameraPan.setPan(S)}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/LastRadarEventCmd",["game/event/EventType","game/type/SuperWeaponType"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("LastRadarEventCmd",class{constructor(S,O,B){this.player=S,this.mapPanningHelper=O,this.cameraPan=B,this.eventHistory=[],this.eventPointer=-1}execute(){var S,O;this.eventHistory.length&&(this.lastRun?(O=(S=Date.now())-this.lastRun,this.lastRun=S,400<O?this.eventPointer=this.eventHistory.length-1:(this.eventPointer--,this.eventPointer<0&&(this.eventPointer=this.eventHistory.length-1))):this.lastRun=Date.now(),(O=this.eventHistory[this.eventPointer])&&(O=this.mapPanningHelper.computeCameraPanFromTile(O.rx,O.ry),this.cameraPan.setPan(O)))}recordEvent(S){this.eventHistory.push(S),this.eventHistory=this.eventHistory.slice(-8),this.eventPointer=this.eventHistory.length-1}handleGameEvent(S){switch(S.type){case B.EventType.RadarEvent:S.target===this.player&&this.recordEvent(S.tile);break;case B.EventType.BridgeRepair:S.source===this.player&&this.recordEvent(S.tile);break;case B.EventType.ObjectDestroy:{let O=S.target;O.isUnit()&&O.owner===this.player&&this.recordEvent(O.tile),O.isProjectile()&&O.isNuke&&this.recordEvent(O.tile)}break;case B.EventType.FactoryProduceUnit:var O=S.target;O.owner===this.player&&this.recordEvent(O.tile);break;case B.EventType.SuperWeaponActivate:O=S,[N.SuperWeaponType.IronCurtain,N.SuperWeaponType.ChronoSphere].includes(O.target)&&this.recordEvent(O.atTile2??O.atTile);break;case B.EventType.LightningStormManifest:this.recordEvent(S.target)}}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/SelectGroupCmd",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("SelectGroupCmd",class{constructor(S,O,B,N,j){this.groupNum=S,this.unitSelectionHandler=O,this.targetLines=B,this.mapPanningHelper=N,this.cameraPan=j}execute(){this.unitSelectionHandler.selectGroup(this.groupNum),this.targetLines.forceShow();var S=performance.now();let O=!0;(!this.lastSelectTime||400<S-this.lastSelectTime)&&(O=!1,this.lastSelectTime=S),!O||(S=this.unitSelectionHandler.getSelectedUnits()).length&&(S=this.computePanTile(S),S=this.mapPanningHelper.computeCameraPanFromTile(S.rx,S.ry),this.cameraPan.setPan(S))}computePanTile(S){return{rx:Math.floor(S.reduce((S,O)=>S+O.tile.rx,0)/S.length),ry:Math.floor(S.reduce((S,O)=>S+O.tile.ry,0)/S.length)}}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/SelectNextUnitCmd",["util/disposable/CompositeDisposable"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("SelectNextUnitCmd",class{constructor(S,O,N,j,L){this.unitSelectionHandler=S,this.mapPanningHelper=O,this.cameraPan=N,this.player=j,this.world=L,this.reverse=!1,this.unitList=[],this.disposables=new B.CompositeDisposable;const n=S=>{S.isTechno()&&S.owner===j&&this.unitList.push(S)};this.world.onObjectSpawned.subscribe(n),this.disposables.add(()=>this.world.onObjectSpawned.unsubscribe(n))}getNextUnit(){return this.generator||(this.generator=this.generate()),this.generator.next().value}*generate(){for(;;){let B=this.unitList=this.player.getOwnedObjects().filter(S=>S.isUnit()).sort((S,O)=>S.tile.dx+1e3*S.tile.dy-(O.tile.dx+1e3*O.tile.dy)+.1*(O.position.subCell-S.position.subCell));if(B.length){let N=this.reverse?B.length:-1,j=this.unitSelectionHandler.getSelectedUnits();var S;for(1<j.length&&j[0].isUnit()&&-1!==(S=B.indexOf(j[0]))&&(N=S);this.reverse?0<=--N:++N<B.length;){if(this.unitSelectionHandler.getHash()!==this.lastSelectionHash){this.lastSelectionHash=this.unitSelectionHandler.getHash();break}var O=B[N];O.owner===this.player&&O.isSpawned&&(yield O)}}else yield}}setReverse(S){this.reverse=S}execute(){var S=this.getNextUnit();S&&(this.unitSelectionHandler.selectSingleUnit(S),this.lastSelectionHash=this.unitSelectionHandler.getHash(),S=S.tile,S=this.mapPanningHelper.computeCameraPanFromTile(S.rx,S.ry),this.cameraPan.setPan(S))}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/SelectPlayerCmd",["gui/screen/game/worldInteraction/keyboard/command/CenterBaseCmd"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("SelectPlayerCmd",class{constructor(S,O,B,N,j){this.playerNum=S,this.player=O,this.mapPanningHelper=B,this.cameraPan=N,this.game=j}execute(){var S=performance.now();let O,N=!0;(!this.lastSelectTime||400<S-this.lastSelectTime)&&(N=!1,this.lastSelectTime=S),S=this.game.getCombatants(),this.playerNum<S.length&&(O=S[this.playerNum]),O&&(this.player.value===O||N&&!this.player.value)&&(N?new B.CenterBaseCmd(O,this.game.rules,this.mapPanningHelper,this.cameraPan).execute():O=void 0),this.player.value=O}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/SelectTypeByCmd",["gui/screen/game/worldInteraction/keyboard/KeyCommand","util/disposable/CompositeDisposable"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("SelectByTypeCmd",class{constructor(S){this.unitSelectionHandler=S,this.triggerMode=B.TriggerMode.KeyDownUp,this.disposables=new N.CompositeDisposable,this.handleUserSelectionUpdate=S=>{!S.queryType&&this.keyDownTime&&this.unitSelectionHandler.selectByType()}}init(){this.unitSelectionHandler.onUserSelectionUpdate.subscribe(this.handleUserSelectionUpdate),this.disposables.add(()=>this.unitSelectionHandler.onUserSelectionUpdate.unsubscribe(this.handleUserSelectionUpdate))}execute(S){var O=Date.now();S?(this.keyDownTime&&O-this.keyDownTime<=1e3&&this.unitSelectionHandler.selectByType(),this.keyDownTime=void 0):this.keyDownTime??(this.keyDownTime=O)}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/SetCameraLocationCmd",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("SetCameraLocationCmd",class{constructor(S,O,B){this.cameraPan=S,this.cameraLocations=O,this.idx=B}execute(){this.cameraLocations.set(this.idx,this.cameraPan.getPan())}})}}}),System.register("gui/screen/game/worldInteraction/placementMode/PlacementGrid",["game/Coords","game/theater/rampHeights","engine/gfx/OverlayUtils","util/geometry","engine/gfx/SpriteUtils","engine/IsoCoords"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){_=S}],execute:function(){F=THREE.Math.ceilPowerOfTwo,S("PlacementGrid",class{constructor(S,O,B){this.viewModel=S,this.camera=O,this.mapTiles=B,this.tileOverlays=new Map}get3DObject(){return this.target}create3DObject(){let S=new THREE.Object3D;S.name="placement_grid",this.target=S,this.createTileOverlays()}update(){if(this.refreshRangeCircle(),this.viewModel.visible||!this.tilesObject){let B=new THREE.Object3D;for(var S of(B.visible=!0,this.viewModel.tiles)){var O=this.mapTiles.getByMapCoords(S.rx,S.ry);if(!O)throw new Error(`Map tile not found for coords (${S.rx}, ${S.ry})`);let N=this.tileOverlays.get(O.rampType);if(!N)throw new Error("Missing overlay mesh for rampType "+O.rampType);let j=N.clone();j.material=j.material.clone(),S=S.buildable?this.viewModel.showBusy?16776960:65280:16711680,j.material.color.set(S),O=this.getTilePosition(O),j.position.copy(O),B.add(j)}let N=this.get3DObject();N.remove(this.tilesObject),this.tilesObject=B,N.add(B)}else this.tilesObject.visible=!1}refreshRangeCircle(){if(this.viewModel.visible||!this.rangeObject){this.rangeObject&&(this.rangeObject.visible=!0);let F=this.get3DObject();var S=this.viewModel.rangeIndicator;if(S){if(this.lastRangeCircle&&S.radius===this.lastRangeCircle.radius||(D=j.OverlayUtils.createGroundCircle(S.radius*B.Coords.getWorldTileSize(),this.viewModel.rangeIndicatorColor),this.rangeObject&&F.remove(this.rangeObject),F.add(D),this.rangeObject=D),!this.lastRangeCircle||!L.pointEquals(S.center,this.lastRangeCircle.center)){var O=Math.floor(S.center.x),N=Math.floor(S.center.y),D=this.mapTiles.getByMapCoords(O,N);if(!D)return void console.warn(`Map tile not found for coords (${O}, ${N})`);let j=this.getTilePosition(D);j.x+=S.center.x%1*B.Coords.getWorldTileSize(),j.z+=S.center.y%1*B.Coords.getWorldTileSize(),this.rangeObject.position.copy(j)}this.lastRangeCircle=S}else this.rangeObject&&(F.remove(this.rangeObject),this.rangeObject=void 0,this.lastRangeCircle=void 0)}else this.rangeObject.visible=!1}createTileOverlays(){for(let S=0;S<N.rampHeights.length;++S)this.tileOverlays.set(S,this.createTileOverlay(S))}createTileOverlay(S){var O=_.IsoCoords.getScreenTileSize();let N=D.SpriteUtils.createSpriteGeometry({texture:this.getTileOverlayTexture(),textureArea:{x:0,y:2*S*O.height,width:O.width,height:2*O.height},align:{x:0,y:-1},camera:this.camera,scale:B.Coords.ISO_WORLD_SCALE});N.applyMatrix((new THREE.Matrix4).makeTranslation(0,B.Coords.tileHeightToWorld(1),0)),O=new THREE.MeshBasicMaterial({map:this.getTileOverlayTexture(),alphaTest:.5,transparent:!0,opacity:.7,flatShading:!0,depthTest:!1,depthWrite:!1});let j=new THREE.Mesh(N,O);return j.renderOrder=1e6,j.frustumCulled=!1,j}getTilePosition(S){return B.Coords.tile3dToWorld(S.rx,S.ry,S.z)}getTileOverlayTexture(){let S=this.textureCache;if(!S){var O=_.IsoCoords.getScreenTileSize();let V=document.createElement("canvas"),W=V.getContext("2d");if(!W)throw new Error("Couldn't acquire canvas 2d context");V.width=F(O.width),V.height=F(2*O.height*N.rampHeights.length);let z=_.IsoCoords.tileToScreen(0,0);z.x+=-O.width/2;var j=B.Coords.ISO_TILE_SIZE/2;for(let S=0;S<N.rampHeights.length;++S){var L=N.rampHeights[S],D=[[0,1],[0,0],[1,0],[1,1]];W.beginPath();var U=_.IsoCoords.tileToScreen(D[0][0],D[0][1]);W.moveTo(-z.x+U.x,-z.y+U.y+(1-L[0])*j+2*S*O.height);for(let B=1;B<D.length;++B){var H=_.IsoCoords.tileToScreen(D[B][0],D[B][1]);W.lineTo(-z.x+H.x,-z.y+H.y+(1-L[B])*j+2*S*O.height)}W.closePath(),W.lineWidth=1,W.fillStyle="#"+16777215..toString(16),W.fill(),W.strokeStyle="#"+(0).toString(16),W.stroke()}S=new THREE.Texture(V),S.needsUpdate=!0,this.textureCache=S}return S}dispose(){this.tileOverlays.forEach(S=>{S.material.dispose(),S.geometry.dispose()})}})}}}),System.register("gui/screen/game/worldInteraction/placementMode/PlacementGridModel",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("gui/screen/mainMenu/MainMenuController",["gui/screen/Controller","engine/sound/SoundKey","engine/sound/ChannelType"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=class extends B.Controller{constructor(S,O,B){super(),this.mainMenu=S,this.sound=O,this.music=B}async goToScreenBlocking(...S){var[O,B]=S;return super.goToScreenBlocking(O,B)}goToScreen(...S){var[O,B]=S;return super.goToScreen(O,B)}async pushScreen(...S){var[O,B]=S;this.setMainComponent(),this.mainMenu.setSidebarTitle(""),await super.pushScreen(O,B),(O=this.screens.get(O)).title&&this.mainMenu.setSidebarTitle(O.title),void 0!==O.musicType&&await(this.music?.play(O.musicType))}async popScreen(S){this.setMainComponent(),this.mainMenu.setSidebarTitle(""),await super.popScreen(S);var O=this.getCurrentScreen();O?.title&&this.mainMenu.setSidebarTitle(O.title)}setSidebarButtons(S,O=!1){this.mainMenu.setButtons(S,O)}showSidebarButtons(){this.mainMenu.isSidebarCollapsed()&&(this.sound.play(N.SoundKey.GUIMoveInSound,j.ChannelType.Ui),this.mainMenu.showButtons())}setSidebarMpContent(S){this.mainMenu.setSidebarMpContent(S)}hideSidebarButtons(){if(!this.mainMenu.isSidebarCollapsed())return this.sound.play(N.SoundKey.GUIMoveOutSound,j.ChannelType.Ui),new Promise(S=>{let t=()=>{this.mainMenu.onSidebarToggle.unsubscribe(t),S()};this.mainMenu.onSidebarToggle.subscribe(t),this.mainMenu.hideButtons()})}toggleSidebarPreview(S){this.mainMenu.toggleSidebarPreview(S)}setSidebarPreview(S){this.mainMenu.setSidebarPreview(S)}getSidebarPreviewSize(){return this.mainMenu.getSidebarPreviewSize()}toggleMainVideo(S){this.mainMenu.toggleVideo(S)}showVersion(S){this.mainMenu.showVersion(S)}hideVersion(){this.mainMenu.hideVersion()}setMainComponent(S){this.mainMenu.setContentComponent(S)}destroy(){this.setMainComponent(void 0),super.destroy()}},S("MainMenuController",L)}}}),System.register("gui/screen/mainMenu/MainMenuRootScreen",["gui/jsx/jsx","gui/screen/mainMenu/component/MainMenu","gui/screen/mainMenu/MainMenuController","gui/screen/mainMenu/ScreenType","engine/resourceConfigs","util/disposable/CompositeDisposable","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation","gui/jsx/HtmlView","gui/screen/mainMenu/component/PrefetchProgress","@puzzl/core/lib/async/sleep","gui/screen/RootScreen"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S}],execute:function(){K=class extends z.RootScreen{constructor(S,O,B,N,j,L,D,_,U,H,V){super(),this.subScreens=S,this.uiScene=O,this.gameResConfig=B,this.strings=N,this.images=j,this.jsxRenderer=L,this.videoSrc=D,this.cdnResourceLoader=_,this.sound=U,this.music=H,this.sentry=V,this.prefetched=!1,this.disposables=new F.CompositeDisposable}createView(){var S;this.mainMenu=new N.MainMenu(this.uiScene.menuViewport,this.images,this.jsxRenderer,this.videoSrc),!this.prefetched&&this.gameResConfig.isCdn()&&([S]=this.jsxRenderer.render(B.jsx(H.HtmlView,{component:V.PrefetchProgress,ref:S=>this.prefetchProgressView=S,props:{progress:0,statusText:this.strings.get("TS:Preloading")}})),this.prefetchProgressEl=S,this.prefetched=!0,this.updatePrefetchProgressViewport())}createViewAndController(){return this.createView(),this.mainMenuCtrl=new j.MainMenuController(this.mainMenu,this.sound,this.music),this.mainMenuCtrl.onScreenChange.subscribe(S=>this.sentry?.addBreadcrumb({category:"ui",message:void 0!==S?"Navigated to screen "+L.ScreenType[S]:"Navigated to previous screen",level:"info"})),this.mainMenuCtrl}onViewportChange(){this.mainMenu&&this.mainMenu.setViewport(this.uiScene.menuViewport),this.mainMenuCtrl?.rerenderCurrentScreen(),this.updatePrefetchProgressViewport()}onEnter(S){let O=this.createViewAndController();for(var[B,N]of this.subScreens)O.addScreen(B,N);if(this.uiScene.add(this.mainMenu),setTimeout(()=>{S?.route?O.goToScreen(S.route.screenType,S.route.params):O.goToScreen(L.ScreenType.Home)}),this.prefetchProgressEl){let S=!1,O=new _.Task(async O=>{await W.sleep(5e3,O),W.sleep(15e3,O).then(()=>{S||this.uiScene.add(this.prefetchProgressEl)}).catch(S=>{if(!(S instanceof U.OperationCanceledError))throw S}),await this.cdnResourceLoader.loadResources(D.resourcesForPrefetch,O,S=>{this.prefetchProgressView.getElement().applyOptions(O=>O.progress=S)}),S=!0,this.uiScene.remove(this.prefetchProgressEl)});O.start().catch(O=>{this.prefetchProgressEl&&this.uiScene.remove(this.prefetchProgressEl),S=!0,O instanceof U.OperationCanceledError||console.error(O)}).then(()=>O=void 0),this.disposables.add(()=>{O?.cancel(),this.prefetchProgressEl.destroy(),this.prefetchProgressEl=void 0,this.prefetchProgressView=void 0})}}updatePrefetchProgressViewport(){this.prefetchProgressEl?.getHtmlContainer()?.setSize(this.uiScene.viewport.width,0)}async onLeave(){this.mainMenuCtrl&&(this.mainMenuCtrl.toggleMainVideo(!1),await this.mainMenuCtrl.leaveCurrentScreen(),this.mainMenuCtrl.destroy(),this.mainMenuCtrl=void 0),this.uiScene.remove(this.mainMenu),this.mainMenu.destroy(),this.mainMenu=void 0,this.disposables.dispose()}},S("MainMenuRootScreen",K)}}}),System.register("gui/screen/mainMenu/MainMenuRoute",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("MainMenuRoute",class{constructor(...S){var[O,B]=S;this.screenType=O,this.params=B}})}}}),System.register("gui/screen/mainMenu/MainMenuScreen",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("MainMenuScreen",class{setController(S){this.controller=S}})}}}),System.register("gui/screen/mainMenu/ScreenParamsMap",["gui/screen/mainMenu/ScreenType"],function(S,O){"use strict";return O&&O.id,{setters:[function(S){}],execute:function(){}}}),System.register("gui/screen/mainMenu/ScreenType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("ScreenType",B={}))[O.Home=0]="Home",O[O.Skirmish=1]="Skirmish",O[O.QuickGame=2]="QuickGame",O[O.CustomGame=3]="CustomGame",O[O.Login=4]="Login",O[O.NewAccount=5]="NewAccount",O[O.Lobby=6]="Lobby",O[O.MapSelection=7]="MapSelection",O[O.Ladder=8]="Ladder",O[O.LadderRules=9]="LadderRules",O[O.ReplaySelection=10]="ReplaySelection",O[O.ModSelection=11]="ModSelection",O[O.Score=12]="Score",O[O.InfoAndCredits=13]="InfoAndCredits",O[O.PatchNotes=14]="PatchNotes",O[O.Credits=15]="Credits",O[O.Options=16]="Options",O[O.OptionsSound=17]="OptionsSound",O[O.OptionsKeyboard=18]="OptionsKeyboard",O[O.OptionsStorage=19]="OptionsStorage",O[O.CustomAiManager=20]="CustomAiManager"}}}),System.register("gui/screen/mainMenu/component/Iframe",["react"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("Iframe",({src:S,className:O})=>B.createElement("iframe",{src:S,className:O}))}}}),System.register("gui/screen/mainMenu/component/MainMenu",["gui/jsx/jsx","gui/UiObject","gui/HtmlContainer","gui/screen/mainMenu/component/MenuVideo","gui/component/MenuButton","util/event","gui/screen/mainMenu/component/MenuSlotAnimationRunner","gui/jsx/HtmlView","gui/screen/mainMenu/component/MenuMpSlotAnimRunner","gui/screen/mainMenu/component/MenuMpSlotText","gui/screen/mainMenu/component/SidebarPreview","gui/screen/mainMenu/component/MenuTooltip","gui/screen/mainMenu/component/VersionString"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S}],execute:function(){$=class extends N.UiObject{constructor(S,O,B,N){super(new THREE.Object3D,new j.HtmlContainer),this.viewport=S,this.images=O,this.jsxRenderer=B,this.videoSrc=N,this.rootObjects=[],this.sidebarObjects=[],this.sidebarSlots=[],this.sidebarMpSlotEnabled=!1,this.sidebarButtons=[],this.sidebarButtonConfigs=[],this.sidebarCollapsed=!0,this._onSidebarToggle=new F.EventDispatcher,this.create3DObject()}get onSidebarToggle(){return this._onSidebarToggle}setViewport(S){this.viewport=S,this.setPosition(this.viewport.x,this.viewport.y);var O=this.getImage("lwscrnl.shp");this.statusBar.setPosition(0,this.viewport.height-O.height);var B=this.getImage("sdtp.shp");O=this.computeSidebarViewport(B),this.sidebarContainer.setPosition(O.x,O.y),this.sidebarContainer.remove(...this.sidebarObjects),this.sidebarObjects.forEach(S=>S.destroy()),this.createSidebarButtons(this.computeSidebarButtonsViewport(B)),this.updateButtons(this.sidebarButtonsRawConfigs??[]),this.sidebarCollapsed||this.showButtons()}setContentComponent(S){let O=this.mainContainer;this.contentComponent&&(O.remove(this.contentComponent),this.contentComponent.destroy(),this.contentComponent=void 0),S&&(O.add(S),this.contentComponent=S)}setSlots(S,O,B=!1){let N=this.sidebarSlots.length;if(!N)throw new Error("Cannot call setButtons prior to render");this.sidebarMpSlotContainer.setVisible(B),this.sidebarSlots[0].setVisible(!B),this.sidebarSlots.forEach((j,L)=>{j.getAnimationRunner().buttonState=L<S+(B?1:0)||L===N-1&&O?_.MenuButtonState.Unlit:_.MenuButtonState.Hidden})}setButtons(S,O=!1){this.sidebarButtonsRawConfigs=S,this.sidebarMpSlotEnabled=O,this.updateButtons(S)}updateButtons(S){let O=this.sidebarMpSlotEnabled;var B=!!S.find(S=>!!S.isBottom);this.setSlots(S.length-(B?1:0),B,O),this.updateSidebarMpContent(),this.sidebarButtons.forEach(S=>S.applyOptions(S=>S.buttonConfig=void 0)),S.forEach((S,B)=>{var N=S.isBottom?this.sidebarButtons.length-1:O?B+1:B;this.sidebarButtonConfigs[N]=S,this.sidebarButtons[N]?.applyOptions(O=>O.buttonConfig={label:S.label,tooltip:S.tooltip,disabled:!!S.disabled})}),this.sidebarNeedsRefresh=!0}isSidebarCollapsed(){return this.sidebarCollapsed}showButtons(){this.sidebarCollapsed=!1,this.sidebarNeedsRefresh=!0,this.sidebarMpSlot.getAnimationRunner().slideIn(),this.sidebarSlots.forEach(S=>{S.getAnimationRunner().slideIn()})}hideButtons(){this.sidebarCollapsed=!0,this.updateSidebarButtons(),this.sidebarNeedsRefresh=!0,this.sidebarMpSlot.getAnimationRunner().slideOut(),this.sidebarSlots.forEach(S=>{S.getAnimationRunner().slideOut()})}setSidebarTitle(S){this.sidebarPreview.setTitle(S)}toggleSidebarPreview(S){this.sidebarPreview.toggleSidebarPreview(S)}setSidebarPreview(S){this.sidebarPreviewInner&&this.sidebarPreviewInner.destroy(),this.sidebarPreview.setPreview(S),this.sidebarPreviewInner=S}getSidebarPreviewSize(){return this.sidebarPreview.getPreviewSize()}toggleVideo(S){if(!this.menuVideo)throw new Error("Cannot call toggleVideo prior to render");this.menuVideo.getUiObject().setVisible(S)}showVersion(S){this.version.getUiObject().setVisible(!0),this.version.getElement().applyOptions(O=>O.value=S)}hideVersion(){this.version.getUiObject().setVisible(!1)}setSidebarMpContent(S){this.sidebarMpSlotContent=S,this.updateSidebarMpContent()}updateSidebarMpContent(){this.sidebarMpSlotContentEl.applyOptions(S=>{this.sidebarMpSlotContent&&(S.text=this.sidebarMpSlotContent.text,S.icon=this.sidebarMpSlotContent.icon,S.tooltip=this.sidebarMpSlotContent.tooltip)})}getImage(S){var O=this.images.get(S);if(!O)throw new Error(`Missing image "${S}"`);return O}create3DObject(){var S,O,N,j,D;super.create3DObject(),this.rootObjects.length||(this.setPosition(this.viewport.x,this.viewport.y),S=this.getImage("mnscrnl.shp"),O=this.getImage("lwscrnl.shp"),N=this.getImage("sdtp.shp"),j=this.getImage("sdwrnanm.shp"),D=this.computeSidebarViewport(N),this.rootObjects=this.jsxRenderer.render(B.jsx("fragment",null,B.jsx("container",{width:S.width,height:S.height,ref:S=>this.mainContainer=S},B.jsx("sprite",{image:S,palette:"shell.pal"}),B.jsx(U.HtmlView,{component:L.MenuVideo,props:{src:this.videoSrc},hidden:!0,ref:S=>this.menuVideo=S})),B.jsx("container",{x:0,y:this.viewport.height-O.height,ref:S=>this.statusBar=S},B.jsx("sprite",{image:O,palette:"shell.pal"}),B.jsx(U.HtmlView,{component:z.MenuTooltip,props:{monitorContainer:this.getHtmlContainer()},width:O.width,height:O.height})),B.jsx("container",{x:D.x,y:D.y,ref:S=>this.sidebarContainer=S},B.jsx(W.SidebarPreview,{sdtpImg:N,sdtpAnimImg:j,closed:!0,ref:S=>this.sidebarPreview=S}),B.jsx(U.HtmlView,{component:K.VersionString,props:{value:""},width:D.width,y:D.height-20,ref:S=>this.version=S,hidden:!0})))),this.add(...this.rootObjects),this.createSidebarButtons(this.computeSidebarButtonsViewport(N)))}createSidebarButtons(S){let O=this.getImage("sdbtnbkgd.shp"),N=this.getImage("sdbtnanm.shp");var j=Math.floor(S.height/O.height);let L=this.getImage("sdbtm.shp");var F=S.height-O.height*j;F=L.clip(L.width,F),this.sidebarSlots=[],this.sidebarButtons=[],this.sidebarObjects=this.jsxRenderer.render(B.jsx("fragment",null,new Array(j).fill(0).map((j,L)=>{let F=new _.MenuSlotAnimationRunner(L);return B.jsx("fragment",null,B.jsx("container",{x:S.x,y:S.y+O.height*L},B.jsx("sprite",{image:O,palette:"shell2.pal"}),L?[]:B.jsx("container",{zIndex:1,hidden:!0,ref:S=>this.sidebarMpSlotContainer=S,x:12,y:-O.height},B.jsx("sprite",{image:"sdmpbtn.shp",palette:"shell.pal",ref:S=>this.sidebarMpSlot=S,animationRunner:new H.MenuMpSlotAnimRunner}),B.jsx(U.HtmlView,{component:V.MenuMpSlotText,props:{text:""},width:146,height:2*O.height,innerRef:S=>this.sidebarMpSlotContentEl=S})),B.jsx("sprite",{image:N,palette:"sdbtnanm.pal",ref:S=>this.sidebarSlots.push(S),x:12,animationRunner:F}),B.jsx(U.HtmlView,{x:12,hidden:!0,innerRef:S=>this.sidebarButtons.push(S),component:D.MenuButton,props:{box:{x:0,y:0,width:146,height:N.height},onMouseDown:()=>{F.buttonState=_.MenuButtonState.Active;let e=()=>{F.buttonState=_.MenuButtonState.Normal,document.removeEventListener("mouseup",e)};document.addEventListener("mouseup",e)},onClick:()=>{this.onSidebarButtonClick(L)}}})))}),B.jsx("sprite",{image:F,palette:"shell.pal",x:S.x,y:S.y+O.height*j}))),this.sidebarContainer.add(...this.sidebarObjects)}computeSidebarViewport(S){return{x:this.viewport.width-S.width,y:0,width:S.width,height:this.viewport.height}}computeSidebarButtonsViewport(S){return{x:0,y:S.height,width:S.width,height:this.viewport.height-S.height}}update(S){super.update(S),this.sidebarNeedsRefresh&&this.sidebarSlots[this.sidebarSlots.length-1].getAnimationRunner().isStopped()&&(this.updateSidebarButtons(),this._onSidebarToggle.dispatch(this,!this.sidebarCollapsed))}updateSidebarButtons(){this.sidebarCollapsed?(this.sidebarButtons.forEach(S=>S.hide()),this.sidebarMpSlotContentEl.hide(),this.sidebarSlots.forEach(S=>{let O=S.getAnimationRunner();O.buttonState===_.MenuButtonState.Normal&&(O.buttonState=_.MenuButtonState.Unlit)})):(this.sidebarButtons.forEach(S=>S.show()),this.sidebarMpSlotContentEl.show(),this.sidebarSlots.forEach(S=>{let O=S.getAnimationRunner();O.buttonState===_.MenuButtonState.Unlit&&(O.buttonState=_.MenuButtonState.Normal)})),this.sidebarNeedsRefresh=!1}onSidebarButtonClick(S){const O=this.sidebarButtonConfigs[S].onClick;O&&O()}destroy(){this.sidebarButtons.length=0,this.remove(...this.rootObjects),this.rootObjects.forEach(S=>S.destroy()),this.rootObjects.length=0,super.destroy()}},S("MainMenu",$)}}}),System.register("gui/screen/mainMenu/component/MenuMpSlotAnimRunner",["gui/screen/mainMenu/component/MenuSlotAnimationRunner","engine/Animation"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends B.MenuSlotAnimationRunner{getCurrentFrame(){if(this.currentAnimationType===B.AnimationType.None||this.animation.getState()===N.AnimationState.DELAYED)return this.collapsed?6:0;{var S=this.currentAnimationType===B.AnimationType.SlideIn?-1:1;let O=1;return-1==S&&(O+=5),O+S*this.animation.getCurrentFrame()}}},S("MenuMpSlotAnimRunner",j)}}}),System.register("gui/screen/mainMenu/component/MenuMpSlotText",["react","gui/component/Image"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("MenuMpSlotText",({text:S,icon:O,tooltip:j})=>B.default.createElement("div",{className:"menu-mp-slot"},B.default.createElement("pre",{className:"menu-mp-slot-text"},S),O&&B.default.createElement("div",{className:"menu-mp-slot-icon","data-r-tooltip":j},B.default.createElement(N.Image,{src:O}))))}}}),System.register("gui/screen/mainMenu/component/MenuSdTopAnimRunner",["gui/screen/mainMenu/component/MenuSlotAnimationRunner","engine/Animation"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends B.MenuSlotAnimationRunner{getCurrentFrame(){if(this.currentAnimationType===B.AnimationType.None||this.animation.getState()===N.AnimationState.DELAYED)return this.collapsed?5:0;{var S=this.currentAnimationType===B.AnimationType.SlideIn?-1:1;let O=0;return-1==S&&(O+=5),O+S*this.animation.getCurrentFrame()}}},S("MenuSdTopAnimRunner",j)}}}),System.register("gui/screen/mainMenu/component/MenuSlotAnimationRunner",["data/IniSection","data/ShpFile","engine/Animation","engine/AnimProps","engine/Engine","util/BoxedVar"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){var O;(O=_||S("AnimationType",_={}))[O.None=0]="None",O[O.SlideIn=1]="SlideIn",O[O.SlideOut=2]="SlideOut",(O=U||S("MenuButtonState",U={}))[O.Hidden=0]="Hidden",O[O.Unlit=1]="Unlit",O[O.Normal=2]="Normal",O[O.Active=3]="Active",S("MenuSlotAnimationRunner",class{constructor(S=0){this.delayFrames=S,this.buttonState=U.Hidden,this.collapsed=!0,this.currentAnimationType=_.None}slideIn(){this.currentAnimationType=_.SlideIn,this.initAnimation()}slideOut(){this.currentAnimationType=_.SlideOut,this.initAnimation()}initAnimation(){var S=new B.IniSection("");let O=new L.AnimProps(S,new N.ShpFile);O.loopEnd=5,S=new j.Animation(O,new F.BoxedVar(D.Engine.UI_ANIM_SPEED)),this.animation=S}tick(S){let O=this.animation;var B=this.currentAnimationType;if(O&&B!==_.None){switch(O.getState()){case j.AnimationState.STOPPED:break;case j.AnimationState.NOT_STARTED:O.start(S,this.delayFrames);case j.AnimationState.RUNNING:default:O.update(S)}O.getState()===j.AnimationState.STOPPED&&(this.collapsed=B===_.SlideOut,this.currentAnimationType=_.None)}}shouldUpdate(){return!0}isStopped(){return this.currentAnimationType===_.None}getCurrentFrame(){if(this.currentAnimationType!==_.None&&this.animation.getState()!==j.AnimationState.DELAYED){var S=this.currentAnimationType===_.SlideIn?-1:1;let O=this.buttonState!==U.Hidden?5:11;return-1==S&&(O+=5),O+S*this.animation.getCurrentFrame()}let O;if(this.collapsed)O=this.buttonState===U.Hidden?16:10;else if(this.buttonState===U.Hidden)O=0;else if(this.buttonState===U.Unlit)O=1;else if(this.buttonState===U.Normal)O=2;else{if(this.buttonState!==U.Active)throw new Error(`Unknown buttonState "${this.buttonState}"`);O=4}return O}})}}}),System.register("gui/screen/mainMenu/component/MenuTooltip",["react","classnames"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("MenuTooltip",({monitorContainer:S})=>{const[O,j]=B.useState(""),[L,D]=B.useState(!1);return B.useEffect(()=>{let O,B=S.getElement();const r=S=>{let N=S.target;if(N!==O){O=N;let S=N.getAttribute?.("data-r-tooltip");for(;N&&N!==B&&!S;)N=N.parentElement,S=N.getAttribute("data-r-tooltip");j(S||"")}};return B.addEventListener("mousemove",r),B.addEventListener("mouseleave",r),()=>{B.removeEventListener("mousemove",r),B.removeEventListener("mouseleave",r)}},[]),B.useEffect(()=>{D(!1);const S=setTimeout(()=>D(!0),10);return()=>clearTimeout(S)},[O]),B.default.createElement("div",{className:N.default("menu-tooltip",{anim:L})},O)})}}}),System.register("gui/screen/mainMenu/component/MenuVideo",["react","util/disposable/CompositeDisposable"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=new Map([["mp4","video/mp4"],["webm","video/webm"]]),L=class extends B.default.Component{constructor(){super(...arguments),this.el=null,this.disposables=new N.CompositeDisposable,this.disposed=!1}render(){const S=this.props.src;let O,N;return"string"==typeof S?(N=S,O=j.get(S.split("?")[0].split(".").pop())??"video/webm"):(N=URL.createObjectURL(S),O=S.type,this.disposables.add(()=>{URL.revokeObjectURL(N)})),B.default.createElement("div",{className:"video-wrapper",ref:S=>this.el=S,dangerouslySetInnerHTML:{__html:`\n            <video style="outline: none;" loop playsinline muted autoplay>\n                <source src="${N}" type="${O}" />\n            </video>\n            <div class="logo" style="opacity: 0;" />\n        `}})}componentDidMount(){const S=this.props.src;let O=this.el.querySelector("video"),B=this.el.querySelector("div");if(S instanceof File&&window.MediaSource){let i=async()=>{this.applyMediaSourceFallback(O,await S.arrayBuffer())};O.querySelector("source").addEventListener("error",i,{once:!0}),O.addEventListener("loadeddata",()=>{O.querySelector("source").removeEventListener("error",i)})}O.addEventListener("loadeddata",()=>{B.style.opacity=""})}async applyMediaSourceFallback(S,O){if(!this.disposed){let B=new MediaSource;B.addEventListener("sourceopen",()=>{try{let N=B.addSourceBuffer('video/webm; codecs="vp8"');N.mode="sequence",N.appendBuffer(O),this.timeoutId=setTimeout(()=>this.processNextSegment(N,S,O),1e3),this.disposables.add(()=>clearTimeout(this.timeoutId))}catch(S){return void("NotSupportedError"!==S.name&&console.error(S))}});let N=S.src=URL.createObjectURL(B);this.disposables.add(()=>{URL.revokeObjectURL(N),N=void 0})}}processNextSegment(S,O,B){try{!S.updating&&0<S.buffered.length&&(S.buffered.end(S.buffered.length-1)-O.currentTime<10&&S.appendBuffer(B),O.paused&&O.play()?.catch(S=>console.error(S)))}catch(S){return void console.error(S)}this.timeoutId=setTimeout(()=>this.processNextSegment(S,O,B),1e3)}componentWillUnmount(){this.disposables.dispose(),this.disposed=!0}},S("MenuVideo",L)}}}),System.register("gui/screen/mainMenu/component/PrefetchProgress",["react"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("PrefetchProgress",({progress:S,statusText:O})=>B.default.createElement("div",{className:"prefetch-progress"},B.default.createElement("div",null,B.default.createElement("label",null,O),B.default.createElement("progress",{value:S,max:100}))))}}}),System.register("gui/screen/mainMenu/component/SidebarPreview",["gui/jsx/jsx","gui/jsx/UiComponent","gui/UiObject","gui/HtmlContainer","gui/screen/mainMenu/component/MenuSdTopAnimRunner","data/IniSection","engine/AnimProps","engine/Animation","engine/animation/SimpleRunner","gui/jsx/HtmlView","gui/screen/mainMenu/component/SidebarTitle","engine/Engine","util/BoxedVar"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S}],execute:function(){$=class extends N.UiComponent{constructor(){super(...arguments),this.sidebarPreviewNeedsRefresh=!1,this.closed=this.props.closed,this.preview=this.props.preview,this.title=this.props.title}createUiObject(){let S=new j.UiObject(new THREE.Object3D,new L.HtmlContainer);return S.onFrame.subscribe(S=>this.handleFrame(S)),S}defineChildren(){var{sdtpImg:S,sdtpAnimImg:O}=this.props,N=this.closed;let j=this.preview;var L=this.title||"",$=new F.IniSection("");let q=new _.AnimProps($,O);q.loopCount=-1,$=new U.Animation(q,new K.BoxedVar(z.Engine.UI_ANIM_SPEED));let Q=new H.SimpleRunner;return Q.animation=$,$=this.getPreviewSize(),B.jsx("fragment",null,B.jsx("sprite",{image:S,palette:"shell.pal",frame:N?0:1,ref:S=>this.sidebarTop=S}),B.jsx(V.HtmlView,{component:W.SidebarTitle,props:{title:L},innerRef:S=>this.titleView=S,x:25,y:3,width:118,height:this.closed?32:18}),B.jsx("sprite",{image:"sdwrntmp.shp",palette:"shell.pal",hidden:!0,ref:S=>this.sidebarTopPreviewAnim=S,animationRunner:new D.MenuSdTopAnimRunner}),B.jsx("sprite",{image:O,palette:"shell2.pal",x:38,y:48,hidden:!N,ref:S=>this.sidebarTopClosedAnim=S,animationRunner:Q}),B.jsx("container",{hidden:!j||N,ref:S=>{this.previewContainer=S,j&&this.previewContainer.add(j)},x:12,y:40,width:$.width,height:$.height}))}getPreviewSize(){return{width:146,height:112}}toggleSidebarPreview(S){if(this.closed!==!S){let O=this.sidebarTopPreviewAnim.getAnimationRunner();S?O.slideIn():O.slideOut(),this.closed=!S,this.sidebarPreviewNeedsRefresh=!0,this.sidebarTopPreviewAnim.setVisible(!0),(S?this.sidebarTopClosedAnim:this.previewContainer).setVisible(!1),this.titleView.setVisible(!1),this.updateTitleSize()}}setPreview(S){this.preview&&this.previewContainer.remove(this.preview),S&&this.previewContainer.add(S),this.preview=S}setTitle(S){this.title=S,this.titleView.applyOptions(O=>O.title=S),this.updateTitleSize()}updateTitleSize(){this.titleView.setSize(this.titleView.getSize().width,this.closed?32:18)}handleFrame(S){this.sidebarPreviewNeedsRefresh&&this.sidebarTopPreviewAnim.getAnimationRunner().isStopped()&&((this.closed?this.sidebarTopClosedAnim:this.previewContainer).setVisible(!0),this.sidebarTopPreviewAnim.setVisible(!1),this.sidebarTop.setFrame(this.closed?0:1),this.titleView.setVisible(!0),this.sidebarPreviewNeedsRefresh=!1)}},S("SidebarPreview",$)}}}),System.register("gui/screen/mainMenu/component/SidebarTitle",["react"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("SidebarTitle",({title:S})=>B.default.createElement("div",{className:"sidebar-title"},S))}}}),System.register("gui/screen/mainMenu/component/VersionString",["react"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("VersionString",({value:S})=>B.default.createElement("div",{className:"menu-version-string"},"v",S))}}}),System.register("gui/screen/mainMenu/component/viewmodel/MenuButtonConfig",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("gui/screen/mainMenu/credits/Credits",["react"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("Credits",({contentTpl:S,strings:O})=>{var N=S.replace(/\{([^}]+)\}/g,(S,B)=>O.get(B)).replace(/<([^>]+)>/g,(S,O)=>O.match(/^(https?|mailto):(\/\/)?/)?`<a href='${encodeURI(O)}' target='_blank' rel='noopener'>${encodeURI(O)}</a>`:"").replace(/\t*\r?\n/g,"<br />").replace(/([^>]+)\t+([^<]+)<br \/>/g,"<div class='def'>\n                <span class='title'>$1</span>\n                <span class='filler'></span>\n                <span class='name'>$2</span>\n            </div>");return B.createElement("div",{className:"credits-container"},B.createElement("div",{className:"credits",dangerouslySetInnerHTML:{__html:N}}))})}}}),System.register("gui/screen/mainMenu/credits/CreditsScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/credits/Credits","engine/Engine","gui/screen/mainMenu/MainMenuScreen"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=class extends D.MainMenuScreen{constructor(S,O){super(),this.strings=S,this.jsxRenderer=O,this.title=this.strings.get("GUI:Credits")}onEnter(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!1);var S=L.Engine.vfs?.openFile("creditscd.txt").readAsString("utf-8")??"";S=(L.Engine.vfs?.openFile("credits.txt").readAsString()??"").replace(/\s+\{CRD:CREDITS\}\s+/,S);var[S]=this.jsxRenderer.render(B.jsx(N.HtmlView,{width:"100%",height:"100%",component:j.Credits,props:{contentTpl:S,strings:this.strings}}));this.controller.setMainComponent(S)}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},S("CreditsScreen",F)}}}),System.register("gui/screen/mainMenu/customGame/CustomGameScreen",["gui/screen/mainMenu/customGame/component/GameBrowser","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","engine/sound/SoundKey","engine/sound/ChannelType","engine/sound/Music","network/IrcConnection","gui/screen/mainMenu/MainMenuScreen","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation/OperationCanceledError","network/ladder/wladderConfig","gui/screen/mainMenu/MainMenuRoute","network/chat/ChatMessage","gui/chat/ChatHistory","network/WolError","@puzzl/core/lib/async/cancellation"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S}],execute:function(){X=class extends V.MainMenuScreen{constructor(S,O,B,N,L,D,H,V,W,z){super(),this.engineModHash=S,this.strings=O,this.wolCon=B,this.wolService=N,this.wladderService=L,this.jsxRenderer=D,this.sound=H,this.serverRegions=V,this.mapList=W,this.errorHandler=z,this.title=this.strings.get("GUI:CustomMatch"),this.musicType=U.MusicType.NormalShuffle,this.playerProfiles=new Map,this.disposables=new j.CompositeDisposable,this.onChannelJoinLeave=S=>{let O=S.channel,B=O.match(/#Lob \d+ (\d)/i);var N;B&&([,N]=B.map(Number),O=this.strings.get("TXT_LOB_"+(N+1))),S.user.name===this.wolCon.getCurrentUser()?this.addSystemMessage(this.strings.get("join"===S.type?"TXT_JOINED_S":"TXT_YOULEFT",O)):S.channel===this.channelName&&("join"===S.type?(this.users.push(S.user),this.users.sort((S,O)=>Number(O.operator)-Number(S.operator))):-1!==(N=this.users.findIndex(O=>O.name===S.user.name))&&this.users.splice(N,1),this.gameBrowser?.refresh())},this.onChannelUsers=S=>{S.channelName===this.channelName&&(this.users=S.users,this.gameBrowser?.applyOptions(S=>S.users=this.users))},this.onChannelMessage=S=>{S.to.type!==q.ChatRecipientType.Page&&S.to.type!==q.ChatRecipientType.Whisper||this.sound.play(F.SoundKey.IncomingMessage,_.ChannelType.Ui);var O={...S,operator:this.users.find(O=>O.name===S.from)?.operator};this.messages.push(O),this.gameBrowser?.refresh(),S.to.type===q.ChatRecipientType.Whisper&&S.to.name!==this.wolCon.getServerName()&&S.from!==this.wolCon.getCurrentUser()&&(this.chatHistory.lastWhisperFrom.value=S.from)},this.onWolClose=()=>{clearInterval(this.refreshTimeoutId)},this.onWolConLost=S=>{this.handleError(S,this.strings.get("TXT_YOURE_DISCON"))}}addSystemMessage(S){this.messages.push({text:S}),this.gameBrowser?.refresh()}async refreshGames(S){if(this.wolCon.isOpen()){if(this.channelName&&this.wolCon.getCurrentUser()){let B;try{var O=this.wolService.getConfig().getClientChannelType();if(B=await this.wolCon.listGames(O,O),S?.isCancelled())return}catch(S){if(S instanceof H.IrcConnection.SocketError)return;if(S instanceof H.IrcConnection.NoReplyError)return;throw S}B.sort((S,O)=>Number(S.passLocked)-Number(O.passLocked)),this.games=B;const N=this.selectedGame;N&&this.onGameSelectionChange(B.find(S=>S.name===N.name)),this.gameBrowser?.applyOptions(S=>S.games=B),this.refreshPlayerRanks()}}else this.onWolClose()}refreshPlayerRanks(){if(this.wladderService.getUrl()){this.ranksUpdateTask?.cancel();let S=this.ranksUpdateTask=new W.Task(async S=>{let O=[...new Set([...this.users.map(S=>S.name),...this.games.map(S=>S.hostName)])].filter(S=>!this.playerProfiles.has(S));if(O.length){for(;0<O.length;){var B,N=O.splice(0,K.MAX_LIST_SEARCH_COUNT);if(N=await this.wladderService.listSearch(N,S),S.isCancelled())return;for(B of N)this.playerProfiles.set(B.name,B)}this.gameBrowser?.refresh()}});S.start().catch(S=>{S instanceof z.OperationCanceledError||console.error(S)})}}onGameSelectionChange(S){this.selectedGame=S,this.refreshSidebarButtons()}gameIsFull(S){return S.humanPlayers+S.aiPlayers===S.maxPlayers-(S.observable?1:0)}refreshSidebarButtons(){let S=this.selectedGame;var O=[{label:this.strings.get("GUI:CreateGame"),tooltip:this.strings.get("STT:LobbyButtonNew"),onClick:()=>this.createGame()},{label:this.strings.get("GUI:JoinGame"),tooltip:this.strings.get("STT:LobbyButtonJoin"),disabled:!S||this.gameIsFull(S),onClick:()=>this.joinGame(S)},{label:this.strings.get("GUI:Observe"),tooltip:this.strings.get("STT:LobbyButtonObserve"),disabled:!S||!S.observable||!!S.observers,onClick:()=>{this.observeGame(S)}},...1<this.serverRegions.getSize()?[{label:this.strings.get("GUI:ChangeServer"),tooltip:this.strings.get("STT:ChangeServer"),onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(N.ScreenType.Login,{clearCredentials:!0,afterLogin:S=>new $.MainMenuRoute(N.ScreenType.CustomGame,{messages:S})})}}]:[],{label:this.strings.get("GUI:Back"),tooltip:this.strings.get("STT:LobbyButtonBack"),isBottom:!0,onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(N.ScreenType.Home)}}];this.controller.setSidebarButtons(O)}initView(S){var[O]=this.jsxRenderer.render(L.jsx(D.HtmlView,{innerRef:S=>this.gameBrowser=S,component:B.GameBrowser,props:{strings:this.strings,messages:this.messages,chatHistory:this.chatHistory,channels:[this.channelName],localUsername:this.wolCon.getCurrentUser(),users:this.users,games:this.games,playerProfiles:this.playerProfiles,mapList:this.mapList,onSendMessage:S=>{S.value.length?this.wolCon.isOpen()&&(this.wolCon.sendChatMessage(S.value,S.recipient),S.recipient.type===q.ChatRecipientType.Whisper&&(this.chatHistory.lastWhisperTo.value=S.recipient.name)):this.addSystemMessage(this.strings.get("TXT_ENTER_MESSAGE"))},onRefreshClick:()=>this.refreshGames(S),onSelectGame:S=>this.onGameSelectionChange(S),onDoubleClickGame:S=>{this.gameIsFull(S)||this.joinGame(S)}}}));this.controller.setMainComponent(O),this.refreshSidebarButtons(),this.controller.showSidebarButtons()}async onEnter(S){this.messages=S?.messages??[],this.chatHistory=new Q.ChatHistory,this.controller.toggleMainVideo(!1);let O=new Y.CancellationTokenSource;this.disposables.add(()=>O.cancel());var B=O.token;this.wolCon.getCurrentUser()?await this.loadChannel(B):this.controller.goToScreen(N.ScreenType.Login,{afterLogin:S=>new $.MainMenuRoute(N.ScreenType.CustomGame,{messages:S})})}async loadChannel(S){this.channelName=void 0,this.users=[],this.games=[],this.selectedGame=void 0,this.wolCon.onJoinChannel.subscribe(this.onChannelJoinLeave),this.wolCon.onLeaveChannel.subscribe(this.onChannelJoinLeave),this.wolCon.onChannelUsers.subscribe(this.onChannelUsers),this.wolCon.onChatMessage.subscribe(this.onChannelMessage),this.wolCon.onClose.subscribe(this.onWolClose),this.wolService.onWolConnectionLost.subscribe(this.onWolConLost);try{let B=this.wolService.getConfig();var O=`#Lob ${B.getClientChannelType()} 0`;if(await this.wolCon.joinChannel(O,B.getGlobalChannelPass()),S.isCancelled())return;this.channelName=O,this.playerProfiles.clear(),this.initView(S),this.gameBrowser?.applyOptions(S=>S.users=this.users),this.refreshGames(S),this.refreshTimeoutId=setInterval(()=>this.refreshGames(S),5e3)}catch(S){let B=this.strings.get("WOL:MatchBadParameters");return S instanceof Z.WolError&&(O=(new Map).set(Z.WolError.Code.NoSuchChannel,"WOL:ChannelJoinFailure").set(Z.WolError.Code.BadChannelPass,"TXT_BADPASS").set(Z.WolError.Code.ChannelFull,"TXT_CHANNEL_FULL").set(Z.WolError.Code.BannedFromChannel,"TXT_JOINBAN").get(S.code))&&(B=this.strings.get(O)),void this.handleError(S,B)}}async onLeave(){this.disposables.dispose(),this.refreshTimeoutId&&clearInterval(this.refreshTimeoutId),this.ranksUpdateTask&&(this.ranksUpdateTask.cancel(),this.ranksUpdateTask=void 0),this.wolCon.isOpen()&&this.channelName&&this.wolCon.leaveChannel(this.channelName),this.wolCon.onJoinChannel.unsubscribe(this.onChannelJoinLeave),this.wolCon.onLeaveChannel.unsubscribe(this.onChannelJoinLeave),this.wolCon.onChannelUsers.unsubscribe(this.onChannelUsers),this.wolCon.onChatMessage.unsubscribe(this.onChannelMessage),this.wolCon.onClose.unsubscribe(this.onWolClose),this.wolService.onWolConnectionLost.unsubscribe(this.onWolConLost),await this.controller.hideSidebarButtons(),this.channelName=void 0,this.gameBrowser=void 0,this.messages=[],this.users=[],this.playerProfiles.clear(),this.games=[],this.selectedGame=void 0}async createGame(){this.controller.goToScreen(N.ScreenType.Lobby,{create:!0})}async joinGame(S){this.joinRoom(S,!1)}observeGame(S){this.joinRoom(S,!0)}joinRoom(S,O){S.modHash===this.engineModHash?this.controller.goToScreen(N.ScreenType.Lobby,{game:S,observe:O}):void 0!==S.modHash&&this.addSystemMessage(this.strings.get("TXT_MISMATCH"))}handleError(S,O){this.errorHandler.handle(S,O,()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(N.ScreenType.Home)}),clearInterval(this.refreshTimeoutId)}},S("CustomGameScreen",X)}}}),System.register("gui/screen/mainMenu/customGame/component/GameBrowser",["react","gui/component/Chat","gui/component/List","gui/component/Image","gui/screen/mainMenu/lobby/component/RankIndicator","gui/component/ChannelUser","network/chat/ChatMessage"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){S("GameBrowser",S=>{const[O,L]=B.useState(void 0);B.useEffect(()=>{O&&!S.games.find(S=>S.name===O.name)&&n(void 0)},[S.games]);const n=O=>{L(O),S.onSelectGame(O)};let D=S.strings;return B.default.createElement("div",{className:"gamebrowser-wrapper"},B.default.createElement("div",{className:"gamebrowser-top"},B.default.createElement("div",{className:"games"},B.default.createElement("div",{className:"games-header"},B.default.createElement("button",{className:"icon-button refresh-button",onClick:S.onRefreshClick,"data-r-tooltip":D.get("STT:WOLLobbyRefreshChannels")}),B.default.createElement("span",{className:"games-label"},D.get("GUI:OpenGames"))),B.default.createElement(U,{games:S.games,selectedGame:O,mapList:S.mapList,onClickGame:n,onDoubleClickGame:O=>{n(O),S.onDoubleClickGame(O)},tooltip:D.get("STT:LobbyListGames"),strings:D,playerProfiles:S.playerProfiles}))),B.default.createElement("div",{className:"gamebrowser-bottom"},B.default.createElement(N.Chat,{strings:D,messages:S.messages,channels:S.channels??[],chatHistory:S.chatHistory,localUsername:S.localUsername,onSendMessage:S.onSendMessage,tooltips:{input:D.get("STT:LobbyEditInput"),output:D.get("STT:LobbyEditOutput"),button:D.get("STT:EmoteButton")}}),B.default.createElement(j.List,{className:"players-list",tooltip:D.get("STT:LobbyListUsers")},S.users.map(O=>{var N=S.playerProfiles.get(O.name);return B.default.createElement(F.ChannelUser,{key:O.name,user:O,playerProfile:N,strings:D,onClick:()=>{S.chatHistory.lastComposeTarget.value={type:_.ChatRecipientType.Whisper,name:O.name}}})}))))}),U=({games:S,selectedGame:O,onClickGame:N,onDoubleClickGame:L,tooltip:D,strings:F,playerProfiles:_,mapList:U})=>B.default.createElement(B.default.Fragment,null,B.default.createElement(j.ListHeader,{className:"game game-list-header"},B.default.createElement("span",{className:"game-flags"},B.default.createElement("span",{className:"game-type"}),B.default.createElement("span",{className:"game-pass-locked"}),B.default.createElement("span",{className:"game-obs"})),B.default.createElement("span",{className:"game-map"},F.get("GUI:Map")),B.default.createElement("span",{className:"game-name"},F.get("GUI:RoomDesc")),B.default.createElement("span",{className:"game-players"},""),B.default.createElement("span",{className:"game-host"},F.get("GUI:HostName")),B.default.createElement("span",{className:"game-ping"},F.get("GUI:Ping"))),B.default.createElement(j.List,{className:"games-list",tooltip:D},S.map((S,j)=>{var D=S.hostPing,V=_.get(S.hostName),W=V?.rank;let z=U.getByName(S.mapName);var K=!z?.official&&S.hostMuted?F.get("GUI:CustomMap"):z?.getFullMapTitle(F)||S.mapName;return B.default.createElement(H,{key:S.name,game:S,uiMapName:K,customMap:!z?.official,ping:D,hostProfile:V,tooltip:[...S.modName?[""+F.get("GUI:GameMod",S.modName)]:[],F.get("TXT_MAP",K),D?F.get("WOL:GamePing",D):F.get("TXT_UNKNOWN_PING"),...void 0!==W?[F.get("TXT_HOST_RANK")+" "+W]:[]].join(", "),selected:S.name===O?.name,strings:F,onClick:N,onDoubleClick:L})}))),H=({game:S,uiMapName:O,customMap:N,selected:F,tooltip:_,ping:U,hostProfile:H,strings:V,onClick:W,onDoubleClick:z})=>B.default.createElement(j.ListItem,{key:S.name,className:"game",selected:F,tooltip:_,onClick:()=>W(S),onDoubleClick:()=>z(S)},B.default.createElement("span",{className:"game-flags"},B.default.createElement("span",{className:"game-type",title:S.modName||!N?""+V.get("GUI:GameMod",S.modName||V.get("GUI:Official")):""+V.get("GUI:CustomMap")},S.modName||N?B.default.createElement(L.Image,{src:"settings.png"}):B.default.createElement(L.Image,{src:S.tournament?"woltrny.pcx":"gt18.pcx"})),B.default.createElement("span",{className:"game-pass-locked"},S.passLocked?B.default.createElement(L.Image,{src:"wolpriv.pcx"}):null),B.default.createElement("span",{className:"game-obs"},S.observable?B.default.createElement(L.Image,{src:"wolob.pcx"}):null)),B.default.createElement("span",{className:"game-map",title:O},O),B.default.createElement("span",{className:"game-name",title:S.hostMuted?void 0:S.description},S.hostMuted?void 0:S.description),B.default.createElement("span",{className:"game-players"},S.maxPlayers?S.humanPlayers+S.aiPlayers+"/"+(S.maxPlayers-(S.observable?1:0)):"?/?"),B.default.createElement("span",{className:"game-host"},S.hostName,void 0!==H&&B.default.createElement(D.RankIndicator,{playerProfile:H,strings:V})),B.default.createElement("span",{className:"game-ping"},U?B.default.createElement("meter",{value:U,max:300,low:100,high:250,optimum:0,title:U+"ms"}):null))}}}),System.register("gui/screen/mainMenu/customGame/component/viewmodel/gameBrowser",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("gui/screen/mainMenu/infoAndCredits/InfoAndCreditsScreen",["react","gui/screen/mainMenu/main/ReportBug","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/ScreenType"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends j.MainMenuScreen{constructor(S,O,B){super(),this.strings=S,this.config=O,this.messageBoxApi=B,this.title=this.strings.get("TS:InfoAndCredits")}onEnter(){let S=this.strings;const O=this.config.discordUrl,j=this.config.donateUrl;this.controller.setSidebarButtons([...this.controller.hasScreen(L.ScreenType.PatchNotes)?[{label:S.get("TS:PatchNotes"),tooltip:S.get("STT:PatchNotes"),onClick:()=>{this.controller?.pushScreen(L.ScreenType.PatchNotes)}}]:[],...O?[{label:S.get("TS:ReportBug"),tooltip:S.get("TS:ReportBugTT"),onClick:()=>{this.messageBoxApi.show(B.createElement(N.ReportBug,{discordUrl:O,strings:this.strings}),this.strings.get("GUI:OK"))}}]:[],...j?[{label:S.get("TS:Donate"),onClick:()=>{window.open(j,"_blank"),window.gtag?.("event","donate_click")}}]:[],{label:S.get("GUI:ViewCredits"),onClick:()=>{this.controller?.pushScreen(L.ScreenType.Credits)}},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!0),this.controller.setMainComponent()}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},S("InfoAndCreditsScreen",D)}}}),System.register("gui/screen/mainMenu/ladder/LadderScreen",["@puzzl/core/lib/async/cancellation","@puzzl/core/lib/async/Task","gui/jsx/HtmlView","gui/jsx/jsx","network/ladder/wladderConfig","network/ladder/WLadderService","util/disposable/CompositeDisposable","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/ladder/component/Ladder","network/HttpRequest"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){W=class e extends U.MainMenuScreen{constructor(S,O,B,N,j,L){super(),this.wladderService=S,this.jsxRenderer=O,this.errorHandler=B,this.messageBoxApi=N,this.strings=j,this.clientLocale=L,this.title=this.strings.get("GUI:Ladder"),this.disposables=new _.CompositeDisposable}async onEnter(S){this.ladder=void 0,this.isBusy=!1,this.season=F.WLadderService.CURRENT_SEASON,this.selectedLadderType=S.ladderType,this.selectedLadder=S.highlightPlayer?.ladder,this.selectedPlayer=S.highlightPlayer,this.startIndex=this.computePageStartIndex(S.highlightPlayer?.rank),this.initSidebar(),this.initView();try{await this.fetchInitial(this.selectedLadderType,this.season,this.selectedLadder,S.highlightPlayer,this.startIndex)}catch(S){S instanceof B.OperationCanceledError||this.handleError(S,this.strings.get("TS:DownloadFailed"),{fatal:!0})}}computePageStartIndex(S){let O=1;return void 0!==S&&(O+=Math.floor((S-1)/e.PLAYERS_PER_PAGE)*e.PLAYERS_PER_PAGE),O}initSidebar(){this.controller?.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}]),this.controller?.showSidebarButtons()}async fetchInitial(S,O,B,N,j){await this.runTaskAsync(async L=>{let D=await this.wladderService.getSeasons(L),F=await this.wladderService.getSeason(O,this.clientLocale,L);this.seasonDetails=F,this.selectedLadderType&&!F.ladders.some(S=>S.type===this.selectedLadderType)&&(this.selectedLadderType=F.ladders[0]?.type);let _=this.buildLadderList(S,F,B);if(B=this.selectedLadder=B?_.find(S=>S.id===B.id):void 0)try{var U=await this.wladderService.rungSearch(j,e.PLAYERS_PER_PAGE+1,S,O,B.id,L);this.updateView({head:B,players:U,start:j},N,F,_)}catch(L){if(!(L instanceof V.DownloadError&&404===L.statusCode))throw L;this.updateView(void 0,N,F,_)}else this.updateView(void 0,N,F,_);1<D.length&&this.ladder?.applyOptions(S=>{S.seasons=D})})}buildLadderList(S,O,B,N){let j=O.ladders.filter(O=>O.type===S);B&&!j.some(S=>S.id===B.id)&&j.push(B);let L=N?.ladder;return L&&L!==B&&!j.some(S=>S.id===L.id)&&j.push(L),j}fetchSeasonLadder(S,O,N,j){this.runTaskAsync(async B=>{let L,F,_=this.seasonDetails;if("season"===j&&(_=await this.wladderService.getSeason(S,this.clientLocale,B),this.seasonDetails=_,this.selectedLadderType&&!_.ladders.some(S=>S.type===this.selectedLadderType)&&(this.selectedLadderType=_.ladders[0]?.type)),"ladder"!==j&&N){var U="string"==typeof N?N:N.name;if((this.selectedLadderType||_?.ladders.some(S=>S.type===D.LadderType.Solo1v1))&&([L]=await this.wladderService.listSearch([U],B,this.selectedLadderType,S,this.clientLocale)),"search"===j){if(!L||!L.rank)return void this.messageBoxApi.show(this.strings.get("TXT_NOT_IN_LADDER"),this.strings.get("GUI:OK"));this.selectedPlayer=L}else L&&(this.selectedPlayer=L);O=L?.ladder}if(_&&(F=this.buildLadderList(this.selectedLadderType,_,O,L??("ladder"===j?this.selectedPlayer:void 0)),O=this.selectedLadder=O?F.find(S=>S.id===O.id):F[0]),O){let N=1;L&&(N=this.computePageStartIndex(L.rank)),U=await this.wladderService.rungSearch(N,e.PLAYERS_PER_PAGE+1,this.selectedLadderType,S,O.id,B),this.updateView({head:O,players:U,start:N},L??this.selectedPlayer,this.seasonDetails,F)}else this.updateView(void 0,L??this.selectedPlayer,this.seasonDetails,F)}).catch(S=>{S instanceof B.OperationCanceledError||this.handleError(S,this.strings.get("TS:DownloadFailed"))})}fetchLadderPage(S){this.runTaskAsync(async O=>{var B;void 0!==this.selectedLadder&&(B=await this.wladderService.rungSearch(S,e.PLAYERS_PER_PAGE+1,this.selectedLadderType,this.season,this.selectedLadder.id,O),this.updateView({head:this.selectedLadder,players:B,start:S},this.selectedPlayer))}).catch(S=>{S instanceof B.OperationCanceledError||this.handleError(S,this.strings.get("TS:DownloadFailed"))})}async runTaskAsync(S){this.asyncTask?.cancel();let O=this.asyncTask=new N.Task(S);try{this.isBusy=!0,this.ladder?.applyOptions(S=>S.disabled=!0),await O.start()}finally{this.isBusy=!1,this.ladder?.applyOptions(S=>S.disabled=!1)}return O}initView(){var[S]=this.jsxRenderer.render(L.jsx(j.HtmlView,{component:H.Ladder,innerRef:S=>this.ladder=S,props:{players:void 0,highlightPlayer:this.selectedPlayer?.name,hasPrevPage:!1,hasNextPage:!1,seasons:void 0,selectedSeason:this.season,seasonDetails:this.seasonDetails,ladders:void 0,selectedLadder:this.selectedLadder,strings:this.strings,disabled:this.isBusy,onFirstPageClick:()=>{this.ladder&&this.fetchLadderPage(1)},onPrevPageClick:()=>{this.ladder&&this.fetchLadderPage(Math.max(1,this.startIndex-e.PLAYERS_PER_PAGE))},onNextPageClick:()=>{this.ladder&&this.fetchLadderPage(this.startIndex+e.PLAYERS_PER_PAGE)},onLastPageClick:()=>{this.ladder&&void 0!==this.totalCount&&this.fetchLadderPage(this.computePageStartIndex(this.totalCount))},onPlayerSearch:S=>{this.ladder&&this.fetchSeasonLadder(this.season,this.selectedLadder,S,"search")},onSeasonSelect:S=>{this.season=S,this.ladder&&this.fetchSeasonLadder(S,this.selectedLadder,this.selectedPlayer,"season")},onLadderSelect:S=>{this.selectedLadder=S,this.ladder&&this.fetchSeasonLadder(this.season,S,this.selectedPlayer,"ladder")},onLadderTypeSelect:S=>{this.selectedLadderType=S,this.selectedLadder=void 0,this.ladder&&this.fetchSeasonLadder(this.season,this.selectedLadder,this.selectedPlayer,"type")}}}));this.controller?.setMainComponent(S)}updateView(S,O,B,N){this.startIndex=S?.start??0,this.totalCount=S?.players.totalCount??0,this.ladder?.applyOptions(j=>{B&&(j.seasonDetails=B),N&&(j.ladders=N),j.selectedLadder=S?.head,j.highlightPlayer=O?.name,j.players=S?.players.records.slice(0,e.PLAYERS_PER_PAGE)??[],j.hasPrevPage=1<this.startIndex,j.hasNextPage=(S?.players.records.length??0)>e.PLAYERS_PER_PAGE})}handleError(S,O,{fatal:B}={}){this.errorHandler.handle(S,O,()=>{B&&this.controller?.popScreen()})}async onLeave(){this.disposables.dispose(),this.ladder=void 0,this.asyncTask&&(this.asyncTask.cancel(),this.asyncTask=void 0),await(this.controller?.hideSidebarButtons())}},S("LadderScreen",W),W.PLAYERS_PER_PAGE=20}}}),System.register("gui/screen/mainMenu/ladder/component/Ladder",["react","classnames","gui/screen/mainMenu/lobby/component/RankIndicator","gui/component/Select","gui/component/Option","network/ladder/wladderConfig","gui/component/List","network/ladder/WLadderService"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V;function d(S,O){return S===U.WLadderService.CURRENT_SEASON?O.get("GUI:LadderCurrent"):S===U.WLadderService.PREV_SEASON?O.get("GUI:LadderPrev"):O.get("GUI:LadderSeason",S)}function g(S){return new Date(S).toLocaleDateString(void 0,{dateStyle:"medium"})}function p(S){return new Date(S).toLocaleTimeString(void 0,{timeStyle:"short"})}return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){H=new Map([[F.LadderType.Solo1v1,"gui:laddertype1v1"],[F.LadderType.Random2v2,"gui:laddertype2v2random"]]),S("Ladder",({players:S,highlightPlayer:O,hasPrevPage:j,hasNextPage:F,seasons:U,selectedSeason:W,seasonDetails:z,ladders:K,selectedLadder:$,disabled:q,strings:Q,onFirstPageClick:Z,onPrevPageClick:Y,onNextPageClick:X,onLastPageClick:J,onPlayerSearch:ee,onSeasonSelect:te,onLadderSelect:ie,onLadderTypeSelect:re})=>{if(!S)return B.createElement("div",{className:"ladder"},Q.get("GUI:LoadingEx"));const se=B.useRef(null),[ne,ae]=B.useState(!$);B.useEffect(()=>{ae(!$)},[$]);const k=S=>S.type+"_"+S.id;var oe=S.some(S=>void 0!==S.mmr),le=S.some(S=>void 0!==S.points);let ce=$?.type,he=[...new Set(z?.ladders.map(S=>S.type)??(ce?[ce]:void 0))];var ue=z?.totalRankedPlayers.find(S=>S.ladderType===ce)?.value;return B.createElement("div",{className:"ladder"},B.createElement("div",{className:N.default("toolbar",{"no-season-select":!U||U.length<2})},void 0!==U&&0<U.length&&B.createElement(L.Select,{disabled:q,initialValue:W??U[0],onSelect:te,className:"season-select"},U.map(S=>B.createElement(D.Option,{key:S,label:d(S,Q),value:S}))),!ne&&B.createElement(B.Fragment,null,void 0!==K&&0<K.length&&B.createElement(L.Select,{disabled:q,initialValue:k($??K[0]),onSelect:S=>{let{type:O,id:B}=(S=>{var[O,B]=S.split("_");return{type:O,id:Number(B)}})(S);var N=K?.find(S=>S.id===B&&S.type===O);N&&ie(N)},className:"ladder-select"},K.map(S=>B.createElement(D.Option,{key:S.type+"_"+S.id,label:S.name+(S.divisionName?", "+Q.get("GUI:LadderDivision",S.divisionName):""),value:k(S)})),ue?B.createElement(D.Option,{label:Q.get("GUI:LadderRankedPlayers",ue),disabled:!0,value:""}):void 0),B.createElement("form",{className:"player-search",onSubmit:S=>{S.preventDefault(),se.current?.value&&(ee(se.current.value),se.current.value="")}},B.createElement("input",{className:"player",type:"text",disabled:q,ref:se,placeholder:Q.get("GUI:Player")}),B.createElement("button",{type:"submit",disabled:q},Q.get("GUI:Search"))))),B.createElement("div",{className:"ladder-content"},B.createElement(_.List,{className:"ladder-types"},B.createElement(_.ListItem,{selected:ne,disabled:q,onClick:()=>ae(!0)},Q.get("gui:ladderseasoninfo")),he.map(S=>B.createElement(_.ListItem,{key:S,selected:!ne&&ce===S,disabled:q,onClick:()=>{ae(!1),re(S)}},Q.get(H.get(S)??S)))),ne&&z?B.createElement("div",{className:"season-info"},B.createElement("header",null,B.createElement("h2",null,d(z.name,Q)),void 0!==z.startTime&&void 0!==z.endTime&&B.createElement("p",null,g(z.startTime)+" - "+g(z.endTime))),void 0!==z.topTierStartTime&&B.createElement("div",{className:"item"},B.createElement("span",{className:"label"},Q.get("gui:laddertoptierstart")),B.createElement("span",{className:"label"},g(z.topTierStartTime))),void 0!==z.nextTopTierDemoteTime&&B.createElement("div",{className:"item"},B.createElement("span",{className:"label"},Q.get("gui:laddertoptierdemotions")),B.createElement("span",{className:"label"},p(z.nextTopTierDemoteTime))),void 0!==z.nextTopTierPromoteTime&&B.createElement("div",{className:"item"},B.createElement("span",{className:"label"},Q.get("gui:laddertoptierpromotions")),B.createElement("span",{className:"label"},p(z.nextTopTierPromoteTime))),void 0!==z.lockTime&&B.createElement("div",{className:"item"},B.createElement("span",{className:"label"},Q.get("gui:ladderseasonlock")),B.createElement("span",{className:"value"},g(z.lockTime)))):B.createElement(V,{players:S,highlightPlayer:O,showPoints:le,showMmr:oe,strings:Q,hasPrevPage:j,hasNextPage:F,disabled:q,onFirstPageClick:Z,onPrevPageClick:Y,onNextPageClick:X,onLastPageClick:J})))}),V=({players:S,highlightPlayer:O,showPoints:L,showMmr:D,strings:F,hasPrevPage:_,hasNextPage:U,disabled:H,onFirstPageClick:V,onPrevPageClick:W,onNextPageClick:z,onLastPageClick:K})=>B.createElement("div",{className:"ladder-table"},B.createElement("table",null,B.createElement("thead",null,B.createElement("tr",null,B.createElement("th",{className:"player-rank"},"#"),B.createElement("th",{className:"player-rank-icon"},F.get("GUI:Rank")),B.createElement("th",{className:"player-name"},F.get("GUI:Name")),L&&B.createElement("th",{className:"player-points"},F.get("GUI:Points")),D&&B.createElement("th",{className:"player-mmr"},F.get("GUI:MMR")),B.createElement("th",{className:"player-wins"},F.get("GUI:NumberWins")),B.createElement("th",{className:"player-losses"},F.get("GUI:NumberLosses")))),B.createElement("tbody",null,S.map(S=>B.createElement("tr",{key:S.name,className:N.default({selected:O?.toLowerCase()===S.name.toLowerCase(),disabled:void 0===S.points&&!S.wins&&!S.losses&&!S.draws})},B.createElement("td",{className:"player-rank"},S.rank),B.createElement("td",{className:"player-rank-icon"},B.createElement(j.RankIndicator,{playerProfile:S,strings:F})),B.createElement("td",{className:"player-name"},S.name),L&&B.createElement("td",{className:"player-points"},S.points),D&&B.createElement("td",{className:"player-mmr"},S.mmr),B.createElement("td",{className:"player-wins"},S.wins),B.createElement("td",{className:"player-losses"},S.losses??0))))),(_||U)&&B.createElement("div",{className:"pagination"},B.createElement("button",{className:"first-page",disabled:!_||H,onClick:V},"<<"),B.createElement("button",{className:"prev-page",disabled:!_||H,onClick:W},"<"),B.createElement("button",{className:"next-page",disabled:!U||H,onClick:z},">"),B.createElement("button",{className:"last-page",disabled:!U||H,onClick:K},">>")))}}}),System.register("gui/screen/mainMenu/ladderRules/LadderRulesScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/component/Iframe"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends j.MainMenuScreen{constructor(S,O,B){super(),this.strings=S,this.jsxRenderer=O,this.rulesUrl=B,this.title=this.strings.get("GUI:Rules")}onEnter(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!1);var[S]=this.jsxRenderer.render(B.jsx(N.HtmlView,{width:"100%",height:"100%",component:L.Iframe,props:{src:this.rulesUrl,className:"ladder-rules"}}));this.controller.setMainComponent(S)}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},S("LadderRulesScreen",D)}}}),System.register("gui/screen/mainMenu/lobby/LobbyScreen",["@puzzl/core/lib/async/Task","network/WolConnection","network/WolError","network/gameopt/SlotInfo","game/gameopts/GameOpts","game/gameopts/constants","gui/screen/mainMenu/lobby/component/LobbyForm","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/screen/mainMenu/lobby/component/PasswordBox","gui/screen/mainMenu/lobby/component/CreateGameBox","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","engine/ResourceLoader","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/lobby/MapPreviewRenderer","util/array","engine/sound/SoundKey","engine/sound/ChannelType","LocalPrefs","gui/screen/mainMenu/lobby/PreferredHostOpts","util/typeGuard","game/gameopts/GameOptSanitizer","gui/screen/mainMenu/MainMenuScreen","data/MapFile","engine/MapDigest","network/gservConfig","network/WolConfig","gui/screen/mainMenu/MainMenuRoute","@puzzl/core/lib/async/sleep","network/chat/ChatMessage","gui/chat/ChatHistory","util/time"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S},function(S){ge=S}],execute:function(){pe=class extends se.MainMenuScreen{constructor(S,O,j,D,F,_,U,H,V,K,$,q,Z,Y,ee,te,re,se,ne,ae,oe,le){super(),this.botsEnabled=S,this.engineModHash=O,this.activeModMeta=j,this.rootController=D,this.errorHandler=F,this.messageBoxApi=_,this.strings=U,this.uiScene=H,this.wolCon=V,this.wolService=K,this.wladderService=$,this.mapTransferService=q,this.gservCon=Z,this.rules=Y,this.gameOptParser=ee,this.gameOptSerializer=te,this.jsxRenderer=re,this.mapFileLoader=se,this.mapList=ne,this.gameModes=ae,this.sound=oe,this.localPrefs=le,this.messages=[],this.playerReadyStatus=new Map,this.playerHasMapStatus=new Map,this.playerProfiles=new Map,this.disposables=new z.CompositeDisposable,this.updatePings=()=>{if(this.wolCon.isOpen()){if(this.gameChannelName&&this.wolCon.isInChannel(this.gameChannelName)){this.pingsUpdateTask?.cancel();let S=this.pingsUpdateTask=new B.Task(async S=>{var O=await this.wolCon.listUsers(this.gameChannelName);if(!S.isCancelled()){for(var B of O)this.updatePlayerPing(B.name,B.ping);this.sendPingData()}});S.start().catch(S=>{S instanceof Q.OperationCanceledError||console.error(S)})}}else this.onWolClose()},this.updateRanks=()=>{if(this.wladderService.getUrl()&&this.slotsInfo){this.ranksUpdateTask?.cancel();let S=this.ranksUpdateTask=new B.Task(async S=>{await he.sleep(5e3,S);var O=this.slotsInfo.map(S=>S.type===L.SlotType.Player?S.name:void 0).filter(ie.isNotNullOrUndefined);if(O=await this.wladderService.listSearch(O,S),!S.isCancelled()){for(var B of O)this.playerProfiles.set(B.name,B);this.updateFormModel()}});S.start().catch(S=>{S instanceof Q.OperationCanceledError||console.error(S)})}},this.onChannelLeave=S=>{S.channel===this.gameChannelName&&(this.hostMode?S.user.name!==this.wolCon.getCurrentUser()&&this.handlePlayerJoinLeave(S):S.user.name!==this.hostPlayerName&&S.user.name!==this.wolCon.getCurrentUser()||this.controller?.goToScreen(W.ScreenType.CustomGame,{}))},this.onChannelJoin=S=>{this.wolCon.isOpen()&&this.gameChannelName&&S.user.name!==this.wolCon.getCurrentUser()&&(this.sound.play("join"===S.type?X.SoundKey.PlayerJoined:X.SoundKey.PlayerLeft,J.ChannelType.Ui),"join"===S.type&&this.updatePlayerPing(S.user.name,S.user.ping),this.hostMode?this.handlePlayerJoinLeave(S):this.wolCon.sendPlayerReady(!1),this.playerProfiles.has(S.user.name)||this.updateRanks())},this.onChannelMessage=S=>{this.lobbyForm&&(S.to.type!==ue.ChatRecipientType.Page&&S.to.type!==ue.ChatRecipientType.Whisper||this.sound.play(X.SoundKey.IncomingMessage,J.ChannelType.Ui),this.messages.push(S),this.lobbyForm.refresh()),S.to.type===ue.ChatRecipientType.Whisper&&S.to.name!==this.wolCon.getServerName()&&S.from!==this.wolCon.getCurrentUser()&&(this.chatHistory.lastWhisperFrom.value=S.from)},this.handleGameStart=S=>{var O,B,j=this.wolCon.getCurrentUser(),L=new ce.MainMenuRoute(W.ScreenType.Login,{afterLogin:S=>new ce.MainMenuRoute(W.ScreenType.CustomGame,{messages:S})});this.hostMode?(O=this.frozenGameOpts??this.gameOpts,B=[...this.playerHasMapStatus.values()].includes(N.WolHasMapStatus.MapTransfer),this.rootController.createGame(S.gameId,S.timestamp,S.gservUrl,j,O,!1,this.isTournament,B,this.hostPrivateGame,L)):(B=this.playerHasMapStatus.get(j)===N.WolHasMapStatus.MapTransfer,this.rootController.joinGame(S.gameId,S.timestamp,S.gservUrl,j,this.isTournament,B,L))},this.handleGameServer=S=>{this.currentGameServer?.id!==S.id&&(this.currentGameServer=S,this.formModel.selectedGameServer=S.id,this.playerPings.length=0,this.lobbyForm?.refresh(),this.hostMode&&this.updatePings(),this.updateGservPing())},this.handleGameOpt=S=>{let O=S.opt,B=O[0];if(this.hostMode){if(S.user!==this.hostPlayerName)if("A"===B)this.handleGameOptReady(S.user,O[1]);else if("R"===B)this.handlePlayerOptsChange(S.user,O);else{if("K"!==B)throw new Error("Unknown GAMEOPT string "+O);this.handleGameOptHasMap(S.user,O[1])}}else if("L"===B)this.handleGameOptSlots(O),this.slotsInfo.some(S=>S.type===L.SlotType.Player&&!this.playerProfiles.has(S.name))&&this.updateRanks();else if("P"===B)this.handleGameOptPing(O.slice(1));else if("O"===B)this.handleGameOptObserver(O[1]);else if("A"===B)this.handleGameOptReady(S.user,O[1]);else if("K"===B)this.handleGameOptHasMap(S.user,O[1]);else{if("R"===B)return;if("G"===B)return void(this.playerReadyStatus.get(this.wolCon.getCurrentUser())||this.addSystemMessage(this.strings.get("GUI:HostGameStartJoiner")));if(!B.match(/^-|\d+/))throw new Error("Unknown GAMEOPT string "+O);this.handleGameOptOptions(O)}this.updateFormModel()},this.onWolClose=()=>{this.hostOptsIntervalId&&clearInterval(this.hostOptsIntervalId),this.gservPingIntervalId&&clearInterval(this.gservPingIntervalId)},this.onWolConLost=S=>{this.errorHandler.handle(S,this.strings.get("TXT_YOURE_DISCON"),()=>{this.controller?.goToScreen(W.ScreenType.Home)})}}async onEnter(S){if(this.wolCon.getCurrentUser()){let j=new Q.CancellationTokenSource;this.disposables.add(()=>j.cancel());var O,B,N=j.token;this.gameChannelName=void 0,this.lobbyForm=void 0,this.chatHistory=new de.ChatHistory,this.playerPings=[],this.initFormModel(),this.wolCon.onGameOpt.subscribe(this.handleGameOpt),this.wolCon.onGameStart.subscribe(this.handleGameStart),this.wolCon.onGameServer.subscribe(this.handleGameServer),this.wolCon.onLeaveChannel.subscribe(this.onChannelLeave),this.wolCon.onJoinChannel.subscribe(this.onChannelJoin),this.wolCon.onChatMessage.subscribe(this.onChannelMessage),this.wolCon.onClose.subscribe(this.onWolClose),this.wolService.onWolConnectionLost.subscribe(this.onWolConLost),this.hostMode=S.create,this.hostMode?(this.title=this.strings.get("GUI:HostScreen"),this.createGame(N)):(this.title=this.strings.get("GUI:JoinScreen"),({game:O,observe:B}=S),this.joinGame(O,B,void 0,N))}else this.messageBoxApi.show(this.strings.get("TXT_YOURE_DISCON"),this.strings.get("GUI:Ok"),()=>{this.controller?.goToScreen(W.ScreenType.Home)})}async joinGame(S,O,B,N){if(B||!S.passLocked){var L=S.name;try{var D=this.waitForHostPlayer(L,N).catch(S=>{if(!(S instanceof Q.OperationCanceledError))throw S});if(await this.wolCon.joinGame(L,B,O),N.isCancelled())return;this.gameChannelName=L;var _,U,H,V=await D;if(N?.isCancelled())return;this.hostPlayerName=V.name,this.hostIsFreshAccount=V.fresh,this.isTournament=S.tournament,this.formModel.channels=[this.gameChannelName],O?this.sendPlayerInfo(F.OBS_COUNTRY_ID,F.RANDOM_COLOR_ID,F.RANDOM_START_POS,F.NO_TEAM_ID):(_=this.localPrefs.getItem(ee.StorageKey.LastPlayerCountry),U=this.localPrefs.getItem(ee.StorageKey.LastPlayerColor),H=void 0!==_&&Number(_)<this.getAvailablePlayerCountries().length?Number(_):F.RANDOM_COUNTRY_ID,z=void 0!==U&&Number(U)<this.getAvailablePlayerColors().length&&this.getSelectablePlayerColors().includes(this.getColorNameById(Number(U)))?Number(U):F.RANDOM_COLOR_ID,H===F.RANDOM_COUNTRY_ID&&z===F.RANDOM_COLOR_ID||this.sendPlayerInfo(H,z,F.RANDOM_START_POS,F.NO_TEAM_ID)),this.observerSlotIndex=8}catch(S){if(S instanceof j.WolError){var z=(new Map).set(j.WolError.Code.BadChannelPass,"TXT_BADPASS").set(j.WolError.Code.GameHasClosed,"TXT_GAME_CLOSED").set(j.WolError.Code.ChannelFull,"TXT_CHANNEL_FULL").set(j.WolError.Code.BannedFromChannel,"TXT_JOINBAN").get(S.code);if(z)return void this.messageBoxApi.show(this.strings.get(z),this.strings.get("GUI:Ok"),()=>{this.controller?.goToScreen(W.ScreenType.CustomGame,{})})}else if(S instanceof Q.OperationCanceledError)return;return void this.handleError(S,this.strings.get("WOL:MatchBadParameters"))}this.controller.toggleSidebarPreview(!0),this.initView()}else this.showPasswordBox(B=>{this.joinGame(S,O,B,N)},()=>{this.controller?.goToScreen(W.ScreenType.CustomGame,{})})}waitForHostPlayer(S,O){return new Promise((B,N)=>{let s=O=>{var j;O.channelName===S&&(this.wolCon.onChannelUsers.unsubscribe(s),(j=O.users.find(S=>S.operator))?B(j):N(new Error("Host player not found")))};this.wolCon.onChannelUsers.subscribe(s),O.register(()=>{this.wolCon.onChannelUsers.unsubscribe(s),N(new Q.OperationCanceledError(O))})})}async createGame(S,O){if(O){try{var{roomDesc:B,tournament:N,observe:j,pass:L}=O,D=this.wolCon.makeGameChannelName(),F=this.waitForHostPlayer(D,S).catch(S=>{if(!(S instanceof Q.OperationCanceledError))throw S});if(await this.wolCon.createGame(D,1,9,this.wolService.getConfig().getClientChannelType(),N,L),S?.isCancelled())return;this.gameChannelName=D;var _=await F;if(S?.isCancelled())return;if(this.hostPlayerName=this.wolCon.getCurrentUser(),this.hostIsFreshAccount=_.fresh,this.hostRoomDesc=B,this.isTournament=N,this.hostPrivateGame=!!L,this.observerSlotIndex=j?0:8,this.formModel.lobbyType=U.LobbyType.MultiplayerHost,this.formModel.activeSlotIndex=j?-1:0,this.formModel.channels=[this.gameChannelName],await this.initHostOptions(j,S),S?.isCancelled())return;this.updateMapPreview(this.currentMapFile),this.updateFormModel(),this.updatePings(),this.updateRanks(),this.sendGameOpts(),this.sendModeMaxSlots(),this.hostOptsIntervalId=setInterval(()=>{this.wolCon.isOpen()&&this.gameChannelName&&(this.sendGameOpts(),this.updatePings())},5e3)}catch(O){return void this.handleError(O,O instanceof q.DownloadError?this.strings.get("TXT_DOWNLOAD_FAILED"):this.strings.get("WOL:MatchBadParameters"))}this.controller.toggleSidebarPreview(!0),this.initView()}else this.showCreateGameBox((O,B,N)=>{this.createGame(S,{roomDesc:O,observe:N,pass:B,tournament:!1})},()=>{this.controller?.goToScreen(W.ScreenType.CustomGame,{})})}onViewportChange(){this.createGameBox&&this.createGameBox.applyOptions(S=>S.viewport=this.uiScene.viewport),this.passBox&&this.passBox.applyOptions(S=>S.viewport=this.uiScene.viewport)}onUnstack(S){if(this.wolCon.isOpen()&&this.gameChannelName){if(S){let _=S.gameMode.id!==this.gameOpts.gameMode;var O=S.mapName!==this.gameOpts.mapName;this.gameOpts.gameMode=S.gameMode.id;let U=this.mapList.getByName(S.mapName),H=S.changedMapFile??this.currentMapFile;this.currentMapFile=H;var B=Y.findIndexReverse(this.slotsInfo,(S,O)=>S.type===L.SlotType.Ai||S.type===L.SlotType.Player&&(this.observerSlotIndex!==O||0===O)||S.type===L.SlotType.Open),N=Math.min(9,U.maxSlots+(0===this.observerSlotIndex?1:0)),j=Math.max(0,B+1-N);for(let S=0;S<j;S++){let O=this.slotsInfo[B-S];O.type===L.SlotType.Player?this.kickPlayer(O.name):O.type===L.SlotType.Ai&&(this.gameOpts.aiPlayers[B-S]=void 0),O.type=L.SlotType.Closed}for(let S=B+1;S<N;S++)this.slotsInfo[S].type=this.preferredHostOpts.slotsClosed.has(S)?L.SlotType.Closed:this.observerSlotIndex===S?L.SlotType.OpenObserver:L.SlotType.Open;let V=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;if([...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].forEach(S=>{S&&(S.startPos>U.maxSlots-1&&(S.startPos=F.RANDOM_START_POS),_&&(S.teamId=V.alliesAllowed&&V.mustAlly?0:F.NO_TEAM_ID))}),O){for(var D of this.playerReadyStatus.keys())this.playerReadyStatus.set(D,!1);this.playerHasMapStatus.clear()}this.sendGameSlotInfo(),this.sendModeMaxSlots(),this.applyGameOption(S=>{S.mapName=U.fileName,S.mapDigest=ae.MapDigest.compute(H),S.mapSizeBytes=H.getSize(),S.mapTitle=U.getFullMapTitle(this.strings),S.maxSlots=U.maxSlots,S.mapOfficial=U.official}),this.localPrefs.setItem(ee.StorageKey.LastMap,U.fileName),this.localPrefs.setItem(ee.StorageKey.LastMode,String(S.gameMode.id))}this.updateMapPreview(this.currentMapFile),this.initView()}else this.onWolClose()}async onStack(){await this.unrender()}initView(){this.initLobbyForm(),this.refreshSidebarButtons(),this.refreshSidebarMpText(),this.controller.showSidebarButtons(),this.gservPingIntervalId=setInterval(()=>{this.updateGservPing()},3e4)}async initHostOptions(S,O){var B=this.localPrefs.getItem(ee.StorageKey.PreferredGameOpts),N=this.localPrefs.getItem(ee.StorageKey.LastPlayerCountry),j=this.localPrefs.getItem(ee.StorageKey.LastPlayerColor),D=this.localPrefs.getItem(ee.StorageKey.LastMap),_=this.localPrefs.getItem(ee.StorageKey.LastMode);let U,H=D?this.mapList.getByName(D):void 0,V=H&&_&&this.gameModes.hasId(Number(_))?Number(_):1,W=this.gameModes.getById(V);U=H?.gameModes.find(S=>S.mapFilter===W.mapFilter)?H:(V=1,W=this.gameModes.getById(V),this.mapList.getAll().find(S=>S.gameModes.find(S=>W.mapFilter===S.mapFilter)));let z=await this.mapFileLoader.load(U.fileName);if(!O?.isCancelled()){this.currentMapFile=z;let O=this.preferredHostOpts=new te.PreferredHostOpts;B?O.unserialize(B):O.applyMpDialogSettings(this.rules.mpDialogSettings),B=this.gameModes.getById(V).mpDialogSettings,this.gameOpts={gameMode:V,shortGame:O.shortGame,mcvRepacks:O.mcvRepacks,cratesAppear:O.cratesAppear,superWeapons:O.superWeapons,gameSpeed:O.gameSpeed,credits:O.credits,unitCount:O.unitCount,buildOffAlly:O.buildOffAlly,hostTeams:O.hostTeams,destroyableBridges:O.destroyableBridges,multiEngineer:O.multiEngineer,noDogEngiKills:O.noDogEngiKills,humanPlayers:[{name:this.hostPlayerName,countryId:S?F.OBS_COUNTRY_ID:void 0!==N&&Number(N)<this.getAvailablePlayerCountries().length?Number(N):F.RANDOM_COUNTRY_ID,colorId:!S&&void 0!==j&&Number(j)<this.getAvailablePlayerColors().length?Number(j):F.RANDOM_COLOR_ID,startPos:F.RANDOM_START_POS,teamId:B.mustAlly?0:F.NO_TEAM_ID}],aiPlayers:new Array(8).fill(void 0),mapName:U.fileName,mapDigest:ae.MapDigest.compute(z),mapSizeBytes:z.getSize(),mapTitle:U.getFullMapTitle(this.strings),maxSlots:U.maxSlots,mapOfficial:U.official},this.slotsInfo=[{type:L.SlotType.Player,name:this.hostPlayerName}];for(let B=1;B<9;++B)this.slotsInfo.push({type:O.slotsClosed.has(B)?L.SlotType.Closed:this.observerSlotIndex===B?L.SlotType.OpenObserver:B<U.maxSlots+(S?1:0)?L.SlotType.Open:L.SlotType.Closed});this.playerProfiles.clear()}}updateGservPing(){if(this.wolCon.isOpen()){if(this.gameChannelName&&this.wolCon.isInChannel(this.gameChannelName)){this.gservPingUpdateTask?.cancel();let S=this.gservPingUpdateTask=new B.Task(async S=>{var O;this.currentGameServer&&(O=this.currentGameServer.url,void 0!==(O=await this.pingGserv(O,S))&&(this.wolCon.sendGservPing(this.currentGameServer.id,O),this.hostMode&&this.updatePings()))});S.start().catch(S=>{S instanceof Q.OperationCanceledError||console.error(S)})}}else this.onWolClose()}async pingGserv(S,O){try{await this.gservCon.connect(S,{cancelToken:O,timeoutSeconds:5}),O?.throwIfCancelled();var B=await this.gservCon.ping(5);return O?.throwIfCancelled(),B}catch(S){return void(S instanceof Q.OperationCanceledError||console.error(S))}finally{this.gservCon.close()}}handleError(S,O){this.errorHandler.handle(S,O,()=>{this.controller?.goToScreen(W.ScreenType.CustomGame,{})}),this.hostOptsIntervalId&&clearInterval(this.hostOptsIntervalId),this.gservPingIntervalId&&clearInterval(this.gservPingIntervalId)}showPasswordBox(S,O){let[B]=this.jsxRenderer.render(K.jsx($.HtmlView,{innerRef:S=>this.passBox=S,component:H.PasswordBox,props:{strings:this.strings,onSubmit:O=>{S(O),B.destroy()},onDismiss:()=>{O(),B.destroy()},viewport:this.uiScene.viewport}}));this.uiScene.add(B),this.disposables.add(B,()=>this.uiScene.remove(B),()=>this.passBox=void 0)}showCreateGameBox(S,O){let[B]=this.jsxRenderer.render(K.jsx($.HtmlView,{component:V.CreateGameBox,innerRef:S=>this.createGameBox=S,props:{strings:this.strings,onSubmit:(O,N,j)=>{B.destroy(),S(O,N,j)},onDismiss:()=>{B.destroy(),O()},viewport:this.uiScene.viewport}}));this.uiScene.add(B),this.disposables.add(B,()=>this.uiScene.remove(B),()=>this.createGameBox=void 0)}getAvailablePlayerCountryRules(){return this.rules.getMultiplayerCountries()}getAvailablePlayerCountries(){return this.getAvailablePlayerCountryRules().map(S=>S.name)}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map(S=>S.asHexString())}getAvailableStartPositions(){return new Array(this.gameOpts?.maxSlots??8).fill(0).map((S,O)=>O)}getSelectablePlayerColors(){let S=[];this.formModel&&this.formModel.playerSlots.forEach(O=>{O&&S.push(O.color)});let O=this.getAvailablePlayerColors();return[F.RANDOM_COLOR_NAME].concat(O.filter(O=>O&&-1===S.indexOf(O)))}getSelectableStartPositions(){let S=[];this.formModel&&this.formModel.playerSlots.forEach(O=>{O&&S.push(O.startPos)});let O=this.getAvailableStartPositions();return[F.RANDOM_START_POS].concat(O.filter(O=>!S.includes(O)))}initFormModel(){var S=this.rules.mpDialogSettings;this.formModel={strings:this.strings,countryUiNames:new Map([[F.RANDOM_COUNTRY_NAME,F.RANDOM_COUNTRY_UI_NAME],[F.OBS_COUNTRY_NAME,F.OBS_COUNTRY_UI_NAME]].concat(this.getAvailablePlayerCountryRules().map(S=>[S.name,S.uiName]))),countryUiTooltips:new Map([[F.RANDOM_COUNTRY_NAME,F.RANDOM_COUNTRY_UI_TOOLTIP],[F.OBS_COUNTRY_NAME,F.OBS_COUNTRY_UI_TOOLTIP]].concat(this.getAvailablePlayerCountryRules().filter(S=>S.uiTooltip).map(S=>[S.name,S.uiTooltip]))),availablePlayerCountries:[F.RANDOM_COUNTRY_NAME].concat(this.getAvailablePlayerCountries()),availablePlayerColors:this.getSelectablePlayerColors(),availableAiNames:this.botsEnabled?new Map([...F.aiUiNames.entries()].filter(([S])=>S!==D.AiDifficulty.Easy)):new Map,availableStartPositions:this.getSelectableStartPositions(),maxTeams:4,lobbyType:U.LobbyType.MultiplayerGuest,messages:this.messages,chatHistory:this.chatHistory,channels:[],localUsername:this.wolCon.getCurrentUser(),mpDialogSettings:S,onSendMessage:S=>{S.value.length?this.wolCon.isOpen()&&this.gameChannelName&&(this.wolCon.sendChatMessage(S.value,S.recipient),S.recipient.type===ue.ChatRecipientType.Whisper&&(this.chatHistory.lastWhisperTo.value=S.recipient.name)):this.addSystemMessage(this.strings.get("TXT_ENTER_MESSAGE"))},onCountrySelect:(S,O)=>{this.wolCon.isOpen()&&this.gameChannelName&&(this.sendPlayerInfo(this.getCountryIdByName(S),this.getColorIdByName(this.formModel.playerSlots[O].color),this.formModel.playerSlots[O].startPos,this.formModel.playerSlots[O].team,O),this.updateFormModel())},onColorSelect:(S,O)=>{this.wolCon.isOpen()&&this.gameChannelName&&(this.sendPlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[O].country),this.getColorIdByName(S),this.formModel.playerSlots[O].startPos,this.formModel.playerSlots[O].team,O),this.updateFormModel())},onStartPosSelect:(S,O)=>{this.wolCon.isOpen()&&this.gameChannelName&&(this.sendPlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[O].country),this.getColorIdByName(this.formModel.playerSlots[O].color),S,this.formModel.playerSlots[O].team,O),this.updateFormModel())},onTeamSelect:(S,O)=>{this.wolCon.isOpen()&&this.gameChannelName&&(this.sendPlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[O].country),this.getColorIdByName(this.formModel.playerSlots[O].color),this.formModel.playerSlots[O].startPos,S,O),this.updateFormModel())},onSlotChange:(S,O,B)=>{this.wolCon.isOpen()&&this.gameChannelName&&this.changeSlotType(S,O,B)},onToggleShortGame:S=>this.applyGameOption(O=>O.shortGame=S),onToggleMcvRepacks:S=>this.applyGameOption(O=>O.mcvRepacks=S),onToggleCratesAppear:S=>this.applyGameOption(O=>O.cratesAppear=S),onToggleSuperWeapons:S=>this.applyGameOption(O=>O.superWeapons=S),onToggleBuildOffAlly:S=>this.applyGameOption(O=>O.buildOffAlly=S),onToggleHostTeams:S=>this.applyGameOption(O=>O.hostTeams=S),onToggleDestroyableBridges:S=>this.applyGameOption(O=>O.destroyableBridges=S),onToggleMultiEngineer:S=>this.applyGameOption(O=>O.multiEngineer=S),onToggleNoDogEngiKills:S=>this.applyGameOption(O=>O.noDogEngiKills=S),onChangeGameSpeed:S=>this.applyGameOption(O=>O.gameSpeed=S),onChangeCredits:S=>this.applyGameOption(O=>O.credits=S),onChangeUnitCount:S=>this.applyGameOption(O=>O.unitCount=S),activeSlotIndex:-1,teamsAllowed:!0,teamsRequired:!1,playerSlots:[],shortGame:!0,mcvRepacks:!0,cratesAppear:!0,superWeapons:!0,buildOffAlly:!0,hostTeams:!1,destroyableBridges:!0,multiEngineer:!1,multiEngineerCount:Math.ceil((1-this.rules.general.engineerCaptureLevel)/this.rules.general.engineerDamage)+1,noDogEngiKills:!1,gameSpeed:6,credits:S.money,unitCount:S.unitCount},this.playerReadyStatus.clear(),this.playerHasMapStatus.clear(),this.messages.length=0}applyGameOption(S){if(!this.hostMode)throw new Error("Can't change options when not a host");this.wolCon.isOpen()?(S(this.gameOpts),re.GameOptSanitizer.sanitize(this.gameOpts,this.rules),this.updateFormModel(),this.sendGameOpts(),this.localPrefs.setItem(ee.StorageKey.PreferredGameOpts,this.preferredHostOpts.applyGameOpts(this.gameOpts).serialize())):this.onWolClose()}changeSlotType(S,O,B){if(!this.hostMode)throw new Error("Only host can change slot type");if(0===O)throw new Error("Change slot type of host");var N=this.formModel.playerSlots[O];let j=this.slotsInfo[O];N.occupation===S&&j.type===L.SlotType.Player&&void 0===B||(N.occupation===U.SlotOccupation.Occupied&&(j.type===L.SlotType.Player?this.kickPlayer(j.name):this.gameOpts.aiPlayers[O]=void 0),N=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings,S===U.SlotOccupation.Closed?(j.type=L.SlotType.Closed,this.preferredHostOpts.slotsClosed.add(O)):S===U.SlotOccupation.Open?(j.type=O===this.observerSlotIndex?L.SlotType.OpenObserver:L.SlotType.Open,this.preferredHostOpts.slotsClosed.delete(O)):S===U.SlotOccupation.Occupied&&void 0!==B&&(j.type=L.SlotType.Ai,j.difficulty=B,this.gameOpts.aiPlayers[O]={difficulty:B,countryId:F.RANDOM_COUNTRY_ID,colorId:F.RANDOM_COLOR_ID,startPos:F.RANDOM_START_POS,teamId:N.mustAlly?3:F.NO_TEAM_ID},this.preferredHostOpts.slotsClosed.delete(O)),this.updateFormModel(),this.sendGameSlotInfo(),this.sendGameOpts(),this.sendModeMaxSlots(),this.localPrefs.setItem(ee.StorageKey.PreferredGameOpts,this.preferredHostOpts.serialize()))}getCountryNameById(S){let O;return O=S===F.RANDOM_COUNTRY_ID?F.RANDOM_COUNTRY_NAME:S===F.OBS_COUNTRY_ID?F.OBS_COUNTRY_NAME:this.getAvailablePlayerCountries()[S],O}getCountryIdByName(S){let O;return O=S===F.RANDOM_COUNTRY_NAME?F.RANDOM_COUNTRY_ID:S===F.OBS_COUNTRY_NAME?F.OBS_COUNTRY_ID:this.getAvailablePlayerCountries().indexOf(S),O}getColorNameById(S){let O;return O=S===F.RANDOM_COLOR_ID?F.RANDOM_COLOR_NAME:this.getAvailablePlayerColors()[S],O}getColorIdByName(S){let O;if(S===F.RANDOM_COLOR_NAME)O=F.RANDOM_COLOR_ID;else if(O=this.getAvailablePlayerColors().indexOf(S),-1===O)throw new Error(`Color ${S} not found in available player colors`);return O}sendPlayerInfo(S,O,B,N,j){if(!this.hostPlayerName)throw new Error("Host player name not yet set.");if(this.hostMode){if(void 0!==j&&j!==this.formModel.activeSlotIndex){const D=this.slotsInfo[j];if(D.type!==L.SlotType.Ai&&!this.gameOpts.hostTeams)throw new Error("Can't change country and color for a non-AI slot");let F=this.gameOpts.aiPlayers[j];if(!F){if(!this.gameOpts.hostTeams)throw new Error("No AI found in slot "+j);if(D.type!==L.SlotType.Player)return void console.warn(`Can't change player info for ${L.SlotType[D.type]} slot at `+j);F=this.gameOpts.humanPlayers.find(S=>S.name===D.name)}if(!F)throw new Error("No human player found in slot "+j);F.countryId=S,F.colorId=O,F.startPos=B,F.teamId=N}else this.updatePlayerInfo(this.hostPlayerName,S,O,B,N);this.updateFormModel(),this.sendGameOpts()}else this.wolCon.sendPlayerOpts(this.hostPlayerName,S,O,B,N);void 0!==j&&j!==this.formModel.activeSlotIndex||S!==F.OBS_COUNTRY_ID&&(S!==F.RANDOM_COUNTRY_ID?this.localPrefs.setItem(ee.StorageKey.LastPlayerCountry,String(S)):this.localPrefs.removeItem(ee.StorageKey.LastPlayerCountry),O!==F.RANDOM_COLOR_ID?this.localPrefs.setItem(ee.StorageKey.LastPlayerColor,String(O)):this.localPrefs.removeItem(ee.StorageKey.LastPlayerColor))}updatePlayerInfo(S,O,B,N,j,L=!1){if(!this.hostMode)throw new Error("Method should only be used in host mode");let D=this.gameOpts.humanPlayers.find(O=>O.name===S);D?(D.countryId=O,D.colorId=B,L||(D.startPos=N,D.teamId=j)):console.error("Can't set country/color for non-existent player "+S)}updateFormModel(){var S=this.gameOpts;if(S&&(this.formModel.gameSpeed=S.gameSpeed,this.formModel.credits=S.credits,this.formModel.unitCount=S.unitCount,this.formModel.shortGame=S.shortGame,this.formModel.superWeapons=S.superWeapons,this.formModel.buildOffAlly=S.buildOffAlly,this.formModel.hostTeams=S.hostTeams,this.formModel.mcvRepacks=S.mcvRepacks,this.formModel.cratesAppear=S.cratesAppear,this.formModel.destroyableBridges=S.destroyableBridges,this.formModel.multiEngineer=S.multiEngineer,this.formModel.noDogEngiKills=S.noDogEngiKills),this.gameOpts&&this.slotsInfo){let O=S.maxSlots+(this.gameOpts?.humanPlayers?.[0]?.countryId===ae.OBS_COUNTRY_ID?1:0);this.slotsInfo.forEach((S,B)=>{B!==this.observerSlotIndex?O?(O--,this.formModel.playerSlots[B]={country:F.RANDOM_COUNTRY_NAME,color:F.RANDOM_COLOR_NAME,startPos:F.RANDOM_START_POS,team:F.NO_TEAM_ID}):this.formModel.playerSlots[B]=void 0:this.formModel.playerSlots[B]={country:F.RANDOM_COUNTRY_NAME,color:F.RANDOM_COLOR_NAME,startPos:F.RANDOM_START_POS,team:F.NO_TEAM_ID}}),this.slotsInfo.forEach((S,O)=>{if(this.formModel.playerSlots[O]){let B=this.formModel.playerSlots[O];S.type===L.SlotType.Closed?B.occupation=U.SlotOccupation.Closed:S.type===L.SlotType.Open||S.type===L.SlotType.OpenObserver?B.occupation=U.SlotOccupation.Open:B.occupation=U.SlotOccupation.Occupied,S.type===L.SlotType.OpenObserver||O===this.observerSlotIndex?B.type=U.SlotType.Observer:S.type===L.SlotType.Ai?B.type=U.SlotType.Ai:B.type=U.SlotType.Player,S.type===L.SlotType.Ai?(B.aiDifficulty=S.difficulty,B.status=U.PlayerStatus.Ready):S.type===L.SlotType.Player&&(B.name=S.name,S.name===this.hostPlayerName?B.status=U.PlayerStatus.Host:B.status=this.playerReadyStatus.get(S.name)?U.PlayerStatus.Ready:U.PlayerStatus.NotReady)}})}let O=this.gameOpts?this.gameOpts.humanPlayers:[],B=this.gameOpts?this.gameOpts.aiPlayers:[],N=this.gameOpts?this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings:void 0;this.formModel.playerSlots.forEach((S,j)=>{var L,D;S&&O.length&&(S.occupation===U.SlotOccupation.Occupied?((L=O.find(O=>O.name===S.name))?(S.country=this.getCountryNameById(L.countryId),S.color=this.getColorNameById(L.colorId),S.startPos=L.startPos,S.team=L.teamId):(D=B[j])&&(S.country=this.getCountryNameById(D.countryId),S.color=this.getColorNameById(D.colorId),S.startPos=D.startPos,S.team=D.teamId),(D=this.playerPings.find(O=>!!S.name&&O.playerName===S.name))&&(S.ping=0<D.ping?D.ping:void 0),this.playerProfiles&&S.type===U.SlotType.Player&&(S.playerProfile=this.playerProfiles.get(S.name))):j===this.observerSlotIndex?S.country=F.OBS_COUNTRY_NAME:(S.country=F.RANDOM_COUNTRY_NAME,N&&(S.team=N.mustAlly?3:F.NO_TEAM_ID)))}),this.hostMode||(this.formModel.activeSlotIndex=this.slotsInfo?this.slotsInfo.findIndex(S=>S.type===L.SlotType.Player&&S.name===this.wolCon.getCurrentUser()):-1),this.formModel.availablePlayerColors=this.getSelectablePlayerColors(),this.formModel.availableStartPositions=this.getSelectableStartPositions(),this.gameOpts&&(this.formModel.teamsAllowed=this.gameModes.getById(S.gameMode).mpDialogSettings.alliesAllowed,this.formModel.teamsRequired=this.gameModes.getById(S.gameMode).mpDialogSettings.mustAlly),this.lobbyForm&&O.length&&this.lobbyForm.refresh()}addSystemMessage(S){this.lobbyForm&&(this.messages.push({text:S}),this.lobbyForm.refresh())}sendGameOpts(){if(!this.hostMode)throw new Error("Should only be used in host mode");var S,O,B;this.gameOpts&&this.wolCon.isOpen()&&this.gameChannelName&&(this.gameOpts.humanPlayers.forEach(S=>{-1===S.colorId&&(S.colorId=F.RANDOM_COLOR_ID)}),B=this.gameOptSerializer.serializeOptions(this.gameOpts),this.wolCon.sendGameOpts(B),S=this.slotsInfo.filter(S=>S.type===L.SlotType.Ai||S.type===L.SlotType.Player||S.type===L.SlotType.Open||S.type===L.SlotType.OpenObserver).length,O=this.slotsInfo.filter(S=>S.type===L.SlotType.Player).length,B=this.activeModMeta?this.activeModMeta.name+(void 0!==this.activeModMeta.version?` (${this.activeModMeta.version})`:""):void 0,this.wolCon.sendGameTopic(O,S,this.gameOpts.aiPlayers.filter(S=>!!S).length,Number(this.slotsInfo[this.observerSlotIndex].type===L.SlotType.Player),this.slotsInfo[this.observerSlotIndex].type===L.SlotType.OpenObserver,this.gameOpts.mapName,this.engineModHash,this.hostRoomDesc,B),this.sendPingData())}handlePlayerJoinLeave(S){if(!this.hostMode)throw new Error("Should only be used in host mode");if(this.wolCon.isOpen()&&this.gameChannelName&&this.slotsInfo){if("join"===S.type){let N=this.slotsInfo.findIndex(S=>S.type===L.SlotType.Open),j=!1;if(-1===N&&(N=this.slotsInfo.findIndex(S=>S.type===L.SlotType.OpenObserver),j=!0,-1===N))return void this.kickPlayer(S.user.name);this.slotsInfo[N]={type:L.SlotType.Player,name:S.user.name};var O,B=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;for(O of(this.gameOpts.humanPlayers.push({name:S.user.name,countryId:j?F.OBS_COUNTRY_ID:F.RANDOM_COUNTRY_ID,colorId:j?F.OBS_COLOR_ID:F.RANDOM_COLOR_ID,startPos:F.RANDOM_START_POS,teamId:B.mustAlly?0:F.NO_TEAM_ID}),this.playerReadyStatus.set(S.user.name,!1),this.playerReadyStatus.keys()))this.playerReadyStatus.set(O,!1)}else this.removeHumanPlayer(S.user.name);this.sendGameSlotInfo(),this.sendObserverSlotInfo(),this.sendGameOpts()}}removeHumanPlayer(S){var O=this.slotsInfo.findIndex(O=>O.type===L.SlotType.Player&&O.name===S);if(-1!==O){let S=this.slotsInfo[O];O===this.observerSlotIndex?S.type=L.SlotType.OpenObserver:S.type=L.SlotType.Open}-1!==(O=this.gameOpts.humanPlayers.findIndex(O=>O.name===S))&&this.gameOpts.humanPlayers.splice(O,1),this.playerReadyStatus.delete(S),this.playerHasMapStatus.delete(S),-1!==(O=this.playerPings.findIndex(O=>O.playerName===S))&&this.playerPings.splice(O,1)}kickPlayer(S,O){this.gameChannelName&&this.wolCon.isInChannel(this.gameChannelName)&&(this.wolCon.kick([S],this.gameChannelName,O),this.removeHumanPlayer(S))}sendObserverSlotInfo(){this.wolCon.sendObserverSlot(this.observerSlotIndex)}sendGameSlotInfo(){var S;this.wolCon.isOpen()&&this.gameChannelName&&(S=this.gameOptSerializer.serializeSlotData(this.slotsInfo),this.wolCon.sendGameSlotsInfo(S))}sendPingData(){var S;this.playerPings.length&&(S=this.gameOptSerializer.serializePingData(this.playerPings),this.wolCon.sendPingData(S))}sendModeMaxSlots(){if(!this.hostMode)throw new Error("Must be in host mode");if(!this.slotsInfo)throw new Error("Slots info should be set by now");var S=this.gameChannelName;if(!S||!this.wolCon.isInChannel(S))throw new Error("Must be in a game channel");var O=this.slotsInfo.filter(S=>S.type!==L.SlotType.Closed&&S.type!==L.SlotType.Ai).length;this.wolCon.sendModeChannelMax(S,O)}updatePlayerPing(S,O){let B=this.playerPings.find(O=>O.playerName===S);B?B.ping=O:this.playerPings.push({ping:O,playerName:S})}handlePlayerOptsChange(S,O){var B=this.slotsInfo.findIndex(O=>O.type===L.SlotType.Player&&O.name===S);if(-1!==B){let[j,D,_,U]=O.slice(1).split(",").map(Number);D=this.getSelectablePlayerColors().includes(this.getColorNameById(D))?D:this.gameOpts.humanPlayers.find(O=>O.name===S).colorId,_=this.getSelectableStartPositions().includes(_)?_:this.gameOpts.humanPlayers.find(O=>O.name===S).startPos;var N=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;U=!N.alliesAllowed||U===F.NO_TEAM_ID&&N.mustAlly?N.mustAlly?0:F.NO_TEAM_ID:U,j===F.OBS_COUNTRY_ID||B!==this.observerSlotIndex?(this.updatePlayerInfo(S,j,D,_,U,this.gameOpts.hostTeams),this.sendGameOpts(),j===F.OBS_COUNTRY_ID&&((N=this.slotsInfo[this.observerSlotIndex]).type!==L.SlotType.OpenObserver?N.type===L.SlotType.Player&&N.name===S||(console.warn(`Player ${S} tried to move to an unavailable observer slot`),this.kickPlayer(S)):(this.slotsInfo[this.observerSlotIndex]=this.slotsInfo[B],this.slotsInfo[B]={type:L.SlotType.Open},this.sendGameSlotInfo()))):this.kickPlayer(S)}}handleGameOptReady(S,O){if(this.slotsInfo){var B=this.slotsInfo.findIndex(O=>O.type===L.SlotType.Player&&O.name===S);if(-1===B&&this.hostMode)return}this.playerReadyStatus.set(S,Boolean(Number(O))),this.hostMode||S!==this.wolCon.getCurrentUser()||this.refreshSidebarButtons(),this.hostMode&&![...this.playerReadyStatus.values()].filter(S=>!1===S).length&&this.sound.play(X.SoundKey.OptionsChanged,J.ChannelType.Ui)}handleGameOptHasMap(S,O){if(this.slotsInfo){var B=this.slotsInfo.findIndex(O=>O.type===L.SlotType.Player&&O.name===S);if(-1===B&&this.hostMode)return}let j=Number(O);Object.values(N.WolHasMapStatus).includes(j)||(j=N.WolHasMapStatus.NoMap),this.playerHasMapStatus.set(S,j),this.hostMode||S!==this.wolCon.getCurrentUser()?j!==N.WolHasMapStatus.HasMap&&this.gameOpts&&this.messages.push({text:j===N.WolHasMapStatus.MapTransfer?this.strings.get("GUI:HostMapTransfer",S,`"${this.gameOpts.mapTitle}"`):this.strings.get("GUI:HostNoMap",S,`"${this.gameOpts.mapTitle}"`)+(this.hostIsFreshAccount?" "+this.strings.get("GUI:HostNoMapUpload"):"")}):this.refreshSidebarButtons()}handleGameOptObserver(S){this.observerSlotIndex=Number(S)}handleGameOptSlots(S){this.slotsInfo=this.gameOptParser.parseSlotData(S)}handleGameOptPing(S){this.playerPings=this.gameOptParser.parsePingData(S)}handleGameOptOptions(S){var O,B;this.gameChannelName&&this.wolCon.isInChannel(this.gameChannelName)&&(B=(O=this.gameOptParser.parseOptions(S)).mapName!==this.gameOpts?.mapName||O.mapDigest!==this.gameOpts?.mapDigest,re.GameOptSanitizer.sanitize(O,this.rules),this.gameOpts=O,this.refreshSidebarMpText(),B&&this.wolCon.isOpen()&&(B=this.wolCon.getCurrentUser(),this.playerReadyStatus.set(B,!1),this.playerHasMapStatus.set(B,N.WolHasMapStatus.NoMap),this.refreshSidebarButtons(),this.wolCon.sendPlayerReady(!1),this.guestUpdateMapDeferred(O)))}guestUpdateMapDeferred(S){this.mapLoadTask?.cancel(),this.mapLoadTask=new B.Task(async O=>{this.controller.setSidebarPreview(),this.currentMapFile=void 0;var B,j,L=this.currentMapFile=await this.loadAndCheckMap(S);!O.isCancelled()&&this.wolCon.isOpen()&&(B=!L&&!S.mapOfficial&&!this.hostIsFreshAccount&&S.mapSizeBytes<=(this.mapTransferService.getUrl()?le:oe).MAX_MAP_TRANSFER_BYTES,j=L?N.WolHasMapStatus.HasMap:B?N.WolHasMapStatus.MapTransfer:N.WolHasMapStatus.NoMap,this.wolCon.sendPlayerHasMap(j),L?this.updateMapPreview(L):this.addSystemMessage(B?this.strings.get("GUI:JoinerMapTransfer",`"${S.mapTitle}"`):this.hostIsFreshAccount?this.strings.get("GUI:HostNoMapUpload"):this.strings.get("GUI:JoinerNoMap",`"${S.mapTitle}"`)),this.refreshSidebarMpText())}),this.mapLoadTask.start().catch(S=>{S instanceof Q.OperationCanceledError||this.handleError(S,this.strings.get("TXT_DOWNLOAD_FAILED"))})}updateMapPreview(S){try{var O=new Z.MapPreviewRenderer(this.strings).render(new ne.MapFile(S),this.hostMode?U.LobbyType.MultiplayerHost:U.LobbyType.MultiplayerGuest,this.controller.getSidebarPreviewSize());this.controller.setSidebarPreview(O)}catch(S){console.error("Failed to render map preview"),console.error(S),this.controller.setSidebarPreview()}}async loadAndCheckMap(S){if(this.mapList.getByName(S.mapName)){let O=await this.mapFileLoader.load(S.mapName);return ae.MapDigest.compute(O)===S.mapDigest&&O.getSize()===S.mapSizeBytes?O:void 0}}initLobbyForm(){var[S]=this.jsxRenderer.render(K.jsx($.HtmlView,{innerRef:S=>this.lobbyForm=S,component:_.LobbyForm,props:this.formModel}));this.controller.setMainComponent(S)}refreshSidebarButtons(){let S=this.strings,O=this.playerReadyStatus.get(this.wolCon.getCurrentUser());var B=this.playerHasMapStatus.get(this.wolCon.getCurrentUser())??N.WolHasMapStatus.NoMap;B=[this.hostMode?{label:S.get("GUI:StartGame"),tooltip:S.get("STT:HostButtonGo"),disabled:!1,onClick:()=>{var S;this.wolCon.isOpen()&&(void 0!==(S=[...this.playerHasMapStatus].find(([,S])=>S===N.WolHasMapStatus.NoMap)?.[0])?this.addSystemMessage(this.strings.get("GUI:HostNoMap",S,`"${this.gameOpts.mapTitle}"`)+(this.hostIsFreshAccount?" "+this.strings.get("GUI:HostNoMapUpload"):"")):this.gameOpts.humanPlayers.filter(S=>S.countryId!==F.OBS_COUNTRY_ID).length<2?this.addSystemMessage(this.strings.get("TXT_ONLY_ONE")):this.meetsMinimumTeams()?[...this.playerReadyStatus.values()].filter(S=>!1===S).length?(this.addSystemMessage(this.strings.get("GUI:HostGameStartHost")),this.wolCon.sendGameStartRequest()):(this.frozenGameOpts=this.gameOptParser.parseOptions(this.gameOptSerializer.serializeOptions(this.gameOpts)),this.wolCon.startGame(this.gameOpts.humanPlayers.map(S=>S.name))):this.addSystemMessage(this.strings.get("TXT_CANNOT_ALLY")))}}:{label:O?S.get("GUI:NotReady"):S.get("GUI:Accept"),tooltip:O?S.get("STT:NotReady"):S.get("STT:GuestButtonAccept"),disabled:B===N.WolHasMapStatus.NoMap,onClick:()=>{this.wolCon.isOpen()&&this.gameChannelName&&(this.playerReadyStatus.set(this.wolCon.getCurrentUser(),!O),this.wolCon.sendPlayerReady(!O))}},...this.hostMode?[{label:S.get("GUI:ChooseMap"),tooltip:S.get("STT:HostButtonChooseMap"),onClick:()=>{this.controller?.pushScreen(W.ScreenType.MapSelection,{lobbyType:this.hostMode?U.LobbyType.MultiplayerHost:U.LobbyType.MultiplayerGuest,gameOpts:this.gameOpts,usedSlots:()=>1+Y.findIndexReverse(this.slotsInfo,(S,O)=>S.type===L.SlotType.Ai||S.type===L.SlotType.Player&&this.observerSlotIndex!==O)-(0===this.observerSlotIndex?1:0)})}}]:[],{label:S.get("GUI:Back"),tooltip:this.hostMode?S.get("STT:HostButtonBack"):S.get("STT:GuestButtonBack"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(W.ScreenType.CustomGame,{})}}],this.controller.setSidebarButtons(B,!0),this.refreshSidebarMpText()}meetsMinimumTeams(){let S=[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].filter(ie.isNotNullOrUndefined).filter(S=>S.countryId!==F.OBS_COUNTRY_ID),O=S[0].teamId;return O===F.NO_TEAM_ID||S.some(S=>S.teamId!==O)}refreshSidebarMpText(){this.gameOpts?this.controller.setSidebarMpContent({text:this.strings.get(this.gameModes.getById(this.gameOpts.gameMode).label)+"\n\n"+(this.hostMode||!this.hostIsFreshAccount||this.currentMapFile?this.gameOpts.mapTitle:this.strings.get("GUI:CustomMap")),icon:this.gameOpts.mapOfficial?"gt18.pcx":"settings.png",tooltip:this.gameOpts.mapOfficial?this.strings.get("STT:VerifiedMap"):this.strings.get("STT:UnverifiedMap")}):this.controller.setSidebarMpContent({text:""})}async onLeave(){this.wolCon.isOpen()&&this.wolCon.getCurrentUser()&&this.gameChannelName&&this.wolCon.leaveChannel(this.gameChannelName),this.disposables.dispose(),this.mapLoadTask?.cancel(),this.mapLoadTask=void 0,this.ranksUpdateTask?.cancel(),this.ranksUpdateTask=void 0,this.pingsUpdateTask?.cancel(),this.pingsUpdateTask=void 0,this.gservPingUpdateTask?.cancel(),this.gservPingUpdateTask=void 0,this.currentMapFile=void 0,this.gameChannelName=void 0,this.hostPlayerName=void 0,this.hostIsFreshAccount=void 0,this.hostRoomDesc="",this.gameOpts=void 0,this.frozenGameOpts=void 0,this.preferredHostOpts=void 0,this.playerPings=this.slotsInfo=void 0,this.playerProfiles.clear(),this.currentGameServer=void 0,this.hostOptsIntervalId&&clearInterval(this.hostOptsIntervalId),this.gservPingIntervalId&&clearInterval(this.gservPingIntervalId),this.wolCon.onGameOpt.unsubscribe(this.handleGameOpt),this.wolCon.onGameStart.unsubscribe(this.handleGameStart),this.wolCon.onGameServer.unsubscribe(this.handleGameServer),this.wolCon.onLeaveChannel.unsubscribe(this.onChannelLeave),this.wolCon.onJoinChannel.unsubscribe(this.onChannelJoin),this.wolCon.onChatMessage.unsubscribe(this.onChannelMessage),this.wolCon.onClose.unsubscribe(this.onWolClose),this.wolService.onWolConnectionLost.unsubscribe(this.onWolConLost),this.controller.toggleSidebarPreview(!1),await this.unrender()}async unrender(){await this.controller.hideSidebarButtons(),this.lobbyForm&&(this.lobbyForm=void 0)}},S("LobbyScreen",pe),__decorate([ge.Throttle(5e3)],pe.prototype,"updateGservPing",null),__decorate([ge.Throttle(350)],pe.prototype,"sendGameOpts",null),__decorate([ge.Throttle(350)],pe.prototype,"sendGameSlotInfo",null)}}}),System.register("gui/screen/mainMenu/lobby/MapPreviewRenderer",["engine/gfx/CanvasUtils","gui/HtmlContainer","gui/UiObject","gui/screen/mainMenu/lobby/component/viewmodel/lobby","game/Coords","engine/IsoCoords"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=new Map([[L.LobbyType.Singleplayer,"STT:SkirmishMapThumbnail"],[L.LobbyType.MultiplayerHost,"STT:HostMapThumbnail"],[L.LobbyType.MultiplayerGuest,"STT:GuestMapThumbnail"]]),S("MapPreviewRenderer",class{constructor(S){this.strings=S}render(S,O,L){let D;try{D=S.decodePreviewImage()}catch(S){console.error("Failed to decode map preview data",S)}if(D){var{data:F,width:U,height:H}=D;let V=B.CanvasUtils.canvasFromRgbImageData(F,U,H),W=1;H=V.width<L.width/2||V.height<L.height/2?4:2;let z=document.createElement("canvas");z.width=H*V.width,z.height=H*V.height;let K=z.getContext("2d");K&&(W=H,K.scale(W,W),K.drawImage(V,0,0),V=z),this.drawStartLocations(V,S,L,W);let $=new N.HtmlContainer;return H=new j.UiObject(new THREE.Object3D,$),$.setSize("100%","100%"),$.render(),V.style.objectFit="contain",V.style.width="100%",V.style.height="100%",V.setAttribute("data-r-tooltip",this.strings.get(_.get(O))),$.getElement().appendChild(V),H}}drawStartLocations(S,O,N,j){var L=S.getContext("2d");if(L){F.IsoCoords.init({x:0,y:O.fullSize.width*D.Coords.getWorldTileSize()/2});var _,U,H=F.IsoCoords.worldToScreen(0,0),V=F.IsoCoords.screenToScreenTile(H.x,H.y),W=13*(H=S.width>S.height?S.width/N.width/j:S.height/N.height/j),z=2*H;for([_,U]of O.startingLocations.entries()){var K=U;K=F.IsoCoords.tileToScreen(K.x,K.y);let N=F.IsoCoords.screenToScreenTile(K.x,K.y);N.x+=V.x,N.y+=V.y;let D=this.dxyToCanvas(N.x,N.y,S,O.localSize);D.x/=j,D.y/=j,B.CanvasUtils.drawText(L,String(_+1),D.x-W/4,D.y-W/2,{fontSize:W,color:"yellow",outlineColor:"black",outlineWidth:z})}}}dxyToCanvas(S,O,B,N){var j=B.width/(2*N.width),L=B.height/N.height/2;return{x:(S-2*N.x)*j,y:(O-2*N.y)*L}}})}}}),System.register("gui/screen/mainMenu/lobby/PreferredHostOpts",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("PreferredHostOpts",class{constructor(){this.gameSpeed=6,this.credits=1e4,this.unitCount=10,this.shortGame=!0,this.superWeapons=!1,this.buildOffAlly=!0,this.mcvRepacks=!0,this.cratesAppear=!1,this.hostTeams=!1,this.destroyableBridges=!0,this.multiEngineer=!1,this.noDogEngiKills=!1,this.slotsClosed=new Set}serialize(){return[this.gameSpeed,this.credits,this.unitCount,Number(this.shortGame),Number(this.superWeapons),Number(this.buildOffAlly),Number(this.mcvRepacks),Number(this.cratesAppear),[...this.slotsClosed].join(","),Number(this.hostTeams),Number(this.destroyableBridges),Number(this.multiEngineer),Number(this.noDogEngiKills)].join(";")}unserialize(S){let[O,B,N,j,L,D,F,_,U,H,V="1",W,z]=S.split(";");return this.gameSpeed=Number(O),this.credits=Number(B),this.unitCount=Number(N),this.shortGame=Boolean(Number(j)),this.superWeapons=Boolean(Number(L)),this.buildOffAlly=Boolean(Number(D)),this.mcvRepacks=Boolean(Number(F)),this.cratesAppear=Boolean(Number(_)),this.hostTeams=Boolean(Number(H)),this.destroyableBridges=Boolean(Number(V)),this.multiEngineer=Boolean(Number(W)),this.noDogEngiKills=Boolean(Number(z)),this.slotsClosed=new Set(U?U.split(",").map(S=>Number(S)):[]),this}applyGameOpts(S){return this.gameSpeed=S.gameSpeed,this.credits=S.credits,this.unitCount=S.unitCount,this.shortGame=S.shortGame,this.superWeapons=S.superWeapons,this.buildOffAlly=S.buildOffAlly,this.mcvRepacks=S.mcvRepacks,this.cratesAppear=S.cratesAppear,this.hostTeams=!!S.hostTeams,this.destroyableBridges=S.destroyableBridges,this.multiEngineer=S.multiEngineer,this.noDogEngiKills=S.noDogEngiKills,this}applyMpDialogSettings(S){return this.gameSpeed=6-S.gameSpeed,this.credits=S.money,this.unitCount=S.unitCount,this.shortGame=S.shortGame,this.mcvRepacks=S.mcvRedeploys,this.cratesAppear=S.crates,this.superWeapons=S.superWeapons,this.destroyableBridges=S.bridgeDestruction,this.multiEngineer=S.multiEngineer,this}})}}}),System.register("gui/screen/mainMenu/lobby/SelectMapParams",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("gui/screen/mainMenu/lobby/SkirmishScreen",["@puzzl/core/lib/async/Task","network/gameopt/SlotInfo","game/gameopts/GameOpts","game/gameopts/constants","gui/screen/mainMenu/lobby/component/LobbyForm","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","engine/ResourceLoader","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/lobby/MapPreviewRenderer","util/array","LocalPrefs","util/typeGuard","gui/screen/mainMenu/lobby/PreferredHostOpts","gui/screen/mainMenu/MainMenuScreen","data/MapFile","engine/MapDigest","gui/screen/mainMenu/MainMenuRoute","engine/sound/Music","network/gameopt/Parser","network/gameopt/Serializer","engine/Engine"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){ne=S}],execute:function(){se=class extends Y.MainMenuScreen{constructor(S,O,B,N,j,L,D,F,_,H){super(),this.rootController=S,this.errorHandler=O,this.messageBoxApi=B,this.strings=N,this.rules=j,this.jsxRenderer=L,this.mapFileLoader=D,this.mapList=F,this.gameModes=_,this.localPrefs=H,this.title=this.strings.get("GUI:SkirmishGame"),this.musicType=te.MusicType.Intro,this.playerName="Player 1",this.disposables=new U.CompositeDisposable,this.observerSlotIndex=8,this.isObserver=!1,this.customAiNames=new Map}async loadCustomAiNames(){try{const S=await ne.Engine.getOrCreateDir(ne.Engine.rfsSettings.customAiDir);if(!S)return;const O=(await S.listEntries()).filter(S=>S.toLowerCase().endsWith(".js"));let B=j.CUSTOM_AI_ID_START||100;this.customAiNames=new Map;for(const S of O){const O=S.replace(/\.js$/i,"");this.customAiNames.set(B,": "+O),B++}console.log(`Found ${this.customAiNames.size} custom AI files`)}catch(S){console.warn("Failed to load custom AI names:",S),this.customAiNames=new Map}}buildAvailableAiNames(){const S=new Map([...L.aiUiNames.entries()]);for(const[O,B]of this.customAiNames)S.set(O,B);return S}onEnter(){this.controller.toggleMainVideo(!1),this.lobbyForm=void 0,this.initFormModel(),this.createGame()}async createGame(){try{await this.initOptions()}catch(S){return void this.handleError(S,S instanceof W.DownloadError?this.strings.get("TXT_DOWNLOAD_FAILED"):this.strings.get("WOL:MatchErrorCreatingGame"))}this.updateMapPreview(),this.updateFormModel(),this.controller.toggleSidebarPreview(!0),this.initView()}onViewportChange(){}onUnstack(S){if(S){let j=S.gameMode.id!==this.gameOpts.gameMode;this.gameOpts.gameMode=S.gameMode.id;let D=this.mapList.getByName(S.mapName),F=S.changedMapFile??this.currentMapFile;this.currentMapFile=F;var O=$.findIndexReverse(this.slotsInfo,(S,O)=>O!==this.observerSlotIndex&&(S.type===N.SlotType.Ai||S.type===N.SlotType.Player||S.type===N.SlotType.Open)),B=Math.max(0,O+1-D.maxSlots);for(let S=0;S<B;S++){let B=O-S;B!==this.observerSlotIndex&&(this.slotsInfo[B].type=N.SlotType.Closed,this.gameOpts.aiPlayers[B]=void 0)}let _=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].forEach(S=>{S&&(S.startPos>D.maxSlots-1&&(S.startPos=L.RANDOM_START_POS),j&&(S.teamId=_.alliesAllowed&&_.mustAlly?0:L.NO_TEAM_ID))}),this.applyGameOption(S=>{S.mapName=D.fileName,S.mapDigest=J.MapDigest.compute(F),S.mapSizeBytes=F.getSize(),S.mapTitle=D.getFullMapTitle(this.strings),S.maxSlots=D.maxSlots,S.mapOfficial=D.official}),this.localPrefs.setItem(q.StorageKey.LastMap,D.fileName),this.localPrefs.setItem(q.StorageKey.LastMode,String(S.gameMode.id)),this.saveBotSettings()}this.updateMapPreview(),this.initView()}async onStack(){await this.unrender()}initView(){this.initLobbyForm(),this.refreshSidebarButtons(),this.refreshSidebarMpText(),this.controller.showSidebarButtons()}async initOptions(){await this.loadCustomAiNames(),this.formModel&&(this.formModel.availableAiNames=this.buildAvailableAiNames());var S=this.localPrefs.getItem(q.StorageKey.PreferredGameOpts),O=this.localPrefs.getItem(q.StorageKey.LastPlayerCountry),B=this.localPrefs.getItem(q.StorageKey.LastPlayerColor),D=this.localPrefs.getItem(q.StorageKey.LastPlayerStartPos),F=this.localPrefs.getItem(q.StorageKey.LastPlayerTeam),_=this.localPrefs.getItem(q.StorageKey.LastMap),U=this.localPrefs.getItem(q.StorageKey.LastMode),H=this.localPrefs.getItem(q.StorageKey.LastBots);let V,W=_?this.mapList.getByName(_):void 0,z=W&&U&&this.gameModes.hasId(Number(U))?Number(U):1,K=this.gameModes.getById(z);V=W?.gameModes.find(S=>S.mapFilter===K.mapFilter)?W:(z=1,K=this.gameModes.getById(z),this.mapList.getAll().find(S=>S.gameModes.find(S=>K.mapFilter===S.mapFilter)));let $=this.currentMapFile=await this.mapFileLoader.load(V.fileName),Q=new Z.PreferredHostOpts;S?Q.unserialize(S):Q.applyMpDialogSettings(this.rules.mpDialogSettings);let Y=K.mpDialogSettings,X=j.AiDifficulty.Medium,ee=H?(new ie.Parser).parseAiOpts(H):void 0;ee&&this.sanitizeLastBotSettings(ee,B,D,V.maxSlots,Y),this.gameOpts={gameMode:z,shortGame:Q.shortGame,mcvRepacks:Q.mcvRepacks,cratesAppear:Q.cratesAppear,superWeapons:Q.superWeapons,gameSpeed:Q.gameSpeed,credits:Q.credits,unitCount:Q.unitCount,buildOffAlly:Q.buildOffAlly,destroyableBridges:Q.destroyableBridges,multiEngineer:Q.multiEngineer,noDogEngiKills:Q.noDogEngiKills,humanPlayers:[{name:this.playerName,countryId:void 0!==O&&Number(O)<this.getAvailablePlayerCountries().length?Number(O):L.RANDOM_COUNTRY_ID,colorId:void 0!==B&&Number(B)<this.getAvailablePlayerColors().length?Number(B):L.RANDOM_COLOR_ID,startPos:void 0!==D&&Number(D)<this.getAvailableStartPositions(V.maxSlots).length?Number(D):L.RANDOM_START_POS,teamId:void 0!==F&&Y.alliesAllowed&&Number(F)<4?Number(F):Y.mustAlly?0:L.NO_TEAM_ID}],aiPlayers:[...new Array(9).fill(void 0).map((S,O)=>{if(O&&!(O>V.maxSlots-1)&&O!==this.observerSlotIndex){var B=1<O||ee?ee?.[O]?.difficulty:X;if(void 0!==B)return{countryId:ee?.[O]?.countryId??L.RANDOM_COUNTRY_ID,colorId:ee?.[O]?.colorId??L.RANDOM_COLOR_ID,startPos:ee?.[O]?.startPos??L.RANDOM_START_POS,teamId:ee?.[O]?.teamId??(Y.mustAlly?3:L.NO_TEAM_ID),difficulty:B}}})],mapName:V.fileName,mapDigest:J.MapDigest.compute($),mapSizeBytes:$.getSize(),mapTitle:V.getFullMapTitle(this.strings),maxSlots:V.maxSlots,mapOfficial:V.official},this.isObserver=!1,this.slotsInfo=[{type:N.SlotType.Player,name:this.playerName},...this.gameOpts.aiPlayers.slice(1,this.observerSlotIndex).map(S=>S?{type:N.SlotType.Ai,difficulty:S.difficulty}:{type:N.SlotType.Closed}),{type:N.SlotType.OpenObserver}]}sanitizeLastBotSettings(S,O,B,N,D){let F=0;for(let O=0;O<S.length;++O)S[O]&&(F++,F>N-1&&(S[O]=void 0));let _=void 0!==O?[Number(O)]:[],U=void 0!==B?[Number(B)]:[];for(var H of S)H&&(void 0===H.difficulty||j.AiDifficulty[H.difficulty]||j.isCustomAiDifficulty(H.difficulty)||(H.difficulty=j.AiDifficulty.Easy),void 0!==H.countryId&&H.countryId>=this.getAvailablePlayerCountries().length&&(H.countryId=L.RANDOM_COUNTRY_ID),void 0!==H.colorId&&H.colorId!==L.RANDOM_COUNTRY_ID&&(H.colorId>=this.getAvailablePlayerColors().length||_.includes(H.colorId)?H.colorId=L.RANDOM_COLOR_ID:_.push(H.colorId)),void 0!==H.startPos&&H.startPos!==L.RANDOM_START_POS&&(H.startPos>=this.getAvailableStartPositions(N).length||U.includes(H.startPos)?H.startPos=L.RANDOM_START_POS:U.push(H.startPos)),H.teamId!==L.NO_TEAM_ID?(4<=H.teamId||!D.alliesAllowed)&&(H.teamId=D.mustAlly?3:L.NO_TEAM_ID):D.mustAlly&&(H.teamId=3))}handleError(S,O){this.errorHandler.handle(S,O,()=>{this.controller?.goToScreen(_.ScreenType.Home)})}getAvailablePlayerCountryRules(){return this.rules.getMultiplayerCountries()}getAvailablePlayerCountries(){return this.getAvailablePlayerCountryRules().map(S=>S.name)}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map(S=>S.asHexString())}getAvailableStartPositions(S){return new Array(S).fill(0).map((S,O)=>O)}getSelectablePlayerColors(S){let O=[];S.forEach(S=>{S&&O.push(S.color)});let B=this.getAvailablePlayerColors();return[L.RANDOM_COLOR_NAME].concat(B.filter(S=>S&&-1===O.indexOf(S)))}getSelectableStartPositions(S,O){let B=[];S.forEach(S=>{S&&B.push(S.startPos)});let N=this.getAvailableStartPositions(O);return[L.RANDOM_START_POS].concat(N.filter(S=>!B.includes(S)))}initFormModel(){var S=this.rules.mpDialogSettings;this.formModel={strings:this.strings,countryUiNames:new Map([[L.RANDOM_COUNTRY_NAME,L.RANDOM_COUNTRY_UI_NAME],[L.OBS_COUNTRY_NAME,L.OBS_COUNTRY_UI_NAME]].concat(this.getAvailablePlayerCountryRules().map(S=>[S.name,S.uiName]))),countryUiTooltips:new Map([[L.RANDOM_COUNTRY_NAME,L.RANDOM_COUNTRY_UI_TOOLTIP],[L.OBS_COUNTRY_NAME,L.OBS_COUNTRY_UI_TOOLTIP]].concat(this.getAvailablePlayerCountryRules().filter(S=>S.uiTooltip).map(S=>[S.name,S.uiTooltip]))),availablePlayerCountries:[L.RANDOM_COUNTRY_NAME].concat(this.getAvailablePlayerCountries()),availablePlayerColors:[],availableStartPositions:[],maxTeams:4,availableAiNames:this.buildAvailableAiNames(),lobbyType:F.LobbyType.Singleplayer,mpDialogSettings:S,onCountrySelect:(S,O)=>{this.updatePlayerInfo(this.getCountryIdByName(S),this.getColorIdByName(this.formModel.playerSlots[O].color),this.formModel.playerSlots[O].startPos,this.formModel.playerSlots[O].team,O),this.updateFormModel()},onColorSelect:(S,O)=>{this.updatePlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[O].country),this.getColorIdByName(S),this.formModel.playerSlots[O].startPos,this.formModel.playerSlots[O].team,O),this.updateFormModel()},onStartPosSelect:(S,O)=>{this.updatePlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[O].country),this.getColorIdByName(this.formModel.playerSlots[O].color),S,this.formModel.playerSlots[O].team,O)},onTeamSelect:(S,O)=>{this.updatePlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[O].country),this.getColorIdByName(this.formModel.playerSlots[O].color),this.formModel.playerSlots[O].startPos,S,O)},onSlotChange:(S,O,B)=>{this.changeSlotType(S,O,B),this.saveBotSettings()},onToggleShortGame:S=>this.applyGameOption(O=>O.shortGame=S),onToggleMcvRepacks:S=>this.applyGameOption(O=>O.mcvRepacks=S),onToggleCratesAppear:S=>this.applyGameOption(O=>O.cratesAppear=S),onToggleSuperWeapons:S=>this.applyGameOption(O=>O.superWeapons=S),onToggleBuildOffAlly:S=>this.applyGameOption(O=>O.buildOffAlly=S),onToggleDestroyableBridges:S=>this.applyGameOption(O=>O.destroyableBridges=S),onToggleMultiEngineer:S=>this.applyGameOption(O=>O.multiEngineer=S),onToggleNoDogEngiKills:S=>this.applyGameOption(O=>O.noDogEngiKills=S),onChangeGameSpeed:S=>this.applyGameOption(O=>O.gameSpeed=S),onChangeCredits:S=>this.applyGameOption(O=>O.credits=S),onChangeUnitCount:S=>this.applyGameOption(O=>O.unitCount=S),activeSlotIndex:0,teamsAllowed:!0,teamsRequired:!1,playerSlots:[],shortGame:!0,mcvRepacks:!0,cratesAppear:!0,superWeapons:!0,buildOffAlly:!0,destroyableBridges:!0,multiEngineer:!1,multiEngineerCount:Math.ceil((1-this.rules.general.engineerCaptureLevel)/this.rules.general.engineerDamage)+1,noDogEngiKills:!1,gameSpeed:6,credits:S.money,unitCount:S.unitCount}}applyGameOption(S){S(this.gameOpts),this.updateFormModel(),this.localPrefs.setItem(q.StorageKey.PreferredGameOpts,(new Z.PreferredHostOpts).applyGameOpts(this.gameOpts).serialize())}changeSlotType(S,O,B){var j;if(!this.isObserver&&0===O)throw new Error("Change slot type of host");if(this.isObserver&&O===this.observerSlotIndex)throw new Error("Change slot type of observer");if(S===F.SlotOccupation.Occupied&&void 0!==B){var D=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;let S=this.slotsInfo[O];S.type=N.SlotType.Ai,S.difficulty=B,(j=this.gameOpts.aiPlayers)[O]??(j[O]={difficulty:B,countryId:L.RANDOM_COUNTRY_ID,colorId:L.RANDOM_COLOR_ID,startPos:L.RANDOM_START_POS,teamId:D.mustAlly?3:L.NO_TEAM_ID}),this.gameOpts.aiPlayers[O].difficulty=B}S===F.SlotOccupation.Closed&&(this.slotsInfo[O].type=N.SlotType.Closed,this.gameOpts.aiPlayers[O]=void 0),this.updateFormModel()}saveBotSettings(){this.localPrefs.setItem(q.StorageKey.LastBots,(new re.Serializer).serializeAiOpts(this.gameOpts.aiPlayers))}getCountryNameById(S){let O;return O=S===L.RANDOM_COUNTRY_ID?L.RANDOM_COUNTRY_NAME:S===L.OBS_COUNTRY_ID?L.OBS_COUNTRY_NAME:this.getAvailablePlayerCountries()[S],O}getCountryIdByName(S){let O;return O=S===L.RANDOM_COUNTRY_NAME?L.RANDOM_COUNTRY_ID:S===L.OBS_COUNTRY_NAME?L.OBS_COUNTRY_ID:this.getAvailablePlayerCountries().indexOf(S),O}getColorNameById(S){let O;return O=S===L.RANDOM_COLOR_ID?L.RANDOM_COLOR_NAME:this.getAvailablePlayerColors()[S],O}getColorIdByName(S){let O;if(S===L.RANDOM_COLOR_NAME)O=L.RANDOM_COLOR_ID;else if(O=this.getAvailablePlayerColors().indexOf(S),-1===O)throw new Error(`Color ${S} not found in available player colors`);return O}updatePlayerInfo(S,O,B,j,D){const F=this.slotsInfo[D];if(D!==this.observerSlotIndex||!this.isObserver){if(F.type===N.SlotType.Ai){let N=this.gameOpts.aiPlayers[D];if(!N)throw new Error("No AI found on slot "+D);N.countryId=S,N.colorId=O,N.startPos=B,N.teamId=j,this.saveBotSettings()}else{if(F.type!==N.SlotType.Player)throw new Error("Unexpected slot type "+F.type);{let N=this.gameOpts.humanPlayers.find(S=>S.name===F.name);if(!N)throw new Error("No player found on slot "+D);N.countryId=S,N.colorId=O,N.startPos=B,N.teamId=j,S!==L.RANDOM_COUNTRY_ID?this.localPrefs.setItem(q.StorageKey.LastPlayerCountry,String(S)):this.localPrefs.removeItem(q.StorageKey.LastPlayerCountry),O!==L.RANDOM_COLOR_ID?this.localPrefs.setItem(q.StorageKey.LastPlayerColor,String(O)):this.localPrefs.removeItem(q.StorageKey.LastPlayerColor),B!==L.RANDOM_START_POS?this.localPrefs.setItem(q.StorageKey.LastPlayerStartPos,String(B)):this.localPrefs.removeItem(q.StorageKey.LastPlayerStartPos),j!==L.NO_TEAM_ID?this.localPrefs.setItem(q.StorageKey.LastPlayerTeam,String(j)):this.localPrefs.removeItem(q.StorageKey.LastPlayerTeam)}}this.updateFormModel()}}updateFormModel(){var S=this.gameOpts;this.formModel.gameSpeed=S.gameSpeed,this.formModel.credits=S.credits,this.formModel.unitCount=S.unitCount,this.formModel.shortGame=S.shortGame,this.formModel.superWeapons=S.superWeapons,this.formModel.buildOffAlly=S.buildOffAlly,this.formModel.mcvRepacks=S.mcvRepacks,this.formModel.cratesAppear=S.cratesAppear,this.formModel.destroyableBridges=S.destroyableBridges,this.formModel.multiEngineer=S.multiEngineer,this.formModel.noDogEngiKills=S.noDogEngiKills;let O=S.maxSlots;this.slotsInfo.forEach((S,B)=>{B===this.observerSlotIndex?this.isObserver?this.formModel.playerSlots[B]={country:L.OBS_COUNTRY_NAME,color:L.RANDOM_COLOR_NAME,startPos:L.RANDOM_START_POS,team:L.NO_TEAM_ID}:this.formModel.playerSlots[B]=void 0:this.formModel.playerSlots[B]=B<O?{country:L.RANDOM_COUNTRY_NAME,color:L.RANDOM_COLOR_NAME,startPos:L.RANDOM_START_POS,team:L.NO_TEAM_ID}:void 0}),this.slotsInfo.forEach((S,O)=>{if(this.formModel.playerSlots[O]){let B=this.formModel.playerSlots[O];O===this.observerSlotIndex?(B.type=F.SlotType.Observer,B.country=L.OBS_COUNTRY_NAME,this.isObserver&&S.type===N.SlotType.Player?(B.occupation=F.SlotOccupation.Occupied,B.name=this.playerName):B.occupation=F.SlotOccupation.Open,B.status=F.PlayerStatus.NotReady):(S.type===N.SlotType.Closed?B.occupation=F.SlotOccupation.Closed:S.type===N.SlotType.Open||S.type===N.SlotType.OpenObserver?B.occupation=F.SlotOccupation.Open:B.occupation=F.SlotOccupation.Occupied,S.type===N.SlotType.Ai?(B.aiDifficulty=S.difficulty,B.type=F.SlotType.Ai):S.type===N.SlotType.Player?(B.name=S.name,B.type=F.SlotType.Player):B.type=F.SlotType.Player,B.status=F.PlayerStatus.NotReady)}}),this.formModel.activeSlotIndex=this.isObserver?this.observerSlotIndex:0;let B=this.gameOpts?this.gameOpts.humanPlayers:[],j=this.gameOpts?this.gameOpts.aiPlayers:[],D=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;this.formModel.playerSlots.forEach((S,O)=>{if(S&&B.length)if(O===this.observerSlotIndex&&this.isObserver){const O=B[0];O&&(S.country=this.getCountryNameById(O.countryId))}else if(S.occupation===F.SlotOccupation.Occupied){let N=B.find(O=>O.name===S.name);N||(N=j[O]),N&&(S.country=this.getCountryNameById(N.countryId),S.color=this.getColorNameById(N.colorId),S.startPos=N.startPos,S.team=N.teamId)}else S.country=L.RANDOM_COUNTRY_NAME,S.team=D.mustAlly?3:L.NO_TEAM_ID}),this.formModel.availablePlayerColors=this.getSelectablePlayerColors(this.formModel.playerSlots),this.formModel.availableStartPositions=this.getSelectableStartPositions(this.formModel.playerSlots,S.maxSlots),this.formModel.teamsAllowed=this.gameModes.getById(S.gameMode).mpDialogSettings.alliesAllowed,this.formModel.teamsRequired=this.gameModes.getById(S.gameMode).mpDialogSettings.mustAlly,this.lobbyForm&&B.length&&this.lobbyForm.refresh()}updateMapPreview(){this.mapTask?.cancel(),this.mapTask=new B.Task(async S=>{if(this.controller){let B;this.controller.setSidebarPreview();try{B=new X.MapFile(await this.mapFileLoader.load(this.gameOpts.mapName,S))}catch(S){if(S instanceof W.DownloadError)return void this.handleError(S,this.strings.get("TXT_DOWNLOAD_FAILED"));throw S}var O=new K.MapPreviewRenderer(this.strings).render(B,F.LobbyType.Singleplayer,this.controller.getSidebarPreviewSize());this.controller.setSidebarPreview(O)}}),this.mapTask.start().catch(S=>{S instanceof z.OperationCanceledError||(console.error("Failed to render map preview"),console.error(S))}),this.disposables.add(()=>this.mapTask?.cancel(),()=>this.mapTask=void 0)}initLobbyForm(){var[S]=this.jsxRenderer.render(H.jsx(V.HtmlView,{innerRef:S=>this.lobbyForm=S,component:D.LobbyForm,props:this.formModel}));this.controller.setMainComponent(S)}refreshSidebarButtons(){let S=this.strings;var O=[{label:S.get("GUI:StartGame"),tooltip:S.get("STT:SkirmishButtonStartGame"),disabled:!1,onClick:()=>{const S=this.gameOpts.humanPlayers[0]&&this.gameOpts.humanPlayers[0].countryId===L.OBS_COUNTRY_ID,O=this.gameOpts.aiPlayers.filter(Q.isNotNullOrUndefined).length;(S?O>=2:O>=1)?this.meetsMinimumTeams()?this.rootController.createGame("0",Date.now(),void 0,this.playerName,this.gameOpts,!0,!1,!1,!1,new ee.MainMenuRoute(_.ScreenType.Skirmish)):this.messageBoxApi.show(this.strings.get("TXT_CANNOT_ALLY"),this.strings.get("GUI:Ok")):this.messageBoxApi.show(this.strings.get("TXT_NEED_AT_LEAST_TWO_PLAYERS"),this.strings.get("GUI:Ok"))}},{label:this.isObserver?S.get("GUI:JoinGame"):S.get("GUI:Observer"),tooltip:this.isObserver?S.get("STT:LobbyButtonJoin"):S.get("STT:PlayerSideObserver"),onClick:()=>{const S=this.gameOpts.humanPlayers[0];if(S){if(this.isObserver)this.isObserver=!1,S.countryId=L.RANDOM_COUNTRY_ID,S.colorId=L.RANDOM_COLOR_ID,S.startPos=L.RANDOM_START_POS,S.teamId=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings.mustAlly?0:L.NO_TEAM_ID,this.slotsInfo[this.observerSlotIndex]={type:N.SlotType.OpenObserver},this.slotsInfo[0]={type:N.SlotType.Player,name:this.playerName},this.gameOpts.aiPlayers[0]=void 0;else{this.isObserver=!0;const O=this.gameOpts.aiPlayers[1];if(O)this.gameOpts.aiPlayers[0]={...O},this.slotsInfo[0]={type:N.SlotType.Ai,difficulty:O.difficulty};else{const S=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;this.gameOpts.aiPlayers[0]={countryId:L.RANDOM_COUNTRY_ID,colorId:L.RANDOM_COLOR_ID,startPos:L.RANDOM_START_POS,teamId:S.mustAlly?0:L.NO_TEAM_ID,difficulty:j.AiDifficulty.Medium},this.slotsInfo[0]={type:N.SlotType.Ai,difficulty:j.AiDifficulty.Medium}}S.countryId=L.OBS_COUNTRY_ID,S.colorId=L.OBS_COLOR_ID,S.startPos=L.RANDOM_START_POS,S.teamId=L.NO_TEAM_ID,this.slotsInfo[this.observerSlotIndex]={type:N.SlotType.Player,name:this.playerName}}this.updateFormModel(),this.refreshSidebarButtons(),this.refreshSidebarMpText()}}},{label:S.get("GUI:ChooseMap"),tooltip:S.get("STT:SkirmishButtonChooseMap"),onClick:()=>{this.controller?.pushScreen(_.ScreenType.MapSelection,{lobbyType:F.LobbyType.Singleplayer,gameOpts:this.gameOpts,usedSlots:()=>{let S=0;for(let O=0;O<this.observerSlotIndex;O++)!this.slotsInfo[O]||this.slotsInfo[O].type!==N.SlotType.Ai&&this.slotsInfo[O].type!==N.SlotType.Player||(S=O+1);return S}})}},{label:S.get("GUI:Back"),tooltip:S.get("STT:SkirmishButtonBack"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(_.ScreenType.Home)}}];this.controller.setSidebarButtons(O,!0),this.refreshSidebarMpText()}meetsMinimumTeams(){let S=[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].filter(Q.isNotNullOrUndefined).filter(S=>S.countryId!==L.OBS_COUNTRY_ID),O=S[0].teamId;return O===L.NO_TEAM_ID||S.some(S=>S.teamId!==O)}refreshSidebarMpText(){this.controller?.setSidebarMpContent({text:this.gameOpts?this.strings.get(this.gameModes.getById(this.gameOpts.gameMode).label)+"\n\n"+this.gameOpts.mapTitle:""})}async onLeave(){this.disposables.dispose(),this.gameOpts=void 0,this.slotsInfo=void 0,this.currentMapFile=void 0,this.controller.toggleSidebarPreview(!1),await this.unrender()}async unrender(){await this.controller.hideSidebarButtons(),this.lobbyForm&&(this.lobbyForm=void 0)}},S("SkirmishScreen",se)}}}),System.register("gui/screen/mainMenu/lobby/component/CreateGameBox",["react","gui/component/Dialog","network/WolConnection"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("CreateGameBox",({strings:S,viewport:O,onSubmit:L,onDismiss:D})=>{let[F,_]=B.useState(!1),[U,H]=B.useState(""),V=B.useRef(null),W=B.useRef(null),[z,K]=B.useState(!1),$=B.useRef(null);return B.default.createElement(N.Dialog,{className:"login-box create-game-box",hidden:F,viewport:O,buttons:[{label:S.get("GUI:Ok"),onClick:()=>W.current?.click()},{label:S.get("GUI:Cancel"),onClick:()=>{_(!0),D?.()}}],zIndex:100},B.default.createElement("form",{onSubmit:S=>{S.preventDefault(),_(!0),L(U,z?V.current.value:"",$.current.checked)},autoComplete:"off"},B.default.createElement("div",{className:"field"},B.default.createElement("label",null,S.get("GUI:RoomDesc")),B.default.createElement("input",{name:"roomname",type:"text",value:U,maxLength:j.WolConnection.MAX_ROOM_DESC_LEN,onChange:S=>{H(S.target.value)}})),B.default.createElement("div",{className:"field"},B.default.createElement("label",null,S.get("GUI:Password")),B.default.createElement("input",{name:"enablepass",type:"checkbox",checked:z,onChange:()=>{K(!z)}}),B.default.createElement("input",{name:"lobbypass",type:"password",autoComplete:"off","data-lpignore":"true",ref:V,disabled:!z,required:z})),B.default.createElement("div",{className:"field"},B.default.createElement("label",null,S.get("GUI:Observe")),B.default.createElement("input",{type:"checkbox",name:"test",ref:$})),B.default.createElement("button",{type:"submit",ref:W,style:{visibility:"hidden"}})))})}}}),System.register("gui/screen/mainMenu/lobby/component/LobbyForm",["react","classnames","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/component/Slider","gui/component/Chat","gui/component/CountrySelect","gui/component/ColorSelect","gui/component/PingIndicator","game/gameopts/GameOpts","gui/component/Image","gui/component/StartPosSelect","gui/component/TeamSelect","game/gameopts/constants","gui/component/Select","gui/component/Option","util/typeGuard","gui/screen/mainMenu/lobby/component/RankIndicator"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S}],execute:function(){Y=class extends B.default.Component{constructor(){super(...arguments),this.onPlayerSelect=(S,O)=>{let B,N;if(S.match(/^\d+$/)){const O=Number(S);O>=100?(B=j.SlotOccupation.Occupied,N=O):B=O}else B=j.SlotOccupation.Occupied,N=H.AiDifficulty[S];this.props.onSlotChange(B,O,N)}}render(){let{strings:S,lobbyType:O,mpDialogSettings:F}=this.props;var _=O===j.LobbyType.Singleplayer||O===j.LobbyType.MultiplayerHost,U=O===j.LobbyType.Singleplayer;let H=this.props;return B.default.createElement("div",{className:N.default("lobby-form",{"lobby-form-sp":U,"lobby-form-server-sel":H.selectedGameServer})},H.selectedGameServer&&B.default.createElement("div",{className:"game-server"},B.default.createElement("span",{className:"label"},S.get("TS:ServerLabel")),B.default.createElement($.Select,{initialValue:H.selectedGameServer,disabled:!0},B.default.createElement(q.Option,{label:H.selectedGameServer,value:H.selectedGameServer}))),B.default.createElement("div",{className:"player-slots"},B.default.createElement("div",{className:"player-slot player-slot-header"},B.default.createElement("div",{className:"player-header-players"},S.get("GUI:Players")),B.default.createElement("div",{className:"player-header-side"},S.get("GUI:Side")),B.default.createElement("div",{className:"player-header-color"},S.get("GUI:Color")),B.default.createElement("div",{className:"player-header-position"},S.get("GUI:StartPosition")),B.default.createElement("div",{className:"player-header-team"},S.get("GUI:Team"))),H.playerSlots.map((S,O)=>this.renderPlayerSlot(H,S,O))),B.default.createElement("div",{className:"game-options"},B.default.createElement("div",{className:"game-options-left"},B.default.createElement("div",{"data-r-tooltip":S.get("STT:HostCBoxShortGame")},B.default.createElement("label",null,B.default.createElement("input",{type:"checkbox",name:"shortGame",checked:H.shortGame,onChange:S=>this.props.onToggleShortGame(S.target.checked),disabled:!_})," ",B.default.createElement("span",null,S.get("GUI:ShortGame")))),B.default.createElement("div",{"data-r-tooltip":S.get("STT:HostCBoxRedeploys")},B.default.createElement("label",null,B.default.createElement("input",{type:"checkbox",name:"mcvRepacks",checked:H.mcvRepacks,onChange:S=>this.props.onToggleMcvRepacks(S.target.checked),disabled:!_})," ",B.default.createElement("span",null,S.get("GUI:MCVRepacks")))),B.default.createElement("div",{"data-r-tooltip":S.get("STT:HostCBoxCrates")},B.default.createElement("label",null,B.default.createElement("input",{type:"checkbox",name:"cratesAppear",checked:H.cratesAppear,onChange:S=>this.props.onToggleCratesAppear(S.target.checked),disabled:!_})," ",B.default.createElement("span",null,S.get("GUI:CratesAppear")))),B.default.createElement("div",{"data-r-tooltip":S.get("STT:HostCBoxSWAllowed")},B.default.createElement("label",null,B.default.createElement("input",{type:"checkbox",name:"superWeapons",checked:H.superWeapons,onChange:S=>this.props.onToggleSuperWeapons(S.target.checked),disabled:!_})," ",B.default.createElement("span",null,S.get("GUI:SuperWeaponsAllowed")))),void 0!==H.hostTeams&&B.default.createElement("div",{"data-r-tooltip":S.get("STT:HostCBoxHostTeams")},B.default.createElement("label",null,B.default.createElement("input",{type:"checkbox",name:"hostTeams",checked:H.hostTeams,onChange:S=>this.props.onToggleHostTeams?.(S.target.checked),disabled:!_})," ",B.default.createElement("span",null,S.get("GUI:HostTeams")))),B.default.createElement("div",{"data-r-tooltip":S.get("STT:DestroyableBridges")},B.default.createElement("label",null,B.default.createElement("input",{type:"checkbox",name:"destBridges",checked:H.destroyableBridges,onChange:S=>this.props.onToggleDestroyableBridges?.(S.target.checked),disabled:!_})," ",B.default.createElement("span",null,S.get("GUI:DestroyableBridges")))),B.default.createElement("div",{"data-r-tooltip":S.get("STT:MultiEngineer",H.multiEngineerCount)},B.default.createElement("label",null,B.default.createElement("input",{type:"checkbox",name:"multiEngineer",checked:H.multiEngineer,onChange:S=>this.props.onToggleMultiEngineer?.(S.target.checked),disabled:!_})," ",B.default.createElement("span",null,S.get("GUI:MultiEngineer")))),B.default.createElement("div",{"data-r-tooltip":S.get("STT:NoDogEngiKills")},B.default.createElement("label",null,B.default.createElement("input",{type:"checkbox",name:"noDogEngiKills",checked:H.noDogEngiKills,onChange:S=>this.props.onToggleNoDogEngiKills?.(S.target.checked),disabled:!_})," ",B.default.createElement("span",null,S.get("GUI:NoDogEngiKills"))))),B.default.createElement("div",{className:"game-options-right"+(_?"":" all-disabled")},B.default.createElement("div",{className:"slider-item"},B.default.createElement("span",{className:"label"},S.get("GUI:GameSpeed")),B.default.createElement(L.Slider,{name:"gameSpeed",min:0,max:6,value:""+H.gameSpeed,disabled:!_,"data-r-tooltip":S.get("STT:HostSliderSpeed"),onChange:S=>this.props.onChangeGameSpeed(Number(S.target.value))})),B.default.createElement("div",{className:"slider-item"},B.default.createElement("span",{className:"label"},S.get("GUI:Credits")),B.default.createElement(L.Slider,{name:"credits",min:F.minMoney,max:F.maxMoney,step:F.moneyIncrement,value:""+H.credits,"data-r-tooltip":S.get("STT:HostSliderCredits"),onChange:S=>this.props.onChangeCredits(Number(S.target.value)),disabled:!_})),B.default.createElement("div",{className:"slider-item"},B.default.createElement("span",{className:"label"},S.get("GUI:UnitCount")),B.default.createElement(L.Slider,{name:"unitCount",min:F.minUnitCount,max:F.maxUnitCount,value:""+H.unitCount,"data-r-tooltip":S.get("STT:HostSliderUnit"),onChange:S=>this.props.onChangeUnitCount(Number(S.target.value)),disabled:!_})),B.default.createElement("div",{className:"checkbox-item","data-r-tooltip":S.get("STT:HostCBoxBuildOffAlly")},B.default.createElement("label",null,B.default.createElement("input",{type:"checkbox",name:"buildOffAlly",checked:H.buildOffAlly,disabled:!_,onChange:S=>this.props.onToggleBuildOffAlly(S.target.checked)})," ",B.default.createElement("span",null,S.get("GUI:BuildOffAlly")))))),void 0!==this.props.messages&&void 0!==this.props.localUsername&&this.props.onSendMessage&&B.default.createElement(D.Chat,{messages:this.props.messages,localUsername:this.props.localUsername,channels:this.props.channels??[],chatHistory:this.props.chatHistory,onSendMessage:this.props.onSendMessage,tooltips:{button:S.get("STT:EmoteButton"),input:_?S.get("STT:HostEditInput"):S.get("STT:GuestEditInput"),output:_?S.get("STT:HostEditOutput"):S.get("STT:GuestEditOutput")},strings:S}))}renderPlayerSlot(S,O,N){const L=S.strings;var D=S.lobbyType===j.LobbyType.Singleplayer||S.lobbyType===j.LobbyType.MultiplayerHost;return O?B.default.createElement("div",{className:"player-slot",key:"playerslot"+N},O.type===j.SlotType.Player?B.default.createElement(Z.RankIndicator,{playerProfile:O.playerProfile,strings:L}):B.default.createElement(Z.RankIndicator,{playerProfile:void 0,strings:L}),B.default.createElement(U.PingIndicator,{ping:O.type===j.SlotType.Player?O.ping:void 0,strings:L}),B.default.createElement("div",{className:"player-status","data-r-tooltip":L.get("STT:HostPictureAcceptance")},this.renderPlayerStatus(O.status)),this.renderPlayerSelect(O,N,S.lobbyType),B.default.createElement(F.CountrySelect,{countryUiNames:S.countryUiNames,countryUiTooltips:S.countryUiTooltips,country:O.country,availableCountries:S.availablePlayerCountries,disabled:N!==S.activeSlotIndex&&(!D||O.type!==j.SlotType.Ai)||O.type===j.SlotType.Observer||O.status===j.PlayerStatus.Ready&&O.type!==j.SlotType.Ai,strings:S.strings,onSelect:S=>this.props.onCountrySelect(S,N)}),O.type!==j.SlotType.Observer?B.default.createElement(B.default.Fragment,null,B.default.createElement(_.ColorSelect,{color:O.color,availableColors:S.availablePlayerColors,disabled:N!==S.activeSlotIndex&&(!D||O.type!==j.SlotType.Ai)||O.status===j.PlayerStatus.Ready&&O.type!==j.SlotType.Ai,strings:S.strings,onSelect:S=>this.props.onColorSelect(S,N)}),B.default.createElement(W.StartPosSelect,{disabled:S.hostTeams?!D||O.occupation!==j.SlotOccupation.Occupied:N!==S.activeSlotIndex&&(!D||O.type!==j.SlotType.Ai)||O.status===j.PlayerStatus.Ready&&O.type!==j.SlotType.Ai,startPos:O.startPos,availableStartPositions:S.availableStartPositions,onSelect:S=>this.props.onStartPosSelect(S,N),strings:S.strings}),B.default.createElement(z.TeamSelect,{disabled:!S.teamsAllowed||(S.hostTeams?!D||O.occupation!==j.SlotOccupation.Occupied:N!==S.activeSlotIndex&&(!D||O.type!==j.SlotType.Ai)||O.status===j.PlayerStatus.Ready&&O.type!==j.SlotType.Ai),teamId:S.teamsAllowed?O.team:K.NO_TEAM_ID,required:S.teamsRequired,maxTeams:S.maxTeams,onSelect:S=>this.props.onTeamSelect(S,N),strings:S.strings})):null):B.default.createElement("div",{className:"player-slot",key:"playerslot"+N})}renderPlayerStatus(S){return S===j.PlayerStatus.Host?B.default.createElement(V.Image,{src:"wolhost.pcx"}):S===j.PlayerStatus.Ready?B.default.createElement(V.Image,{src:"wolacpt.pcx"}):null}renderPlayerSelect(S,O,N){let L=N===j.LobbyType.Singleplayer;var D=L||N===j.LobbyType.MultiplayerHost;if(O===this.props.activeSlotIndex&&S.type===j.SlotType.Player)return B.default.createElement("input",{type:"text",className:"player-name",value:S.name,readOnly:!0});let F=this.props.strings,_=(new Map).set(j.SlotOccupation.Occupied,S.name||"").set(j.SlotOccupation.Open,F.get(S.type===j.SlotType.Observer?"GUI:OpenObserver":"GUI:Open")).set(j.SlotOccupation.Closed,L?F.get("GUI:None"):F.get("GUI:Closed")),U=S.occupation;return S.occupation===j.SlotOccupation.Occupied&&S.type===j.SlotType.Ai&&(_.delete(j.SlotOccupation.Occupied),U=S.aiDifficulty>=100?S.aiDifficulty:H.AiDifficulty[S.aiDifficulty]),S.type!==j.SlotType.Observer&&this.props.availableAiNames.forEach((S,O)=>{const B=O>=100?O:H.AiDifficulty[O],N=F.get(S)||S;_.set(B,N)}),B.default.createElement($.Select,{initialValue:""+U,disabled:!D,onSelect:S=>this.onPlayerSelect(S,O),className:"player-name",tooltip:L?F.get("STT:SkirmishComboAiPlayer"):F.get("STT:HostComboPlayer")},[..._].map(([O,N])=>O===j.SlotOccupation.Occupied&&S.occupation!==j.SlotOccupation.Occupied||O===j.SlotOccupation.Open&&L?null:B.default.createElement(q.Option,{key:O,value:""+O,label:N,tooltip:L?(()=>{let S;return S=O===j.SlotOccupation.Closed?"STT:PlayerNone":K.aiUiTooltips.get(H.AiDifficulty[O]),S?F.get(S):void 0})():void 0})).filter(Q.isNotNullOrUndefined))}},S("LobbyForm",Y)}}}),System.register("gui/screen/mainMenu/lobby/component/PasswordBox",["react","gui/component/Dialog"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("PasswordBox",({strings:S,viewport:O,onSubmit:j,onDismiss:L})=>{let D=B.useRef(null),[F,_]=B.useState(!1);B.useEffect(()=>{setTimeout(()=>{D.current?.focus()},50)},[]);var c=S=>{S&&S.preventDefault(),_(!0),j(D.current.value)};return B.default.createElement(N.Dialog,{className:"login-box password-box",hidden:F,viewport:O,zIndex:100,buttons:[{label:S.get("GUI:Ok"),onClick:c},{label:S.get("GUI:Cancel"),onClick:()=>{_(!0),L?.()}}]},B.default.createElement("form",{onSubmit:c,autoComplete:"off"},B.default.createElement("div",{className:"field"},B.default.createElement("label",null,S.get("GUI:Password")),B.default.createElement("input",{name:"lobbypass",type:"password",autoComplete:"off","data-lpignore":"true",ref:D})),B.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))})}}}),System.register("gui/screen/mainMenu/lobby/component/RankIndicator",["react","gui/component/Image","network/ladder/PlayerRankType"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=(new Map).set(j.PlayerRankType.Private,"private").set(j.PlayerRankType.Corporal,"corporal").set(j.PlayerRankType.Sergeant,"sergeant").set(j.PlayerRankType.Lieutenant,"lieutena").set(j.PlayerRankType.Major,"major").set(j.PlayerRankType.Colonel,"colonel").set(j.PlayerRankType.BrigGeneral,"briggenr").set(j.PlayerRankType.General,"general").set(j.PlayerRankType.FiveStarGeneral,"stargen").set(j.PlayerRankType.CommanderInChief,"comchief"),S("RANK_LABELS",D=(new Map).set(j.PlayerRankType.Private,"GUI:RankPrivate").set(j.PlayerRankType.Corporal,"GUI:RankCorporal").set(j.PlayerRankType.Sergeant,"GUI:RankSergeant").set(j.PlayerRankType.Lieutenant,"GUI:RankLieutenant").set(j.PlayerRankType.Major,"GUI:RankMajor").set(j.PlayerRankType.Colonel,"GUI:RankColonel").set(j.PlayerRankType.BrigGeneral,"GUI:RankBrigGeneral").set(j.PlayerRankType.General,"GUI:RankGeneral").set(j.PlayerRankType.FiveStarGeneral,"GUI:RankFiveStar").set(j.PlayerRankType.CommanderInChief,"GUI:RankCmdInChief")),S("RankIndicator",({playerProfile:S,strings:O})=>{var F=S?.rankType??j.PlayerRankType.None,_=S?F!==j.PlayerRankType.None?S.name+" : "+O.get(D.get(F)):S.name+" : "+O.get("TXT_UNRANKED"):void 0;return B.default.createElement("div",{className:"rank-indicator","data-r-tooltip":_},F!==j.PlayerRankType.None?B.default.createElement(N.Image,{src:L.get(F)+".pcx"}):null)})}}}),System.register("gui/screen/mainMenu/lobby/component/viewmodel/lobby",[],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[],execute:function(){var O,D;(O=B||S("LobbyType",B={}))[O.Singleplayer=0]="Singleplayer",O[O.MultiplayerHost=1]="MultiplayerHost",O[O.MultiplayerGuest=2]="MultiplayerGuest",(D=N||S("SlotType",N={}))[D.Player=1]="Player",D[D.Ai=2]="Ai",D[D.Observer=3]="Observer",(D=j||S("SlotOccupation",j={}))[D.Open=1]="Open",D[D.Closed=2]="Closed",D[D.Occupied=3]="Occupied",(D=L||S("PlayerStatus",L={}))[D.NotReady=1]="NotReady",D[D.Ready=2]="Ready",D[D.Host=3]="Host"}}}),System.register("gui/screen/mainMenu/login/LoginBox",["react","gui/screen/mainMenu/login/ServerList","@puzzl/core/lib/async/Task","network/HttpRequest","network/WolConfig"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){F=({regions:S,selectedRegion:O,selectedUser:F,pings:_,breakingNewsUrl:U,strings:H,onRegionChange:V,onRequestRegionRefresh:W,onSubmit:z},K)=>{let $=B.useRef(null),q=B.useRef(null),Q=B.useRef(null),[Z,Y]=B.useState();B.useEffect(()=>{setTimeout(()=>q.current?.focus(),50)},[]),B.useEffect(()=>{if(U){let S=new j.Task(async S=>{let O=await(new L.HttpRequest).fetchHtml(U,S);O=O.trim(),O.length&&Y(O)});return S.start().catch(S=>console.error(S)),()=>S.cancel()}},[U]);const b=()=>{q.current&&Q.current&&z(q.current.value,Q.current.value)};return B.useImperativeHandle(K,()=>({submit(){$.current?.requestSubmit?$.current.requestSubmit():b()}})),B.default.createElement("div",{className:"login-wrapper"},B.default.createElement("div",{className:"title"},H.get("GUI:Login")),B.default.createElement("form",{onSubmit:S=>{S.preventDefault(),b()},className:"login-form login-box",ref:$},B.default.createElement("div",{className:"field"},B.default.createElement("label",null,H.get("TS:Region")),F&&O?B.default.createElement("input",{type:"text",value:O.label,readOnly:!0}):B.default.createElement(B.default.Fragment,null,B.default.createElement(N.ServerList,{regionId:O?.id,regions:S,pings:_,strings:H,onChange:S=>{V(S)}}),B.default.createElement("button",{type:"button",className:"icon-button refresh-button",onClick:W}))),B.default.createElement("div",{className:"field"},B.default.createElement("label",null,H.get("GUI:Nickname")),B.default.createElement("input",{name:"user",type:"text",required:!0,minLength:D.MIN_USERNAME_LEN,maxLength:D.MAX_USERNAME_LEN,pattern:"[a-zA-Z0-9_\\-]+",ref:q,value:F,readOnly:!!F})),B.default.createElement("div",{className:"field"},B.default.createElement("label",null,H.get("GUI:Password")),B.default.createElement("input",{name:"pass",type:"password",required:!0,maxLength:D.MAX_PASS_LEN,ref:Q})),B.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})),Z&&B.default.createElement("fieldset",{className:"news"},B.default.createElement("legend",null,H.get("GUI:BreakingNews")),B.default.createElement("div",{dangerouslySetInnerHTML:{__html:Z}})))},S("LoginBox",B.forwardRef(F))}}}),System.register("gui/screen/mainMenu/login/LoginScreen",["gui/jsx/jsx","network/WolError","gui/screen/mainMenu/login/LoginBox","gui/screen/mainMenu/ScreenType","gui/jsx/HtmlView","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/sleep","LocalPrefs","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/login/ServerPings","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/MainMenuRoute"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S}],execute:function(){K=void 0,$=class extends H.MainMenuScreen{constructor(S,O,B,N,j,L,D,F,_,U,H,V,W,z){super(),this.wolService=S,this.wladderService=O,this.wgameresService=B,this.mapTransferService=N,this.strings=j,this.jsxRenderer=L,this.messageBoxApi=D,this.serverRegions=F,this.serversUrl=_,this.breakingNewsUrl=U,this.wolLogger=H,this.errorHandler=V,this.localPrefs=W,this.rootController=z,this.title=this.strings.get("GUI:Login"),this.needsServerListRefresh=!1,this.handleLoginSubmit=async(S,O)=>{var B;!this.isBusy&&this.loginBoxApi&&this.controller&&(this.isBusy=!0,(B=this.selectedRegion)&&(await this.controller.hideSidebarButtons(),await this.login(S,O,B.id)))}}async onEnter(S){this.params=S,this.formRendered=!1,this.controller.toggleMainVideo(!1),S.clearCredentials?K=void 0:S.useCredentials&&(K=S.useCredentials);try{await this.loadServerList()}catch(S){return void this.handleWolError(S,this.strings.get("TXT_NO_SERV_LIST"),{fatal:!0})}this.needsServerListRefresh=!1,this.serverPings=new V.ServerPings(this.serverRegions,this.wolLogger),K&&this.serverRegions.isAvailable(K.regionId)?(this.isBusy=!0,this.login(K.user,K.pass,K.regionId)):(this.isBusy=!1,this.initView(!0))}async loadServerList(S){let O=!1;var B=setTimeout(async()=>{this.messageBoxApi.show(this.strings.get("TXT_CONNECTING")),O=!0},1e3);try{var N=await this.wolService.loadServerList(this.serversUrl,S);if(S?.isCancelled())return;this.serverRegions.load(N),this.selectedRegion&&(this.selectedRegion=this.serverRegions.getAll().find(S=>S.id===this.selectedRegion.id))}finally{clearTimeout(B),O&&this.messageBoxApi.destroy()}}initView(S=!1){if(this.controller){if(this.updateSidebarButtons(),this.isBusy||this.controller.showSidebarButtons(),!this.selectedRegion){var O=(O=this.localPrefs.getItem(U.StorageKey.PreferredServerRegion))&&this.serverRegions.isAvailable(O)?this.serverRegions.get(O):this.serverRegions.getFirstAvailable();let S=this.serverPings.pings;!O||S.has(O)&&void 0===S.get(O)?this.selectedRegion=void 0:this.selectedRegion=O}S&&!this.params.forceUser&&this.selectedRegion&&this.updateServers();var[O]=this.jsxRenderer.render(B.jsx(D.HtmlView,{width:"100%",height:"100%",component:j.LoginBox,props:{ref:S=>this.loginBoxApi=S,regions:this.serverRegions.getAll(),selectedRegion:this.selectedRegion,selectedUser:this.params.forceUser,pings:this.serverPings.pings,breakingNewsUrl:this.breakingNewsUrl,strings:this.strings,onRegionChange:S=>{this.selectedRegion=this.serverRegions.get(S),this.loginBox?.applyOptions(S=>S.selectedRegion=this.selectedRegion),this.updateSidebarButtons()},onRequestRegionRefresh:()=>{this.needsServerListRefresh=!0,this.updateServers()},onSubmit:this.handleLoginSubmit},innerRef:S=>this.loginBox=S}));this.controller.setMainComponent(O),this.updateSidebarButtons(),this.formRendered=!0}}updateSidebarButtons(){this.controller&&this.controller.setSidebarButtons([{label:this.strings.get("GUI:Login"),disabled:!this.selectedRegion,onClick:()=>{this.submitLoginForm()}},{label:this.strings.get("GUI:NewAccount"),disabled:!!this.params.forceUser,onClick:()=>{this.controller?.goToScreen(L.ScreenType.NewAccount,{regionId:this.selectedRegion?.id,afterLogin:this.params.afterLogin})}},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(L.ScreenType.Home)}}])}updateServers(){this.isBusy||this.serversUpdateTask||(this.serverPings.pings.clear(),this.handleServerPingsUpdate(),this.serversUpdateTask=new F.Task(async S=>{if(this.formRendered||await _.sleep(500,S),this.needsServerListRefresh){this.needsServerListRefresh=!1;try{await this.loadServerList(S)}catch(S){return this.handleWolError(S,this.strings.get("TXT_NO_SERV_LIST"),{fatal:!0}),void(this.serversUpdateTask=void 0)}}this.loginBox?.applyOptions(S=>{S.selectedRegion=this.selectedRegion,S.regions=this.serverRegions.getAll()}),this.updateSidebarButtons();try{await this.serverPings.update(()=>this.handleServerPingsUpdate(),S)}finally{this.serversUpdateTask=void 0}this.handleServerPingsUpdate()}),this.serversUpdateTask.start().catch(S=>{S instanceof W.OperationCanceledError||console.error(S)}))}handleServerPingsUpdate(){if(this.loginBoxApi){var S=this.selectedRegion;let O=this.serverPings.pings;S&&O.has(S)&&void 0===O.get(S)&&(this.selectedRegion=void 0,this.loginBox?.applyOptions(S=>S.selectedRegion=void 0),this.updateSidebarButtons()),this.loginBox?.refresh()}}submitLoginForm(){!this.isBusy&&this.loginBoxApi&&this.controller&&this.selectedRegion&&this.loginBoxApi.submit()}async login(S,O,B){if(S.match(/^[A-Za-z0-9-_]+$/)){this.serversUpdateTask?.cancel(),this.serversUpdateTask=void 0;let D=new F.Task(async S=>{await _.sleep(1e3,S),S.isCancelled()||this.messageBoxApi.show(this.strings.get("TXT_CONNECTING"))});D.start().catch(S=>{S instanceof W.OperationCanceledError||console.error(S)});var j=this.serverRegions.get(B);this.serverRegions.setSelectedRegion(B);try{await this.wolService.validateGameVersion(j)}catch(S){let O;return D.cancel(),this.messageBoxApi.destroy(),O=S instanceof N.WolError&&S.code===N.WolError.Code.OutdatedClient?this.strings.get("TS:OutdatedClient"):this.strings.get("TXT_NO_SERV_LIST"),void this.handleWolError(S,O,{fatal:!1})}let H=!1;try{let N=[];this.wolService.isConnected()&&this.wolService.getConnection().getCurrentUser()||(N=await this.wolService.connectAndLogin({url:j.wolUrl,user:S,pass:O},({position:S,avgWaitSeconds:O})=>{D.cancel(),this.messageBoxApi.show(this.strings.get("TS:ServerFull")+"\n\n\n"+this.strings.get("TS:LoginPositionInQueue",S)+"\n"+this.strings.get("TS:LoginAvgWaitTime")+(0<O&&O<3600?this.strings.get("TS:LoginAvgWaitTimeMinutes",O<60?"<1":"~"+Math.ceil(O/60)):this.strings.get("TS:LoginAvgWaitTimeUnavail")),this.strings.get("GUI:Cancel"),()=>{H=!0,this.wolService.closeWolConnection()})}),this.wladderService.setUrl(j.wladderUrl),this.wgameresService.setUrl(j.wgameresUrl),this.mapTransferService.setUrl(j.mapTransferUrl),K={user:S,pass:O,regionId:B}),D.cancel(),this.messageBoxApi.destroy(),this.localPrefs.setItem(U.StorageKey.PreferredServerRegion,B);var L=this.params.afterLogin(N);L instanceof z.MainMenuRoute?this.controller?.goToScreen(L.screenType,L.params):this.rootController.goToScreen(L.screenType,L.params)}catch(S){if(D.cancel(),this.messageBoxApi.destroy(),H)return this.isBusy=!1,void(this.formRendered?(this.updateSidebarButtons(),this.controller?.showSidebarButtons()):this.initView());if(S instanceof N.WolError&&S.code===N.WolError.Code.OutdatedClient)return void this.handleWolError(S,this.strings.get("TS:OutdatedClient"),{fatal:!1});S instanceof N.WolError&&S.code===N.WolError.Code.BadLogin?(this.wolService.closeWolConnection(),this.handleBadPass()):S instanceof N.WolError&&S.code===N.WolError.Code.BannedFromServer?(this.wolService.closeWolConnection(),this.handleLoginError(S.reason??"This account is banned")):S instanceof N.WolError&&S.code===N.WolError.Code.ServerFull?this.handleLoginError(this.strings.get("TS:ServerFull")):this.handleWolError(S,this.strings.get("TS:ConnectFailed"),{fatal:!1,netError:!0})}}else this.handleBadPass()}handleBadPass(){this.handleLoginError(this.strings.get("TXT_BADPASS"))}handleLoginError(S){this.messageBoxApi.show(S,this.strings.get("GUI:Ok"),()=>{this.isBusy=!1,this.formRendered?(this.updateSidebarButtons(),this.controller.showSidebarButtons()):this.initView()})}handleWolError(S,O,{fatal:B,netError:N}){this.errorHandler.handle(S,O,()=>{this.isBusy=!1,this.serversUpdateTask?.cancel(),this.serversUpdateTask=void 0,this.wolService.closeWolConnection(),B?this.controller?.goToScreen(L.ScreenType.Home):this.formRendered?(this.updateSidebarButtons(),this.controller?.showSidebarButtons()):(N&&(this.needsServerListRefresh=!0),this.initView(N))})}async onLeave(){this.loginBoxApi=null,this.loginBox=void 0,this.formRendered=!1,this.serversUpdateTask?.cancel(),this.serversUpdateTask=void 0,this.isBusy||await this.controller.hideSidebarButtons(),this.isBusy=!1}},S("LoginScreen",$)}}}),System.register("gui/screen/mainMenu/login/ServerList",["gui/component/List","react"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("ServerList",({regionId:S,regions:O,pings:j,strings:L,onChange:D})=>N.default.createElement(B.List,{className:"server-list"},O.map(O=>{var F=j.get(O);let _=!O.available||j.has(O)&&void 0===F;return N.default.createElement(B.ListItem,{key:O.id,selected:O.id===S&&!_,disabled:_,onClick:()=>!_&&D(O.id)},N.default.createElement("span",{className:"label"},O.label),N.default.createElement("span",{className:"ping"},_?N.default.createElement("span",{className:"offline-text"},L.get("TS:ServerOffline")):void 0!==F&&N.default.createElement("span",{className:"online-text"},L.get("TS:ServerOnline"))))})))}}}),System.register("gui/screen/mainMenu/login/ServerPingIndicator",["react","classnames","gui/component/Image"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){var O;(O=L=L||{})[O.Good=1]="Good",O[O.Average=2]="Average",O[O.Bad=3]="Bad",D=S=>S<=100?L.Good:S<=250?L.Average:L.Bad,F=(new Map).set(L.Bad,"pingr").set(L.Average,"pingy").set(L.Good,"pingg"),_=(new Map).set(L.Bad,"ping-bad").set(L.Average,"ping-avg").set(L.Good,"ping-good"),S("ServerPingIndicator",({ping:S,strings:O})=>{var L=D(S);return B.default.createElement("div",{className:"server-ping"},B.default.createElement("span",{className:N.default("ping-text",_.get(L))},O.get("TS:PingValue",S)),B.default.createElement(j.Image,{src:F.get(L)+".pcx"}))})}}}),System.register("gui/screen/mainMenu/login/ServerPings",["@puzzl/core/lib/async/cancellation","network/WolConnection"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("ServerPings",j=class e{constructor(S,O){this.regions=S,this.wolLogger=O,this.pings=new Map}async update(S,O){await Promise.all(this.regions.getAll().filter(S=>S.available).map(async j=>{let L,D=N.WolConnection.factory(this.wolLogger);try{await D.connect(j.wolUrl,{timeoutSeconds:e.CONNECT_TIMEOUT,cancelToken:O})}catch(L){return L instanceof B.OperationCanceledError||(console.error(L),D.close(),this.pings.set(j,void 0)),void S?.()}try{L=await D.ping(5)}catch(L){console.error(L)}finally{D.close()}O?.isCancelled()||(this.pings.set(j,L),S?.())}))}}),j.CONNECT_TIMEOUT=5}}}),System.register("gui/screen/mainMenu/main/HomeScreen",["gui/screen/mainMenu/ScreenType","gui/FullScreen","engine/sound/Music","gui/screen/options/component/getHumanReadableKey","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/MainMenuRoute"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=class extends D.MainMenuScreen{constructor(S,O,B,N,L){super(),this.strings=S,this.fullScreen=O,this.appVersion=B,this.storageEnabled=N,this.quickMatchEnabled=L,this.title=this.strings.get("GUI:MainMenu"),this.musicType=j.MusicType.Intro}onEnter(){let S=this.strings;this.controller.setSidebarButtons([{label:S.get("GUI:QuickMatch"),tooltip:S.get("STT:WOLWelcomeQuickMatch"),disabled:!this.quickMatchEnabled,onClick:()=>{this.controller?.goToScreen(B.ScreenType.Login,{afterLogin:S=>new F.MainMenuRoute(B.ScreenType.QuickGame,{messages:S})})}},{label:S.get("GUI:CustomMatch"),tooltip:S.get("STT:WOLWelcomeCustomMatch"),onClick:()=>{this.controller?.goToScreen(B.ScreenType.Login,{afterLogin:S=>new F.MainMenuRoute(B.ScreenType.CustomGame,{messages:S})})}},{label:S.get("GUI:Demo"),tooltip:S.get("STT:Demo"),onClick:()=>{this.controller?.goToScreen(B.ScreenType.Skirmish)}},{label:S.get("GUI:Replays"),tooltip:S.get("STT:Replays"),onClick:()=>{this.controller?.pushScreen(B.ScreenType.ReplaySelection)}},...this.storageEnabled?[{label:S.get("GUI:Mods"),tooltip:S.get("STT:Mods"),onClick:()=>{this.controller?.pushScreen(B.ScreenType.ModSelection)}}]:[],{label:S.get("TS:InfoAndCredits"),tooltip:S.get("STT:InfoAndCredits"),onClick:()=>{this.controller?.pushScreen(B.ScreenType.InfoAndCredits)}},{label:S.get("GUI:Options"),tooltip:S.get("STT:MainButtonOptions"),onClick:()=>{this.controller?.pushScreen(B.ScreenType.Options)}},{label:S.get("GUI:Fullscreen",L.getHumanReadableKey(N.FullScreen.hotKey)),tooltip:S.get("STT:Fullscreen"),isBottom:!0,disabled:!this.fullScreen.isAvailable(),onClick:()=>this.fullScreen.toggle()}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!0),this.controller.showVersion(this.appVersion)}async onLeave(){this.controller.hideVersion(),await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},S("HomeScreen",_)}}}),System.register("gui/screen/mainMenu/main/ReportBug",["react"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ReportBug",({strings:S,discordUrl:O})=>B.createElement("div",null,S.get("TS:ReportBugDesc"),B.createElement("br",null),B.createElement("br",null),B.createElement("a",{target:"_blank",href:O},O)))}}}),System.register("gui/screen/mainMenu/mapSel/MapSelScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/mapSel/component/MapSel","gui/screen/mainMenu/lobby/MapPreviewRenderer","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/MainMenuScreen","game/ini/GameModeType","LocalPrefs","data/MapFile","data/vfs/VirtualFile","engine/MapSupport","data/vfs/IOError","data/vfs/StorageQuotaError","data/vfs/FileNotFoundError","engine/Engine","util/disposable/CompositeDisposable","engine/ResourceLoader","engine/MapManifest","data/vfs/NameNotAllowedError"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S}],execute:function(){ee=class extends _.MainMenuScreen{constructor(S,O,B,N,j,L,D,F,_,U,V){super(),this.strings=S,this.jsxRenderer=O,this.mapFileLoader=B,this.errorHandler=N,this.messageBoxApi=j,this.localPrefs=L,this.mapList=D,this.gameModes=F,this.mapDir=_,this.fsAccessLib=U,this.sentry=V,this.title=this.strings.get("GUI:ChooseMap"),this.disposables=new Z.CompositeDisposable,this.handleSelectMap=(S,O)=>{var B=this.selectedMapName!==S;this.selectedMapName=S,this.refreshMapInfo(),B&&(this.updateMapDeferred({updatePreview:!O}),this.initSidebar()),this.form.applyOptions(O=>O.selectedMapName=S),O&&this.handleSubmit()},this.handleSelectGameMode=S=>{this.selectedGameMode=S;let O=this.computeAvailableMaps();O.find(S=>S.mapName===this.selectedMapName)||this.handleSelectMap(O[0].mapName,!1),this.refreshMapInfo(),this.form.applyOptions(B=>{B.selectedGameMode=S,B.maps=O})},this.handleSelectSort=S=>{this.localPrefs.setItem(H.StorageKey.LastSortMap,S)}}onEnter({gameOpts:S,usedSlots:O,lobbyType:B}){this.updateMapsAndModes(),this.selectedGameMode=this.availableGameModes.find(O=>O.id===S.gameMode),this.selectedMapName=S.mapName,this.lobbyType=B,this.computeUsedSlots=O,this.initSidebar(),this.initForm()}updateMapsAndModes(){let S=this.gameModes.getAll().filter(S=>this.mapList.getAll().find(O=>O.gameModes.some(O=>O.id===S.id)));var O=this.mapList.getAll().map(S=>({mapName:S.fileName,mapTitle:S.getFullMapTitle(this.strings),maxSlots:S.maxSlots,gameModes:S.gameModes}));this.availableGameModes=S.filter(S=>S.type!==U.GameModeType.Cooperative).sort((S,O)=>S.id-O.id),this.allMaps=O}initForm(){this.controller.setMainComponent(this.jsxRenderer.render(B.jsx(N.HtmlView,{innerRef:S=>this.form=S,component:j.MapSel,props:{strings:this.strings,maps:this.computeAvailableMaps(),gameModes:this.availableGameModes,selectedMapName:this.selectedMapName,selectedGameMode:this.selectedGameMode,initialSortType:this.readInitialSort(),onSelectMap:this.handleSelectMap,onSelectGameMode:this.handleSelectGameMode,onSelectSort:this.handleSelectSort}}))[0])}readInitialSort(){let S=this.localPrefs.getItem(H.StorageKey.LastSortMap);return S&&Object.values(j.SortType).includes(S)||(S=j.SortType.None),S}initSidebar(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:UseMap"),tooltip:this.strings.get("STT:ScenarioButtonUseMap"),onClick:()=>{this.handleSubmit()}},...this.mapDir?[{label:this.strings.get("TS:ImportMap"),tooltip:this.strings.get("STT:ImportMap"),onClick:async()=>{let S=new F.CancellationTokenSource;var t=()=>S.cancel();this.disposables.add(t);try{await this.importMap(S.token)}catch(S){return void(S instanceof F.OperationCanceledError||this.handleMapImportError(S))}finally{this.disposables.remove(t)}}}]:[],{label:this.strings.get("GUI:Cancel"),tooltip:this.strings.get("STT:ScenarioButtonCancel"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}],!0),this.refreshMapInfo(),this.controller.showSidebarButtons()}async importMap(S){let O;try{var B=await this.fsAccessLib.showOpenFilePicker({types:[{description:"RA2 Map",accept:{"text/plain":Q.Engine.supportedMapTypes.map(S=>"."+S)}}],excludeAcceptAllOption:!0});let S=Array.isArray(B)?B[0]:B;O=await S.getFile()}catch(S){if("AbortError"===S.name)return;if(S instanceof DOMException)throw new K.IOError(`File could not be read (${S.name})`,{cause:S});throw S}if(Q.Engine.supportedMapTypes.some(S=>O.name.toLowerCase().endsWith("."+S)))if(this.mapList.getByName(O.name))await this.messageBoxApi.alert(this.strings.get("TS:ImportMapDuplicateError",O.name),this.strings.get("GUI:Ok"));else{let j,L;B=await W.VirtualFile.fromRealFile(O);try{j=new V.MapFile(B);var N=z.MapSupport.check(j,this.strings);if(N)return void await this.messageBoxApi.alert(N,this.strings.get("GUI:Ok"));L=(new X.MapManifest).fromMapFile(B,this.gameModes.getAll())}catch(S){return console.error(S),void await this.messageBoxApi.alert(this.strings.get("TXT_MAP_ERROR"),this.strings.get("GUI:Ok"))}if((j.unknownActionTypes.size||j.unknownEventTypes.size)&&!await this.messageBoxApi.confirm(this.strings.get("TS:MapUnsupportedTriggers"),this.strings.get("GUI:Continue"),this.strings.get("GUI:Cancel")))return;let D=L.gameModes;D.length?(await this.mapDir.writeFile(B),this.mapList.add(L),S.throwIfCancelled(),this.updateMapsAndModes(),this.form.applyOptions(S=>{S.gameModes=this.availableGameModes,S.maps=this.computeAvailableMaps()}),D.some(S=>this.selectedGameMode.id===S.id)||this.handleSelectGameMode(D[0]),this.handleSelectMap(B.filename,!1)):await this.messageBoxApi.alert(this.strings.get("TS:MapUnsupportedGameMode"),this.strings.get("GUI:Ok"))}else await this.messageBoxApi.alert(this.strings.get("TS:ImportMapUnsupportedType",Q.Engine.supportedMapTypes.map(S=>"*."+S).join(", ")),this.strings.get("GUI:Ok"))}handleMapImportError(S){let O=this.strings,B=O.get("TS:ImportMapError");"QuotaExceededError"===S.name||S instanceof $.StorageQuotaError?B+="\n\n"+O.get("ts:storage_quota_exceeded"):S instanceof J.NameNotAllowedError?B+="\n\n"+O.get("TS:FileNameError"):S instanceof K.IOError||S instanceof q.FileNotFoundError||this.sentry?.captureException(new Error("Map import failed "+(S.message??S.name),{cause:S})),this.errorHandler.handle(S,B,()=>{})}async handleSubmit(){let S=new F.CancellationTokenSource;var t=()=>S.cancel();this.disposables.add(t);try{await this.submitMap(S.token)}catch(S){if(!(S instanceof F.OperationCanceledError))throw S}finally{this.disposables.remove(t)}}async submitMap(S){let O,B=!1;if(this.mapFileUpdateTask){this.form.hide(),this.controller?.hideSidebarButtons(),B=!0;try{await this.mapFileUpdateTask.wait()}catch(S){}}if(S.throwIfCancelled(),this.changedMapFile)try{var N=new V.MapFile(this.changedMapFile),j=z.MapSupport.check(N,this.strings);if(j)return void await this.messageBoxApi.alert(j,this.strings.get("GUI:Ok"))}catch(S){return console.error(S),await this.messageBoxApi.alert(this.strings.get("TXT_MAP_ERROR"),this.strings.get("GUI:Ok")),void(B&&(this.form.show(),this.controller?.showSidebarButtons()))}O=!(this.computeUsedSlots()>this.allMaps.find(S=>S.mapName===this.selectedMapName).maxSlots)||await this.messageBoxApi.confirm(this.strings.get("GUI:EjectPlayers"),this.strings.get("GUI:Ok"),this.strings.get("GUI:Cancel")),S.throwIfCancelled(),O?await(this.controller?.popScreen({gameMode:this.selectedGameMode,mapName:this.selectedMapName,changedMapFile:this.changedMapFile})):B&&(this.form.show(),this.controller?.showSidebarButtons())}computeAvailableMaps(){return this.allMaps.filter(S=>S.gameModes.some(S=>S.id===this.selectedGameMode.id))}refreshMapInfo(){this.controller?.setSidebarMpContent({text:this.strings.get(this.selectedGameMode.label)+"\n\n"+this.allMaps.find(S=>S.mapName===this.selectedMapName)?.mapTitle})}async onLeave(){this.computeUsedSlots=void 0,this.availableGameModes=void 0,this.allMaps=void 0,this.messageBoxApi.destroy(),this.form=void 0,this.mapFileUpdateTask?.cancel(),this.mapFileUpdateTask=void 0,this.controller.setMainComponent(),this.disposables.dispose(),await this.controller.hideSidebarButtons()}updateMapDeferred({updatePreview:S}){this.mapFileUpdateTask?.cancel(),this.mapFileUpdateTask=new D.Task(async O=>{if(this.controller){let N;S&&this.controller.setSidebarPreview(),this.changedMapFile=void 0;try{N=this.changedMapFile=await this.mapFileLoader.load(this.selectedMapName,O)}catch(S){if(S instanceof Y.DownloadError)return void this.errorHandler.handle(S,this.strings.get("TXT_DOWNLOAD_FAILED"),()=>{this.controller?.popScreen()});throw S}var B;S&&!O.isCancelled()&&(B=new L.MapPreviewRenderer(this.strings).render(new V.MapFile(N),this.lobbyType,this.controller.getSidebarPreviewSize()),this.controller.setSidebarPreview(B)),this.mapFileUpdateTask=void 0}}),this.mapFileUpdateTask.start().catch(S=>{S instanceof F.OperationCanceledError||(console.error("Failed to render map preview"),console.error(S))})}},S("MapSelScreen",ee)}}}),System.register("gui/screen/mainMenu/mapSel/component/MapSel",["react","gui/component/List","gui/component/Select","gui/component/Option"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){var O;(O=D||S("SortType",D={})).None="",O.NameAsc="nameAsc",O.NameDesc="nameDesc",O.MaxSlotsAsc="maxSlotsAsc",O.MaxSlotsDesc="maxSlotsDesc",F=(S,O)=>{switch(O){case D.None:return S;case D.NameAsc:return S.sort((S,O)=>S.mapTitle.localeCompare(O.mapTitle));case D.NameDesc:return S.sort((S,O)=>O.mapTitle.localeCompare(S.mapTitle));case D.MaxSlotsAsc:return S.sort((S,O)=>S.maxSlots-O.maxSlots);case D.MaxSlotsDesc:return S.sort((S,O)=>O.maxSlots-S.maxSlots);default:throw new Error(`Unsupported sort type "${O}"`)}},S("MapSel",({strings:S,gameModes:O,maps:_,selectedGameMode:U,selectedMapName:H,initialSortType:V,onSelectGameMode:W,onSelectMap:z,onSelectSort:K})=>{const $=B.useRef(null),[q,Q]=B.useState(_),[Z,Y]=B.useState(""),[X,J]=B.useState(V);B.useEffect(()=>{w()},[_,Z,X]),B.useEffect(()=>{let S=setTimeout(()=>$.current?.scrollIntoView(),50);return()=>clearTimeout(S)},[_]);const w=()=>{Q(F(_.filter(S=>S.mapTitle.toLowerCase().includes(Z.toLowerCase())),X))};return B.default.createElement("div",{className:"map-sel-form"},B.default.createElement("div",{className:"map-sel-title"},S.get("GUI:SelectEngagement")),B.default.createElement("div",{className:"map-sel-body"},B.default.createElement("div",{className:"map-sel-game-mode"},B.default.createElement(N.List,{title:S.get("GUI:GameType"),className:"game-mode-list",tooltip:S.get("STT:ScenarioListGameType")},O.map(O=>B.default.createElement(N.ListItem,{key:O.id,selected:U===O,onClick:()=>W(O),"data-r-tooltip":S.get(O.description)},S.get(O.label))))),B.default.createElement("div",{className:"map-sel-map"},B.default.createElement(N.List,{title:B.default.createElement("div",{className:"map-list-title"},B.default.createElement("div",null,S.get("GUI:GameMap")),B.default.createElement("div",{className:"map-list-sort","data-r-tooltip":S.get("STT:SortBy")},B.default.createElement("label",null,""),B.default.createElement(j.Select,{initialValue:X,onSelect:S=>(S=>{J(S),K(S)})(S),className:"map-list-sort-select"},B.default.createElement(L.Option,{value:D.None,label:S.get("TS:SortNone")}),B.default.createElement(L.Option,{value:D.NameAsc,label:S.get("TS:SortName")+" "}),B.default.createElement(L.Option,{value:D.NameDesc,label:S.get("TS:SortName")+" "}),B.default.createElement(L.Option,{value:D.MaxSlotsAsc,label:S.get("TS:SortMaxSlots")+" "}),B.default.createElement(L.Option,{value:D.MaxSlotsDesc,label:S.get("TS:SortMaxSlots")+" "})))),className:"map-list",tooltip:S.get("STT:ScenarioListMaps")},q.map(S=>{var O=S.mapName===H;return B.default.createElement(N.ListItem,{key:S.mapName,selected:O,innerRef:O?$:null,onClick:()=>z(S.mapName,!1),onDoubleClick:()=>z(S.mapName,!0)},S.mapTitle)})),B.default.createElement("div",{className:"map-sel-search"},B.default.createElement("label",null,B.default.createElement("span",null,S.get("GUI:Search")),B.default.createElement("input",{type:"text",className:"new-message",value:Z,onChange:S=>{var O=S.target.value;Y(O)}}))))))})}}}),System.register("gui/screen/mainMenu/modSel/BadModArchiveError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends Error{},S("BadModArchiveError",B)}}}),System.register("gui/screen/mainMenu/modSel/DuplicateModError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=class extends Error{},S("DuplicateModError",B)}}}),System.register("gui/screen/mainMenu/modSel/Mod",["gui/screen/mainMenu/modSel/ModStatus"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("Mod",class{get id(){return this.meta.id}get name(){return this.meta.name}get supported(){return this.meta.supported}constructor(S,O){if(S)O&&O.version!==S.version?(this.status=B.ModStatus.UpdateAvailable,this.meta=S.clone(),this.meta.download=O.download,this.meta.downloadSize=O.downloadSize,this.meta.manualDownload=O.manualDownload,this.latestVersion=O.version):(this.status=B.ModStatus.Installed,this.meta=S,this.latestVersion=S.version);else{if(this.status=B.ModStatus.NotInstalled,!O)throw new Error("At least a local or remote meta must be specified");this.meta=O,this.latestVersion=O.version}}isInstalled(){return this.status!==B.ModStatus.NotInstalled}})}}}),System.register("gui/screen/mainMenu/modSel/ModDetailsPane",["react","gui/screen/mainMenu/modSel/ModStatus"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=new Map([[N.ModStatus.Installed,"GUI:ModStatusInstalled"],[N.ModStatus.UpdateAvailable,"GUI:ModStatusUpdateAvail"],[N.ModStatus.NotInstalled,"GUI:ModStatusNotInstalled"]]),S("ModDetailsPane",({modDetails:{supported:S,name:O,description:N,authors:L,version:D,website:F},modLoaded:_,modStatus:U,strings:H})=>B.createElement("div",{className:"mod-details"},B.createElement("table",null,B.createElement("tbody",null,B.createElement("tr",null,B.createElement("td",null,H.get("GUI:ModName"),":"),B.createElement("td",null,O)),B.createElement("tr",null,B.createElement("td",null,H.get("GUI:ModStatus"),":"),B.createElement("td",null,H.get(j.get(U)??"GUI:Unknown"),_?", "+H.get("GUI:ModLoaded"):"",S?"":", "+H.get("GUI:ModUnsupported"))),D&&B.createElement("tr",null,B.createElement("td",null,H.get("GUI:ModVersion"),":"),B.createElement("td",null,D)),N&&B.createElement("tr",null,B.createElement("td",null,H.get("GUI:ModDescription"),":"),B.createElement("td",{className:"mod-desc"},N)),L&&B.createElement("tr",null,B.createElement("td",null,H.get("GUI:ModAuthor"),":"),B.createElement("td",null,L.join(", "))),F&&B.createElement("tr",null,B.createElement("td",null,H.get("GUI:ModWebsite"),":"),B.createElement("td",null,B.createElement("a",{href:F,rel:"nofollow noopener",target:"_blank"},F)))))))}}}),System.register("gui/screen/mainMenu/modSel/ModDownloadPrompt",["react"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ModDownloadPrompt",({url:S,sizeMb:O,isUpdate:N,strings:j,onClick:L})=>B.createElement("div",null,N&&B.createElement("p",{style:{marginTop:0}},j.get("GUI:ModUpdateAvail")),B.createElement("p",null,j.get("GUI:ManualDownloadModPrompt")),B.createElement("a",{href:S,rel:"nofollow noopener",target:"_blank",onClick:L},S),B.createElement("br",null),B.createElement("br",null),B.createElement("em",null,j.get("ts:gameres_download_size",O))))}}}),System.register("gui/screen/mainMenu/modSel/ModImporter",["util/time","data/vfs/IOError","engine/gameRes/importError/ArchiveExtractionError","engine/gameRes/importError/InvalidArchiveError","gui/screen/mainMenu/modSel/ModManager","gui/screen/mainMenu/modSel/ModMeta","gui/screen/mainMenu/modSel/BadModArchiveError","data/IniFile","gui/screen/mainMenu/modSel/DuplicateModError","data/vfs/VirtualFile"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){S("ModImporter",W=class e{constructor(S,O,B){this.strings=S,this.messageBoxApi=O,this.storage=B}async import(S,O,V,W){let z,K,$,q=this.strings;try{let S=await SystemJS.import("7z-wasm");$=await S({quit:(S,O)=>{z=S,K=O}})}catch(S){if(S instanceof WebAssembly.RuntimeError)throw new N.IOError("Couldn't load 7z-wasm",{cause:S});throw S}W(q.get("ts:import_loading_archive")),$.FS.chdir("/tmp");var Q=S.name;try{var Z=await S.arrayBuffer(),Y=$.FS.open(Q,"w+");$.FS.write(Y,new Uint8Array(Z),0,Z.byteLength,0,!0),$.FS.close(Y)}catch(S){if(S instanceof DOMException)throw new N.IOError(`File "${Q}" could not be read (${S.name})`,{cause:S});throw S}if(W(q.get("ts:import_extracting_archive")),await B.sleep(100),$.callMain(["x","-ssc-","-x!*/",Q,"*.*"]),z){if(1!==z)throw new L.InvalidArchiveError("7-Zip exited with code "+z,{cause:K});if(K?.message?.match(/out of memory|allocation/i))throw new RangeError("Out of memory",{cause:K});throw new j.ArchiveExtractionError("Archive extraction failed with code "+z,{cause:K})}$.FS.unlink(Q);let X=$.FS.lookupPath($.FS.cwd()).node,J=Object.keys(X.contents),ee=new F.ModMeta;var te;Y=()=>{for(var S of(({node:X}=$.FS.lookupPath($.FS.cwd())),J=Object.keys(X.contents),J))$.FS.unlink(S)};let ie=0;for(te of J)ie+=$.FS.stat(te).size;if(this.storage?.estimate&&(Q=await this.storage.estimate().catch(S=>{console.warn("Couldn't get storage estimate",[S])}),Q?.quota&&Q.usage&&(Q=Q.quota-Q.usage)<ie+1048576))return await this.messageBoxApi.alert(q.get("GUI:InstallModStorageFull",Q/1024/1024,ie/1024/1024),q.get("GUI:OK")),void Y();try{let B,N=await O.listEntries();if(J.includes(D.ModManager.modMetaFileName)){let O=this.readFileFromEmFs($.FS,D.ModManager.modMetaFileName);try{ee.fromIniFile(new U.IniFile(O.readAsString("utf-8")))}catch(S){throw new _.BadModArchiveError("Mod meta file is invalid")}if(B=ee.id,!V&&N.find(S=>S.toLowerCase()===B))throw new H.DuplicateModError(`A mod with the id "${ee.id}" already exists`)}else{if(!J.some(S=>e.modFileExtensions.includes(X.contents[S].name.toLowerCase().split(".").pop())))throw new _.BadModArchiveError("Archive doesn't contain a valid mod");if(!await this.messageBoxApi.confirm(this.strings.get("GUI:ImportModUnsupportedWarn"),this.strings.get("GUI:Continue"),this.strings.get("GUI:Cancel")))return void Y();if(B=await this.promptFolderName(N),!B)return void Y();ee.id=B,ee.name=B}let j=await O.getOrCreateDirectory(B);for await(var re of j.getFileHandles())await j.deleteFile(re.name);for(var se of J){W(q.get("ts:import_importing",se));try{var ne=this.readFileFromEmFs($.FS,se);await j.writeFile(ne)}catch(S){throw await O.deleteDirectory(j.name,!0),S}finally{$.FS.unlink(se)}}}finally{Y()}return ee}async promptFolderName(S){let O,B=this.strings;for(;;){if(O=await this.messageBoxApi.prompt(B.get("GUI:ImportModFolderPrompt"),B.get("GUI:Ok"),B.get("GUI:Cancel")),!O)return;if(O.match(D.ModManager.modIdRegex)){if(!S.some(S=>S.toLowerCase()===O))break;await this.messageBoxApi.alert(B.get("GUI:ImportModFolderExists"),B.get("GUI:Ok"))}else await this.messageBoxApi.alert(B.get("GUI:ImportModFolderBadName"),B.get("GUI:Ok"))}return O}readFileFromEmFs(S,O){S.chmod(O,448);let B=S.lookupPath(O).node;var N=B.contents.subarray(0,B.usedBytes);return V.VirtualFile.fromBytes(N,O.slice(O.lastIndexOf("/")+1))}}),W.modFileExtensions=["ini","mix"]}}}),System.register("gui/screen/mainMenu/modSel/ModManager",["data/IniFile","RouteHelper","gui/screen/mainMenu/modSel/Mod","gui/screen/mainMenu/modSel/ModMeta"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("ModManager",D=class e{constructor(S,O,B){this.location=S,this.modDir=O,this.appResourceLoader=B}getModDir(){return this.modDir}async buildModList(S,O){let B=[];O=[...O??[]];for(let L of S){var N=O.findIndex(S=>S.id===L.id);N=-1!==N?O.splice(N,1)[0]:void 0,B.push(new j.Mod(L,N))}for(var L of O)B.push(new j.Mod(void 0,L));return B}async listRemote(){var S,O=await this.appResourceLoader.loadText(e.remoteListFileName);let N=new B.IniFile(O),j=N.getSection("General");if(!j)throw new Error(e.remoteListFileName+" is missing the [General] section");let D=[];for(S of j.entries.values()){var F=N.getSection(S);F?(F=(new L.ModMeta).fromIniSection(F),D.push(F)):console.warn(`Mod "${S}" has no INI section`)}return D}async listLocal(){let S=[];if(this.modDir)for await(var O of this.modDir.getEntries())O=await this.loadModMeta(O),S.push(O);return S.sort((S,O)=>S.name.localeCompare(O.name)),S}async loadModMeta(S){let O=new L.ModMeta;O.id=S,O.name=S;try{let N=await this.modDir.getDirectory(S,!0),j=await N.containsEntry(e.modMetaFileName)?await N.getRawFile(e.modMetaFileName):void 0;if(j){try{O.fromIniFile(new B.IniFile(await j.text()))}catch(B){console.warn(`Couldn't parse meta file in mod folder "${S}"`),O.name=S}O.id=S}}catch(S){console.warn(S)}return O}async deleteModFiles(S){await(this.modDir?.containsEntry(S))&&await this.modDir.deleteDirectory(S,!0)}loadMod(S){let O=new URL(this.location.href);S?O.searchParams.set(N.RouteHelper.modQueryStringName,S):O.searchParams.delete(N.RouteHelper.modQueryStringName),this.location.href=O.href}}),D.remoteListFileName="mods.ini",D.modMetaFileName="modcd.ini",D.modIdRegex=/^[a-z0-9-_]+$/i}}}),System.register("gui/screen/mainMenu/modSel/ModMeta",["gui/screen/mainMenu/modSel/ModManager"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("ModMeta",class e{constructor(){this.supported=!1,this.manualDownload=!1}fromIniFile(S){var O=S.getSection("General");if(!O)throw new Error("Mod meta missing [General] section");return this.fromIniSection(O),this}fromIniSection(S){let O=S.getString("ID");var N=S.getString("Name");if(!O)throw new Error("Mod meta missing ID");if(!O.match(B.ModManager.modIdRegex))throw new Error(`Mod meta has invalid ID "${O}". ID must contain only alphanumeric characters, dash (-) or underscore (_)`);if(!N)throw new Error("Mod meta missing Name");this.id=O,this.name=N,this.supported=!0,this.description=S.getString("Description")||void 0,(N=S.get("Author"))&&(this.authors=Array.isArray(N)?N:[N]);let j=S.getString("Website");return j&&(j.match(/^https?:\/\//)?this.website=j:console.warn(`Invalid mod meta website "${j}"`)),this.version=S.getString("Version")||void 0,this.download=S.getString("Download")||void 0,this.downloadSize=S.getNumber("DownloadSize")||void 0,this.manualDownload=S.getBool("ManualDownload"),this}clone(){let S=new e;return S.id=this.id,S.name=this.name,S.supported=this.supported,S.description=this.description,S.authors=this.authors?.slice(),S.website=this.website,S.version=this.version,S.download=this.download,S.downloadSize=this.downloadSize,S.manualDownload=this.manualDownload,S}})}}}),System.register("gui/screen/mainMenu/modSel/ModSel",["react","gui/component/List","gui/screen/mainMenu/modSel/ModDetailsPane"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("ModSel",({strings:S,mods:O,activeMod:L,selectedMod:D,onSelectMod:F})=>{const _=B.useRef(null);return B.useEffect(()=>{_.current?.scrollIntoView()},[]),B.default.createElement("div",{className:"mod-sel-form"},B.default.createElement(N.List,{title:S.get("GUI:SelectMod"),className:"mod-list"},O?O.map(O=>{var j=O.id===D?.id;return B.default.createElement(N.ListItem,{key:O.id,selected:j,innerRef:j?_:null,onClick:()=>F(O),onDoubleClick:()=>F(O,!0),style:{display:"flex"}},B.default.createElement("div",{className:"mod-name"},(O===L?" ":"")+O.name+(O.supported?"":` (${S.get("GUI:ModUnsupported").toUpperCase()})`)))}):B.default.createElement(N.ListItem,{style:{textAlign:"center"}},S.get("GUI:LoadingEx"))),D&&B.default.createElement(j.ModDetailsPane,{modLoaded:L===D,modStatus:D.status,modDetails:D.meta,strings:S}))})}}}),System.register("gui/screen/mainMenu/modSel/ModSelScreen",["react","gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/ScreenType","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","data/vfs/StorageQuotaError","gui/screen/mainMenu/MainMenuScreen","data/vfs/IOError","data/vfs/FileNotFoundError","gui/screen/mainMenu/modSel/ModSel","engine/Engine","engine/gameRes/FileSystemUtil","gui/screen/mainMenu/modSel/ModImporter","engine/gameRes/importError/InvalidArchiveError","engine/gameRes/importError/ArchiveExtractionError","gui/screen/mainMenu/modSel/BadModArchiveError","gui/screen/mainMenu/modSel/DuplicateModError","gui/screen/mainMenu/modSel/Mod","gui/screen/mainMenu/modSel/ModStatus","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/modSel/ModDownloadPrompt"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S}],execute:function(){ie=class extends U.MainMenuScreen{constructor(S,O,B,N,j,L,D,_,U,H,V){super(),this.rootController=S,this.strings=O,this.jsxRenderer=B,this.errorHandler=N,this.messageBoxApi=j,this.modManager=L,this.activeModId=D,this.modSdkUrl=_,this.modResourceLoader=U,this.fsAccessLib=H,this.sentry=V,this.title=this.strings.get("GUI:Mods"),this.disposables=new F.CompositeDisposable,this.handleSelectMod=async(S,O)=>{var B=this.selectedMod?.id!==S.id;this.selectedMod=S,B&&this.updateSidebarButtons(),this.form?.applyOptions(O=>{O.selectedMod=S}),O&&S!==this.activeMod&&S.status===J.ModStatus.Installed&&await this.loadOrUnloadMod(S)}}async onEnter(){this.availableMods=[],this.controller.toggleMainVideo(!1),this.initForm();var S=await this.loadAvailableMods();S&&(this.availableMods=S,this.activeMod=this.availableMods.find(S=>S.id===this.activeModId),this.selectedMod=this.activeMod,this.form.applyOptions(S=>{S.mods=this.availableMods,S.activeMod=this.activeMod,S.selectedMod=this.selectedMod}),this.initSidebar())}async loadAvailableMods(){try{var[S,O]=await Promise.all([this.modManager.listLocal(),this.modManager.listRemote().catch(S=>{console.warn("Failed to fetch remote mods",[S])})]);return await this.modManager.buildModList(S,O)}catch(S){return S instanceof H.IOError||S instanceof V.FileNotFoundError||S instanceof _.StorageQuotaError||this.sentry?.captureException(new Error(`Failed to load mod list (${S.name??S.message})`,{cause:S})),void this.handleError(S,this.strings.get("GUI:ModListError"))}}initForm(){this.controller.setMainComponent(this.jsxRenderer.render(N.jsx(j.HtmlView,{innerRef:S=>this.form=S,component:W.ModSel,props:{strings:this.strings,mods:void 0,activeMod:void 0,selectedMod:void 0,onSelectMod:this.handleSelectMod}}))[0])}initSidebar(){this.updateSidebarButtons(),this.controller.showSidebarButtons()}updateSidebarButtons(){this.controller?.setSidebarButtons([{label:this.selectedMod&&this.selectedMod===this.activeMod?this.strings.get("GUI:UnloadMod"):this.selectedMod?.isInstalled()?this.strings.get("GUI:LoadMod"):this.strings.get("GUI:ModActionInstall"),disabled:!this.selectedMod,onClick:async()=>{var S=this.selectedMod;if(S.status===J.ModStatus.Installed||S===this.activeMod)await this.loadOrUnloadMod(S);else{var O=(S.meta.downloadSize||0)/1024/1024;if(S.meta.manualDownload){var N=S.status===J.ModStatus.UpdateAvailable,j=B.createElement(te.ModDownloadPrompt,{url:S.meta.download,sizeMb:O,isUpdate:N,strings:this.strings,onClick:()=>this.messageBoxApi.destroy()});N?await this.messageBoxApi.confirm(j,this.strings.get("GUI:Close"),this.strings.get("GUI:ModActionLoadAnyway"))||await this.loadOrUnloadMod(S):this.messageBoxApi.show(j,this.strings.get("GUI:Close"),()=>{})}else{let B,j=!1;if(S.status===J.ModStatus.UpdateAvailable){if(!await this.messageBoxApi.confirm(this.strings.get("GUI:ModUpdateAvail")+"\n\n"+this.strings.get("GUI:UpdateModPrompt",S.latestVersion,O),this.strings.get("GUI:ModActionUpdate"),this.strings.get("GUI:ModActionLoadAnyway")))return void await this.loadOrUnloadMod(S);j=!0}else if(10<O&&!await this.messageBoxApi.confirm(this.strings.get("GUI:InstallModDownloadPrompt",O),this.strings.get("GUI:Continue"),this.strings.get("GUI:Cancel")))return;try{B=await this.downloadMod(S)}catch(N){return N instanceof ee.OperationCanceledError?void 0:void this.errorHandler.handle(N,this.strings.get("GUI:DownloadFailed"),()=>{})}this.messageBoxApi.destroy();try{await this.importModFromFile(B,S.status===J.ModStatus.UpdateAvailable)}catch(N){return void this.handleModImportError(N)}j&&await this.loadOrUnloadMod(S)}}}},{label:this.strings.get("GUI:ImportMod"),tooltip:this.strings.get("STT:ImportMod"),onClick:async()=>{try{let S;try{let O=await K.FileSystemUtil.showArchivePicker(this.fsAccessLib);S=await O.getFile()}catch(S){if("AbortError"===S.name)return;if(S instanceof DOMException)throw new H.IOError(`File could not be read (${S.name})`,{cause:S});throw S}await this.importModFromFile(S,!1)}catch(S){return void this.handleModImportError(S)}}},{label:this.strings.get("GUI:UninstallMod"),tooltip:this.strings.get("STT:UninstallMod"),disabled:!(this.selectedMod?.isInstalled()&&this.activeMod!==this.selectedMod),onClick:async()=>{var S=this.selectedMod;if(await this.messageBoxApi.confirm(this.strings.get("GUI:ConfirmUninstallMod",S.name),this.strings.get("GUI:Ok"),this.strings.get("GUI:Cancel"))){this.messageBoxApi.show(this.strings.get("GUI:WorkingPleaseWait"));try{await this.modManager.deleteModFiles(S.id)}catch(S){var O=S instanceof _.StorageQuotaError?this.strings.get("ts:storage_quota_exceeded"):this.strings.get("GUI:UninstallModError");return void this.errorHandler.handle(S,O,()=>{})}finally{this.messageBoxApi.destroy()}(O=await this.loadAvailableMods())&&(this.availableMods=O,this.selectedMod=void 0,this.form?.applyOptions(S=>{S.mods=this.availableMods,S.selectedMod=void 0}),this.updateSidebarButtons())}}},{label:this.strings.get("GUI:BrowseMod"),tooltip:this.strings.get("STT:BrowseMod"),onClick:()=>{this.controller?.pushScreen(D.ScreenType.OptionsStorage,{startIn:z.Engine.rfsSettings.modDir+(this.selectedMod?.isInstalled()?"/"+this.selectedMod.id:"")})}},...this.modSdkUrl?[{label:this.strings.get("GUI:ModSDK"),tooltip:this.strings.get("STT:ModSDK"),onClick:()=>{window.open(this.modSdkUrl,"_blank")}}]:[],{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}])}async loadOrUnloadMod(S){await(this.controller?.hideSidebarButtons()),this.modManager.loadMod(S!==this.activeMod?S.id:void 0)}async downloadMod(S){var O=S.meta.download;if(!O)throw new Error("Mod meta is missing download");let B=new ee.CancellationTokenSource;this.messageBoxApi.show(this.strings.get("TS:Downloading"),this.strings.get("GUI:Cancel"),()=>B.cancel());var N={id:"archive",src:O,type:"binary",sizeHint:S.meta.downloadSize};let j=await this.modResourceLoader.loadResources([N],B.token,S=>{this.messageBoxApi.updateText(this.strings.get("TS:DownloadingPg",S))});return O=j.pop("archive"),new File([O],this.modResourceLoader.getResourceFileName(N))}async importModFromFile(S,O){this.messageBoxApi.show(this.strings.get("ts:import_preparing_for_import"));var i=S=>{this.messageBoxApi.updateText(S)};let B;try{B=await new $.ModImporter(this.strings,this.messageBoxApi,navigator.storage).import(S,this.modManager.getModDir(),O,i)}finally{this.messageBoxApi.destroy()}if(B){let S=new X.Mod(B,void 0);S&&(-1!==(i=this.availableMods.findIndex(O=>O.id===S.id))?this.availableMods.splice(i,1,S):this.availableMods.unshift(S),this.selectedMod=S,this.form?.applyOptions(O=>{O.mods=this.availableMods,O.selectedMod=S}),this.updateSidebarButtons())}}handleModImportError(S){let O=this.strings,B=O.get("GUI:ImportModError");S instanceof Z.BadModArchiveError?B+="\n\n"+O.get("GUI:ImportModBadArchive"):S instanceof Y.DuplicateModError?B+="\n\n"+O.get("GUI:ImportDuplicateModError"):S instanceof q.InvalidArchiveError?B+="\n\n"+O.get("ts:import_invalid_archive"):S instanceof Q.ArchiveExtractionError?S.cause?.message?.match(/out of memory|allocation/i)?B+="\n\n"+O.get("ts:import_out_of_memory"):B+="\n\n"+O.get("ts:import_archive_extract_failed"):S.message?.match(/out of memory|allocation/i)?B+="\n\n"+O.get("ts:import_out_of_memory"):"QuotaExceededError"===S.name||S instanceof _.StorageQuotaError?B+="\n\n"+O.get("ts:storage_quota_exceeded"):S instanceof H.IOError||S instanceof V.FileNotFoundError||this.sentry?.captureException(new Error("Mod import failed "+(S.message??S.name),{cause:S})),this.errorHandler.handle(S,B,()=>{})}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}async onLeave(){this.availableMods.length=0,this.form=void 0,this.messageBoxApi.destroy(),this.disposables.dispose(),this.controller.setMainComponent(),await this.controller.hideSidebarButtons()}handleError(S,O){this.errorHandler.handle(S,O,()=>{this.rootController.goToScreen(L.ScreenType.MainMenuRoot)})}},S("ModSelScreen",ie)}}}),System.register("gui/screen/mainMenu/modSel/ModStatus",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("ModStatus",B={}))[O.NotInstalled=0]="NotInstalled",O[O.Installed=1]="Installed",O[O.UpdateAvailable=2]="UpdateAvailable"}}}),System.register("gui/screen/mainMenu/newAccount/NewAccountBox",["react","network/WolConfig"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=({regions:S,initialRegion:O,strings:j,onRegionChange:L,onSubmit:D},F)=>{let[_,U]=B.useState(O.id),H=B.useRef(null),V=B.useRef(null),W=B.useRef(null),z=B.useRef(null);B.useEffect(()=>{setTimeout(()=>V.current?.focus(),50)},[]);const p=()=>{D({user:V.current.value,pass:W.current.value,passMatch:W.current.value===z.current.value,regionId:_})};return B.useImperativeHandle(F,()=>({submit(){H.current?.requestSubmit?H.current.requestSubmit():p()}})),B.default.createElement("div",{className:"login-wrapper new-account-box"},B.default.createElement("div",{className:"title"},j.get("GUI:NewAccount")),B.default.createElement("form",{onSubmit:S=>{S.preventDefault(),p()},className:"login-form login-box",ref:H},1<S.length?B.default.createElement("div",{className:"field"},B.default.createElement("label",null,j.get("TS:Region")),B.default.createElement("select",{name:"server",value:_,onChange:S=>{var O=S.target.value;U(O),L(O)}},S.map(S=>B.default.createElement("option",{value:S.id,key:S.id,disabled:!S.available},S.label)))):B.default.createElement("input",{type:"hidden",name:"server",value:_}),B.default.createElement("div",{className:"field"},B.default.createElement("label",null,j.get("GUI:Nickname")),B.default.createElement("input",{name:"user",type:"text",required:!0,minLength:N.MIN_USERNAME_LEN,maxLength:N.MAX_USERNAME_LEN,ref:V,autoComplete:"off"})),B.default.createElement("div",{className:"field"},B.default.createElement("label",null,j.get("GUI:Password")),B.default.createElement("input",{name:"pass",type:"password",required:!0,minLength:N.MIN_PASS_LEN,maxLength:N.MAX_PASS_LEN,ref:W,autoComplete:"off"})),B.default.createElement("div",{className:"field"},B.default.createElement("label",null,j.get("GUI:Re-enterPassword")),B.default.createElement("input",{name:"confirmPass",type:"password",required:!0,ref:z,autoComplete:"off"})),B.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))},S("NewAccountBox",B.forwardRef(j))}}}),System.register("gui/screen/mainMenu/newAccount/NewAccountScreen",["gui/jsx/jsx","gui/screen/mainMenu/newAccount/NewAccountBox","gui/screen/mainMenu/ScreenType","gui/jsx/HtmlView","@puzzl/core/lib/async/Task","util/time","LocalPrefs","gui/screen/mainMenu/MainMenuScreen","network/HttpRequest"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S}],execute:function(){V=class extends U.MainMenuScreen{constructor(S,O,B,N,j,L,D){super(),this.appLocale=S,this.strings=O,this.jsxRenderer=B,this.messageBoxApi=N,this.serverRegions=j,this.errorHandler=L,this.localPrefs=D,this.title=this.strings.get("GUI:NewAccount"),this.handleSubmit=async(S,O)=>{if(!this.isBusy&&this.controller){this.isBusy=!0,await this.controller.hideSidebarButtons();let{user:B,pass:N,passMatch:j,regionId:L}=S;j?B.match(/^[A-Za-z0-9-_]+$/)?await this.createAccount(B,N,L,O):this.handleValidationError(this.strings.get("TS:BadNickname")):this.handleValidationError(this.strings.get("TXT_PASSWORD_VERIFY"))}}}async onEnter(S){var O;this.controller.toggleMainVideo(!1),this.isBusy=!1,(O=(O=S.regionId??this.localPrefs.getItem(_.StorageKey.PreferredServerRegion))&&this.serverRegions.isAvailable(O)?this.serverRegions.get(O):this.serverRegions.getFirstAvailable())?(this.controller.setSidebarButtons([{label:this.strings.get("GUI:Ok"),onClick:()=>this.submitForm()},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(j.ScreenType.Login,{afterLogin:S.afterLogin})}}]),this.controller.showSidebarButtons(),[O]=this.jsxRenderer.render(B.jsx(L.HtmlView,{width:"100%",height:"100%",component:N.NewAccountBox,props:{ref:S=>this.newAccountBox=S,strings:this.strings,regions:this.serverRegions.getAll(),initialRegion:O,onRegionChange:S=>{this.localPrefs.setItem(_.StorageKey.PreferredServerRegion,S)},onSubmit:O=>this.handleSubmit(O,S.afterLogin)}})),this.controller.setMainComponent(O)):this.handleWolError("No servers available",this.strings.get("gui:noserversavailable"),{fatal:!0})}submitForm(){!this.isBusy&&this.controller&&this.newAccountBox?.submit()}async createAccount(S,O,B,N){var L=this.serverRegions.get(B);this.serverRegions.setSelectedRegion(B);let _=new D.Task(async S=>{await F.sleep(1e3),S.isCancelled()||this.messageBoxApi.show(this.strings.get("TXT_CONNECTING"))});_.start();try{var U={locale:this.appLocale,user:S,pass:O},V=await(new H.HttpRequest).fetchJson(L.apiRegUrl,void 0,{method:"POST",body:JSON.stringify(U)});if(_.cancel(),this.messageBoxApi.destroy(),V.error)return void this.handleValidationError(V.error);this.controller?.goToScreen(j.ScreenType.Login,{useCredentials:{regionId:L.id,user:S,pass:O},afterLogin:N})}catch(S){_.cancel(),this.messageBoxApi.destroy(),this.handleWolError(S,this.strings.get("TS:ConnectFailed"),{fatal:!1})}}handleValidationError(S){this.messageBoxApi.show(S,this.strings.get("GUI:Ok"),()=>{this.isBusy=!1,this.controller?.showSidebarButtons()})}handleWolError(S,O,{fatal:B}){this.errorHandler.handle(S,O,()=>{this.isBusy=!1,this.controller&&(B?this.controller.goToScreen(j.ScreenType.Home):this.controller.showSidebarButtons())})}async onLeave(){this.newAccountBox=void 0,!this.isBusy&&this.controller&&await this.controller.hideSidebarButtons(),this.isBusy=!1}},S("NewAccountScreen",V)}}}),System.register("gui/screen/mainMenu/patchNotes/PatchNotesScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/component/Iframe","gui/screen/mainMenu/MainMenuScreen"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends L.MainMenuScreen{constructor(S,O,B){super(),this.strings=S,this.jsxRenderer=O,this.patchNotesUrl=B,this.title=this.strings.get("TS:PatchNotes")}onEnter(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!1);var[S]=this.jsxRenderer.render(B.jsx(N.HtmlView,{width:"100%",height:"100%",component:j.Iframe,props:{src:this.patchNotesUrl,className:"patch-notes"}}));this.controller.setMainComponent(S)}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},S("PatchNotesScreen",D)}}}),System.register("gui/screen/mainMenu/quickGame/ChatUi",["@puzzl/core/lib/async/cancellation","network/ladder/wladderConfig","util/disposable/CompositeDisposable","network/chat/ChatMessage","engine/sound/SoundKey","engine/sound/ChannelType","@puzzl/core/lib/async/Task","gui/chat/ChatHistory","util/time","gui/component/ChatInput"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){S("ChatUi",W=class{constructor(S,O,B,N,_,H,V,W){this.messages=S,this.updateView=O,this.wolConfig=B,this.wolCon=N,this.wolService=_,this.wladderService=H,this.strings=V,this.sound=W,this.disposables=new j.CompositeDisposable,this.users=[],this.chatHistory=new U.ChatHistory,this.playerProfiles=new Map,this.onChannelJoinLeave=S=>{let O=S.channel,B=O.match(/#Lob (\d+) (\d)/i);if(B){var[,N,j]=B.map(Number);if(this.wolConfig.getAllQuickMatchChannelIds().includes(N))return;O=this.strings.get("TXT_LOB_"+(j+1))}S.user.name===this.wolCon.getCurrentUser()?this.addSystemMessage(this.strings.get("join"===S.type?"TXT_JOINED_S":"TXT_YOULEFT",O)):S.channel===this.channelName&&("join"===S.type?(this.users.push(S.user),this.users.sort((S,O)=>Number(O.operator)-Number(S.operator))):-1!==(j=this.users.findIndex(O=>O.name===S.user.name))&&this.users.splice(j,1),this.updateView(),this.refreshPlayerRanks())},this.onChannelUsers=S=>{S.channelName===this.channelName&&(this.users=S.users,this.updateView({users:this.users}),this.refreshPlayerRanks())},this.onChannelMessage=S=>{var O;[S.from,S.to.name].includes(this.wolConfig.getQuickMatchBotName())||(S.to.type!==L.ChatRecipientType.Page&&S.to.type!==L.ChatRecipientType.Whisper||this.sound.play(D.SoundKey.IncomingMessage,F.ChannelType.Ui),O={...S,operator:this.users.find(O=>O.name===S.from)?.operator},this.messages.push(O),this.updateView(),S.to.type===L.ChatRecipientType.Whisper&&S.to.name!==this.wolCon.getServerName()&&S.from!==this.wolCon.getCurrentUser()&&(this.chatHistory.lastWhisperFrom.value=S.from))}}async loadChannel(S){this.channelName=void 0,this.users=[],this.wolCon.onJoinChannel.subscribe(this.onChannelJoinLeave),this.wolCon.onLeaveChannel.subscribe(this.onChannelJoinLeave),this.wolCon.onChannelUsers.subscribe(this.onChannelUsers),this.wolCon.onChatMessage.subscribe(this.onChannelMessage);let O=this.wolService.getConfig();var B=`#Lob ${O.getClientChannelType()} 0`;await this.wolCon.joinChannel(B,O.getGlobalChannelPass()),S.isCancelled()?this.wolCon.isOpen()&&this.wolCon.leaveChannel(B):(this.channelName=B,this.playerProfiles.clear(),this.updateView({channels:[B],users:this.users}))}getViewProps(){return{strings:this.strings,messages:this.messages,chatHistory:this.chatHistory,channels:this.channelName?[this.channelName]:[],localUsername:this.wolCon.getCurrentUser(),users:this.users,playerProfiles:this.playerProfiles,onSendMessage:S=>{S.value.length?S.recipient.type!==L.ChatRecipientType.Channel||S.recipient.name!==V.IMPLICIT_CHANNEL_NAME?this.wolCon.isOpen()&&(this.wolCon.sendChatMessage(S.value,S.recipient),S.recipient.type===L.ChatRecipientType.Whisper&&(this.chatHistory.lastWhisperTo.value=S.recipient.name)):this.addSystemMessage(this.strings.get("TXT_NOT_IN_CHAN")):this.addSystemMessage(this.strings.get("TXT_ENTER_MESSAGE"))}}}addSystemMessage(S){this.messages.push({text:S}),this.updateView()}refreshPlayerRanks(){if(this.wladderService.getUrl()){this.ranksUpdateTask?.cancel();let S=this.ranksUpdateTask=new _.Task(async S=>{let O=this.users.map(S=>S.name).filter(S=>!this.playerProfiles.has(S));if(O.length){for(;0<O.length;){var B,j=O.splice(0,N.MAX_LIST_SEARCH_COUNT);if(j=await this.wladderService.listSearch(j,S),S.isCancelled())return;for(B of j)this.playerProfiles.set(B.name,B)}this.updateView()}});S.start().catch(S=>{S instanceof B.OperationCanceledError||console.error(S)})}}dispose(){this.disposables.dispose(),this.ranksUpdateTask&&(this.ranksUpdateTask.cancel(),this.ranksUpdateTask=void 0),this.wolCon.isOpen()&&this.channelName&&this.wolCon.leaveChannel(this.channelName),this.wolCon.onJoinChannel.unsubscribe(this.onChannelJoinLeave),this.wolCon.onLeaveChannel.unsubscribe(this.onChannelJoinLeave),this.wolCon.onChannelUsers.unsubscribe(this.onChannelUsers),this.wolCon.onChatMessage.unsubscribe(this.onChannelMessage),this.channelName=void 0,this.messages=[],this.users=[],this.playerProfiles.clear()}}),__decorate([H.Throttle(5e3)],W.prototype,"refreshPlayerRanks",null)}}}),System.register("gui/screen/mainMenu/quickGame/QuickGameScreen",["@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation","gui/jsx/jsx","gui/jsx/HtmlView","engine/sound/Music","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","game/gameopts/constants","engine/sound/SoundKey","engine/sound/ChannelType","gui/screen/mainMenu/MainMenuRoute","gui/screen/mainMenu/quickGame/component/QuickGameForm","LocalPrefs","network/ladder/WLadderService","network/ladder/wladderConfig","network/WolError","network/qmCodes","gui/screen/mainMenu/quickGame/ChatUi"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S}],execute:function(){var O;(O=J=J||{})[O.None=0]="None",O[O.Initializing=1]="Initializing",O[O.WaitingForMatch=2]="WaitingForMatch",O[O.WaitingForStartTimer=3]="WaitingForStartTimer",O[O.WaitingForGameStart=4]="WaitingForGameStart",ee=class extends F.MainMenuScreen{constructor(S,O,B,N,j,L,F,H,K,$,q,Z,X,ee,te,ie){super(),this.unrankedEnabled=S,this.engineVersion=O,this.engineModHash=B,this.clientLocale=N,this.rules=j,this.wolService=L,this.wolCon=F,this.wladderService=H,this.serverRegions=K,this.rootController=$,this.messageBoxApi=q,this.jsxRenderer=Z,this.strings=X,this.localPrefs=ee,this.sound=te,this.errorHandler=ie,this.title=this.strings.get("GUI:WolMatch"),this.musicType=D.MusicType.NormalShuffle,this.partySize=1,this.availableQueueTypes=Object.values(Q.LadderQueueType),this.disposables=new U.CompositeDisposable,this.handleChatMessage=S=>{if(S.text.startsWith(Y.RPL_QUEUE_LIST+" ")&&this.queueState===J.None){let O=S.text.split(" ").slice(1).join(" ").split(",").filter(S=>Object.values(Q.LadderQueueType).includes(S));this.availableQueueTypes=O,!O.includes(this.queueOpts.type)&&O.length&&(this.queueOpts.type=O[0],this.form&&this.requestPlayerProfileRefresh()),this.form?.applyOptions(S=>{S.enabledTypes=O,S.type=this.queueOpts.type})}if(this.queueState!==J.None&&S.from===this.wolConfig.getQuickMatchBotName())if([Y.RPL_WORKING,Y.RPL_BAD_VERS,Y.RPL_BAD_HASH,Y.RPL_MODE_UNAVAIL].includes(S.text))if(this.queueState===J.Initializing)if(S.text===Y.RPL_WORKING)this.updateQueueState(J.WaitingForMatch);else{let O,B=!0;S.text===Y.RPL_BAD_VERS?O=this.strings.get("TS:OutdatedClient"):S.text===Y.RPL_BAD_HASH?O=this.strings.get("TXT_MISMATCH"):S.text===Y.RPL_MODE_UNAVAIL?(O=this.strings.get("WOL:MatchModeUnavail"),B=!1):O=this.strings.get("WOL:MatchBadParameters"),B||this.leaveQueue(),this.handleError(S.text,O,{fatal:B})}else console.warn(`Unexpected reply "${S.text}" from match bot (qs: ${J[this.queueState]})`);else if(S.text.startsWith(Y.RPL_MATCHED+" "))this.queueState===J.WaitingForMatch?(this.sound.play(V.SoundKey.PlayerJoined,W.ChannelType.Ui),O=S.text.split(" ")[1],this.countdownSeconds=Number(O),this.updateQueueState(J.WaitingForStartTimer)):console.warn(`Unexpected reply "${S.text}" from match bot (qs: ${J[this.queueState]})`);else if(S.text===Y.RPL_REQUEUE)[J.WaitingForGameStart,J.WaitingForStartTimer].includes(this.queueState)&&(console.log("A player left. Returned to queue."),this.updateQueueState(J.WaitingForMatch));else if(S.text.startsWith(Y.RPL_STATS+" ")&&this.queueState===J.WaitingForMatch){let B=S.text.split(" ").slice(1).join(" ");var[,O]=B.split(","),O="-1"!==O?Number(O):void 0;this.updateSidebarText(this.strings.get("TXT_SEARCHING_FOR",this.queueOpts.type)+"\n\n"+this.strings.get("WOL:MatchAvgWaitTime")+"\n"+(void 0!==O&&O<3600?this.strings.get("WOL:MatchAvgWaitTimeMinutes",O<60?"<1":"~"+Math.ceil(O/60)):this.strings.get("WOL:MatchAvgWaitTimeUnavail")))}},this.handleLeaveChannel=async S=>{S.user.name===this.wolCon.getCurrentUser()&&S.channel===this.quickMatchChannelName&&(this.quickMatchChannelName=void 0,this.queueState!==J.None&&(this.updateQueueState(J.None),this.wolCon.close()))},this.handleGameStart=async S=>{if(this.queueState===J.WaitingForGameStart||this.queueState===J.WaitingForStartTimer)try{var O=this.wolCon.getCurrentUser();if(void 0===O)throw new Error("User should be logged in");this.updateQueueState(J.None);var B=new z.MainMenuRoute(_.ScreenType.Login,{afterLogin:S=>new z.MainMenuRoute(_.ScreenType.QuickGame,{messages:S})});this.form||await(this.controller?.popScreen()),this.rootController.joinGame(S.gameId,S.timestamp,S.gservUrl,O,!0,!1,B)}catch(S){if(await this.leaveQueue(),!this.wolCon.isOpen())return;this.handleError(S,this.strings.get("WOL:MatchTimeout"),{fatal:!1})}},this.onWolClose=()=>{this.updateQueueState(J.None)},this.onWolConLost=S=>{this.handleError(S,this.strings.get("TXT_YOURE_DISCON"),{fatal:!0})}}async onEnter(S){this.updateQueueState(J.None);var O=this.localPrefs.getItem($.StorageKey.LastPlayerCountry),B=this.localPrefs.getItem($.StorageKey.LastPlayerColor),j=this.localPrefs.getItem($.StorageKey.LastQueueRanked),L=this.localPrefs.getItem($.StorageKey.LastQueueType);if(O=void 0!==O&&Number(O)<this.getAvailablePlayerCountries().length?Number(O):H.RANDOM_COUNTRY_ID,B=void 0!==B&&Number(B)<this.getAvailablePlayerColors().length?Number(B):H.RANDOM_COLOR_ID,j=void 0===j||!this.unrankedEnabled||Boolean(Number(j)),L=void 0!==L&&Object.values(Q.LadderQueueType).includes(L)?L:Q.LadderQueueType.Solo1v1,this.queueOpts={type:L,ranked:j,countryId:O,colorId:B},this.playerProfile=void 0,this.controller.toggleMainVideo(!1),this.wolService.isConnected()&&this.wolCon.getCurrentUser()){this.wolConfig=this.wolService.getConfig(),this.wolCon.onClose.subscribe(this.onWolClose),this.disposables.add(()=>this.wolCon.onClose.unsubscribe(this.onWolClose)),this.wolService.onWolConnectionLost.subscribe(this.onWolConLost),this.disposables.add(()=>this.wolService.onWolConnectionLost.unsubscribe(this.onWolConLost)),this.wolCon.onChatMessage.subscribe(this.handleChatMessage),this.disposables.add(()=>this.wolCon.onChatMessage.unsubscribe(this.handleChatMessage)),this.wolCon.onLeaveChannel.subscribe(this.handleLeaveChannel),this.disposables.add(()=>this.wolCon.onLeaveChannel.unsubscribe(this.handleLeaveChannel)),this.wolCon.onGameStart.subscribe(this.handleGameStart),this.disposables.add(()=>this.wolCon.onGameStart.unsubscribe(this.handleGameStart));let O=S.messages;this.chatUi=new X.ChatUi(O,S=>{this.form?.applyOptions(O=>{var B=O.chatProps;O.chatProps={...B,...S}})},this.wolConfig,this.wolCon,this.wolService,this.wladderService,this.strings,this.sound),this.disposables.add(this.chatUi,()=>this.chatUi=void 0),this.refreshSidebarButtons(),this.initView(),this.requestPlayerProfileRefresh(),this.wolCon.privmsg([this.wolConfig.getQuickMatchBotName()],Y.REQ_LIST_QUEUES),this.updateStatsIntervalId=setInterval(()=>{this.wolCon.privmsg([this.wolConfig.getQuickMatchBotName()],Y.REQ_LIST_QUEUES)},3e4);let L=new N.CancellationTokenSource;this.disposables.add(()=>L.cancel()),B=L.token;try{await this.chatUi.loadChannel(B)}catch(j){let S=this.strings.get("WOL:MatchBadParameters");return j instanceof Z.WolError&&(B=(new Map).set(Z.WolError.Code.NoSuchChannel,"WOL:ChannelJoinFailure").set(Z.WolError.Code.BadChannelPass,"TXT_BADPASS").set(Z.WolError.Code.ChannelFull,"TXT_CHANNEL_FULL").set(Z.WolError.Code.BannedFromChannel,"TXT_JOINBAN").get(j.code))&&(S=this.strings.get(B)),void O.push({text:S})}}else this.controller.goToScreen(_.ScreenType.Login,{afterLogin:S=>new z.MainMenuRoute(_.ScreenType.QuickGame,{messages:S})})}requestPlayerProfileRefresh(){this.refreshProfileTask?.cancel(),this.refreshProfileTask=new B.Task(S=>this.refreshPlayerProfile(this.queueOpts.type,S)),this.refreshProfileTask.start().catch(S=>{S instanceof N.OperationCanceledError||console.error(S)})}refreshSidebarButtons(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:QuickMatchPlay"),tooltip:this.strings.get("GUI:FindAGame"),disabled:this.queueState!==J.None,onClick:()=>{this.availableQueueTypes.includes(this.queueOpts.type)?setTimeout(()=>this.joinQueue(),0):this.messageBoxApi.show(this.strings.get("WOL:MatchModeUnavail"),this.strings.get("GUI:OK"))}},...this.wladderService.getUrl()?[{label:this.strings.get("GUI:ViewLadder"),tooltip:this.strings.get("GUI:ViewTourLadder"),onClick:()=>{this.controller?.pushScreen(_.ScreenType.Ladder,{ladderType:Q.getLadderTypeForQueueType(this.queueOpts.type,this.partySize),highlightPlayer:this.playerProfile})}}]:[],...this.controller?.hasScreen(_.ScreenType.LadderRules)?[{label:this.strings.get("GUI:ViewRules"),onClick:()=>{this.controller?.pushScreen(_.ScreenType.LadderRules)}}]:[],...1<this.serverRegions.getSize()?[{label:this.strings.get("GUI:ChangeServer"),tooltip:this.strings.get("STT:ChangeServer"),onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(_.ScreenType.Login,{clearCredentials:!0,afterLogin:S=>new z.MainMenuRoute(_.ScreenType.QuickGame,{messages:S})})}}]:[],{label:this.queueState===J.None?this.strings.get("GUI:Back"):this.strings.get("GUI:Cancel"),isBottom:!0,onClick:()=>{this.queueState===J.None?(this.wolService.closeWolConnection(),this.controller?.goToScreen(_.ScreenType.Home)):this.leaveQueue()}}],!0),this.controller.showSidebarButtons()}updateSidebarText(S){this.controller.setSidebarMpContent({text:S})}initView(){var[S]=this.jsxRenderer.render(j.jsx(L.HtmlView,{width:"100%",height:"100%",component:K.QuickGameForm,innerRef:S=>this.form=S,props:{strings:this.strings,disabled:this.queueState!==J.None,countryUiNames:new Map([[H.RANDOM_COUNTRY_NAME,H.RANDOM_COUNTRY_UI_NAME]].concat(this.getAvailablePlayerCountryRules().map(S=>[S.name,S.uiName]))),countryUiTooltips:new Map([[H.RANDOM_COUNTRY_NAME,H.RANDOM_COUNTRY_UI_TOOLTIP]].concat(this.getAvailablePlayerCountryRules().filter(S=>S.uiTooltip).map(S=>[S.name,S.uiTooltip]))),availableTypes:Object.values(Q.LadderQueueType),enabledTypes:this.availableQueueTypes,availableColors:[H.RANDOM_COLOR_NAME].concat(this.getAvailablePlayerColors()),availableCountries:[H.RANDOM_COUNTRY_NAME].concat(this.getAvailablePlayerCountries()),color:this.getColorNameById(this.queueOpts.colorId),country:this.getCountryNameById(this.queueOpts.countryId),type:this.queueOpts.type,ranked:this.queueOpts.ranked,unrankedEnabled:this.unrankedEnabled,playerName:this.wolCon.getCurrentUser()??"",playerProfile:this.playerProfile,chatProps:this.chatUi.getViewProps(),onCountrySelect:S=>{var O=this.getCountryIdByName(S);this.queueOpts.countryId=O,this.form?.applyOptions(O=>{O.country=S}),O!==H.RANDOM_COUNTRY_ID?this.localPrefs.setItem($.StorageKey.LastPlayerCountry,String(O)):this.localPrefs.removeItem($.StorageKey.LastPlayerCountry)},onColorSelect:S=>{var O=this.getColorIdByName(S);this.queueOpts.colorId=O,this.form?.applyOptions(O=>{O.color=S}),O!==H.RANDOM_COLOR_ID?this.localPrefs.setItem($.StorageKey.LastPlayerColor,String(O)):this.localPrefs.removeItem($.StorageKey.LastPlayerColor)},onRankedChange:S=>{this.queueOpts.ranked=S,this.form?.applyOptions(O=>O.ranked=S),this.localPrefs.setItem($.StorageKey.LastQueueRanked,String(Number(S)))},onTypeChange:S=>{this.queueOpts.type!==S&&(this.queueOpts.type=S,this.playerProfile=void 0,this.form?.applyOptions(O=>{O.type=S,O.playerProfile=void 0}),this.localPrefs.setItem($.StorageKey.LastQueueType,S),this.form&&this.requestPlayerProfileRefresh())}}}));this.controller.setMainComponent(S)}async refreshPlayerProfile(S,O){var B,N;!this.wladderService.getUrl()||(B=this.wolCon.getCurrentUser())&&(N=Q.getLadderTypeForQueueType(S,this.partySize),[N]=await this.wladderService.listSearch([B],O,N,q.WLadderService.CURRENT_SEASON,this.clientLocale),N&&!O.isCancelled()&&(this.playerProfile=N,this.form?.applyOptions(S=>S.playerProfile=this.playerProfile)))}getAvailablePlayerCountryRules(){return this.rules.getMultiplayerCountries()}getAvailablePlayerCountries(){return this.getAvailablePlayerCountryRules().map(S=>S.name)}getCountryNameById(S){let O;return O=S===H.RANDOM_COUNTRY_ID?H.RANDOM_COUNTRY_NAME:this.getAvailablePlayerCountries()[S],O}getCountryIdByName(S){let O;return O=S===H.RANDOM_COUNTRY_NAME?H.RANDOM_COUNTRY_ID:this.getAvailablePlayerCountries().indexOf(S),O}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map(S=>S.asHexString())}getColorNameById(S){let O;return O=S===H.RANDOM_COLOR_ID?H.RANDOM_COLOR_NAME:this.getAvailablePlayerColors()[S],O}getColorIdByName(S){let O;if(S===H.RANDOM_COLOR_NAME)O=H.RANDOM_COLOR_ID;else if(O=this.getAvailablePlayerColors().indexOf(S),-1===O)throw new Error(`Color ${S} not found in available player colors`);return O}async joinQueue(){if(this.queueState===J.None){this.quickMatchChannelName=void 0,this.updateSidebarText(this.strings.get("WOL:RequestingMatch")+"..."),this.updateQueueState(J.Initializing);try{var S=`#Lob ${this.wolConfig.getQuickMatchChannelId(this.queueOpts.type)} 0`;if(await this.wolCon.joinChannel(S,this.wolConfig.getGlobalChannelPass()),this.queueState!==J.Initializing)return;this.quickMatchChannelName=S;let{countryId:B,colorId:N}=this.queueOpts;var O=Y.REQ_MATCH+" "+[[Y.TAG_COUNTRY,B],[Y.TAG_COLOR,N],[Y.TAG_VERSION,this.engineVersion],[Y.TAG_MODHASH,this.engineModHash],[Y.TAG_RANKED,Number(this.queueOpts.ranked)]].map(S=>S.join("=")).join(", ");this.wolCon.privmsg([this.wolConfig.getQuickMatchBotName()],O)}catch(S){return void(S instanceof Z.WolError&&S.code===Z.WolError.Code.BadChannelPass?this.handleError(S,this.strings.get("WOL:MatchModeUnavail"),{fatal:!1}):this.handleError(S,this.strings.get("WOL:MatchBadParameters"),{fatal:!0}))}}}async leaveQueue(){this.queueState!==J.None&&(this.updateQueueState(J.None),this.messageBoxApi.destroy(),this.wolCon.isOpen()&&this.quickMatchChannelName&&(this.wolCon.leaveChannel(this.quickMatchChannelName),this.quickMatchChannelName=void 0))}updateQueueState(S){if(this.queueState=S,this.gameStartTimeoutId&&(clearTimeout(this.gameStartTimeoutId),this.gameStartTimeoutId=void 0),this.countdownIntervalId&&(clearInterval(this.countdownIntervalId),this.countdownIntervalId=void 0),this.updateStatsIntervalId&&(clearInterval(this.updateStatsIntervalId),this.updateStatsIntervalId=void 0),this.form&&(this.form.applyOptions(O=>O.disabled=S!==J.None),this.refreshSidebarButtons()),S!==J.None){let O;switch(S===J.WaitingForGameStart&&(this.gameStartTimeoutId=setTimeout(async()=>{console.log("Timed out. Rejoining queue..."),await this.leaveQueue(),this.wolCon.isOpen()&&this.joinQueue()},1e4)),S===J.WaitingForStartTimer&&(this.countdownIntervalId=setInterval(()=>this.tickStartTimer(),1e3)),S===J.WaitingForMatch&&(this.updateStatsIntervalId=setInterval(()=>this.requestStats(),5e3)),S){case J.WaitingForMatch:O=this.strings.get("TXT_SEARCHING_FOR",this.queueOpts.type);break;case J.WaitingForStartTimer:O=this.strings.get("WOL:MatchStartSeconds",this.countdownSeconds);break;case J.WaitingForGameStart:O=this.strings.get("WOL:MatchGameStarting")}void 0!==O&&(this.updateSidebarText(O),console.log(O))}else this.updateSidebarText("")}async tickStartTimer(){if(void 0===this.countdownSeconds)throw new Error("Game start countdown should be set by now");0<this.countdownSeconds?(this.countdownSeconds--,this.updateSidebarText(this.strings.get("WOL:MatchStartSeconds",this.countdownSeconds)),this.sound.play(V.SoundKey.QuickMatchTimer,W.ChannelType.Ui)):this.updateQueueState(J.WaitingForGameStart)}requestStats(){this.queueState===J.WaitingForMatch&&this.wolCon.privmsg([this.wolConfig.getQuickMatchBotName()],Y.REQ_STATS)}async onUnstack(){this.refreshSidebarButtons(),this.initView(),this.wolService.isConnected()&&this.wolCon.getCurrentUser()?this.wolCon.privmsg([this.wolConfig.getQuickMatchBotName()],Y.REQ_LIST_QUEUES):this.controller.goToScreen(_.ScreenType.Login,{afterLogin:S=>new z.MainMenuRoute(_.ScreenType.QuickGame,{messages:S})}),this.requestPlayerProfileRefresh()}async onStack(){await this.unrender()}async onLeave(){this.updateQueueState(J.None),this.refreshProfileTask&&(this.refreshProfileTask.cancel(),this.refreshProfileTask=void 0),this.disposables.dispose(),this.wolCon.isOpen()&&this.quickMatchChannelName&&this.wolCon.leaveChannel(this.quickMatchChannelName),await this.unrender()}async unrender(){this.availQueueRefreshIntervalId&&(clearInterval(this.availQueueRefreshIntervalId),this.availQueueRefreshIntervalId=void 0),this.form=void 0,await this.controller.hideSidebarButtons()}handleError(S,O,{fatal:B}){this.updateQueueState(J.None),this.errorHandler.handle(S,O,()=>{B&&(this.wolService.closeWolConnection(),this.controller?.goToScreen(_.ScreenType.Home))})}},S("QuickGameScreen",ee)}}}),System.register("gui/screen/mainMenu/quickGame/component/QuickGameChat",["react","gui/component/Chat","gui/component/List","gui/component/ChannelUser","network/chat/ChatMessage"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){S("QuickGameChat",({strings:S,messages:O,channels:F,localUsername:_,users:U,chatHistory:H,playerProfiles:V,onSendMessage:W})=>B.default.createElement(B.default.Fragment,null,B.default.createElement(N.Chat,{strings:S,messages:O,channels:F??[],chatHistory:H,localUsername:_,onSendMessage:W,tooltips:{input:S.get("STT:LobbyEditInput"),output:S.get("STT:LobbyEditOutput"),button:S.get("STT:EmoteButton")}}),B.default.createElement(j.List,{className:"players-list",tooltip:S.get("STT:LobbyListUsers")},U.map(O=>{var N=V.get(O.name);return B.default.createElement(L.ChannelUser,{key:O.name,user:O,playerProfile:N,strings:S,onClick:()=>{H.lastComposeTarget.value={type:D.ChatRecipientType.Whisper,name:O.name}}})}))))}}}),System.register("gui/screen/mainMenu/quickGame/component/QuickGameForm",["classnames","gui/component/Image","gui/component/ButtonSelect","gui/component/ColorSelect","gui/component/CountrySelect","gui/component/Option","react","gui/screen/mainMenu/lobby/component/RankIndicator","gui/screen/mainMenu/quickGame/component/QuickGameChat"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S}],execute:function(){S("QuickGameForm",S=>{let{strings:O,disabled:V,playerName:W,playerProfile:z,unrankedEnabled:K,ranked:$,type:q,availableTypes:Q,enabledTypes:Z,chatProps:Y,onRankedChange:X,onTypeChange:J}=S;return _.createElement("div",{className:"qm-form"},_.createElement("div",{className:"qm-top"},_.createElement("div",{className:"opts"},_.createElement("div",{className:"item qm-game-type-item"},_.createElement("label",null,_.createElement("span",{className:"label"},O.get("GUI:QuickMatchGameMode")),_.createElement("div",{className:"qm-game-type"},_.createElement(j.ButtonSelect,{initialValue:q,onSelect:S=>J(S),disabled:V},Q.map(S=>_.createElement(F.Option,{value:S,label:S,key:S,disabled:!Z.includes(S)}))),_.createElement(j.ButtonSelect,{initialValue:String(Number($)),onSelect:S=>{X(Boolean(Number(S)))},disabled:V},_.createElement(F.Option,{value:"1",label:O.get("GUI:Ranked")}),_.createElement(F.Option,{value:"0",disabled:!K,label:O.get("GUI:Unranked")}))))),_.createElement("div",{className:"item"},_.createElement("label",null,_.createElement("span",{className:"label"},O.get("GUI:PreferredCountry")),_.createElement(D.CountrySelect,{countryUiNames:S.countryUiNames,countryUiTooltips:S.countryUiTooltips,country:S.country,availableCountries:S.availableCountries,disabled:V,strings:S.strings,onSelect:O=>S.onCountrySelect(O)}))),_.createElement("div",{className:"item"},_.createElement("label",null,_.createElement("span",{className:"label"},O.get("GUI:PreferredColor")),_.createElement(L.ColorSelect,{color:S.color,availableColors:S.availableColors,disabled:V,strings:S.strings,onSelect:O=>S.onColorSelect(O)})))),_.createElement("fieldset",{className:"qm-profile"},_.createElement("legend",null,z?.name??W),void 0===z?.rank?z?_.createElement("div",{className:"item placement"},O.get("GUI:LadderPlacement",z.placementMatchesLeft)):_.createElement("div",null):_.createElement(_.Fragment,null,_.createElement("div",{className:"player-rank"},_.createElement("div",{className:"rank-name"},_.createElement(U.RankIndicator,{playerProfile:z,strings:O})," ",O.get(U.RANK_LABELS.get(z.rankType))),_.createElement("div",{className:"rank-number"},O.get("GUI:Rank")," ",z.rank)),z.promotionProgress&&_.createElement("div",{className:B.default("item","promo-progress",{demotion:z.promotionProgress.demotion})},_.createElement("span",{className:"label"},O.get("GUI:LadderPromoProgress")),_.createElement("span",{className:"value"},_.createElement("div",{className:"next-rank"},O.get(U.RANK_LABELS.get(z.promotionProgress.rankType)),z.promotionProgress.demotion?_.createElement("span",{className:"demotion-indicator"},""):_.createElement("span",{className:"promotion-indicator"},"")),_.createElement("progress",{value:z.promotionProgress.progress,max:1}))),_.createElement("hr",null),_.createElement("div",{className:"item"},_.createElement("span",{className:"label"},O.get("GUI:LadderWins")),_.createElement("span",{className:"value"},z.wins??O.get("GUI:UnknownStats"))),void 0!==z.points&&_.createElement("div",{className:"item"},_.createElement("span",{className:"label"},O.get("GUI:LadderPoints")),_.createElement("span",{className:"value"},z.points)),void 0!==z.bonusPool&&_.createElement("div",{className:"item"},_.createElement("span",{className:"label"},O.get("GUI:ProfileBonusPool")),_.createElement("span",{className:"value"},z.bonusPool)),void 0!==z.mmr&&_.createElement("div",{className:"item"},_.createElement("span",{className:"label"},O.get("GUI:ProfileMMR")),_.createElement("span",{className:"value"},z.mmr,void 0!==z.provisionalMmr&&_.createElement("span",{className:"info",title:O.get("gui:profileprovmmr")+" "+z.provisionalMmr},_.createElement(N.Image,{src:"info.png"}))))))),_.createElement("div",{className:"qm-bottom"},_.createElement(H.QuickGameChat,{...Y})))})}}}),System.register("gui/screen/mainMenu/score/ScoreScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/score/ScoreTable","game/SideType","engine/sound/Music","gui/screen/mainMenu/MainMenuScreen","LocalPrefs","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation/OperationCanceledError","@puzzl/core/lib/async/sleep"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){W=new Map([[L.SideType.GDI,{img:"mpascrnl.shp",pal:"mpascrn.pal"}],[L.SideType.Nod,{img:"mpsscrnl.shp",pal:"mpsscrn.pal"}]]),z=class extends F.MainMenuScreen{constructor(S,O,B,N,j,L){super(),this.strings=S,this.jsxRenderer=O,this.messageBoxApi=B,this.localPrefs=N,this.config=j,this.wolService=L,this.musicType=D.MusicType.Score}async onEnter(S){this.title=S.singlePlayer?this.strings.get("GUI:SkirmishScore"):this.strings.get("GUI:MultiplayerScore"),this.controller.toggleMainVideo(!1),this.initView(S),S.singlePlayer||this.loadGameReport(S.game)}initView({game:S,localPlayer:O,singlePlayer:D,tournament:F,returnTo:_}){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Continue"),tooltip:this.strings.get("STT:MPScoreButtonContinue"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(_.screenType,_.params)}}]),this.controller.showSidebarButtons();var U,H=O.country?.side??L.SideType.GDI;if(!(U=W.get(H)))throw new Error("Unsupported sideType "+H);var[U]=this.jsxRenderer.render(B.jsx("container",{width:"100%",height:"100%"},B.jsx("sprite",{image:U.img,palette:U.pal}),B.jsx(N.HtmlView,{width:"100%",height:"100%",component:j.ScoreTable,innerRef:S=>this.scoreTable=S,props:{game:S,singlePlayer:D,localPlayer:O,tournament:F,strings:this.strings}})));this.controller.setMainComponent(U)}loadGameReport(S){this.reportUpdateTask?.cancel();let O=this.reportUpdateTask=new U.Task(async O=>{for(;;){if(O.isCancelled())return;let B=this.wolService.getLastGameReport();if(B?.gameId===S.id)return void this.scoreTable.applyOptions(S=>{S.gameReport=B});await V.sleep(1e3,O)}});O.start().catch(S=>{S instanceof H.OperationCanceledError||console.error(S)})}async onLeave(){this.reportUpdateTask&&(this.reportUpdateTask.cancel(),this.reportUpdateTask=void 0),await this.controller.hideSidebarButtons();var S,O,B=this.config.donateUrl;B&&(2<=(O=Number(this.localPrefs.getItem(_.StorageKey.DonateBoxState)??"0"))?((S=await this.messageBoxApi.confirm(this.strings.get("TS:DonatePrompt"),this.strings.get("TS:DonateNow"),this.strings.get("TS:DonateLater")))&&window.open(B,"_blank"),this.localPrefs.setItem(_.StorageKey.DonateBoxState,"-"+Date.now()),window.gtag?.("event","donate_dismiss",{donate:S})):0<=O?this.localPrefs.setItem(_.StorageKey.DonateBoxState,String(O+1)):(O=-O,2592e6<Date.now()-O&&this.localPrefs.setItem(_.StorageKey.DonateBoxState,"0")))}},S("ScoreScreen",z)}}}),System.register("gui/screen/mainMenu/score/ScoreTable",["classnames","game/gameopts/constants","gui/component/CountryIcon","react","util/format","gui/screen/mainMenu/lobby/component/RankIndicator","network/WolGameReport"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){S("ScoreTable",({game:S,singlePlayer:O,tournament:B,localPlayer:H,gameReport:V,strings:W})=>{const z=S.getNonNeutralPlayers().filter(S=>!S.isObserver||S.defeated).sort((S,O)=>O.score-S.score);let K=B&&V;var $=V?.players.find(S=>S.name.toLowerCase()===H.name.toLowerCase());let q=$?.resultType;return void 0===q&&(S.stalemateDetectTrait?.isStale()&&0===S.stalemateDetectTrait.getCountdownTicks()?q=_.WolGameReportResult.Draw:H.defeated?S.alliances.getAllies(H).filter(S=>!S.isAi&&!S.defeated).length||(q=_.WolGameReportResult.Loss):H.isObserver||(q=_.WolGameReportResult.Win)),L.default.createElement("div",{className:"score-wrapper"},(q||!O)&&L.default.createElement("div",{className:"score-title"},L.default.createElement("div",{className:"game-result"},q===_.WolGameReportResult.Win?W.get("gui:gameresultvictory"):q===_.WolGameReportResult.Draw?W.get("gui:gameresultdraw"):q===_.WolGameReportResult.Loss?W.get("gui:gameresultdefeat"):""),!V&&!O&&(B||void 0===q)&&L.default.createElement("div",{className:"pending-results"},W.get("gui:gameresultwaiting")),$?.points&&L.default.createElement("div",{className:"points-gain"},W.get("GUI:LadderPoints")," ",$.points.value," (",L.default.createElement(U,{className:"points-gain-value",value:$.points.gain,win:q===_.WolGameReportResult.Win}),")")),L.default.createElement("div",{className:"score-header"},L.default.createElement("div",{"data-r-tooltip":W.get("STT:MPScoreLabelMapName")},W.get("TXT_MAP",S.gameOpts.mapTitle)),L.default.createElement("div",{"data-r-tooltip":W.get("STT:MPScoreLabelTime")},W.get("GUI:Time"),": ",D.formatTimeDuration(Math.floor(S.currentTime/1e3)))),L.default.createElement("table",null,L.default.createElement("thead",null,L.default.createElement("tr",null,L.default.createElement("th",null),L.default.createElement("th",{className:"player-rank"}),L.default.createElement("th",{className:"player-name","data-r-tooltip":W.get("STT:MPScoreLabelPlayer")},W.get("GUI:Player")),K&&L.default.createElement("th",{className:"number"},W.get("GUI:MMR")),L.default.createElement("th",{className:"number","data-r-tooltip":W.get("STT:MPScoreLabelKills")},W.get("GUI:Kills")),L.default.createElement("th",{className:"number","data-r-tooltip":W.get("STT:MPScoreLabelLosses")},W.get("GUI:Losses")),L.default.createElement("th",{className:"number","data-r-tooltip":W.get("STT:MPScoreLabelBuilt")},W.get("GUI:Built")),L.default.createElement("th",{className:"number","data-r-tooltip":W.get("STT:MPScoreLabelScore")},W.get("GUI:Score")))),L.default.createElement("tbody",null,z.map((S,O)=>{var B=V?.players.find(O=>O.name.toLowerCase()===S.name.toLowerCase()),D=B?.mmr?.value,H=B?.mmr?.gain;return L.default.createElement("tr",{key:O,style:{color:S.color.asHexString()}},L.default.createElement("td",null,L.default.createElement(j.CountryIcon,{country:S.country.name})),L.default.createElement("td",{className:"player-rank"},B&&L.default.createElement(F.RankIndicator,{playerProfile:B,strings:W})),L.default.createElement("td",{className:"player-name","data-r-tooltip":W.get("STT:MPScoreLabelPlayer")},S.isAi?N.getAiDisplayName(S.aiDifficulty,W):S.name),K&&L.default.createElement("td",{className:"number player-mmr"},D??"-",void 0!==H&&L.default.createElement(L.default.Fragment,null," (",L.default.createElement(U,{className:"mmr-gain",value:H,win:B?.resultType===_.WolGameReportResult.Win}),")")),L.default.createElement("td",{className:"number","data-r-tooltip":W.get("STT:MPScoreLabelKills")},S.getUnitsKilled()),L.default.createElement("td",{className:"number","data-r-tooltip":W.get("STT:MPScoreLabelLosses")},S.getUnitsLost()),L.default.createElement("td",{className:"number","data-r-tooltip":W.get("STT:MPScoreLabelBuilt")},S.getUnitsBuilt()),L.default.createElement("td",{className:"number","data-r-tooltip":W.get("STT:MPScoreLabelScore")},S.score))}))))}),U=({value:S,win:O,className:N})=>{let j;return j=0<S?"+":0===S?O?"+":"-":"",L.default.createElement("span",{className:B.default(N,{positive:O})},j,S)}}}}),System.register("gui/screen/options/CustomAiManagerScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/options/component/CustomAiManager","gui/screen/mainMenu/MainMenuScreen"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends L.MainMenuScreen{constructor(S,O,B,N){super(),this.strings=S,this.jsxRenderer=O,this.messageBoxApi=B,this.rfs=N,this.title="AI"}onEnter(S){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[O]=this.jsxRenderer.render(B.jsx(N.HtmlView,{width:"100%",height:"100%",component:j.CustomAiManager,props:{strings:this.strings,messageBoxApi:this.messageBoxApi,rfs:this.rfs}}));this.controller.setMainComponent(O)}async onLeave(){await this.controller.hideSidebarButtons()}},S("CustomAiManagerScreen",D)}}}),System.register("gui/screen/options/GeneralOptions",["engine/renderable/entity/unit/FlyerHelperMode","util/Base64","util/BoxedVar","gui/screen/options/GraphicsOptions"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("SCROLL_BASE_FACTOR",3),S("GeneralOptions",class{constructor(){this.scrollRate=new j.BoxedVar(12),this.flyerHelper=new j.BoxedVar(B.FlyerHelperMode.Selected),this.hiddenObjects=new j.BoxedVar(!0),this.targetLines=new j.BoxedVar(!0),this.rightClickMove=new j.BoxedVar(!1),this.rightClickScroll=new j.BoxedVar(!0),this.mouseAcceleration=new j.BoxedVar(!0),this.graphics=new L.GraphicsOptions}unserialize(S){var[O,B,j,L,D,F,_,U]=S.split(",");return this.scrollRate.value=Number(O),void 0!==B&&(this.flyerHelper.value=Number(B)),void 0!==j&&this.graphics.unserialize(N.Base64.decode(j)),void 0!==L&&(this.hiddenObjects.value=Boolean(Number(L))),void 0!==D&&(this.rightClickMove.value=Boolean(Number(D))),void 0!==F&&(this.rightClickScroll.value=Boolean(Number(F))),void 0!==_&&(this.targetLines.value=Boolean(Number(_))),void 0!==U&&(this.mouseAcceleration.value=Boolean(Number(U))),this}serialize(){return[this.scrollRate.value,this.flyerHelper.value,N.Base64.encode(this.graphics.serialize()),Number(this.hiddenObjects.value),Number(this.rightClickMove.value),Number(this.rightClickScroll.value),Number(this.targetLines.value),Number(this.mouseAcceleration.value)].join(",")}})}}}),System.register("gui/screen/options/GraphicsOptions",["engine/renderable/entity/unit/ModelQuality","engine/renderable/entity/unit/ShadowQuality","util/BoxedVar"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("GraphicsOptions",class{constructor(){this.resolution=new j.BoxedVar(void 0),this.models=new j.BoxedVar(B.ModelQuality.High),this.shadows=new j.BoxedVar(N.ShadowQuality.High)}unserialize(S){let[O,B,N]=S.split(",");var j;return this.models.value=Number(O),this.shadows.value=Number(B),void 0!==N&&(j=N.length?N.split("x").map(S=>Number(S)):void 0,this.resolution.value=j?{width:j[0],height:j[1]}:void 0),this}serialize(){return[this.models.value,this.shadows.value,this.resolution.value?[this.resolution.value.width,this.resolution.value.height].join("x"):""].join(",")}applyLowPreset(){this.models.value=B.ModelQuality.Low,this.shadows.value=N.ShadowQuality.Low}applyHighPreset(){this.models.value=B.ModelQuality.High,this.shadows.value=N.ShadowQuality.High}})}}}),System.register("gui/screen/options/KeyboardScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/options/component/KeyOpts"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("KeyboardScreen",class{constructor(S,O,B){this.strings=S,this.jsxRenderer=O,this.keyBinds=B,this.title=this.strings.get("GUI:KeyboardOptions")}setController(S){this.controller=S}onEnter(){this.isDirty=!1,this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[S]=this.jsxRenderer.render(B.jsx(N.HtmlView,{width:"100%",height:"100%",component:j.KeyOpts,props:{keyBinds:this.keyBinds,strings:this.strings,onHotKeyChange:(S,O)=>{this.keyBinds.changeHotKey(S,O),this.isDirty=!0},onResetAll:async()=>{try{await this.keyBinds.resetAndReload()}catch(S){console.error(S)}}}}));this.controller.setMainComponent(S)}async onLeave(){if(await this.controller.hideSidebarButtons(),this.isDirty){this.isDirty=!1;try{await this.keyBinds.save()}catch(S){console.error(S)}}}})}}}),System.register("gui/screen/options/OptionsScreen",["gui/jsx/jsx","gui/screen/mainMenu/MainMenuController","gui/screen/game/gameMenu/GameMenuController","gui/screen/game/gameMenu/ScreenType","gui/screen/mainMenu/ScreenType","LocalPrefs","gui/jsx/HtmlView","gui/screen/options/component/GeneralOpts"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S}],execute:function(){S("OptionsScreen",class{constructor(S,O,B,N,j,L,D){this.strings=S,this.jsxRenderer=O,this.options=B,this.localPrefs=N,this.fullScreen=j,this.inGame=L,this.storageOptsEnabled=D,this.title=this.strings.get("GUI:Options")}setController(S){this.controller=S}onEnter(){if(this.inGame)try{window.dispatchEvent(new CustomEvent("ra2web:viewportClampMode",{detail:{mode:"menu"}}))}catch{}this.initialOptionsStr=this.options.serialize(),this.controller instanceof N.MainMenuController&&this.controller.toggleMainVideo(!1),this.controller.setSidebarButtons([{label:this.strings.get("GUI:Sound"),onClick:()=>{this.controller instanceof j.GameMenuController?this.controller.pushScreen(L.ScreenType.OptionsSound):this.controller?.pushScreen(D.ScreenType.OptionsSound)}},{label:this.strings.get("GUI:Keyboard"),onClick:()=>{this.controller instanceof j.GameMenuController?this.controller.pushScreen(L.ScreenType.OptionsKeyboard):this.controller?.pushScreen(D.ScreenType.OptionsKeyboard)}},...this.controller instanceof N.MainMenuController&&this.storageOptsEnabled?[{label:this.strings.get("GUI:Storage"),onClick:()=>{this.controller.pushScreen(D.ScreenType.OptionsStorage,{})}},{label:"AI",onClick:()=>{this.controller.pushScreen(D.ScreenType.CustomAiManager,{})}}]:[],{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[S]=this.jsxRenderer.render(B.jsx(_.HtmlView,{width:"100%",height:"100%",component:U.GeneralOpts,props:{options:this.options,fullScreen:this.fullScreen,strings:this.strings,inGame:this.inGame,localPrefs:this.localPrefs}}));this.controller.setMainComponent(S)}async onLeave(){var S=this.options.serialize();if(S!==this.initialOptionsStr&&this.localPrefs.setItem(F.StorageKey.Options,S),await this.controller.hideSidebarButtons(),this.inGame)try{window.dispatchEvent(new CustomEvent("ra2web:viewportClampMode",{detail:{mode:"dynamic"}}))}catch{}}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}})}}}),System.register("gui/screen/options/SoundOptsScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/options/component/SoundOpts","LocalPrefs"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("SoundOptsScreen",class{constructor(S,O,B,N,j){this.strings=S,this.jsxRenderer=O,this.mixer=B,this.music=N,this.localPrefs=j,this.title=this.strings.get("GUI:Sound")}setController(S){this.controller=S}onEnter(){this.initialSettings=this.mixer.serialize(),this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[S]=this.jsxRenderer.render(B.jsx(N.HtmlView,{width:"100%",height:"100%",component:j.SoundOpts,props:{mixer:this.mixer,music:this.music,strings:this.strings}}));this.controller.setMainComponent(S)}async onLeave(){var S=this.mixer.serialize();S!==this.initialSettings&&this.localPrefs.setItem(L.StorageKey.Mixer,S),this.music&&(S=this.music.serializeOptions(),this.localPrefs.setItem(L.StorageKey.MusicOpts,S)),await this.controller.hideSidebarButtons()}})}}}),System.register("gui/screen/options/StorageScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/options/component/StorageExplorer","gui/screen/mainMenu/MainMenuScreen"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends L.MainMenuScreen{constructor(S,O,B,N){super(),this.strings=S,this.jsxRenderer=O,this.messageBoxApi=B,this.rfs=N,this.title=this.strings.get("GUI:Storage")}onEnter(S){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[O]=this.jsxRenderer.render(B.jsx(N.HtmlView,{width:"100%",height:"100%",component:j.StorageExplorer,props:{strings:this.strings,messageBoxApi:this.messageBoxApi,storageDirHandle:this.rfs.getRootDirectoryHandle(),startIn:S?.startIn,onFileSystemChange:()=>{this.controller?.setSidebarButtons([{label:this.strings.get("GUI:ExitAndReload"),isBottom:!0,onClick:()=>{location.reload()}}])}}}));this.controller.setMainComponent(O)}async onLeave(){await this.controller.hideSidebarButtons()}},S("StorageScreen",D)}}}),System.register("gui/screen/options/component/CustomAiManager",["react","engine/Engine","data/vfs/RealFileSystemDir","data/vfs/VirtualFile"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S.Engine},function(S){S.RealFileSystemDir},function(S){S.VirtualFile}],execute:function(){const O="custom-ai-opts-styles";if(!document.getElementById(O)){const S=document.createElement("style");S.id=O,S.textContent="\n        .custom-ai-opts .ai-list-container {\n          margin-top: 15px;\n          max-height: 300px;\n          overflow-y: auto;\n          border: 1px solid #600;\n          background: rgba(0, 0, 0, 0.3);\n        }\n        .custom-ai-opts .ai-list-item {\n          display: flex;\n          align-items: center;\n          padding: 8px 12px;\n          border-bottom: 1px solid #400;\n          cursor: pointer;\n          transition: background 0.15s;\n        }\n        .custom-ai-opts .ai-list-item:last-child {\n          border-bottom: none;\n        }\n        .custom-ai-opts .ai-list-item:hover {\n          background: rgba(255, 0, 0, 0.1);\n        }\n        .custom-ai-opts .ai-list-item.selected {\n          background: rgba(255, 0, 0, 0.2);\n        }\n        .custom-ai-opts .ai-list-item .ai-icon {\n          width: 24px;\n          margin-right: 12px;\n          text-align: center;\n        }\n        .custom-ai-opts .ai-list-item .ai-info {\n          flex: 1;\n        }\n        .custom-ai-opts .ai-list-item .ai-name {\n          font-weight: bold;\n        }\n        .custom-ai-opts .ai-list-item .ai-details {\n          font-size: 11px;\n          color: #999;\n          margin-top: 2px;\n        }\n        .custom-ai-opts .empty-state {\n          padding: 30px;\n          text-align: center;\n          color: #888;\n        }\n        .custom-ai-opts .button-row {\n          margin-top: 15px;\n          display: flex;\n          gap: 10px;\n        }\n        .custom-ai-opts .button-row button {\n          padding: 8px 16px;\n          background: linear-gradient(to bottom, #600 0%, #400 100%);\n          border: 1px solid #800;\n          color: #fff;\n          cursor: pointer;\n          font-size: 13px;\n        }\n        .custom-ai-opts .button-row button:hover {\n          background: linear-gradient(to bottom, #800 0%, #600 100%);\n        }\n        .custom-ai-opts .button-row button:disabled {\n          background: #333;\n          border-color: #444;\n          color: #666;\n          cursor: not-allowed;\n        }\n        .custom-ai-opts .status-message {\n          margin-top: 10px;\n          padding: 8px 12px;\n          font-size: 12px;\n        }\n        .custom-ai-opts .status-message.error {\n          background: rgba(255, 0, 0, 0.2);\n          border: 1px solid #800;\n          color: #f88;\n        }\n        .custom-ai-opts .status-message.success {\n          background: rgba(0, 128, 0, 0.2);\n          border: 1px solid #080;\n          color: #8f8;\n        }\n        .custom-ai-opts .info-text {\n          margin-top: 15px;\n          font-size: 11px;\n          color: #888;\n        }\n      ",document.head.appendChild(S)}S("CustomAiManager",({strings:S,messageBoxApi:O,rfs:j})=>{const[L,D]=B.useState([]),[F,_]=B.useState(!0),[U,H]=B.useState({text:"",type:""}),[V,W]=B.useState(null),z=B.useRef(null),K=B.useCallback(async()=>{try{_(!0);const S=await N.getCustomAiDir();if(!S)return D([]),void _(!1);const O=[];for await(const B of S.getEntries())if(B.toLowerCase().endsWith(".js"))try{const N=await S.getRawFile(B),j=B.replace(/\.js$/i,"");O.push({id:B,filename:B,name:j,size:N.size})}catch(S){console.warn(`Failed to read AI file ${B}:`,S)}D(O)}catch(S){console.error("Failed to load AI list:",S),H({text:"AI: "+S.message,type:"error"})}finally{_(!1)}},[]);B.useEffect(()=>{K()},[K]);const $=L.find(S=>S.id===V);return B.createElement("div",{className:"opts custom-ai-opts"},B.createElement("fieldset",null,B.createElement("legend",null,"AI"),B.createElement("div",{className:"item"},B.createElement("span",{style:{color:"#aaa",fontSize:"12px"}}," AI ")),B.createElement("div",{className:"button-row"},B.createElement("button",{onClick:()=>z.current?.click()},"AI"),B.createElement("input",{ref:z,type:"file",accept:".js",style:{display:"none"},onChange:async B=>{const j=B.target.files;if(!j||0===j.length)return;const D=j[0];if(!D.name.toLowerCase().endsWith(".js"))return H({text:" .js ",type:"error"}),void(B.target.value="");if(0===D.size)return H({text:"",type:"error"}),void(B.target.value="");const F=L.find(S=>S.filename.toLowerCase()===D.name.toLowerCase());if(F){if(!await O.confirm(`AI "${F.name}" `,S.get("GUI:Yes"),S.get("GUI:No")))return void(B.target.value="")}try{H({text:` ${D.name}...`,type:""});const S=await N.getCustomAiDir();if(!S)throw new Error("AI");await S.writeFile(D),H({text:` ${D.name}`,type:"success"}),await K()}catch(S){console.error("Failed to upload AI file:",S),H({text:": "+S.message,type:"error"})}B.target.value=""}}),B.createElement("button",{disabled:!$,onClick:()=>$&&(async S=>{const O=prompt("AI:",S.name);if(!O||O===S.name)return;if(!/^[a-zA-Z0-9_\-\u4e00-\u9fa5]+$/i.test(O))return void H({text:"",type:"error"});const B=O+".js";if(L.some(O=>O.filename.toLowerCase()===B.toLowerCase()&&O.id!==S.id))H({text:"",type:"error"});else try{H({text:"...",type:""});const j=await N.getCustomAiDir(),L=await j.getRawFile(S.filename),D=await L.arrayBuffer(),F=new File([D],B,{type:"application/javascript"});await j.writeFile(F),await j.deleteFile(S.filename),H({text:` ${O}`,type:"success"}),await K()}catch(S){console.error("Failed to rename AI:",S),H({text:": "+S.message,type:"error"})}})($)},""),B.createElement("button",{disabled:!$,onClick:()=>$&&(async B=>{if(await O.confirm(` "${B.name}" `,S.get("GUI:Yes"),S.get("GUI:No")))try{H({text:"...",type:""});const S=await N.getCustomAiDir();await S.deleteFile(B.filename),H({text:` ${B.name}`,type:"success"}),W(null),await K()}catch(S){console.error("Failed to delete AI:",S),H({text:": "+S.message,type:"error"})}})($)},"")),B.createElement("div",{className:"ai-list-container"},F?B.createElement("div",{className:"empty-state"},"..."):0===L.length?B.createElement("div",{className:"empty-state"},"AI",B.createElement("br"),B.createElement("span",{style:{fontSize:"11px"}},'"AI"')):L.map(S=>{return B.createElement("div",{key:S.id,className:"ai-list-item"+(V===S.id?" selected":""),onClick:()=>W(S.id)},B.createElement("div",{className:"ai-icon"},""),B.createElement("div",{className:"ai-info"},B.createElement("div",{className:"ai-name"},S.name),B.createElement("div",{className:"ai-details"},`${S.filename} (${O=S.size,O<1024?O+" B":O<1048576?(O/1024).toFixed(1)+" KB":(O/1048576).toFixed(1)+" MB"})`)));var O})),U.text&&B.createElement("div",{className:"status-message "+U.type},U.text),B.createElement("div",{className:"info-text"},` ${L.length} AI`)))})}}}),System.register("gui/screen/options/component/GeneralOpts",["react","gui/component/Slider","gui/screen/options/GeneralOptions","gui/component/Select","gui/component/Option","engine/renderable/entity/unit/FlyerHelperMode","engine/renderable/entity/unit/ModelQuality","engine/renderable/entity/unit/ShadowQuality","gui/component/Image","gui/screen/options/component/Resolution"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){W=new Map([[1,"TXT_SLOWEST"],[2,"TXT_SLOWER"],[3,"TXT_SLOW"],[4,"TXT_MEDIUM"],[5,"TXT_FAST"],[6,"TXT_FASTER"],[7,"TXT_FASTEST"]]);const O="ra2web.mobileJoystick.enabled";function isMobileDevice(){return"ontouchstart"in window||(navigator.maxTouchPoints??0)>0}function getJoystickEnabled(S){try{let B=S?.getItem?.(O);return null==B?isMobileDevice():"1"===B||"true"===B}catch{return isMobileDevice()}}S("GeneralOpts",({strings:S,options:z,fullScreen:K,inGame:$,localPrefs:q})=>B.createElement("div",{className:"opts general-opts"},B.createElement("fieldset",null,B.createElement("legend",null,S.get("TS:GameplayOpts")),B.createElement("div",{className:"slider-item"},B.createElement("span",{className:"label"},S.get("GUI:ScrollRate")),B.createElement(N.Slider,{min:1,max:7,value:""+Math.floor(z.scrollRate.value/j.SCROLL_BASE_FACTOR),getLabel:O=>S.get(W.get(Number(O))),onChange:S=>z.scrollRate.value=Number(S.target.value)*j.SCROLL_BASE_FACTOR})),B.createElement("div",{className:"item","data-r-tooltip":S.get("STT:MouseAccel")},B.createElement("label",null,B.createElement("span",{className:"label"},S.get("TS:MouseAccel")),B.createElement(L.Select,{initialValue:""+Number(z.mouseAcceleration.value),onSelect:S=>z.mouseAcceleration.value=Boolean(Number(S))},B.createElement(D.Option,{value:"1",label:S.get("TXT_ON")}),B.createElement(D.Option,{value:"0",label:S.get("TXT_OFF")})),B.createElement("span",{className:"info",title:S.get("TS:MouseAccelHint")},B.createElement(H.Image,{src:"info.png"})))),B.createElement("div",{className:"item","data-r-tooltip":S.get("STT:AttackMoveButton")},B.createElement("label",null,B.createElement("span",{className:"label"},S.get("TS:AttackMoveButton")),B.createElement(L.Select,{initialValue:""+Number(z.rightClickMove.value),onSelect:S=>z.rightClickMove.value=Boolean(Number(S))},B.createElement(D.Option,{value:"0",label:S.get("TS:AttackMoveButtonLeft")}),B.createElement(D.Option,{value:"1",label:S.get("TS:AttackMoveButtonRight")})))),B.createElement("div",{className:"item","data-r-tooltip":S.get("STT:RightClickScroll")},B.createElement("label",null,B.createElement("span",{className:"label"},S.get("TS:RightClickScroll")),B.createElement(L.Select,{initialValue:""+Number(z.rightClickScroll.value),onSelect:S=>z.rightClickScroll.value=Boolean(Number(S))},B.createElement(D.Option,{value:"1",label:S.get("TXT_ON")}),B.createElement(D.Option,{value:"0",label:S.get("TXT_OFF")})))),B.createElement("div",{className:"item","data-r-tooltip":S.get("STT:FlyerLabel")},B.createElement("span",{className:"label"},S.get("TS:FlyerLabel")),B.createElement(L.Select,{initialValue:""+z.flyerHelper.value,onSelect:S=>z.flyerHelper.value=Number(S)},B.createElement(D.Option,{value:""+F.FlyerHelperMode.Always,label:S.get("TS:FlyerAlways")}),B.createElement(D.Option,{value:""+F.FlyerHelperMode.Selected,label:S.get("TS:FlyerSelected")}),B.createElement(D.Option,{value:""+F.FlyerHelperMode.Never,label:S.get("TS:FlyerNever")}))),B.createElement("div",{className:"checkbox-grid",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"4px 16px",marginTop:"8px"}},B.createElement("div",{className:"item","data-r-tooltip":S.get("STT:IGGameOptCBoxHidden")},B.createElement("label",null,B.createElement("span",{className:"label"},S.get("GUI:ShowHidden")),B.createElement("input",{type:"checkbox",defaultChecked:z.hiddenObjects.value,onChange:S=>z.hiddenObjects.value=S.target.checked}))),B.createElement("div",{className:"item","data-r-tooltip":S.get("STT:IGGameOptCBoxTargetLines")},B.createElement("label",null,B.createElement("span",{className:"label"},S.get("GUI:TargetLines")),B.createElement("input",{type:"checkbox",defaultChecked:z.targetLines.value,onChange:S=>z.targetLines.value=S.target.checked}))),B.createElement("div",{className:"item","data-r-tooltip":""},B.createElement("label",null,B.createElement("span",{className:"label"},""),B.createElement("input",{type:"checkbox",defaultChecked:getJoystickEnabled(q),onChange:S=>function setJoystickEnabled(S,B){try{S?.setItem?.(O,B?"1":"0"),"undefined"!=typeof window&&window.__ra2webRuntimeVars?.mobileJoystickEnabled&&(window.__ra2webRuntimeVars.mobileJoystickEnabled.value=B)}catch{}}(q,S.target.checked)}))),B.createElement("div",{className:"item"},B.createElement("button",{className:"options-inline-button",type:"button",onClick:()=>function resetJoystickPosition(S){try{S?.removeItem?.("ra2web.mobileJoystick.pos"),"undefined"!=typeof window&&window.__ra2webVirtualJoystick&&window.__ra2webVirtualJoystick.applyPositionFromPrefs?.(),alert("")}catch{}}(q),"data-r-tooltip":""},"")))),B.createElement("fieldset",null,B.createElement("legend",null,S.get("TS:GfxOpts")),B.createElement("div",{className:"item"},B.createElement("span",{className:"label"},S.get("TS:Resolution")),B.createElement(V.ResolutionSelect,{resolution:z.graphics.resolution,fullScreen:K,strings:S}),B.createElement("span",{className:"info",title:S.get("TS:ResolutionHint")},B.createElement(H.Image,{src:"info.png"}))),B.createElement("div",{className:"item","data-r-tooltip":S.get("STT:GfxModels")},B.createElement("span",{className:"label"},S.get("TS:GfxModels")),B.createElement(L.Select,{disabled:$,initialValue:""+z.graphics.models.value,onSelect:S=>z.graphics.models.value=Number(S)},B.createElement(D.Option,{value:""+_.ModelQuality.High,label:S.get("TS:GfxQualityHigh")}),B.createElement(D.Option,{value:""+_.ModelQuality.Low,label:S.get("TS:GfxQualityLow")}))),B.createElement("div",{className:"item","data-r-tooltip":S.get("STT:GfxShadows")},B.createElement("span",{className:"label"},S.get("TS:GfxShadows")),B.createElement(L.Select,{initialValue:""+z.graphics.shadows.value,onSelect:S=>z.graphics.shadows.value=Number(S)},B.createElement(D.Option,{value:""+U.ShadowQuality.High,label:S.get("TS:GfxQualityHigh")}),B.createElement(D.Option,{value:""+U.ShadowQuality.Medium,label:S.get("TS:GfxQualityMed")}),B.createElement(D.Option,{value:""+U.ShadowQuality.Low,label:S.get("TS:GfxQualityLow")}),B.createElement(D.Option,{value:""+U.ShadowQuality.Off,label:S.get("TS:GfxQualityOff")}))))))}}}),System.register("gui/screen/options/component/KeyOpts",["react","gui/screen/options/component/configurableCmds","gui/component/List","gui/screen/options/component/PressKeyInput","gui/screen/options/component/getHumanReadableKey","gui/screen/game/worldInteraction/keyboard/KeyboardHandler"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){S("KeyOpts",({strings:S,keyBinds:O,onResetAll:_,onHotKeyChange:U})=>{let[H,V]=B.useState(),[W,z]=B.useState(),[K,$]=B.useState(),[q,Q]=B.useState(0),[Z,Y]=B.useState();const b=O=>"function"==typeof O?O(S):S.get(O);let X=H&&N.configurableCmds.has(H)?N.configurableCmds.get(H).desc:void 0;var J=X?"function"==typeof X?X(S):S.get(X):void 0,ee=H?O.getHotKey(H):void 0;return B.default.createElement("div",{className:"opts key-opts"},B.default.createElement("div",{className:"key-opts-list"},B.default.createElement("div",{className:"key-opts-left"},B.default.createElement(j.List,{title:S.get("GUI:Commands"),className:"key-list"},[...N.configurableCmds].map(([S,{label:O}])=>B.default.createElement(j.ListItem,{key:S,selected:H===S,onClick:()=>(S=>{V(S),z(void 0),Q(q+1),Y(void 0)})(S)},b(O))))),B.default.createElement("div",{className:"key-opts-right"},B.default.createElement("fieldset",{className:"key-opts-desc-container"},B.default.createElement("legend",null,S.get("GUI:Description")),B.default.createElement("div",{className:"key-opts-desc"},J)))),B.default.createElement("div",{className:"key-opts-assigns"},B.default.createElement("div",{className:"key-opts-cur-assign"},B.default.createElement("div",{className:"key-opts-left","data-r-tooltip":S.get("STT:KeyboardLabelAssigned")},B.default.createElement("div",{className:"key-opts-cur-assign-label"},S.get("GUI:CurrentShortcut")),B.default.createElement("div",{className:"key-opts-cur-assign-value"},ee&&D.getHumanReadableKey(ee))),B.default.createElement("div",{className:"key-opts-right"},Z)),B.default.createElement("div",{className:"key-opts-ch-assign"},B.default.createElement("div",{className:"key-opts-left"},B.default.createElement("div",{className:"key-opts-ch-assign-label"},S.get("GUI:PressShortcut")),B.default.createElement(L.PressKeyInput,{key:q,onChange:S=>{z(S?O.getCommandType(S):void 0),$(S),Y(void 0)},tooltip:S.get("STT:KeyboardEditEntry")}),B.default.createElement("div",{className:"key-opts-ch-assign-current"},B.default.createElement("div",null,S.get("GUI:CurAssignedTo")),B.default.createElement("div",null,W&&N.configurableCmds.has(W)?b(N.configurableCmds.get(W).label):""))),B.default.createElement("div",{className:"key-opts-right"},B.default.createElement("button",{className:"dialog-button",disabled:!H,onClick:()=>{if(H){if(K&&(K.shiftKey||K.ctrlKey||K.altKey||K.metaKey)){if(F.KeyboardHandler.anyModifierCommands.includes(H))return void Y(S.get("Error:CannotMap"));var B=O.getCommandType({keyCode:K.keyCode,altKey:!1,ctrlKey:!1,shiftKey:!1,metaKey:!1});if(void 0!==B&&F.KeyboardHandler.anyModifierCommands.includes(B))return void Y(S.get("Error:CannotRemap"))}U?.(H,K),z(void 0),$(void 0),Q(q+1),Y(void 0)}},"data-r-tooltip":S.get("STT:KeyboardButtonAssign")},S.get("GUI:Assign")),B.default.createElement("button",{className:"dialog-button",onClick:async()=>{V(void 0),z(void 0),$(void 0),Y(void 0),await(_?.()),Q(q+1)},"data-r-tooltip":S.get("STT:KeyboardButtonResetAll")},S.get("GUI:ResetAll")))),B.default.createElement("fieldset",{className:"key-opts-ch-assign-warn"},B.default.createElement("legend",null,S.get("TS:Warning").toLocaleUpperCase()),S.get("TS:HotKeyFSWarning"))))})}}}),System.register("gui/screen/options/component/MusicJukebox",["gui/component/List","react","util/string"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("MusicJukebox",({music:S,strings:O})=>{const[L,D]=N.useState(()=>S.getCurrentPlaylistItem());return N.default.createElement("div",{className:"music-jukebox"},N.default.createElement("div",{className:"jukebox-content"},N.default.createElement("div",{className:"controls"},N.default.createElement("div",null,N.default.createElement("label",null,N.default.createElement("input",{type:"checkbox",defaultChecked:S.getShuffleMode(),onChange:O=>S.setShuffleMode(O.target.checked)}),O.get("GUI:Shuffle"))),N.default.createElement("div",null,N.default.createElement("label",null,N.default.createElement("input",{type:"checkbox",defaultChecked:S.getRepeatMode(),onChange:O=>S.setRepeatMode(O.target.checked)}),O.get("GUI:Repeat")))),N.default.createElement(B.List,{className:"playlist"},S.getPlaylist().map((S,F)=>N.default.createElement(B.ListItem,{key:S.name,selected:S===L,onClick:()=>D(S)},j.pad(F+1,"00")," - ",O.get(S.name))))),N.default.createElement("div",{className:"jukebox-footer"},N.default.createElement("button",{className:"dialog-button",onClick:()=>L&&S.selectPlaylistItem(L)},O.get("GUI:Play")),N.default.createElement("button",{className:"dialog-button",onClick:()=>S.stopPlaying()},O.get("GUI:Stop"))))})}}}),System.register("gui/screen/options/component/PressKeyInput",["gui/FullScreen","react","gui/screen/options/component/getHumanReadableKey"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=S=>S.shiftKey||S.ctrlKey||S.altKey||S.metaKey,D=S=>["Alt","Control","Shift","Meta"].includes(S.key),F=["Escape","Backspace","Enter","Tab","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"," "],S("PressKeyInput",({tooltip:S,onChange:O})=>{const[_,U]=N.useState(),h=S=>{U(S),S&&void 0===S.keyCode||O(S)};var H=_?j.getHumanReadableKey(_):"";return N.default.createElement("input",{type:"text",value:H,"data-r-tooltip":S,onChange:()=>{},onKeyDown:S=>{S.preventDefault(),S.stopPropagation(),S.repeat||255<S.keyCode||(F.includes(S.key)||B.FullScreen.isFullScreenHotKey(S)?h(void 0):h({shiftKey:S.shiftKey,ctrlKey:S.ctrlKey,altKey:S.altKey,metaKey:S.metaKey,keyCode:D(S)?void 0:S.keyCode}))},onKeyUp:S=>{S.preventDefault(),S.stopPropagation(),S.repeat||255<S.keyCode||void 0===_?.keyCode&&D(S)&&h(L(S)?{shiftKey:S.shiftKey,ctrlKey:S.ctrlKey,altKey:S.altKey,metaKey:S.metaKey,keyCode:void 0}:void 0)},onBlur:()=>{_&&void 0===_?.keyCode&&h(void 0)}})})}}}),System.register("gui/screen/options/component/Resolution",["gui/component/Select","gui/component/Option","react"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){L=[{width:1920,height:1080},{width:1600,height:900},{width:1280,height:1024},{width:1366,height:768},{width:1024,height:768},{width:800,height:600}],S("ResolutionSelect",({resolution:S,fullScreen:O,strings:D})=>{const o=S=>S.width+" x "+S.height,l=()=>({width:Math.max(L[L.length-1].width,window.innerWidth),height:Math.max(L[L.length-1].height,window.innerHeight)}),c=S=>L.filter((O,B)=>O.height<=S.height&&O.width<=S.width||B===L.length-1),[F,_]=j.useState(()=>l()),[U,H]=j.useState(S.value),[V,W]=j.useState(()=>c(F));var z=O.isFullScreen(),K=U&&!V.find(S=>S.height===U.height&&S.width===U.width);return j.useEffect(()=>{const t=()=>{var S=l();_(S),W(c(S))};return window.addEventListener("resize",t),S.onChange.subscribe(H),()=>{window.removeEventListener("resize",t),S.onChange.unsubscribe(H)}},[]),z?j.createElement(B.Select,{className:"resolution-select",initialValue:"",disabled:!0,onSelect:()=>{}},j.createElement(N.Option,{value:"",label:D.get("TS:ResolutionFullScreen",o(F))})):j.createElement(B.Select,{className:"resolution-select",initialValue:U?o(U):"",onSelect:O=>{var B=(B=""!==O?O.split(" x ").map(S=>Number(S)):void 0)?{width:B[0],height:B[1]}:void 0;S.value=B}},K&&j.createElement(N.Option,{value:o(U),label:`${o(U)} (${o({width:Math.min(U.width,F.width),height:Math.min(U.height,F.height)})})`}),j.createElement(N.Option,{value:"",label:D.get("TS:ResolutionFit",o(F))}),V.map(S=>{var O=o(S);return j.createElement(N.Option,{key:O,value:O,label:O})}))})}}}),System.register("gui/screen/options/component/SoundOpts",["react","gui/component/Slider","engine/sound/ChannelType","gui/screen/options/component/MusicJukebox"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=new Map([[j.ChannelType.Master,"GUI:MasterVolume"],[j.ChannelType.Music,"GUI:MusicVolume"],[j.ChannelType.Effect,"GUI:SFXVolume"],[j.ChannelType.Voice,"GUI:VoiceVolume"],[j.ChannelType.Ambient,"GUI:AmbientVolume"],[j.ChannelType.Ui,"GUI:UIVolume"],[j.ChannelType.CreditTicks,"GUI:CreditsVolume"]]),S("SoundOpts",({strings:S,music:O,mixer:j})=>B.createElement("div",{className:"opts sound-opts"},B.createElement("div",{className:"sound-sliders"},[...D].map(([O,L])=>B.createElement("div",{className:"slider-item",key:O},B.createElement("span",{className:"label"},S.get(L)),B.createElement(N.Slider,{min:0,max:10,value:""+10*j.getVolume(O),onChange:S=>j.setVolume(O,Number(S.target.value)/10)})))),O&&B.createElement(L.MusicJukebox,{music:O,strings:S})))}}}),System.register("gui/screen/options/component/StorageExplorer",["@puzzl/core/lib/regexp","data/vfs/RealFileSystemDir","data/zip/Zip","engine/Engine","gui/replay/ReplayStorageFileSystem","gui/screen/mainMenu/modSel/ModManager","network/gamestate/Replay","react","util/CssLoader","util/ScriptLoader","util/time"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S}],execute:function(){var O;z=S=>Y.some(O=>"string"==typeof O?S.toLowerCase()===O.toLowerCase():O.test(S)),K=async(S,O)=>{let B=[];for await(var[N,j]of S.entries())B.push({id:N,name:N,type:"directory"===j.kind?"folder":"file",hash:N,attrs:"directory"!==j.kind||z(("/"!==O?O:"")+"/"+N)?void 0:{canmodify:!1},..."file"===j.kind?{size:(await j.getFile()).size}:{}});return B},$=async(S,O,B=!1)=>{let N=O;for(var j of S.slice(1))N=await N.getDirectoryHandle(j,{create:B});return N},q=["/keyboard.ini",/^\/(language|multi|ra2)\.mix$/i,"/"+L.Engine.rfsSettings.menuVideoFileName,"/"+L.Engine.rfsSettings.splashImgFileName,new RegExp(`^/${L.Engine.rfsSettings.musicDir}/([^/]+)\\.mp3$`,"i"),new RegExp(`^/${L.Engine.rfsSettings.replayDir}/(([^/]+)${B.escape(_.Replay.extension)})|(${B.escape(D.ReplayStorageFileSystem.manifestFileName)})$`,"i"),new RegExp(`^/${L.Engine.rfsSettings.tauntsDir}/tau([^/]+)\\.wav$`,"i"),new RegExp(`^/${L.Engine.rfsSettings.modDir}/[^/]+/`,"i"),new RegExp(`^/${L.Engine.rfsSettings.mapDir}/[^/]+\\.(${L.Engine.supportedMapTypes.join("|")})$`,"i"),new RegExp(`^/${L.Engine.rfsSettings.customAiDir}/[^/]+\\.js$`,"i")],Q=["/keyboard.ini",/^\/[^/]+\.mix$/i,new RegExp(`^/${L.Engine.rfsSettings.musicDir}/`,"i"),new RegExp(`^/${L.Engine.rfsSettings.tauntsDir}/`,"i")],Z=[/^\/([^/]+)\.mix$/i,"/"+L.Engine.rfsSettings.menuVideoFileName,"/"+L.Engine.rfsSettings.splashImgFileName,"/"+L.Engine.rfsSettings.musicDir,"/"+L.Engine.rfsSettings.tauntsDir,"/"+L.Engine.rfsSettings.replayDir+"/"+D.ReplayStorageFileSystem.manifestFileName],Y=["/","/"+L.Engine.rfsSettings.replayDir,new RegExp(`^/${L.Engine.rfsSettings.modDir}(/.*)?`),new RegExp(`^/${L.Engine.rfsSettings.mapDir}(/.*)?`),new RegExp(`^/${L.Engine.rfsSettings.customAiDir}(/.*)?`)],X=[L.Engine.rfsSettings.modDir],(O=J=J||{})[O.None=0]="None",O[O.OverwriteAll=1]="OverwriteAll",O[O.SkipAll=2]="SkipAll",S("StorageExplorer",({messageBoxApi:S,storageDirHandle:O,startIn:B,strings:L,onFileSystemChange:D})=>{const _=U.useRef(null);return U.useEffect(()=>{let U,Y,ee=!1,te=J.None,ie=0,re=!1;const x=async()=>{var S,O,B;U&&navigator.storage?.estimate&&(({usage:S,quota:O}=await navigator.storage.estimate()),S&&O&&(B=L.get("GUI:StorageUsed",U.GetDisplayFilesize(S),U.GetDisplayFilesize(O)),U.SetNamedStatusBarText("quota",O<=S?"<font color='red'>"+B+"</font>":B)))},A=async(S,B)=>{if(X.includes(B.GetPathIDs().pop())){let j=prompt(L.get("GUI:NewFolderPrompt"));if(j?.match(F.ModManager.modIdRegex)){try{let D=await $(B.GetPathIDs(),O);if(await new N.RealFileSystemDir(D).containsEntry(j))return void S(L.get("GUI:NewFolderExists"));j=(await D.getDirectoryHandle(j,{create:!0})).name}catch(O){return console.error(O),void S(!1)}S({type:"folder",name:j,id:j,hash:j})}else S(L.get("GUI:NewFolderInvalidName"))}else S(L.get("GUI:NewFolderNotAllowed"))},M=async(B,N,j)=>{let F=[],_=[];var H,V=j.length;for(H of j){let S=[...N.GetPathIDs(),H].join("/");(Z.some(O=>"string"==typeof O?S.toLowerCase()===O.toLowerCase():O.test(S))?F:_).push(S)}if(!_.length||await S.confirm(1===V?L.get("GUI:ConfirmDeleteFile"):L.get("GUI:ConfirmDeleteFiles",V),L.get("GUI:Yes"),L.get("GUI:No"))){if(F.length)for(var W of F)await S.confirm(L.get("GUI:ConfirmDeleteSystemFile",W),L.get("GUI:Yes"),L.get("GUI:No"))&&_.push(W);if(_.length){let S;try{for(var z of _){console.log(`Deleting "${z}"...`);var K=z.substring(0,z.lastIndexOf("/")).split("/");let S=await $(K,O);await S.removeEntry(z.split("/").pop(),{recursive:!0}),console.log(`Deleted "${z}".`)}}catch(B){console.error(B),S=B}B(!!S&&S.message),U?.RefreshFolders(!0),re||(re=!0,D())}else B(!1)}else B(!1)},R=async(B,j)=>{let F=j.folder.GetPathIDs().join("/")+j.fullPath,_=F.substring(0,F.lastIndexOf("/")).split("/"),H=!1;Y&&(clearTimeout(Y),Y=void 0),ie++;let V,W=!1;try{if(q.some(S=>"string"==typeof S?F.toLowerCase()===S.toLowerCase():S.test(F))){for await(var z of(V=await $(_,O,!0),V.keys()))if(z.toLowerCase()===j.file.name.toLowerCase()){var K;te===J.None?(2===(K=await new Promise(O=>{S.show(L.get("GUI:ConfirmOverwriteFile",_.join("/")||"/",j.file.name),[{label:L.get("GUI:Yes"),onClick:()=>O(1)},{label:L.get("GUI:YesToAll"),onClick:()=>O(2)},{label:L.get("GUI:No"),onClick:()=>O(0)},{label:L.get("GUI:Cancel"),onClick:()=>O(-1)}])}))?te=J.OverwriteAll:-1===K&&(te=J.SkipAll),K<=0&&(W=!0)):te===J.SkipAll&&(W=!0);break}}else W=!0;if(W)console.log("File skipped: "+F);else{console.log("Uploading file: "+F),U?.SetNamedStatusBarText("message",L.get("GUI:Uploading",F));let S=j.file.name;Q.some(S=>"string"==typeof S?F.toLowerCase()===S.toLowerCase():S.test(F))&&(S=S.toLowerCase()),await new N.RealFileSystemDir(V).writeFile(j.file,S),H=!0,console.log("File uploaded: "+F)}}catch(B){console.error(B);var Z="QuotaExceededError"===B.name?L.get("GUI:UploadFailedQuota"):L.get("GUI:UploadFailed");U?.SetNamedStatusBarText("message","<font color='red'>"+Z+"</font>",1e4)}ie--,ie||(Y=setTimeout(()=>{te=J.None,U?.SetNamedStatusBarText("message",L.get("GUI:UploadFinished"),2e3)},1e3)),B(!1),U&&H&&(U.RefreshFolders(!0),await x(),re||(re=!0,D()))},P=(B,N,D,F)=>{1!==F.length||"file"!==F[0].type?(async()=>{let B=await SystemJS.import("file-system-access"),D=await B.showSaveFilePicker({suggestedName:"cdexport.zip"}),_=await $(N.GetPathIDs(),O),H=new j.Zip;const u=async(S,O,B)=>{for await(var N of S.values())"directory"===N.kind?await u(N,O+"/"+N.name,B):await B(await N.getFile(),O+"/"+N.name)};let V=new AbortController,z=U.CreateProgressTracker(()=>{try{V.abort()}catch(S){}});z.queueditems=F.length,z.showbyterate=!0;const f=async(S,O)=>{H.startFile(O,S.lastModified);const B=S.stream().getReader();for(;;){var{done:N,value:j}=await B.read();if(N)break;H.appendData(j),await W.sleep(0)}H.endFile(),z.totalbytes+=S.size};var K=setTimeout(()=>{S.show(L.get("GUI:CreatingArchive"),L.get("GUI:Cancel"),()=>{try{z.cancelcallback()}catch(S){console.error(S)}})},1e3);try{await Promise.all([(async()=>{for(var{id:S,type:O}of F){if("folder"===O){var B=await _.getDirectoryHandle(S);await u(B,S,async(S,O)=>{await f(S,O)})}else{let O=await _.getFileHandle(S);B=await O.getFile(),await f(B,S)}z.itemsdone++}H.finish()})(),(async()=>{var S=await D.createWritable();await H.outputStream.pipeTo(S,{signal:V.signal})})()]),console.log("ZIP file saved successfully."),U?.RemoveProgressTracker(z,L.get("GUI:DownloadFinished"))}catch(B){clearTimeout(K),"AbortError"!==B.name?(console.error(B),U?.RemoveProgressTracker(z,L.get("GUI:DownloadFailed")),await S.alert(L.get("GUI:DownloadFailed"),L.get("GUI:OK"))):U?.RemoveProgressTracker(z,L.get("GUI:DownloadAborted"))}finally{clearTimeout(K),S.destroy()}})().catch(S=>{"AbortError"!==S.name&&console.error(S)}):U.OpenSelectedItems()},I=(S,B)=>{(async()=>{let N=await $(S.GetPathIDs(),O),j=await N.getFileHandle(B.id);var L=await j.getFile();let D=await SystemJS.import("file-system-access"),F=await D.showSaveFilePicker({suggestedName:L.name}),_=await F.createWritable();try{await _.write(L),await _.close()}catch(N){throw await _.abort(),N}})().catch(S=>{"AbortError"!==S.name&&console.error(S)})},k=(S,B)=>{(async()=>{var B=await $(S.GetPathIDs(),O);B=await K(B,S.GetPathIDs().join("/")),U?.IsDestroyed()||S.SetEntries(B)})().catch(S=>{console.error(S)})};return(async()=>{S.show(L.get("GUI:LoadingEx"));try{if(await Promise.all([new V.ScriptLoader(document).load("lib/file-explorer/file-explorer.js"),new H.CssLoader(document).load("lib/file-explorer/file-explorer.css")]),ee)return;let S=[["","/",{canmodify:z("/")}]];if(B){let N="";for(var O of B.split("/"))N+="/"+O,S.push([O,O,{canmodify:z(N)}])}U=new window.FileExplorer(_.current,{initpath:S,onrefresh:k,onopenfile:I,concurrentuploads:1,oninitupload:R,oninitdownload:P,onnewfolder:A,ondelete:M}),await x()}finally{S.destroy()}})().catch(S=>console.error(S)),()=>{ee=!0,U?.Destroy(),U=void 0,Y&&clearTimeout(Y)}},[]),U.default.createElement("div",{ref:_,className:"storage-explorer"})})}}}),System.register("gui/screen/options/component/configurableCmds",["gui/screen/game/worldInteraction/keyboard/KeyCommandType"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("configurableCmds",new Map([[B.KeyCommandType.Options,{label:"txt_options",desc:"txt_options_desc"}],[B.KeyCommandType.ToggleAlliance,{label:"txt_alliance",desc:"txt_alliance_desc"}],[B.KeyCommandType.PlaceBeacon,{label:"txt_place_beacon",desc:"txt_place_beacon_desc"}],[B.KeyCommandType.AllToCheer,{label:"cmnd:allcheer",desc:"cmnd:allcheerdesc"}],[B.KeyCommandType.DeployObject,{label:"txt_deploy_object",desc:"txt_deploy_object_desc"}],[B.KeyCommandType.Follow,{label:"txt_follow",desc:"txt_follow_desc"}],[B.KeyCommandType.GuardObject,{label:"txt_guard",desc:"txt_guard_desc"}],[B.KeyCommandType.StopObject,{label:"txt_stop_object",desc:"txt_stop_object_desc"}],[B.KeyCommandType.ScatterObject,{label:"txt_scatter",desc:"txt_scatter_desc"}],[B.KeyCommandType.CenterBase,{label:"txt_center_base",desc:"txt_center_base_desc"}],[B.KeyCommandType.ToggleRepair,{label:"txt_repair_mode",desc:"txt_repair_mode_desc"}],[B.KeyCommandType.ToggleSell,{label:"txt_sell_mode",desc:"txt_sell_mode_desc"}],[B.KeyCommandType.PreviousObject,{label:"txt_prev_object",desc:"txt_prev_object_desc"}],[B.KeyCommandType.NextObject,{label:"txt_next_object",desc:"txt_next_object_desc"}],[B.KeyCommandType.TypeSelect,{label:"cmnd:typeselect",desc:"cmnd:typeselectdesc"}],[B.KeyCommandType.CombatantSelect,{label:"cmnd:combatantselect",desc:"cmnd:combatantselectdesc"}],[B.KeyCommandType.StructureTab,{label:"txt_structure_tab",desc:"txt_structure_tab_desc"}],[B.KeyCommandType.DefenseTab,{label:"txt_defense_tab",desc:"txt_defense_tab_desc"}],[B.KeyCommandType.InfantryTab,{label:"txt_infantry_tab",desc:"txt_infantry_tab_desc"}],[B.KeyCommandType.UnitTab,{label:"txt_unit_tab",desc:"txt_unit_tab_desc"}],[B.KeyCommandType.PlanningMode,{label:"cmnd:planningmode",desc:"cmnd:planningmodedesc"}],[B.KeyCommandType.CenterOnRadarEvent,{label:"txt_radar_event",desc:"txt_radar_event_desc"}],[B.KeyCommandType.HealthNav,{label:"cmnd:healthnavigation",desc:"cmnd:healthnavigationdesc"}],[B.KeyCommandType.VeterancyNav,{label:"cmnd:vetnavigation",desc:"cmnd:vetnavigationdesc"}],[B.KeyCommandType.TeamSelect_1,{label:S=>S.get("txt_select_team",1),desc:S=>S.get("txt_select_team_desc",1)}],[B.KeyCommandType.TeamSelect_2,{label:S=>S.get("txt_select_team",2),desc:S=>S.get("txt_select_team_desc",2)}],[B.KeyCommandType.TeamSelect_3,{label:S=>S.get("txt_select_team",3),desc:S=>S.get("txt_select_team_desc",3)}],[B.KeyCommandType.TeamSelect_4,{label:S=>S.get("txt_select_team",4),desc:S=>S.get("txt_select_team_desc",4)}],[B.KeyCommandType.TeamSelect_5,{label:S=>S.get("txt_select_team",5),desc:S=>S.get("txt_select_team_desc",5)}],[B.KeyCommandType.TeamSelect_6,{label:S=>S.get("txt_select_team",6),desc:S=>S.get("txt_select_team_desc",6)}],[B.KeyCommandType.TeamSelect_7,{label:S=>S.get("txt_select_team",7),desc:S=>S.get("txt_select_team_desc",7)}],[B.KeyCommandType.TeamSelect_8,{label:S=>S.get("txt_select_team",8),desc:S=>S.get("txt_select_team_desc",8)}],[B.KeyCommandType.TeamSelect_9,{label:S=>S.get("txt_select_team",9),desc:S=>S.get("txt_select_team_desc",9)}],[B.KeyCommandType.TeamSelect_10,{label:S=>S.get("txt_select_team",10),desc:S=>S.get("txt_select_team_desc",10)}],[B.KeyCommandType.TeamCreate_1,{label:S=>S.get("txt_create_team",1),desc:S=>S.get("txt_create_team_desc",1)}],[B.KeyCommandType.TeamCreate_2,{label:S=>S.get("txt_create_team",2),desc:S=>S.get("txt_create_team_desc",2)}],[B.KeyCommandType.TeamCreate_3,{label:S=>S.get("txt_create_team",3),desc:S=>S.get("txt_create_team_desc",3)}],[B.KeyCommandType.TeamCreate_4,{label:S=>S.get("txt_create_team",4),desc:S=>S.get("txt_create_team_desc",4)}],[B.KeyCommandType.TeamCreate_5,{label:S=>S.get("txt_create_team",5),desc:S=>S.get("txt_create_team_desc",5)}],[B.KeyCommandType.TeamCreate_6,{label:S=>S.get("txt_create_team",6),desc:S=>S.get("txt_create_team_desc",6)}],[B.KeyCommandType.TeamCreate_7,{label:S=>S.get("txt_create_team",7),desc:S=>S.get("txt_create_team_desc",7)}],[B.KeyCommandType.TeamCreate_8,{label:S=>S.get("txt_create_team",8),desc:S=>S.get("txt_create_team_desc",8)}],[B.KeyCommandType.TeamCreate_9,{label:S=>S.get("txt_create_team",9),desc:S=>S.get("txt_create_team_desc",9)}],[B.KeyCommandType.TeamCreate_10,{label:S=>S.get("txt_create_team",10),desc:S=>S.get("txt_create_team_desc",10)}],[B.KeyCommandType.TeamAddSelect_1,{label:S=>S.get("txt_add_select_team",1),desc:S=>S.get("txt_add_select_team_desc",1)}],[B.KeyCommandType.TeamAddSelect_2,{label:S=>S.get("txt_add_select_team",2),desc:S=>S.get("txt_add_select_team_desc",2)}],[B.KeyCommandType.TeamAddSelect_3,{label:S=>S.get("txt_add_select_team",3),desc:S=>S.get("txt_add_select_team_desc",3)}],[B.KeyCommandType.TeamAddSelect_4,{label:S=>S.get("txt_add_select_team",4),desc:S=>S.get("txt_add_select_team_desc",4)}],[B.KeyCommandType.TeamAddSelect_5,{label:S=>S.get("txt_add_select_team",5),desc:S=>S.get("txt_add_select_team_desc",5)}],[B.KeyCommandType.TeamAddSelect_6,{label:S=>S.get("txt_add_select_team",6),desc:S=>S.get("txt_add_select_team_desc",6)}],[B.KeyCommandType.TeamAddSelect_7,{label:S=>S.get("txt_add_select_team",7),desc:S=>S.get("txt_add_select_team_desc",7)}],[B.KeyCommandType.TeamAddSelect_8,{label:S=>S.get("txt_add_select_team",8),desc:S=>S.get("txt_add_select_team_desc",8)}],[B.KeyCommandType.TeamAddSelect_9,{label:S=>S.get("txt_add_select_team",9),desc:S=>S.get("txt_add_select_team_desc",9)}],[B.KeyCommandType.TeamAddSelect_10,{label:S=>S.get("txt_add_select_team",10),desc:S=>S.get("txt_add_select_team_desc",10)}],[B.KeyCommandType.TeamCenter_1,{label:S=>S.get("txt_center_team",1),desc:S=>S.get("txt_center_team_desc",1)}],[B.KeyCommandType.TeamCenter_2,{label:S=>S.get("txt_center_team",2),desc:S=>S.get("txt_center_team_desc",2)}],[B.KeyCommandType.TeamCenter_3,{label:S=>S.get("txt_center_team",3),desc:S=>S.get("txt_center_team_desc",3)}],[B.KeyCommandType.TeamCenter_4,{label:S=>S.get("txt_center_team",4),desc:S=>S.get("txt_center_team_desc",4)}],[B.KeyCommandType.TeamCenter_5,{label:S=>S.get("txt_center_team",5),desc:S=>S.get("txt_center_team_desc",5)}],[B.KeyCommandType.TeamCenter_6,{label:S=>S.get("txt_center_team",6),desc:S=>S.get("txt_center_team_desc",6)}],[B.KeyCommandType.TeamCenter_7,{label:S=>S.get("txt_center_team",7),desc:S=>S.get("txt_center_team_desc",7)}],[B.KeyCommandType.TeamCenter_8,{label:S=>S.get("txt_center_team",8),desc:S=>S.get("txt_center_team_desc",8)}],[B.KeyCommandType.TeamCenter_9,{label:S=>S.get("txt_center_team",9),desc:S=>S.get("txt_center_team_desc",9)}],[B.KeyCommandType.TeamCenter_10,{label:S=>S.get("txt_center_team",10),desc:S=>S.get("txt_center_team_desc",10)}],[B.KeyCommandType.CenterView,{label:"txt_center_view",desc:"txt_center_view_desc"}],[B.KeyCommandType.View1,{label:"txt_view_bookmark1",desc:"txt_view_bookmark1_desc"}],[B.KeyCommandType.View2,{label:"txt_view_bookmark2",desc:"txt_view_bookmark2_desc"}],[B.KeyCommandType.View3,{label:"txt_view_bookmark3",desc:"txt_view_bookmark3_desc"}],[B.KeyCommandType.View4,{label:"txt_view_bookmark4",desc:"txt_view_bookmark4_desc"}],[B.KeyCommandType.SetView1,{label:"txt_set_bookmark1",desc:"txt_set_bookmark1_desc"}],[B.KeyCommandType.SetView2,{label:"txt_set_bookmark2",desc:"txt_set_bookmark2_desc"}],[B.KeyCommandType.SetView3,{label:"txt_set_bookmark3",desc:"txt_set_bookmark3_desc"}],[B.KeyCommandType.SetView4,{label:"txt_set_bookmark4",desc:"txt_set_bookmark4_desc"}],[B.KeyCommandType.Taunt_1,{label:S=>S.get("txt_taunt_number",1),desc:S=>S.get("txt_taunt_desc",1)}],[B.KeyCommandType.Taunt_2,{label:S=>S.get("txt_taunt_number",2),desc:S=>S.get("txt_taunt_desc",2)}],[B.KeyCommandType.Taunt_3,{label:S=>S.get("txt_taunt_number",3),desc:S=>S.get("txt_taunt_desc",3)}],[B.KeyCommandType.Taunt_4,{label:S=>S.get("txt_taunt_number",4),desc:S=>S.get("txt_taunt_desc",4)}],[B.KeyCommandType.Taunt_5,{label:S=>S.get("txt_taunt_number",5),desc:S=>S.get("txt_taunt_desc",5)}],[B.KeyCommandType.Taunt_6,{label:S=>S.get("txt_taunt_number",6),desc:S=>S.get("txt_taunt_desc",6)}],[B.KeyCommandType.Taunt_7,{label:S=>S.get("txt_taunt_number",7),desc:S=>S.get("txt_taunt_desc",7)}],[B.KeyCommandType.Taunt_8,{label:S=>S.get("txt_taunt_number",8),desc:S=>S.get("txt_taunt_desc",8)}],[B.KeyCommandType.Delete,{label:"cmnd:delete",desc:"cmnd:deletedesc"}],[B.KeyCommandType.PageUser,{label:"txt_pageuser",desc:"txt_pageuser_desc"}],[B.KeyCommandType.SidebarPageUp,{label:"txt_sidebar_pgup",desc:"txt_sidebar_pgup_desc"}],[B.KeyCommandType.SidebarUp,{label:"txt_sidebar_up",desc:"txt_sidebar_up_desc"}],[B.KeyCommandType.SidebarPageDown,{label:"txt_sidebar_pgdn",desc:"txt_sidebar_pgdn_desc"}],[B.KeyCommandType.SidebarDown,{label:"txt_sidebar_down",desc:"txt_sidebar_down_desc"}],[B.KeyCommandType.ToggleFps,{label:"cmnd:togglefps",desc:"cmnd:togglefpsdesc"}]]))}}}),System.register("gui/screen/options/component/getHumanReadableKey",["util/keyNames","util/userAgent"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("getHumanReadableKey",S=>{var O=N.isMac()||N.isIpad();let j=[];return S.ctrlKey&&j.push("Ctrl"),S.altKey&&j.push(O?"":"Alt"),S.shiftKey&&j.push("Shift"),S.metaKey&&j.push(O?"":"Win"),void 0!==S.keyCode?(j.push(B.getKeyName(S.keyCode)),j.join("+")):j.join("+")+"+"})}}}),System.register("gui/screen/replay/KeepReplayBox",["react","gui/component/Dialog","network/gamestate/Replay"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("KeepReplayBox",({defaultName:S,strings:O,viewport:L,onSubmit:D,onDismiss:F})=>{let _=B.useRef(null),[U,H]=B.useState(!1);B.useEffect(()=>{setTimeout(()=>{_.current?.focus(),_.current?.setSelectionRange(0,_.current.value.length)},50)},[]);var u=S=>{S&&S.preventDefault();var O=_.current.value;O&&(H(!0),D(O))};return B.default.createElement(N.Dialog,{className:"keep-replay-box",hidden:U,viewport:L,zIndex:100,buttons:[{label:O.get("GUI:Ok"),onClick:u},{label:O.get("GUI:Cancel"),onClick:()=>{H(!0),F?.()}}]},B.default.createElement("form",{onSubmit:u},B.default.createElement("div",{className:"field"},B.default.createElement("label",null,O.get("GUI:ReplayNamePrompt")),B.default.createElement("input",{type:"text",name:"replayname",autoComplete:"off",ref:_,defaultValue:S,maxLength:j.Replay.maxNameLength})),B.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))})}}}),System.register("gui/screen/replay/ReplayDetailsPane",["react","util/format"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("ReplayDetailsPane",({replayDetails:{engineVersion:S,durationSeconds:O,gameId:j,gameTimestamp:L,mapName:D,players:F},strings:_})=>B.createElement("div",{className:"replay-details"},B.createElement("table",null,B.createElement("tbody",null,L?B.createElement("tr",null,B.createElement("td",null,_.get("GUI:ReplayTime"),":"),B.createElement("td",{dir:"auto"},new Date(L*(String(L).length<13?1e3:1)).toLocaleString())):null,B.createElement("tr",null,B.createElement("td",null,_.get("GUI:GameVersion"),":"),B.createElement("td",null,S)),"0"!==j?B.createElement("tr",null,B.createElement("td",null,_.get("GUI:GameID"),":"),B.createElement("td",null,j)):null,void 0!==D&&B.createElement("tr",null,B.createElement("td",null,_.get("GUI:Map"),":"),B.createElement("td",null,D)),F&&B.createElement("tr",null,B.createElement("td",null,_.get("GUI:Players"),":"),B.createElement("td",null,F.map((S,O)=>B.createElement(B.Fragment,{key:S.name},O?", ":"",B.createElement("span",{style:{color:S.color}},S.name))))),void 0!==O&&B.createElement("tr",null,B.createElement("td",null,_.get("GUI:Duration"),":"),B.createElement("td",null,N.formatTimeDuration(O)))))))}}}),System.register("gui/screen/replay/ReplayScreen",["engine/Engine","gui/screen/game/component/hud/viewmodel/SidebarModel","tools/DevToolsApi","engine/GameAnimationLoop","util/disposable/CompositeDisposable","gui/screen/game/SoundHandler","gui/screen/game/worldInteraction/WorldInteractionFactory","gui/screen/game/ObserverUi","gui/screen/game/GameMenu","gui/screen/game/WorldView","engine/sound/Eva","engine/sound/EvaSpecs","gui/screen/game/HudFactory","gui/screen/game/component/Minimap","game/SideType","network/gamestate/ReplayTurnManager","game/action/ActionFactory","game/action/ActionFactoryReg","gui/screen/game/component/hud/viewmodel/MessageList","engine/sound/Music","network/gamestate/replay/ChatMessageReplayEvent","engine/sound/SoundKey","engine/sound/ChannelType","network/gamestate/replay/TauntReplayEvent","gui/screen/game/TauntPlayback","gui/screen/game/component/hud/commandBar/CommandBarButtonType","util/userAgent","gui/screen/RootScreen","gui/screen/game/loadingScreen/LoadingScreenApiFactory","data/MapFile","engine/ResourceLoader","engine/MapDigest","gui/chat/ChatHistory"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S}],execute:function(){ge=class extends oe.RootScreen{constructor(S,O,B,N,j,L,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne){super(),this.engineVersion=S,this.engineModHash=O,this.errorHandler=B,this.gameMenuSubScreens=N,this.loadingScreenApiFactory=j,this.config=L,this.strings=F,this.renderer=_,this.uiScene=U,this.runtimeVars=H,this.messageBoxApi=V,this.uiAnimationLoop=W,this.viewport=z,this.jsxRenderer=K,this.pointer=$,this.sound=q,this.music=Q,this.keyBinds=Z,this.generalOptions=Y,this.actionLogger=X,this.fullScreen=J,this.mapFileLoader=ee,this.gameLoader=te,this.vxlGeometryPool=ie,this.buildingImageDataCache=re,this.leaveAction=se,this.battleControlApi=ne,this.preventUnload=!0,this.disposables=new D.CompositeDisposable}async onEnter(S){try{window.dispatchEvent(new CustomEvent("ra2web:viewportClampMode",{detail:{mode:"menu"}}))}catch{}this.params=S,this.disposables.add(()=>this.params=void 0),this.pointer.lock(),this.pointer.setVisible(!1),await(this.music?.play(J.MusicType.Loading));var{gameId:O,gameTimestamp:L,gameOpts:D,engineVersion:F,modHash:_}=S.replay;let U;if(F!==this.engineVersion?U=this.strings.get("GUI:ReplayVersionMismatch",F):_!==this.engineModHash&&(U=this.strings.get("GUI:ReplayModMismatch")),U)this.messageBoxApi.show(U,this.strings.get("GUI:Ok"),()=>{this.leaveAction()});else{let z;F=this.loadingScreenApiFactory.create(le.LoadingScreenType.Replay),this.loadingScreenApi=F,this.disposables.add(F,()=>this.loadingScreenApi=void 0),_=D.mapName;try{var H=await this.mapFileLoader.load(_);if(ue.MapDigest.compute(H)!==D.mapDigest)return void this.handleError("Map digest mismatch",this.strings.get("TS:MapMismatch",_));var W=new ce.MapFile(H);z=await this.gameLoader.load(O,L,D,W,void 0,1===D.humanPlayers.length,F)}catch(U){let S;return U.message?.match(/memory|allocation/i)?S=this.strings.get("TS:GameInitOom"):U instanceof he.DownloadError?S=this.strings.get("TS:MapNotFound",_):(S=this.strings.get("TS:GameInitError"),D.mapOfficial||(S+="\n\n"+this.strings.get("TS:CustomMapCrash"))),void this.handleError(U,S)}let{game:q,theater:J,hudSide:te,cameoFilenames:ie}=z;this.game=q,this.baseSpeed=this.game.speed.value,this.disposables.add(()=>this.game=void 0),this.disposables.add(()=>{B.Engine.unloadTheater(J.type),this.gameLoader.clearStaticCaches()}),this.disposables.add(q),F=new N.SidebarModel(q,S.replay);let ae=new X.MessageList(q.rules.audioVisual.messageDuration,6,void 0);_=new de.ChatHistory,this.sidebarModel=F,this.disposables.add(()=>this.sidebarModel=void 0),this.messageList=ae,this.disposables.add(()=>this.messageList=void 0),D=[ne.CommandBarButtonType.ReplayRewind,ne.CommandBarButtonType.ReplayPlay,ne.CommandBarButtonType.ReplayPause,ne.CommandBarButtonType.ReplaySpeed],this.hudFactory=new K.HudFactory(te,this.uiScene,F,ae,_,q.debugText,this.runtimeVars.debugText,void 0,q.getCombatants(),q.stalemateDetectTrait,q.countdownTimer,ie,this.jsxRenderer,this.strings,D),this.disposables.add(()=>this.hudFactory=void 0);let oe=this.hudFactory.create();this.hud=oe;let ge=this.minimap=new $.Minimap(q,void 0,oe.getTextColor(),q.rules.general.radar);oe.setMinimap(ge),this.disposables.add(ge,()=>this.minimap=void 0),ge.setPointerEvents(this.pointer.pointerEvents),D={width:oe.sidebarWidth,height:oe.actionBarHeight};let pe=new V.WorldView(D,q,this.sound,this.renderer,this.runtimeVars,ge,this.strings,this.generalOptions,this.vxlGeometryPool,this.buildingImageDataCache),{worldScene:me,worldSound:fe,renderableManager:ye}=pe.init(void 0,this.viewport.value,J);this.worldView=pe,this.disposables.add(pe,()=>this.worldView=void 0),me.create3DObject(),D=new Z.ActionFactory,(new Y.ActionFactoryReg).register(D,q,void 0);let Te=this.gameTurnMgr=new Q.ReplayTurnManager(q,S.replay,D,this.actionLogger);this.gameTurnMgr.init();let ve=new se.TauntPlayback(this.sound.audioSystem,B.Engine.getTaunts());const G=S=>{if(S instanceof ee.ChatMessageReplayEvent){var O=S.payload;let N=q.getPlayer(O.playerId);var B=this.strings.get("TS:ReplayChatFrom",N.name)+" "+O.message;O=N.color.asHexString(),ae.addChatMessage(B,O)}else S instanceof re.TauntReplayEvent&&(B=S.payload,O=q.getPlayer(B.playerId),B=B.tauntNo,ve.playTaunt(O,B).catch(S=>console.error(S)))};Te.onReplayEvent.subscribe(G),this.disposables.add(()=>Te.onReplayEvent.unsubscribe(G)),this.onGameStart(q,ge,ae,me,fe,ye),j.DevToolsApi.registerCommand("reset",async()=>{await this.onLeave(),await this.onEnter(S)}),j.DevToolsApi.registerVar("speed",q.desiredSpeed),this.disposables.add(()=>j.DevToolsApi.unregisterCommand("reset"),()=>j.DevToolsApi.unregisterVar("speed"))}}onViewportChange(){this.loadingScreenApi?.updateViewport(),this.rerenderHud()}rerenderHud(){if(this.hud){this.uiScene.remove(this.hud),this.hud.destroy(),this.hudFactory.setSidebarModel(this.sidebarModel);let S=this.hudFactory.create();this.hud=S,S.setMinimap(this.minimap),this.worldView&&(this.uiScene.add(S),this.menu?.handleHudChange(S),this.worldView.handleViewportChange(this.viewport.value),this.playerUi?.handleHudChange(S),this.initHudEvents(S,this.messageList))}}onGameStart(S,O,N,j,D,F){try{window.dispatchEvent(new CustomEvent("ra2web:viewportClampMode",{detail:{mode:"dynamic"}}))}catch{}this.loadingScreenApi?.dispose(),this.music?.play(J.MusicType.Normal);var _=new z.EvaSpecs(q.SideType.GDI).readIni(B.Engine.getIni("eva.ini"));let U=new W.Eva(_,this.sound,this.renderer);U.init(),this.disposables.add(U);try{this.initUi(S,j,D,U,F,O,N)}catch(O){return _=O.message?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):this.strings.get("TS:GameInitError"),void this.handleError(O,_)}this.renderer.removeScene(this.uiScene),this.renderer.addScene(j),this.renderer.addScene(this.uiScene),this.pointer.setVisible(!0),S.start(),this.gameAnimationLoop=new L.GameAnimationLoop(void 0,this.renderer,this.sound,this.gameTurnMgr,{skipFrames:!0,skipBudgetMillis:8,onError:this.config.devMode?void 0:(O,B)=>this.handleError(O,this.strings.get("TS:GameCrashed")+(B||S.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash")),B)}),this.uiAnimationLoop.stop(),this.gameAnimationLoop.start()}initUi(S,O,B,N,j,L,D){let V=new F.SoundHandler(S,B,N,this.sound,S.events,D,this.strings,void 0);if(V.init(),this.disposables.add(V),D.onNewMessage.subscribe(S=>{S.animate&&this.sound.play(te.SoundKey.IncomingMessage,ie.ChannelType.Ui)}),ae.isIpad()){let e=S=>{this.sidebarModel.topTextLeftAlign=S};this.fullScreen.onChange.subscribe(e),this.disposables.add(()=>this.fullScreen.onChange.unsubscribe(e))}this.uiScene.add(this.hud),this.initHudEvents(this.hud,D);let W=this.menu=new H.GameMenu(this.gameMenuSubScreens,S,void 0,void 0,void 0,!0);W.init(this.hud),this.initGameMenuEvents(W),this.disposables.add(W,()=>this.menu=void 0);var z=S.getUnitSelection(),K=this.runtimeVars.freeCamera,$=this.runtimeVars.debugPaths,q=this.runtimeVars.debugText,Q=this.config.devMode;Q=new _.WorldInteractionFactory(void 0,S,z,j,this.uiScene,O,this.pointer,this.renderer,this.keyBinds,this.generalOptions,K,$,Q,document,L,this.strings,this.hud.getTextColor(),q,this.battleControlApi),q=this.config.discordUrl,(this.playerUi=new U.ObserverUi(S,void 0,this.sidebarModel,this.params.replay,this.renderer,O,this.sound,Q,W,this.runtimeVars,this.strings,j,this.messageBoxApi,q)).onPlayerChange.subscribe(({player:S,sidebarModel:O})=>{this.sidebarModel=O,this.rerenderHud(),this.worldView?.changeLocalPlayer(S),this.minimap.changeLocalPlayer(S)}),this.playerUi.init(this.hud),this.disposables.add(this.playerUi,()=>this.playerUi=void 0)}initGameMenuEvents(S){S.onOpen.subscribe(()=>{this.pointer.unlock(),this.playerUi.worldInteraction.setEnabled(!1)}),S.onQuit.subscribe(async()=>{this.playerUi.dispose(),this.gameTurnMgr.dispose(),this.leaveAction()}),S.onCancel.subscribe(()=>{this.pointer.lock(),this.playerUi.worldInteraction.setEnabled(!0)})}initHudEvents(S,O){S.onCommandBarButtonClick.subscribe(S=>{switch(this.sound.play(te.SoundKey.GenericClick,ie.ChannelType.Ui),S){case ne.CommandBarButtonType.ReplayRewind:(async()=>{var S=this.params;await this.onLeave(),await this.onEnter(S)})().catch(S=>console.error(S));break;case ne.CommandBarButtonType.ReplayPlay:this.game.desiredSpeed.value=this.baseSpeed,this.game.speed.value===Number.EPSILON?this.gameTurnMgr.doGameTurn(performance.now()):this.game.speed.value!==this.baseSpeed&&O.addSystemMessage(this.strings.get("TS:ReplaySpeedConfirm","1x"),"grey");break;case ne.CommandBarButtonType.ReplayPause:this.game.desiredSpeed.value=Number.EPSILON;break;case ne.CommandBarButtonType.ReplaySpeed:{this.game.speed.value===Number.EPSILON&&(this.game.desiredSpeed.value=this.baseSpeed,this.gameTurnMgr.doGameTurn(performance.now()));let S=Math.floor(this.game.desiredSpeed.value/this.baseSpeed);S=16===S?1:2*S,this.game.desiredSpeed.value=S*this.baseSpeed,O.addSystemMessage(this.strings.get("TS:ReplaySpeedConfirm",S+"x"),"grey");break}default:console.warn("Unhandled command type "+S)}})}async onLeave(){this.pointer.unlock(),this.gameAnimationLoop&&(this.gameAnimationLoop.destroy(),this.gameAnimationLoop=void 0,this.uiAnimationLoop.start()),this.hud&&(this.uiScene.remove(this.hud),this.hud.destroy(),this.hud=void 0),this.gameTurnMgr?.dispose(),this.gameTurnMgr=void 0,this.disposables.dispose()}handleError(S,O,B){this.gameTurnMgr&&this.gameTurnMgr.setErrorState(),this.pointer.unlock(),this.errorHandler.handle(S,O,B?void 0:()=>{this.leaveAction()}),B&&this.playerUi?.dispose()}},S("ReplayScreen",ge)}}}),System.register("gui/screen/replay/ReplaySel",["react","gui/component/List","gui/screen/replay/StorageWarning","gui/screen/replay/ReplayDetailsPane"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("ReplaySel",({strings:S,replays:O,selectedReplay:D,selectedReplayDetails:F,onSelectReplay:_})=>{const U=B.useRef(null);return B.useEffect(()=>{U.current?.scrollIntoView()},[]),B.default.createElement("div",{className:"replay-sel-form"},B.default.createElement(N.List,{title:S.get("GUI:SelectReplay"),className:"replay-list"},O?O.map(S=>{var O=S.id===D?.id;return B.default.createElement(N.ListItem,{key:S.id,selected:O,innerRef:O?U:null,onClick:()=>_(S),onDoubleClick:()=>_(S,!0),style:{display:"flex"}},B.default.createElement("div",{className:"replay-name"},S.keep?"":"* ",S.name),B.default.createElement("div",{className:"replay-time",dir:"auto"},new Date(S.timestamp).toLocaleString()))}):B.default.createElement(N.ListItem,{style:{textAlign:"center"}},S.get("GUI:LoadingEx"))),F&&B.default.createElement(L.ReplayDetailsPane,{replayDetails:F,strings:S}),B.default.createElement(j.StorageWarning,{strings:S}))})}}}),System.register("gui/screen/replay/ReplaySelScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/replay/ReplaySel","network/gamestate/Replay","gui/screen/ScreenType","gui/screen/replay/KeepReplayBox","util/disposable/CompositeDisposable","gui/replay/ReplayStorageError","engine/ResourceLoader","data/vfs/StorageQuotaError","@puzzl/core/lib/async/Task","network/gameopt/Parser","game/GameSpeed","gui/replay/ReplayExistsError","gui/screen/mainMenu/MainMenuScreen","@puzzl/core/lib/async/cancellation","data/vfs/IOError","data/vfs/FileNotFoundError","RouteHelper","game/gameopts/GameOptRandomGen","game/gameopts/constants"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S}],execute:function(){te=class extends q.MainMenuScreen{constructor(S,O,B,N,j,L,D,F,U,H,V,W,z){super(),this.engineVersion=S,this.engineModHash=O,this.activeMod=B,this.oldClientsBaseUrl=N,this.rootController=j,this.strings=L,this.jsxRenderer=D,this.errorHandler=F,this.messageBoxApi=U,this.replayManager=H,this.uiScene=V,this.rules=W,this.sentry=z,this.title=this.strings.get("GUI:Replays"),this.disposables=new _.CompositeDisposable,this.handleSelectReplay=(S,O)=>{var B=this.selectedReplay?.id!==S.id;this.selectedReplay=S,B&&this.updateSidebarButtons(),this.form.applyOptions(O=>{O.selectedReplay=S,O.selectedReplayDetails=void 0}),O?this.loadSelectedReplay():this.loadReplayDetails(S)}}async onEnter(){this.availableReplays=[],this.controller.toggleMainVideo(!1),this.initForm();try{this.availableReplays=await this.replayManager.loadList(!0)}catch(S){return S instanceof Z.IOError||S instanceof Y.FileNotFoundError||S instanceof V.StorageQuotaError||this.sentry?.captureException(new Error(`Failed to load replay list (${S.name??S.message})`,{cause:S})),void this.handleError(S,this.strings.get("GUI:ReplayListError"))}this.selectedReplay=this.availableReplays[0],this.form.applyOptions(S=>{S.replays=this.availableReplays,S.selectedReplay=this.selectedReplay}),void 0!==this.selectedReplay&&this.loadReplayDetails(this.selectedReplay),this.initSidebar(),this.initFileInput()}initForm(){this.controller.setMainComponent(this.jsxRenderer.render(B.jsx(N.HtmlView,{innerRef:S=>this.form=S,component:j.ReplaySel,props:{strings:this.strings,replays:void 0,selectedReplay:void 0,selectedReplayDetails:void 0,onSelectReplay:this.handleSelectReplay}}))[0])}initFileInput(){let S=this.fileInput=document.createElement("input");S.setAttribute("type","file"),S.setAttribute("accept",L.Replay.extension),S.setAttribute("style","display: none"),document.body.appendChild(S);const t=async()=>{var S=this.fileInput.files?.[0];if(S)try{await this.replayManager.importReplay(S),this.availableReplays=await this.replayManager.loadList(),this.form.applyOptions(S=>S.replays=this.availableReplays)}catch(S){let O;O=S instanceof V.StorageQuotaError?this.strings.get("ts:storage_quota_exceeded"):S instanceof U.ReplayStorageError?this.strings.get("GUI:SaveReplayError"):this.strings.get("GUI:ImportReplayError"),this.errorHandler.handle(S,O,()=>{})}};S.addEventListener("change",t),this.disposables.add(()=>{this.fileInput&&document.body.removeChild(this.fileInput),this.fileInput.removeEventListener("change",t),this.fileInput=void 0})}initSidebar(){this.updateSidebarButtons(),this.controller.showSidebarButtons()}updateSidebarButtons(){let S=this.getSelectedReplayMeta();this.controller?.setSidebarButtons([{label:this.strings.get("GUI:LoadReplay"),disabled:!this.selectedReplay,onClick:()=>{this.loadSelectedReplay()}},{label:this.strings.get(S?.keep?"GUI:RenameReplay":"GUI:KeepReplay"),tooltip:S?.keep?void 0:this.strings.get("STT:KeepReplay"),disabled:!this.selectedReplay,onClick:()=>{this.showKeepReplayBox(S.name,O=>{this.replayManager.keepReplay(S.id,O).then(async()=>{this.availableReplays=await this.replayManager.loadList(),this.selectedReplay=this.getSelectedReplayMeta(),this.form.applyOptions(S=>S.replays=this.availableReplays),this.updateSidebarButtons()}).catch(S=>{let O;O=S instanceof $.ReplayExistsError?this.strings.get("GUI:ReplayExistsError"):this.strings.get("GUI:SaveReplayError"),this.errorHandler.handle(S,O,()=>{})})})}},{label:this.strings.get("GUI:ImportReplay"),tooltip:this.strings.get("STT:ImportReplay"),onClick:()=>{if(void 0!==this.fileInput.click)this.fileInput.click();else{let S=document.createEvent("Event");S.initEvent("click",!0,!0),this.fileInput.dispatchEvent(S)}}},{label:this.strings.get("GUI:ExportReplay"),tooltip:this.strings.get("STT:ExportReplay"),disabled:!this.selectedReplay,onClick:()=>{this.exportCurrentReplay().catch(S=>this.errorHandler.handle(S,this.strings.get("GUI:ReplayError"),()=>{}))}},{label:this.strings.get("GUI:DeleteReplay"),disabled:!this.selectedReplay,onClick:async()=>{var S=this.getSelectedReplayMeta();if(await this.messageBoxApi.confirm(this.strings.get("GUI:ConfirmDeleteReplay",S.name),this.strings.get("GUI:Ok"),this.strings.get("GUI:Cancel"))){try{await this.replayManager.deleteReplay(S)}catch(O){return S=O instanceof V.StorageQuotaError?this.strings.get("ts:storage_quota_exceeded"):this.strings.get("GUI:DeleteReplayError"),void this.errorHandler.handle(O,S,()=>{})}this.selectedReplay=void 0,this.availableReplays=await this.replayManager.loadList(),this.form.applyOptions(S=>{S.replays=this.availableReplays,S.selectedReplay=void 0,S.selectedReplayDetails=void 0}),this.updateSidebarButtons()}}},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}])}async loadSelectedReplay(){var S=this.selectedReplay;let O;try{var B=await this.replayManager.loadSerializedReplay(S);O=await(new L.Replay).parseHeader(B)}catch(S){return void this.errorHandler.handle(S,this.strings.get("GUI:ReplayError"),()=>{})}if(O.engineVersion!==this.engineVersion){if(!this.clientVersions&&this.oldClientsBaseUrl){this.messageBoxApi.show(this.strings.get("GUI:LoadingEx"));try{let S=new H.ResourceLoader(this.oldClientsBaseUrl);this.clientVersions=await S.loadJson("versions.json")}catch(S){console.warn("Couldn't download client version list",S)}finally{this.messageBoxApi.destroy()}}let N;return this.clientVersions&&(N=this.clientVersions[O.engineVersion]),void(N?await this.messageBoxApi.confirm(this.strings.get("GUI:ReplayOpenOldClient",O.engineVersion),this.strings.get("TXT_CONTINUE"),this.strings.get("GUI:Close"))&&(B=this.activeMod?`?${X.RouteHelper.modQueryStringName}=`+this.activeMod:"",window.open(`${this.oldClientsBaseUrl}v${N}/${B}#/replay/`+S.id,"_blank")):this.messageBoxApi.show(this.strings.get("GUI:ReplayVersionMismatch",O.engineVersion),this.strings.get("GUI:Ok")))}if(O.modHash===this.engineModHash){let O;try{O=await this.replayManager.loadReplay(S)}catch(S){return void this.errorHandler.handle(S,this.strings.get("GUI:ReplayError"),()=>{})}this.rootController.goToScreen(D.ScreenType.Replay,{replay:O})}else this.messageBoxApi.show(this.strings.get("GUI:ReplayModMismatch"),this.strings.get("GUI:Ok"))}showKeepReplayBox(S,O){let[j]=this.jsxRenderer.render(B.jsx(N.HtmlView,{component:F.KeepReplayBox,props:{defaultName:S,strings:this.strings,onSubmit:S=>{O(S),j.destroy()},onDismiss:()=>{j.destroy()},viewport:this.uiScene.viewport}}));this.uiScene.add(j),this.disposables.add(j,()=>this.uiScene.remove(j))}async exportCurrentReplay(){var S=this.getSelectedReplayMeta();if(!S)throw new Error("No replay selected");var O=await this.replayManager.loadSerializedReplay(S);this.currentReplayUrl&&URL.revokeObjectURL(this.currentReplayUrl),O=URL.createObjectURL(new Blob([O],{type:"application/octet-stream"})),this.currentReplayUrl=O;let B=document.createElement("a");B.setAttribute("href",O),B.setAttribute("download",S.name+L.Replay.extension),document.body.appendChild(B),B.click(),document.body.removeChild(B)}getSelectedReplayMeta(){if(this.selectedReplay)return this.availableReplays.find(S=>S.id===this.selectedReplay.id)}async onLeave(){this.currentReplayUrl&&URL.revokeObjectURL(this.currentReplayUrl),this.clientVersions=void 0,this.availableReplays.length=0,this.form=void 0,this.messageBoxApi.destroy(),this.disposables.dispose(),this.replayDetailsTask?.cancel(),this.replayDetailsTask=void 0,this.controller.setMainComponent(),await this.controller.hideSidebarButtons()}loadReplayDetails(S){this.replayDetailsTask?.cancel(),this.replayDetailsTask=new W.Task(async O=>{let B=await this.replayManager.loadSerializedReplay(S);var N=await(new L.Replay).parseHeader(B);let j,D,F;if(O.throwIfCancelled(),N.engineVersion===this.engineVersion){let N=new L.Replay;N.unserialize("string"==typeof B?B:await B.text(),S),O.throwIfCancelled(),j=N.gameOpts,D=Math.floor(N.endTick/K.GameSpeed.BASE_TICKS_PER_SECOND)}else try{j=(new z.Parser).parseOptions(N.gameOptsSerialized)}catch(S){console.warn("Replay couldn't be parsed",S)}if(j){let S=J.GameOptRandomGen.factory(N.gameId,N.gameTimestamp).generateColors(j),O=this.getAvailablePlayerColors();F=j.humanPlayers.filter(S=>S.countryId!==ee.OBS_COUNTRY_ID).map(B=>({name:B.name,color:O[S.get(B)??B.colorId]}))}let _={gameId:N.gameId,gameTimestamp:N.gameTimestamp||void 0,engineVersion:N.engineVersion,durationSeconds:D,mapName:j?.mapTitle,players:F};this.form.applyOptions(S=>{S.selectedReplayDetails=_})}),this.replayDetailsTask.start().catch(S=>{S instanceof Q.OperationCanceledError||console.error(S)})}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map(S=>S.asHexString())}handleError(S,O){this.errorHandler.handle(S,O,()=>{this.rootController.goToScreen(D.ScreenType.MainMenuRoot)})}},S("ReplaySelScreen",te)}}}),System.register("gui/screen/replay/StorageWarning",["react"],function(S,O){"use strict";var B;function r(S){return Math.ceil(S/1024/1024)}return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("StorageWarning",({strings:S})=>{const[O,N]=B.useState();return B.useEffect(()=>{navigator.storage?.estimate&&navigator.storage.estimate().then(S=>N(S)).catch(S=>console.warn("Couldn't get storage estimate",[S]))},[]),O?.quota&&O.usage&&O.quota-O.usage<1048576?B.default.createElement("div",{className:"storage-warning"},S.get("ts:storage_quota_warning",r(O.usage),r(O.quota))):null})}}}),System.register("main",["Application"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){N=new B.Application,document.body?N.main():document.addEventListener("DOMContentLoaded",()=>{N.main()})}}}),System.register("network/AccountRegFormData",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/Apgar",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){S("Apgar",B=class{static encode(S){let O="";for(let j=0;j<this.maxLength;j++){var B=S.charCodeAt(j),N=0<j?S.charCodeAt(S.length-j):0;O+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789./"[63&(0<(1&B)?B<<1&N:B^N)]}return O}}),B.maxLength=8}}}),System.register("network/GservConnection",["util/event","data/DataStream","network/IrcConnection","network/gservCodes","network/GservError","network/gservConfig","network/gameopt/Parser","network/gameopt/Serializer","network/chat/ChatMessage","util/Base64"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S}],execute:function(){W=new Map([[L.RPL_BAD_LOGIN,D.GservError.Code.BadLogin],[L.RPL_TOO_MANY_LOGIN_ATTEMPTS,D.GservError.Code.TooManyLoginAttempts],[L.RPL_ALREADY_LOGGED_IN,D.GservError.Code.AlreadyLoggedIn],[L.RPL_INSTANCE_EXISTS,D.GservError.Code.InstanceAlreadyExists],[L.RPL_INSTANCE_TOO_MANY,D.GservError.Code.CreatedTooManyInstances],[L.RPL_INSTANCE_NONEXISTENT,D.GservError.Code.InstanceNonExistent],[L.RPL_INSTANCE_NOT_ALLOWED,D.GservError.Code.InstanceNotAllowed],[L.RPL_INSTANCE_ALREADY_STARTED,D.GservError.Code.InstanceAlreadyStarted],[L.RPL_INSTANCE_VERS_MISMATCH,D.GservError.Code.InstanceVersMismatch]]),S("GservConnection",class{get onError(){return this.con.onError}get onClose(){return this.con.onClose}get onLoadInfo(){return this._onLoadInfo.asEvent()}get onGameStart(){return this._onGameStart.asEvent()}get onGameActions(){return this._onGameActions.asEvent()}get onGameDesync(){return this._onGameDesync.asEvent()}get onRateChange(){return this._onRateChange.asEvent()}get onChatMessage(){return this._onChatMessage.asEvent()}get onTaunt(){return this._onTaunt.asEvent()}get onPlayerDisconnect(){return this._onPlayerDisconnect.asEvent()}get onPrivMsgNotAllowed(){return this._onPrivMsgNotAllowed.asEvent()}static factory(S){return new this(new j.IrcConnection({mode:"text",binaryRplPrefix:L.RPL_BIN_PREFIX,binaryReqPrefix:L.REQ_BIN_PREFIX,logFilter:S=>S.replace(/^(user [^ ]+) ([^ ]+)/i,"$1 <redacted>").replace(/^((:.+!.+@.+)?privmsg ([^ ]+ )+):(.+)\r?\n?$/i,"$1:<redacted>")},S))}constructor(S){this._onLoadInfo=new B.EventDispatcher,this._onGameStart=new B.EventDispatcher,this._onGameActions=new B.EventDispatcher,this._onGameDesync=new B.EventDispatcher,this._onRateChange=new B.EventDispatcher,this._onChatMessage=new B.EventDispatcher,this._onTaunt=new B.EventDispatcher,this._onPlayerDisconnect=new B.EventDispatcher,this._onPrivMsgNotAllowed=new B.EventDispatcher,this.handleMessage=S=>{if("string"==typeof S){let N=S.split(" ");var O,B;"ping"===N[0]?this.isOpen()&&this.con.sendMessage("pong"+(N[1]?" "+N[1]:"")):"privmsg"===N[1].toLowerCase()?this.handlePrivMsg(S):N[1]===""+L.RPL_LOAD_INFO?this.handleLoadInfo(N[3]):N[1]===""+L.RPL_GAME_START?this.handleGameStart():N[1]===""+L.RPL_GAME_DESYNC?this._onGameDesync.dispatch(this):N[1]===""+L.RPL_NET_RATE?([O,B]=N[3].slice(1).split(","),this._onRateChange.dispatch(this,{rate:Number(O),turnNo:Number(B)})):N[1]===""+L.RPL_TAUNT?this._onTaunt.dispatch(this,{from:N[0].replace(/^:/,""),tauntNo:Number(N[3].replace(/^:/,""))}):N[1]===""+L.RPL_PLAYER_DISCONNECT?this._onPlayerDisconnect.dispatch(this,N[3].replace(/^:/,"")):N[1]===""+L.RPL_PRIVMSG_NOT_ALLOWED&&this._onPrivMsgNotAllowed.dispatch(this)}else S[0]===L.RPL_BIN_GAME_ACTIONS&&this.handlePlayerActions(S.slice(1))},this.con=S}getCurrentUser(){return this.currentUser}getServerName(){return this.serverName}async connect(S,O){return this.con.onMessage.subscribe(this.handleMessage),await this.con.connect(S,O)}close(){this.con.onMessage.unsubscribe(this.handleMessage),this.con.close(),this.currentUser=void 0}isOpen(){return this.con.isOpen()}async cvers(S){let O=await this.con.sendCommand(`cvers ${S} `+F.API_VERSION,{replyCodes:[L.RPL_CVERS_OK,L.RPL_CVERS_OUTDATED]});if(O[0].code===L.RPL_CVERS_OUTDATED){var B=O[0].params?O[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new D.GservError("Cvers error: "+B,D.GservError.Code.OutdatedClient)}}async login(S,O){let B=await this.con.sendCommand(`user ${S} `+V.Base64.encode(O),{replyCodes:[L.RPL_LOGGED_IN,L.RPL_BAD_LOGIN,L.RPL_TOO_MANY_LOGIN_ATTEMPTS,L.RPL_ALREADY_LOGGED_IN],timeout:10});if(B[0].code!==L.RPL_LOGGED_IN){var N=W.get(B[0].code)??D.GservError.Code.Unknown,j=B[0].params?B[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new D.GservError("Login error: "+j,N)}this.currentUser=S,this.serverName=B[0].raw.match(/^:([^\s]+)/)?.[1]||""}async createGame(S,O,B,N,j,F=!1){if(B.includes(" "))throw new Error("Game opts string cannot include spaces");let _=await this.con.sendCommand(`create ${S} ${O} ${B} ${N} ${j} `+Number(F),{replyCodes:[L.RPL_INSTANCE_CREATED,L.RPL_INSTANCE_EXISTS,L.RPL_INSTANCE_TOO_MANY,L.RPL_INSTANCE_NOT_ALLOWED]});if(_[0].code!==L.RPL_INSTANCE_CREATED){var U=W.get(_[0].code)??D.GservError.Code.Unknown,H=_[0].params?_[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new D.GservError("Create error: "+H,U)}}async joinGame(S,O,B){let N=await this.con.sendCommand(`join ${S} ${O} `+B,{replyCodes:[L.RPL_INSTANCE_CONNECTED,L.RPL_INSTANCE_NONEXISTENT,L.RPL_INSTANCE_NOT_ALLOWED,L.RPL_INSTANCE_ALREADY_STARTED,L.RPL_INSTANCE_VERS_MISMATCH]});if(N[0].code!==L.RPL_INSTANCE_CONNECTED){var j=W.get(N[0].code)??D.GservError.Code.Unknown,F=N[0].params?N[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new D.GservError("Join error: "+F,j)}}async gameOpts(){let S=await this.con.sendCommand("gameopts",{replyCodes:[L.RPL_GAME_OPTS]});if(!S[0].params)throw new Error("Unexpected server reply for getopts command. Missing params.");return S[0].params.splice(1).join(" ").replace(/^:/,"")}sendLoadedPercent(S){this.con.sendMessage("loaded "+S)}requestLoadInfo(){this.con.sendMessage("loadinfo")}sendGameStateHash(S,O){let B=new N.DataStream(10);B.dynamicSize=!1,B.writeUint8(L.REQ_BIN_PREFIX),B.writeUint8(L.REQ_BIN_GAME_STATE_HASH),B.writeUint32(S),B.writeUint32(O),this.con.sendMessage(B.toUint8Array())}sendPlayerActive(S){this.con.sendMessage("active "+(S?1:0))}sendTaunt(S){this.con.sendMessage("taunt "+S)}async ping(S){return await this.con.ping(S)}sendPlayerActions(S,O){let B=new N.DataStream(6);B.writeUint8(L.REQ_BIN_PREFIX),B.writeUint8(L.REQ_BIN_GAME_ACTIONS),B.writeUint32(S),B.writeUint8Array(O),this.con.sendMessage(B.toUint8Array())}sendMap(S){let O=new N.DataStream(2);O.writeUint8(L.REQ_BIN_PREFIX),O.writeUint8(L.REQ_BIN_PUT_MAP),O.writeUint8Array((new U.Serializer).serializeMapData(S)),this.con.sendMessage(O.toUint8Array())}async getMap(){let S=new N.DataStream(2);S.dynamicSize=!1,S.writeUint8(L.REQ_BIN_PREFIX),S.writeUint8(L.REQ_BIN_GET_MAP);var O=await this.con.sendBinCommand(S.toUint8Array(),{replyCodes:[L.RPL_BIN_MAP_DATA],timeout:15});return(new _.Parser).parseMapData(O.data)}handleLoadInfo(S){this._onLoadInfo.dispatch(this,S.replace(/^:/,""))}handleGameStart(){this._onGameStart.dispatch(this,void 0)}handlePlayerActions(S){this._onGameActions.dispatch(this,S)}sayChannel(S){this.privmsg([F.RECIPIENT_ALL],S)}privmsg(S,O){if(!this.currentUser)throw new Error("Must login before sending messages");var B;O.length&&(B=S.join(","),this.con.sendMessage(`privmsg ${B} :`+O))}handlePrivMsg(S){var O=S.match(/^:([A-Za-z0-9-_]+) PRIVMSG ([A-Za-z0-9-_#']+) :(.*)/i);if(!O)throw new Error(`Unexpected PRIVMSG message format "${S}"`);var[,B,N,j]=O;let L;O=new Date,N===F.RECIPIENT_ALL?L={from:B,to:{type:H.ChatRecipientType.Channel,name:N},text:j,time:O}:N===this.currentUser&&(L={from:B,to:B===this.getServerName()?{type:H.ChatRecipientType.Page,name:N}:{type:H.ChatRecipientType.Channel,name:F.RECIPIENT_TEAM},text:j,time:O}),L&&this._onChatMessage.dispatch(this,L)}})}}}),System.register("network/GservError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;B=class extends Error{constructor(S,O){super(S),this.code=O}},S("GservError",B),(O=(O=B||S("GservError",B={})).Code||(O.Code={}))[O.Unknown=0]="Unknown",O[O.OutdatedClient=1]="OutdatedClient",O[O.BadLogin=2]="BadLogin",O[O.TooManyLoginAttempts=3]="TooManyLoginAttempts",O[O.AlreadyLoggedIn=4]="AlreadyLoggedIn",O[O.InstanceNonExistent=5]="InstanceNonExistent",O[O.InstanceAlreadyExists=6]="InstanceAlreadyExists",O[O.InstanceNotAllowed=7]="InstanceNotAllowed",O[O.InstanceAlreadyStarted=8]="InstanceAlreadyStarted",O[O.InstanceVersMismatch=9]="InstanceVersMismatch",O[O.CreatedTooManyInstances=10]="CreatedTooManyInstances"}}}),System.register("network/HttpRequest",["@puzzl/core/lib/async/cancellation"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("HttpRequest",class{async fetchText(S,O,B){return await this.fetchAndParse({url:S,type:"text"},O,B)}async fetchBinary(S,O,B){return await this.fetchAndParse({url:S,type:"binary"},O,B)}async fetchJson(S,O,B){return await this.fetchAndParse({url:S,type:"json"},O,B)}async fetchHtml(S,O,B){return await this.fetchAndParse({url:S,type:"text"},O,{...B,allowHtmlMimeType:!0})}async fetchAndParse(S,O,B){var N=await this.fetchRaw(S.url,O,B);return this.parseResult(S.type,N)}async fetchRaw(S,O,j){let L,D=new AbortController;O?.register(()=>{try{D.abort()}catch(S){}});try{L=await fetch(S,{signal:D.signal,body:j?.body,method:j?.method,headers:j?.headers})}catch(S){if("AbortError"===S.name||S instanceof DOMException&&S.code===DOMException.ABORT_ERR)throw new B.OperationCanceledError(O);throw console.error(S),new N(`Fetch failed with error: ${S.name}:`+S.message)}if(!L.ok)throw new N(`Fetch failed with status ${L.status}:`+L.statusText,void 0,L.status);if("text/html"===L.headers.get("Content-Type")&&!j?.allowHtmlMimeType)throw new N(`Fetch failed with invalid mime type "text/html" (HTTP status ${L.status})`);let F=L.body.getReader(),_=0,U=[];for(var H,V=L.headers.get("Content-Encoding")?void 0:Number(L.headers.get("Content-Length")||0);;)try{var{done:W,value:z}=await F.read();if(W)break;U.push(z),_+=z.length,j?.onProgress?.(z.length,V)}catch(S){if("AbortError"===S.name)throw new B.OperationCanceledError(O);throw console.error(S),new N(S.message)}let K=new Uint8Array(_),$=0;for(H of U)K.set(H,$),$+=H.length;return K}parseResult(S,O){if("binary"===S)return O;var B=new TextDecoder("utf-8").decode(O);return"json"===S?JSON.parse(B):B}}),N=class extends Error{constructor(S,O,B){super(S,O),this.statusCode=B}},S("DownloadError",N)}}}),System.register("network/IrcConnection",["@puzzl/core/lib/async/cancellation","util/event","util/Logger","util/string","util/time"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){S("IrcConnection",F=class e{constructor(S,O){this.options=S,this.logger=O,this.timeout=5,this._onMessage=new N.EventDispatcher,this._onError=new N.EventDispatcher,this._onClose=new N.EventDispatcher,this.messageBuffer=""}get onMessage(){return this._onMessage.asEvent()}get onError(){return this._onError.asEvent()}get onClose(){return this._onClose.asEvent()}async connect(S,O){let N=O?.timeoutSeconds?setTimeout(()=>this.close(),1e3*O.timeoutSeconds):void 0;return O?.cancelToken?.register(()=>{N&&(clearTimeout(N),this.close())}),new Promise((N,j)=>{this.socket=new WebSocket(S),"binary"===this.options.mode&&(this.socket.binaryType="blob");let n=N=>{this.socket.removeEventListener("error",n),O?.cancelToken?.isCancelled()?j(new B.OperationCanceledError(O.cancelToken)):j(new e.ConnectError(`Connection to "${S}" failed`))};this.socket.addEventListener("open",()=>{this.socket.removeEventListener("error",n),this.socket.addEventListener("error",S=>this.handleError(S)),this.handleOpen(),N()}),this.socket.addEventListener("error",n),this.socket.addEventListener("close",S=>this.handleClose(S)),this.socket.addEventListener("message",S=>{globalThis.Blob&&S.data instanceof Blob?this.parseData(S.data).then(S=>{this.handleMessage(S)}).catch(S=>{console.error("Failed to decode socket message.",S)}):this.handleMessage(S.data)})}).finally(()=>{N&&clearTimeout(N)})}handleOpen(){this.logger.info("Connection open to "+this.socket.url)}handleError(S){this.logger.error("Connection error",S),this._onError.dispatch(this,S)}handleClose(S){this.logger.info(`Connection closed (${this.socket.url})`,S),this._onClose.dispatch(this,S)}handleMessage(S){if("string"!=typeof S){if(S[0]===this.options.binaryRplPrefix)return void this._onMessage.dispatch(this,S.slice(1));S=L.uint8ArrayToBinaryString(S)}this.logger.enabledFor(j.AppLogger.DEBUG)&&this.logger.debug("Got message:","string"==typeof S?this.options.logFilter?.(S)??S:S),S=this.messageBuffer+S,this.messageBuffer="";let O=S.split(/\r?\n/);var B=O.pop();B.length&&(this.messageBuffer=B),O.filter(S=>!!S).forEach(S=>this._onMessage.dispatch(this,S))}parseData(S){return new Promise((O,B)=>{let N=new FileReader;N.onload=()=>O(new Uint8Array(N.result)),N.onerror=()=>B(new Error("Failed to parse data")),N.readAsArrayBuffer(S)})}async sendCommand(S,O){if(O.replyStartCode&&!O.replyEndCode)throw new Error("Invalid argument. Expected a reply end code, but got only a start code.");let B=[];return await this.sendRawCommand(S,(S,N,j,D)=>{let o=(S,O)=>{if("number"==typeof S)return O.code===S;let[B,N]=S;return O.code===B&&N(O)};if("string"!=typeof S){if(S[0]===this.options.binaryRplPrefix)return!1;S=L.uint8ArrayToBinaryString(S)}return O.replyRawText?(j(S.split(/\r?\n/).map(S=>({raw:S,time:N}))),!0):S.split(/\r?\n/).filter(S=>!!S).some(S=>(S=>{if(O.replyMatch){if(O.replyMatch.exec(S))return j([{raw:S,time:N}]),!0;if(!O.replyCodes)return!1}if(!O.replyEndCode&&!O.replyCodes)return j([{raw:S,time:N}]),!0;var L,[,L,...F]=S.split(" ");let _={raw:S,code:L=parseInt(L,10),params:F,time:N};if(O.replyEndCode)return O.replyCodes&&O.replyCodes.some(S=>o(S,_))?(j([_]),!0):(O.replyHeartbeatCodes&&-1!==O.replyHeartbeatCodes.indexOf(L)&&D(O.heartbeatTimeout),(L===O.replyStartCode||O.replyBodyCodes&&-1!==O.replyBodyCodes.indexOf(L)||L===O.replyEndCode)&&B.push(_),L===O.replyEndCode&&(j(B),!0));if(void 0===O.replyCodes)throw new Error("List of replyCodes must be specified when not using start/end codes");return!!O.replyCodes.some(S=>o(S,_))&&(j([_]),!0)})(S))},O.timeout)}async sendBinCommand(S,O){const B=this.options.binaryRplPrefix;if(!B)throw new Error("Must configure binary message reply prefix to send binary commands");const N=this.options.binaryReqPrefix;if(!N)throw new Error("Must configure binary message request prefix to send binary commands");if(S[0]!==N)throw new Error("Binary command must start with the magic prefix 0x"+N.toString(16));return await this.sendRawCommand(S,(S,N,j)=>{if("string"==typeof S||S[0]!==B)return!1;var L=S[1];return-1!==O.replyCodes.indexOf(L)&&(j({code:L,data:S.slice(2),time:N}),!0)},O.timeout)}sendRawCommand(S,O,B){return new Promise((N,j)=>{let L,F=!1,c=S=>{clearTimeout(L),void 0!==S&&Number.isFinite(S)&&(L=setTimeout(d,1e3*(S??B??this.timeout)))},h=S=>{clearTimeout(L),N(S)},u=S=>{this.socket.removeEventListener("message",m),this.socket.removeEventListener("close",g),clearTimeout(L),L=void 0,j(S)},d=()=>{var O="string"==typeof S?this.options.logFilter?.(S)??S:"0x"+S[1].toString(16);u(new e.NoReplyError("Timeout reached for command "+O))},g=async()=>{for(;F;)await D.sleep(10);_||u(new e.SocketError("Connection was closed prematurely"))},_=!1,m=S=>{if(!_){let B=Date.now();globalThis.Blob&&S.data instanceof Blob?(F=!0,this.parseData(S.data).then(S=>{F=!1,_||O(S,B,h,c)&&(_=!0,this.socket.removeEventListener("message",m),this.socket.removeEventListener("close",g))}).catch(S=>{F=!1,console.error("Failed to decode socket message.",S)})):O(S.data,B,h,c)&&(_=!0,this.socket.removeEventListener("message",m),this.socket.removeEventListener("close",g))}};if(this.socket&&this.socket.readyState===WebSocket.OPEN){L=setTimeout(d,1e3*(B??this.timeout)),this.socket.addEventListener("message",m),this.socket.addEventListener("close",g);try{this.sendMessage(S)}catch(S){u(S)}}else u(new e.SocketError("Send command failed. Socket is not open."+(this.socket?` (readyState = ${this.socket.readyState})`:"")))})}sendMessage(S){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)throw new e.SocketError("Socket is not open"+(this.socket?` (readyState = ${this.socket.readyState})`:""));let O;this.logger.enabledFor(j.AppLogger.DEBUG)&&this.logger.debug("Sent message:","string"==typeof S?this.options.logFilter?.(S)??S:S),"string"==typeof S&&(S+="\r\n"),O="binary"===this.options.mode&&"string"==typeof S?L.binaryStringToUint8Array(S):S,this.socket.send(O)}async ping(S){var O=Date.now();return(await this.sendCommand("ping :"+O,{replyMatch:new RegExp("^:[^ ]+ PONG [^ :]+ :"+O,"i"),timeout:S}))[0].time-O}close(){this.socket&&this.socket.close()}isOpen(){return this.socket&&this.socket.readyState===WebSocket.OPEN}}),function(S){class t extends Error{constructor(S){super(S)}}S.NoReplyError=t;class i extends Error{constructor(S){super(S)}}S.SocketError=i;class r extends Error{constructor(S){super(S)}}S.ConnectError=r}(F||S("IrcConnection",F={}))}}}),System.register("network/IrcProtocol",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){S("IrcProtocol",B=class{static escapeChannelName(S){return S.split("").map(S=>{switch(S){case" ":return"_";case"%":return"%%";case"_":return"%_";case"\b":return"%b";case"\n":return"%n";case"\r":return"%r";case":":return"%=";case",":return"%-";default:return S}}).join("")}static unescapeChannelName(S){var O=S.split("");let B="",N=0;for(;N<O.length;){var j,L=O[N++];let S;S="%"===L?"b"===(j=O[N++])?"\b":"n"===j?"\n":"r"===j?"\r":"="===j?":":"-"===j?",":j:"_"===L?" ":L,B+=S}return B}}),B.MAX_CHANNELNAME_LEN=30}}}),System.register("network/Logger",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/MapTransferService",["network/HttpRequest","util/Base64","@puzzl/core/lib/async/sleep","util/math"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("MapTransferService",class{constructor(S){this.wolService=S}setUrl(S){this.url=S}getUrl(){return this.url}async putMap(S,O,N){if(!this.url)throw new Error("No MapTransfer URL is set");var D=this.makeAuthorizationHeader();let F,_=3;for(;_--;)try{return console.log("Uploading map...",_+" retries left"),N?.throwIfCancelled(),await(new B.HttpRequest).fetchRaw(this.url+"/"+O,N,{method:"PUT",body:S,headers:{authorization:D,"Content-Type":"application/octet-stream"}}),void console.log(`Map upload finished. (size=${S.byteLength})`)}catch(S){if(!(S instanceof B.DownloadError)||S.statusCode&&L.isBetween(S.statusCode,400,499))throw S;F=S,await j.sleep(1e3,N)}throw F}async getMap(S,O){if(!this.url)throw new Error("No MapTransfer URL is set");var N=this.makeAuthorizationHeader();let L,D=6;for(;D--;)try{console.log("Transferring map...",D+" retries left"),O?.throwIfCancelled();var F=await(new B.HttpRequest).fetchBinary(this.url+"/"+S,O,{headers:{authorization:N}});return console.log(`Map download finished. (size=${F.byteLength})`),F}catch(S){if(!(S instanceof B.DownloadError&&404===S.statusCode))throw S;L=S,await j.sleep(3e3,O)}throw L}makeAuthorizationHeader(){var S=this.wolService.getCredentials();if(!S)throw new Error("Missing WOL credentials");return N.Base64.encode(JSON.stringify({nick:S.user,pass:S.pass}))}})}}}),System.register("network/ServerRegions",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("ServerRegions",class{constructor(){this.regions=new Map}load(S){for(var O of(this.regions.clear(),S.getOrderedSections()))this.regions.set(O.name,{id:O.name,label:O.getString("label"),available:O.getBool("available",!0),gameVersion:this.normalizeVersion(O.getString("gameVersion")||void 0),wolUrl:O.getString("wolUrl"),apiRegUrl:O.getString("apiRegUrl"),wladderUrl:O.getString("wladderUrl")||void 0,wgameresUrl:O.getString("wgameresUrl")||void 0,mapTransferUrl:O.getString("mapTransferUrl")||void 0})}normalizeVersion(S){return void 0!==S&&S.match(/^\d+\.\d+$/)&&(S+=".0"),S}get(S){if(!this.regions.has(S))throw new Error("Unknown region id "+S);return this.regions.get(S)}has(S){return this.regions.has(S)}isAvailable(S){return this.regions.has(S)&&this.regions.get(S).available}getAll(){return[...this.regions.values()]}getFirstAvailable(){return this.getAll().filter(S=>S.available)[0]}getSize(){return this.regions.size}setSelectedRegion(S){this.selectedRegion=this.get(S)}getSelectedRegion(){if(!this.selectedRegion)throw new Error("No server region selected");return this.selectedRegion}})}}}),System.register("network/WGameResService",["network/HttpRequest","util/Base64","util/string"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("WGameResService",class{constructor(S,O){this.wolService=S,this.wolConfig=O}setUrl(S){this.url=S}getUrl(){return this.url}async sendGameResPacket(S,O){if(!this.url)throw new Error("No WGameRes URL is set");var L=this.wolConfig.getClientSku(),D=this.wolService.getCredentials();if(!D)throw new Error("Missing WOL credentials");await(new B.HttpRequest).fetchRaw(this.url+"/"+L,O,{method:"POST",body:j.uint8ArrayToBase64String(S),headers:{authorization:N.Base64.encode(JSON.stringify({nick:D.user,pass:D.pass}))}})}})}}}),System.register("network/WolConfig",["network/ladder/wladderConfig"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S}],execute:function(){var O;S("MATCH_BOT_NAME","matchbot"),S("MIN_USERNAME_LEN",2),S("MAX_USERNAME_LEN",15),S("MIN_PASS_LEN",8),S("MAX_PASS_LEN",128),S("MAX_MAP_TRANSFER_BYTES",2097152),(O=N||S("ClientType",N={}))[O.Cdral2=0]="Cdral2",S("WolConfig",j=class e{static skuToClientType(S){return[...e.allClientSettings.entries()].find(([,O])=>O.sku===S)?.[0]}static factory(S){var O=e.allClientSettings.get(S);if(!O)throw new Error(`Unhandled client type "${N[S]}"`);return new this(S,O)}constructor(S,O){this.clientType=S,this.clientSettings=O}getClientSku(){return this.clientSettings.sku}getClientChannelType(){return this.clientSettings.channelType}getGlobalChannelPass(){return"zotclot9"}getQuickMatchBotName(){return"matchbot"}getAllQuickMatchChannelIds(){return[...this.clientSettings.qmChanIds.values()]}getQuickMatchChannelId(S){var O=this.clientSettings.qmChanIds.get(S);if(void 0===O)throw new Error(`Client type ${this.clientType} doesn't have a configured channel for ladder=`+S);return O}}),j.allClientSettings=(new Map).set(N.Cdral2,{sku:16640,channelType:45,qmChanIds:(new Map).set(B.LadderQueueType.Solo1v1,50).set(B.LadderQueueType.Team2v2,51)})}}}),System.register("network/WolConnectOptions",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/WolConnection",["util/event","network/IrcConnection","network/WolError","util/string","util/Base64","util/typeGuard","network/gameopt/FileNameEncoder","network/chat/ChatMessage","network/wolCodes","network/IrcProtocol","network/WolLocale","network/WolConfig","network/gameopt/Parser","@puzzl/core/lib/regexp","network/WolGameReport"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S}],execute:function(){var O;(O=Q||S("WolHasMapStatus",Q={}))[O.NoMap=0]="NoMap",O[O.HasMap=1]="HasMap",O[O.MapTransfer=2]="MapTransfer",S("WolConnection",Z=class e{get onError(){return this.con.onError}get onClose(){return this.con.onClose}get onLoginQueueUpdate(){return this._onLoginQueueUpdate}get onChatMessage(){return this._onChatMessage}get onJoinChannel(){return this._onJoinChannel}get onLeaveChannel(){return this._onLeaveChannel}get onGameStart(){return this._onGameStart}get onGameOpt(){return this._onGameOpt}get onGameMode(){return this._onGameMode}get onGameServer(){return this._onGameServer}get onChannelUsers(){return this._onChannelUsers}get onGameReport(){return this._onGameReport}static factory(S){return new this(new N.IrcConnection({mode:"text",logFilter:S=>S.replace(/((^|\n)(apgar|pass)) ([^ \n]+)/gi,"$1 <redacted>").replace(/^(join [^ ]+) ([^ ]+)/gi,"$1 <redacted>").replace(/^(joingame (([^ ]+ ){2}|([^ ]+ ){8}))([^ ]+)$/gi,"$1<redacted>").replace(/^((privmsg|page|notice) ([^ ]+ )+):(.+)\r?\n?$/i,(S,O,B,N)=>N===z.MATCH_BOT_NAME+" "?S:O+":<redacted>").replace(/^(:([^ ]+) (privmsg|page|notice) ([^ ]+ )+):(.+)\r?\n?$/i,(S,O,B)=>B.startsWith(z.MATCH_BOT_NAME+"!")?S:O+":<redacted>")},S),S)}constructor(S,O){this.con=S,this.logger=O,this.currentChannels=new Set,this.lastChannelOpts=new Map,this.pendingChannelUsers=new Map,this._onLoginQueueUpdate=new B.EventDispatcher,this._onChatMessage=new B.EventDispatcher,this._onJoinChannel=new B.EventDispatcher,this._onLeaveChannel=new B.EventDispatcher,this._onGameStart=new B.EventDispatcher,this._onGameOpt=new B.EventDispatcher,this._onGameMode=new B.EventDispatcher,this._onGameServer=new B.EventDispatcher,this._onChannelUsers=new B.EventDispatcher,this._onGameReport=new B.EventDispatcher,this.handleMessage=S=>{if("string"==typeof S){let N=S.split(" ");var O,B;"ping"===N[0].toLowerCase()?this.con.sendMessage("PONG"+(N[1]?" "+N[1]:"")):"privmsg"===N[1].toLowerCase()?this.handlePrivMsg(S):"page"===N[1].toLowerCase()||"notice"===N[1].toLowerCase()?this.handlePageOrNotice(S):"join"===N[1].toLowerCase()?this.handleJoin(S):"joingame"===N[1].toLowerCase()?this.handleJoingame(S):"part"===N[1].toLowerCase()?this.handlePart(S):"kick"===N[1].toLowerCase()?this.handleKick(S):"gameopt"===N[1].toLowerCase()?this.handleGameOpt(S):"mode"===N[1].toLowerCase()?this.handleMode(S):"startg"===N[1].toLowerCase()?this.handleStartGame(S):"gserv"===N[1].toLowerCase()?this.handleGserv(S):(O=Number(N[1]),Number.isNaN(O)||(B={raw:S,code:O,params:N.slice(2),time:Date.now()},O===H.RPL_LOGIN_QUEUE?this.handleLoginQueueUpdate(B):O===H.RPL_NAMREPLY?this.handleNamReply(B):O===H.RPL_ENDOFNAMES?this.handleEndOfNames(B):O===H.RPL_GAME_REPORT?this.handleGameReport(B):this.handleIrcError(S)))}},this.handleClose=()=>{this.currentUser=void 0,this.currentGameChannel=void 0,this.currentChannels.clear(),this.pendingChannelUsers.clear(),this.con.onMessage.unsubscribe(this.handleMessage)}}getCurrentUser(){return this.currentUser}getCurrentChannels(){return[...this.currentChannels]}isInChannel(S){return this.currentChannels.has(S)}getServerName(){return this.serverName}async connect(S,O){return this.con.onMessage.subscribe(this.handleMessage),this.con.onClose.subscribeOnce(this.handleClose),await this.con.connect(S,O)}close(){this.con.onMessage.unsubscribe(this.handleMessage),this.con.close()}isOpen(){return this.con.isOpen()}ping(S){return this.con.ping(S)}async cvers(S,O){let B=await this.con.sendCommand(`cvers ${S} `+O,{replyCodes:[H.RPL_CVERS_OK,H.RPL_CVERS_OUTDATED]});if(B[0].code===H.RPL_CVERS_OUTDATED){var N=B[0].params?B[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new j.WolError("Cvers error: "+N,j.WolError.Code.OutdatedClient)}}async login(S,O,B){B&&this._onLoginQueueUpdate.subscribe(B);let N=await this.con.sendCommand(["pass "+D.Base64.encode(O),"nick "+S,"user UserName HostName irc.westwood.com :RealName"].join("\r\n"),{replyCodes:[H.RPL_BAD_LOGIN,H.ERR_YOUREBANNEDCREEP,H.ERR_SERVER_FULL],replyStartCode:H.RPL_MOTDSTART,replyBodyCodes:[H.RPL_MOTD],replyEndCode:H.RPL_ENDOFMOTD,replyHeartbeatCodes:[H.RPL_LOGIN_QUEUE],heartbeatTimeout:Number.POSITIVE_INFINITY}).finally(()=>{B&&this._onLoginQueueUpdate.unsubscribe(B)});if(1===N.length){var L=N[0].params?N[0].params.splice(2).join(" ").replace(/^:/,""):"unknown";if(N[0].code===H.RPL_BAD_LOGIN)throw new j.WolError("Login error: "+L,j.WolError.Code.BadLogin);if(N[0].code===H.ERR_YOUREBANNEDCREEP)throw new j.WolError("Login error: "+L,j.WolError.Code.BannedFromServer,L);if(N[0].code===H.ERR_SERVER_FULL)throw new j.WolError("Login error: "+L,j.WolError.Code.ServerFull)}return this.currentUser=S,this.serverName=N[0].raw.match(/^:([^\s]+)/)?.[1]||"",N.slice(0,-1).map(S=>S.raw.replace(/^.*:- /,""))}async setLocale(S){await this.con.sendCommand("setlocale "+S,{replyCodes:[H.RPL_SET_LOCALE]})}async getLocale(){if(!this.currentUser)throw new Error("Must login first");let S=await this.con.sendCommand("getlocale "+this.currentUser,{replyCodes:[H.RPL_GET_LOCALE]});return S[0].params?.[2].split("`")[1]??W.WolLocale.Unknown}async joinChannel(S,O){if(!this.currentUser)throw new Error("Must login before sending messages");let B=V.IrcProtocol.escapeChannelName(S);var N="join "+B+(void 0!==O?" "+O:"");if(N=await this.con.sendCommand(N,{replyCodes:[[H.ERR_NOSUCHCHANNEL,S=>!!S.params&&S.params[1]===this.currentUser&&S.params[2]===B],H.ERR_BADCHANNELKEY,H.ERR_CHANNELISFULL,H.ERR_BANNEDFROMCHAN],replyMatch:new RegExp(`^:${$.escape(this.currentUser)}![^ ]+ JOIN :[^ ]+ ${$.escape(B)}$`,"i")}),void 0!==N[0].code)switch(N[0].code){case H.ERR_NOSUCHCHANNEL:throw new j.WolError("No such channel",j.WolError.Code.NoSuchChannel);case H.ERR_BADCHANNELKEY:throw new j.WolError("Wrong password",j.WolError.Code.BadChannelPass);case H.ERR_CHANNELISFULL:throw new j.WolError("Channel is full",j.WolError.Code.ChannelFull);case H.ERR_BANNEDFROMCHAN:throw new j.WolError("Banned from channel",j.WolError.Code.BannedFromChannel);default:throw new Error("Unknown error")}else this.lastChannelOpts.set(S,O)}async listUsers(S){let O=await this.con.sendCommand("NAMES "+V.IrcProtocol.escapeChannelName(S),{replyCodes:[H.ERR_NOSUCHCHANNEL,H.ERR_NOTONCHANNEL],replyBodyCodes:[H.RPL_NAMREPLY],replyEndCode:H.RPL_ENDOFNAMES});if(O[0].code!==H.RPL_NAMREPLY)throw new Error("Unknown error");return this.parseNames(O.slice(0,-1)).sort((S,O)=>Number(O.operator)-Number(S.operator))}async rejoinLastChannels(){if(this.lastChannelOpts)for(var[S,O]of this.lastChannelOpts)this.isInChannel(S)||await this.joinChannel(S,O)}sendChatMessage(S,O){if(!this.currentUser)throw new Error("Must login before sending messages");O.type!==U.ChatRecipientType.Channel&&O.type!==U.ChatRecipientType.Whisper||this.privmsg([O.name],S)}privmsg(S,O){if(!this.currentUser)throw new Error("Must login before sending messages");var B,N=S.map(S=>S.startsWith("#")?V.IrcProtocol.escapeChannelName(S):S).join(",");for(B of(this.con.sendMessage(`privmsg ${N} :`+O),S)){var j=B.startsWith("#");this._onChatMessage.dispatch(this,{from:this.currentUser,to:{type:j?U.ChatRecipientType.Channel:U.ChatRecipientType.Whisper,name:B},text:O,time:new Date})}}kick(S,O,B){this.con.sendMessage(`kick ${V.IrcProtocol.escapeChannelName(O)} ${S.join(",")} :`+(B||""))}async listGames(S,O){if(!this.currentUser)throw new Error("Must login before sending messages");return(await this.con.sendCommand(`list ${S} `+S,{replyStartCode:H.RPL_LISTSTART,replyBodyCodes:[H.RPL_LIST,H.RPL_GAME_CHANNEL],replyEndCode:H.RPL_LISTEND})).slice(1,-1).map(S=>{if(!S.params||S.params.length<9)throw new Error(`Unexpected reply for list command "${S.raw}". Insufficient params.`);let B=V.IrcProtocol.unescapeChannelName(S.params[1]);var N=S.params[2],j=Number(S.params[4]),L=S.params[5],D=S.params[6],F=S.params[7],[_,U]=S.params[8]?.split("::")??[],H=S.params[9];if(j===O&&U&&(U=(new K.Parser).parseTopic(U)))return{hostName:B.match(/^#?([^']+)'s game$/)?.[1]??"",hostPing:Number(F),hostMuted:Boolean(Number(H)),name:B,description:U.description,modHash:U.modHash,modName:U.modName,tournament:Boolean(Number(L)),humanPlayers:Number(N),aiPlayers:U.aiPlayers,maxPlayers:U.maxPlayers,observers:U.observers,observable:U.observable,mapName:U.mapName,passLocked:384===Number(_),resLocked:Boolean(Number(D))}}).filter(F.isNotNullOrUndefined)}leaveChannel(S){this.currentChannels.has(S)&&(this.lastChannelOpts.delete(S),this.pendingChannelUsers.delete(S),this.con.sendMessage("PART "+V.IrcProtocol.escapeChannelName(S)))}leaveAllChannels(){for(var S of this.getCurrentChannels())this.leaveChannel(S)}async createGame(S,O,B,N,j,L,D=!1){if(!this.currentUser)throw new Error("Must login before sending messages");var F=V.IrcProtocol.escapeChannelName(S);await this.con.sendCommand(`joingame ${F} ${O} ${B} ${N} ${Number(D)} 0 ${Number(j)} 0`+(L?" "+L:""),{replyMatch:new RegExp(`^:${$.escape(this.currentUser)}![^ ]+ JOINGAME [^:]+:${$.escape(F)}$`,"i")}),this.logger.info(`Created game "${S}"`),this.currentChannels.add(S),this.currentGameChannel=S,this.logger.info(`Joined channel "${S}"`)}makeGameChannelName(){var S=this.getCurrentUser()+"'s game";return S=V.IrcProtocol.escapeChannelName("#"+S).slice(0,V.IrcProtocol.MAX_CHANNELNAME_LEN-1),V.IrcProtocol.unescapeChannelName(S)}async joinGame(S,O,B=!1){if(!this.currentUser)throw new Error("Must login before sending messages");var N=V.IrcProtocol.escapeChannelName(S);if(void 0===(N=await this.con.sendCommand(`joingame ${N} ${Number(B)} `+(O||""),{replyCodes:[H.ERR_BADCHANNELKEY,H.ERR_GAMEHASCLOSED,H.ERR_CHANNELISFULL,H.ERR_BANNEDFROMCHAN],replyMatch:new RegExp(`^:${$.escape(this.currentUser)}![^ ]+ JOINGAME [^:]+:${$.escape(N)}$`,"i")}))[0].code)return this.currentChannels.add(S),this.currentGameChannel=S,void this.logger.info(`Joined channel "${S}"`);switch(N[0].code){case H.ERR_BADCHANNELKEY:throw new j.WolError("Wrong password",j.WolError.Code.BadChannelPass);case H.ERR_GAMEHASCLOSED:throw new j.WolError("Game has closed",j.WolError.Code.GameHasClosed);case H.ERR_CHANNELISFULL:throw new j.WolError("Channel is full",j.WolError.Code.ChannelFull);case H.ERR_BANNEDFROMCHAN:throw new j.WolError("Banned from channel",j.WolError.Code.BannedFromChannel);default:throw new Error("Unknown error")}}sendGservPing(S,O){if(!this.currentGameChannel)throw new Error("No game channel active");var B=V.IrcProtocol.escapeChannelName(this.currentGameChannel);this.con.sendMessage(`gping ${B} ${S} `+Math.floor(O))}startGame(S){if(!this.currentGameChannel)throw new Error("No game channel active");var O=S.join(",");this.con.sendMessage(`startg ${V.IrcProtocol.escapeChannelName(this.currentGameChannel)} `+O)}parseNames(S){let O=[];return S.forEach(S=>{var B=this.parseNamReply(S);O=O.concat(B)}),O}parseNamReply(S){return S.raw.replace(new RegExp("^.*(=|\\*) [^ ]+ :"),"").split(" ").map(S=>S.split(",")).map(([S,,O,B])=>{var N=S.startsWith(e.CHAN_OP_PREFIX),j=Number(O);return{name:N?S.slice(e.CHAN_OP_PREFIX.length):S,operator:N,fresh:Boolean(Number(B)),ping:j}})}sendPlayerReady(S){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"A"+(S?1:0))}sendPlayerHasMap(S){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"K"+S)}sendGameStartRequest(){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"G")}sendGameSlotsInfo(S){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"L"+S)}sendPingData(S){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"P"+S)}sendObserverSlot(S){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"O"+S)}sendGameOpts(S){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,S)}sendPlayerOpts(S,O,B,N,j){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(S,`R${O},${B},${N},${j},0,0,0`)}sendModeChannelMax(S,O){this.con.sendMessage(`MODE ${V.IrcProtocol.escapeChannelName(S)} +l `+O)}sendGameTopic(S,O,B,N,j,F,U,H,W){if(!this.currentGameChannel)throw new Error("No game channel active");var z=(new _.FileNameEncoder).encode(F),K=D.Base64.encode(L.utf16ToBinaryString(H.slice(0,e.MAX_ROOM_DESC_LEN-1))),$=void 0!==W?D.Base64.encode(L.utf16ToBinaryString(W.slice(0,e.MAX_ROOM_DESC_LEN-1))):"",q=V.IrcProtocol.escapeChannelName(this.currentGameChannel);this.con.sendMessage(`topic ${q} :g${S}${O}N39,`+U+`,${B},${N},${j?1:0},`+z+`,${K},`+$)}gameOpt(S,O){if(!this.currentUser)throw new Error("Must login first");if(!this.currentGameChannel)throw new Error("No game channel active");var B=S.startsWith("#")?V.IrcProtocol.escapeChannelName(S):S;this.con.sendMessage(`gameopt ${B} :`+O),this._onGameOpt.dispatch(this,{user:this.currentUser,opt:O})}handleJoin(S){if(!(L=S.match(/^:([A-Za-z0-9-_]+)![^ ]+ JOIN :([^ ]+) ([^ ]+)/i)))throw new Error(`Unexpected JOIN message format "${S}"`);let[,O,B,N]=L;var j=B.trim().split(","),L=V.IrcProtocol.unescapeChannelName(N);this.currentUser===O&&(this.currentChannels.add(L),this.logger.info(`Joined channel "${L}"`)),this._onJoinChannel.dispatch(this,{type:"join",user:{name:O,ping:Number(j[1]),operator:Boolean(Number(j[2])),fresh:Boolean(Number(j[3]))},channel:L})}handleJoingame(S){var O=S.match(/^:([A-Za-z0-9-_]+)![^ ]+ JOINGAME ([^:]+):([^ ]+)/i);if(!O)throw new Error(`Unexpected JOINGAME message format "${S}"`);let[,B,N,j]=O;O=N.trim().split(" "),j=V.IrcProtocol.unescapeChannelName(j),B!==this.currentUser&&this.logger.info(`Player "${B}" joined game "${j}"`),this._onJoinChannel.dispatch(this,{type:"join",user:{name:B,operator:!1,ping:Number(O[5]),fresh:Boolean(Number(O[6]))},channel:j})}handleStartGame(S){var O;if(!(O=S.match(/^:[^ ]+ STARTG [^:]+:([^ ]+) :([^ ]+) (\d+)/i)))throw new Error(`Unexpected STARTG message format "${S}"`);var[,B,N,O]=O;this._onGameStart.dispatch(this,{gameId:N,timestamp:Number(O),gservUrl:B})}handleGserv(S){var O;if(!(O=S.match(/^[^ ]+ GSERV [^:]+:([^ ]+) ([^ ]+)/i)))throw new Error(`Unexpected GSERV message format "${S}"`);var[,B,O]=O;this._onGameServer.dispatch(this,{id:B,url:O})}handlePrivMsg(S){var O=S.match(/^:([A-Za-z0-9-_]+)![^ ]+ PRIVMSG ([^ ]+) :(.*)/i);if(!O)throw new Error(`Unexpected PRIVMSG message format "${S}"`);let B,[,N,j,L]=O;O=new Date,j.startsWith("#")?B={from:N,to:{type:U.ChatRecipientType.Channel,name:V.IrcProtocol.unescapeChannelName(j)},text:L,time:O}:j===this.currentUser&&(B={from:N,to:{type:U.ChatRecipientType.Whisper,name:j},text:L,time:O}),B&&this._onChatMessage.dispatch(this,B)}handleLoginQueueUpdate(S){if(!S.params)throw new Error("Unexpected queue update reply "+S.raw);let[,O,B]=S.params;this._onLoginQueueUpdate.dispatch(this,{position:Number(O.slice(1)),avgWaitSeconds:B?Number(B):0})}handleNamReply(S){if(!S.params)throw new Error(`Missing NAMREPLY params: "${S.raw}"`);var O=V.IrcProtocol.unescapeChannelName(S.params[2]),B=this.parseNamReply(S);let N=this.pendingChannelUsers.get(O);N?N.push(...B):this.pendingChannelUsers.set(O,B)}handleEndOfNames(S){if(!S.params)throw new Error(`Missing ENDOFNAMES params: "${S.raw}"`);var O=V.IrcProtocol.unescapeChannelName(S.params[1]);let B=this.pendingChannelUsers.get(O)??[];B.sort((S,O)=>Number(O.operator)-Number(S.operator)),this.pendingChannelUsers.delete(O),this._onChannelUsers.dispatch(this,{channelName:O,users:B})}handleGameReport(S){if(!S.params)throw new Error(`Missing GAME_REPORT params: "${S.raw}"`);if(S.params.length<2)throw new Error("Insufficient number of params for GAME_REPORT: "+S.params.length);var O=new q.WolGameReport(S.params[1].slice(1));this._onGameReport.dispatch(this,O)}handleIrcError(S){var O;if(O=S.match(/^:([A-Za-z0-9-_]+) (\d+) ([^ ]+) (?:([^ ]*) )?:(.*)/i)){var[,B,N,j,,O]=O;if([H.ERR_NOSUCHNICK,H.ERR_NOSUCHCHANNEL,H.ERR_NOTONCHANNEL,H.ERR_CHANOPRIVSNEEDED].includes(Number(N))){let S;j===this.currentUser&&(S={from:B,to:{type:U.ChatRecipientType.Page,name:j},text:O,time:new Date}),S&&this._onChatMessage.dispatch(this,S)}}}handlePageOrNotice(S){var O;if(!(O=S.match(/^:([A-Za-z0-9-_]+)(?:![^ ]+)? (?:PAGE|NOTICE) ([^ ]+) :(.*)/i)))throw new Error(`Unexpected PAGE message format "${S}"`);var[,B,N,O]=O,N={text:O,from:B,to:{type:U.ChatRecipientType.Page,name:N},time:new Date};this._onChatMessage.dispatch(this,N)}handlePart(S){if(!(B=S.match(/^:([A-Za-z0-9-_]+)![^ ]+ PART ([^ ]+)/i)))throw new Error(`Unexpected PART message format "${S}"`);var[,O,B]=B,B=V.IrcProtocol.unescapeChannelName(B);O===this.currentUser?(B===this.currentGameChannel&&(this.currentGameChannel=void 0),this.currentChannels.delete(B),this.lastChannelOpts.delete(B),this.pendingChannelUsers.delete(B),this.logger.info(`Left channel "${B}"`)):B===this.currentGameChannel&&this.logger.info(`Player "${O}" left game "${B}"`),this._onLeaveChannel.dispatch(this,{type:"leave",user:{name:O},channel:B})}handleKick(S){var O;if(!(O=S.match(/^:([A-Za-z0-9-_]+)![^ ]+ KICK ([^ ]+) ([A-Za-z0-9-_]+)/i)))throw new Error(`Unexpected KICK message format "${S}"`);var[,,B,O]=O,B=V.IrcProtocol.unescapeChannelName(B);O===this.currentUser&&(B===this.currentGameChannel&&(this.currentGameChannel=void 0),this.currentChannels.delete(B),this.lastChannelOpts.delete(B),this.pendingChannelUsers.delete(B),this.logger.info(`Left channel "${B}"`)),this._onLeaveChannel.dispatch(this,{type:"leave",user:{name:O},channel:B})}handleGameOpt(S){var O;if(!(O=S.match(/^:([A-Za-z0-9-_]+)![^ ]+ GAMEOPT ([^ ]+) :(.*)/i)))throw new Error(`Unexpected GAMEOPT message format"${S}"`);var[,B,,O]=O;this._onGameOpt.dispatch(this,{user:B,opt:O})}handleMode(S){var O=S.match(/^:([A-Za-z0-9-_]+)![^ ]+ MODE ([^ ]+) \+l (\d+)/i);O?([,,,O]=O,this._onGameMode.dispatch(this,Number(O))):this.logger.warn("Got unknown MODE line: "+S)}}),Z.MAX_ROOM_DESC_LEN=64,Z.CHAN_OP_PREFIX="@"}}}),System.register("network/WolError",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;B=class extends Error{constructor(S,O,B){super(S),this.code=O,this.reason=B}},S("WolError",B),(O=(O=B||S("WolError",B={})).Code||(O.Code={}))[O.OutdatedClient=0]="OutdatedClient",O[O.BadLogin=1]="BadLogin",O[O.BadChannelPass=2]="BadChannelPass",O[O.GameHasClosed=3]="GameHasClosed",O[O.ChannelFull=4]="ChannelFull",O[O.BannedFromChannel=5]="BannedFromChannel",O[O.BannedFromServer=6]="BannedFromServer",O[O.NoSuchChannel=7]="NoSuchChannel",O[O.ServerFull=8]="ServerFull"}}}),System.register("network/WolGameReport",["util/Base64"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S}],execute:function(){var O;(O=N||S("WolGameReportResult",N={}))[O.Win=0]="Win",O[O.Loss=1]="Loss",O[O.Draw=2]="Draw",S("WolGameReport",class{constructor(S){var O=JSON.parse(B.Base64.decode(S));return this.gameId=O.gameId,this.players=O.players,this.duration=O.duration,this}})}}}),System.register("network/WolLocale",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("WolLocale",B={}))[O.Unknown=0]="Unknown",O[O.Other=1]="Other",O[O.Usa=2]="Usa",O[O.Canada=3]="Canada",O[O.Uk=4]="Uk",O[O.Germany=5]="Germany",O[O.France=6]="France",O[O.Spain=7]="Spain",O[O.Netherlands=8]="Netherlands",O[O.Belgium=9]="Belgium",O[O.Austria=10]="Austria",O[O.Switzerland=11]="Switzerland",O[O.Italy=12]="Italy",O[O.Denmark=13]="Denmark",O[O.Sweden=14]="Sweden",O[O.Norway=15]="Norway",O[O.Finland=16]="Finland",O[O.Israel=17]="Israel",O[O.SouthAfrica=18]="SouthAfrica",O[O.Japan=19]="Japan",O[O.SouthKorea=20]="SouthKorea",O[O.China=21]="China",O[O.Singapore=22]="Singapore",O[O.Taiwan=23]="Taiwan",O[O.Malaysia=24]="Malaysia",O[O.Australia=25]="Australia",O[O.NewZealand=26]="NewZealand",O[O.Brazil=27]="Brazil",O[O.Thailand=28]="Thailand",O[O.Argentina=29]="Argentina",O[O.Philippines=30]="Philippines",O[O.Greece=31]="Greece",O[O.Ireland=32]="Ireland",O[O.Poland=33]="Poland",O[O.Portugal=34]="Portugal",O[O.Mexico=35]="Mexico",O[O.Russia=36]="Russia",O[O.Turkey=37]="Turkey",S("localeCodeMap",(new Map).set("en-US",B.Usa).set("en-GB",B.Uk).set("de-DE",B.Germany).set("es-ES",B.Spain).set("fr-FR",B.France).set("it-IT",B.Italy).set("ja-JP",B.Japan).set("ko-KR",B.SouthKorea).set("nl-NL",B.Netherlands).set("pl-PL",B.Poland).set("pt-BR",B.Brazil).set("pt-PT",B.Portugal).set("ru-RU",B.Russia).set("zh-CN",B.China).set("zh-TW",B.Taiwan))}}}),System.register("network/WolService",["util/event","engine/ResourceLoader","data/IniFile","network/WolError","network/WolLocale","network/IrcConnection"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){S("WolService",_=class e{get onWolConnectionLost(){return this._onWolConnectionLost.asEvent()}constructor(S,O,N,j){this.wolConfig=S,this.wolCon=O,this.clientVersion=N,this.clientLocale=j,this.ignoreLastWolClose=!1,this._onWolConnectionLost=new B.EventDispatcher,this.autoReconnect=!1,this.pendingReconnect=!1,this.onWolClose=S=>{this.connectOpts&&!this.ignoreLastWolClose&&(this.autoReconnect&&!this.pendingReconnect&&(this.reconnectTimeout=setTimeout(()=>this.tryReconnect(e.MIN_RECONNECT_MILLIS),0)),this._onWolConnectionLost.dispatch(this,S)),this.ignoreLastWolClose=!1},this.onGameReport=S=>{this.lastGameReport=S}}init(){this.wolCon.onGameReport.subscribe(this.onGameReport),this.wolCon.onClose.subscribe(this.onWolClose)}getConfig(){return this.wolConfig}getConnection(){return this.wolCon}isConnected(){return this.wolCon.isOpen()}getCredentials(){return this.connectOpts?{user:this.connectOpts.user,pass:this.connectOpts.pass}:void 0}getLastGameReport(){return this.lastGameReport}async connectAndLogin(S,O){var B,{url:N,user:j,pass:_}=S;this.cancelReconnect(),this.wolCon.isOpen()&&JSON.stringify(this.connectOpts)!==JSON.stringify(S)&&this.closeWolConnection(),this.connectOpts=S,this.ignoreLastWolClose=!0;try{await this.wolCon.connect(N),await this.wolCon.cvers(this.clientVersion,this.wolConfig.getClientSku()),void 0===this.clientLocale||void 0!==(B=D.localeCodeMap.get(this.clientLocale))&&await this.wolCon.setLocale(B);let S=await this.wolCon.login(j,_,O);return this.ignoreLastWolClose=!1,S.map(S=>({text:S}))}catch(S){throw S instanceof L.WolError||S instanceof F.IrcConnection.ConnectError||S instanceof F.IrcConnection.SocketError||(this.ignoreLastWolClose=!1),S}}async loadServerList(S,O){let B=new N.ResourceLoader("");var L=await B.loadText(S,O);return(new j.IniFile).fromString(L)}async validateGameVersion(S){if(S.gameVersion&&!this.matchVersions(this.clientVersion,S.gameVersion))throw new L.WolError(`Game version mismatch: client version is ${this.clientVersion}, but expected `+S.gameVersion,L.WolError.Code.OutdatedClient)}matchVersions(S,O){let[B,N,j]=S.split(".");var[L,D,F]=O.split(".");return B===L&&N===D&&Number(j.split("-")[0])>=Number(F)}async tryReconnect(S){if(this.connectOpts&&!this.pendingReconnect)try{this.pendingReconnect=!0,await this.connectAndLogin(this.connectOpts),await this.wolCon.rejoinLastChannels()}catch(O){if(O instanceof L.WolError)console.error("Failed to reconnect to WoL service",O);else{let O=Math.min(e.MAX_RECONNECT_MILLIS,2*S);this.reconnectTimeout=setTimeout(()=>this.tryReconnect(O),S)}}finally{this.pendingReconnect=!1}}setAutoReconnect(S){S!==this.autoReconnect&&((this.autoReconnect=S)||this.cancelReconnect())}closeWolConnection(){this.cancelReconnect(),this.wolCon.isOpen()&&(this.connectOpts=void 0,this.ignoreLastWolClose=!0,this.wolCon.leaveAllChannels(),this.wolCon.close())}dispose(){this.cancelReconnect(),this.wolCon.onGameReport.unsubscribe(this.onGameReport),this.wolCon.onClose.unsubscribe(this.onWolClose)}cancelReconnect(){this.pendingReconnect&&this.wolCon.close(),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}}),_.MIN_RECONNECT_MILLIS=5e3,_.MAX_RECONNECT_MILLIS=6e4}}}),System.register("network/chat/ChatMessage",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("ChatRecipientType",B={}))[O.Channel=0]="Channel",O[O.Page=1]="Page",O[O.Whisper=2]="Whisper"}}}),System.register("network/chat/Message",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/chat/SystemMessage",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/gameopt/FileNameEncoder",["util/Base64","util/string"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("FileNameEncoder",class{encode(S){return S.match(/^[a-z0-9-_]+\.[a-z]{3}$/i)?S:B.Base64.encode(N.utf16ToBinaryString(S))}decode(S){return S.match(/\.[a-z]{3}$/i)?S:N.binaryStringToUtf16(B.Base64.decode(S))}})}}}),System.register("network/gameopt/LoadInfoParser",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("LoadInfoParser",class{parse(S){let O=[];var B=S.split(",");for(let S=0;S<B.length/5;++S){var N={name:B[5*S],status:Number(B[5*S+1]),loadPercent:Number(B[5*S+2]),ping:Number(B[5*S+3]),lagAllowanceMillis:Number(B[5*S+4])};O.push(N)}return O}})}}}),System.register("network/gameopt/MapNameLegacyEncoder",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("MapNameLegacyEncoder",class{encode(S){let O=[],B=0;return S.split("").forEach((S,N)=>{var j,L=127&(j=S.charCodeAt(0)<<2*N-7*B),D=j>>7&127;(j=j>>14&127)&&B++,O.push(L,D),j&&O.push(j)}),O.push(0,0),2<=S.length&&O.push(0),O=O.map(S=>128^S),O.map(S=>String.fromCharCode(S)).join("")}decode(S){let O=S.split("").map(S=>S.charCodeAt(0));for(O=O.map(S=>128^S);0===O[O.length-1];)O.pop();let B=[],N=0,j=0;for(;O.length;){var L=B.length,D=O.shift(),F=O.shift();let S=0,_=!1;(-1!==[1,2,3].indexOf(O[0])||L>N+3)&&(S=O.shift(),N=L,_=!0),L=(S<<14|F<<7|D)>>2*L-7*j,B.push(127&L),_&&j++}return B.map(S=>String.fromCharCode(S)).join("")}})}}}),System.register("network/gameopt/Parser",["data/DataStream","network/gameopt/MapNameLegacyEncoder","network/gameopt/SlotInfo","game/gameopts/GameOpts","network/gameopt/FileNameEncoder","util/Base64","util/string"],function(S,O){"use strict";var B,N,j,L,D,F,_;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){S("Parser",class{parseOptions(S){let O={},[B,j,,L]=S.split(":"),U=B.split(",");U.shift(),U.shift(),O.gameSpeed=6-Number(U.shift()),O.credits=Number(U.shift()),O.unitCount=Number(U.shift()),O.shortGame=Boolean(Number(U.shift())),O.superWeapons=Boolean(Number(U.shift())),O.buildOffAlly=Boolean(Number(U.shift())),O.mcvRepacks=Boolean(Number(U.shift())),O.cratesAppear=Boolean(Number(U.shift())),O.gameMode=Number(U.shift()),O.hostTeams=Boolean(Number(U.shift()));var H=U.shift();return O.mapTitle=F.Base64.isBase64(H)?_.binaryStringToUtf16(F.Base64.decode(H)):(new N.MapNameLegacyEncoder).decode(H),O.maxSlots=Number(U.shift()),O.mapOfficial=Boolean(Number(U.shift())),O.mapSizeBytes=Number(U.shift()),O.mapName=(new D.FileNameEncoder).decode(U.shift()),O.mapDigest=U.shift(),O.destroyableBridges=Boolean(Number(U.shift()??"1")),O.multiEngineer=Boolean(Number(U.shift()??"0")),O.noDogEngiKills=Boolean(Number(U.shift()??"0")),O.unknown=U.length?U.join(","):void 0,O.humanPlayers=this.parsePlayerOpts(j),O.aiPlayers=this.parseAiOpts(L?.slice(0,-1)),O}parsePlayerOpts(S){var O=S.split(",");if(O.length%8!=0)throw new Error("Couldn't parse gameopt: unexpected players data length "+O.length);let B=[];for(let S=0,j=Math.floor(O.length/8);S<j;++S){var N={name:O[8*S],countryId:Number(O[8*S+1]),colorId:Number(O[8*S+2]),startPos:Number(O[8*S+3]),teamId:Number(O[8*S+4])};B.push(N)}return B}parseAiOpts(S){let O=[];if(S){var B=S.split(",");if(B.length%5!=0)throw new Error("Couldn't parse gameopt: unexpected ai data length "+B.length);for(let S=0,j=Math.floor(B.length/5);S<j;++S){var N={difficulty:Number(B[5*S]),countryId:Number(B[5*S+1]),colorId:Number(B[5*S+2]),startPos:Number(B[5*S+3]),teamId:Number(B[5*S+4])};O.push(-1!==N.countryId?N:void 0)}}return O}parseTopic(S){var O=S.split(",");if(!(O.length<6)){var B=O[0],N=Number(O[1]),j=B[2],L=O[2],U=O[3],H=O[4];return B=(new D.FileNameEncoder).decode(O[5]),{description:O[6]?_.binaryStringToUtf16(F.Base64.decode(O[6])):"",modHash:N,modName:O[7]?_.binaryStringToUtf16(F.Base64.decode(O[7])):void 0,aiPlayers:Number(L),maxPlayers:Number(j),observers:Number(U),observable:Boolean(Number(H)),mapName:B}}}parsePingData(S){var O=S.split(",").slice(1);if(O.length%2)throw new Error("Couldn't parse gameopt: unexpected ping data length "+O.length);let B=[];for(let S=0,N=Math.floor(O.length/2);S<N;++S)B.push({playerName:O[2*S],ping:Number(O[2*S+1])});return B}parseSlotData(S){var O;let B=[];for(O of S.slice(1,-1).split(",")){let S={};if("@Closed@"===O)S.type=j.SlotType.Closed;else if("@Open@"===O)S.type=j.SlotType.Open;else if("@OpenObserver@"===O)S.type=j.SlotType.OpenObserver;else if(-1!==["@EasyAI@","@MediumAI@","@HardAI@"].indexOf(O)){let B;if(S.type=j.SlotType.Ai,"@EasyAI@"===O)B=L.AiDifficulty.Easy;else if("@MediumAI@"===O)B=L.AiDifficulty.Medium;else{if("@HardAI@"!==O)throw new Error("Couldn't parse gameopt: unknown slot type "+O);B=L.AiDifficulty.Brutal}S.difficulty=B}else S.type=j.SlotType.Player,S.name=O;B.push(S)}return B}parsePlayerActions(S){let O=new B.DataStream(S);var N=O.readUint8();let j=[];for(let S=0;S<N;++S){var L=O.readUint8(),D=0<(D=O.readUint16())?O.readUint8Array(D):new Uint8Array;j.push({id:L,params:D})}return j}parseAllPlayerActions(S){var O=S.readUint8();let B=new Map;for(let L=0;L<O;++L){var N=S.readUint8(),j=0<(j=S.readUint16())?S.readUint8Array(j):new Uint8Array;j=this.parsePlayerActions(j),B.set(N,j)}return B}parseMapData(S){return _.uint8ArrayToBinaryString(S)}})}}}),System.register("network/gameopt/PingInfo",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/gameopt/Serializer",["data/DataStream","network/gameopt/SlotInfo","game/gameopts/GameOpts","network/gameopt/MapNameLegacyEncoder","network/gameopt/FileNameEncoder","util/Base64","util/string"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){S("Serializer",U=class e{serializeOptions(S,O=!1){let B=S.gameMode,N=O?(new L.MapNameLegacyEncoder).encode(S.mapTitle):F.Base64.encode(_.utf16ToBinaryString(S.mapTitle)),j=(new D.FileNameEncoder).encode(S.mapName);return["0","0",6-S.gameSpeed,S.credits,S.unitCount,Number(S.shortGame),Number(S.superWeapons),Number(S.buildOffAlly),Number(S.mcvRepacks),Number(S.cratesAppear),B,Number(S.hostTeams??!1),N,S.maxSlots,Number(S.mapOfficial),S.mapSizeBytes,j,S.mapDigest,Number(S.destroyableBridges),Number(S.multiEngineer),Number(S.noDogEngiKills),...S.unknown?[S.unknown]:[]].join(",")+`:${S.humanPlayers.map(S=>S.name+`,${S.countryId},${S.colorId},${S.startPos},${S.teamId},0,0,0`).join(",")}:@:${this.serializeAiOpts(S.aiPlayers)},`}serializeAiOpts(S){return S.map(S=>S?`${S.difficulty},${S.countryId},${S.colorId},${S.startPos},`+S.teamId:"0,-1,-1,-1,-1").join(",")}serializePingData(S){return S.length+","+S.map(S=>S.playerName+","+S.ping).join(",")}serializeSlotData(S){return S.map(S=>{if(S.type===N.SlotType.Closed)return"@Closed@";if(S.type===N.SlotType.Open)return"@Open@";if(S.type===N.SlotType.OpenObserver)return"@OpenObserver@";if(S.type===N.SlotType.Ai){if(S.difficulty===j.AiDifficulty.Easy)return"@EasyAI@";if(S.difficulty===j.AiDifficulty.Medium)return"@MediumAI@";if(S.difficulty===j.AiDifficulty.Brutal)return"@HardAI@"}else if(S.type===N.SlotType.Player)return S.name;throw new Error("Unexpected slot info with type "+N.SlotType[S.type])}).join(",")+","}serializeLoadInfo(S){return S.map(S=>[S.name,S.status,S.loadPercent,S.ping,S.lagAllowanceMillis].join(",")).join(",")}serializePlayerActions(S){let O=new B.DataStream;for(var{id:N,params:j}of(O.writeUint8(S.length),S))if(O.writeUint8(N),O.writeUint16(j.byteLength),0<j.byteLength){if(j.byteLength>e.MAX_ACTION_PAYLOAD_SIZE-O.position)throw console.error(`Action #${N} payload exceeds max data size`,j),new RangeError("Maximum payload data size exceeded");O.writeUint8Array(j)}return O.toUint8Array()}serializeAllPlayerActions(S,O){for(var[B,N]of(S.writeUint8(O.size),O)){S.writeUint8(B);var j=this.serializePlayerActions(N);if(S.writeUint16(j.byteLength),0<j.byteLength){if(j.byteLength>e.MAX_ACTION_PAYLOAD_SIZE)throw console.error(`Player #${B} actions payload exceeds max data size`,N),new RangeError("Maximum payload data size exceeded");S.writeUint8Array(j)}}}serializeMapData(S){return _.binaryStringToUint8Array(S)}}),U.MAX_ACTION_PAYLOAD_SIZE=65536}}}),System.register("network/gameopt/SlotInfo",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("SlotType",B={}))[O.Closed=0]="Closed",O[O.Open=1]="Open",O[O.OpenObserver=2]="OpenObserver",O[O.Player=3]="Player",O[O.Ai=4]="Ai"}}}),System.register("network/gameopt/WolGameTopic",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/gameres/GameRes",["data/DataStream","engine/type/ObjectType","game/gameopts/constants","util/typeGuard","network/gameres/GameResType"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S}],execute:function(){var O;(O=F=F||{})[O.Byte=1]="Byte",O[O.Boolean=2]="Boolean",O[O.Time=5]="Time",O[O.Int=6]="Int",O[O.String=7]="String",S("GameRes",class{fromGame(S,O,B){let D=S.gameOpts,F=S.gameOpts.humanPlayers.filter(S=>S.countryId!==j.OBS_COUNTRY_ID).map(O=>S.getPlayerByName(O.name));this.game={id:S.id,startTime:S.startTimestamp,duration:Math.floor(S.currentTime/1e3),speed:6-D.gameSpeed,players:F.length,mapName:D.mapName,mapDigest:D.mapDigest,unitCount:D.unitCount,cratesAppear:D.cratesAppear,credits:D.credits,tournament:O,shortGame:D.shortGame,superWeapons:D.superWeapons,aiPlayers:D.aiPlayers.filter(L.isNotNullOrUndefined).length,gameMode:D.gameMode,buildOffAlly:D.buildOffAlly,mcvRepacks:D.mcvRepacks,destroyableBridges:D.destroyableBridges,multiEngineer:D.multiEngineer,noDogEngiKills:D.noDogEngiKills},this.client=B;let _=this.computePlayerTeams(S,F);return this.players=F.map(O=>({buildingsBuilt:O.getUnitsBuilt(N.ObjectType.Building),buildingsCaptured:O.buildingsCaptured,buildingsKilled:O.getUnitsKilled(N.ObjectType.Building),buildingsLeft:O.buildings.size,color:2*[...S.rules.colors.values()].findIndex(S=>S.asHex()===O.color.asHex())+1,cratesFound:O.cratesPickedUp,endCredits:O.credits,infantryBuilt:O.getUnitsBuilt(N.ObjectType.Infantry),infantryKilled:O.getUnitsKilled(N.ObjectType.Infantry),infantryLeft:O.getOwnedObjectsByType(N.ObjectType.Infantry).length,lostConnection:O.name===B.accountName&&B.suddenDisconnect,name:O.name,planesBuilt:O.getUnitsBuilt(N.ObjectType.Aircraft),planesKilled:O.getUnitsKilled(N.ObjectType.Aircraft),planesLeft:O.getOwnedObjectsByType(N.ObjectType.Aircraft).length,unitsBuilt:O.getUnitsBuilt(N.ObjectType.Vehicle),unitsKilled:O.getUnitsKilled(N.ObjectType.Vehicle),unitsLeft:O.getOwnedObjectsByType(N.ObjectType.Vehicle).length,completionStatus:this.getCompletionStatus(O,S,this.client,F.length),country:O.country.id,side:O.country.side,team:_.get(O)})),this}computePlayerTeams(S,O){let B=new Map,N=0;for(var j of O)if(!B.has(j)){var L;for(L of(B.set(j,N),S.alliances.getAllies(j)))B.has(L)||B.set(L,N);N++}return B}getCompletionStatus(S,O,B,N){return B.finished?O.stalemateDetectTrait?.isStale()&&0===O.stalemateDetectTrait.getCountdownTicks()?D.GameResType.Draw:!S.defeated||O.alliances.getAllies(S).some(S=>!S.defeated)?D.GameResType.Win:S.resigned?D.GameResType.Resign:S.dropped?D.GameResType.Disconnect:D.GameResType.Loss:B.outOfSync?D.GameResType.Disconnect:2<N?B.accountName!==S.name?D.GameResType.Playing:B.quit?D.GameResType.Resign:D.GameResType.Disconnect:B.accountName!==S.name?D.GameResType.Win:B.quit?D.GameResType.Resign:S.defeated?D.GameResType.Loss:D.GameResType.Disconnect}toFlat(){return{AFPS:[F.Int,this.client.avgFps],APNG:[F.Int,this.client.avgRtt],AIPL:[F.Int,this.game.aiPlayers],CRAT:[F.Boolean,this.game.cratesAppear],DURA:[F.Int,this.game.duration],FINI:[F.Boolean,this.client.finished],GSKU:[F.Int,this.client.gameSku],CRED:[F.Int,this.game.credits],OOSY:[F.Boolean,this.client.outOfSync],PLRS:[F.Int,this.game.players],PNGR:[F.Int,this.client.pingsRecv],PNGS:[F.Int,this.client.pingsSent],SCEN:[F.String,this.game.mapName],SHRT:[F.Boolean,this.game.shortGame],SPED:[F.Int,this.game.speed],SUPR:[F.Boolean,this.game.superWeapons],TIME:[F.Time,this.game.startTime],TRNY:[F.Boolean,this.game.tournament],UNIT:[F.Int,this.game.unitCount],VERS:[F.String,this.client.clientVers],MODE:[F.Int,this.game.gameMode],BAMR:[F.Int,Number(this.game.mcvRepacks)+2*Number(this.game.buildOffAlly)],MAPC:[F.String,this.game.mapDigest],GMID:[F.String,this.game.id],SNAM:[F.String,this.client.accountName],DSTB:[F.Boolean,this.game.destroyableBridges],MENG:[F.Boolean,this.game.multiEngineer],DOGK:[F.Boolean,this.game.noDogEngiKills],...this.players.map((S,O)=>({["BLB"+O]:[F.Time,S.buildingsBuilt],["BLC"+O]:[F.Int,S.buildingsCaptured],["BLK"+O]:[F.Time,S.buildingsKilled],["BLL"+O]:[F.Time,S.buildingsLeft],["COL"+O]:[F.Int,S.color],["CRA"+O]:[F.Int,S.cratesFound],["CRD"+O]:[F.Time,S.endCredits],["INB"+O]:[F.Time,S.infantryBuilt],["INK"+O]:[F.Time,S.infantryKilled],["INL"+O]:[F.Time,S.infantryLeft],["LCN"+O]:[F.Boolean,S.lostConnection],["NAM"+O]:[F.String,S.name],["PLB"+O]:[F.Time,S.planesBuilt],["PLK"+O]:[F.Time,S.planesKilled],["PLL"+O]:[F.Time,S.planesLeft],["UNB"+O]:[F.Time,S.unitsBuilt],["UNK"+O]:[F.Time,S.unitsKilled],["UNL"+O]:[F.Time,S.unitsLeft],["CMP"+O]:[F.Int,S.completionStatus],["CTY"+O]:[F.Int,S.country],["SID"+O]:[F.Int,S.side],["TID"+O]:[F.Int,S.team]})).reduce((S,O)=>({...S,...O}),{})}}fromFlat(S){function t(S){return S[0]===F.Int||S[0]===F.Time?S[1]:0}function i(S){return S[0]===F.Boolean&&S[1]}function r(S){return S[0]===F.String?S[1]:""}var O=t(S.PLRS),B=t(S.BAMR),N=Boolean(1&B);B=Boolean(2&B),this.game={aiPlayers:t(S.AIPL),cratesAppear:i(S.CRAT),duration:t(S.DURA),credits:t(S.CRED),id:r(S.GMID),players:O,mapName:r(S.SCEN),shortGame:i(S.SHRT),speed:t(S.SPED),superWeapons:i(S.SUPR),startTime:t(S.TIME),tournament:i(S.TRNY),unitCount:t(S.UNIT),gameMode:t(S.MODE),buildOffAlly:B,mcvRepacks:N,mapDigest:r(S.MAPC),destroyableBridges:void 0===S.DSTB||i(S.DSTB),multiEngineer:void 0!==S.MENG&&i(S.MENG),noDogEngiKills:void 0!==S.DOGK&&i(S.DOGK)},this.players=new Array(O).fill(0).map((O,B)=>({buildingsBuilt:t(S["BLB"+B]),buildingsCaptured:t(S["BLC"+B]),buildingsKilled:t(S["BLK"+B]),buildingsLeft:t(S["BLL"+B]),color:t(S["COL"+B]),cratesFound:t(S["CRA"+B]),endCredits:t(S["CRD"+B]),infantryBuilt:t(S["INB"+B]),infantryKilled:t(S["INK"+B]),infantryLeft:t(S["INL"+B]),lostConnection:i(S["LCN"+B]),name:r(S["NAM"+B]),planesBuilt:t(S["PLB"+B]),planesKilled:t(S["PLK"+B]),planesLeft:t(S["PLL"+B]),unitsBuilt:t(S["UNB"+B]),unitsKilled:t(S["UNK"+B]),unitsLeft:t(S["UNL"+B]),completionStatus:t(S["CMP"+B]),country:t(S["CTY"+B]),side:t(S["SID"+B]),team:t(S["TID"+B])}));let j=r(S.SNAM);O=this.players.find(S=>S.name===j),this.client={avgFps:t(S.AFPS),avgRtt:t(S.APNG??0),finished:i(S.FINI),gameSku:t(S.GSKU),outOfSync:i(S.OOSY),pingsRecv:t(S.PNGR),pingsSent:t(S.PNGS),clientVers:r(S.VERS),quit:O?.completionStatus===D.GameResType.Resign,accountName:j,suddenDisconnect:O?.lostConnection??!1}}toBinary(){var S,O=new B.DataStream,N=this.toFlat();for(S of Object.keys(N)){var[j,L]=N[S];this.writeType(j,S,L,O)}let D=new B.DataStream;return D.writeUint16(O.byteLength+4,B.DataStream.BIG_ENDIAN),D.writeUint16(0),D.writeUint8Array(new Uint8Array(O.buffer,O.byteOffset,O.byteLength)),new Uint8Array(D.buffer,D.byteOffset,D.byteLength)}fromBinary(S){let O=new B.DataStream(S);var N=O.readUint16(B.DataStream.BIG_ENDIAN)-4;if(0!==O.readUint16())throw new Error("Invalid game res packet. Second byte should be 0.");let j={};for(;N&&O.position<=N-4;){var{fieldName:L,type:D,data:F}=this.readType(O);void 0!==F&&(j[L]=[D,F])}return this.fromFlat(j),this}writeType(S,O,N,j){if(4<O.length)throw new Error(`Field "${O}" must not exceed 4 characters`);switch(j.writeString(O,"ASCII",4),j.writeUint16(S,B.DataStream.BIG_ENDIAN),S){case F.Byte:return j.writeUint16(1,B.DataStream.BIG_ENDIAN),j.writeUint32(N,B.DataStream.BIG_ENDIAN);case F.Boolean:return j.writeUint16(1,B.DataStream.BIG_ENDIAN),j.writeUint8Array([N?1:0,0,0,0]);case F.Time:case F.Int:return j.writeUint16(4,B.DataStream.BIG_ENDIAN),j.writeUint32(N,B.DataStream.BIG_ENDIAN);case F.String:var L=N.length+1;return j.writeUint16(L,B.DataStream.BIG_ENDIAN),j.writeCString(N,4*Math.ceil(L/4));default:throw new Error(`Unhandled type "${S}"`)}}readType(S){var O=S.readString(4,"ASCII"),N=S.readUint16(B.DataStream.BIG_ENDIAN),j=S.readUint16(B.DataStream.BIG_ENDIAN);let L;switch(N){case F.Byte:L=S.readUint32(B.DataStream.BIG_ENDIAN);break;case F.Boolean:L=Boolean(S.readUint8Array(4)[0]);break;case F.Time:case F.Int:L=S.readUint32(B.DataStream.BIG_ENDIAN);break;case F.String:L=S.readCString(4*Math.ceil(j/4));break;default:console.warn(`Unknown game res field type "${N}"`),S.position+=j,L=void 0}return{fieldName:O,type:N,data:L}}})}}}),System.register("network/gameres/GameResClientInfo",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/gameres/GameResGameInfo",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/gameres/GameResPlayerInfo",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("GameResPlayerInfo",class{})}}}),System.register("network/gameres/GameResType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("GameResType",B={}))[O.ConnectionLost=2]="ConnectionLost",O[O.Playing=8]="Playing",O[O.Draw=64]="Draw",O[O.Win=256]="Win",O[O.Loss=512]="Loss",O[O.Resign=528]="Resign",O[O.Disconnect=768]="Disconnect"}}}),System.register("network/gamestate/ActionSerializer",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("ActionSerializer",class{getActionPayload(S){return{id:S.actionType,params:S.serialize()}}})}}}),System.register("network/gamestate/LockstepManager",["data/DataStream","game/action/NoAction","game/Game","util/event","network/gservConfig","game/GameSpeed","network/gamestate/lockstepUtil"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S}],execute:function(){S("LockstepManager",U=class e{get onLagStateChange(){return this._onLagStateChange.asEvent()}get onActionsSent(){return this._onActionsSent.asEvent()}get onActionsProcessed(){return this._onActionsProcessed.asEvent()}get onActionsReceived(){return this._onActionsReceived.asEvent()}constructor(S,O,N,j,D,F,_,U,H,V,W,z,K){this.game=S,this.gservCon=O,this.gameoptParser=N,this.gameoptSerializer=j,this.actionSerializer=D,this.actionFactory=F,this.inputActions=_,this.onDesync=U,this.actionLogger=H,this.netLogger=V,this.debugLogger=W,this.replayRecorder=z,this.debugGameState=K,this.debugGameStateHistory=[],this.queuedRateChanges=[],this.errorState=!1,this.passiveMode=!1,this.receivedActions=new Map,this.receivedNetworkTurn=0,this.lagState=!1,this._onLagStateChange=new L.EventDispatcher,this._onActionsSent=new L.EventDispatcher,this._onActionsProcessed=new L.EventDispatcher,this._onActionsReceived=new L.EventDispatcher,this.receiveActions=S=>{let O=new B.DataStream(S);var N=O.readUint32(),j=this.gameoptParser.parseAllPlayerActions(O);this.receivedNetworkTurn=N,this.receivedActions.set(N,j),this._onActionsReceived.dispatch(void 0,N)},this.handleGameDesync=()=>{this.setErrorState(),this.onDesync()}}init(){this.gameTurnMillis=1e3/(this.game.desiredSpeed.value*F.GameSpeed.BASE_TICKS_PER_SECOND),this.currentNetworkTurn=0,this.currentSubTurn=0,this.gservCon.onGameActions.subscribe(this.receiveActions),this.gservCon.onGameDesync.subscribe(this.handleGameDesync),this.debug("Init: gameTurnMillis = "+this.gameTurnMillis)}canAdvanceNetworkTurn(){return this.currentNetworkTurn<2||this.receivedActions.has(this.currentNetworkTurn-2)}setErrorState(){this.errorState=!0}getErrorState(){return this.errorState}setRate(S){if(this.debug(`Recv rate: ${S.rate} (turn ${S.turnNo})`),0===this.currentSubTurn&&0===this.currentNetworkTurn&&0===S.turnNo)this.updateRate(S.rate);else{if(S.turnNo<this.currentNetworkTurn-2)throw new Error("Rate change has turn number more than two turns in the past.");this.queuedRateChanges.push(S)}}updateRate(S){this.networkTurnMillis=_.computeNetworkTurnMillis(S,this.gameTurnMillis),this.hashCheckTurnInterval=Math.ceil(e.PREFERRED_HASH_CHECK_MILLIS/this.networkTurnMillis),this.netLogger?.debug(`Rate set to ${S} (${this.networkTurnMillis}ms) @ `+this.currentNetworkTurn)}setPassiveMode(S){this.debug("Send passive: "+S),this.passiveMode=S,this.gservCon.sendPlayerActive(!S)}getTurnMillis(){return this.gameTurnMillis}doGameTurn(S){if(!this.errorState){if(!this.networkTurnMillis)throw new Error("Network turn rate should be set by now.");if(this.game.status!==j.GameStatus.Ended){if(0===this.currentSubTurn){var O=this.queuedRateChanges[0];if(O&&O.turnNo+2===this.currentNetworkTurn&&(this.debug(`Process rate ${O.rate} (turn ${O.turnNo})`),this.updateRate(O.rate),this.queuedRateChanges.shift()),!this.canAdvanceNetworkTurn())return this.handleCommsLag(!0,S),this.debug("Lag state: "+this.lagState),!1;this.debug("Advance turn"),this.commsLagStartTime&&0<S-this.commsLagStartTime&&this.netLogger?.debug(`Waited ${Math.round(S-this.commsLagStartTime)}ms for other clients to catch up.`),this.handleCommsLag(!1,S),!this.passiveMode&&this.currentNetworkTurn>=this.receivedNetworkTurn&&this.sendActions(),2<=this.currentNetworkTurn&&(B=this.receivedActions.get(this.currentNetworkTurn-2),this.replayRecorder.recordActions(this.game.currentTick,B),this.processActions(B),this.receivedActions.delete(this.currentNetworkTurn-2),this._onActionsProcessed.dispatch(void 0,this.currentNetworkTurn-2)),this.game.update(),this.passiveMode||this.currentNetworkTurn%this.hashCheckTurnInterval!=0||this.gservCon.sendGameStateHash(this.currentNetworkTurn,this.game.getHash()),this.networkTurnMillis>this.gameTurnMillis?this.currentSubTurn++:this.currentNetworkTurn++}else this.debug("Update"),this.game.update(),this.currentSubTurn++,this.currentSubTurn>=this.networkTurnMillis/this.gameTurnMillis&&(this.currentSubTurn=0,this.currentNetworkTurn++);var B;this.debugGameState&&(B=this.networkTurnMillis/this.gameTurnMillis*this.hashCheckTurnInterval,this.debugGameStateHistory.length>B&&this.debugGameStateHistory.shift(),this.debugGameStateHistory.push(this.game.debugGetState()))}else this.game.update()}}handleCommsLag(S,O){S?(this.commsLagStartTime||(this.commsLagStartTime=O),O-this.commsLagStartTime>D.LAG_STATE_THRESH_MILLIS&&this.updateLagState(!0)):(this.commsLagStartTime=void 0,this.updateLagState(!1))}updateLagState(S){S!==this.lagState&&(this.lagState=S,this._onLagStateChange.dispatch(void 0,S))}sendActions(){let S=this.inputActions.dequeueAll();S.length||S.push(new N.NoAction);var O=this.gameoptSerializer.serializePlayerActions(S.map(S=>this.actionSerializer.getActionPayload(S)));this.debug("Send actions: "+O),this.gservCon.sendPlayerActions(this.currentNetworkTurn,O),this._onActionsSent.dispatch(void 0,this.currentNetworkTurn)}processActions(S){[...S].forEach(([S,O])=>O.forEach(O=>{let B=this.actionFactory.create(O.id);B.player=this.game.getPlayer(S),B.unserialize(O.params),B.process();var N=B.print();N&&this.actionLogger?.debug(`(${B.player.name})@${this.game.currentTick}: `+N)}))}debug(S){this.debugLogger?.(`${this.currentNetworkTurn}-${this.currentSubTurn}-${this.game.currentTick}: `+S)}dispose(){this.setErrorState(),this.gservCon.onGameActions.unsubscribe(this.receiveActions),this.gservCon.onGameDesync.unsubscribe(this.handleGameDesync)}}),U.PREFERRED_HASH_CHECK_MILLIS=1e3}}}),System.register("network/gamestate/PlayerActionPayload",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/gamestate/PlayerConnectionInfo",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/gamestate/PlayerConnectionStatus",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("PlayerConnectionStatus",B={}))[O.NotConnected=0]="NotConnected",O[O.Connected=1]="Connected"}}}),System.register("network/gamestate/Replay",["network/gameopt/Serializer","network/gameopt/Parser","util/Base64","network/gamestate/replay/ReplayEventFactory","util/stream","util/string"],function(S,O){"use strict";var B,N,j,L,D,F,_,U;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){_=[5,6],S("Replay",U=class e{constructor(){this.name="",this.events=[]}static sanitizeFileName(S,O="_"){return S.replace(/[/?<>\\:*|"]/g,O).replace(/[\x00-\x1f\x7f\x80-\x9f]/g,O).slice(0,this.maxNameLength)}init(S,O,B,N,j){this.gameId=S,this.gameTimestamp=O,this.gameOpts=B,this.engineVersion=N,this.modHash=j,this.name=e.sanitizeFileName(this.gameOpts.mapTitle+" "+(new Date).toISOString().replace(/(\.|,)\d+Z$/,"Z")),this.timestamp=Date.now()}writeEvent(...S){this.events.push(...S)}finish(S){this.endTick=S}getEvents(){return this.events}*flush(){if(!this.gameOpts)throw new Error("Game options must be set first");if(!this.engineVersion)throw new Error("Engine version is not set");if(void 0===this.modHash)throw new Error("Mod hash is not set");let S=new B.Serializer,O=this.getHeaderTag()+"\n";for(O+=`ENGINE ${this.engineVersion} ${this.modHash}\n`,O+=[this.gameId,this.gameTimestamp,S.serializeOptions(this.gameOpts)].join(" ")+"\n",yield O,O="";void 0===this.endTick||this.events.length;){for(var N of this.events)O+=N.tickNo+"="+N.type+"|"+N.serialize()+"\n";this.events.length=0,yield O,O=""}O+=this.getEndTag()+" "+this.endTick+"\n",this.debugInfo&&(O+=j.Base64.encode(F.utf16ToBinaryString(this.debugInfo))+"\n"),yield O}serialize(){if(void 0===this.endTick)throw new Error("Replay is not finished");let S="";var O,B=this.events.slice();for(O of this.flush())S+=O;return this.events=B,S}async parseHeader(S){let O,B,N,L,F,_,U=0;var H;for await(H of"string"==typeof S?S.split("\n"):D.makeTextFileLineIterator(S)){if(0===U)O=this.readReplayVersion(H);else if(1===U){if(!H.match(e.engineLineRegex))throw new Error("Missing or invalid game engine version line");var V;B=(V=H.split(" "))[1],N=Number(O<4?"0":V[2])}else{if(2!==U)break;if(!H.match(/^([a-zA-Z0-9-]+) \d+ .*$/))throw new Error("Missing or invalid game id/time/opts line");var[W,z,V]=H.split(" ");L=W,F=Number(z),_=O<6?j.Base64.decode(V):V}U++}if(U<3)throw new Error("Bad replay header");return{replayVersion:O,engineVersion:B,modHash:N,gameId:L,gameTimestamp:F,gameOptsSerialized:_}}unserialize(S,O){let D=S.split("\n");var U=this.readReplayVersion(D.shift()||"");if(!_.includes(U))throw new Error("Unsupported replay version "+U);let H=new N.Parser,V=D.shift();if(!V||!V.match(e.engineLineRegex))throw new Error("Missing or invalid game engine version line");var[,W,z]=V.split(" ");let K=D.shift();if(!K)throw new Error("Missing game id/time/opts line");var $=K.match(/^([a-zA-Z0-9-]+) (\d+) (.*)$/);if(!$)throw new Error("Invalid game id/time/opts line");let[,q,Q,Z]=$;U<6&&(Z=j.Base64.decode(Z)),U=H.parseOptions(Z),this.init(q,Number(Q),U,W,Number(z)),this.name=O.name,this.timestamp=O.timestamp;let Y,X=!1;for(;Y=D.shift();){if(Y.startsWith(this.getEndTag())){X=!0;break}var J;if(!(J=Y.match(/^(\d+)=(\d+)\|(.+)$/)))throw new Error(`Invalid event line "${Y}"`);var[,ee,te,J]=J,ee=Number(ee),te=Number(te);let S=new L.ReplayEventFactory(H,new B.Serializer).create(te,ee);S.unserialize(J),this.writeEvent(S)}if(!X)throw new Error("Incomplete replay data");if(!(z=Y.match(new RegExp(`^${this.getEndTag()} (\\d+)$`))))throw new Error("Invalid end tag");this.endTick=Number(z[1]),1<=D.length&&(this.debugInfo=F.binaryStringToUtf16(j.Base64.decode(D[0])))}getHeaderTag(){return"RA2TSREPL_v6"}readReplayVersion(S){var O=S.match(/^RA2TSREPL_v(\d+)$/);if(!O||O.length<2)throw new Error("Unknown replay format");return Number(O[1])}getEndTag(){return"END"}}),U.extension=".rpl",U.maxNameLength=128,U.engineLineRegex=/^ENGINE \d+\.\d+( \d+)?$/}}}),System.register("network/gamestate/ReplayRecorder",["game/action/ActionType","network/gamestate/replay/TurnActionsReplayEvent","network/gameopt/Parser","network/gameopt/Serializer","network/gamestate/replay/ChatMessageReplayEvent","network/gamestate/replay/TauntReplayEvent"],function(S,O){"use strict";var B,N,j,L,D,F;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S}],execute:function(){S("ReplayRecorder",class{constructor(S,O,B,N){this.replay=S,this.playerId=O,this.humanPlayers=B,this.actionSerializer=N}recordActions(S,O){if(!window.r?.replayDisabled)if(Array.isArray(O)){let B=new N.TurnActionsReplayEvent(new j.Parser,new L.Serializer,S);B.payload=[[this.playerId,O.map(S=>this.actionSerializer.getActionPayload(S))]],this.replay.writeEvent(B)}else if(this.hasActualActions(O)){let B=new N.TurnActionsReplayEvent(new j.Parser,new L.Serializer,S);B.payload=[...O].map(([S,O])=>[S,O]),this.replay.writeEvent(B)}}recordChatMessage(S,O,B){let N=new D.ChatMessageReplayEvent(S);N.payload={playerId:this.humanPlayers.findIndex(S=>S.name===O),message:B},this.replay.writeEvent(N)}recordTaunt(S,O,B){let N=new F.TauntReplayEvent(S);N.payload={playerId:this.humanPlayers.findIndex(S=>S.name===O),tauntNo:B},this.replay.writeEvent(N)}hasActualActions(S){return!![...S.values()].find(S=>S.find(S=>S.id!==B.ActionType.NoAction))}})}}}),System.register("network/gamestate/ReplayTurnManager",["game/Game","game/GameSpeed","network/gamestate/replay/TurnActionsReplayEvent","util/event"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("ReplayTurnManager",class{get onReplayEvent(){return this._onReplayEvent.asEvent()}constructor(S,O,B,N){this.game=S,this.replay=O,this.actionFactory=B,this.actionLogger=N,this.errorState=!1,this.gameSpeedChanged=!1,this._onReplayEvent=new L.EventDispatcher,this.onGameSpeedChanged=()=>{this.gameSpeedChanged=!0}}init(){this.game.desiredSpeed.onChange.subscribe(this.onGameSpeedChanged),this.computeGameTurn(this.game.speed.value),this.replayIterator=this.replay.getEvents().values(),this.nextReplayEvent=this.replayIterator.next().value}computeGameTurn(S){this.gameTurnMillis=1e3/(S*N.GameSpeed.BASE_TICKS_PER_SECOND)}setErrorState(){this.errorState=!0}getErrorState(){return this.errorState}getTurnMillis(){return this.gameTurnMillis}doGameTurn(S){if(!this.errorState)if(this.game.status!==B.GameStatus.Ended){for(;this.nextReplayEvent&&this.nextReplayEvent.tickNo===this.game.currentTick;)this.nextReplayEvent instanceof j.TurnActionsReplayEvent&&this.processActions(this.nextReplayEvent.payload),this._onReplayEvent.dispatch(this,this.nextReplayEvent),this.nextReplayEvent=this.replayIterator.next().value;if(this.nextReplayEvent&&this.nextReplayEvent.tickNo<this.game.currentTick)throw new Error("Replay event desync");this.replay.endTick+1<=this.game.currentTick?this.game.status=B.GameStatus.Ended:(this.game.update(),this.gameSpeedChanged&&(this.game.speed.value=this.game.desiredSpeed.value,this.computeGameTurn(this.game.speed.value),this.gameSpeedChanged=!1))}else this.game.speed.value=0}processActions(S){S.forEach(([S,O])=>O.forEach(O=>{let B=this.actionFactory.create(O.id);B.player=this.game.getPlayer(S),B.unserialize(O.params),B.process();var N=B.print();N&&this.actionLogger?.debug(`(${B.player.name})@${this.game.currentTick}: `+N)}))}dispose(){this.game.desiredSpeed.onChange.unsubscribe(this.onGameSpeedChanged)}})}}}),System.register("network/gamestate/SoloPlayTurnManager",["game/action/NoAction","game/Game","game/GameSpeed"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S}],execute:function(){S("SoloPlayTurnManager",class{constructor(S,O,B,N,j){this.game=S,this.currentPlayer=O,this.inputActions=B,this.actionLogger=N,this.replayRecorder=j,this.errorState=!1,this.gameSpeedChanged=!1,this.onGameSpeedChanged=()=>{this.gameSpeedChanged=!0}}init(){this.game.desiredSpeed.onChange.subscribe(this.onGameSpeedChanged),this.computeGameTurn(this.game.speed.value)}computeGameTurn(S){this.gameTurnMillis=1e3/(S*j.GameSpeed.BASE_TICKS_PER_SECOND)}setErrorState(){this.errorState=!0}getErrorState(){return this.errorState}getTurnMillis(){return this.gameTurnMillis}doGameTurn(S){if(!this.errorState){if(this.game.status!==N.GameStatus.Ended){let S=this.inputActions.dequeueAll();S.length?this.replayRecorder.recordActions(this.game.currentTick,S):S.push(new B.NoAction),this.processActions(S)}this.game.update(),this.gameSpeedChanged&&(this.game.speed.value=this.game.desiredSpeed.value,this.computeGameTurn(this.game.speed.value),this.gameSpeedChanged=!1)}}processActions(S){S.forEach(S=>{S.player=this.currentPlayer,S.process();var O=S.print();O&&this.actionLogger?.debug(`(${S.player.name})@${this.game.currentTick}: `+O)})}dispose(){this.game.desiredSpeed.onChange.unsubscribe(this.onGameSpeedChanged)}})}}}),System.register("network/gamestate/lockstepUtil",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("computeNetworkTurnMillis",(S,O)=>Math.max(1,Math.ceil(S/O))*O)}}}),System.register("network/gamestate/replay/ChatMessageReplayEvent",["util/Base64","util/string","network/gamestate/replay/ReplayEvent","network/gamestate/replay/ReplayEventType"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends j.ReplayEvent{constructor(S){super(L.ReplayEventType.ChatMessage,S)}serialize(){return this.payload.playerId+":"+B.Base64.encode(N.utf16ToBinaryString(this.payload.message))}unserialize(S){var[O,j]=S.split(":"),O=Number(O),j=N.binaryStringToUtf16(B.Base64.decode(j));this.payload={playerId:O,message:j}}},S("ChatMessageReplayEvent",D)}}}),System.register("network/gamestate/replay/ReplayEvent",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("ReplayEvent",class{constructor(S,O){this.type=S,this.tickNo=O}})}}}),System.register("network/gamestate/replay/ReplayEventFactory",["network/gamestate/replay/ChatMessageReplayEvent","network/gamestate/replay/ReplayEventType","network/gamestate/replay/TauntReplayEvent","network/gamestate/replay/TurnActionsReplayEvent"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("ReplayEventFactory",class{constructor(S,O){this.gameOptsParser=S,this.gameOptsSerializer=O}create(S,O){switch(S){case N.ReplayEventType.TurnActions:return new L.TurnActionsReplayEvent(this.gameOptsParser,this.gameOptsSerializer,O);case N.ReplayEventType.ChatMessage:return new B.ChatMessageReplayEvent(O);case N.ReplayEventType.Taunt:return new j.TauntReplayEvent(O);default:throw new Error(`Unsupported replay event type "${S}" at game tick "${O}"`)}}})}}}),System.register("network/gamestate/replay/ReplayEventType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("ReplayEventType",B={}))[O.TurnActions=0]="TurnActions",O[O.ChatMessage=1]="ChatMessage",O[O.Taunt=2]="Taunt"}}}),System.register("network/gamestate/replay/TauntReplayEvent",["network/gamestate/replay/ReplayEvent","network/gamestate/replay/ReplayEventType"],function(S,O){"use strict";var B,N,j;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){j=class extends B.ReplayEvent{constructor(S){super(N.ReplayEventType.Taunt,S)}serialize(){return this.payload.playerId+":"+this.payload.tauntNo}unserialize(S){var[O,B]=S.split(":"),O=Number(O),B=Number(B);this.payload={playerId:O,tauntNo:B}}},S("TauntReplayEvent",j)}}}),System.register("network/gamestate/replay/TurnActionsReplayEvent",["data/DataStream","util/string","network/gamestate/replay/ReplayEvent","network/gamestate/replay/ReplayEventType"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){D=class extends j.ReplayEvent{constructor(S,O,B){super(L.ReplayEventType.TurnActions,B),this.gameOptsParser=S,this.gameOptsSerializer=O}serialize(){let S=new B.DataStream;return this.gameOptsSerializer.serializeAllPlayerActions(S,new Map(this.payload)),N.uint8ArrayToBase64String(S.toUint8Array())}unserialize(S){var O=new B.DataStream(N.base64StringToUint8Array(S));O=this.gameOptsParser.parseAllPlayerActions(O),this.payload=[...O]}},S("TurnActionsReplayEvent",D)}}}),System.register("network/gservCodes",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("RPL_CVERS_OK",10),S("RPL_CVERS_OUTDATED",11),S("RPL_CVERS_MISSING",12),S("RPL_LOGGED_IN",100),S("RPL_ALREADY_LOGGED_IN",101),S("RPL_NOT_LOGGED_IN",102),S("RPL_BAD_LOGIN",103),S("RPL_TOO_MANY_LOGIN_ATTEMPTS",104),S("RPL_INSTANCE_CREATED",200),S("RPL_INSTANCE_EXISTS",201),S("RPL_INSTANCE_TOO_MANY",202),S("RPL_NOT_ENOUGH_PARAMS",300),S("RPL_INVALID_PARAMS",301),S("RPL_RATE_LIMIT_EXCEEDED",302),S("RPL_INSTANCE_CONNECTED",400),S("RPL_INSTANCE_NONEXISTENT",401),S("RPL_INSTANCE_NOT_ALLOWED",402),S("RPL_INSTANCE_ALREADY_STARTED",403),S("RPL_NO_INSTANCE",404),S("RPL_INSTANCE_NOT_RUNNING",405),S("RPL_INSTANCE_VERS_MISMATCH",406),S("RPL_GAME_OPTS",500),S("RPL_LOAD_INFO",600),S("RPL_MAP_TOO_BIG",602),S("RPL_MAP_ALREADY_SENT",603),S("RPL_GAME_START",700),S("RPL_GAME_DESYNC",801),S("RPL_NET_RATE",802),S("RPL_TAUNT",803),S("RPL_PLAYER_DISCONNECT",804),S("RPL_PRIVMSG_NOT_ALLOWED",805),S("RPL_BIN_PREFIX",2),S("RPL_BIN_GAME_ACTIONS",1),S("RPL_BIN_MAP_DATA",2),S("REQ_BIN_PREFIX",2),S("REQ_BIN_GAME_ACTIONS",1),S("REQ_BIN_GAME_STATE_HASH",2),S("REQ_BIN_PUT_MAP",3),S("REQ_BIN_GET_MAP",4)}}}),System.register("network/gservConfig",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("API_VERSION",2),S("RECIPIENT_ALL","#all"),S("RECIPIENT_TEAM","#team"),S("TURN_TIMEOUT_MILLIS",1e4),S("LAG_STATE_THRESH_MILLIS",1e3),S("CON_INFO_THRESH_MILLIS",2e3),S("LAG_CHECK_INTERVAL_MILLIS",1e3),S("MAX_MAP_TRANSFER_BYTES",2097152)}}}),System.register("network/ladder/LadderHead",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/ladder/PagedResponse",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/ladder/PlayerLadderRung",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/ladder/PlayerMatchHistoryEntry",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/ladder/PlayerProfile",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("network/ladder/PlayerRankType",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){var O;(O=B||S("PlayerRankType",B={}))[O.None=0]="None",O[O.Private=1]="Private",O[O.Corporal=2]="Corporal",O[O.Sergeant=3]="Sergeant",O[O.Lieutenant=4]="Lieutenant",O[O.Major=5]="Major",O[O.Colonel=6]="Colonel",O[O.BrigGeneral=7]="BrigGeneral",O[O.General=8]="General",O[O.FiveStarGeneral=9]="FiveStarGeneral",O[O.CommanderInChief=10]="CommanderInChief"}}}),System.register("network/ladder/WLadderService",["network/ladder/wladderConfig","network/HttpRequest"],function(S,O){"use strict";var B,N,j,L;return O&&O.id,{setters:[function(S){N=B=S},function(S){j=S}],execute:function(){S("WLadderService",L=class e{constructor(S){this.wolConfig=S}setUrl(S){this.url=S}getUrl(){return this.url}async getSeasons(S){if(!this.url)throw new Error("No ladder URL is set");var O=this.wolConfig.getClientSku();return await(new j.HttpRequest).fetchJson(this.url+"/"+O,S)}async getSeason(S,O,B){if(!this.url)throw new Error("No ladder URL is set");var N=this.wolConfig.getClientSku();return await(new j.HttpRequest).fetchJson(this.url+`/${N}/${S}?locale=`+O,B)}async listSearch(S,O,B=N.LadderType.Solo1v1,L=e.CURRENT_SEASON,D){if(!this.url)throw new Error("No ladder URL is set");var F=this.wolConfig.getClientSku();return await(new j.HttpRequest).fetchJson(this.url+`/${F}/${B}/${L}/listsearch`,O,{method:"POST",body:JSON.stringify({players:S,locale:D})})}async rungSearch(S,O,B,N,L,D){if(!this.url)throw new Error("No ladder URL is set");var F=this.wolConfig.getClientSku();return await(new j.HttpRequest).fetchJson(this.url+`/${F}/${B}/${N}/rungsearch`,D,{method:"POST",body:JSON.stringify({ladderId:L,start:S,count:O})})}}),L.CURRENT_SEASON=B.CURRENT_SEASON,L.PREV_SEASON=B.PREV_SEASON}}}),System.register("network/ladder/wladderConfig",[],function(S,O){"use strict";var B,N;return O&&O.id,S("getLadderTypeForQueueType",function(S,O){switch(S){case N.Solo1v1:return B.Solo1v1;case N.Team2v2:return B.Random2v2;default:throw new Error(`Unhandled queue type "${S}"`)}}),S("getQueueTypeForLadderType",function(S){switch(S){case B.Solo1v1:return N.Solo1v1;case B.Random2v2:return N.Team2v2;default:throw new Error(`Unhandled ladder type "${S}"`)}}),{setters:[],execute:function(){var O;S("CURRENT_SEASON","current"),S("PREV_SEASON","prev"),S("MAX_LIST_SEARCH_COUNT",50),(O=B||S("LadderType",B={})).Solo1v1="1v1",O.Random2v2="2v2-random",(O=N||S("LadderQueueType",N={})).Solo1v1="1v1",O.Team2v2="2v2",S("teamSizes",new Map([[N.Solo1v1,1],[N.Team2v2,2]]))}}}),System.register("network/qmCodes",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("REQ_MATCH","Match"),S("REQ_STATS","Stats"),S("REQ_LIST_QUEUES","ListQueues"),S("RPL_WORKING","Working"),S("RPL_STATS","Stats"),S("RPL_QUEUE_LIST","QueueList"),S("RPL_BAD_VERS","Badvers"),S("RPL_BAD_HASH","Badhash"),S("RPL_MODE_UNAVAIL","Unavailable"),S("RPL_ALREADY_QUEUED","AlreadyQueued"),S("RPL_MATCHED","Matched"),S("RPL_REQUEUE","Requeue"),S("RPL_REMOVED_FROM_QUEUE","Removed"),S("TAG_COUNTRY","COU"),S("TAG_COLOR","COL"),S("TAG_RANKED","RKD"),S("TAG_VERSION","VRS"),S("TAG_MODHASH","MOD")}}}),System.register("network/wolCodes",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("RPL_GET_LOCALE",309),S("RPL_SET_LOCALE",310),S("RPL_LISTSTART",321),S("RPL_LIST",322),S("RPL_CHANNELMODEIS",324),S("RPL_GAME_CHANNEL",326),S("RPL_CHANNEL",327),S("RPL_LISTEND",323),S("RPL_TOPIC",332),S("RPL_NAMREPLY",353),S("RPL_ENDOFNAMES",366),S("RPL_MOTD",372),S("RPL_MOTDSTART",375),S("RPL_ENDOFMOTD",376),S("RPL_BAD_LOGIN",378),S("ERR_UNKNOWNERROR",400),S("ERR_NOSUCHNICK",401),S("ERR_NOSUCHCHANNEL",403),S("ERR_UNKNOWNCOMMAND",421),S("ERR_USERNOTINCHANNEL",441),S("ERR_NOTONCHANNEL",442),S("ERR_NEEDMOREPARAMS",461),S("ERR_ALREADYREGISTERED",462),S("ERR_YOUREBANNEDCREEP",465),S("ERR_BADCHANNELKEY",475),S("ERR_GAMEHASCLOSED",478),S("ERR_CHANNELISFULL",471),S("ERR_UNKNOWNMODE",472),S("ERR_BANNEDFROMCHAN",474),S("ERR_CHANOPRIVSNEEDED",482),S("ERR_RESTRICTED",484),S("ERR_UMODEUNKNOWNFLAG",501),S("RPL_QUIT",607),S("RPL_CVERS_OK",700),S("RPL_CVERS_OUTDATED",701),S("ERR_CVERS_UNKNOWN",702),S("ERR_BAD_PARAMS",710),S("ERR_RATE_LIMIT_EXCEEDED",711),S("RPL_LOGIN_QUEUE",720),S("ERR_SERVER_FULL",721),S("RPL_GAME_REPORT",730)}}}),System.register("tools/AircraftTester",["engine/gfx/Renderer","engine/Engine","game/Coords","engine/IsoCoords","game/Player","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","engine/TheaterType","game/Alliances","game/PlayerList","game/gameobject/selection/SelectionLevel","game/gameobject/unit/VeteranLevel","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","engine/Lighting","game/gameobject/ObjectFactory","game/map/TileCollection","engine/type/ObjectType","game/gameobject/trait/MoveTrait","game/map/TileOccupation","game/map/Bridges","engine/RenderableManager","game/World","data/Strings","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","game/gameobject/unit/ZoneType","util/math"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S},function(S){ge=S},function(S){pe=S},function(S){me=S},function(S){fe=S},function(S){ye=S},function(S){Te=S},function(S){ve=S},function(S){be=S},function(S){Se=S}],execute:function(){S("AircraftTester",we=class{static async main(S){let O=this.renderer=new B.Renderer(800,600);O.init(document.body),O.initStats(document.body);let j=F.WorldScene.factory({x:0,y:0,width:800,height:600},new H.BoxedVar(!0),new H.BoxedVar(Te.ShadowQuality.High));this.disposables.add(j),j.scene.background=new THREE.Color(12632256),L.IsoCoords.init({x:0,y:0}),this.theater=await N.Engine.loadTheater($.TheaterType.Temperate);var D=new _.Rules(N.Engine.getRules());this.rules=D,this.art=new z.Art(D,N.Engine.getArt()),this.images=N.Engine.getImages(),this.voxels=N.Engine.getVoxels(),this.voxelAnims=N.Engine.getVoxelAnims(),this.buildBrowser(D.aircraftRules);let U=new ve.CanvasMetrics(O.getCanvas(),window);U.init(),this.disposables.add(U),D=new X.PointerEvents(O,{x:0,y:0},document,U);let W=new te.CameraZoomControls(D,j.cameraZoom);W.init(),this.disposables.add(D,W),O.addScene(j),(this.uiAnimationLoop=new V.UiAnimationLoop(O)).start(),this.worldScene=j,this.vxlGeometryPool=new fe.VxlGeometryPool(new ye.VxlGeometryCache),this.addGrid(),this.createFloor()}static addGrid(){var S=new U.MapGrid({width:10,height:10}).get3DObject();let O=new THREE.Object3D;O.add(S),this.worldScene.scene.add(O)}static createFloor(){var S=new THREE.PlaneGeometry(1e4,1e4);let O=new THREE.ShadowMaterial;O.opacity=.5;let B=new THREE.Mesh(S,O);B.rotation.x=-Math.PI/2,B.receiveShadow=!0,B.renderOrder=2e5,this.worldScene.scene.add(B)}static selectAircraft(S){this.currentAircraft&&(this.world.removeObject(this.currentAircraft),this.currentAircraft.dispose());let O=new D.Player("Player");this.disposables.add(O),O.color=this.rules.getMultiplayerColors().get("DarkRed");var B=new q.Alliances(new Q.PlayerList),j=new ee.UnitSelection,L=new ie.Lighting;this.disposables.add(L);var F=new K.RenderableFactory(new H.BoxedVar(O),j,B,this.rules,this.art,void 0,new W.ImageFinder(this.images,this.theater),N.Engine.getPalettes(),this.voxels,this.voxelAnims,this.theater,this.worldScene.camera,L,new pe.LightingDirector(L,this.renderer,new H.BoxedVar(1)),new H.BoxedVar(!1),new H.BoxedVar(!1),new H.BoxedVar(2),void 0,new ue.Strings,new H.BoxedVar(ge.FlyerHelperMode.Selected),new H.BoxedVar(!1),new me.VxlBuilderFactory(this.vxlGeometryPool,!1,this.worldScene.camera),new Map);j=new se.TileCollection([],null,this.rules.general,Se.getRandomInt),B=new oe.TileOccupation(j),L=new de.MapBounds,L=new le.Bridges(this.theater.tileSets,j,B,L,this.rules);let _=this.currentAircraft=new re.ObjectFactory(j,B,L,new H.BoxedVar(0)).create(ne.ObjectType.Aircraft,S,this.rules,this.art);_.owner=O,_.position.tile={rx:1,ry:1,z:0,rampType:0};let U=this.world=new he.World,V=new ce.RenderableManager(U,this.worldScene,this.worldScene.camera,F);V.init(),this.disposables.add(V),U.spawnObject(_);let z=this.currentRenderable=V.getRenderableByGameObject(_);z.selectionModel.setSelectionLevel(Z.SelectionLevel.None),z.selectionModel.setControlGroupNumber(3),this.buildControls()}static buildControls(){this.controlsEl&&document.body.removeChild(this.controlsEl);let S=this.controlsEl=document.createElement("div");S.style.position="absolute",S.style.left="0",S.style.top="0",S.style.width="200px",S.style.padding="5px",S.style.background="rgba(255, 255, 255, 0.5)",S.style.border="1px black solid",S.appendChild(document.createTextNode("Remap color:"));let O=this.rules.getMultiplayerColors(),B=document.createElement("select");B.style.display="block",B.addEventListener("change",()=>{this.currentAircraft.owner.color=O.get(B.value)}),S.appendChild(B),O.forEach((S,O)=>{let N=document.createElement("option");N.innerHTML=O,N.value=O,N.selected=S.asHex()===this.currentAircraft.owner.color.asHex(),B.appendChild(N)}),S.appendChild(document.createTextNode("Selection level:"));let N=document.createElement("div");S.appendChild(N),[Z.SelectionLevel.None,Z.SelectionLevel.Hover,Z.SelectionLevel.Selected].forEach(S=>{let O=document.createElement("button");O.innerHTML=Z.SelectionLevel[S],O.disabled=!this.currentAircraft.rules.selectable,O.addEventListener("click",()=>this.currentRenderable.selectionModel.setSelectionLevel(S)),N.appendChild(O)}),S.appendChild(document.createTextNode("Veteran level:"));let L=document.createElement("div");S.appendChild(L),this.currentAircraft.veteranTrait&&[Y.VeteranLevel.None,Y.VeteranLevel.Veteran,Y.VeteranLevel.Elite].forEach(S=>{let O=document.createElement("button");O.innerHTML=Y.VeteranLevel[S],O.addEventListener("click",()=>this.currentAircraft.veteranTrait.veteranLevel=S),L.appendChild(O)}),S.appendChild(document.createTextNode("Rudder:"));let D=document.createElement("input");D.style.display="block",D.type="range",D.min="-180",D.max="180",D.value="0",D.addEventListener("input",()=>{this.currentAircraft.yaw=Number(D.value)}),S.appendChild(D);let F=document.createElement("input");F.style.display="block",F.type="range",F.min="-180",F.max="180",F.value="0",F.addEventListener("input",()=>{this.currentAircraft.pitch=Number(F.value)}),S.appendChild(F);let _=document.createElement("input");_.style.display="block",_.type="range",_.min="-180",_.max="180",_.value="0",_.addEventListener("input",()=>{this.currentAircraft.roll=Number(_.value)}),S.appendChild(_),S.appendChild(document.createTextNode("Height:"));let U=document.createElement("input");U.type="range",U.min="0",U.max="2560",U.value="0",U.style.display="block",U.addEventListener("input",()=>{this.currentAircraft.position.tileElevation=j.Coords.worldToTileHeight(Number(U.value))}),S.appendChild(U),S.appendChild(document.createTextNode("isMoving:"));let H=document.createElement("input");H.type="checkbox",H.style.display="block",H.addEventListener("change",S=>{var O=S.target.checked;this.currentAircraft.moveTrait.moveState=O?ae.MoveState.Moving:ae.MoveState.Idle,this.currentAircraft.zone=O?be.ZoneType.Air:be.ZoneType.Ground}),S.appendChild(H),S.appendChild(document.createTextNode("Warped out:"));let V=document.createElement("input");V.type="checkbox",V.style.display="block",V.addEventListener("change",S=>{this.currentAircraft.warpedOutTrait.debugSetActive(S.target.checked)}),S.appendChild(V);let W=document.createElement("button");W.style.display="block",W.style.color="red",W.innerHTML="DESTROY",W.addEventListener("click",async()=>{this.currentAircraft.isDestroyed=!0,this.world.removeObject(this.currentAircraft),this.currentAircraft.dispose(),this.currentAircraft=void 0,document.body.removeChild(this.controlsEl),this.controlsEl=void 0}),S.appendChild(W),document.body.appendChild(S)}static buildBrowser(S){let O=this.listEl=document.createElement("div");O.style.position="absolute",O.style.right="0",O.style.top="0",O.style.height="600px",O.style.width="200px",O.style.overflowY="auto",O.style.padding="5px",O.style.background="rgba(255, 255, 255, 0.5)",O.style.border="1px black solid",O.appendChild(document.createTextNode("Aircraft types:"));let B=[...S.keys()].filter(S=>this.art.hasObject(S,ne.ObjectType.Aircraft)).sort();B.forEach(S=>{let B=document.createElement("a");B.style.display="block",B.textContent=S,B.setAttribute("href","javascript:;"),B.addEventListener("click",()=>{console.log("Selected aircraft",S),this.selectAircraft(S)}),O.appendChild(B)}),document.body.appendChild(O),setTimeout(()=>{this.selectAircraft(B[0])},50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsEl&&(this.controlsEl.remove(),this.controlsEl=void 0),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),this.disposables.dispose()}}),we.disposables=new J.CompositeDisposable}}}),System.register("tools/BuildingTester",["engine/gfx/Renderer","engine/Engine","engine/IsoCoords","engine/TheaterType","game/Player","engine/renderable/entity/building/DamageType","engine/renderable/entity/building/AnimationType","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","util/Color","game/gameobject/selection/SelectionLevel","game/Alliances","game/PlayerList","game/gameobject/ObjectFactory","engine/type/ObjectType","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","game/gameobject/Infantry","engine/Lighting","game/map/TileCollection","game/map/TileOccupation","game/map/Bridges","data/Strings","game/gameobject/trait/AutoRepairTrait","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","game/World","engine/RenderableManager","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","util/math"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S},function(S){ge=S},function(S){pe=S},function(S){me=S},function(S){fe=S},function(S){ye=S},function(S){Te=S},function(S){ve=S},function(S){be=S},function(S){Se=S},function(S){we=S}],execute:function(){S("BuildingTester",Ee=class e{static async main(S){let O=this.renderer=new B.Renderer(800,600);O.init(document.body),O.initStats(document.body);let D=U.WorldScene.factory({x:0,y:0,width:800,height:600},new W.BoxedVar(!0),new W.BoxedVar(be.ShadowQuality.High));this.disposables.add(D),D.scene.background=new THREE.Color(12632256),j.IsoCoords.init({x:0,y:0}),this.theater=await N.Engine.loadTheater(L.TheaterType.Snow);var F=new H.Rules(N.Engine.getRules());this.buildBrowser(F.buildingRules),this.rules=F,this.art=new $.Art(F,N.Engine.getArt()),this.images=N.Engine.getImages(),this.voxels=N.Engine.getVoxels(),this.voxelAnims=N.Engine.getVoxelAnims();let _=new Se.CanvasMetrics(O.getCanvas(),window);_.init(),this.disposables.add(_),F=new te.PointerEvents(O,{x:0,y:0},document,_);let V=new se.CameraZoomControls(F,D.cameraZoom);this.disposables.add(V,F),V.init(),O.addScene(D),(this.uiAnimationLoop=new z.UiAnimationLoop(O)).start(),this.worldScene=D,this.vxlGeometryPool=new Te.VxlGeometryPool(new ve.VxlGeometryCache),this.addGrid()}static addGrid(){var S=new V.MapGrid({width:10,height:10}).get3DObject();let O=new THREE.Object3D;O.add(S),this.worldScene.scene.add(O)}static selectBuilding(S){this.currentRenderable&&!this.currentBuilding.isDisposed&&(this.world.removeObject(this.currentBuilding),this.currentBuilding.dispose());var O=this.rules.getBuilding(S);let B=new D.Player("Player");this.disposables.add(B),B.color=-1!==O.techLevel||O.constructionYard?this.rules.getMultiplayerColors().get("DarkRed"):new Q.Color(255,255,255);let j=new X.PlayerList;j.addPlayer(B);var L=new Y.Alliances(j),F=new re.UnitSelection,_=new ae.Lighting;this.disposables.add(_),O=new q.RenderableFactory(new W.BoxedVar(B),F,L,this.rules,this.art,void 0,new K.ImageFinder(this.images,this.theater),N.Engine.getPalettes(),this.voxels,this.voxelAnims,this.theater,this.worldScene.camera,_,new pe.LightingDirector(_,this.renderer,new W.BoxedVar(1)),new W.BoxedVar(!1),new W.BoxedVar(!1),new W.BoxedVar(2),void 0,new he.Strings({TXT_PRIMARY:"Primary"}),new W.BoxedVar(ge.FlyerHelperMode.Selected),new W.BoxedVar(!1),new ye.VxlBuilderFactory(this.vxlGeometryPool,!1,this.worldScene.camera),new Map),F=new oe.TileCollection([],null,this.rules.general,we.getRandomInt),L=new le.TileOccupation(F),_=new de.MapBounds,_=new ce.Bridges(this.theater.tileSets,F,L,_,this.rules);let U=this.currentBuilding=new J.ObjectFactory(F,L,_,new W.BoxedVar(1)).create(ee.ObjectType.Building,S,this.rules,this.art);U.owner=B,U.position.tile={rx:1,ry:1,z:0,rampType:0},U.position.setCenterOffset(U.getFoundationCenterOffset());let H=this.world=new me.World,V=new fe.RenderableManager(H,this.worldScene,this.worldScene.camera,O);V.init(),this.disposables.add(V),H.spawnObject(U),(this.currentRenderable=V.getRenderableByGameObject(U)).selectionModel.setSelectionLevel(Z.SelectionLevel.Selected),this.currentRenderable.selectionModel.setControlGroupNumber(3),setTimeout(()=>{this.buildBuildingControls(),this.createAnimButtons(),this.createOccupiedButtons()},50)}static selectAnimation(S){this.currentRenderable&&this.currentRenderable.setAnimation(S,performance.now())}static stopCurrentAnimation(){this.currentRenderable&&this.currentRenderable.endCurrentAnimation()}static setDamageType(S){this.currentBuilding.healthTrait.health=S?100*(S===F.DamageType.CONDITION_YELLOW?e.rules.audioVisual.conditionYellow:e.rules.audioVisual.conditionRed):100}static setActiveState(S){this.currentRenderable&&this.currentRenderable.setPowered(S)}static createAnimButtons(){let S=this.animButtonsWrap;S.innerHTML="";for(let B of[_.AnimationType.IDLE,_.AnimationType.PRODUCTION,_.AnimationType.BUILDUP,_.AnimationType.UNBUILD,_.AnimationType.SUPER_CHARGE_START,_.AnimationType.SPECIAL_REPAIR_START,_.AnimationType.SPECIAL_SHOOT,_.AnimationType.SPECIAL_DOCKING,_.AnimationType.FACTORY_DEPLOYING,_.AnimationType.FACTORY_ROOF_DEPLOYING]){let N=document.createElement("button");if(N.innerHTML=_.AnimationType[B],N.style.display="block",N.addEventListener("click",()=>this.selectAnimation(B)),!this.currentRenderable)throw new Error("Must build anim buttons after a building is selected");var O=!this.currentRenderable.hasAnimation(B);N.disabled=O,N.style.opacity=O?".5":"1",S.appendChild(N)}}static createOccupiedButtons(){let S=this.occupiedButtonsWrap;S.innerHTML="";let O=document.createElement("select");O.disabled=!this.currentBuilding.garrisonTrait,O.style.display="block",O.addEventListener("change",()=>{this.currentBuilding.garrisonTrait.units=new Array(Number(O.value)).fill(0).map(()=>new ne.Infantry("dummy",this.rules.getObject("E1",ee.ObjectType.Infantry),null))});for(let S=0;S<this.currentBuilding.rules.maxNumberOccupants+1;S++){let B=document.createElement("option");B.innerHTML=String(S),B.value=String(S),B.selected=0===S,O.appendChild(B)}S.appendChild(O)}static buildBuildingControls(){this.controlsElement&&document.body.removeChild(this.controlsElement);let S=this.controlsElement=document.createElement("div");S.style.position="absolute",S.style.left="0",S.style.top="0",S.style.width="220px",S.style.padding="5px",S.style.background="rgba(255, 255, 255, 0.5)",S.style.border="1px black solid",S.appendChild(document.createTextNode("Remap color:"));let O=new Map(this.rules.getMultiplayerColors());O.set("None",new Q.Color(255,255,255));let B=document.createElement("select");B.style.display="block",B.addEventListener("change",()=>{this.currentBuilding.owner.color=O.get(B.value)}),S.appendChild(B),O.forEach((S,O)=>{let N=document.createElement("option");N.innerHTML=O,N.value=O,N.selected=S.asHex()===this.currentBuilding.owner.color.asHex(),B.appendChild(N)}),S.appendChild(document.createTextNode("Selection level:"));let N=document.createElement("div");S.appendChild(N),[Z.SelectionLevel.None,Z.SelectionLevel.Hover,Z.SelectionLevel.Selected].forEach(S=>{let O=document.createElement("button");O.innerHTML=Z.SelectionLevel[S],O.disabled=S===Z.SelectionLevel.Selected&&!this.currentBuilding.rules.selectable,O.addEventListener("click",()=>this.currentRenderable.selectionModel.setSelectionLevel(S)),N.appendChild(O)}),S.appendChild(document.createTextNode("Animation type:"));var j=this.animButtonsWrap=document.createElement("div");S.appendChild(j);let L=document.createElement("button");L.innerHTML="Stop current",L.style.display="block",L.addEventListener("click",()=>this.stopCurrentAnimation()),S.appendChild(L),S.appendChild(document.createTextNode("Occupants:")),j=this.occupiedButtonsWrap=document.createElement("div"),S.appendChild(j),S.appendChild(document.createTextNode("Damage type:"));let D=document.createElement("button");D.innerHTML="NORMAL",D.style.display="block",D.addEventListener("click",()=>this.setDamageType(F.DamageType.NORMAL)),S.appendChild(D);let _=document.createElement("button");_.innerHTML="YELLOW",_.style.display="block",_.addEventListener("click",()=>this.setDamageType(F.DamageType.CONDITION_YELLOW)),S.appendChild(_);let U=document.createElement("button");U.innerHTML="RED",U.style.display="block",U.addEventListener("click",()=>this.setDamageType(F.DamageType.CONDITION_RED)),S.appendChild(U);let H=document.createElement("button");H.innerHTML="DESTROYED",H.style.display="block",H.addEventListener("click",async()=>{this.currentBuilding.isDestroyed=!0,this.currentBuilding.healthTrait.health=0,this.world.removeObject(this.currentBuilding),this.currentBuilding.dispose(),document.body.removeChild(this.controlsElement),this.controlsElement=void 0}),S.appendChild(H);let V=document.createElement("button");V.innerHTML="Toggle repair",V.style.display="block",V.addEventListener("click",()=>{let S=this.currentBuilding.traits.get(ue.AutoRepairTrait);S.setDisabled(!S.isDisabled())}),S.appendChild(V),S.appendChild(document.createTextNode("Powered state:"));let W=document.createElement("button");W.innerHTML="INACTIVE",W.style.display="block",W.addEventListener("click",()=>this.setActiveState(!1)),S.appendChild(W);let z=document.createElement("button");z.innerHTML="ACTIVE",z.style.display="block",z.addEventListener("click",()=>this.setActiveState(!0)),S.appendChild(z),S.appendChild(document.createTextNode("Warped out:"));let K=document.createElement("input");K.type="checkbox",K.style.display="block",K.addEventListener("change",S=>{this.currentBuilding.warpedOutTrait.debugSetActive(S.target.checked)}),S.appendChild(K),document.body.appendChild(S)}static buildBrowser(S){let O=this.listEl=document.createElement("div");O.style.position="absolute",O.style.right="0",O.style.top="0",O.style.height="600px",O.style.width="200px",O.style.overflowY="auto",O.style.padding="5px",O.style.background="rgba(255, 255, 255, 0.5)",O.style.border="1px black solid",O.appendChild(document.createTextNode("Building types:"));let B=[];S.forEach((S,O)=>{-1!==["AMMOCRAT","GADUMY","GAGREEN","CAARMR"].indexOf(O)||/^CASIN/.exec(O)||/^CITY/.exec(O)||B.push(O)}),B.sort(),B.forEach(S=>{let B=document.createElement("a");B.style.display="block",B.textContent=S,B.setAttribute("href","javascript:;"),B.addEventListener("click",()=>{console.log("Selected building",S),this.selectBuilding(S)}),O.appendChild(B)}),document.body.appendChild(O),setTimeout(()=>{this.selectBuilding(B[0])},50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsElement&&(this.controlsElement.remove(),this.controlsElement=void 0),this.disposables.dispose()}}),Ee.disposables=new ie.CompositeDisposable}}}),System.register("tools/CameraZoomControls",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("CameraZoomControls",class{constructor(S,O){this.pointerEvents=S,this.cameraZoom=O,this.handleWheel=S=>{this.cameraZoom.applyStep(0<S.wheelDeltaY?-.1:.1)}}init(){this.pointerEvents.addEventListener("canvas","wheel",this.handleWheel)}destroy(){this.pointerEvents.removeEventListener("canvas","wheel",this.handleWheel)}})}}}),System.register("tools/ConsoleController",["tools/DevToolsApi"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){(async()=>{try{const S=B.DevToolsApi.getPublicNamespace();if(!S.ctx)return void console.warn("ConsoleController: r.ctx is not available yet. Start a single-player game first.");const{ActionsApi:O}=await SystemJS.import("game/api/ActionsApi"),{GameApi:N}=await SystemJS.import("game/api/GameApi"),{OrderType:j}=await SystemJS.import("game/order/OrderType"),{MoveOrder:L}=await SystemJS.import("game/order/MoveOrder"),{UnitSelectionLite:D}=await SystemJS.import("game/gameobject/selection/UnitSelectionLite"),{AttackOrder:F}=await SystemJS.import("game/order/AttackOrder"),{AttackMoveOrder:_}=await SystemJS.import("game/order/AttackMoveOrder"),{ObjectType:U}=await SystemJS.import("engine/type/ObjectType"),{ObserveGameAction:H}=await SystemJS.import("game/action/ObserveGameAction"),{EventType:V}=await SystemJS.import("game/event/EventType");function u(){const O=S.ctx;return"function"==typeof O?O():O}function d(S){const B=u(),N={name:S};return new O(B.game,B.actionFactory,B.actionQueue,N,void 0)}function autoDisableReplay(O){S.replayDisabled||S.disableReplay(O)}Object.defineProperty(S,"replayDisabled",{configurable:!0,writable:!0,value:!1}),Object.defineProperty(S,"_replayDisableReason",{configurable:!0,writable:!0,value:void 0}),Object.defineProperty(S,"disableReplay",{configurable:!0,value:function(O="Console API used"){return S.replayDisabled||(S.replayDisabled=!0,S._replayDisableReason=O,console.warn(`[ConsoleController]  Replay recording DISABLED: ${O}`),console.warn("[ConsoleController] Replay will NOT be saved for this game session.")),"Replay disabled"}}),Object.defineProperty(S,"enableReplay",{configurable:!0,value:function(){return S.replayDisabled=!1,S._replayDisableReason=void 0,console.info("[ConsoleController]  Replay recording RE-ENABLED"),"Replay enabled (warning: existing events preserved)"}}),Object.defineProperty(S,"getReplayStatus",{configurable:!0,value:function(){return{disabled:S.replayDisabled,reason:S._replayDisableReason}}});const W=new Map;new Map;let z=null;const K={ObjectSpawn:V.ObjectSpawn,ObjectUnspawn:V.ObjectUnspawn,ObjectDestroy:V.ObjectDestroy,ObjectMorph:V.ObjectMorph,ObjectTeleport:V.ObjectTeleport,WeaponFire:V.WeaponFire,WarheadDetonate:V.WarheadDetonate,InflictDamage:V.InflictDamage,HealthChange:V.HealthChange,ObjectAttacked:V.ObjectAttacked,UnitDeployUndeploy:V.UnitDeployUndeploy,UnitPromote:V.UnitPromote,Cheer:V.Cheer,EnterTransport:V.EnterTransport,LeaveTransport:V.LeaveTransport,EnterObject:V.EnterObject,EnterTile:V.EnterTile,UnitRepairStart:V.UnitRepairStart,UnitRepairFinish:V.UnitRepairFinish,UnitRecycle:V.UnitRecycle,BuildStatusChange:V.BuildStatusChange,BuildingPlace:V.BuildingPlace,BuildingFailedPlace:V.BuildingFailedPlace,BuildingCapture:V.BuildingCapture,BuildingInfiltration:V.BuildingInfiltration,BuildingGarrison:V.BuildingGarrison,BuildingEvacuate:V.BuildingEvacuate,BuildingRepairStart:V.BuildingRepairStart,BuildingRepairFull:V.BuildingRepairFull,ObjectSell:V.ObjectSell,BridgeRepair:V.BridgeRepair,ObjectLiftOff:V.ObjectLiftOff,ObjectLand:V.ObjectLand,ObjectCrashing:V.ObjectCrashing,ObjectDisguiseChange:V.ObjectDisguiseChange,ObjectCloakChange:V.ObjectCloakChange,ShipSubmergeChange:V.ShipSubmergeChange,PlayerDefeated:V.PlayerDefeated,PlayerResigned:V.PlayerResigned,PlayerDropped:V.PlayerDropped,ObjectOwnerChange:V.ObjectOwnerChange,AllianceChange:V.AllianceChange,InsufficientFunds:V.InsufficientFunds,PowerChange:V.PowerChange,PowerLow:V.PowerLow,PowerRestore:V.PowerRestore,FactoryProduceUnit:V.FactoryProduceUnit,PrimaryFactoryChange:V.PrimaryFactoryChange,RallyPointChange:V.RallyPointChange,SuperWeaponReady:V.SuperWeaponReady,SuperWeaponActivate:V.SuperWeaponActivate,LightningStormManifest:V.LightningStormManifest,LightningStormCloud:V.LightningStormCloud,RadarOnOff:V.RadarOnOff,RadarEvent:V.RadarEvent,PingLocation:V.PingLocation,DeployNotAllowed:V.DeployNotAllowed,CratePickup:V.CratePickup,StalemateDetect:V.StalemateDetect,TimerExpire:V.TimerExpire,TriggerSoundFx:V.TriggerSoundFx,TriggerStopSoundFx:V.TriggerStopSoundFx,TriggerEva:V.TriggerEva,TriggerAnim:V.TriggerAnim,TriggerText:V.TriggerText};function convertEvent(S){const O=u().game,B={type:S.type,typeName:Object.keys(K).find(O=>K[O]===S.type)||`Unknown(${S.type})`,tick:O.currentTick,time:O.currentTime};switch(S.type){case V.ObjectSpawn:return{...B,objectId:S.gameObject?.id,objectName:S.gameObject?.name,objectType:S.gameObject?.type,owner:S.gameObject?.owner?.name};case V.ObjectUnspawn:return{...B,objectId:S.gameObject?.id,objectName:S.gameObject?.name};case V.ObjectDestroy:return{...B,targetId:S.target?.id,targetName:S.target?.name,targetOwner:S.target?.owner?.name,attackerPlayer:S.attackerInfo?.player?.name,attackerObjectId:S.attackerInfo?.obj?.id,weapon:S.attackerInfo?.weapon?.rules?.name,incidental:S.incidental};case V.ObjectOwnerChange:return{...B,targetId:S.target?.id,targetName:S.target?.name,prevOwner:S.prevOwner?.name,newOwner:S.target?.owner?.name};case V.WeaponFire:return{...B,shooterId:S.shooter?.id,shooterName:S.shooter?.name,weapon:S.weapon?.rules?.name,targetId:S.target?.obj?.id};case V.InflictDamage:return{...B,targetId:S.target?.id,targetName:S.target?.name,damage:S.damage,attackerPlayer:S.attackerInfo?.player?.name};case V.HealthChange:return{...B,targetId:S.target?.id,targetName:S.target?.name,prevHealth:S.prevHealth,newHealth:S.target?.healthTrait?.health};case V.PlayerDefeated:case V.PlayerResigned:case V.PlayerDropped:return{...B,player:S.target?.name};case V.UnitPromote:return{...B,unitId:S.target?.id,unitName:S.target?.name,owner:S.target?.owner?.name,newLevel:S.target?.veteranLevel};case V.FactoryProduceUnit:return{...B,unitId:S.target?.id,unitName:S.target?.name,owner:S.target?.owner?.name};case V.BuildingCapture:return{...B,buildingId:S.target?.id,buildingName:S.target?.name,newOwner:S.target?.owner?.name};case V.BuildingPlace:return{...B,buildingId:S.target?.id,buildingName:S.target?.name,owner:S.target?.owner?.name};case V.SuperWeaponReady:return{...B,superWeapon:S.target?.rules?.name,owner:S.owner?.name};case V.SuperWeaponActivate:return{...B,superWeapon:S.target?.rules?.name,owner:S.owner?.name,tileX:S.atTile?.rx,tileY:S.atTile?.ry};case V.CratePickup:return{...B,unitId:S.unit?.id,unitName:S.unit?.name,owner:S.unit?.owner?.name,powerupType:S.powerup?.type};case V.EnterTransport:case V.LeaveTransport:return{...B,unitId:S.unit?.id,transportId:S.transport?.id};case V.PowerLow:case V.PowerRestore:return{...B,player:S.target?.name};case V.InsufficientFunds:return{...B,player:S.player?.name};case V.ObjectSell:return{...B,objectId:S.target?.id,objectName:S.target?.name,owner:S.target?.owner?.name};default:return{...B,raw:S}}}function initEventSystem(){if(z)return;const S=u().game;S?.events?(z=S.events.subscribe(S=>{try{const O=convertEvent(S),B=W.get(S.type);B&&B.forEach(S=>{try{S(O)}catch(S){console.error("[Event callback error]",S)}});const N=W.get("all");N&&N.forEach(S=>{try{S(O)}catch(S){console.error("[Event callback error]",S)}})}catch(S){console.error("[ConsoleController] Event processing error:",S)}}),console.info("[ConsoleController]  Event system initialized")):console.warn("[ConsoleController] Game events not available")}Object.defineProperty(S,"EventType",{configurable:!0,value:K}),Object.defineProperty(S,"on",{configurable:!0,value:function(O,B){return initEventSystem(),W.has(O)||W.set(O,new Set),W.get(O).add(B),()=>S.off(O,B)}}),Object.defineProperty(S,"off",{configurable:!0,value:function(S,O){const B=W.get(S);B&&B.delete(O)}}),Object.defineProperty(S,"onAll",{configurable:!0,value:function(O){return S.on("all",O)}}),Object.defineProperty(S,"offAll",{configurable:!0,value:function(O){S.off("all",O)}}),Object.defineProperty(S,"getEventListenerCount",{configurable:!0,value:function(){let S=0;return W.forEach(O=>S+=O.size),S}}),Object.defineProperty(S,"clearAllEventListeners",{configurable:!0,value:function(){return W.clear(),"All event listeners cleared"}}),Object.defineProperty(S,"onUnitDestroyed",{configurable:!0,value:function(O){return S.on(V.ObjectDestroy,O)}}),Object.defineProperty(S,"onUnitSpawned",{configurable:!0,value:function(O){return S.on(V.ObjectSpawn,O)}}),Object.defineProperty(S,"onUnitProduced",{configurable:!0,value:function(O){return S.on(V.FactoryProduceUnit,O)}}),Object.defineProperty(S,"onPlayerDefeated",{configurable:!0,value:function(O){return S.on(V.PlayerDefeated,O)}}),Object.defineProperty(S,"onSuperWeaponReady",{configurable:!0,value:function(O){return S.on(V.SuperWeaponReady,O)}}),Object.defineProperty(S,"onSuperWeaponActivate",{configurable:!0,value:function(O){return S.on(V.SuperWeaponActivate,O)}}),Object.defineProperty(S,"onBuildingCaptured",{configurable:!0,value:function(O){return S.on(V.BuildingCapture,O)}}),Object.defineProperty(S,"onOwnerChange",{configurable:!0,value:function(O){return S.on(V.ObjectOwnerChange,O)}}),Object.defineProperty(S,"view",{configurable:!0,value:function(S){const O=u(),B=O.game.getPlayerByName(S);return O.worldView?.changeLocalPlayer(B),O.minimap?.changeLocalPlayer(B),`Viewing ${S}`}}),Object.defineProperty(S,"observe",{configurable:!0,value:function(){const S=u(),O=new H(S.game);return O.player=S.localPlayer,S.actionQueue.push(O),"Observe requested"}}),Object.defineProperty(S,"order",{configurable:!0,value:{move:(S,O,B,N,L)=>(d(S).orderUnits(O,j.Move,B,N,L),"Move enqueued"),attack(S,O,B,N){const L=d(S);return"number"==typeof B&&"number"==typeof N?L.orderUnits(O,j.Attack,B,N):L.orderUnits(O,j.Attack,B),"Attack enqueued"},stop:(S,O)=>(d(S).orderUnits(O,j.Stop),"Stop enqueued"),moveDirect(S,O,B,N,j=!1){autoDisableReplay("moveDirect called - direct orders bypass replay");const F=u().game,_=F.map.tiles.getByMapCoords(B,N);if(!_)throw new Error(`No tile at ${B},${N}`);const U=F.getPlayerByName(S),H=new D(U);return O.forEach(S=>{const O=F.getObjectById(S);if(!O)return;const B=new L(F,F.map,H,j),N=F.createTarget(void 0,_);B.set(O,N),B.isValid()&&B.isAllowed()&&O.unitOrderTrait.addOrder(B,!1)}),"MoveDirect applied"},attackDirect(S,O,B,N,j){autoDisableReplay("attackDirect called - direct orders bypass replay");const L=u().game;if(!L.getPlayerByName(S))throw new Error(`Player ${S} not found`);let D={},_=N;"object"==typeof N&&null!==N?(D=N,_=void 0):j&&"object"==typeof j&&(D=j);const U=!!D.queue,H=!!D.force,V=!1!==D.allowIvanBomb,W="number"==typeof B&&"number"==typeof _;let z;if(W&&(z=L.map.tiles.getByMapCoords(B,_),!z))throw new Error(`No tile at ${B},${_}`);const K=W?void 0:L.getObjectById(B);if(!W&&!K)throw new Error(`Target object ${B} not found`);const $=W?L.createTarget(void 0,z):L.createTarget(K,K.tile);let q=0;return O.forEach(S=>{const O=L.getObjectById(S);if(!O)return;const B=new F(L,{forceAttack:H,noIvanBomb:!V});B.set(O,$),B.isValid()&&B.isAllowed()&&(O.unitOrderTrait.addOrder(B,U),q++)}),`AttackDirect applied to ${q} unit(s)`},attackMoveDirect(S,O,B,N,j){autoDisableReplay("attackMoveDirect called - direct orders bypass replay");const L=u().game;if(!L.getPlayerByName(S))throw new Error(`Player ${S} not found`);let D={},F=N;"object"==typeof N&&null!==N?(D=N,F=void 0):j&&"object"==typeof j&&(D=j);const U=!!D.queue,H=!!D.force,V="number"==typeof B&&"number"==typeof F;let W;if(V&&(W=L.map.tiles.getByMapCoords(B,F),!W))throw new Error(`No tile at ${B},${F}`);const z=V?void 0:L.getObjectById(B);if(!V&&!z)throw new Error(`Target object ${B} not found`);const K=V?L.createTarget(void 0,W):L.createTarget(z,z.tile);let $=0;return O.forEach(S=>{const O=L.getObjectById(S);if(!O)return;const B=new _(L,L.map);H&&(B.forceAttack=!0),B.set(O,K),B.isValid()&&B.isAllowed()&&(O.unitOrderTrait.addOrder(B,U),$++)}),`AttackMoveDirect applied to ${$} unit(s)`}}}),Object.defineProperty(S,"state",{configurable:!0,value:{game:()=>new N(u().game,!0),players(){return this.game().getPlayers()},unitsOf(S){return this.game().getVisibleUnits(S,"self")},unitData(S){return this.game().getUnitData(S)}}}),Object.defineProperty(S,"spawnUnit",{configurable:!0,value:function(S,O,B,N,j){autoDisableReplay("spawnUnit called - direct unit creation bypasses replay");const L=u(),D=L.game.getPlayerByName(S),F=L.game.rules.getObject(O,U[B]),_=L.game.createUnitForPlayer(F,D),H=L.game.map.tiles.getByMapCoords(N,j);if(!H)throw new Error(`No tile at ${N},${j}`);return L.game.spawnObject(_,H),_.id}}),Object.defineProperty(S,"spawnBuilding",{configurable:!0,value:function(S,O,B,N,j={}){autoDisableReplay("spawnBuilding called - direct building creation bypasses replay");const L=u().game,D=L.getPlayerByName(S);if(!D)return`Player ${S} not found`;const F=L.rules.getBuilding(O);if(!F)return`Building rules ${O} not found`;const _=L.map.tiles.getByMapCoords(B,N);if(!_)return`No tile at ${B},${N}`;let U,H;try{U=L.getConstructionWorker(D)}catch(O){return console.error("spawnBuilding: failed to get construction worker",O),`Construction worker unavailable for player ${S}`}try{H=U.normalizePlacementTile(F.name,_)}catch(S){return console.warn("spawnBuilding: normalize placement failed",S),`Failed to normalize placement tile: ${S.message??S}`}const V={rx:H.rx,ry:H.ry};if(!U.canPlaceAt(F.name,V,{normalizedTile:!0,ignoreAdjacent:void 0===j.ignoreAdjacent||!!j.ignoreAdjacent}))return`Cannot place ${O} at ${V.rx},${V.ry} (terrain blocked)`;let W;try{W=U.placeAt(F.name,H,!0)}catch(S){return console.error("spawnBuilding: placeAt failed",S),`Failed to place ${O}: ${S.message??S}`}if(!W||!W.length)return`No building spawned for ${O}`;const z=W.map(S=>S.id);return console.info("[SpawnBuilding] placed",JSON.stringify({owner:S,building:O,rootTile:V,ids:z})),`Spawned building(s) ${O} for ${S} at ${V.rx},${V.ry} (ids: ${z.join(", ")})`}}),Object.defineProperty(S,"placeBuilding",{configurable:!0,value:function(S,O,B,N){return d(S).placeBuilding(O,B,N),"PlaceBuilding enqueued"}}),Object.defineProperty(S,"setUnitDebugText",{configurable:!0,value:function(S,O){const B=u().game.getObjectById(S);return B?B.isTechno()?(B.debugLabel=O||void 0,`Debug text set for unit ${S}: "${O||"(cleared)"}"`):`Object ${S} is not a techno object (unit/building)`:`Unit ${S} not found`}}),Object.defineProperty(S,"clearUnitDebugText",{configurable:!0,value:function(O){return S.setUnitDebugText(O,void 0)}}),Object.defineProperty(S,"enableDebugText",{configurable:!0,value:function(){return void 0!==S.debug_text?(S.debug_text=!0,"Debug text display enabled"):"Debug text variable not available. Make sure you're in a game."}}),Object.defineProperty(S,"disableDebugText",{configurable:!0,value:function(){return void 0!==S.debug_text?(S.debug_text=!1,"Debug text display disabled"):"Debug text variable not available. Make sure you're in a game."}}),Object.defineProperty(S,"setUnitDebugTextBatch",{configurable:!0,value:function(O){const B=[];for(const N of O){const O=S.setUnitDebugText(N.unitId,N.label);B.push(O)}return`Set debug text for ${O.length} units:\n${B.join("\n")}`}}),Object.defineProperty(S,"setUnitFollowLabel",{configurable:!0,value:function(S,O,B){const N=u().game.getObjectById(S);if(!N)return`Unit ${S} not found`;if(!N.isTechno())return`Object ${S} is not a techno object (unit/building)`;let j={},L={};if("object"!=typeof O||null===O||Array.isArray(O)){if(null!=O){const S=String(O);S&&(j.text=S)}}else L={...O};if("string"==typeof B?L.color=B.trim():"object"!=typeof B||null===B||Array.isArray(B)||(L={...L,...B}),"string"==typeof L.text&&L.text.trim()&&(j.text=L.text.trim()),"string"==typeof L.html){const S=L.html.trim();S&&(j.html=S)}if(void 0!==L.fontSize){const S=Number(L.fontSize);!Number.isNaN(S)&&S>0&&(j.fontSize=S)}if(void 0===j.text&&void 0===j.html&&(null==O||""===O))return delete N.consoleFollowLabel,`Follow label cleared for unit ${S}`;let D="string"==typeof L.color&&L.color.trim()?L.color.trim():void 0;D||(D=N.consoleFollowLabel?.color||N.owner?.color?.asHex?.()||"#ffffff");const F={text:j.text,color:D,html:j.html,fontSize:j.fontSize};return F.text||F.html?(N.consoleFollowLabel=F,F.html?`Follow label (DOM) set for unit ${S}`:`Follow label set for unit ${S}: "${F.text}"`):(delete N.consoleFollowLabel,`Follow label cleared for unit ${S}`)}}),Object.defineProperty(S,"clearUnitFollowLabel",{configurable:!0,value:function(O){return S.setUnitFollowLabel(O,void 0)}}),Object.defineProperty(S,"setUnitFollowLabelBatch",{configurable:!0,value:function(O){const B=[];for(const N of O){const O=S.setUnitFollowLabel(N.unitId,N.label,N.color);B.push(O)}return`Set follow label for ${O.length} units:\n${B.join("\n")}`}}),Object.defineProperty(S,"setUnitOwner",{configurable:!0,value:function(S,O){autoDisableReplay("setUnitOwner called - owner change bypasses replay");const B=u().game,N=B.getObjectById(S);if(!N)return`Unit ${S} not found`;const j=B.getPlayerByName(O);if(!j)return`Player ${O} not found`;if(!N.isTechno())return`Object ${S} is not a controllable techno`;const L=N.owner;return L===j?`Unit ${S} already belongs to ${O}`:(B.changeObjectOwner(N,j),console.info("[SetUnitOwner]",JSON.stringify({unitId:S,from:L?.name,to:O})),`Unit ${S} owner changed from ${L?.name??"unknown"} to ${O}`)}}),console.log("ConsoleController loaded. Try: r.view('Player1'), r.observe(), r.state.players(), r.order.move(...), r.spawnUnit(...), r.spawnBuilding(...), r.placeBuilding(...)"),console.log("Debug text: r.setUnitDebugText(unitId, 'text'), r.enableDebugText(), r.clearUnitDebugText(unitId)"),console.log("Replay control: r.disableReplay(), r.enableReplay(), r.getReplayStatus() - Note: spawnUnit/spawnBuilding/Direct commands auto-disable replay"),console.log("Event system: r.on(r.EventType.ObjectDestroy, callback), r.onAll(callback), r.onUnitDestroyed(cb), r.onUnitSpawned(cb), r.onPlayerDefeated(cb), r.EventType for all types")}catch($){console.error("ConsoleController init failed",$)}})()}}}),System.register("tools/DevToolsApi",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){S("DevToolsApi",B=class{static getPublicNamespace(){return window.r=window.r||Object.create(null)}static registerCommand(S,O){var B=this.getPublicNamespace();B[S]?console.error(`Command ${S} is already registered`):(this.cmdHandlers.set(S,O),Object.defineProperty(B,S,{configurable:!0,get:()=>this.cmdHandlers.get(S)()}))}static unregisterCommand(S){this.cmdHandlers.has(S)?(this.cmdHandlers.delete(S),delete this.getPublicNamespace()[S]):console.error(`Command ${S} is not registered`)}static registerVar(S,O){var B=this.getPublicNamespace();B[S]?console.error(`Runtime variable ${S} is already registered`):(this.runtimeVars.set(S,O),Object.defineProperty(B,S,{configurable:!0,get:()=>this.runtimeVars.get(S).value,set:O=>{this.runtimeVars.get(S).value=O}}))}static unregisterVar(S){this.runtimeVars.has(S)?(this.runtimeVars.delete(S),delete this.getPublicNamespace()[S]):console.error(`Runtime variable ${S} is not registered`)}static listVars(){return this.runtimeVars.keys()}static listCommands(){return this.cmdHandlers.keys()}}),B.cmdHandlers=new Map,B.runtimeVars=new Map}}}),System.register("tools/InfantryTester",["engine/gfx/Renderer","engine/Engine","engine/IsoCoords","game/Player","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","engine/TheaterType","game/gameobject/unit/ZoneType","game/type/SpeedType","game/gameobject/infantry/StanceType","game/gameobject/infantry/InfDeathType","game/Alliances","game/PlayerList","game/gameobject/selection/SelectionLevel","game/gameobject/unit/VeteranLevel","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","engine/Lighting","game/gameobject/ObjectFactory","game/map/TileCollection","engine/type/ObjectType","game/gameobject/trait/MoveTrait","game/map/TileOccupation","game/map/Bridges","data/Strings","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","game/World","engine/RenderableManager","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","util/math"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,xe;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S},function(S){ge=S},function(S){pe=S},function(S){me=S},function(S){fe=S},function(S){ye=S},function(S){Te=S},function(S){ve=S},function(S){be=S},function(S){Se=S},function(S){we=S},function(S){Ee=S}],execute:function(){S("InfantryTester",xe=class{static async main(S){let O=this.renderer=new B.Renderer(800,600);O.init(document.body),O.initStats(document.body);let L=D.WorldScene.factory({x:0,y:0,width:800,height:600},new U.BoxedVar(!0),new U.BoxedVar(Se.ShadowQuality.High));this.disposables.add(L),L.scene.background=new THREE.Color(12632256),j.IsoCoords.init({x:0,y:0}),this.theater=await N.Engine.loadTheater(K.TheaterType.Snow);var _=new F.Rules(N.Engine.getRules());this.rules=_,this.art=new W.Art(_,N.Engine.getArt()),this.images=N.Engine.getImages(),this.buildBrowser(_.infantryRules);let V=new we.CanvasMetrics(O.getCanvas(),window);V.init(),this.disposables.add(V),_=new te.PointerEvents(O,{x:0,y:0},document,V);let z=new se.CameraZoomControls(_,L.cameraZoom);this.disposables.add(z,_),z.init(),O.addScene(L),(this.uiAnimationLoop=new H.UiAnimationLoop(O)).start(),this.worldScene=L,this.addGrid()}static addGrid(){var S=new _.MapGrid({width:10,height:10}).get3DObject();let O=new THREE.Object3D;O.add(S),this.worldScene.scene.add(O)}static selectInfantry(S){this.currentInfantry&&!this.currentInfantry.isDisposed&&(this.world.removeObject(this.currentInfantry),this.currentInfantry.dispose());let O=new L.Player("Player");this.disposables.add(O),O.color=this.rules.getMultiplayerColors().get("DarkRed");var B=new Y.Alliances(new X.PlayerList),j=new re.UnitSelection,D=new ne.Lighting;this.disposables.add(D);var F=new z.RenderableFactory(new U.BoxedVar(O),j,B,this.rules,this.art,void 0,new V.ImageFinder(this.images,this.theater),N.Engine.getPalettes(),null,null,this.theater,this.worldScene.camera,D,new me.LightingDirector(D,this.renderer,new U.BoxedVar(1)),new U.BoxedVar(!1),new U.BoxedVar(!1),new U.BoxedVar(2),void 0,new de.Strings,new U.BoxedVar(pe.FlyerHelperMode.Selected),new U.BoxedVar(!1),new Te.VxlBuilderFactory(new ve.VxlGeometryPool(new be.VxlGeometryCache),!1,this.worldScene.camera),new Map);j=new oe.TileCollection([],null,this.rules.general,Ee.getRandomInt),B=new he.TileOccupation(j),D=new ge.MapBounds,D=new ue.Bridges(this.theater.tileSets,j,B,D,this.rules);let _=this.currentInfantry=new ae.ObjectFactory(j,B,D,new U.BoxedVar(1)).create(le.ObjectType.Infantry,S,this.rules,this.art);_.owner=O,_.position.tile={rx:1,ry:1,z:0,rampType:0};let H=this.world=new fe.World,W=new ye.RenderableManager(H,this.worldScene,this.worldScene.camera,F);W.init(),this.disposables.add(W),H.spawnObject(_);let K=this.currentRenderable=W.getRenderableByGameObject(_);K.selectionModel.setSelectionLevel(J.SelectionLevel.Selected),K.selectionModel.setControlGroupNumber(3),this.buildControls()}static buildControls(){this.controlsEl&&document.body.removeChild(this.controlsEl);let S=this.controlsEl=document.createElement("div");S.style.position="absolute",S.style.left="0",S.style.top="0",S.style.width="200px",S.style.padding="5px",S.style.background="rgba(255, 255, 255, 0.5)",S.style.border="1px black solid",S.appendChild(document.createTextNode("Remap color:"));let O=new Map(this.rules.getMultiplayerColors()),B=document.createElement("select");B.style.display="block",B.addEventListener("change",()=>{this.currentInfantry.owner.color=O.get(B.value)}),S.appendChild(B),O.forEach((S,O)=>{let N=document.createElement("option");N.innerHTML=O,N.value=O,N.selected=S.asHex()===this.currentInfantry.owner.color.asHex(),B.appendChild(N)}),S.appendChild(document.createTextNode("Selection level:"));let N=document.createElement("div");S.appendChild(N),[J.SelectionLevel.None,J.SelectionLevel.Hover,J.SelectionLevel.Selected].forEach(S=>{let O=document.createElement("button");O.innerHTML=J.SelectionLevel[S],O.addEventListener("click",()=>this.currentRenderable.selectionModel.setSelectionLevel(S)),N.appendChild(O)}),S.appendChild(document.createTextNode("Veteran level:"));let j=document.createElement("div");S.appendChild(j),this.currentInfantry.veteranTrait&&[ee.VeteranLevel.None,ee.VeteranLevel.Veteran,ee.VeteranLevel.Elite].forEach(S=>{let O=document.createElement("button");O.innerHTML=ee.VeteranLevel[S],O.addEventListener("click",()=>this.currentInfantry.veteranTrait.veteranLevel=S),j.appendChild(O)}),S.appendChild(document.createTextNode("SubCell:"));let L=document.createElement("select");L.style.display="block",L.addEventListener("change",()=>{this.currentInfantry.position.subCell=Number(L.value)}),S.appendChild(L);for(let S=0;S<5;++S){let O=document.createElement("option");O.innerHTML=""+S,O.value=""+S,L.appendChild(O)}S.appendChild(document.createTextNode("Zone:")),this.createZoneSelect(S),S.appendChild(document.createTextNode("Stance:")),this.createStanceSelect(S),S.appendChild(document.createTextNode("isMoving:"));let D=document.createElement("input");D.type="checkbox",D.style.display="block",D.addEventListener("change",S=>{this.currentInfantry.moveTrait.moveState=S.target.checked?ce.MoveState.Moving:ce.MoveState.Idle}),S.appendChild(D),S.appendChild(document.createTextNode("isFiring:"));let F=document.createElement("input");F.type="checkbox",F.disabled=!this.currentInfantry.rules.primary,F.style.display="block",F.addEventListener("change",S=>{this.currentInfantry.isFiring=S.target.checked}),S.appendChild(F),S.appendChild(document.createTextNode("isPanicked:"));let _=document.createElement("input");_.type="checkbox",_.disabled=!this.currentInfantry.rules.fraidycat,_.style.display="block",_.addEventListener("change",S=>{this.currentInfantry.isPanicked=S.target.checked}),S.appendChild(_),S.appendChild(document.createTextNode("Warped out:"));let U=document.createElement("input");U.type="checkbox",U.style.display="block",U.addEventListener("change",S=>{this.currentInfantry.warpedOutTrait.debugSetActive(S.target.checked)}),S.appendChild(U),this.createDeathSelect(S),document.body.appendChild(S)}static createZoneSelect(S){let O=document.createElement("select");O.style.display="block",O.addEventListener("change",()=>{this.currentInfantry.zone=Number(O.value)}),S.appendChild(O);let B=document.createElement("option");if(B.value=""+$.ZoneType.Ground,B.innerHTML=$.ZoneType[$.ZoneType.Ground],O.appendChild(B),this.currentInfantry.rules.consideredAircraft){let S=document.createElement("option");S.value=""+$.ZoneType.Air,S.innerHTML=$.ZoneType[$.ZoneType.Air],O.appendChild(S)}if(this.currentInfantry.rules.speedType===q.SpeedType.Amphibious){let S=document.createElement("option");S.value=""+$.ZoneType.Water,S.innerHTML=$.ZoneType[$.ZoneType.Water],O.appendChild(S)}}static createStanceSelect(S){let O=document.createElement("select");O.style.display="block",O.addEventListener("change",()=>{this.currentInfantry.stance=Number(O.value)}),S.appendChild(O);let B=document.createElement("option");B.value=""+Q.StanceType.None,B.innerHTML=Q.StanceType[Q.StanceType.None],O.appendChild(B);let N=document.createElement("option");N.value=""+Q.StanceType.Guard,N.innerHTML=Q.StanceType[Q.StanceType.Guard],O.appendChild(N);let j=document.createElement("option");j.value=""+Q.StanceType.Paradrop,j.innerHTML=Q.StanceType[Q.StanceType.Paradrop],O.appendChild(j);let L=document.createElement("option");if(L.value=""+Q.StanceType.Cheer,L.innerHTML=Q.StanceType[Q.StanceType.Cheer],O.appendChild(L),!this.currentInfantry.rules.fearless){let S=document.createElement("option");S.value=""+Q.StanceType.Prone,S.innerHTML=Q.StanceType[Q.StanceType.Prone],O.appendChild(S)}if(this.currentInfantry.rules.deployer){let S=document.createElement("option");S.value=""+Q.StanceType.Deployed,S.innerHTML=Q.StanceType[Q.StanceType.Deployed],O.appendChild(S)}}static createDeathSelect(S){S.appendChild(document.createTextNode("Death"));let O=document.createElement("select"),B=1,N=Z.InfDeathType[B];for(;void 0!==N;){let S=document.createElement("option");S.innerHTML=N,S.value=""+B,S.disabled=!this.currentInfantry.rules.isHuman&&![Z.InfDeathType.Gunfire,Z.InfDeathType.Explode].includes(B),O.appendChild(S),N=Z.InfDeathType[++B]}S.appendChild(O);let j=document.createElement("button");j.style.display="block",j.style.color="red",j.innerHTML="KILL",j.addEventListener("click",async()=>{this.currentInfantry.isDestroyed=!0,this.currentInfantry.infDeathType=Number(O.value),this.world.removeObject(this.currentInfantry),this.currentInfantry.dispose(),document.body.removeChild(this.controlsEl),this.controlsEl=void 0}),S.appendChild(j)}static buildBrowser(S){let O=this.listEl=document.createElement("div");O.style.position="absolute",O.style.right="0",O.style.top="0",O.style.height="600px",O.style.width="200px",O.style.overflowY="auto",O.style.padding="5px",O.style.width="200px",O.style.background="rgba(255, 255, 255, 0.5)",O.style.border="1px black solid",O.appendChild(document.createTextNode("Infantry types:"));let B=[...S.keys()].filter(S=>this.art.hasObject(S,le.ObjectType.Infantry)).sort();B.forEach(S=>{let B=document.createElement("a");B.style.display="block",B.textContent=S,B.setAttribute("href","javascript:;"),B.addEventListener("click",()=>{console.log("Selected infantry",S),this.selectInfantry(S)}),O.appendChild(B)}),document.body.appendChild(O),setTimeout(()=>{this.selectInfantry(B[0]),this.animateInfantry()},50)}static animateInfantry(){this.currentInfantry.isDisposed||(this.currentInfantry.direction=(this.currentInfantry.direction+1)%360),setTimeout(()=>this.animateInfantry(),50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsEl&&(this.controlsEl.remove(),this.controlsEl=void 0),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),this.disposables.dispose()}}),xe.disposables=new ie.CompositeDisposable}}}),System.register("tools/LobbyFormTester",["engine/gfx/Renderer","engine/Engine","gui/UiScene","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/screen/mainMenu/component/MainMenu","game/rules/Rules","gui/screen/mainMenu/lobby/component/LobbyForm","engine/UiAnimationLoop","gui/jsx/JsxRenderer","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","game/gameopts/constants","network/ladder/PlayerRankType","network/ladder/wladderConfig"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S}],execute:function(){S("LobbyFormTester",Q=class{static main(S,O){let V=new B.Renderer(800,600);V.init(S),V.initStats(document.body),this.disposables.add(V);let Q=j.UiScene.factory({x:0,y:0,width:800,height:600});this.disposables.add(Q);var Z={x:Math.max(0,(Q.viewport.width-800)/2),y:Math.max(0,(Q.viewport.height-600)/2),width:800,height:600};let Y=new H.JsxRenderer(N.Engine.getImages(),N.Engine.getPalettes(),Q.camera,void 0),X=new D.MainMenu(Z,N.Engine.getImages(),Y,"dummy.webm");Q.add(X);let J=new F.Rules(N.Engine.getRules());var[Z]=Y.render(W.jsx(z.HtmlView,{x:Z.x,y:Z.y,component:_.LobbyForm,props:{strings:O,countryUiNames:new Map([["Random","GUI:RandomEx"],["Observer","GUI:Observer"]].concat(J.getMultiplayerCountries().map(S=>[S.name,S.uiName]))),countryUiTooltips:new Map,availablePlayerCountries:["Random"].concat(J.getMultiplayerCountries().map(S=>S.name)),availablePlayerColors:[""].concat([...J.getMultiplayerColors().values()].map(S=>S.asHexString())),maxTeams:4,availableAiNames:K.aiUiNames,availableStartPositions:new Array(8).fill(0).map((S,O)=>O),activeSlotIndex:0,teamsAllowed:!0,teamsRequired:!1,lobbyType:L.LobbyType.MultiplayerHost,playerSlots:[{name:"Player 1",type:L.SlotType.Player,occupation:L.SlotOccupation.Occupied,country:"French",color:"#2269d4",startPos:K.RANDOM_START_POS,team:K.NO_TEAM_ID,status:L.PlayerStatus.Host,ping:50,playerProfile:{name:"Player 1",rank:2,rankType:$.PlayerRankType.Private,points:100,ladder:{id:0,name:"1v1",divisionName:"Test ladder",type:q.LadderType.Solo1v1},wins:0,losses:0}},{name:"Player 2",type:L.SlotType.Player,occupation:L.SlotOccupation.Occupied,country:"Russians",color:"#ff1818",startPos:1,team:0,status:L.PlayerStatus.Ready,ping:300},{name:"Open",type:L.SlotType.Player,occupation:L.SlotOccupation.Open,country:"Random",color:"",startPos:K.RANDOM_START_POS,team:K.NO_TEAM_ID,status:L.PlayerStatus.NotReady},{type:L.SlotType.Observer,occupation:L.SlotOccupation.Open,country:"Observer",color:"",startPos:K.RANDOM_START_POS,team:K.NO_TEAM_ID,status:L.PlayerStatus.NotReady}],shortGame:!0,mcvRepacks:!0,cratesAppear:!0,superWeapons:!0,buildOffAlly:!0,destroyableBridges:!0,multiEngineer:!1,multiEngineerCount:3,noDogEngiKills:!1,gameSpeed:6,credits:1e4,unitCount:10,messages:[],mpDialogSettings:J.mpDialogSettings,onSendMessage:()=>{},onCountrySelect:S=>{console.log("selected country",S)},onColorSelect:S=>{console.log("selected color",S)},onStartPosSelect:S=>{console.log("selected start pos",S)},onTeamSelect:S=>{console.log("selected team",S)},onSlotChange:(S,O)=>{console.log("changed slot",S,O)},onToggleShortGame:S=>console.log(S),onToggleMcvRepacks:S=>console.log(S),onToggleCratesAppear:S=>console.log(S),onToggleSuperWeapons:S=>console.log(S),onToggleBuildOffAlly:S=>console.log(S),onChangeGameSpeed:S=>console.log(S),onChangeCredits:S=>console.log(S),onChangeUnitCount:S=>console.log(S)}}));X.add(Z),V.addScene(Q);let ee=new U.UiAnimationLoop(V);ee.start(),this.disposables.add(ee),S.appendChild(Q.getHtmlContainer().getElement()),this.disposables.add(()=>S.removeChild(Q.getHtmlContainer().getElement()))}static destroy(){this.disposables.dispose()}}),Q.disposables=new V.CompositeDisposable}}}),System.register("tools/ShpTester",["engine/gfx/Renderer","gui/UiScene","gui/screen/game/component/Hud","engine/Engine","gui/screen/game/component/hud/viewmodel/SidebarModel","game/rules/Rules","game/art/Art","game/Country","game/Player","game/World","game/gameobject/ObjectFactory","game/art/ObjectArt","engine/type/ObjectType","engine/UiAnimationLoop","game/Game","gui/jsx/JsxRenderer","util/disposable/CompositeDisposable","game/Alliances","game/PlayerList","gui/Pointer","util/BoxedVar","game/map/TileCollection","game/map/TileOccupation","game/map/Bridges","game/gameobject/selection/UnitSelection","game/ini/GameModeType","util/math","engine/TheaterType","game/GameMap","game/player/trait/RadarTrait","gui/screen/game/component/Minimap","game/player/production/Production","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","gui/screen/game/component/hud/viewmodel/MessageList","game/trait/MapShroudTrait","game/trait/SellTrait","game/map/MapBounds","engine/mixDatabase","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/CanvasMetrics","game/trait/StalemateDetectTrait","game/CountdownTimer","data/IniSection","gui/chat/ChatHistory"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,xe;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S},function(S){ge=S},function(S){pe=S},function(S){me=S},function(S){fe=S},function(S){ye=S},function(S){Te=S},function(S){ve=S},function(S){be=S},function(S){Se=S},function(S){we=S},function(S){Ee=S}],execute:function(){S("ShpTester",xe=class{static async main(S,O,Z,xe){let Oe=new B.Renderer(800,600);Oe.init(Z),Oe.initStats(document.body),this.disposables.add(Oe);let Ae=N.UiScene.factory({x:0,y:0,width:800,height:600});this.disposables.add(Ae),await S.addMixFile("sidec01.mix");var Me=ye.mixDatabase.get("cameo.mix");if(!Me)throw new Error("Missing file list database for cameos");let Re=new F.Rules(L.Engine.getRules()),Pe=new _.Art(Re,L.Engine.getArt());var Ie=await L.Engine.loadTheater(oe.TheaterType.Temperate),ke=new le.GameMap(O,Ie.tileSets,Re,ae.getRandomInt),Be={superWeapons:!1,gameSpeed:5},Ne=U.Country.factory("Americans",Re);let je=new H.Player("Player",Ne);je.radarTrait=new ce.RadarTrait,je.production=new ue.Production(je,10,Be,Re,[...Re.buildingRules.values(),...Re.infantryRules.values()]),this.disposables.add(je);var Le=new V.World,De=new X.PlayerList,Fe=new Y.Alliances(De),_e=new se.UnitSelection,Ue=new te.TileCollection([],null,Re.general,ae.getRandomInt),He=new ie.TileOccupation(Ue);Ne=new fe.MapBounds,Ie=new re.Bridges(Ie.tileSets,Ue,He,Ne,Re),Ne=new ee.BoxedVar(1);let Ge=new W.ObjectFactory(Ue,He,Ie,Ne),Ve=new q.Game(Le,ke,Re,Pe,null,"0",0,Be,ne.GameModeType.Battle,De,_e,Fe,Ne,Ge,null);var We;Ve.addPlayer(je),Ve.mapShroudTrait=new pe.MapShroudTrait(ke,Fe),Ve.traits.add(Ve.mapShroudTrait),Ve.sellTrait=new me.SellTrait(Ve,Ve.rules.general),Ve.traits.add(Ve.sellTrait),["GACNST","GAPOWR","GAREFN","GAPILE","GAAIRC","GAWEAP","GATECH","NACNST","NAPOWR"].forEach(S=>je.addOwnedObject(Ge.create(K.ObjectType.Building,S,Re,Pe)));let ze=new de.CombatantSidebarModel(je,Ve);ze.powerDrained=150,ze.powerGenerated=300,je.radarTrait.setDisabled(!1);let Ke=setInterval(()=>{ze.powerDrained=ae.getRandomInt(0,300),ze.powerGenerated=ae.getRandomInt(200,1e3),console.log(`Set power = ${ze.powerGenerated}, drain = `+ze.powerDrained)},5e3);this.disposables.add(()=>clearInterval(Ke)),je.credits=5e3;let $e=setInterval(()=>{je.credits=ae.clamp(je.credits+ae.getRandomInt(-1e3,1e3),0,1e6),console.log("Set credits",je.credits)},5e3);for(We of(this.disposables.add(()=>clearInterval($e)),je.production.getAvailableObjects())){var qe=z.ObjectArt.factory(We.type,We,L.Engine.getArt(),L.Engine.getArt().getSection(We.imageName)??new we.IniSection(We.imageName));let S=ze.getTabForQueueType(je.production.getQueueTypeForObject(We));S.items.push({target:{type:D.SidebarItemTargetType.Techno,rules:We},cameo:qe.cameo,disabled:S.id===D.SidebarCategory.Structures,progress:0,quantity:0,status:D.SidebarItemStatus.Idle})}let Qe=ze.activeTab.items[1];Qe.disabled=!1,Qe.progress=.75,Qe.quantity=2,Qe.status=D.SidebarItemStatus.OnHold;let Ze=ze.tabs[D.SidebarCategory.Infantry].items[0];Ze.quantity=5,Ze.progress=1,Ze.status=D.SidebarItemStatus.Ready;let Ye=new ve.CanvasMetrics(Oe.getCanvas(),window);Ye.init(),this.disposables.add(Ye);let Xe=J.Pointer.factory(L.Engine.getImages().get("mouse.shp"),L.Engine.getPalettes().get("mousepal.pal"),Oe,document,Ye,new ee.BoxedVar(!1));Xe.init(),Xe.lock(),this.disposables.add(Xe),Ae.add(Xe.getSprite()),Fe=new Q.JsxRenderer(L.Engine.getImages(),L.Engine.getPalettes(),Ae.camera,Xe.pointerEvents);let Je,et=new ge.MessageList(Ve.rules.audioVisual.messageDuration,6,je),it=["txt_low_power","txt_space_cant_save","txt_receiving_scenario","txt_bad_chankey"],Ce=()=>{var S=xe.get(it[ae.getRandomInt(0,it.length-1)]);console.log("Add system message:",S),et.addSystemMessage(S,"#"+new THREE.Color(Math.random(),Math.random(),Math.random()).getHexString()),Je=setTimeout(Ce,5e3*Math.random())};Je=setTimeout(Ce,5e3*Math.random()),this.disposables.add(()=>clearTimeout(Je));let rt=new j.Hud(je.country.side,Ae.viewport,L.Engine.getImages(),L.Engine.getPalettes(),Me,ze,et,new Ee.ChatHistory,new ee.BoxedVar(""),new ee.BoxedVar(!1),void 0,[],new be.StalemateDetectTrait,new Se.CountdownTimer,Fe,xe,Object.values(Te.CommandBarButtonType).filter(S=>"number"==typeof S)),st=new he.Minimap(Ve,je,rt.getTextColor(),Re.general.radar);st.setPointerEvents(Xe.pointerEvents),rt.setMinimap(st),this.disposables.add(st),Ae.add(rt),rt.onSidebarSlotClick.subscribe(S=>{console.log("clicked",S)}),rt.onOptButtonClick.subscribe(()=>{Xe.unlock(),rt.showSidebarMenu([{label:"Button 1",onClick(){console.log("button 1 clicked")}},{label:"Button 2",disabled:!0,onClick(){console.error("button 2 should not trigger onClick")}},{label:"Exit",isBottom:!0,onClick(){Xe.lock(),rt.hideSidebarMenu()}}])}),rt.onRepairButtonClick.subscribe(()=>{je.radarTrait.setDisabled(!je.radarTrait.isDisabled())}),rt.onCommandBarButtonClick.subscribe(S=>{console.log("Clicked command bar -> "+Te.CommandBarButtonType[S])}),Me=(new Date).getTime(),Oe.addScene(Ae);let nt=new $.UiAnimationLoop(Oe);this.disposables.add(nt),nt.start(),Fe=(new Date).getTime(),console.log("Rendering took "+(Fe-Me)+"ms"),Z.appendChild(Ae.getHtmlContainer().getElement()),this.disposables.add(()=>{Z.removeChild(Ae.getHtmlContainer().getElement())})}static destroy(){this.disposables.dispose()}}),xe.disposables=new Z.CompositeDisposable}}}),System.register("tools/SoundTester",["util/disposable/CompositeDisposable","data/AudioBagFile","data/IdxFile","engine/Engine"],function(S,O){"use strict";var B,N,j,L,D;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S}],execute:function(){S("SoundTester",D=class e{static async main(S,O){this.sounds=L.Engine.getSounds(),this.audioBag=new N.AudioBagFile;var B=S.openFile("audio.bag"),D=S.openFile("audio.idx");this.audioBag.fromVirtualFile(B,new j.IdxFile(D.stream)),S.addArchive(this.audioBag,"audio.bag"),this.buildBrowser()}static selectSound(S){let O=new AudioContext,B=O.createGain();B.gain.value=.5;var N=new Uint8Array(this.sounds.get(S).getData()).buffer;O.decodeAudioData(N,S=>{let N=O.createBufferSource();N.buffer=S,N.connect(B).connect(O.destination),N.start(0)},S=>console.log(S))}static buildBrowser(){let S=this.listEl=document.createElement("div");S.style.position="absolute",S.style.right="0",S.style.top="0",S.style.height="600px",S.style.width="200px",S.style.overflowY="auto",S.style.padding="5px",S.style.background="rgba(255, 255, 255, 0.5)",S.style.border="1px black solid",S.appendChild(document.createTextNode("Sound files:")),this.audioBag.getFileList().forEach(O=>{let B=document.createElement("a");B.style.display="block",B.textContent=O,B.setAttribute("href","javascript:;"),B.addEventListener("click",()=>{e.selectSound(O)}),S.appendChild(B)}),document.body.appendChild(S)}static destroy(){this.listEl.remove(),this.disposables.dispose()}}),D.disposables=new B.CompositeDisposable}}}),System.register("tools/TestApi",["gui/screen/mainMenu/ScreenType","tools/DevToolsApi"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S.ScreenType},function(S){N=S.DevToolsApi}],execute:function(){S("TestApi",class TestApi{constructor(){this.rootController=null,this.mainMenuController=null,this.gui=null,this.ScreenType=B,this._onMainMenuReadyCallbacks=new Set,this._onGameStartCallbacks=new Set,this._onGameEndCallbacks=new Set,this._battleControlUnsubscribe=null,this._isGameActive=!1}init(S,O){return this.gui=S,this.rootController=O,N.registerCommand("test",()=>this),window.__TEST__=this,this._setupBattleControlListener(),this._notifyMainMenuReady(),console.log("[TestApi]  Initialized!"),console.log("[TestApi] Use window.__TEST__.help() or r.test.help() for usage"),console.log("[TestApi]  Lifecycle events: onMainMenuReady(), onGameStart(), onGameEnd()"),this}_setupBattleControlListener(){const setupListener=()=>{window.CdApi?.battleControl&&(this._battleControlUnsubscribe=window.CdApi.battleControl.onToggle(S=>{S&&!this._isGameActive?(this._isGameActive=!0,this._notifyGameStart()):!S&&this._isGameActive&&(this._isGameActive=!1,this._notifyGameEnd())}),console.log("[TestApi]  Battle control listener ready"))};window.CdApi?.battleControl?setupListener():window.addEventListener("CdApiReady",setupListener,{once:!0})}_notifyMainMenuReady(){for(const S of this._onMainMenuReadyCallbacks)try{S()}catch(S){console.error("[TestApi] onMainMenuReady callback error:",S)}}_notifyGameStart(){console.log("[TestApi]  Game started!");for(const S of this._onGameStartCallbacks)try{S()}catch(S){console.error("[TestApi] onGameStart callback error:",S)}}_notifyGameEnd(){console.log("[TestApi]  Game ended!");for(const S of this._onGameEndCallbacks)try{S()}catch(S){console.error("[TestApi] onGameEnd callback error:",S)}}onMainMenuReady(S){if(this._onMainMenuReadyCallbacks.add(S),this.rootController)try{S()}catch(S){console.error(S)}return()=>this._onMainMenuReadyCallbacks.delete(S)}onGameStart(S){if(this._onGameStartCallbacks.add(S),this._isGameActive)try{S()}catch(S){console.error(S)}return()=>this._onGameStartCallbacks.delete(S)}onGameEnd(S){return this._onGameEndCallbacks.add(S),()=>this._onGameEndCallbacks.delete(S)}isGameActive(){return this._isGameActive}waitForMainMenu(){return new Promise(S=>{if(this.rootController)S();else{const O=this.onMainMenuReady(()=>{O(),S()})}})}waitForGameStart(S=6e4){return new Promise((O,B)=>{if(this._isGameActive)return void O();const N=setTimeout(()=>{j(),B(new Error("Timeout waiting for game start"))},S),j=this.onGameStart(()=>{clearTimeout(N),j(),O()})})}waitForGameEnd(S){return new Promise((O,B)=>{if(!this._isGameActive)return void O();let N;S&&(N=setTimeout(()=>{j(),B(new Error("Timeout waiting for game end"))},S));const j=this.onGameEnd(()=>{N&&clearTimeout(N),j(),O()})})}get controller(){const S=this.rootController?.getCurrentScreen?.();return S?.mainMenuCtrl?S.mainMenuCtrl:this.mainMenuController||this.rootController}getControllerInfo(){const S=this.rootController?.getCurrentScreen?.(),O=S?.mainMenuCtrl,B=O?.getCurrentScreen?.();return{rootController:!!this.rootController,rootScreen:S?.constructor?.name||"none",hasMainMenuCtrl:!!O,mainMenuScreenStack:O?.screenStack?.length||0,currentMenuScreen:B?.constructor?.name||"none"}}help(){return console.log("\n\n                    ra2web Test API                           \n\n Navigation:                                                  \n   __TEST__.getScreens()         - List all screen types      \n   __TEST__.getCurrentScreen()   - Get current screen name    \n   __TEST__.goTo('Skirmish')     - Navigate to screen         \n   __TEST__.back()               - Go back to previous screen \n                                                              \n UI Interaction:                                              \n   __TEST__.getSidebarButtons()  - List sidebar buttons       \n   __TEST__.clickSidebar(0)      - Click sidebar button       \n   __TEST__.clickSidebar('')  - Click by label            \n   __TEST__.click('button.xxx')  - Click element by selector  \n   __TEST__.type('input', 'txt') - Type into input            \n                                                              \n Query:                                                       \n   __TEST__.find('selector')     - Find elements              \n   __TEST__.findByText('text')   - Find by text content       \n   __TEST__.getState()           - Get current UI state       \n                                                              \n Utilities:                                                   \n   __TEST__.wait(ms)             - Wait for milliseconds      \n   __TEST__.waitFor('selector')  - Wait for element           \n   __TEST__.screenshot()         - Download screenshot        \n                                                              \n Automation:                                                  \n   __TEST__.runTest(testFn)      - Run an async test          \n\n          "),this}getScreens(){const S={};for(const O in B)"number"==typeof B[O]&&(S[O]=B[O]);return console.table(S),S}_getScreenNameByType(S){for(const O in B)if(B[O]===S)return O;return String(S)}getCurrentScreen(){const S=this.rootController?.getCurrentScreen?.();if(!S)return console.log("[TestApi] Current screen: none"),null;const O=S.mainMenuCtrl;if(O){const S=O.getCurrentScreen?.();if(S){for(const[B,N]of O.screens)if(N===S){const S=this._getScreenNameByType(B);return console.log("[TestApi] Current screen:",S),S}const B=S.constructor?.name||"Unknown";return console.log("[TestApi] Current screen (by class):",B),B}}for(const[O,B]of this.rootController.screens)if(B===S){const S=0===O?"MainMenuRoot":1===O?"Game":2===O?"Replay":String(O);return console.log("[TestApi] Current screen (root):",S),S}const B=S.constructor?.name||"Unknown";return console.log("[TestApi] Current screen (fallback):",B),B}async goTo(S){let O=S;if("string"==typeof S&&(O=B[S],void 0===O))return console.error(`[TestApi] Unknown screen: ${S}`),console.log("[TestApi] Available screens:",Object.keys(B).filter(S=>"number"==typeof B[S])),!1;try{const S=this.controller;if(!S)return console.error("[TestApi] No controller available"),!1;S.goToScreenBlocking?await S.goToScreenBlocking(O):(S.goToScreen(O),await this.wait(200)),await this.wait(50);const B=this._getScreenNameByType(O);return console.log(`[TestApi] Navigated to: ${B}`),!0}catch(S){return console.error("[TestApi] Navigation failed:",S),!1}}async back(){try{return await(this.controller?.popScreen()),console.log("[TestApi] Went back"),!0}catch(S){return console.error("[TestApi] Back failed:",S),!1}}getSidebarButtons(){const S=[".sidebar-menu button",".sidebar button",'[class*="sidebar"] button','[class*="menu-item"]','[class*="MenuItem"]','[class*="mainmenu"] > div > div > div > div'];let O=[];for(const B of S){const S=document.querySelectorAll(B);if(S.length>0){S.forEach((S,B)=>{const N=S.textContent?.trim();N&&N.length<50&&!O.find(S=>S.label===N)&&O.push({index:O.length,label:N,disabled:S.classList?.contains("disabled")||S.getAttribute("disabled"),element:S})});break}}if(0===O.length){const S=["","","","","MOD","","","QuickMatch","Custom","Skirmish","Replay","Options"],B=document.querySelectorAll("div, button, span"),N=new Set;B.forEach(B=>{const j=B.textContent?.trim();j&&S.some(S=>j.includes(S))&&0===B.children.length&&!N.has(j)&&(N.add(j),O.push({index:O.length,label:j,disabled:!1,element:B.parentElement||B}))})}return console.table(O.map(S=>({index:S.index,label:S.label,disabled:S.disabled}))),O}async clickSidebar(S){const O=this.getSidebarButtons();let B;return B="number"==typeof S?O[S]:O.find(O=>O.label.includes(S)),B?B.disabled?(console.warn(`[TestApi] Button is disabled: ${B.label}`),!1):(B.element.click(),console.log(`[TestApi] Clicked sidebar: ${B.label}`),await this.wait(100),!0):(console.error(`[TestApi] Sidebar button not found: ${S}`),!1)}async click(S){const O=document.querySelector(S);return O?(O.click(),console.log(`[TestApi] Clicked: ${S}`),await this.wait(50),!0):(console.error(`[TestApi] Element not found: ${S}`),!1)}async type(S,O){const B=document.querySelector(S);return B?(B.focus(),B.value=O,B.dispatchEvent(new Event("input",{bubbles:!0})),B.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`[TestApi] Typed into ${S}: ${O}`),!0):(console.error(`[TestApi] Input not found: ${S}`),!1)}find(S){const O=document.querySelectorAll(S);return console.log(`[TestApi] Found ${O.length} elements for: ${S}`),Array.from(O)}findByText(S,O="*"){const B=document.querySelectorAll(O),N=Array.from(B).filter(O=>O.textContent?.includes(S)&&0===O.children.length);return console.log(`[TestApi] Found ${N.length} elements containing: "${S}"`),N}getState(){const S={currentScreen:this.getCurrentScreen(),url:window.location.href,sidebarButtons:this.getSidebarButtons().map(S=>S.label),dialogs:Array.from(document.querySelectorAll('[class*="dialog"], [class*="modal"]')).length,loading:!!document.querySelector('[class*="loading"]')};return console.log("[TestApi] UI State:",S),S}wait(S){return new Promise(O=>setTimeout(O,S))}async waitFor(S,O=5e3){const B=Date.now();for(;Date.now()-B<O;){const O=document.querySelector(S);if(O)return console.log(`[TestApi] Element appeared: ${S}`),O;await this.wait(100)}return console.error(`[TestApi] Timeout waiting for: ${S}`),null}async waitForText(S,O=5e3){const B=Date.now();for(;Date.now()-B<O;){if(document.body.textContent?.includes(S))return console.log(`[TestApi] Text appeared: "${S}"`),!0;await this.wait(100)}return console.error(`[TestApi] Timeout waiting for text: "${S}"`),!1}async screenshot(S="ra2web-screenshot.png"){try{const O=document.querySelector("canvas");if(O){const B=document.createElement("a");return B.download=S,B.href=O.toDataURL("image/png"),B.click(),console.log(`[TestApi] Screenshot saved: ${S}`),!0}return console.error("[TestApi] No canvas found for screenshot"),!1}catch(S){return console.error("[TestApi] Screenshot failed:",S),!1}}async runTest(S){console.log("[TestApi] "),console.log("[TestApi] Starting automated test..."),console.log("[TestApi] ");const O=Date.now();try{await S(this);const B=Date.now()-O;return console.log("[TestApi] "),console.log(`[TestApi]  Test completed in ${B}ms`),console.log("[TestApi] "),{success:!0,duration:B}}catch(S){const B=Date.now()-O;return console.error("[TestApi] "),console.error(`[TestApi]  Test failed after ${B}ms:`,S),console.error("[TestApi] "),{success:!1,duration:B,error:S}}}assert(S,O){if(!S)throw new Error(`Assertion failed: ${O}`);return console.log(`[TestApi]  Assert passed: ${O}`),!0}assertExists(S){const O=document.querySelector(S);if(!O)throw new Error(`Element not found: ${S}`);return console.log(`[TestApi]  Element exists: ${S}`),O}assertText(S){if(!document.body.textContent?.includes(S))throw new Error(`Text not found: "${S}"`);return console.log(`[TestApi]  Text found: "${S}"`),!0}async startSkirmish(S={}){if(console.log("[TestApi] Starting skirmish game..."),!this.rootController)return console.error("[TestApi] RootController not available. Make sure you're on the main menu."),!1;try{const{MapFile:O}=await SystemJS.import("data/MapFile"),{MapDigest:B}=await SystemJS.import("engine/MapDigest"),{Engine:N}=await SystemJS.import("engine/Engine"),{AiDifficulty:j}=await SystemJS.import("game/gameopts/GameOpts"),L=-1,D=-2,F=-2,_=-3,U=-2,H=!0===S.observer;let V=H?2:1;const W={map:S.map||"mp01t4.map",playerName:S.playerName||"Player 1",playerCountry:S.playerCountry??L,playerColor:S.playerColor??L,playerStartPos:S.playerStartPos??L,playerTeam:S.playerTeam??F,isObserver:H,aiCount:Math.min(7,Math.max(V,S.aiCount||V)),aiDifficulty:S.aiDifficulty??j.Medium,credits:S.credits||1e4,gameSpeed:S.gameSpeed??6,unitCount:S.unitCount||0,techLevel:S.techLevel||10,shortGame:!1!==S.shortGame,superWeapons:!1!==S.superWeapons,mcvRepacks:!1!==S.mcvRepacks,cratesAppear:S.cratesAppear||!1,destroyableBridges:!1!==S.destroyableBridges,multiEngineer:S.multiEngineer||!1,buildOffAlly:S.buildOffAlly||!1,noDogEngiKills:S.noDogEngiKills||!1,gameMode:S.gameMode??1};let z;if(console.log(`[TestApi] Loading map: ${W.map}`),N.vfs.fileExists(W.map))z=N.vfs.openFile(W.map),console.log("[TestApi] Map found in VFS");else{const S=await N.getMapDir().catch(()=>null);if(!S||!await S.containsEntry(W.map))throw new Error(`Map "${W.map}" not found in VFS or maps directory`);z=await S.openFile(W.map,!0),console.log("[TestApi] Map found in maps directory (custom map)")}const K=B.compute(z),$=new O(z),q={fileName:W.map,maxSlots:$.startingLocations?.length||8,title:$.getSection("Basic")?.getString("Name")||W.map.replace(/\.(map|mpr|yrm)$/i,""),sizeBytes:z.getSize()};console.log(`[TestApi] Map loaded: ${q.title}, max slots: ${q.maxSlots}`);const Q=new Set,Z=new Set;let Y,X,J;W.isObserver?(J=_,Y=U,X=D,console.log("[TestApi] Observer mode enabled")):(Y=W.playerColor,Y<0&&(Y=0),Q.add(Y),X=W.playerStartPos,X<0&&(X=0),Z.add(X),J=W.playerCountry,J<0&&(J=0));const ee=new Array(9).fill(null),getNextColor=S=>{if(S>=0&&!Q.has(S))return Q.add(S),S;for(let S=0;S<8;S++)if(!Q.has(S))return Q.add(S),S;return 0},getNextStartPos=S=>{if(S>=0&&!Z.has(S))return Z.add(S),S;for(let S=0;S<q.maxSlots;S++)if(!Z.has(S))return Z.add(S),S;return 0};if(S.ai&&Array.isArray(S.ai))S.ai.forEach((S,O)=>{const B=O+1;B<q.maxSlots&&(ee[B]={difficulty:S.difficulty??W.aiDifficulty,countryId:S.country>=0?S.country:B%9,colorId:getNextColor(S.color),startPos:getNextStartPos(S.startPos),teamId:S.team??F})}),console.log(`[TestApi] Custom AI config: ${S.ai.length} AI(s)`);else for(let S=1;S<=W.aiCount&&S<q.maxSlots;S++)ee[S]={difficulty:W.aiDifficulty,countryId:S%9,colorId:getNextColor(-1),startPos:getNextStartPos(-1),teamId:F};const te={gameMode:W.gameMode,shortGame:W.shortGame,mcvRepacks:W.mcvRepacks,superWeapons:W.superWeapons,credits:W.credits,unitCount:W.unitCount,gameSpeed:W.gameSpeed,techLevel:W.techLevel,cratesAppear:W.cratesAppear,destroyableBridges:W.destroyableBridges,multiEngineer:W.multiEngineer,buildOffAlly:W.buildOffAlly,noDogEngiKills:W.noDogEngiKills,mapName:W.map,mapDigest:K,mapSizeBytes:q.sizeBytes,mapTitle:q.title,maxSlots:q.maxSlots,mapOfficial:!0,humanPlayers:[{name:W.playerName,countryId:J,colorId:Y,startPos:X,teamId:W.playerTeam}],aiPlayers:ee},ie=ee.filter(S=>null!==S).length,re=ee.map((S,O)=>S?`  AI${O}: =${2===S.difficulty?"":""}, =${S.countryId}, =${S.colorId}, =${S.startPos}, =${S.teamId}`:null).filter(Boolean);console.log("[TestApi] Game options:",{map:W.map,player:`${W.playerName} (=${J}, =${Y}, =${X}, =${W.playerTeam})`,aiCount:ie,credits:W.credits,gameSpeed:W.gameSpeed}),re.length>0&&console.log("[TestApi] AI:\n"+re.join("\n"));const se="skirmish-"+Date.now(),ne=Date.now();return this.rootController.createGame(se,ne,void 0,W.playerName,te,!0,!1,!1,!1),console.log("[TestApi]  Skirmish game started!"),console.log("[TestApi] Game ID:",se),{success:!0,gameId:se,gameOpts:te}}catch(S){return console.error("[TestApi] Failed to start skirmish:",S),{success:!1,error:S.message}}}async getMapList(S=!1){try{const{Engine:O}=await SystemJS.import("engine/Engine");let B=O.getMapList();B||(console.log("[TestApi] MapList not loaded, loading now..."),B=await O.loadMapList());const N=await O.getMapDir().catch(()=>null);if(N&&B){const{MapManifest:S}=await SystemJS.import("engine/MapManifest"),j=O.getMpModes();let L=0;for await(const D of N.getEntries()){const F=D.toLowerCase();if(O.supportedMapTypes.some(S=>F.endsWith("."+S))&&!B.getByName(D))try{const O=await N.openFile(D,!0),F=(new S).fromMapFile(O,j.getAll());B.add(F),L++}catch(S){console.warn(`[TestApi] Failed to load custom map "${D}":`,S.message)}}L>0&&console.log(`[TestApi] Loaded ${L} custom maps from maps folder`)}if(B){const O=B.getAll();return console.log(`[TestApi] Found ${O.length} maps total`),S?O.map(S=>({fileName:S.fileName,title:S.title||S.name,maxSlots:S.maxSlots,isCustom:S.isCustom||!1})):O.map(S=>S.fileName)}const j=this.rootController;if(j?.screenStack?.[0]?.mainMenuCtrl?.screenStack)for(const O of j.screenStack[0].mainMenuCtrl.screenStack)if(O?.mapList){const B=O.mapList.getAll();return console.log(`[TestApi] Found ${B.length} maps (from screen)`),S?B.map(S=>({fileName:S.fileName,title:S.title||S.name,maxSlots:S.maxSlots})):B.map(S=>S.fileName)}return console.warn("[TestApi] MapList not found."),[]}catch(S){return console.error("[TestApi] Failed to get map list:",S),[]}}async quickSkirmish(S=1,O=1){return this.startSkirmish({aiCount:S,aiDifficulty:O,map:"mp01t4.map"})}gameHelp(){return console.log('\n\n                      Quick Game Start API                             \n\n :                                                             \n   r.test.quickSkirmish()           - 1v1 vs  AI                   \n   r.test.quickSkirmish(3, 1)       - 1v3 vs  AIs                  \n   r.test.quickSkirmish(2, 2)       - 1v2 vs  AIs                  \n\n  (AI):                                              \n   r.test.startSkirmish({ observer: true, aiCount: 2 })               \n   r.test.startSkirmish({ observer: true, aiCount: 4, map: "mp01t4"}) \n   : 2AI                                         \n\n :                                                             \n   r.test.startSkirmish({                                              \n     map: "mp02t4.map",             -                        \n     playerName: "MyName",          -                          \n     playerCountry: 0,              -  (0-8, -1=)              \n     playerColor: 0,                -  (0-7, -1=)              \n     playerStartPos: 0,             -  (0-7, -1=)              \n     playerTeam: 0,                 -  (0-3, -2=)            \n     observer: false,               -  (>=2AI)           \n     aiCount: 2,                    - AI (1-7)                     \n     aiDifficulty: 1,               - AI: 1=, 2=       \n     credits: 10000,                -                          \n     gameSpeed: 6,                  -  (0-6)                       \n     superWeapons: true,            -                          \n     shortGame: true,               -                          \n     mcvRepacks: true,              - MCV                    \n     cratesAppear: false,           -                          \n     destroyableBridges: true,      -                        \n     multiEngineer: false,          -                        \n     noDogEngiKills: false,         -                    \n     buildOffAlly: false            -                    \n   })                                                                  \n\n AI ( ai ):                                        \n   r.test.startSkirmish({                                              \n     map: "mp04t6.map",                                                \n     playerCountry: 0, playerColor: 0, playerStartPos: 0, playerTeam: 0\n     ai: [                                                             \n       { difficulty: 1, country: 1, color: 1, startPos: 1, team: 1 },  \n       { difficulty: 2, country: 2, color: 2, startPos: 2, team: 1 },  \n       { difficulty: 1, country: 3, color: 3, startPos: 3, team: 0 }   \n     ]                                                                 \n   })                                                                  \n                                                                       \n AI:                                                           \n   difficulty: 1=(Supalosa), 2=(Dummy)                         \n   country:    ID (0-8), -1/-2=                                \n   color:      ID (0-7), -1/-2=                                \n   startPos:    (), -1/-2=                       \n   team:       ID (0-3), -2=                                 \n\n ID (rules.iniMultiplay=true):                         \n   rules:                                    \n   0=Americans(), 1=Alliance(), 2=French(),                \n   3=Germans(), 4=British(), 5=Africans(),               \n   6=Arabs(), 7=Confederation(), 8=Russians()            \n   -1/-2=                                                          \n   : rules.ini                                     \n\n ID:                                                               \n   0=Gold(), 1=DarkRed(), 2=DarkBlue(), 3=DarkGreen(),   \n   4=Orange(), 5=DarkSky(), 6=Purple(), 7=Magenta()        \n\n :                                                                 \n   r.test.getMapList()              -                      \n\n          '),this}})}}}),System.register("tools/VehicleTester",["engine/gfx/Renderer","engine/Engine","engine/IsoCoords","game/Player","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","engine/TheaterType","game/theater/rampHeights","game/Alliances","game/PlayerList","game/gameobject/selection/SelectionLevel","game/gameobject/unit/VeteranLevel","game/gameobject/ObjectFactory","engine/type/ObjectType","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","engine/Lighting","game/map/TileCollection","game/gameobject/trait/MoveTrait","game/map/TileOccupation","game/map/Bridges","data/Strings","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","game/World","engine/RenderableManager","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","game/gameobject/unit/ZoneType","util/math","game/gameobject/trait/interface/NotifyTileChange"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S},function(S){q=S},function(S){Q=S},function(S){Z=S},function(S){Y=S},function(S){X=S},function(S){J=S},function(S){ee=S},function(S){te=S},function(S){ie=S},function(S){re=S},function(S){se=S},function(S){ne=S},function(S){ae=S},function(S){oe=S},function(S){le=S},function(S){ce=S},function(S){he=S},function(S){ue=S},function(S){de=S},function(S){ge=S},function(S){pe=S},function(S){me=S},function(S){fe=S},function(S){ye=S},function(S){Te=S},function(S){ve=S},function(S){be=S},function(S){Se=S},function(S){we=S}],execute:function(){S("VehicleTester",Ee=class{static async main(S){let O=this.renderer=new B.Renderer(800,600);O.init(document.body),O.initStats(document.body);let L=D.WorldScene.factory({x:0,y:0,width:800,height:600},new U.BoxedVar(!0),new U.BoxedVar(Te.ShadowQuality.High));this.disposables.add(L),L.scene.background=new THREE.Color(12632256),j.IsoCoords.init({x:0,y:0}),this.theater=await N.Engine.loadTheater(K.TheaterType.Temperate);var _=new F.Rules(N.Engine.getRules());this.rules=_,this.art=new W.Art(_,N.Engine.getArt()),this.images=N.Engine.getImages(),this.voxels=N.Engine.getVoxels(),this.voxelAnims=N.Engine.getVoxelAnims(),this.buildBrowser(_.vehicleRules);let V=new ve.CanvasMetrics(O.getCanvas(),window);V.init(),this.disposables.add(V),_=new ee.PointerEvents(O,{x:0,y:0},document,V);let z=new re.CameraZoomControls(_,L.cameraZoom);this.disposables.add(z,_),z.init(),O.addScene(L),(this.uiAnimationLoop=new H.UiAnimationLoop(O)).start(),this.worldScene=L,this.vxlGeometryPool=new fe.VxlGeometryPool(new ye.VxlGeometryCache),this.addGrid(),this.createFloor()}static addGrid(){var S=new _.MapGrid({width:10,height:10}).get3DObject();let O=new THREE.Object3D;O.add(S),this.worldScene.scene.add(O)}static createFloor(){var S=new THREE.PlaneGeometry(1e4,1e4);let O=new THREE.ShadowMaterial;O.opacity=.5;let B=new THREE.Mesh(S,O);B.rotation.x=-Math.PI/2,B.receiveShadow=!0,B.renderOrder=2e5,B.position.y=1,this.worldScene.scene.add(B)}static selectVehicle(S){this.currentVehicle&&!this.currentVehicle.isDisposed&&(this.world.removeObject(this.currentVehicle),this.currentVehicle.dispose());let O=new L.Player("Player");this.disposables.add(O),O.color=this.rules.getMultiplayerColors().get("DarkRed");var B=new q.Alliances(new Q.PlayerList),j=new ie.UnitSelection,D=new se.Lighting;this.disposables.add(D);var F=new z.RenderableFactory(new U.BoxedVar(O),j,B,this.rules,this.art,void 0,new V.ImageFinder(this.images,this.theater),N.Engine.getPalettes(),this.voxels,this.voxelAnims,this.theater,this.worldScene.camera,D,new de.LightingDirector(D,this.renderer,new U.BoxedVar(1)),new U.BoxedVar(!1),new U.BoxedVar(!1),new U.BoxedVar(2),void 0,new ce.Strings,new U.BoxedVar(ue.FlyerHelperMode.Selected),new U.BoxedVar(!1),new me.VxlBuilderFactory(this.vxlGeometryPool,!1,this.worldScene.camera),new Map);j=new ne.TileCollection([],null,this.rules.general,Se.getRandomInt),B=new oe.TileOccupation(j),D=new he.MapBounds,D=new le.Bridges(this.theater.tileSets,j,B,D,this.rules);let _=new X.ObjectFactory(j,B,D,new U.BoxedVar(1)),H=this.currentVehicle=_.create(J.ObjectType.Vehicle,S,this.rules,this.art);H.owner=O,H.position.tile=this.tile,H.harvesterTrait?(H.harvesterTrait.ore=5,H.harvesterTrait.gems=10):H.transportTrait&&H.transportTrait.units.push(_.create(J.ObjectType.Vehicle,"FV",this.rules,this.art),_.create(J.ObjectType.Infantry,"E1",this.rules,this.art),_.create(J.ObjectType.Infantry,"CLEG",this.rules,this.art)),H.tilterTrait?.[we.NotifyTileChange.onTileChange](H);let W=this.world=new ge.World,K=new pe.RenderableManager(W,this.worldScene,this.worldScene.camera,F);K.init(),this.disposables.add(K),W.spawnObject(H);let $=this.currentRenderable=K.getRenderableByGameObject(H);$.selectionModel.setSelectionLevel(Z.SelectionLevel.Selected),$.selectionModel.setControlGroupNumber(3),this.buildControls()}static buildControls(){this.controlsEl&&document.body.removeChild(this.controlsEl);let S=this.controlsEl=document.createElement("div");S.style.position="absolute",S.style.left="0",S.style.top="0",S.style.width="200px",S.style.padding="5px",S.style.background="rgba(255, 255, 255, 0.5)",S.style.border="1px black solid",S.appendChild(document.createTextNode("Remap color:"));let O=this.rules.getMultiplayerColors(),B=document.createElement("select");B.style.display="block",B.addEventListener("change",()=>{this.currentVehicle.owner.color=O.get(B.value)}),S.appendChild(B),O.forEach((S,O)=>{let N=document.createElement("option");N.innerHTML=O,N.value=O,N.selected=S.asHex()===this.currentVehicle.owner.color.asHex(),B.appendChild(N)}),S.appendChild(document.createTextNode("Selection level:"));let N=document.createElement("div");S.appendChild(N),[Z.SelectionLevel.None,Z.SelectionLevel.Hover,Z.SelectionLevel.Selected].forEach(S=>{let O=document.createElement("button");O.innerHTML=Z.SelectionLevel[S],O.addEventListener("click",()=>this.currentRenderable.selectionModel.setSelectionLevel(S)),N.appendChild(O)}),S.appendChild(document.createTextNode("Veteran level:"));let j=document.createElement("div");S.appendChild(j),this.currentVehicle.veteranTrait&&[Y.VeteranLevel.None,Y.VeteranLevel.Veteran,Y.VeteranLevel.Elite].forEach(S=>{let O=document.createElement("button");O.innerHTML=Y.VeteranLevel[S],O.addEventListener("click",()=>this.currentVehicle.veteranTrait.veteranLevel=S),j.appendChild(O)}),S.appendChild(document.createTextNode("Ramp type:"));let L=document.createElement("select");L.style.display="block",L.addEventListener("change",()=>{this.tile.rampType=Number(L.value),this.currentVehicle.tilterTrait?.[we.NotifyTileChange.onTileChange](this.currentVehicle)}),S.appendChild(L);for(let S=0;S<$.rampHeights.length;++S){let O=document.createElement("option");O.innerHTML=""+S,O.value=""+S,L.appendChild(O)}S.appendChild(document.createTextNode("Turret #:"));let D=document.createElement("select");D.style.display="block",D.disabled=!this.currentVehicle.rules.turret,D.addEventListener("change",()=>{this.currentVehicle.turretNo=Number(D.value)}),S.appendChild(D);for(let S=0;S<this.currentVehicle.rules.turretCount;++S){let O=document.createElement("option");O.innerHTML=""+S,O.value=""+S,D.appendChild(O)}S.appendChild(document.createTextNode("isMoving:"));let F=document.createElement("input");F.type="checkbox",F.style.display="block",F.addEventListener("change",S=>{var O=S.target.checked;this.currentVehicle.moveTrait.moveState=O?ae.MoveState.Moving:ae.MoveState.Idle,this.currentVehicle.rules.consideredAircraft&&O?this.currentVehicle.zone=be.ZoneType.Air:this.currentVehicle.zone=this.currentVehicle.rules.naval?be.ZoneType.Water:be.ZoneType.Ground}),S.appendChild(F),S.appendChild(document.createTextNode("isFiring:"));let _=document.createElement("input");_.type="checkbox",_.style.display="block",_.addEventListener("change",S=>{this.currentVehicle.isFiring=S.target.checked}),S.appendChild(_),S.appendChild(document.createTextNode("isRocking:"));let U=document.createElement("input");if(U.type="checkbox",U.style.display="block",U.addEventListener("change",S=>{S.target.checked?this.currentVehicle.applyRocking(360*Math.random(),1):this.currentVehicle.rocking=void 0}),S.appendChild(U),this.currentVehicle.airSpawnTrait){S.appendChild(document.createTextNode("hasSpawns:"));let O=document.createElement("input");O.type="checkbox",O.style.display="block",O.checked=!!this.currentVehicle.airSpawnTrait.availableSpawns,O.addEventListener("change",S=>{var O=S.target.checked?1:0;this.currentVehicle.airSpawnTrait.debugSetStorage(null,O)}),S.appendChild(O)}S.appendChild(document.createTextNode("Warped out:"));let H=document.createElement("input");H.type="checkbox",H.style.display="block",H.addEventListener("change",S=>{this.currentVehicle.warpedOutTrait.debugSetActive(S.target.checked)}),S.appendChild(H),S.appendChild(document.createTextNode("Direction:"));let V=document.createElement("div");S.appendChild(V);let W=document.createElement("input");W.type="range",W.min="-180",W.max="180",W.value="0",W.disabled=void 0===this.fixedDirection,W.style.verticalAlign="middle",W.addEventListener("input",()=>{this.fixedDirection=Number(W.value)}),V.appendChild(W);let z=document.createElement("button");z.innerHTML="Reset",z.disabled=void 0===this.fixedDirection,z.style.verticalAlign="middle",z.addEventListener("click",()=>{void 0!==this.fixedDirection&&(this.fixedDirection=0,W.value="0")}),V.appendChild(z);let K=document.createElement("input");K.type="checkbox",K.checked=void 0===this.fixedDirection,K.addEventListener("change",S=>{this.fixedDirection=S.target.checked?void 0:0,W.disabled=z.disabled=void 0===this.fixedDirection,W.value="0"}),S.appendChild(K);let q=document.createElement("label");q.innerHTML="Auto rotate",S.appendChild(q);let Q=document.createElement("button");Q.style.display="block",Q.style.color="red",Q.innerHTML="DESTROY",Q.addEventListener("click",async()=>{this.currentVehicle.isDestroyed=!0,this.world.removeObject(this.currentVehicle),this.currentVehicle.dispose(),document.body.removeChild(this.controlsEl),this.controlsEl=void 0}),S.appendChild(Q),document.body.appendChild(S)}static buildBrowser(S){let O=this.listEl=document.createElement("div");O.style.position="absolute",O.style.right="0",O.style.top="0",O.style.height="600px",O.style.width="200px",O.style.overflowY="auto",O.style.padding="5px",O.style.background="rgba(255, 255, 255, 0.5)",O.style.border="1px black solid",O.appendChild(document.createTextNode("Vehicle types:"));let B=[...S.keys()].filter(S=>this.art.hasObject(S,J.ObjectType.Vehicle)).sort();B.forEach(S=>{let B=document.createElement("a");B.style.display="block",B.textContent=S,B.setAttribute("href","javascript:;"),B.addEventListener("click",()=>{console.log("Selected vehicle",S),this.selectVehicle(S)}),O.appendChild(B)}),document.body.appendChild(O),setTimeout(()=>{this.selectVehicle(B[0]),this.animateVehicle()},50)}static animateVehicle(){this.currentVehicle.direction=this.fixedDirection??(this.currentVehicle.direction+1)%360,this.currentVehicle.turretTrait&&(this.currentVehicle.turretTrait.facing=this.fixedDirection??(this.currentVehicle.turretTrait.facing+2)%360),setTimeout(()=>this.animateVehicle(),50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsEl&&(this.controlsEl.remove(),this.controlsEl=void 0),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),this.disposables.dispose()}}),Ee.tile={rx:1,ry:1,rampType:0,z:0},Ee.disposables=new te.CompositeDisposable}}}),System.register("tools/VxlTester",["data/Palette","data/VxlFile","engine/gfx/Renderer","engine/renderable/WorldScene","engine/renderable/builder/VxlNonBatchedBuilder","engine/UiAnimationLoop","gui/PointerEvents","util/disposable/CompositeDisposable","tools/CameraZoomControls","util/BoxedVar","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics"],function(S,O){"use strict";var B,N,j,L,D,F,_,U,H,V,W,z,K,$,q,Q,Z;return O&&O.id,{setters:[function(S){B=S},function(S){N=S},function(S){j=S},function(S){L=S},function(S){D=S},function(S){F=S},function(S){_=S},function(S){U=S},function(S){H=S},function(S){V=S},function(S){W=S},function(S){z=S},function(S){K=S},function(S){$=S}],execute:function(){q=["1tnk.vxl","1tnkbarl.vxl","1tnktur.vxl","2tnk.vxl","2tnkbarl.vxl","2tnktur.vxl","3tnk.vxl","3tnkbarl.vxl","3tnktur.vxl","4tnk.vxl","4tnkbarl.vxl","4tnktur.vxl","aegis.vxl","apache.vxl","apc.vxl","apcw.vxl","art2.vxl","art2barl.vxl","art2tur.vxl","arty.vxl","artybarl.vxl","asw.vxl","axle.vxl","bana.vxl","beag.vxl","bggy.vxl","bike.vxl","bus.vxl","car.vxl","cargocar.vxl","carrier.vxl","cdest.vxl","cdestwo.vxl","cmin.vxl","cmon.vxl","cona.vxl","cop.vxl","cplane.vxl","cruise.vxl","dest.vxl","destwo.vxl","dmisl.vxl","dpod.vxl","dred.vxl","dredwo.vxl","dshp.vxl","euroc.vxl","falc.vxl","flak.vxl","flaktur.vxl","flata.vxl","fortress.vxl","ftnk.vxl","fv.vxl","fvtur.vxl","fvtur1.vxl","fvtur10.vxl","fvtur11.vxl","fvtur12.vxl","fvtur13.vxl","fvtur14.vxl","fvtur2.vxl","fvtur3.vxl","fvtur4.vxl","fvtur5.vxl","fvtur6.vxl","fvtur7.vxl","fvtur8.vxl","fvtur9.vxl","gastank.vxl","gtgcanbarl.vxl","gtgcantur.vxl","gtnk.vxl","gtnkbarl.vxl","gtnktur.vxl","harv.vxl","harvtur.vxl","heli.vxl","hind.vxl","hmec.vxl","hornet.vxl","horv.vxl","htk.vxl","htkbarl.vxl","htktur.vxl","htnk.vxl","htnkbarl.vxl","htnktur.vxl","hvr.vxl","hvrtur.vxl","hwtz.vxl","hyd.vxl","icbm.vxl","jeep.vxl","jeeptur.vxl","laser.vxl","lcrf.vxl","limo.vxl","lpst.vxl","ltnk.vxl","ltnkbarl.vxl","ltnktur.vxl","m113.vxl","m113tur.vxl","mcv.vxl","misl.vxl","mislchem.vxl","mislmlti.vxl","mislorca.vxl","mislsam.vxl","mlrs.vxl","mlrstur.vxl","mmchbarl.vxl","mnly.vxl","monocar.vxl","monoeng.vxl","mrj.vxl","mrjtur.vxl","mtnk.vxl","mtnkbarl.vxl","mtnktur.vxl","mtrb.vxl","mtrs.vxl","mtrt.vxl","orca.vxl","orcab.vxl","orcatran.vxl","outp.vxl","pdplane.vxl","phal.vxl","pick.vxl","piece.vxl","probe.vxl","propa.vxl","ptruck.vxl","pulscan.vxl","repair.vxl","rtnk.vxl","rtnkbarl.vxl","rtnktur.vxl","sam.vxl","sapc.vxl","scrin.vxl","shad.vxl","smcv.vxl","sonic.vxl","sonictur.vxl","sref.vxl","sreftur.vxl","sreftur1.vxl","sreftur2.vxl","sreftur3.vxl","stang.vxl","stnk.vxl","sub.vxl","subt.vxl","subtank.vxl","suvb.vxl","suvw.vxl","taxi.vxl","tire.vxl","tnkd.vxl","tractor.vxl","tran.vxl","trnsport.vxl","trs.vxl","truck2.vxl","trucka.vxl","truckb.vxl","truk.vxl","ttnk.vxl","ttnktur.vxl","tug.vxl","utnk.vxl","v3.vxl","v3rocket.vxl","v3wo.vxl","vlad.vxl","vladwo.vxl","weed.vxl","wini.vxl","wrmn.vxl","zbomb.vxl","zep.vxl"],Q=class{constructor(S,O,B,N,j){this.builder=new D.VxlNonBatchedBuilder(S,O,B,N,j),this.wrapper=new THREE.Object3D}get3DObject(){return this.wrapper}create3DObject(){var S=this.builder.build();this.wrapper.add(S)}update(){this.wrapper.rotation.y-=.01}dispose(){this.builder.dispose()}},S("VxlTester",Z=class e{static async main(S,O){let N=this.renderer=new j.Renderer(800,600);N.init(document.body),N.initStats(document.body),this.vfs=S,this.vxlGeometryPool=new W.VxlGeometryPool(new z.VxlGeometryCache),this.palette=new B.Palette(S.openFile("unittem.pal"));let D=this.worldScene=L.WorldScene.factory({x:0,y:0,width:800,height:600},new V.BoxedVar(!0),new V.BoxedVar(K.ShadowQuality.High));this.disposables.add(D),D.scene.background=new THREE.Color(14737632),D.camera.far+=1e3,D.camera.updateProjectionMatrix();let U=new $.CanvasMetrics(N.getCanvas(),window);U.init(),this.disposables.add(U);var q=new _.PointerEvents(N,{x:0,y:0},document,U);let Q=new H.CameraZoomControls(q,D.cameraZoom);this.disposables.add(Q,q),Q.init(),this.createFloor(),this.buildBrowser(),N.addScene(D),(this.uiAnimationLoop=new F.UiAnimationLoop(N)).start()}static createFloor(){var S=new THREE.PlaneGeometry(1e4,1e4);let O=new THREE.ShadowMaterial;O.opacity=.5;let B=new THREE.Mesh(S,O);B.rotation.x=-Math.PI/2,B.position.y=-100,B.receiveShadow=!0,this.worldScene.scene.add(B)}static async selectVxl(S){e.currentVxl&&(e.worldScene.remove(e.currentVxl),e.currentVxl.dispose());var O=this.vfs.openFile(S),B=(new Date).getTime(),j=new N.VxlFile(O);O=(new Date).getTime(),console.log("Parsing took "+(O-B)+"ms"),j=this.currentVxl=new Q(j,void 0,this.palette,this.vxlGeometryPool,e.worldScene.camera),e.worldScene.add(j)}static buildBrowser(){let S=this.listEl=document.createElement("div");S.style.position="absolute",S.style.right="0",S.style.top="0",S.style.height="600px",S.style.width="200px",S.style.overflowY="auto",S.appendChild(document.createTextNode("Vxl files:")),q.forEach(O=>{let B=document.createElement("a");B.style.display="block",B.textContent=O,B.setAttribute("href","javascript:;"),B.addEventListener("click",()=>{console.log("Selected vxl",O),e.selectVxl(O)}),S.appendChild(B)}),document.body.appendChild(S),setTimeout(()=>{e.selectVxl("zep.vxl")},50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.disposables.dispose()}}),Z.disposables=new U.CompositeDisposable}}}),System.register("util/Base64",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("Base64",class{static encode(S){return void 0!==globalThis.btoa?globalThis.btoa(S):Buffer.from(S,"binary").toString("base64")}static decode(S){return void 0!==globalThis.atob?globalThis.atob(S):Buffer.from(S,"base64").toString("binary")}static isBase64(S){return!!S.match(/^([A-Za-z0-9+/]{4})*([A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{2}==)?$/)}})}}}),System.register("util/BoxedVar",["util/event"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("BoxedVar",class{constructor(S){this._onChange=new B.EventDispatcher,this.value=S}get value(){return this._value}set value(S){var O=S!==this._value;this._value=S,O&&this._onChange.dispatch(this,S)}get onChange(){return this._onChange.asEvent()}})}}}),System.register("util/Color",["util/string"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("Color",class e{static fromRgb(S,O,B){return new e(S,O,B)}static fromHsv(S,O,B){let N=0,j=0,L=0;if(S=S/255*360%360,B/=255,0==(O/=255))N=B,j=B,L=B;else{var D=S/60,F=Math.floor(D),_=B*(1-O),U=B*(1-O*(D-=F)),H=B*(1-O*(1-D));switch(F){case 0:N=B,j=H,L=_;break;case 1:N=U,j=B,L=_;break;case 2:N=_,j=B,L=H;break;case 3:N=_,j=U,L=B;break;case 4:N=H,j=_,L=B;break;case 5:N=B,j=_,L=U}}return e.fromRgb(Math.floor(255*N),Math.floor(255*j),Math.floor(255*L))}constructor(S,O,B){this.r=S,this.g=O,this.b=B}asHex(){return(this.r<<16)+(this.g<<8)+this.b}asHexString(){return"#"+B.pad(this.asHex().toString(16),"000000")}clone(){return new e(this.r,this.g,this.b)}})}}}),System.register("util/CssLoader",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("CssLoader",class{constructor(S){this.document=S}async load(S){return new Promise((O,B)=>{let N=document.createElement("link");N.rel="stylesheet",N.type="text/css",N.href=S,"onload"in N&&(N.onload=()=>O()),"onerror"in N&&(N.onerror=()=>B(new Error(`Couldn't load CSS at "${S}"`))),this.document.head.appendChild(N),"onload"in N||O()})}})}}}),System.register("util/Graph",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){S("Node",B=class{constructor(S,O){this.id=S,this.data=O,this.neighbors=new Set}addLink(S){this.neighbors.add(S),S!==this&&S.neighbors.add(this)}removeLink(S){this.neighbors.delete(S),S.neighbors.delete(this)}deleteLinks(){for(var S of this.neighbors)S.neighbors.delete(this);this.neighbors.clear()}}),S("Graph",class{constructor(){this.nodes=new Map}addNode(S,O){let N=this.getNode(S);return N?N.data=O:N=new B(S,O),this.nodes.set(S,N),N}removeNode(S){let O=this.getNode(S);return!!O&&(O.deleteLinks(),this.nodes.delete(S),!0)}hasNode(S){return this.nodes.has(S)}getNode(S){return this.nodes.get(S)}getNodeCount(){return this.nodes.size}forEachNode(S){for(var O of this.nodes.values())S(O)}clear(){for(var S of this.nodes.values())S.deleteLinks();this.nodes.clear()}})}}}),System.register("util/Logger",["js-logger"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("AppLogger",B)}}}),System.register("util/PointerLock",["util/event","util/disposable/CompositeDisposable"],function(S,O){"use strict";var B,N;return O&&O.id,{setters:[function(S){B=S},function(S){N=S}],execute:function(){S("PointerLock",class{get onChange(){return this._onChange.asEvent()}constructor(S,O){this.element=S,this.document=O,this._onChange=new B.EventDispatcher,this.disposables=new N.CompositeDisposable,this.listening=!1}async request(S){if(S?.unadjustedMovement)try{await this.requestInternal({unadjustedMovement:!0})}catch(S){if("NotSupportedError"!==S.name)throw S;await this.requestInternal()}else await this.requestInternal()}async requestInternal(S){if(!this.isActive()){if(!this.listening){this.listening=!0;const e=()=>{this._onChange.dispatch(this,this.isActive())};this.document.addEventListener("pointerlockchange",e,!1),this.disposables.add(()=>this.document.removeEventListener("pointerlockchange",e,!1));let t=()=>{this.exit().catch(S=>console.error(S))};this.document.addEventListener("touchstart",t,!1),this.disposables.add(()=>this.document.removeEventListener("touchstart",t,!1))}return new Promise((O,B)=>{const r=()=>{this.document.removeEventListener("pointerlockchange",r,!1),this.document.removeEventListener("pointerlockerror",s,!1),O()},s=S=>{this.document.removeEventListener("pointerlockchange",r,!1),this.document.removeEventListener("pointerlockerror",s,!1),console.error(S),B(new Error("Pointer lock error"))};this.document.addEventListener("pointerlockerror",s,!1),this.document.addEventListener("pointerlockchange",r,!1),this.element.requestPointerLock(S)?.catch?.(B)})}}async exit(){if(this.isActive())return new Promise((S,O)=>{const i=()=>{this.document.removeEventListener("pointerlockchange",i,!1),this.document.removeEventListener("pointerlockerror",r,!1),S()},r=S=>{this.document.removeEventListener("pointerlockchange",i,!1),this.document.removeEventListener("pointerlockerror",r,!1),console.error(S),O(new Error("Pointer lock error"))};this.document.addEventListener("pointerlockerror",r,!1),this.document.addEventListener("pointerlockchange",i,!1),this.document.exitPointerLock()})}isActive(){return this.element===this.document.pointerLockElement}dispose(){this.disposables.dispose()}})}}}),System.register("util/QuadTree",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=new THREE.Vector2,S("QuadTree",class e{constructor(S,O){this.box=S,this.config=O,this.parentMap=new Map,this.objects=[]}add(S,O=!0){var B=this.config.getKey(S);if(this.box.containsPoint(B)){if(!this.regions)return this.parentMap.get(S)?.remove(S),this.parentMap.set(S,this),this.objects.push({key:B,value:S}),O&&this.update(),!0;for(var N of this.regions)if(N.add(S,O))return!0}return!1}remove(S,O=!0){let B=this.parentMap.get(S);B&&(B===this?(this.parentMap.delete(S),this.objects.splice(this.objects.findIndex(O=>O.value===S),1),O&&this.parent?.update()):B.remove(S,O))}updateObject(S){let O=this.parentMap.get(S);if(O){var B=this.config.getKey(S);if(O.box.containsPoint(B))O.objects.find(O=>O.value===S).key=B;else{O.remove(S,!1);let B=O.parent;for(;B&&!B.add(S,!1);)B=B.parent}}}queryRange(S,O=[]){if(this.box.intersectsBox(S))if(this.regions)for(var B of this.regions)B.queryRange(S,O);else for(var N of this.objects)S.containsPoint(N.key)&&O.push(N.value);return O}update(){let S=0;if(this.regions){for(var O of this.regions)S+=O.update();S<=this.config.joinThreshold&&this.join()}else S=this.objects.length,S>=this.config.splitThreshold&&this.split()&&this.update();return S}split(){if(this.regions||this.config.maxDepth<=1)return!1;var S,O,B={getKey:this.config.getKey,joinThreshold:this.config.joinThreshold,splitThreshold:this.config.splitThreshold,maxDepth:this.config.maxDepth-1},N=this.generateRegions(),j=this.objects;for(S of(this.objects=[],this.regions=[],N)){let O=new e(S,B);O.parentMap=this.parentMap,this.regions.push(O),O.parent=this}for(O of j)this.parentMap.delete(O.value),this.add(O.value,!1);return!0}join(){if(!this.regions)return!1;for(var S of this.regions)for(var O of(S.join(),S.parent=void 0,S.objects))this.objects.push(O),this.parentMap.set(O.value,this);return!(this.regions=void 0)}generateRegions(){let S=[this.box.clone()];var O=this.box.getCenter(B);let N=S[0],j=N.clone();N.max.x=O.x,j.min.x=O.x,S.push(j);for(let B=0,L=S.length;B<L;B++)N=S[B],j=N.clone(),N.max.y=O.y,j.min.y=O.y,S.push(j);return S}})}}}),System.register("util/Routing",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("Routing",class{constructor(){this.routes={}}addRoute(S,O){this.routes[S]={controller:O}}init(){window.addEventListener("hashchange",()=>this.router()),this.router()}async router(){let S=location.hash.slice(1)||"/";if(S.match(/^\//)){var[,O,...B]=S.split("/");this.routes["*"]&&await this.routes["*"].controller(B);let N=this.routes["/"+O];N.controller&&await N.controller(B)}}})}}}),System.register("util/ScriptLoader",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("ScriptLoader",class{constructor(S){this.document=S}load(S,O={}){return new Promise((B,N)=>{let j=this.document.head,L=this.document.createElement("script");L.type=O.type||"text/javascript",L.charset=O.charset||"utf8",L.async=void 0===O.async||O.async,L.src=S;const D=O.attrs;D&&Object.keys(D).forEach(S=>L.setAttribute(S,D[S])),O.text&&(L.text=O.text),L.onload=()=>{B()};let F=new Error(`Failed to load script "${S}"`);L.onerror=()=>{N(F)},j.appendChild(L)})}})}}}),System.register("util/Sentry",["util/ScriptLoader"],function(S,O){"use strict";var B;return O&&O.id,{setters:[function(S){B=S}],execute:function(){S("Sentry",class{async init(S,O){await new B.ScriptLoader(document).load(`https://js.sentry-cdn.com/${S.dsn}.min.js`);let N=this.sdk=window.Sentry,j=new Date;N.init({environment:S.env,release:O,denyUrls:[/^file:/],ignoreErrors:[/init message from worker/,/The object can not be found here/,/itemsclipboard/,/A requested file or directory could not be found/,/The requested file could not be read/,/The play\(\) request/,/^db$/],initialScope:S=>S.setTags({locale:navigator.language}).setExtra("initTime",j),...S.defaultIntegrations?{}:{defaultIntegrations:!1}}),N.onLoad(()=>{this.sdk=window.Sentry}),S.lazyLoad||N.forceLoad()}captureException(S,O){this.sdk?.captureException(S,O)}configureScope(S){this.sdk?.configureScope(S)}addBreadcrumb(S){this.sdk?.addBreadcrumb(S)}})}}}),System.register("util/Serializable",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("util/array",[],function(S,O){"use strict";return O&&O.id,S("findReverse",function(S,O){for(let B=S.length-1;0<=B;B--)if(O(S[B],B,S))return S[B]}),S("findIndexReverse",function(S,O){for(let B=S.length-1;0<=B;B--)if(O(S[B],B,S))return B;return-1}),S("equals",function(S,O){if(S.length!==O.length)return!1;for(let B=0,N=S.length;B<N;B++)if(S[B]!==O[B])return!1;return!0}),{setters:[],execute:function(){}}}),System.register("util/bresenham",[],function(S,O){"use strict";return O&&O.id,S("bresenham",function(S,O,B,N,j){let L=[];j=j||((S,O)=>{L.push({x:S,y:O})});var D=B-S,F=N-O,_=Math.abs(D),U=Math.abs(F);let H=0;var V=0<D?1:-1,W=0<F?1:-1;if(U<_)for(let N=S,L=O;V<0?N>=B:N<=B;N+=V)j(N,L),H+=U,H<<1>=_&&(L+=W,H-=_);else for(let B=S,L=O;W<0?L>=N:L<=N;L+=W)j(B,L),H+=_,H<<1>=U&&(B+=V,H-=U);return L}),{setters:[],execute:function(){}}}),System.register("util/disposable/CompositeDisposable",[],function(S,O){"use strict";var B;return O&&O.id,{setters:[],execute:function(){B=S=>!S.dispose,S("CompositeDisposable",class{constructor(){this.disposables=new Set}add(...S){S.map(S=>this.disposables.add("function"==typeof S?{dispose:S}:S))}remove(...S){S.map(S=>this.disposables.delete(S))}dispose(){this.disposables.forEach(S=>{"function"==typeof S?S():B(S)?S.destroy():S.dispose()}),this.disposables.clear()}})}}}),System.register("util/disposable/Disposable",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("util/disposable/LegacyDisposable",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("util/dom",[],function(S,O){"use strict";return O&&O.id,S("getOffset",function(S){let O=0,B=0;for(;O+=S.offsetTop||0,B+=S.offsetLeft||0,S=S.offsetParent;);return{top:O,left:B}}),S("contains",function(S,O){do{if(O===S)return!0}while(O=O.parentElement);return!1}),{setters:[],execute:function(){}}}),System.register("util/event",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("EventDispatcher",class{constructor(){this.listeners=new Set}subscribe(S){this.listeners.add(S)}subscribeOnce(S){let t=(O,B)=>{S(O,B),this.unsubscribe(t),t=void 0};this.subscribe(t)}unsubscribe(S){this.listeners.delete(S)}dispatch(S,O){this.listeners.forEach(B=>B(O,S))}asEvent(){return this}})}}}),System.register("util/format",["util/string"],function(S,O){"use strict";var B;return O&&O.id,S("formatTimeDuration",function(S,O=!1){var N=Math.floor(S/3600);S-=3600*N;var j=Math.floor(S/60),L=S-=60*j;return[...N||!O?[N]:[],B.pad(j,"00"),B.pad(L,"00")].join(":")}),{setters:[function(S){B=S}],execute:function(){}}}),System.register("util/fullScreen",[],function(S,O){"use strict";return O&&O.id,S("setupFullScreenChangeListener",function(S,O){if(S.fullscreenEnabled){let B=!0;const r=()=>{var N=!!S.fullscreenElement;N?B=!1:setTimeout(()=>B=!0,100),O(N)},s=async O=>{if(122===O.keyCode&&B&&!S.fullscreenElement)try{await S.documentElement.requestFullscreen();try{await(screen?.orientation?.lock?.("landscape"))}catch(S){console.warn("Orientation lock failed",S)}}catch{console.warn("Full screen permission denied by user.")}};return S.addEventListener("fullscreenchange",r),S.addEventListener("keyup",s),()=>{S.removeEventListener("fullscreenchange",r),S.removeEventListener("keyup",s)}}console.warn("Browser fullscreen API not available.")}),{setters:[],execute:function(){}}}),System.register("util/geometry",["util/math"],function(S,O){"use strict";var B;return O&&O.id,S("pointEquals",function(S,O){return S&&O&&S.x===O.x&&S.y===O.y||!S&&!O}),S("rectIntersect",function(S,O){return S.x<=O.x+O.width&&O.x<=S.x+S.width&&S.y<=O.y+O.height&&O.y<=S.y+S.height}),S("rectEquals",function(S,O){return S.x===O.x&&S.y===O.y&&S.width===O.width&&S.height===O.height}),S("circleIntersect",function(S,O){var N=S.center,j=O.center;return B.isBetween((N.x-j.x)*(N.x-j.x)+(N.y-j.y)*(N.y-j.y),(S.radius-O.radius)*(S.radius-O.radius),(S.radius+O.radius)*(S.radius+O.radius))}),S("circleContainsPoint",function(S,O){var B=S.center;return(B.x-O.x)*(B.x-O.x)+(B.y-O.y)*(B.y-O.y)<=S.radius*S.radius}),S("rectContainsPoint",function(S,O){return new THREE.Box2(new THREE.Vector2(S.x,S.y),new THREE.Vector2(S.x+S.width,S.y+S.height)).containsPoint(new THREE.Vector2(O.x,O.y))}),S("rectContainsRect",function(S,O){let B=new THREE.Box2(new THREE.Vector2(S.x,S.y),new THREE.Vector2(S.x+S.width,S.y+S.height));var N=new THREE.Box2(new THREE.Vector2(O.x,O.y),new THREE.Vector2(O.x+O.width,O.y+O.height));return B.containsBox(N)}),S("rectClampPoint",function(S,O){return new THREE.Box2(new THREE.Vector2(S.x,S.y),new THREE.Vector2(S.x+S.width,S.y+S.height)).clampPoint(new THREE.Vector2(O.x,O.y),new THREE.Vector2)}),S("octileDistance",function(S,O){var B=Math.abs(S.x-O.x),N=Math.abs(S.y-O.y);return B+N+(Math.SQRT2-2)*Math.min(B,N)}),{setters:[function(S){B=S}],execute:function(){}}}),System.register("util/keyNames",[],function(S,O){"use strict";var B;return O&&O.id,S("getKeyName",function(S){var O=B.get(S);return void 0!==O?O:String.fromCharCode(S)}),{setters:[],execute:function(){B=new Map([[8,"Backspace"],[9,"Tab"],[12,"Clear"],[13,"Enter"],[19,"Pause/Break"],[20,"CapsLock"],[27,"Esc"],[32,"Space"],[33,"PageUp"],[34,"PageDown"],[35,"End"],[36,"Home"],[37,"ArrowLeft"],[38,"ArrowUp"],[39,"ArrowRight"],[40,"ArrowDown"],[44,"PrintScreen"],[45,"Insert"],[46,"Delete"],[91,"LeftWin/"],[92,"RightWin/"],...new Array(10).fill(0).map((S,O)=>[96+O,"Num"+O]),[106,"Num*"],[107,"Num+"],[109,"Num-"],[110,"NumDel"],[111,"Num/"],...new Array(32).fill(0).map((S,O)=>[111+O+1,"F"+(O+1)]),[144,"NumLock"],[145,"ScrollLock"],[186,";"],[187,"="],[188,","],[189,"-"],[190,"."],[191,"/"],[192,"`"],[219,"["],[220,"\\"],[221,"]"],[222,"'"]])}}}),System.register("util/math",[],function(S,O){"use strict";return O&&O.id,S("getRandomInt",function(S,O){return Math.floor(Math.random()*(O+1-S))+S}),S("clamp",function(S,O,B){return Math.min(B,Math.max(S,O))}),S("isBetween",function(S,O,B){return O<=S&&S<=B}),S("lerp",function(S,O,B){return(1-B)*S+B*O}),S("truncToDecimals",function(S,O){if(!S)return S;var B=10**O;return 0<=S?Math.floor(S*B)/B:Math.ceil(S*B)/B}),S("roundToDecimals",function(S,O){if(!S)return S;var B=10**O;return Math.round(S*B)/B}),S("floorTo",function(S,O){return Math.floor(S/O)*O}),S("fnv32a",function(S){let O=2166136261;for(let B=0,N=S.length;B<N;++B)O^=S[B],O+=(O<<1)+(O<<4)+(O<<7)+(O<<8)+(O<<24);return O>>>0}),{setters:[],execute:function(){}}}),System.register("util/mouse",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}}),System.register("util/number",[],function(S,O){"use strict";return O&&O.id,S("int32ToFloat32",function(S){let O=new DataView(new ArrayBuffer(4));return O.setInt32(0,S),O.getFloat32(0)}),{setters:[],execute:function(){}}}),System.register("util/stream",[],function(S,O){"use strict";return O&&O.id,S("makeTextFileLineIterator",async function*(S){const O=new TextDecoder("utf-8");let B=S.stream().getReader(),{value:N,done:j}=await B.read();N=N?O.decode(N,{stream:!0}):"";let L=/\r\n|\n|\r/gm,D=0;for(;;){var F=L.exec(N);if(F)yield N.substring(D,F.index),D=L.lastIndex;else{if(j)break;F=N.substr(D),({value:N,done:j}=await B.read()),N=F+(N?O.decode(N,{stream:!0}):""),D=L.lastIndex=0}}D<N.length&&(yield N.substr(D))}),{setters:[],execute:function(){}}}),System.register("util/string",["util/Base64"],function(S,O){"use strict";var B;function r(S){var O=S.length;let B=new Uint8Array(O);for(let N=0;N<O;N++)B[N]=S.charCodeAt(N);return B}function s(S){return S.reduce((S,O)=>S+String.fromCharCode(O),"")}return O&&O.id,S("pad",function(S,O="0000"){var B=""+S;return O.substring(0,O.length-B.length)+B}),S("equalsIgnoreCase",function(S,O){return S.toLowerCase()===O.toLowerCase()}),S("binaryStringToUint8Array",r),S("base64StringToUint8Array",function(S){return r(B.Base64.decode(S))}),S("uint8ArrayToBase64String",function(S){return B.Base64.encode(s(S))}),S("uint8ArrayToBinaryString",s),S("utf16ToBinaryString",function(S){var O=S.length;let B="";for(let j=0;j<O;j++){var N=S.charCodeAt(j);B+=String.fromCharCode(N>>8),B+=String.fromCharCode(255&N)}return B}),S("binaryStringToUtf16",function(S){var O=S.length;let B="";for(let j=0;j<O;j+=2){var N=(S.charCodeAt(j)<<8)+S.charCodeAt(j+1);B+=String.fromCharCode(N)}return B}),S("bufferToHexString",function(S){const O=[],B=new DataView(S);for(let S=0;S<B.byteLength;S+=4){var N=((N="00000000")+B.getUint32(S).toString(16)).slice(-N.length);O.push(N)}return O.join("")}),{setters:[function(S){B=S}],execute:function(){}}}),System.register("util/time",[],function(S,O){"use strict";async function i(S){return new Promise(O=>{setTimeout(()=>O(),S)})}function r(S,O){let B=!1,N=Number.NEGATIVE_INFINITY;return async function(...j){var L,D;B||(D=(L=Date.now())-N,N=O<=D?L:(B=!0,await i(O-D),B=!1,Date.now()),await S.apply(this,j))}}return O&&O.id,S("sleep",i),S("throttle",r),S("Throttle",function(S){return(O,B,N)=>{var j=N.value;N.value=r(j,S)}}),{setters:[],execute:function(){}}}),System.register("util/typeGuard",[],function(S,O){"use strict";return O&&O.id,S("isNotNullOrUndefined",function(S){return null!=S}),{setters:[],execute:function(){}}}),System.register("util/userAgent",[],function(S,O){"use strict";function i(){return navigator.platform.includes("Mac")}return O&&O.id,S("isIpad",function(){return/iPad/i.test(navigator.userAgent)||/MacIntel/i.test(navigator.platform)&&!!navigator.maxTouchPoints}),S("isMac",i),S("isMacFirefox",function(){return i()&&-1!==navigator.userAgent.toLowerCase().indexOf("firefox")}),{setters:[],execute:function(){}}}),System.register("version",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){S("version","0.78.0-prvt.6")}}}),System.register("worker/WorkerApi",[],function(S,O){"use strict";return O&&O.id,{setters:[],execute:function(){}}});