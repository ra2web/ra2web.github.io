/*! For license information please see spbots.min.js.LICENSE.txt */
define("SPBots",["@chronodivide/game-api","three"],(t,e)=>(()=>{var i={25:(t,e)=>{
/**
 * @license MIT
 * @copyright 2020 Eyas Ranjous <eyas.ranjous@gmail.com>
 *
 * @class
 */
class i{constructor(t,e,i){if("function"!=typeof t)throw new Error("Heap constructor expects a compare function");this._compare=t,this._nodes=Array.isArray(e)?e:[],this._leaf=i||null}toArray(){return Array.from(this._nodes)}_hasLeftChild(t){return 2*t+1<this.size()}_hasRightChild(t){return 2*t+2<this.size()}_compareAt(t,e){return this._compare(this._nodes[t],this._nodes[e])}_swap(t,e){const i=this._nodes[t];this._nodes[t]=this._nodes[e],this._nodes[e]=i}_shouldSwap(t,e){return!(t<0||t>=this.size())&&(!(e<0||e>=this.size())&&this._compareAt(t,e)>0)}_compareChildrenOf(t){if(!this._hasLeftChild(t)&&!this._hasRightChild(t))return-1;const e=2*t+1,i=2*t+2;if(!this._hasLeftChild(t))return i;if(!this._hasRightChild(t))return e;return this._compareAt(e,i)>0?i:e}_compareChildrenBefore(t,e,i){return this._compareAt(i,e)<=0&&i<t?i:e}_heapifyUp(t){let e=t,i=Math.floor((e-1)/2);for(;this._shouldSwap(i,e);)this._swap(i,e),e=i,i=Math.floor((e-1)/2)}_heapifyDown(t){let e=t,i=this._compareChildrenOf(e);for(;this._shouldSwap(e,i);)this._swap(e,i),e=i,i=this._compareChildrenOf(e)}_heapifyDownUntil(t){let e,i=0,s=1,r=2;for(;s<t;)e=this._compareChildrenBefore(t,s,r),this._shouldSwap(i,e)&&this._swap(i,e),i=e,s=2*i+1,r=2*i+2}insert(t){return this._nodes.push(t),this._heapifyUp(this.size()-1),(null===this._leaf||this._compare(t,this._leaf)>0)&&(this._leaf=t),this}push(t){return this.insert(t)}extractRoot(){if(this.isEmpty())return null;const t=this.root();return this._nodes[0]=this._nodes[this.size()-1],this._nodes.pop(),this._heapifyDown(0),t===this._leaf&&(this._leaf=this.root()),t}pop(){return this.extractRoot()}sort(){for(let t=this.size()-1;t>0;t-=1)this._swap(0,t),this._heapifyDownUntil(t);return this._nodes}fix(){for(let t=Math.floor(this.size()/2)-1;t>=0;t-=1)this._heapifyDown(t);for(let t=Math.floor(this.size()/2);t<this.size();t+=1){const e=this._nodes[t];(null===this._leaf||this._compare(e,this._leaf)>0)&&(this._leaf=e)}return this}isValid(){const t=e=>{let i=!0,s=!0;if(this._hasLeftChild(e)){const s=2*e+1;if(this._compareAt(e,s)>0)return!1;i=t(s)}if(this._hasRightChild(e)){const i=2*e+2;if(this._compareAt(e,i)>0)return!1;s=t(i)}return i&&s};return t(0)}clone(){return new i(this._compare,this._nodes.slice(),this._leaf)}root(){return this.isEmpty()?null:this._nodes[0]}top(){return this.root()}leaf(){return this._leaf}size(){return this._nodes.length}isEmpty(){return 0===this.size()}clear(){this._nodes=[],this._leaf=null}[Symbol.iterator](){let t=this.size();return{next:()=>(t-=1,{value:this.pop(),done:-1===t})}}static heapify(t,e){if(!Array.isArray(t))throw new Error("Heap.heapify expects an array of values");if("function"!=typeof e)throw new Error("Heap.heapify expects a compare function");return new i(e,t).fix()}static isHeapified(t,e){return new i(e,t).isValid()}}e.Heap=i},350:(t,e,i)=>{
/**
 * @copyright 2020 Eyas Ranjous <eyas.ranjous@gmail.com>
 * @license MIT
 */
const{Heap:s,MaxHeap:r}=i(690);class n{constructor(t,e){if(t&&"function"!=typeof t)throw new Error("MaxPriorityQueue constructor requires a callback for object values");this._heap=e||new r(t)}front(){return this._heap.root()}back(){return this._heap.leaf()}enqueue(t){return this._heap.insert(t)}push(t){return this.enqueue(t)}dequeue(){return this._heap.extractRoot()}pop(){return this.dequeue()}remove(t){if("function"!=typeof t)throw new Error("MaxPriorityQueue remove expects a callback");const e=[],i=[];for(;!this.isEmpty();){const s=this.pop();t(s)?e.push(s):i.push(s)}return i.forEach(t=>this.push(t)),e}size(){return this._heap.size()}isEmpty(){return this._heap.isEmpty()}clear(){this._heap.clear()}toArray(){return this._heap.clone().sort().reverse()}[Symbol.iterator](){let t=this.size();return{next:()=>(t-=1,{value:this.pop(),done:-1===t})}}static fromArray(t,e){const i=new s((t=>(e,i)=>("function"==typeof t?t(e):e)<("function"==typeof t?t(i):i)?1:-1)(e),t);return new n(e,new r(e,i).fix())}}e.MaxPriorityQueue=n},564:(t,e,i)=>{
/**
 * @copyright 2020 Eyas Ranjous <eyas.ranjous@gmail.com>
 * @license MIT
 */
const{Heap:s}=i(690);class r{constructor(t,e){if("function"!=typeof t)throw new Error("PriorityQueue constructor expects a compare function");this._heap=new s(t,e),e&&this._heap.fix()}front(){return this._heap.root()}back(){return this._heap.leaf()}enqueue(t){return this._heap.insert(t)}push(t){return this.enqueue(t)}dequeue(){return this._heap.extractRoot()}pop(){return this.dequeue()}remove(t){if("function"!=typeof t)throw new Error("PriorityQueue remove expects a callback");const e=[],i=[];for(;!this.isEmpty();){const s=this.pop();t(s)?e.push(s):i.push(s)}return i.forEach(t=>this.push(t)),e}size(){return this._heap.size()}isEmpty(){return this._heap.isEmpty()}clear(){this._heap.clear()}toArray(){return this._heap.clone().sort().reverse()}[Symbol.iterator](){let t=this.size();return{next:()=>(t-=1,{value:this.pop(),done:-1===t})}}static fromArray(t,e){return new r(e,t)}}e.PriorityQueue=r},690:(t,e,i)=>{const{Heap:s}=i(25),{MinHeap:r}=i(805),{MaxHeap:n}=i(971);e.Heap=s,e.MinHeap=r,e.MaxHeap=n},712:e=>{"use strict";e.exports=t},738:(t,e,i)=>{const{MinPriorityQueue:s}=i(808),{MaxPriorityQueue:r}=i(350),{PriorityQueue:n}=i(564);t.exports={MinPriorityQueue:s,MaxPriorityQueue:r,PriorityQueue:n}},752:t=>{"use strict";t.exports=e},805:(t,e,i)=>{
/**
 * @license MIT
 * @copyright 2020 Eyas Ranjous <eyas.ranjous@gmail.com>
 */
const{Heap:s}=i(25),r=t=>(e,i)=>("function"==typeof t?t(e):e)<("function"==typeof t?t(i):i)?-1:1;class n{constructor(t,e){this._getCompareValue=t,this._heap=e||new s(r(t))}toArray(){return Array.from(this._heap._nodes)}insert(t){return this._heap.insert(t)}push(t){return this.insert(t)}extractRoot(){return this._heap.extractRoot()}pop(){return this.extractRoot()}sort(){return this._heap.sort()}fix(){return this._heap.fix()}isValid(){return this._heap.isValid()}root(){return this._heap.root()}top(){return this.root()}leaf(){return this._heap.leaf()}size(){return this._heap.size()}isEmpty(){return this._heap.isEmpty()}clear(){this._heap.clear()}clone(){return new n(this._getCompareValue,this._heap.clone())}[Symbol.iterator](){let t=this.size();return{next:()=>(t-=1,{value:this.pop(),done:-1===t})}}static heapify(t,e){if(!Array.isArray(t))throw new Error("MinHeap.heapify expects an array");const i=new s(r(e),t);return new n(e,i).fix()}static isHeapified(t,e){const i=new s(r(e),t);return new n(e,i).isValid()}}e.MinHeap=n},808:(t,e,i)=>{
/**
 * @copyright 2020 Eyas Ranjous <eyas.ranjous@gmail.com>
 * @license MIT
 */
const{Heap:s,MinHeap:r}=i(690);class n{constructor(t,e){if(t&&"function"!=typeof t)throw new Error("MinPriorityQueue constructor requires a callback for object values");this._heap=e||new r(t)}front(){return this._heap.root()}back(){return this._heap.leaf()}enqueue(t){return this._heap.insert(t)}push(t){return this.enqueue(t)}dequeue(){return this._heap.extractRoot()}pop(){return this.dequeue()}remove(t){if("function"!=typeof t)throw new Error("MinPriorityQueue remove expects a callback");const e=[],i=[];for(;!this.isEmpty();){const s=this.pop();t(s)?e.push(s):i.push(s)}return i.forEach(t=>this.push(t)),e}size(){return this._heap.size()}isEmpty(){return this._heap.isEmpty()}clear(){this._heap.clear()}toArray(){return this._heap.clone().sort().reverse()}[Symbol.iterator](){let t=this.size();return{next:()=>(t-=1,{value:this.pop(),done:-1===t})}}static fromArray(t,e){const i=new s((t=>(e,i)=>("function"==typeof t?t(e):e)<("function"==typeof t?t(i):i)?-1:1)(e),t);return new n(e,new r(e,i).fix())}}e.MinPriorityQueue=n},971:(t,e,i)=>{
/**
 * @license MIT
 * @copyright 2020 Eyas Ranjous <eyas.ranjous@gmail.com>
 */
const{Heap:s}=i(25),r=t=>(e,i)=>("function"==typeof t?t(e):e)<("function"==typeof t?t(i):i)?1:-1;class n{constructor(t,e){this._getCompareValue=t,this._heap=e||new s(r(t))}insert(t){return this._heap.insert(t)}push(t){return this.insert(t)}extractRoot(){return this._heap.extractRoot()}pop(){return this.extractRoot()}sort(){return this._heap.sort()}toArray(){return Array.from(this._heap._nodes)}fix(){return this._heap.fix()}isValid(){return this._heap.isValid()}root(){return this._heap.root()}top(){return this.root()}leaf(){return this._heap.leaf()}size(){return this._heap.size()}isEmpty(){return this._heap.isEmpty()}clear(){this._heap.clear()}clone(){return new n(this._getCompareValue,this._heap.clone())}[Symbol.iterator](){let t=this.size();return{next:()=>(t-=1,{value:this.pop(),done:-1===t})}}static heapify(t,e){if(!Array.isArray(t))throw new Error("MaxHeap.heapify expects an array");const i=new s(r(e),t);return new n(e,i).fix()}static isHeapified(t,e){const i=new s(r(e),t);return new n(e,i).isValid()}}e.MaxHeap=n}},s={};function r(t){var e=s[t];if(void 0!==e)return e.exports;var n=s[t]={exports:{}};return i[t](n,n.exports,r),n.exports}r.d=(t,e)=>{for(var i in e)r.o(e,i)&&!r.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n={};return(()=>{"use strict";r.r(n),r.d(n,{SupalosaBot:()=>te,version:()=>ee});var t=r(712);function e(t){return t.getRealMapSize()}function i(t,e,i,s){let r=0,n=0;for(let a=i.x;a<s.x;++a)for(let o=i.y;o<s.y;++o){let i=t.getTile(a,o);i&&(++r,t.isVisibleTile(i,e.name)&&++n)}return{visibleTiles:n,validTiles:r}}function s(e,i,s,r,n,a){let o=r+Math.round(e.generateRandom()*(n-r)),h=t.GameMath.atan2(s.y-i.y,s.x-i.x)-(a*(Math.PI/12)+2*a*e.generateRandom()*(Math.PI/12)),u=Math.round(i.x+t.GameMath.cos(h)*o),c=Math.round(i.y+t.GameMath.sin(h)*o);return new t.Vector2(u,c)}function a(t,e){return t.distanceTo(e)}function o(e,i){return new t.Vector2(e.rx,e.ry).distanceTo(i)}class h{constructor(t,e,i,s){this.sectorStartPoint=t,this.sectorStartTile=e,this.sectorVisibilityPct=i,this.sectorVisibilityLastCheckTick=s,this.sectorExploreAttempts=0}onExploreAttempted(t){this.sectorExploreAttempts++,this.sectorLastExploredAt=t}shouldAttemptExploration(t,e,i){return!(i>=this.sectorExploreAttempts)&&!(this.sectorLastExploredAt&&t<this.sectorLastExploredAt+e)}}class u{constructor(e,i){this.sectors=[],this.mapBounds=i,this.sectorsX=Math.ceil(i.width/8),this.sectorsY=Math.ceil(i.height/8),this.sectors=new Array(this.sectorsX);for(let i=0;i<this.sectorsX;++i){this.sectors[i]=new Array(this.sectorsY);for(let s=0;s<this.sectorsY;++s){const r=8*i,n=8*s;this.sectors[i][s]=new h(new t.Vector2(r,n),e.getTile(r,n),void 0,void 0)}}}getMapBounds(){return this.mapBounds}updateSectors(e,s,r,n){let a=this.lastUpdatedSectorX?this.lastUpdatedSectorX+1:0,o=this.lastUpdatedSectorY?this.lastUpdatedSectorY:0,h=0;for(;h<s;){a>=this.sectorsX&&(a=0,++o),o>=this.sectorsY&&(o=0,a=0);let s=this.getSector(a,o);if(s){s.sectorVisibilityLastCheckTick=e;let a=s.sectorStartPoint,o=i(r,n,a,new t.Vector2(a.x+8,a.y+8));o.validTiles>0?s.sectorVisibilityPct=o.visibleTiles/o.validTiles:s.sectorVisibilityPct=void 0}this.lastUpdatedSectorX=a,this.lastUpdatedSectorY=o,++a,++h}}getSectorUpdateRatio(t){let e=0,i=0;for(let s=0;s<this.sectorsX;++s)for(let r=0;r<this.sectorsY;++r){let n=this.sectors[s][r];n&&n.sectorVisibilityLastCheckTick&&n.sectorVisibilityLastCheckTick>=t&&++e,++i}return e/i}getOverallVisibility(){let t=0,e=0;for(let i=0;i<this.sectorsX;++i)for(let s=0;s<this.sectorsY;++s){let r=this.sectors[i][s];null!=r.sectorVisibilityPct&&(t+=r.sectorVisibilityPct,e+=1)}return t/e}getSector(t,e){if(!(t<0||t>=this.sectorsX||e<0||e>=this.sectorsY))return this.sectors[t][e]}getSectorBounds(){return{width:this.sectorsX,height:this.sectorsY}}getSectorCoordinatesForWorldPosition(t,e){if(!(t<0||t>=this.mapBounds.width||e<0||e>=this.mapBounds.height))return{sectorX:Math.floor(t/8),sectorY:Math.floor(e/8)}}getSectorForWorldPosition(t,e){if(this.getSectorCoordinatesForWorldPosition(t,e))return this.sectors[Math.floor(t/8)][Math.floor(e/8)]}}const c=new WeakMap,l=(t,e)=>{const i=t.getGameObjectData(e);if(!i)return null;const{rulesApi:s}=t,{name:r}=i;let n=c.get(t);if(n||(n={},c.set(t,n)),n[r])return n[r];const a=s.aircraftRules.get(r);if(a)return n[r]=a,a;const o=s.buildingRules.get(r);if(o)return n[r]=o,o;const h=s.infantryRules.get(r);if(h)return n[r]=h,h;const u=s.vehicleRules.get(r);return u?(n[r]=u,u):(n[r]=null,null)};class g{constructor(t,e){this.uniqueName=t,this.logger=e,this.active=!0,this.unitIds=[],this.centerOfMass=null,this.maxDistanceToCenterOfMass=null,this.onFinish=()=>{}}updateCenterOfMass(e){const i=(e=>{if(0===e.length)return null;const i=e.reduce(({x:t,y:e},i)=>({x:t+(i?.rx||0),y:e+(i?.ry||0)}),{x:0,y:0}),s=new t.Vector2(Math.round(i.x/e.length),Math.round(i.y/e.length)),r=e.map(t=>o(t,s)),n=Math.max(...r);return{centerOfMass:s,maxDistance:n}})(this.unitIds.map(t=>e.getGameObjectData(t)).map(t=>t?.tile).filter(t=>!!t));i?(this.centerOfMass=i.centerOfMass,this.maxDistanceToCenterOfMass=i.maxDistance):(this.centerOfMass=null,this.maxDistanceToCenterOfMass=null)}onAiUpdate(t,e,i,s,r,n){return this.updateCenterOfMass(t),this._onAiUpdate(t,e,i,s,r,n)}isActive(){return this.active}getUnitIds(){return this.unitIds}removeUnit(t){this.unitIds=this.unitIds.filter(e=>e!=t)}addUnit(t){this.unitIds.push(t)}getUnits(t){return this.unitIds.map(e=>t.getUnitData(e)).filter(t=>null!=t).map(t=>t)}getUnitsGameObjectData(t){return this.unitIds.map(e=>t.getGameObjectData(e)).filter(t=>null!=t).map(t=>t)}getUnitsOfTypes(t,...e){return this.unitIds.map(e=>t.getUnitData(e)).filter(t=>!!t&&e.includes(t.name)).map(t=>t)}getUnitsMatchingByRule(t,e){return this.unitIds.map(e=>({unitId:e,rules:l(t,e)})).filter(t=>null!==t.rules).filter(({rules:t})=>e(t)).map(({unitId:t})=>t)}getCenterOfMass(){return this.centerOfMass}getMaxDistanceToCenterOfMass(){return this.maxDistanceToCenterOfMass}getUniqueName(){return this.uniqueName}endMission(t){this.onFinish(this.unitIds,t),this.active=!1}then(t){return this.onFinish=t,this}isUnitsLocked(){return!0}}const p=t=>({type:"disband",reason:t}),d=t=>"disband"===t.action.type,m=(t,e)=>({type:"request",unitNames:t,priority:e}),y=t=>"request"===t.action.type,f=(t,e)=>({type:"requestSpecific",unitIds:t,priority:e}),T=t=>"requestSpecific"===t.action.type,A=(t,e)=>({type:"requestCombatants",point:t,radius:e}),b=t=>"requestCombatants"===t.action.type,w=t=>({type:"releaseUnits",unitIds:t}),M=t=>"releaseUnits"===t.action.type;class x extends g{constructor(t,e,i,s){super(t,s),this.priority=e,this.selectedMcv=i,this.hasAttemptedDeployWith=null}_onAiUpdate(e,i,s,r,n,a){const o=["AMCV","SMCV","CMCV"],h=this.getUnitsOfTypes(e,...o);return 0===h.length?null!==this.hasAttemptedDeployWith?p():this.selectedMcv?f([this.selectedMcv],this.priority):m(o,this.priority):((!this.hasAttemptedDeployWith||e.getCurrentTick()>this.hasAttemptedDeployWith.gameTick+30)&&(s.orderUnits(h.map(t=>t.id),t.OrderType.DeploySelected),this.hasAttemptedDeployWith={unitId:h[0].id,gameTick:e.getCurrentTick()}),{type:"noop"})}getGlobalDebugText(){return`Expand with MCV ${this.selectedMcv}`}getPriority(){return this.priority}}class P{getName(){return"ExpansionMissionFactory"}maybeCreateMissions(t,e,i,s,r,n){t.getVisibleUnits(e.name,"self",e=>t.getGeneralRules().baseUnit.includes(e.name)).forEach(t=>{s.addMission(new x("expand-with-"+t,100,t,n))})}onMissionFailed(t,e,i,s,r,n){}}var S;!function(t){t.USA="Americans",t.KOREA="Alliance",t.FRANCE="French",t.GERMANY="Germans",t.GREAT_BRITAIN="British",t.LIBYA="Africans",t.IRAQ="Arabs",t.CUBA="Confederation",t.RUSSIA="Russians"}(S||(S={}));const v=t=>"@@NEUTRAL@@"===t?.owner;function C(t,e="0000"){let i=""+t;return e.substring(0,e.length-i.length)+i}function k(t,e){if(0===t.length)return null;let i=0,s=e(t[0]);for(let r=1;r<t.length;++r){const n=e(t[r]);(null===s||null!==n&&n>s)&&(i=r,s=n)}return t[i]}function U(t,e){return t.reduce((t,i)=>{const s=e(i);return void 0===s||(t[s]||(t[s]=0),t[s]=t[s]+1),t},{})}function D(t,e){return t.reduce((t,i)=>{const s=e(i);return void 0===s||(t.hasOwnProperty(s)||(t[s]=[]),t[s].push(i)),t},{})}class E{constructor(t,e,i,s,r=0){this._unitId=t,this._orderType=e,this._point=i,this._targetId=s,this._nonce=r}static noTarget(t,e,i=0){return new E(t,e,void 0,void 0,i)}static toPoint(t,e,i,s=0){return new E(t,e,i,void 0)}static toTargetId(t,e,i,s=0){return new E(t,e,void 0,i,s)}get unitId(){return this._unitId}get orderType(){return this._orderType}get point(){return this._point}get targetId(){return this._targetId}isSameAs(t){return this._unitId===t._unitId&&(this._orderType===t._orderType&&(this._point===t._point&&(this._targetId===t._targetId&&this._nonce===t._nonce)))}}class N{constructor(){this.actions=[]}push(t){this.actions.push(t)}resolve(e){const i=D(this.actions,t=>t.orderType.valueOf().toString());Object.entries(i).forEach(([i,s])=>{const r=parseInt(i),n=D(s.filter(t=>!!t.targetId),t=>t.targetId?.toString());Object.entries(n).forEach(([t,i])=>{e.orderUnits(i.map(t=>t.unitId),r,parseInt(t))});const a=D(s.filter(t=>!!t.point),t=>{return(e=t.point).x+","+e.y;var e});Object.entries(a).forEach(([i,s])=>{const n=(e=>{const[i,s]=e.split(",");return new t.Vector2(parseInt(i),parseInt(s))})(i);e.orderUnits(s.map(t=>t.unitId),r,n.x,n.y)});const o=s.filter(t=>!t.targetId&&!t.point);o.length>0&&e.orderUnits(o.map(t=>t.unitId),r)})}}function R(e,i){if("E1"===e.name||"PLA"===e.name){if(e.stance===t.StanceType.Deployed)return E.noTarget(e.id,t.OrderType.DeploySelected,1)}return E.toPoint(e.id,t.OrderType.AttackMove,i)}function _(e,i){const s=(r=e,n=i,new t.Vector2(r.tile.rx,r.tile.ry).distanceTo(new t.Vector2(n.tile.rx,n.tile.ry)));var r,n;if("E1"===e.name||"PLA"===e.name){const i=e.secondaryWeapon?.maxRange||5,r=e.stance===t.StanceType.Deployed;if(!r&&(s<=i||e.attackState===t.AttackState.JustFired))return E.noTarget(e.id,t.OrderType.DeploySelected,0);if(r&&s>i)return E.noTarget(e.id,t.OrderType.DeploySelected,1)}let a=i,o=t.OrderType.Attack;const h=e.primaryWeapon?.maxRange||5;return a?.type==t.ObjectType.Building&&s<.8*h?o=t.OrderType.Attack:(a?.rules.canDisguise||a?.rules.underwater)&&(o=t.OrderType.ForceAttack),E.toTargetId(e.id,o,i.id)}function $(e,i){const{rx:s,ry:r}=e.tile,{rx:n,ry:o}=i.tile;["SUB","DLPH","SQD","SUB2"].includes(e.name),["DEST","AEGIS","CARRIER","SUB","HYD","DRED","DLPH","SQD","SUB2","DEST2","MBOAT","CARRIER2"].includes(i.name);if(!e.primaryWeapon?.projectileRules.isAntiAir&&i.zone===t.ZoneType.Air)return null;if(!["CARRIER","DRED"].includes(e.name)&&!e.primaryWeapon?.projectileRules.isAntiGround&&i.zone===t.ZoneType.Ground)return null;return 1e6-a(new t.Vector2(s,r),new t.Vector2(n,o))}var O;!function(t){t[t.Gathering=0]="Gathering",t[t.Attacking=1]="Attacking"}(O||(O={}));class I{constructor(t,e,i){this.rallyArea=t,this.targetArea=e,this.radius=i,this.lastCommand=null,this.state=O.Gathering,this.lastOrderGiven={}}getGlobalDebugText(){return this.debugLastTarget??"<none>"}setAttackArea(t){this.targetArea=t}onAiUpdate(e,i,s,r,n,a,o){if(n.getUnitIds().length>0&&(!this.lastCommand||e.getCurrentTick()>this.lastCommand+10)){this.lastCommand=e.getCurrentTick();const i=n.getCenterOfMass(),h=n.getMaxDistanceToCenterOfMass(),u=n.getUnitsMatchingByRule(e,t=>t.isSelectableCombatant).map(t=>e.getUnitData(t)).filter(t=>!!t),c=n.getUnitsMatchingByRule(e,e=>e.isSelectableCombatant&&(e.movementZone===t.MovementZone.Infantry||e.movementZone===t.MovementZone.Normal||e.movementZone===t.MovementZone.InfantryDestroyer));if(this.state===O.Gathering){const r=10*t.GameMath.sqrt(c.length)+5;i&&h&&void 0!==e.mapApi.getTile(i.x,i.y)&&h>r?u.forEach(t=>{this.submitActionIfNew(s,R(t,i))}):(o(`CombatSquad ${n.getUniqueName()} switching back to attack mode (${h})`),this.state=O.Attacking)}else{const l=this.targetArea||r.startLocation,g=10*t.GameMath.sqrt(c.length)+15;if(i&&h&&void 0!==e.mapApi.getTile(i.x,i.y)&&h>g)return o(`CombatSquad ${n.getUniqueName()} switching back to gather (${h})`),this.state=O.Gathering,{type:"noop"};const p=t=>t.primaryWeapon?.maxRange??t.secondaryWeapon?.maxRange??5,d=function(t,e){if(0===t.length)return null;let i=0,s=e(t[0]);for(let r=1;r<t.length;++r){const n=e(t[r]);(null===s||null!==n&&n<s)&&(i=r,s=n)}return t[i]}(u,p),m=k(u,p),y=Math.max(15,m?p(m):15);if(!d)return{type:"noop"};const f=a.getHostilesNearPoint2d(this.targetArea,2*y).map(({unitId:t})=>e.getUnitData(t)).filter(t=>!!t&&!v(t));for(const e of u){const r=["FV","HTK","BGGY"].includes(e.name),n=["SUB","DLPH","SQD","SUB2"].includes(e.name),a=p(e),h=Math.max(15,a),u=f.filter(i=>t.GameMath.sqrt(t.GameMath.pow(i.tile.rx-e.tile.rx,2)+t.GameMath.pow(i.tile.ry-e.tile.ry,2))<=h);if(r){const r=k(u.filter(e=>e.zone===t.ZoneType.Air),t=>$(e,t));r?(this.submitActionIfNew(s,_(e,r)),this.debugLastTarget=`AA ${r.id.toString()}`):i?(this.submitActionIfNew(s,R(e,i)),this.debugLastTarget=`escort@${i.x},${i.y}`):(this.submitActionIfNew(s,R(e,l)),this.debugLastTarget=`escort->@${l.x},${l.y}`);continue}n&&(o(`[NAVAL_DEBUG] Underwater unit ${e.name}(id:${e.id}) starting to find attack target (scan=${h})`),o(`[NAVAL_DEBUG]   Found ${u.length} hostile targets within scan range`),u.forEach((t,i)=>{const s=$(e,t),r=["DEST","AEGIS","CARRIER","SUB","HYD","DRED","DLPH","SQD","SUB2","DEST2","MBOAT","CARRIER2"].includes(t.name);o(`[NAVAL_DEBUG]     Target ${i+1}: ${t.name}(id:${t.id}) weight=${s} is naval=${r}`)}));const c=k(u,t=>$(e,t));c?(n&&o(`[NAVAL_DEBUG]   Choosing attack target: ${c.name}(id:${c.id})`),this.submitActionIfNew(s,_(e,c)),this.debugLastTarget=`Unit ${c.id.toString()}`):(n&&o("[NAVAL_DEBUG]   No suitable attack target found, moving to target point"),this.submitActionIfNew(s,R(e,l)),this.debugLastTarget=`@${l.x},${l.y}`)}}}return{type:"noop"}}submitActionIfNew(t,e){const i=this.lastOrderGiven[e.unitId];i&&i.isSameAs(e)||(t.push(e),this.lastOrderGiven[e.unitId]=e)}}class V extends g{constructor(t,e,i,s){super(t,s),this.retreatToPoint=e,this.withUnitIds=i,this.createdAt=null}_onAiUpdate(e,i,s,r,n,a){return this.createdAt||(this.createdAt=e.getCurrentTick()),this.getUnitIds().length>0?(s.orderUnits(this.getUnitIds(),t.OrderType.AttackMove,this.retreatToPoint.x,this.retreatToPoint.y),p()):this.createdAt&&e.getCurrentTick()>this.createdAt+240?p():f(this.withUnitIds,1e3)}getGlobalDebugText(){return`retreat with ${this.withUnitIds.length} units`}getPriority(){return 100}}function L(e){return function(i){const s=[t.QueueType.Structures,t.QueueType.Armory,t.QueueType.Infantry,t.QueueType.Vehicles,t.QueueType.Aircrafts,t.QueueType.Ships];for(const t of s)try{const s=e.getAvailableObjects(t);if(s.some(t=>t.name===i))return!0}catch(t){continue}return!1}}function G(e,i,s,r,n=1,a=!1){const o=e.mapApi.getTile(i.x,i.y),h=e.mapApi.getTile(s.x,s.y);if(!o||!h)return!1;const u=void 0!==o.onBridgeLandType,c=void 0!==h.onBridgeLandType,l=e.mapApi.findPath(r,a,{tile:o,onBridge:u},{tile:h,onBridge:c});if(!l||0===l.length)return!1;const g=l[0].tile;return new t.Vector2(g.rx,g.ry).distanceTo(s)<=n}var q,B;!function(t){t[t.NoTargets=0]="NoTargets",t[t.DefenceTooStrong=1]="DefenceTooStrong"}(q||(q={})),function(t){t[t.Preparing=0]="Preparing",t[t.Attacking=1]="Attacking",t[t.Retreating=2]="Retreating"}(B||(B={}));function F(e,i,s,r,n=!1){if(!i.country)throw new Error(`player ${i.name} has no country`);if(n){if(i.country.side===t.SideType.Nod){const t=((t,e,i,s)=>{let r={};return L(s)("DRED")&&(r.DRED=1),r})(0,0,0,r),e=((t,e,i,s)=>{const r=L(s),n=r("DEST2"),a=r("MBOAT"),o=r("CARRIER2"),h={};return n&&(h.DEST2=3),a&&(h.MBOAT=1),o&&(h.CARRIER2=1),h})(0,0,0,r),i={...t};for(const[t,s]of Object.entries(e))i[t]=(i[t]??0)+s;return i}return((t,e,i,s)=>{const r=L(s),n=r("DEST"),a=r("AEGIS"),o=r("CARRIER");let h={};return a&&(h.AEGIS=1),o&&(h.CARRIER=1),n&&(h.DEST=3),h})(0,0,0,r)}if(i.country.side===t.SideType.Nod){const t=((t,e,i,s)=>{const r=L(s),n=r("E2"),a=r("DESO"),o=r("HTNK"),h=r("HTK"),u=r("V3"),c=r("TTNK"),l=r("APOC"),g=r("SHK"),p=!l&&n,d={};return a&&(d.DESO=1),g&&(d.SHK=1),d.E2=p?10:1,o&&(d.HTNK=5),u&&(d.V3=1),h&&(o||u)&&(d.HTK=1),c&&(d.TTNK=1),l&&(d.APOC=2),d})(0,0,0,r),e=((t,e,i,s)=>{const r=L(s),n=r("PLA"),a=r("LTNK"),o=r("BGGY"),h=r("GHOST2"),u=r("HOWI"),c=r("V32"),l={};return n&&(l.PLA=5),a&&(l.LTNK=3),o&&(l.BGGY=2),h&&(l.GHOST2=2),u&&(l.HOWI=2),c&&(l.V32=1),l})(0,0,0,r),i={...t};for(const[t,s]of Object.entries(e))i[t]=(i[t]??0)+s;return i}return((t,e,i,s)=>{const r=L(s),n=r("E1"),a=r("SNIPE"),o=r("JUMPJET"),h=r("TNKD"),u=r("MTNK"),c=r("FV"),l=r("SREF"),g=r("MGTK"),p={};return!o&&!l&&n&&(p.E1=5),a&&(p.SNIPE=1),u&&!o&&(p.MTNK=6,c&&(p.FV=1)),u&&o&&(p.MTNK=3),h&&(p.TNKD=1),o&&(p.JUMPJET=6,c&&(p.FV=1)),l&&(p.SREF=2,g&&(p.MGTK=3),c&&(p.FV=1)),p})(0,0,0,r)}function j(e,i,s,r){if(!i.country)throw new Error(`player ${i.name} has no country`);if(i.country.side===t.SideType.Nod){const t=((t,e,i,s)=>{const r={};return L(s)("HTK")&&(r.HTK=2),r})(0,0,0,r),e=((t,e,i,s)=>{const r={};return L(s)("BGGY")&&(r.BGGY=2),r})(0,0,0,r),i={...t};for(const[t,s]of Object.entries(e))i[t]=(i[t]??0)+s;return i}return((t,e,i,s)=>{const r={};return L(s)("FV")&&(r.FV=2),r})(0,0,0,r)}class H extends g{constructor(t,e,i,s,r,n,a,o){super(t,a),this.priority=e,this.rallyArea=i,this.attackArea=s,this.radius=r,this.composition=n,this.eventBus=o,this.hasTriedLandAttack=!1,this.landAttackFailCount=0,this.MAX_LAND_ATTACK_ATTEMPTS=2,this.isNavalMission=!1,this.navalModeStartTick=0,this.navalYardRequestAttempts=0,this.unsubscribeFromEvents=null,this.MAX_NAVAL_YARD_ATTEMPTS=2,this.NAVAL_YARD_WAIT_TICKS=4500,this.lastTargetSeenAt=0,this.hasPickedNewTarget=!1,this.state=B.Preparing,this.squad=new I(i,s,r)}shouldSwitchToNaval(e,i){if(this.logger(`shouldSwitchToNaval? tick=${e.getCurrentTick()} | isNavalMission=${this.isNavalMission} | landFails=${this.landAttackFailCount}/${this.MAX_LAND_ATTACK_ATTEMPTS}`),this.logger(`    rallyArea=(${this.rallyArea.x},${this.rallyArea.y}) attackArea=(${this.attackArea.x},${this.attackArea.y})`),this.isNavalMission)return this.logger("    Already naval mission, skip switch check."),!1;const s=G(e,this.rallyArea,this.attackArea,t.SpeedType.Track,6);if(this.logger(`    pathReachable=${s}`),!s){const s=e.mapApi.getTile(this.rallyArea.x,this.rallyArea.y),r=e.mapApi.getTile(this.attackArea.x,this.attackArea.y),n=(G(e,this.rallyArea,this.attackArea,t.SpeedType.Track,6),e.getVisibleUnits(i.name,"enemy").map(t=>e.getUnitData(t)).filter(t=>void 0!==t).filter(e=>new t.Vector2(e.tile.rx,e.tile.ry).distanceTo(this.attackArea)<=3));return this.logger(`Attack Area (${this.attackArea.x},${this.attackArea.y}) radius ${this.radius} found ${n.length} enemy units:`),n.forEach((e,i)=>{const s=new t.Vector2(e.tile.rx,e.tile.ry).distanceTo(this.attackArea);this.logger(`  ${i+1}. ${e.name}(id:${e.id}) distance:${s.toFixed(1)} type:${e.type} health:${e.hitPoints}/${e.maxHitPoints}`)}),this.logger(`Target point unreachable for land units, switching to naval formation | rallyTile type: ${s?.landType??"unknown"} | attackTile type: ${r?.landType??"unknown"}`),!0}return this.landAttackFailCount>=this.MAX_LAND_ATTACK_ATTEMPTS&&(this.logger("Too many land attack failures, switching to naval formation"),!0)}_onAiUpdate(t,e,i,s,r,n){switch(this.state){case B.Preparing:return this.handlePreparingState(t,e,i,s,r,n);case B.Attacking:return this.handleAttackingState(t,e,i,s,r,n);case B.Retreating:return this.handleRetreatingState(t,i,s,r,n)}}handlePreparingState(e,i,s,r,n,a){if(!this.isNavalMission&&this.shouldSwitchToNaval(e,r))return this.isNavalMission=!0,this.eventBus.publish({type:"modeChanged",player:r.name,isNaval:!0}),this.unsubscribeFromEvents||(this.unsubscribeFromEvents=this.eventBus.subscribe(t=>{"yardFailed"===t.type&&t.player===r.name&&this.navalYardRequestAttempts++})),this.navalModeStartTick=e.getCurrentTick(),this.navalYardRequestAttempts=0,this.composition=F(0,r,0,i,!0),this.logger("Switched to naval formation"),this.logger(`[NAVAL_DEBUG] Naval formation composition: ${JSON.stringify(this.composition)}`),{type:"noop"};const o=U(this.getUnitsGameObjectData(e),t=>t.name),h=j(0,r,0,i),u=Object.fromEntries(Object.keys(h).map(t=>[t,o[t]||0]));if(this.isNavalMission){if(G(e,this.rallyArea,this.attackArea,t.SpeedType.Track,6))return this.logger("[NAVAL_DEBUG] Land path is now clear, switching back to land mode"),this.unsubscribeFromEvents&&(this.unsubscribeFromEvents(),this.unsubscribeFromEvents=null),this.isNavalMission=!1,this.eventBus.publish({type:"modeChanged",player:r.name,isNaval:!1}),this.priority=Y,this.composition=F(0,r,0,i,!1),{type:"noop"}}const c=e.getVisibleUnits(r.name,"self",t=>"GAYARD"===t.name||"NAYARD"===t.name).length>0;if(this.isNavalMission&&!c){if(e.getCurrentTick()-this.navalModeStartTick>this.NAVAL_YARD_WAIT_TICKS||this.navalYardRequestAttempts>=this.MAX_NAVAL_YARD_ATTEMPTS)return this.logger(`[NAVAL_DEBUG] Naval yard unable to build for long time, falling back to land mode, attempts: ${this.navalYardRequestAttempts}, wait time: ${e.getCurrentTick()-this.navalModeStartTick}`),this.unsubscribeFromEvents&&(this.unsubscribeFromEvents(),this.unsubscribeFromEvents=null),this.isNavalMission=!1,this.eventBus.publish({type:"modeChanged",player:r.name,isNaval:!1}),this.composition=F(0,r,0,i,!1),{type:"noop"};if(this.navalYardRequestAttempts<this.MAX_NAVAL_YARD_ATTEMPTS){const e=r.country?.side===t.SideType.Nod?"NAYARD":"GAYARD";return m([e],100*this.priority)}}this.isNavalMission&&(this.logger(`[NAVAL_DEBUG] Current naval unit composition: ${JSON.stringify(o)}`),this.logger(`[NAVAL_DEBUG] Target naval formation composition: ${JSON.stringify(this.composition)}`));const l=Object.entries(this.composition).filter(([t,e])=>!o[t]||o[t]<e);if(l.length>0){this.isNavalMission&&this.logger(`[NAVAL_DEBUG] Missing naval units: ${JSON.stringify(l)}`),this.priority=Math.min(1.01*this.priority,50);const t=l.map(([t])=>t);return this.logger(`Requesting units: ${JSON.stringify(t)}`),t.includes("HTK")&&this.logger("[DEBUG] Requesting HTK"),m(t,this.priority)}if(this.isNavalMission)this.logger("[NAVAL_DEBUG] Naval formation ready, starting attack phase"),this.priority=Y,this.state=B.Attacking;else{const t=Object.entries(h).filter(([t,e])=>(u[t]||0)<e),e=this.priority;if(this.priority=Y,this.state=B.Attacking,t.length>0)return m(t.map(([t])=>t),e)}return{type:"noop"}}handleAttackingState(t,e,i,s,r,n){if(0===this.getUnitIds().length)return!this.isNavalMission&&(this.landAttackFailCount++,this.shouldSwitchToNaval(t,s))?(this.state=B.Preparing,{type:"noop"}):(this.state=B.Retreating,{type:"noop"});const a=r.getHostilesNearPoint2d(this.attackArea,this.radius).map(e=>t.getUnitData(e.unitId)).filter(t=>!v(t)),o=this.squad.onAiUpdate(t,i,n,s,this,r,this.logger);if("noop"!==o.type)return o;if(a.length>0)this.lastTargetSeenAt=t.getCurrentTick(),this.hasPickedNewTarget=!1;else{if(t.getCurrentTick()>this.lastTargetSeenAt+900)return p(q.NoTargets);if(!this.hasPickedNewTarget&&t.getCurrentTick()>this.lastTargetSeenAt+450){const e=W(t,s,r,!1,this.logger);e&&(this.squad.setAttackArea(e),this.hasPickedNewTarget=!0)}}if(!this.isNavalMission){const i=j(0,s,0,e);if(Object.keys(i).length>0){const e=U(this.getUnitsGameObjectData(t),t=>t.name),s=Object.fromEntries(Object.keys(i).map(t=>[t,e[t]||0])),r=Object.entries(i).filter(([t,e])=>(s[t]||0)<e);if(r.length>0)return this.priority=Math.min(1.01*this.priority,50),m(r.map(([t])=>t),this.priority)}}return{type:"noop"}}handleRetreatingState(t,e,i,s,r){return this.getUnits(t).forEach(t=>{r.push(R(t,s.getMainRallyPoint()))}),p()}getGlobalDebugText(){return this.squad.getGlobalDebugText()??"<none>"}getState(){return this.state}isUnitsLocked(){return this.state!==B.Preparing}getPriority(){return this.priority}isNaval(){return this.isNavalMission}}const Q=(e,i)=>i&&e.rules.harvester?1e5:e.type===t.ObjectType.Building?10*e.maxHitPoints:e.maxHitPoints;function W(e,i,s,r=!1,n){const a=s.getMainRallyPoint();try{const s=0===e.generateRandomInt(0,1),o=e.getVisibleUnits(i.name,"enemy").map(t=>e.getUnitData(t)).filter(t=>!!t&&e.getPlayerData(t.owner).isCombatant),h=k(o,i=>{let r=Q(i,s);try{G(e,a,new t.Vector2(i.tile.rx,i.tile.ry),t.SpeedType.Track,6)||(r*=.3)}catch(t){r*=.3}return r});if(h)return n?.(`generateTarget: picked visible enemy unit ${h.name} (id=${h.id}) at (${h.tile.rx},${h.tile.ry})`),new t.Vector2(h.tile.rx,h.tile.ry);if(r){const t=e.mapApi,s=e.getPlayers().map(t=>e.getPlayerData(t)).filter(t=>!e.areAlliedPlayers(i.name,t.name)).filter(e=>{const s=t.getTile(e.startLocation.x,e.startLocation.y);return!!s&&!t.isVisibleTile(s,i.name)});if(s.length>0){const t=s[e.generateRandomInt(0,s.length-1)].startLocation;return n?.(`generateTarget: picked unexplored enemy base at (${t.x},${t.y})`),t}}}catch(t){n?.(`generateTarget: ERROR while selecting target: ${t}`)}try{const s=e.getGeneralRules().baseUnit??[],r=e.getVisibleUnits(i.name,"enemy",t=>!!t.deploysInto&&s.includes(t.name));if(r.length>0){const i=r[0],s=e.getUnitData(i);if(s)return n?.(`generateTarget: fallback to enemy MCV ${s.name} (id=${s.id}) at (${s.tile.rx},${s.tile.ry})`),new t.Vector2(s.tile.rx,s.tile.ry)}}catch(t){}return null}const Y=1;class z{constructor(t){this.eventBus=t,this.lastAttackAt=-120}getName(){return"AttackMissionFactory"}maybeCreateMissions(t,e,i,s,r,n){if(t.getCurrentTick()<this.lastAttackAt+120)return;if(s.getMissions().some(t=>t instanceof H&&t.getState()===B.Preparing))return;const a=t.getCurrentTick()>this.lastAttackAt+1800,o=W(t,e,i,a,n);if(!o)return;const h="attack_"+t.getCurrentTick(),u=F(0,e,0,r);s.addMission(new H(h,Y,i.getMainRallyPoint(),o,10,u,n,this.eventBus).then((e,r)=>{s.addMission(new V("retreat-from-"+h+t.getCurrentTick(),i.getMainRallyPoint(),e,n))}))&&(this.lastAttackAt=t.getCurrentTick())}onMissionFailed(t,e,i,s,r,n){}}class K extends g{constructor(t,e,i){super(t,i),this.priority=e,this.scoutTarget=null,this.attemptsOnCurrentTarget=0,this.scoutTargetRefreshedAt=0,this.lastMoveCommandTick=0,this.scoutTargetIsPermanent=!1,this.hadUnit=!1}_onAiUpdate(e,i,s,r,n,a){const h=this.getUnits(e);if((n.getSectorCache().getOverallVisibility()||0)>.9)return p();if(0===h.length)return this.scoutTarget&&this.hadUnit&&(this.attemptsOnCurrentTarget++,this.hadUnit=!1),m(function(e,i){const s=[...e.getAvailableObjects(t.QueueType.Infantry),...e.getAvailableObjects(t.QueueType.Vehicles),...e.getAvailableObjects(t.QueueType.Aircrafts)].filter(t=>t.speed>0&&t.sight>0&&!t.harvester&&!t.refinery&&!t.deploysInto);return 0===s.length?["E1","E2","PLA","ADOG","DOG"]:(s.sort((t,e)=>{const s=Math.max(i.credits/10,100),r=(2*t.sight+t.speed)/(t.cost/s+1);return(2*e.sight+e.speed)/(e.cost/s+1)-r}),[s[0].name])}(i,r),this.priority);if(this.scoutTarget){if(this.hadUnit=!0,!this.scoutTargetIsPermanent){if(this.attemptsOnCurrentTarget>3)return this.logger(`Scout target ${this.scoutTarget.x},${this.scoutTarget.y} took too many attempts, moving to next`),this.setScoutTarget(null,0),{type:"noop"};let i=!0;if(h.length>0){G(e,new t.Vector2(h[0].tile.rx,h[0].tile.ry),this.scoutTarget,t.SpeedType.Track,5,!1)&&(i=!1,this.logger(`Scout target ${this.scoutTarget.x},${this.scoutTarget.y} is reachable, skipping time limit`))}if(i&&e.getCurrentTick()>this.scoutTargetRefreshedAt+600)return this.logger(`Scout target ${this.scoutTarget.x},${this.scoutTarget.y} took too long, moving to next`),this.setScoutTarget(null,0),{type:"noop"}}const i=e.mapApi.getTile(this.scoutTarget.x,this.scoutTarget.y);if(!i)throw new Error(`target tile ${this.scoutTarget.x},${this.scoutTarget.y} does not exist`);if(e.getCurrentTick()>this.lastMoveCommandTick+30){this.lastMoveCommandTick=e.getCurrentTick(),h.forEach(e=>{this.scoutTarget&&s.orderUnits([e.id],t.OrderType.AttackMove,this.scoutTarget.x,this.scoutTarget.y)});const i=h.map(t=>o(t.tile,this.scoutTarget)),r=Math.min(...i);(!this.scoutMinDistance||r<this.scoutMinDistance)&&(this.logger(`Scout timeout refreshed because unit moved closer to point (${r} < ${this.scoutMinDistance})`),this.scoutTargetRefreshedAt=e.getCurrentTick(),this.scoutMinDistance=r)}e.mapApi.isVisibleTile(i,r.name)&&(this.logger(`Scout target ${this.scoutTarget.x},${this.scoutTarget.y} successfully scouted, moving to next`),this.setScoutTarget(null,e.getCurrentTick()))}else{const t=n.getScoutingManager().getNewScoutTarget();if(!t)return this.logger("No more scouting targets available, disbanding."),p();this.setScoutTarget(t,e.getCurrentTick())}return{type:"noop"}}setScoutTarget(t,e){this.attemptsOnCurrentTarget=0,this.scoutTargetRefreshedAt=e,this.scoutTarget=t?.asVector2()??null,this.scoutMinDistance=void 0,this.scoutTargetIsPermanent=t?.isPermanent??!1}getGlobalDebugText(){return"scouting"}getPriority(){return this.priority}}class X{constructor(t=-300){this.lastScoutAt=t}getName(){return"ScoutingMissionFactory"}maybeCreateMissions(t,e,i,s,r,n){t.getCurrentTick()<this.lastScoutAt+300||i.getScoutingManager().hasScoutTargets()&&(s.addMission(new K("globalScout",10,n))||(this.lastScoutAt=t.getCurrentTick()))}onMissionFailed(t,e,i,s,r,n,a){t.getCurrentTick()<this.lastScoutAt+300||i.getScoutingManager().hasScoutTargets()&&s instanceof H&&(n.addMission(new K("globalScout",10,a)),this.lastScoutAt=t.getCurrentTick())}}class Z extends g{constructor(t,e,i,s,r,n){super(t,n),this.priority=e,this.defenceArea=s,this.radius=r,this.idleTicks=0,this.IDLE_DISBAND_THRESHOLD=90,this.squad=new I(i,s,r)}_onAiUpdate(e,i,s,r,n,a){const o=n.getHostilesNearPoint2d(this.defenceArea,this.radius).map(t=>e.getUnitData(t.unitId)).filter(t=>!v(t)),h=this.squad.onAiUpdate(e,s,a,r,this,n,this.logger);if("noop"!==h.type)return h;if(0===o.length)return this.priority=0,this.idleTicks++,this.idleTicks>=this.IDLE_DISBAND_THRESHOLD&&0===this.getUnitIds().length?(this.logger(`(Defence Mission ${this.getUniqueName()}): No threats for ${this.idleTicks} ticks and no units, disbanding.`),p()):this.getUnitIds().length>0?(this.logger(`(Defence Mission ${this.getUniqueName()}): No targets found, releasing units.`),w(this.getUnitIds())):{type:"noop"};{this.idleTicks=0;const e=o[0];return this.logger(`(Defence Mission ${this.getUniqueName()}): Focused on target ${e?.name} (${o.length} found in area ${this.radius})`),this.squad.setAttackArea(new t.Vector2(o[0].tile.rx,o[0].tile.ry)),this.priority=100,A(r.startLocation,this.priority)}}getGlobalDebugText(){return this.squad.getGlobalDebugText()??"<none>"}getPriority(){return this.priority}}class J{constructor(){this.lastDefenceCheckAt=0}getName(){return"DefenceMissionFactory"}maybeCreateMissions(t,e,i,s,r,n){if(t.getCurrentTick()<this.lastDefenceCheckAt+30)return;this.lastDefenceCheckAt=t.getCurrentTick();const a=10+.001*t.getCurrentTick(),o=i.getHostilesNearPoint2d(e.startLocation,a).map(e=>t.getUnitData(e.unitId)).filter(t=>!v(t));o.length>0&&(s.getMissions().filter(t=>!1===t.isUnitsLocked()&&!(t instanceof H&&t.isNaval())).forEach(t=>{n(`Disbanding preparing mission ${t.getUniqueName()} due to defence activation.`),s.disbandMission(t.getUniqueName())}),n(`Starting defence mission, ${o.length} found in radius ${a} (tick ${t.getCurrentTick()})`),s.addMission(new Z("globalDefence",10,i.getMainRallyPoint(),e.startLocation,1.2*a,n)))}onMissionFailed(t,e,i,s,r,n){}}class tt extends g{constructor(t,e,i,s){super(t,s),this.priority=e,this.captureTargetId=i,this.hasAttemptedCaptureWith=null}_onAiUpdate(e,i,s,r,n,a){const o=["ENGINEER","SENGINEER"],h=this.getUnitsOfTypes(e,...o);return 0===h.length?null!==this.hasAttemptedCaptureWith?p():m(o,this.priority):((!this.hasAttemptedCaptureWith||e.getCurrentTick()>this.hasAttemptedCaptureWith.gameTick+120)&&(s.orderUnits(h.map(t=>t.id),t.OrderType.Capture,this.captureTargetId),this.hasAttemptedCaptureWith={unitId:h[0].id,gameTick:e.getCurrentTick()}),{type:"noop"})}getGlobalDebugText(){}getPriority(){return this.priority}}class et{constructor(){this.lastCheckAt=0}getName(){return"EngineerMissionFactory"}maybeCreateMissions(t,e,i,s,r,n){if(!(t.getCurrentTick()>this.lastCheckAt+300))return;this.lastCheckAt=t.getCurrentTick();t.getVisibleUnits(e.name,"hostile",t=>t.capturable&&t.produceCashAmount>0).forEach(t=>{s.addMission(new tt("capture-"+t,100,t,n))})}onMissionFailed(t,e,i,s,r,n){}}function it(i,s=8){const r=[],n=e(i.mapApi);for(let e=0;e<n.width;e+=s)for(let a=0;a<n.height;a+=s)if(e>=0&&e<n.width&&a>=0&&a<n.height){const s=i.mapApi.getTile(e,a);if(s&&s.landType===t.LandType.Water){i.mapApi.findPath(t.SpeedType.Float,!0,{tile:s,onBridge:!1},{tile:s,onBridge:!1})&&r.push(new t.Vector2(e,a))}}return 0===r.length&&s>2?it(i,Math.floor(s/2)):r}function st(e,i,s){const r=e.mapApi.getTile(i.x,i.y),n=e.mapApi.getTile(s.x,s.y);if(!r||!n)return null;const a=e.mapApi.findPath(t.SpeedType.Float,!0,{tile:r,onBridge:!1},{tile:n,onBridge:!1});if(!a||0===a.length)return null;const o=a[a.length-1];return new t.Vector2(o.tile.rx,o.tile.ry)}class rt extends g{constructor(t,e,i){super(t,i),this.priority=e,this.scoutTarget=null,this.attemptsOnCurrentTarget=0,this.scoutTargetRefreshedAt=0,this.lastMoveCommandTick=0,this.scoutTargetIsPermanent=!1,this.hadUnit=!1,this.waterPoints=null,this.visitedWaterPoints=new Set,this.lastPosition=null,this.lastPositionCheckTick=0}initializeWaterPoints(t){null===this.waterPoints&&(this.waterPoints=it(t),this.logger(`Found ${this.waterPoints.length} water exploration points`))}getNextWaterTarget(t,e,i){if(this.initializeWaterPoints(t),!this.waterPoints||0===this.waterPoints.length)return null;let s=null,r=Number.MAX_VALUE;const n=i.getSectorCache(),a=new Set;this.waterPoints.forEach(t=>{const e=n.getSectorForWorldPosition(t.x,t.y);e&&void 0!==e.sectorVisibilityPct&&e.sectorVisibilityPct>0&&a.add(`${t.x},${t.y}`)}),this.visitedWaterPoints.size>=this.waterPoints.length&&(this.visitedWaterPoints=a);for(let i=0;i<this.waterPoints.length;i++){const n=this.waterPoints[i],o=`${n.x},${n.y}`;if(this.visitedWaterPoints.has(o))continue;if(a.has(o)){this.visitedWaterPoints.add(o);continue}const h=e.distanceTo(n);if(h<r){st(t,e,n)&&(s=n,r=h)}}if(s){const t=`${s.x},${s.y}`;this.visitedWaterPoints.add(t),this.logger(`Selected new water exploration point ${s.x},${s.y}`)}else this.visitedWaterPoints.size<this.waterPoints.length&&this.logger("Re-explore undiscovered areas");return s}isUnitStuck(t){if(!this.lastPosition)return!1;const e=Math.abs(t.x-this.lastPosition.x),i=Math.abs(t.y-this.lastPosition.y);return e<=2&&i<=2}_onAiUpdate(e,i,s,r,n,a){const o=this.getUnits(e);if((n.getSectorCache().getOverallVisibility()||0)>.9)return p();if(0===o.length)return this.scoutTarget&&this.hadUnit&&(this.attemptsOnCurrentTarget++,this.hadUnit=!1),m(function(e,i){const s=[...e.getAvailableObjects(t.QueueType.Ships),...e.getAvailableObjects(t.QueueType.Aircrafts)].filter(e=>e.speedType===t.SpeedType.Float||e.speedType===t.SpeedType.Amphibious||e.speedType===t.SpeedType.Winged).filter(t=>t.speed>0&&t.sight>0&&!t.harvester&&!t.refinery&&!t.deploysInto);return 0===s.length?["DLPH","DEST","SUB","HYD","SQD","SUB2","DEST2"]:(s.sort((t,e)=>{const s=Math.max(i.credits/10,100),r=(2*t.sight+t.speed)/(t.cost/s+1);return(2*e.sight+e.speed)/(e.cost/s+1)-r}),[s[0].name])}(i,r),this.priority);const h=o[0],u=new t.Vector2(h.tile.rx,h.tile.ry);if(e.getCurrentTick()>=this.lastPositionCheckTick+60&&(this.lastPosition&&this.isUnitStuck(u)&&(this.logger(`Unit stopped moving at ${u.x},${u.y}, searching for new target`),this.setScoutTarget(null,e.getCurrentTick())),this.lastPosition=u,this.lastPositionCheckTick=e.getCurrentTick()),this.scoutTarget){if(this.hadUnit=!0,!this.scoutTargetIsPermanent){if(this.attemptsOnCurrentTarget>5)return this.logger(`Scout target ${this.scoutTarget.x},${this.scoutTarget.y} attempted too many times, switching to next target`),this.setScoutTarget(null,0),{type:"noop"};if(e.getCurrentTick()>this.scoutTargetRefreshedAt+600)return this.logger(`Scout target ${this.scoutTarget.x},${this.scoutTarget.y} taking too long, switching to next target`),this.setScoutTarget(null,0),{type:"noop"}}const i=e.mapApi.getTile(this.scoutTarget.x,this.scoutTarget.y);if(!i)throw new Error(`Target position ${this.scoutTarget.x},${this.scoutTarget.y} does not exist`);if(e.getCurrentTick()>this.lastMoveCommandTick+30&&(this.lastMoveCommandTick=e.getCurrentTick(),o.forEach(e=>{this.scoutTarget&&s.orderUnits([e.id],t.OrderType.Move,this.scoutTarget.x,this.scoutTarget.y)})),e.mapApi.isVisibleTile(i,r.name)){const t=`${this.scoutTarget.x},${this.scoutTarget.y}`;this.visitedWaterPoints.add(t),this.logger(`Target ${this.scoutTarget.x},${this.scoutTarget.y} scouted successfully, switching to next target`),this.setScoutTarget(null,e.getCurrentTick())}}else{const t=n.getScoutingManager().getNewScoutTarget();if(t){const i=t.asVector2();if(i){const t=st(e,u,i);if(t)return this.setScoutTarget(t,e.getCurrentTick()),this.logger(`Heading to scout target ${t.x},${t.y}`),{type:"noop"}}}const i=this.getNextWaterTarget(e,u,n);if(!i)return this.logger("No reachable water exploration points found, mission ends"),p();this.setScoutTarget(i,e.getCurrentTick())}return{type:"noop"}}setScoutTarget(t,e){this.attemptsOnCurrentTarget=0,this.scoutTargetRefreshedAt=e,this.scoutTarget=t,this.scoutTargetIsPermanent=!1,this.lastPosition=null,this.lastPositionCheckTick=e}getGlobalDebugText(){return"Naval scouting in progress"}getPriority(){return this.priority}}class nt{constructor(t=-300,e){this.lastScoutAt=t,this.eventBus=e,this.navalMode=!1,this.eventBus&&this.eventBus.subscribe(t=>{"modeChanged"===t.type&&(this.navalMode=t.isNaval)})}getName(){return"NavalScoutingMissionFactory"}maybeCreateMissions(t,e,i,s,r,n){this.navalMode&&(t.getCurrentTick()<this.lastScoutAt+300||i.getScoutingManager().hasScoutTargets()&&(s.addMission(new rt("navalScout",10,n))||(this.lastScoutAt=t.getCurrentTick())))}onMissionFailed(t,e,i,s,r,n,a){this.navalMode&&(t.getCurrentTick()<this.lastScoutAt+300||i.getScoutingManager().hasScoutTargets()&&s instanceof rt&&(n.addMission(new rt("navalScout",10,a)),this.lastScoutAt=t.getCurrentTick()))}}function at(i,s=8){const r=[],n=e(i.mapApi);for(let e=0;e<n.width;e+=s)for(let a=0;a<n.height;a+=s)if(e>=0&&e<n.width&&a>=0&&a<n.height){const s=i.mapApi.getTile(e,a);s&&i.mapApi.isPassableTile(s,t.SpeedType.Amphibious,!1,!1)&&r.push(new t.Vector2(e,a))}return 0===r.length&&s>2?at(i,Math.floor(s/2)):r}class ot extends g{constructor(t,e,i){super(t,i),this.priority=e,this.scoutTarget=null,this.attemptsOnCurrentTarget=0,this.scoutTargetRefreshedAt=0,this.lastMoveCommandTick=0,this.scoutTargetIsPermanent=!1,this.hadUnit=!1,this.amphibiousPoints=null,this.visitedPoints=new Set,this.lastPosition=null,this.lastPositionCheckTick=0}initializeAmphibiousPoints(t){if(null===this.amphibiousPoints){this.amphibiousPoints=at(t);for(let e=this.amphibiousPoints.length-1;e>0;e--){const i=Math.floor(t.generateRandomInt(0,e));[this.amphibiousPoints[e],this.amphibiousPoints[i]]=[this.amphibiousPoints[i],this.amphibiousPoints[e]]}this.logger(`Found ${this.amphibiousPoints.length} amphibious exploration points`)}}isUnitStuck(t){if(!this.lastPosition)return!1;const e=Math.abs(t.x-this.lastPosition.x),i=Math.abs(t.y-this.lastPosition.y);return e<=2&&i<=2}getNextAmphibiousTarget(t,e,i){if(this.initializeAmphibiousPoints(t),!this.amphibiousPoints||0===this.amphibiousPoints.length)return null;let s=null,r=1/0;for(const n of this.amphibiousPoints){const a=`${n.x},${n.y}`;if(this.visitedPoints.has(a))continue;const h=t.mapApi.getTile(n.x,n.y);if(!h||t.mapApi.isVisibleTile(h,i.name)){this.visitedPoints.add(a);continue}const u=o(h,e);u<r&&(r=u,s=n)}return s}_onAiUpdate(e,i,s,r,n,a){const h=this.getUnits(e);if((n.getSectorCache().getOverallVisibility()||0)>.9)return p();if(0===h.length)return this.scoutTarget&&this.hadUnit&&(this.attemptsOnCurrentTarget++,this.hadUnit=!1),m(function(e,i){const s=[...e.getAvailableObjects(t.QueueType.Infantry),...e.getAvailableObjects(t.QueueType.Vehicles)].filter(e=>e.speedType===t.SpeedType.Amphibious||e.speedType===t.SpeedType.Hover||e.speedType===t.SpeedType.Winged).filter(t=>t.speed>0&&t.sight>0&&!t.harvester&&!t.refinery&&!t.deploysInto);return 0===s.length?["SAPC","LCRF","CAPC"]:(s.sort((t,e)=>{const s=Math.max(i.credits/10,100),r=(2*t.sight+t.speed)/(t.cost/s+1);return(2*e.sight+e.speed)/(e.cost/s+1)-r}),[s[0].name])}(i,r),this.priority);const u=h[0],c=new t.Vector2(u.tile.rx,u.tile.ry);if(e.getCurrentTick()>=this.lastPositionCheckTick+60&&(this.lastPosition&&this.isUnitStuck(c)&&(this.logger(`Unit stuck at ${c.x},${c.y}, looking for new target`),this.setScoutTarget(null,e.getCurrentTick())),this.lastPosition=c,this.lastPositionCheckTick=e.getCurrentTick()),this.scoutTarget){if(this.hadUnit=!0,!this.scoutTargetIsPermanent){if(this.attemptsOnCurrentTarget>5)return this.logger(`Scout target ${this.scoutTarget.x},${this.scoutTarget.y} exceeded max attempts, switching to next target`),this.setScoutTarget(null,0),{type:"noop"};if(e.getCurrentTick()>this.scoutTargetRefreshedAt+600)return this.logger(`Scout target ${this.scoutTarget.x},${this.scoutTarget.y} taking too long, switching to next target`),this.setScoutTarget(null,0),{type:"noop"}}const i=e.mapApi.getTile(this.scoutTarget.x,this.scoutTarget.y);if(!i)throw new Error(`Target position ${this.scoutTarget.x},${this.scoutTarget.y} does not exist`);if(e.getCurrentTick()>this.lastMoveCommandTick+30){this.lastMoveCommandTick=e.getCurrentTick(),h.forEach(e=>{this.scoutTarget&&s.orderUnits([e.id],t.OrderType.AttackMove,this.scoutTarget.x,this.scoutTarget.y)});const i=h.map(t=>o(t.tile,this.scoutTarget)),r=Math.min(...i);(!this.scoutMinDistance||r<this.scoutMinDistance)&&(this.logger(`Unit approaching target point (${r} < ${this.scoutMinDistance})`),this.scoutTargetRefreshedAt=e.getCurrentTick(),this.scoutMinDistance=r)}if(e.mapApi.isVisibleTile(i,r.name)){const t=`${this.scoutTarget.x},${this.scoutTarget.y}`;this.visitedPoints.add(t),this.logger(`Target ${this.scoutTarget.x},${this.scoutTarget.y} scouted successfully, switching to next target`),this.setScoutTarget(null,e.getCurrentTick())}}else{const t=n.getScoutingManager().getNewScoutTarget();if(t)return this.setScoutTarget(t.asVector2(),e.getCurrentTick()),{type:"noop"};const i=this.getNextAmphibiousTarget(e,c,r);if(!i)return this.logger("No reachable amphibious exploration points found, mission ended"),p();this.setScoutTarget(i,e.getCurrentTick())}return{type:"noop"}}setScoutTarget(t,e){this.attemptsOnCurrentTarget=0,this.scoutTargetRefreshedAt=e,this.scoutTarget=t,this.scoutMinDistance=void 0,this.scoutTargetIsPermanent=!1,this.lastPosition=null,this.lastPositionCheckTick=e}getGlobalDebugText(){return"Amphibious scouting"}getPriority(){return this.priority}}class ht{constructor(t=-300,e){this.lastScoutAt=t,this.eventBus=e,this.navalMode=!1,this.eventBus&&this.eventBus.subscribe(t=>{"modeChanged"===t.type&&(this.navalMode=t.isNaval)})}getName(){return"AmphibiousScoutingMissionFactory"}maybeCreateMissions(t,e,i,s,r,n){this.navalMode&&(t.getCurrentTick()<this.lastScoutAt+300||i.getScoutingManager().hasScoutTargets()&&(s.addMission(new ot("amphibiousScout",10,n))||(this.lastScoutAt=t.getCurrentTick())))}onMissionFailed(t,e,i,s,r,n,a){this.navalMode&&(t.getCurrentTick()<this.lastScoutAt+300||i.getScoutingManager().hasScoutTargets()&&s instanceof ot&&(n.addMission(new ot("amphibiousScout",10,a)),this.lastScoutAt=t.getCurrentTick()))}}class ut extends g{hasClearWaterLoS(e,i,s,r=1){const n=s.x-i.x,a=s.y-i.y,o=Math.max(Math.abs(n),Math.abs(a));if(0===o)return!0;for(let s=0;s<=o;s++){const h=Math.round(i.x+n*s/o),u=Math.round(i.y+a*s/o);for(let i=-r;i<=r;i++)for(let s=-r;s<=r;s++){const r=h+i,n=u+s,a=e.mapApi.getTile(r,n);if(!a)return!1;if(a.landType!==t.LandType.Clear&&a.landType!==t.LandType.Water||void 0!==a.onBridgeLandType)return!1}}return!0}findWaterFiringPoint(e,i,s,r=10){for(let n=0;n<r;n++){const r=e.generateRandom()*Math.PI*2,n=i+e.generateRandom()*(s-i),a=this.targetPos.add(new t.Vector2(Math.round(t.GameMath.cos(r)*n),Math.round(t.GameMath.sin(r)*n))),o=e.mapApi.getTile(a.x,a.y);if(o&&(o.landType===t.LandType.Water&&void 0===o.onBridgeLandType&&this.hasClearWaterLoS(e,a,this.targetPos)))return a}return null}pushToPointSafe(t,e,i,s,r){t.mapApi.getTile(r.x,r.y)&&e.push(E.toPoint(i,s,r))}constructor(t,e,i){super(t,i),this.requiredUnits=null,this.stage="gather",this.patrolPoints=[],this.currentPatrolIdx=0,this.lastHostileTick=0,this.initialized=!1,this.lastRepositionTick=0,this.targetPos=e,this.shipyardId=null,this.rallyPoint=e}getPriority(){return 80}isUnitsLocked(){return!1}getGlobalDebugText(){return`AntiShipyard  (${this.targetPos.x},${this.targetPos.y})`}_onAiUpdate(e,i,s,r,n,a){if(!this.initialized){const i=this.getUnits(e);let s=this.targetPos;const n=e.getVisibleUnits(r.name,"self",t=>"GAYARD"===t.name||"NAYARD"===t.name||"CAYARD"===t.name);if(n.length>0){const i=e.getUnitData(n[0]);i&&(s=new t.Vector2(i.tile.rx,i.tile.ry))}if(i.length>0){const e=i[0];s=new t.Vector2(e.tile.rx,e.tile.ry)}const a=e.mapApi.getTile(s.x,s.y),o=e.mapApi.getTile(this.targetPos.x,this.targetPos.y);let h=s;if(a&&o){const i=e.mapApi.findPath(t.SpeedType.Float,!1,{tile:a,onBridge:!1},{tile:o,onBridge:!1});if(i&&i.length>2){const e=i[Math.floor(i.length/5*4)];h=new t.Vector2(e.tile.rx,e.tile.ry)}}this.rallyPoint=h,this.initialized=!0}if(!this.requiredUnits){const t=L(i);t("SUB2")?this.requiredUnits={SUB2:3}:t("SUB")?this.requiredUnits={SUB:3}:t("DLPH")?this.requiredUnits={DLPH:5}:this.requiredUnits={}}const o=U(this.getUnitsGameObjectData(e),t=>t.name),h=Object.entries(this.requiredUnits).filter(([t,e])=>(o[t]||0)<e);if(h.length>0)return m(h.map(([t])=>t),this.getPriority());const u=this.getUnits(e);if("gather"===this.stage){if(!u.every(e=>new t.Vector2(e.tile.rx,e.tile.ry).distanceTo(this.rallyPoint)<=4))return u.forEach(i=>{this.pushToPointSafe(e,a,i.id,t.OrderType.Move,this.rallyPoint)}),{type:"noop"};if(0===this.patrolPoints.length)for(let e=0;e<3;e++){const i=2*Math.PI*e/3,s=this.targetPos.add(new t.Vector2(Math.round(6*t.GameMath.cos(i)),Math.round(6*t.GameMath.sin(i))));this.patrolPoints.push(s)}this.stage="approach",this.lastHostileTick=e.getCurrentTick()}if("approach"===this.stage){if(!u.every(e=>new t.Vector2(e.tile.rx,e.tile.ry).distanceTo(this.targetPos)<=12))return u.forEach(i=>{this.pushToPointSafe(e,a,i.id,t.OrderType.AttackMove,this.targetPos)}),{type:"noop"};this.stage="patrol"}if(n.getHostilesNearPoint2d(this.targetPos,12).length>0&&(this.lastHostileTick=e.getCurrentTick()),"patrol"===this.stage){const i=e.getVisibleUnits(r.name,"enemy").map(t=>e.getUnitData(t)).filter(e=>{if(!e)return!1;return new t.Vector2(e.tile.rx,e.tile.ry).distanceTo(this.targetPos)<=12&&e.rules.speedType===t.SpeedType.Float});if(i.length>0)return this.lastHostileTick=e.getCurrentTick(),u.forEach(e=>{let s=i[0],r=new t.Vector2(e.tile.rx,e.tile.ry).distanceTo(new t.Vector2(s.tile.rx,s.tile.ry));for(const n of i){const i=new t.Vector2(e.tile.rx,e.tile.ry).distanceTo(new t.Vector2(n.tile.rx,n.tile.ry));i<r&&(s=n,r=i)}s&&a.push(E.toTargetId(e.id,t.OrderType.Attack,s.id))}),{type:"noop"};if(!(e.getCurrentTick()-this.lastHostileTick>45))return u.forEach(i=>{const s=new t.Vector2(e.generateRandomInt(-2,2),e.generateRandomInt(-2,2)),r=this.targetPos.add(s);this.pushToPointSafe(e,a,i.id,t.OrderType.Move,r)}),{type:"noop"};this.stage="destroy"}const c=e.getVisibleUnits(r.name,"enemy",t=>"GAYARD"===t.name||"NAYARD"===t.name||"CAYARD"===t.name).map(t=>e.getUnitData(t)).filter(t=>!!t),l=e.getVisibleUnits(r.name,"enemy").map(t=>e.getUnitData(t)).filter(e=>{if(!e)return!1;return new t.Vector2(e.tile.rx,e.tile.ry).distanceTo(this.targetPos)<=12&&e.rules.speedType===t.SpeedType.Float});if(l.length>0)return u.forEach(e=>{let i=l[0],s=new t.Vector2(e.tile.rx,e.tile.ry).distanceTo(new t.Vector2(i.tile.rx,i.tile.ry));for(const r of l){const n=new t.Vector2(e.tile.rx,e.tile.ry).distanceTo(new t.Vector2(r.tile.rx,r.tile.ry));n<s&&(i=r,s=n)}a.push(E.toTargetId(e.id,t.OrderType.Attack,i.id))}),{type:"noop"};if(c.length>0){const i=c[0];u.forEach(s=>{const r=new t.Vector2(s.tile.rx,s.tile.ry);if(this.hasClearWaterLoS(e,r,this.targetPos))a.push(E.toTargetId(s.id,t.OrderType.Attack,i.id));else{if(e.getCurrentTick()-this.lastRepositionTick<30)return;const i=this.findWaterFiringPoint(e,5,8);i?(this.pushToPointSafe(e,a,s.id,t.OrderType.AttackMove,i),this.lastRepositionTick=e.getCurrentTick()):this.pushToPointSafe(e,a,s.id,t.OrderType.AttackMove,this.targetPos)}})}else u.forEach(i=>{this.pushToPointSafe(e,a,i.id,t.OrderType.AttackMove,this.targetPos)});return{type:"noop"}}}class ct{maybeCreateMissions(e,i,s,r,n,a){if(r.getMissions().some(t=>t instanceof ut))return;const o=e.getVisibleUnits(i.name,"enemy",t=>"GAYARD"===t.name||"NAYARD"===t.name||"CAYARD"===t.name);if(0===o.length)return;const h=e.getUnitData(o[0]);if(!h)return;const u=new t.Vector2(h.tile.rx,h.tile.ry),c=new ut("antiShipyard_"+e.getCurrentTick(),u,a);r.addMission(c)}getName(){return"AntiShipyardMissionFactory"}onMissionFailed(t,e,i,s,r,n,a){}}function lt(t,e,i,s,r){t.mapApi.getTile(r.x,r.y)&&e.push(E.toPoint(i,s,r))}class gt extends g{constructor(t,e,i,s){super(t,s),this.requiredUnits={MTNK:3},this.stage="gather",this.targetId=e,this.targetPos=i}getPriority(){return 500}isUnitsLocked(){return!1}getGlobalDebugText(){return`AntiCoast  DEST#${this.targetId}`}_onAiUpdate(e,i,s,r,n,a){const o=e.getUnitData(this.targetId);if(!o)return p();this.targetPos.set(o.tile.rx,o.tile.ry);const h=U(this.getUnitsGameObjectData(e),t=>t.name),u=Object.entries(this.requiredUnits).filter(([t,e])=>(h[t]||0)<e);if(u.length>0){m(u.map(([t])=>t),this.getPriority());return A(r.startLocation,this.getPriority())}const c=this.getUnits(e);if("gather"===this.stage){const i=r.startLocation;if(!c.every(e=>new t.Vector2(e.tile.rx,e.tile.ry).distanceTo(i)<=4))return c.forEach(s=>lt(e,a,s.id,t.OrderType.Move,i)),{type:"noop"};this.stage="attack"}return c.forEach(i=>{lt(e,a,i.id,t.OrderType.AttackMove,this.targetPos)}),{type:"noop"}}}class pt{getName(){return"AntiCoastShipMissionFactory"}maybeCreateMissions(e,i,s,r,n,a){if(r.getMissions().some(t=>t instanceof gt))return;const o=["DEST","AEGIS","CARRIER","DRED","HYD"],h=e.getVisibleUnits(i.name,"enemy",t=>o.includes(t.name)).filter(s=>{const r=e.getUnitData(s);if(!r)return!1;if(r.rules.movementZone!==t.MovementZone.Water)return!1;try{const s=e.mapApi.getTile(i.startLocation.x,i.startLocation.y),n=e.mapApi.getTile(r.tile.rx,r.tile.ry);if(!s||!n)return!1;const a=e.mapApi.findPath(t.SpeedType.Track,!1,{tile:s,onBridge:!1},{tile:n,onBridge:!1});if(!a||0===a.length)return!1;const o=a[0];return new t.Vector2(o.tile.rx,o.tile.ry).distanceTo(new t.Vector2(r.tile.rx,r.tile.ry))<=6}catch(t){return!1}});if(0===h.length)return;const u=h[0],c=e.getUnitData(u);if(!c)return;const l=new t.Vector2(c.tile.rx,c.tile.ry),g=new gt("antiCoast_"+e.getCurrentTick(),u,l,a);r.addMission(g)}onMissionFailed(){}}class dt extends g{constructor(t,e,i){super(t,i),this.loggerCtx=i,this.dreadId=e}getDreadId(){return this.dreadId}getPriority(){return 101}isUnitsLocked(){return!0}getGlobalDebugText(){return`MixedEscortDRED#${this.dreadId}`}_onAiUpdate(e,i,s,r,n,a){const o=e.getUnitData(this.dreadId);if(!o)return p();const h=U(this.getUnitsGameObjectData(e),t=>t.name),u=h.SUB||0,c=h.HYD||0,l=[];if(u<3){const t=3-u;l.push(...Array(t).fill("SUB"))}if(c<2){const t=2-c;l.push(...Array(t).fill("HYD"))}if(l.length>0)return m(l,this.getPriority());const g=new t.Vector2(o.tile.rx,o.tile.ry);return this.getUnits(e).forEach(i=>{lt(e,a,i.id,t.OrderType.AttackMove,g)}),{type:"noop"}}}class mt{getName(){return"DreadEscortMissionFactory"}maybeCreateMissions(t,e,i,s,r,n){const a=t.getVisibleUnits(e.name,"self",t=>"DRED"===t.name);0!==a.length&&a.forEach(t=>{if(!s.getMissions().some(e=>e instanceof dt&&e.getDreadId()===t)){const e=new dt(`escortDred_${t}`,t,n);s.addMission(e)}})}onMissionFailed(){}}class yt extends g{constructor(t,e,i,s,r){super(t,r),this.harvesterId=e,this.radius=s,this.priority=10,this.squad=new I(i,i,s)}_onAiUpdate(e,i,s,r,n,a){const o=e.getUnitData(this.harvesterId);if(!o||o.owner!==r.name||!o.rules?.harvester)return this.logger(`Harvester ${this.harvesterId} lost  disbanding defence mission`),p();const h=new t.Vector2(o.tile.rx,o.tile.ry);this.squad.setAttackArea(h);const u=this.squad.onAiUpdate(e,s,a,r,this,n,this.logger);if("noop"!==u.type)return u;return 0===n.getHostilesNearPoint2d(h,this.radius).map(({unitId:t})=>e.getUnitData(t)).filter(t=>!!t).filter(t=>!v(t)).length?(this.priority=0,this.getUnitIds().length>0?w(this.getUnitIds()):{type:"noop"}):(this.priority=100,A(h,2*this.radius))}getGlobalDebugText(){return this.squad.getGlobalDebugText()}getPriority(){return this.priority}}class ft{constructor(){this.lastCheckAt=0}getName(){return"HarvesterDefenceMissionFactory"}maybeCreateMissions(e,i,s,r,n,a){if(e.getCurrentTick()<this.lastCheckAt+600)return;this.lastCheckAt=e.getCurrentTick();e.getVisibleUnits(i.name,"self",t=>t.harvester).forEach(n=>{const o=e.getUnitData(n);if(!o)return;if(0===s.getHostilesNearPoint2d(new t.Vector2(o.tile.rx,o.tile.ry),10).length)return;const h=`harvesterDefence_${n}`;if(r.getMissions().some(t=>t.getUniqueName()===h))return;const u=new yt(h,n,i.startLocation,10,a);r.addMission(u)})}onMissionFailed(t,e,i,s,r,n,a){}}class Tt{constructor(t,e){this.eventBus=t,this.logger=e,this.missions=[],this.unitIdToMission=new Map,this.requestedUnitTypes=new Map,this.forceDisbandedMissions=[],this.missionFactories=(t=>[new P,new X,new z(t),new J,new et,new nt(-300,t),new ht(-300,t),new ct,new pt,new ft,new mt])(this.eventBus)}updateUnitIds(t){this.unitIdToMission=new Map,this.missions.forEach(e=>{const i=[];e.getUnitIds().forEach(s=>{this.unitIdToMission.has(s)?this.logger(`WARNING: unit ${s} is in multiple missions, please debug.`):t.getGameObjectData(s)?this.unitIdToMission.set(s,e):i.push(s)}),i.forEach(t=>e.removeUnit(t))})}onAiUpdate(e,i,s,r,n){this.missions=this.missions.filter(t=>t.isActive()),this.updateUnitIds(e);const a=new N,o=this.missions.map(t=>({mission:t,action:t.onAiUpdate(e,i,s,r,n,a)})),h=new Map,u=[];this.forceDisbandedMissions.forEach(t=>h.set(t,null)),this.forceDisbandedMissions=[],o.filter(d).forEach(t=>{this.logger(`Mission ${t.mission.getUniqueName()} disbanding as requested.`),t.mission.getUnitIds().forEach(t=>{this.unitIdToMission.delete(t),s.setUnitDebugText(t,void 0)}),h.set(t.mission.getUniqueName(),t.action.reason)}),this.missions.filter(t=>h.has(t.getUniqueName())).forEach(t=>{const e=h.get(t.getUniqueName());this.logger(`mission disbanded: ${t.getUniqueName()}, reason: ${e}`),u.push({mission:t,reason:e}),t.endMission(h.get(t.getUniqueName()))}),this.missions=this.missions.filter(t=>!h.has(t.getUniqueName())),o.filter(M).forEach(t=>{t.action.unitIds.forEach(e=>{this.unitIdToMission.get(e)?.getUniqueName()===t.mission.getUniqueName()&&this.removeUnitFromMission(t.mission,e,s)})});const c=o.filter(T).reduce((t,e)=>{const{unitIds:i}=e.action;return i.forEach(i=>{t.hasOwnProperty(i)?t[i].action.priority>t[i].action.priority&&(t[i]=e):t[i]=e}),t},{}),l=Object.entries(c).flatMap(([t,i])=>{const r=Number.parseInt(t),n=e.getGameObjectData(r),{mission:a}=i,o=a.getUniqueName();return n?this.unitIdToMission.has(r)?[]:(this.addUnitToMission(a,n,s),[{unitName:n?.name,mission:a.getUniqueName()}]):(this.logger(`mission ${o} requested non-existent unit ${r}`),[])}).reduce((t,e)=>(t[e.mission]||(t[e.mission]={}),t[e.mission][e.unitName]||(t[e.mission][e.unitName]=0),t[e.mission][e.unitName]=t[e.mission][e.unitName]+1,t),{});Object.entries(l).forEach(([t,e])=>{this.logger(`Mission ${t} received: ${Object.entries(e).map(([t,e])=>t+" x "+e).join(", ")}`)});const g=o.filter(y).reduce((t,e)=>{const{unitNames:i}=e.action;return i.forEach(i=>{t.hasOwnProperty(i)?t[i].action.priority>t[i].action.priority&&(t[i]=e):t[i]=e}),t},{}),p=o.filter(b),m=e.getVisibleUnits(r.name,"self").map(t=>e.getGameObjectData(t)).filter(t=>!!t).map(t=>({unit:t,mission:this.unitIdToMission.get(t.id)})).filter(t=>!t.mission||!1===t.mission.isUnitsLocked());m.sort((t,e)=>(t.mission?.getPriority()??0)-(e.mission?.getPriority()??0));const f=m.flatMap(({unit:e,mission:i})=>{if(g.hasOwnProperty(e.name)){const{mission:t}=g[e.name];if(i){if(i===t||i.getPriority()>t.getPriority())return[];this.removeUnitFromMission(i,e.id,s)}return this.logger(`granting unit ${e.id}#${e.name} to mission ${t.getUniqueName()}`),this.addUnitToMission(t,e,s),delete g[e.name],[{unitName:e.name,missionName:t.getUniqueName(),method:"type"}]}if(p.length>0){const r=p.find(i=>{var s;return!!(s=e)&&!!s?.rules?.isSelectableCombatant&&i.action.point.distanceTo(new t.Vector2(e.tile.rx,e.tile.ry))<=i.action.radius});if(r){if(i){if(i===r.mission||i.getPriority()>r.mission.getPriority())return[];this.removeUnitFromMission(i,e.id,s)}return this.addUnitToMission(r.mission,e,s),[{unitName:e.name,missionName:r.mission.getUniqueName(),method:"grab"}]}}return[]}).reduce((t,e)=>(t[e.missionName]||(t[e.missionName]={}),t[e.missionName][e.unitName]||(t[e.missionName][e.unitName]={grab:0,type:0}),t[e.missionName][e.unitName][e.method]=t[e.missionName][e.unitName][e.method]+1,t),{});Object.entries(f).forEach(([t,e])=>{this.logger(`Mission ${t} received: ${Object.entries(e).flatMap(([t,e])=>Object.entries(e).filter(([,t])=>t>0).map(([e,i])=>t+" x "+i+" (by "+e+")")).join(", ")}`)}),this.updateRequestedUnitTypes(g),a.resolve(s),this.missionFactories.forEach(t=>{t.maybeCreateMissions(e,r,n,this,i,this.logger),u.forEach(({reason:i,mission:s})=>{t.onMissionFailed(e,r,n,s,i,this,this.logger)})})}updateRequestedUnitTypes(t){const e=Array.from(this.requestedUnitTypes.keys());for(const t of e){const e=.75*this.requestedUnitTypes.get(t)-1;e>.5?this.requestedUnitTypes.set(t,e):this.requestedUnitTypes.delete(t)}Object.entries(t).forEach(([t,e])=>{const i=this.requestedUnitTypes.get(t);this.requestedUnitTypes.set(t,i?Math.max(i,e.action.priority):e.action.priority)})}getRequestedUnitTypes(){return this.requestedUnitTypes}addUnitToMission(t,e,i){t.addUnit(e.id),this.unitIdToMission.set(e.id,t),i.setUnitDebugText(e.id,t.getUniqueName()+"_"+e.id)}removeUnitFromMission(t,e,i){t.removeUnit(e),this.unitIdToMission.delete(e),i.setUnitDebugText(e,void 0)}addMission(t){return this.missions.some(e=>e.getUniqueName()===t.getUniqueName())?null:(this.logger(`Added mission: ${t.getUniqueName()}`),this.missions.push(t),t)}disbandMission(t){this.forceDisbandedMissions.push(t)}getGlobalDebugText(t){let e="";return this.missions.forEach(i=>{var s;this.logger(`Mission ${i.getUniqueName()}: ${Object.entries((s=i.getUnitIds(),U(s,e=>t.getGameObjectData(e)?.name))).map(([t,e])=>`${t} x ${e}`).join(", ")}`);const r=i.getGlobalDebugText();r&&(e+=i.getUniqueName()+": "+r+"\n")}),e}updateDebugText(t){this.missions.forEach(e=>{e.getUnitIds().forEach(i=>t.setUnitDebugText(i,`${i}: ${e.getUniqueName()}`))})}getMissions(){return this.missions}}class At{constructor(t,e,i,s){this.basePriority=t,this.baseAmount=e,this.groundStrength=i,this.limit=s}getPlacementLocation(t,e,i){return((t,e,i)=>{const{startLocation:r,name:n}=e,a=t.getPlayers().filter(e=>e!==n&&!t.areAlliedPlayers(e,n)).map(e=>{const i=t.getPlayerData(e);return s(t,r,i.startLocation,4,16,1.5)});if(0===a.length)return;const o=a[Math.floor(t.generateRandom()*a.length)];return Ot(t,e,o,i,!1,2)})(t,e,i)}getPriority(t,e,i,s){const r=Et(t,e,i);if(r>=this.limit)return 0;if(s){let t=s.totalAvailableAntiGroundFirepower+s.totalDefensivePower+this.groundStrength;return s.totalOffensiveLandThreat>1.1*t?this.basePriority*(s.totalOffensiveLandThreat/Math.max(1,t)):0}const n=this.groundStrength/i.cost*1e3;return this.basePriority*(1-r/this.baseAmount)*n}getMaxCount(t,e,i,s){return null}}class bt{constructor(t,e,i,s){this.basePriority=t,this.artilleryPower=e,this.antiGroundPower=i,this.baseAmount=s}getPlacementLocation(t,e,i){}getPriority(t,e,i,s){return 0}getMaxCount(t,e,i,s){return null}}class wt{constructor(t,e,i=1,s=0){this.basePriority=t,this.baseAmount=e,this.antiGroundPower=i,this.antiAirPower=s}getPlacementLocation(t,e,i){}getPriority(t,e,i,s){return 0}getMaxCount(t,e,i,s){return null}}class Mt{constructor(t,e,i){this.basePriority=t,this.maxNeeded=e,this.onlyBuildWhenFloatingCreditsAmount=i}getPlacementLocation(t,e,i){return Ot(t,e,e.startLocation,i)}getPriority(t,e,i,s){const r=Et(t,e,i);if(r>=(this.getMaxCount(t,e,i,s)??this.maxNeeded))return-100;const n=this.basePriority*(1-r/this.maxNeeded);return this.onlyBuildWhenFloatingCreditsAmount&&e.credits<this.onlyBuildWhenFloatingCreditsAmount?n*(e.credits/this.onlyBuildWhenFloatingCreditsAmount):n}getMaxCount(t,e,i,s){return this.maxNeeded}}class xt{constructor(t,e,i=1,s=0){this.basePriority=t,this.baseAmount=e,this.antiGroundPower=i,this.antiAirPower=s}getPlacementLocation(t,e,i){}getPriority(t,e,i,s){return 0}getMaxCount(t,e,i,s){return null}}class Pt{getPlacementLocation(t,e,i){return Ot(t,e,e.startLocation,i)}getPriority(t,e,i){return e.power.total<e.power.drain?100:e.power.total<e.power.drain+i.power/2?20:0}getMaxCount(t,e,i,s){return null}}var St=r(752);class vt extends Mt{constructor(t,e,i){super(t,e,i)}getPlacementLocation(e,i,s){let r=i.startLocation;var n,a;let o=e.mapApi.getAllTilesResourceData();for(let e=0;e<o.length;++e){let i=o[e];if(i.spawnsOre){let e=t.GameMath.sqrt(t.GameMath.pow(r.x-i.tile.rx,2)+t.GameMath.pow(r.y-i.tile.ry,2));(null==a||e<a)&&(a=e,n=i.tile)}}return n&&(r=new St.Vector2(n.rx,n.ry)),Ot(e,i,r,s)}getMaxCount(t,e,i,s){const r=t.getVisibleUnits(e.name,"self",t=>t.harvester).length;return Math.max(1,2*r)}}class Ct extends xt{constructor(t,e,i){super(t,e,0,0),this.minNeeded=i}getPriority(t,e,i,s){const r=t.getVisibleUnits(e.name,"self",t=>t.refinery).length,n=t.getVisibleUnits(e.name,"self",t=>t.harvester).length,a=n<this.minNeeded?3:n>3*r?0:1;return this.basePriority*(r/Math.max(n/2,1))*a}}class kt{constructor(t,e,i){this.basePriority=t,this.baseAmount=e,this.airStrength=i}getPlacementLocation(t,e,i){let r=e.startLocation,n=t.getPlayers(),a=[];for(let i=0;i<n.length;++i){let o=n[i];if(o==e.name)continue;let h=t.getPlayerData(o);a.push(s(t,r,h.startLocation,4,16,1.5))}let o=a[Math.floor(t.generateRandom()*a.length)];return Ot(t,e,o,i,!1,0)}getPriority(t,e,i,s){if(s){let t=s.totalAvailableAntiAirFirepower+this.airStrength;return s.totalOffensiveAirThreat>1.1*t?this.basePriority*(s.totalOffensiveAirThreat/Math.max(1,t)):0}const r=this.airStrength/i.cost*1e3,n=Et(t,e,i);return this.basePriority*(1-n/this.baseAmount)*r}getMaxCount(t,e,i,s){return null}}class Ut extends Mt{constructor(t,e,i){super(t,e,i)}getPlacementLocation(t,e,i){return Ot(t,e,e.startLocation,i,!0,1)}getPriority(t,e,i,s){return super.getPriority(t,e,i,s)}}class Dt{constructor(t,e,i=1,s=0,r=1){this.basePriority=t,this.baseAmount=e,this.antiGroundPower=i,this.antiAirPower=s,this.antiNavalPower=r}getPlacementLocation(t,e,i){}getPriority(t,e,i,s){return 0}getMaxCount(t,e,i,s){return null}}function Et(t,e,i){return t.getVisibleUnits(e.name,"self",t=>t==i).length}function Nt(t,e,i,s){return{x:t.x-i-(s?.width||0),y:t.y-i-(s?.height||0),width:e.width+2*i+(s?.width||0),height:e.height+2*i+(s?.height||0)}}function Rt(e,i,s){return e.mapApi.getTilesInRect(i).filter(e=>!s||e.landType===t.LandType.Water)}function _t(e,i,s,r,n){const a=e.getBuildingPlacementData(s.name),{width:o,height:h}=a.foundation,u=[],c=e.getVisibleUnits(i.name,"self",e=>e.type===t.ObjectType.Building),l=new Set;for(let i of c){const c=e.getUnitData(i);if(!c?.rules?.baseNormal)continue;const{foundation:g,tile:p}=c,d=new t.Vector2(p.rx,p.ry),m={width:g?.width,height:g?.height},y=Rt(e,Nt(d,m,s.adjacent,a.foundation),r);if(0===y.length)continue;u.push(...y);const f=Nt(new t.Vector2(d.x-(o-1),d.y-(h-1)),{width:m.width+(o-1),height:m.height+(h-1)},n),T=y.filter(t=>t.rx>=f.x&&t.rx<f.x+f.width&&t.ry>=f.y&&t.ry<f.y+f.height);T.forEach(t=>l.add(t.id))}var g,p;return(g=u,p=t=>t.id,Object.values(g.reduce((t,e)=>{const i=p(e);return t[i]||(t[i]=e),t},{}))).filter(t=>!l.has(t.id))}function $t(e,i,s,r){var n=e-s,a=i-r;let o=n*n+a*a;return 0===o?0:t.GameMath.sqrt(o)}function Ot(t,e,i,s,r=!1,n=1){if(!t.getBuildingPlacementData(s.name))return;const a=function(t,e){return e.map(e=>({tile:e,distance:$t(e.rx,e.ry,t.x,t.y)})).sort((t,e)=>t.distance-e.distance)}(i,_t(t,e,s,r,n));for(let i of a)if(i.tile&&t.canPlaceBuilding(e.name,s.name,i.tile))return i.tile}const It=new Map([["GAPOWR",new Pt],["GAREFN",new vt(10,2)],["GAWEAP",new Mt(15,2)],["GAPILE",new Mt(12,1)],["CMIN",new Ct(15,3,2)],["GADEPT",new Mt(1,1,1e4)],["GAAIRC",new Mt(10,1,500)],["AMRADR",new Mt(10,1,500)],["GATECH",new Mt(20,1,4e3)],["GAYARD",new Ut(10,2)],["GAPILL",new At(2,1,5,5)],["ATESLA",new At(2,1,10,3)],["NASAM",new kt(2,1,5)],["GAWALL",new At(0,0,0,0)],["E1",new xt(2,2,.2,0)],["ENGINEER",new xt(1,0,0)],["MTNK",new xt(10,3,2,0)],["MGTK",new xt(10,1,2.5,0)],["FV",new xt(5,2,.5,1)],["JUMPJET",new wt(10,1,1,1)],["ORCA",new wt(7,1,2,0)],["SREF",new bt(10,5,3,3)],["CLEG",new xt(0,0)],["SHAD",new xt(0,0)],["NAPOWR",new Pt],["NAREFN",new vt(10,2)],["NAWEAP",new Mt(15,2)],["NAHAND",new Mt(12,1)],["HARV",new Ct(15,3,2)],["NADEPT",new Mt(1,1,1e4)],["NARADR",new Mt(10,1,500)],["NANRCT",new Pt],["NAYARD",new Ut(10,3)],["NATECH",new Mt(20,1,4e3)],["NALASR",new At(2,1,5,5)],["NAFLAK",new kt(2,1,5)],["TESLA",new At(2,1,10,3)],["NAWALL",new At(0,0,0,0)],["E2",new xt(2,2,.2,0)],["SENGINEER",new xt(1,0,0)],["FLAKT",new xt(2,2,.1,.3)],["YURI",new xt(1,1,1,0)],["DOG",new xt(1,1,0,0)],["HTNK",new xt(10,3,3,0)],["APOC",new xt(6,1,5,0)],["HTK",new xt(5,2,.33,1.5)],["ZEP",new wt(5,1,5,1)],["V3",new bt(9,10,0,3)],["DEST",new Dt(9,4,2,0,1)],["AEGIS",new Dt(8,0,0,6,0)],["CARRIER",new Dt(9,1,4,1,1)],["DLPH",new Dt(5,2,0,0,2)],["SUB",new Dt(9,4,0,0,4)],["HYD",new Dt(8,0,0,1.5,.1)],["DRED",new Dt(9,0,4,0,1)],["SQD",new Dt(5,2,0,0,5)],["CAPOWR",new Pt],["CAREFN",new vt(10,2)],["CAWEAP",new Mt(15,2)],["CAHAND",new Mt(12,1)],["CHAR",new Ct(15,3,2)],["CADEPT",new Mt(1,1,1e4)],["CARADR",new Mt(10,1,500)],["CANRCT",new Pt],["CAYARD",new Ut(10,3)],["CATECH",new Mt(20,1,4e3)],["CAARMR",new Mt(20,1,4e3)],["CAPILL",new At(2,1,5,5)],["MSAM",new kt(2,1,5)],["CTESLA",new At(2,1,10,3)],["CAWALL",new At(0,0,0,0)],["PLA",new xt(2,2,.2,0)],["GHOST2",new xt(2,2,.5,0)],["LTNK",new xt(10,3,3,0)],["HOWI",new xt(6,1,5,0)],["BGGY",new xt(5,2,.33,1.5)],["V32",new bt(9,10,0,3)]]),Vt=[t.QueueType.Structures,t.QueueType.Armory,t.QueueType.Infantry,t.QueueType.Vehicles,t.QueueType.Aircrafts,t.QueueType.Ships],Lt=e=>{switch(e){case t.QueueType.Structures:return"Structures";case t.QueueType.Armory:return"Armory";case t.QueueType.Infantry:return"Infantry";case t.QueueType.Vehicles:return"Vehicles";case t.QueueType.Aircrafts:return"Aircrafts";case t.QueueType.Ships:return"Ships";default:return"Unknown"}};class Gt{constructor(t){this.eventBus=t,this.queueStates=[],this.lastRepairCheckAt=0,this.navalMode=!1,this.lastCancelTicks=new Map,this.eventBus.subscribe(t=>{"modeChanged"===t.type&&(this.navalMode=t.isNaval)})}onAiUpdate(t,e,i,s,r,n,a){this.queueStates=Vt.map(i=>{const o=e.getAvailableObjects(i),h=this.getPrioritiesForBuildingOptions(t,o,r,s,n,a,i),u=h.length>0?h[h.length-1]:void 0;return{queue:i,items:h,topItem:u&&u.priority>0?u:void 0}});const o=this.queueStates.map(t=>t.topItem?.priority).reduce((t,e)=>t+e,0),h=this.queueStates.map(t=>t.topItem?.unit.cost).reduce((t,e)=>t+e,0);this.queueStates.forEach(n=>{this.updateBuildQueue(t,e,i,s,r,n.queue,n.topItem,o,h,a)}),s.credits>0&&t.getCurrentTick()>this.lastRepairCheckAt+30&&(t.getVisibleUnits(s.name,"self",t=>t.repairable).forEach(e=>{const s=t.getUnitData(e);s&&s.hitPoints&&s.maxHitPoints&&!s.hasWrenchRepair&&s.hitPoints<s.maxHitPoints&&i.toggleRepairWrench(e)}),this.lastRepairCheckAt=t.getCurrentTick())}updateBuildQueue(e,i,s,r,n,a,o,h,u,c){const l=r.credits,g=i.getQueueData(a);if(g.status==t.QueueStatus.Idle)void 0!==o&&(c(`Decision (${Lt(a)}): ${o.unit.name}`),s.queueForProduction(a,o.unit.name,o.unit.type,1));else if(g.status==t.QueueStatus.Ready&&g.items.length>0){const i=g.items[0].rules;if(a==t.QueueType.Structures||a==t.QueueType.Armory){let t=this.getBestLocationForStructure(e,r,i);void 0!==t?(c(`Completed: ${Lt(a)}: ${i.name}, placing at ${t.rx},${t.ry}`),s.placeBuilding(i.name,t.rx,t.ry)):(c(`Completed: ${Lt(a)}: ${i.name} but nowhere to place it`),"GAYARD"!==i.name&&"NAYARD"!==i.name||this.eventBus.publish({type:"yardFailed",player:r.name}),s.unqueueFromProduction(a,i.name,i.type,1))}}else if(g.status==t.QueueStatus.Active&&g.items.length>0&&null!=o){const t=g.items[0].rules;if(o.unit!=t){let i=this.getPriorityForBuildingOption(t,e,r,n,a),h=o.priority;const u=this.lastCancelTicks.get(a)??0,l=900;h>3*i&&e.getCurrentTick()-u>l&&(c(`Dequeueing queue ${Lt(g.type)} unit ${t.name} because ${o.unit.name} has 2x higher priority.`),s.unqueueFromProduction(g.type,t.name,t.type,1),this.lastCancelTicks.set(a,e.getCurrentTick()))}else u>l&&o.priority<.25*h&&(c(`Pausing queue ${Lt(g.type)} because weight is low (${o.priority}/${h})`),s.pauseProduction(g.type))}else g.status==t.QueueStatus.OnHold&&(l>=u?(c(`Resuming queue ${Lt(g.type)} because credits are high`),s.resumeProduction(g.type)):o&&o.priority>=.25*h&&(c(`Resuming queue ${Lt(g.type)} because weight is high (${o.priority}/${h})`),s.resumeProduction(g.type)))}getPrioritiesForBuildingOptions(t,e,i,s,r,n,a){let o=[];return e.forEach(e=>{const n=e.name,h="GAYARD"===n||"NAYARD"===n,u="GAWEAP"===n||"NAWEAP"===n;if(h||u){const e=t.getVisibleUnits(s.name,"self",t=>t.name===n).length;if(h){if(!this.navalMode)return;if(e>=4)return}else if(u){if(e>=(this.navalMode?1:4))return}}const c=this.getPriorityForBuildingOption(e,t,s,i,a),l=Math.max(c,r.get(e.name)??c),g=l+1e-5*t.generateRandom();l>0&&o.push({unit:e,priority:g})}),o=o.sort((t,e)=>t.priority-e.priority),o}getPriorityForBuildingOption(e,i,s,r,n){if(It.has(e.name)){return It.get(e.name).getPriority(i,s,e,r)}{const r=i.getVisibleUnits(s.name,"self",t=>t==e).length;return(n===t.QueueType.Structures||n===t.QueueType.Armory)&&0===r?1:0-r}}getBestLocationForStructure(t,e,i){if(It.has(i.name)){return It.get(i.name).getPlacementLocation(t,e,i)}return Ot(t,e,e.startLocation,i)}getGlobalDebugText(e,i){return`Production: ${Vt.reduce((e,s)=>{if(0===i.getQueueData(s).size)return e;const r=i.getQueueData(s).status===t.QueueStatus.OnHold;return e+" ["+Lt(s)+(r?" PAUSED":"")+": "+i.getQueueData(s).items.map(t=>t.rules.name+(t.quantity>1?"x"+t.quantity:""))+"]"},"")}\n${this.queueStates.filter(t=>t.items.length>0).map(t=>{const e=t.items.map(t=>t.unit.name+"("+Math.round(10*t.priority)/10+")").join(", ");return`${Lt(t.queue)} Prios: ${e}\n`}).join("")}`}}class qt{constructor(t,e,i,s,r,n,a,o,h){this.certainty=t,this.totalOffensiveLandThreat=e,this.totalOffensiveAirThreat=i,this.totalOffensiveAntiAirThreat=s,this.totalDefensiveThreat=r,this.totalDefensivePower=n,this.totalAvailableAntiGroundFirepower=a,this.totalAvailableAntiAirFirepower=o,this.totalAvailableAirPower=h}}function Bt(t,e){return jt(t,e,t=>t.isAntiGround)}function Ft(t,e){return jt(t,e,t=>t.isAntiAir)}function jt(t,e,i){const s=l(t,e);if(!s||!s.primary&&!s.secondary)return!1;const r=s.primary?t.rulesApi.getWeapon(s.primary):null,n=Ht(t,r);if(n&&i(n))return!0;const a=s.secondary?t.rulesApi.getWeapon(s.secondary):null,o=Ht(t,a);return!(!o||!i(o))}function Ht(t,e){return e?t.rulesApi.getProjectile(e.projectile):null}function Qt(e,i){let s=0;return i.forEach(i=>{const r=e.getGameObjectData(i);r&&(s+=function(e,i){const s=l(e,i.id);if(!s)return 0;const r=i?.hitPoints||0,n=i?.maxHitPoints||0;let a=0;const o=r/Math.max(1,n);if(s.primary){const i=e.rulesApi.getWeapon(s.primary);a+=o*((i.damage+1)*t.GameMath.sqrt(i.range+1))/Math.max(i.rof,1)}if(s.secondary){const i=e.rulesApi.getWeapon(s.secondary);a+=o*((i.damage+1)*t.GameMath.sqrt(i.range+1))/Math.max(i.rof,1)}return Math.min(800,a)}(e,r))}),s}class Wt{constructor(t,e=0){this.bounds={x:t.x||0,y:t.y||0,width:t.width,height:t.height},this.maxObjects="number"==typeof t.maxObjects?t.maxObjects:10,this.maxLevels="number"==typeof t.maxLevels?t.maxLevels:4,this.level=e,this.objects=[],this.nodes=[]}getIndex(t){return t.qtIndex(this.bounds)}split(){const t=this.level+1,e=this.bounds.width/2,i=this.bounds.height/2,s=this.bounds.x,r=this.bounds.y,n=[{x:s+e,y:r},{x:s,y:r},{x:s,y:r+i},{x:s+e,y:r+i}];for(let s=0;s<4;s++)this.nodes[s]=new Wt({x:n[s].x,y:n[s].y,width:e,height:i,maxObjects:this.maxObjects,maxLevels:this.maxLevels},t)}insert(t){if(this.nodes.length){const e=this.getIndex(t);for(let i=0;i<e.length;i++)this.nodes[e[i]].insert(t);return}if(this.objects.push(t),this.objects.length>this.maxObjects&&this.level<this.maxLevels){this.nodes.length||this.split();for(let t=0;t<this.objects.length;t++){const e=this.getIndex(this.objects[t]);for(let i=0;i<e.length;i++)this.nodes[e[i]].insert(this.objects[t])}this.objects=[]}}retrieve(t){const e=this.getIndex(t);let i=this.objects;if(this.nodes.length)for(let s=0;s<e.length;s++)i=i.concat(this.nodes[e[s]].retrieve(t));return 0===this.level?Array.from(new Set(i)):i}remove(t,e=!1){const i=this.objects.indexOf(t);i>-1&&this.objects.splice(i,1);for(let e=0;e<this.nodes.length;e++)this.nodes[e].remove(t);return 0!==this.level||e||this.join(),-1!==i}update(t,e=!1){this.remove(t,e),this.insert(t)}join(){let t=Array.from(this.objects);for(let e=0;e<this.nodes.length;e++){const i=this.nodes[e].join();t=t.concat(i)}const e=Array.from(new Set(t));if(e.length<=this.maxObjects){this.objects=e;for(let t=0;t<this.nodes.length;t++)this.nodes[t].objects=[];this.nodes=[]}return t}clear(){this.objects=[];for(let t=0;t<this.nodes.length;t++)this.nodes.length&&this.nodes[t].clear();this.nodes=[]}}class Yt{constructor(t){this.x=t.x,this.y=t.y,this.r=t.r,this.data=t.data}qtIndex(t){const e=[],i=t.width/2,s=t.height/2,r=t.x+i,n=t.y+s,a=[[r,t.y],[t.x,t.y],[t.x,n],[r,n]];for(let t=0;t<a.length;t++)Yt.intersectRect(this.x,this.y,this.r,a[t][0],a[t][1],a[t][0]+i,a[t][1]+s)&&e.push(t);return e}static intersectRect(t,e,i,s,r,n,a){const o=t-Math.max(s,Math.min(t,n)),h=e-Math.max(r,Math.min(e,a));return o*o+h*h<i*i}}var zt=r(738);class Kt{constructor(t,e,i=!1){if(this.permanent=i,e.hasOwnProperty("x")&&e.hasOwnProperty("y"))this._targetPoint=e;else{if(!e.hasOwnProperty("sectorStartPoint"))throw new TypeError(`invalid object passed as target: ${e}`);this._targetSector=e}this._priority=t}get priority(){return this._priority}asVector2(){return this._targetPoint??this._targetSector?.sectorStartPoint??null}get targetSector(){return this._targetSector}get isPermanent(){return this.permanent}}class Xt{constructor(t){this.logger=t,this.queuedRadius=2,this.scoutingQueue=new zt.PriorityQueue((t,e)=>e.priority-t.priority)}addRadiusToScout(e,i,s,r,n){const{x:a,y:o}=i,{width:h,height:u}=s.getSectorBounds(),c=s.getSectorCoordinatesForWorldPosition(a,o);if(c)for(let i=Math.max(0,c.sectorX-r);i<Math.min(h,c.sectorX+r);++i)for(let a=Math.max(0,c.sectorY-r);a<Math.min(u,c.sectorY+r);++a){if(i===c?.sectorX&&a===c?.sectorY)continue;const r=t.GameMath.pow(i-c.sectorX,2)+t.GameMath.pow(a-c.sectorY,2),o=s.getSector(i,a);if(o){const i=[];i.push(o.sectorStartPoint),i.push(new t.Vector2(o.sectorStartPoint.x+Math.floor(4),o.sectorStartPoint.y+Math.floor(4))),i.push(new t.Vector2(Math.min(o.sectorStartPoint.x+8-1,s.getMapBounds().width-1),Math.min(o.sectorStartPoint.y+8-1,s.getMapBounds().height-1))),i.forEach(t=>{if(!e.mapApi.getTile(t.x,t.y))return;const i=new Kt(n-r,t);this.scoutingQueue.enqueue(i)})}}}ensureEnemyStartLocations(t,e){t.mapApi.getStartingLocations().filter(t=>t!==e.startLocation).forEach(i=>{const s=t.mapApi.getTile(i.x,i.y);if(!s)return;if(t.mapApi.isVisibleTile(s,e.name))return;i.x,i.y;this.scoutingQueue.toArray().some(t=>{const e=t.asVector2();return e&&e.x===i.x&&e.y===i.y})||(this.logger(`Re-queue unseen enemy spawn at ${i.x},${i.y}`),this.scoutingQueue.enqueue(new Kt(100,i,!0)))})}onGameStart(t,e,i){t.mapApi.getStartingLocations().filter(i=>{if(i==e.startLocation)return!1;let s=t.mapApi.getTile(i.x,i.y);return!!s&&!t.mapApi.isVisibleTile(s,e.name)}).map(t=>new Kt(100,t,!0)).forEach(t=>{this.logger(`Adding ${t.asVector2()?.x},${t.asVector2()?.y} to initial scouting queue`),this.scoutingQueue.enqueue(t)}),this.addRadiusToScout(t,e.startLocation,i,2,1e3)}onAiUpdate(t,e,i){this.ensureEnemyStartLocations(t,e);const s=this.scoutingQueue.front();if(!s)return;const r=s.asVector2();if(!r)return void this.scoutingQueue.dequeue();const{x:n,y:a}=r,o=t.mapApi.getTile(n,a);o&&t.mapApi.isVisibleTile(o,e.name)&&(this.logger("head point is visible, dequeueing"),this.scoutingQueue.dequeue());const h=Math.floor(t.getCurrentTick()/9e3);h>this.queuedRadius&&(this.logger(`expanding scouting radius from ${this.queuedRadius} to ${h}`),this.addRadiusToScout(t,e.startLocation,i,h,1e3),this.queuedRadius=h)}getNewScoutTarget(){return this.scoutingQueue.dequeue()}hasScoutTargets(){return!this.scoutingQueue.isEmpty()}}class Zt{constructor(t,e,i,s){this.threatCache=t,this.sectorCache=e,this.mainRallyPoint=i,this.logger=s,this._shouldAttack=!1;const{width:r,height:n}=e.getMapBounds();this.hostileQuadTree=new Wt({width:r,height:n}),this.scoutingManager=new Xt(s)}getHostilesNearPoint2d(t,e){return this.getHostilesNearPoint(t.x,t.y,e)}getHostilesNearPoint(e,i,s){return this.hostileQuadTree.retrieve(new Yt({x:e,y:i,r:s})).map(({x:t,y:e,data:i})=>({x:t,y:e,unitId:i})).filter(({x:r,y:n})=>new t.Vector2(r,n).distanceTo(new t.Vector2(e,i))<=s).filter(({unitId:t})=>!!t)}getThreatCache(){return this.threatCache}getSectorCache(){return this.sectorCache}getMainRallyPoint(){return this.mainRallyPoint}getScoutingManager(){return this.scoutingManager}shouldAttack(){return this._shouldAttack}checkShouldAttack(t,e){let i=1.1*t.totalAvailableAntiGroundFirepower,s=1.1*(e*t.totalOffensiveLandThreat+t.totalDefensiveThreat),r=1.1*t.totalAvailableAirPower,n=1.1*(e*t.totalOffensiveAntiAirThreat+t.totalDefensiveThreat);return i>s||r>n}onGameStart(t,e){this.scoutingManager.onGameStart(t,e,this.sectorCache)}onAiUpdate(e,i){const r=this.sectorCache;r.updateSectors(e.getCurrentTick(),8,e.mapApi,i),this.scoutingManager.onAiUpdate(e,i,r);let n=r?.getSectorUpdateRatio(e.getCurrentTick()-60*e.getTickRate());n&&n<1&&this.logger(100*n+"% of sectors updated in last 60 seconds.");const a=e.getVisibleUnits(i.name,"enemy");try{const t=a.map(t=>e.getGameObjectData(t)).filter(t=>void 0!==t);o=this.hostileQuadTree,h=t,o.clear(),h.forEach(t=>{o.insert(new Yt({x:t.tile.rx,y:t.tile.ry,r:1,data:t.id}))})}catch(t){console.error("caught error",a)}var o,h;if(e.getCurrentTick()%30==0){let s=r?.getOverallVisibility();if(s){this.logger(Math.round(1e3*s)/10+"% of tiles visible. Calculating threat."),this.threatCache=function(e,i,s){let r=e.getVisibleUnits(i.name,"enemy",e=>e.type==t.ObjectType.Vehicle||e.type==t.ObjectType.Infantry),n=e.getVisibleUnits(i.name,"enemy",e=>e.movementZone==t.MovementZone.Fly),a=e.getVisibleUnits(i.name,"enemy",e=>e.type==t.ObjectType.Building).filter(t=>Bt(e,t)),o=e.getVisibleUnits(i.name,"enemy",e=>e.type!=t.ObjectType.Building).filter(t=>Ft(e,t)),h=e.getVisibleUnits(i.name,"self",t=>t.isSelectableCombatant).filter(t=>Bt(e,t)),u=e.getVisibleUnits(i.name,"self",e=>e.isSelectableCombatant||e.type===t.ObjectType.Building).filter(t=>Ft(e,t)),c=e.getVisibleUnits(i.name,"self",e=>e.type===t.ObjectType.Building).filter(t=>Bt(e,t)),l=e.getVisibleUnits(i.name,"self",e=>e.movementZone==t.MovementZone.Fly&&e.isSelectableCombatant),g=Qt(e,r),p=Qt(e,n),d=Qt(e,o),m=Qt(e,a),y=Qt(e,h),f=Qt(e,u),T=Qt(e,l),A=Qt(e,c);return new qt(s,g,p,d,m,A,y,f,T)}(e,i,s);const r=Math.max(0,1-e.getCurrentTick()/108e3);this.logger(`Game length multiplier: ${r}`),this._shouldAttack?(this._shouldAttack=this.checkShouldAttack(this.threatCache,.75*r),this._shouldAttack||this.logger("Globally switched to defence mode.")):(this._shouldAttack=this.checkShouldAttack(this.threatCache,1.25*r),this._shouldAttack&&this.logger("Globally switched to attack mode."))}}if(e.getCurrentTick()%300==0){const r=e.getPlayers().filter(t=>t!==i.name&&!e.areAlliedPlayers(i.name,t)),n=e.getPlayerData(r[0]),a=function(e,i){const s=i.startLocation.x,r=i.startLocation.y;for(let i=0;i<=5;i++){const n=[{x:s,y:r},{x:s+i,y:r},{x:s-i,y:r},{x:s,y:r+i},{x:s,y:r-i}];for(const{x:i,y:s}of n){const r=e.mapApi.getTile(i,s);if(r&&e.mapApi.isPassableTile(r,t.SpeedType.Track,!1,!1))return r}}const n=e.mapApi.getTile(s,r);return n??null}(e,i),o=e.mapApi.getTile(n.startLocation.x,n.startLocation.y),h=s(e,i.startLocation,n.startLocation,9,9,0);if(a&&o)try{const i=e.mapApi.findPath(t.SpeedType.Track,!1,{tile:a,onBridge:!1},{tile:o,onBridge:!1},{bestEffort:!0});if(i&&i.length>0){const e=i[Math.floor(i.length/10*9)].tile;this.mainRallyPoint=new t.Vector2(e.rx,e.ry),this.logger(`Rally point set to path 70% position: (${e.rx}, ${e.ry}), path length: ${i.length}`)}else this.mainRallyPoint=h,this.logger(`No path found, using fallback rally point: (${this.mainRallyPoint.x}, ${this.mainRallyPoint.y})`)}catch(t){this.mainRallyPoint=h,this.logger(`Path finding error, using fallback rally point: ${t}`)}else this.mainRallyPoint=h,this.logger("Cannot get tiles, using fallback rally point")}}getGlobalDebugText(){if(this.threatCache)return`Threat LAND: Them ${Math.round(this.threatCache.totalOffensiveLandThreat)}, us: ${Math.round(this.threatCache.totalAvailableAntiGroundFirepower)}.\nThreat DEFENSIVE: Them ${Math.round(this.threatCache.totalDefensiveThreat)}, us: ${Math.round(this.threatCache.totalDefensivePower)}.\nThreat AIR: Them ${Math.round(this.threatCache.totalOffensiveAirThreat)}, us: ${Math.round(this.threatCache.totalAvailableAntiAirFirepower)}.`}}class Jt{constructor(){this.listeners=new Set}subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}publish(t){this.listeners.forEach(e=>e(t))}}class te extends t.Bot{constructor(t,e,i=[],s=!0){super(t,e),this.tryAllyWith=i,this.enableLogging=s,this.tickOfLastAttackOrder=0,this.logFilePath=null,this.matchAwareness=null,this.eventBus=new Jt,this.missionController=new Tt(this.eventBus,(t,e)=>this.logBotStatus(t,e)),this.queueController=new Gt(this.eventBus)}onGameStart(t){const i=t.getTickRate();this.tickRatio=Math.ceil(i/5),this.knownMapBounds=e(t.mapApi);const s=t.getPlayerData(this.name);this.matchAwareness=new Zt(null,new u(t.mapApi,this.knownMapBounds),s.startLocation,(t,e)=>this.logBotStatus(t,e)),this.matchAwareness.onGameStart(t,s),this.logBotStatus(`Map bounds: ${this.knownMapBounds.width}, ${this.knownMapBounds.height}`),this.tryAllyWith.filter(t=>t!==this.name).forEach(t=>this.actionsApi.toggleAlliance(t,!0))}onGameTick(e){if(!this.matchAwareness)return;const i=this.matchAwareness.getThreatCache();if(e.getCurrentTick()/15%6==0&&this.updateDebugState(e),e.getCurrentTick()%this.tickRatio===0){const s=e.getPlayerData(this.name);this.matchAwareness.onAiUpdate(e,s);const r=e.getVisibleUnits(this.name,"self",t=>t.isSelectableCombatant),n=e.getVisibleUnits(this.name,"self",t=>!!t.deploysInto&&e.getGeneralRules().baseUnit.includes(t.name)),a=e.getVisibleUnits(this.name,"self",e=>e.type==t.ObjectType.Building&&e.factory!=t.FactoryType.None);0==r.length&&0==a.length&&0==n.length&&(this.logBotStatus(`No army or production left, quitting. ${r}, ${a}, ${n}`),this.actionsApi.quitGame()),this.gameApi.getCurrentTick()%3==0&&this.missionController.onAiUpdate(e,this.productionApi,this.actionsApi,s,this.matchAwareness);const o=this.missionController.getRequestedUnitTypes();this.queueController.onAiUpdate(e,this.productionApi,this.actionsApi,s,i,o,t=>this.logBotStatus(t))}}getHumanTimestamp(t){return function(t,e=!1){let i=Math.floor(t/3600);t-=3600*i;let s=Math.floor(t/60);t-=60*s;let r=Math.floor(t);return[...i||!e?[i]:[],C(s,"00"),C(r,"00")].join(":")}(t.getCurrentTick()/15)}logBotStatus(t,e=!1){if(!this.enableLogging)return;const i=this.getHumanTimestamp(this.gameApi),s=`[${i}] ${t}`;this.logger.info(s),e&&this.actionsApi.sayAll(`${i}: ${t}`)}updateDebugState(t){if(!this.getDebugMode())return;const e=t.getPlayerData(this.name),i=t.getVisibleUnits(this.name,"self",t=>t.harvester).length;let s=`Cash: ${e.credits} | Harvesters: ${i}\n`;s+=this.queueController.getGlobalDebugText(this.gameApi,this.productionApi),s+=this.missionController.getGlobalDebugText(this.gameApi),s+=this.matchAwareness?.getGlobalDebugText(),this.missionController.updateDebugText(this.actionsApi),t.getVisibleUnits(this.name,"enemy").forEach(t=>{this.actionsApi.setUnitDebugText(t,t.toString())}),this.actionsApi.setGlobalDebugText(s)}onGameEvent(e){if(e.type===t.ApiEventType.ObjectDestroy)e.attackerInfo?.playerName==this.name&&(this.tickOfLastAttackOrder+=(this.gameApi.getCurrentTick()-this.tickOfLastAttackOrder)/2)}}const ee="0.78.1-c1"})(),n})());